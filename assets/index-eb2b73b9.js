(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))c(u);new MutationObserver(u=>{for(const h of u)if(h.type==="childList")for(const _ of h.addedNodes)_.tagName==="LINK"&&_.rel==="modulepreload"&&c(_)}).observe(document,{childList:!0,subtree:!0});function l(u){const h={};return u.integrity&&(h.integrity=u.integrity),u.referrerPolicy&&(h.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?h.credentials="include":u.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function c(u){if(u.ep)return;u.ep=!0;const h=l(u);fetch(u.href,h)}})();/*! For license information please see bundle.m.js.LICENSE.txt */var __webpackgi_modules__={774:function(d,o,l){var c=l(364),u=l.n(c)()(function(h){return h[1]});u.push([d.id,'.tippy-box[data-animation=fade][data-state=hidden]{opacity:0}[data-tippy-root]{max-width:calc(100vw - 10px)}.tippy-box{position:relative;background-color:#333;color:#fff;border-radius:4px;font-size:14px;line-height:1.4;white-space:normal;outline:0;transition-property:transform,visibility,opacity}.tippy-box[data-placement^=top]>.tippy-arrow{bottom:0}.tippy-box[data-placement^=top]>.tippy-arrow:before{bottom:-7px;left:0;border-width:8px 8px 0;border-top-color:initial;transform-origin:center top}.tippy-box[data-placement^=bottom]>.tippy-arrow{top:0}.tippy-box[data-placement^=bottom]>.tippy-arrow:before{top:-7px;left:0;border-width:0 8px 8px;border-bottom-color:initial;transform-origin:center bottom}.tippy-box[data-placement^=left]>.tippy-arrow{right:0}.tippy-box[data-placement^=left]>.tippy-arrow:before{border-width:8px 0 8px 8px;border-left-color:initial;right:-7px;transform-origin:center left}.tippy-box[data-placement^=right]>.tippy-arrow{left:0}.tippy-box[data-placement^=right]>.tippy-arrow:before{left:-7px;border-width:8px 8px 8px 0;border-right-color:initial;transform-origin:center right}.tippy-box[data-inertia][data-state=visible]{transition-timing-function:cubic-bezier(0.54, 1.5, 0.38, 1.11)}.tippy-arrow{width:16px;height:16px;color:#333}.tippy-arrow:before{content:"";position:absolute;border-color:rgba(0,0,0,0);border-style:solid}.tippy-content{position:relative;padding:5px 9px;z-index:1}',""]),o.A=u},611:function(d,o,l){var c=l(364),u=l.n(c)()(function(h){return h[1]});u.push([d.id,".loader{width:48px;height:48px;border:5px solid #333;border-bottom-color:rgba(0,0,0,0);border-radius:50%;display:inline-block;box-sizing:border-box;animation:rotation 1s linear infinite}@keyframes rotation{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}",""]),o.A=u},223:function(d,o,l){var c=l(364),u=l.n(c)()(function(h){return h[1]});u.push([d.id,"#assetManagerLoadingBar{z-index:400;position:absolute;top:0;left:0;right:0;width:100%;background-color:rgba(0,0,0,0);height:auto}#assetManagerLoadingBarContent{color:#fff;position:absolute;left:0;right:0;margin:auto;transition:width .5s;background-color:rgba(34,34,34,.6666666667);text-align:center;font-size:.5rem;line-height:.6rem;height:.6rem;border-radius:0 0 .125rem .125rem;border-bottom:#999 1px solid}.processState{font-weight:bold}",""]),o.A=u},646:function(d,o,l){var c=l(364),u=l.n(c)()(function(h){return h[1]});u.push([d.id,'#assetManagerLoadingScreen{z-index:300;position:absolute;bottom:0;right:0;min-width:100%;min-height:100%;color:#333;font-size:1rem;gap:1rem;display:flex;align-content:center;justify-content:center;align-items:center;flex-direction:column;opacity:1;transition:opacity .5s ease-in-out,min-width .5s,min-height .5s,bottom .5s,right .5s;overflow:hidden;background:rgba(0,0,0,0);-webkit-backdrop-filter:blur(16px);backdrop-filter:blur(16px);background-blend-mode:luminosity;--b-opacity: 0.8;--b-background: #ffffff}#assetManagerLoadingScreen::before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;z-index:-1;opacity:var(--b-opacity);background:var(--b-background)}#assetManagerLoadingScreenContent{padding-top:.5rem}.loadingScreenProcessState{font-weight:bold}#assetManagerLoadingScreen.minimizedLoadingScreen{top:unset;left:unset;bottom:2rem;right:2rem;min-width:0;min-height:0;max-width:80vw;max-height:80vh;width:-moz-max-content;width:max-content;height:-moz-max-content;height:max-content;padding:1.5rem;border-radius:.5rem}.loadingScreenFilesElement{min-height:4rem;padding:1rem}.loadingScreenLogoElement{margin-bottom:.5rem;max-width:80%}.loadingScreenLogoElement img{min-height:3rem;max-height:5rem;max-width:100%;-o-object-fit:contain;object-fit:contain}.loadingScreenLogoImage{width:-moz-max-content;width:max-content;height:-moz-max-content;height:max-content}.minimizedLoadingScreen .loadingScreenLoadingElement{display:none}.minimizedLoadingScreen .loadingScreenFilesElement{min-height:0}.minimizedLoadingScreen .loadingScreenLogoElement{min-height:0;display:none}.minimizedLoadingScreen #assetManagerLoadingScreenContent{display:none}',""]),o.A=u},636:function(d,o,l){var c=l(364),u=l.n(c)()(function(h){return h[1]});u.push([d.id,"#assetManagerPopup{z-index:300;position:absolute;bottom:2rem;right:2rem;color:#fff;-webkit-backdrop-filter:blur(16px);backdrop-filter:blur(16px);background-blend-mode:luminosity;background-color:rgba(40,34,60,.6666666667);padding:1.5rem;font-size:1rem;width:-moz-max-content;width:max-content;max-width:80vw;max-height:80vh;overflow-y:scroll;border-radius:.5rem;height:-moz-max-content;height:max-content}#assetManagerPopupClose{position:absolute;top:0;right:0;padding:.5rem;cursor:pointer}#assetManagerPopupContent{padding-top:.5rem}.processState{font-weight:bold}",""]),o.A=u},757:function(d,o,l){var c=l(364),u=l.n(c)()(function(h){return h[1]});u.push([d.id,'.button-bar{background:var(--tp-base-background-color);width:fit-content;width:-moz-fit-content;height:auto;display:flex;flex-direction:row;justify-content:center;flex-wrap:wrap;z-index:200;padding:.25rem .5rem .5rem;border-radius:.5rem;pointer-events:auto;box-shadow:0 2px 4px var(--tp-base-shadow-color);gap:8px;font-size:.85rem;line-height:130%;font-family:Inter,"Roboto Mono","Source Code Pro",Menlo,Courier,monospace;opacity:1;transition:all .25s}.button-bar-button{background-color:rgba(0,0,0,0);cursor:pointer;width:auto;height:auto;font-weight:500;padding:.35rem .5rem;position:relative;-webkit-user-select:none;-moz-user-select:none;user-select:none;color:var(--tp-input-foreground-color, #cccccc);transition:color .25s}.button-bar-button:hover{color:var(--tp-label-foreground-color, #eeeeee)}.button-bar-selected{color:var(--tp-label-foreground-color, #eeeeee)}.button-bar-selected-box{color:var(--tp-label-foreground-color, #eeeeee)}.button-bar>.button-bar-button:not(:last-child)::after{content:"";position:absolute;right:-5px;top:20%;width:2px;height:60%;border-radius:1px;background-color:var(--tp-container-background-color-active, #413762)}.button-bar-button:before{left:50%;width:0;content:"";position:absolute}.button-bar-selected:before{left:25%;width:50%;bottom:0;height:2px;border-radius:1px;background-color:var(--tp-container-foreground-color, #cccccc);transition:width .25s,left .25s}.button-bar-selected-box{background-color:rgba(238,238,238,.3333333333);border-radius:.25rem;transition:all .25s}.round-button{width:1rem;height:1rem;padding:.6rem;background-color:var(--tp-base-background-color);border-radius:1.2rem;color:#ccc;cursor:pointer;box-shadow:0 2px 4px var(--tp-base-shadow-color);transition:all .25s;box-sizing:content-box !important}.round-button:hover{color:#fff}.util-buttons-container{bottom:1.25rem;right:1.25rem;position:absolute;gap:8px;padding:.25rem}.util-button{position:relative;width:auto;height:1.2rem;aspect-ratio:1;box-sizing:content-box !important}.mode-buttons-container{border-top:0;top:0;left:0;right:0;margin-left:auto;margin-right:auto;position:absolute;min-width:6rem;border-radius:0 0 .5rem .5rem;gap:8px;flex-wrap:nowrap !important;overflow-x:scroll;pointer-events:auto;max-width:100%;align-content:center;justify-content:flex-start;align-items:center;box-sizing:border-box}.mode-buttons-container::-webkit-scrollbar{display:none}.mode-buttons-container{-ms-overflow-style:none;scrollbar-width:none}.mode-button{font-weight:500}#webgi-logo{background-image:url("https://static.webgi.xyz/logo.svg");background-size:contain;background-repeat:no-repeat;background-position:center;bottom:1.25rem;left:1rem;z-index:100;width:7.5rem;height:2.5rem;position:absolute;cursor:pointer}#webgi-logo:hover{filter:grayscale(100%)}#fsToggle{position:absolute;right:1.25rem;top:1.25rem;color:var(--tp-container-foreground-color, #dddddd)}#assetManagerPopup{position:absolute;margin:auto;left:0;right:0;top:0;bottom:0;color:#fff;padding:1.5rem;font-size:.85rem;overflow-y:scroll;background-color:var(--tp-base-background-color)}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:rgba(40,34,60,.8) !important;border-radius:6px}::-webkit-scrollbar-thumb{background:hsla(0,0%,100%,.4);border-radius:6px}::-webkit-scrollbar-corner{background:rgba(0,0,0,.5)}.tippy-box[data-theme~=editor]{margin:.25rem !important;background-color:var(--tp-base-background-color) !important;font-size:.9rem !important;color:var(--tp-container-foreground-color, #dddddd) !important}#tweakpaneUiContainer{margin-top:4.5rem}#canvasContainer{display:flex;justify-content:center;align-items:center}@media only screen and (min-width: 920px){#canvasContainer{width:calc(min(100% - 3rem,100% - var(--tweakpane-ui-container-width, 300px)) - 3.5rem) !important;height:calc(100% - 5rem);margin:3.5rem 1.5rem 1.5rem 1.5rem;border-radius:.5rem;box-shadow:rgba(0,0,0,.25) 0px 25px 50px -12px}#mcanvas{border-radius:.5rem}#tweakpaneUiContainer{margin-top:3.5rem}}body{transition:background-color .5s ease;background-color:#d1d4e7}body.tpTheme-blue{background-color:#d1d4e7}body.tpTheme-white{background-color:#dcdcdc}body.tpTheme-black{background-color:#48495d}',""]),o.A=u},367:function(d,o,l){var c=l(364),u=l.n(c)()(function(h){return h[1]});u.push([d.id,':root{--tp-blade-unit-size: 26px;--tp-font-family: "Inter";--tp-element-border-radius: 0.25rem}:root{--tp-base-background-color: #0e0e0e;--tp-container-background-color: rgba(32, 32, 32, 0.2);--tp-container-background-color-hover: rgba(32, 32, 32, 0.3);--tp-container-background-color-active: rgba(50, 50, 50, 0.8);--tp-container-background-color-focus: rgba(50, 50, 50, 1.0);--tp-container-foreground-color: hsla(0, 0%, 90%, 0.90);--tp-label-foreground-color: hsla(0, 0%, 85%, 0.90)}:root .tpTheme-blue{--tp-base-background-color: #28223C;--tp-base-shadow-color: hsla(0, 0%, 0%, 0.2);--tp-button-background-color: hsla(230, 10%, 80%, 1.00);--tp-button-background-color-active: hsla(230, 10%, 95%, 1.00);--tp-button-background-color-focus: hsla(230, 10%, 90%, 1.00);--tp-button-background-color-hover: hsla(230, 10%, 85%, 1.00);--tp-button-foreground-color: hsla(230, 20%, 11%, 1.00);--tp-container-background-color: hsla(230, 25%, 16%, 0.65);--tp-container-background-color-active: hsla(230, 25%, 36%, 0.65);--tp-container-background-color-focus: hsla(230, 25%, 26%, 0.65);--tp-container-background-color-hover: hsla(230, 25%, 21%, 0.65);--tp-container-foreground-color: hsl(240, 10%, 92%);--tp-groove-foreground-color: hsla(230, 20%, 8%, 1.00);--tp-input-background-color: hsla(230, 20%, 8%, 1.00);--tp-input-background-color-active: hsla(230, 28%, 23%, 1.00);--tp-input-background-color-focus: hsla(230, 28%, 18%, 1.00);--tp-input-background-color-hover: hsla(230, 20%, 13%, 1.00);--tp-input-foreground-color: hsla(230, 10%, 80%, 1.00);--tp-monitor-background-color: hsla(230, 20%, 8%, 1.00);--tp-monitor-foreground-color: hsla(230, 12%, 48%, 1.00);--tp-label-foreground-color: #E4E2ED}:root .tpTheme-white{--tp-base-background-color: hsla(230, 5%, 90%, 1.00);--tp-base-shadow-color: hsla(0, 0%, 0%, 0.10);--tp-button-background-color: hsla(230, 7%, 85%, 1.00);--tp-button-background-color-active: hsla(230, 7%, 70%, 1.00);--tp-button-background-color-focus: hsla(230, 7%, 75%, 1.00);--tp-button-background-color-hover: hsla(230, 7%, 80%, 1.00);--tp-button-foreground-color: hsla(230, 10%, 30%, 1.00);--tp-container-background-color: hsla(230, 15%, 80%, 0.10);--tp-container-background-color-active: hsla(230, 15%, 70%, 0.32);--tp-container-background-color-focus: hsla(230, 15%, 70%, 0.28);--tp-container-background-color-hover: hsla(230, 15%, 70%, 0.24);--tp-container-foreground-color: hsla(230, 10%, 30%, 1.00);--tp-groove-foreground-color: hsla(230, 15%, 20%, 0.10);--tp-input-background-color: hsla(230, 15%, 30%, 0.10);--tp-input-background-color-active: hsla(230, 15%, 50%, 0.22);--tp-input-background-color-focus: hsla(230, 15%, 50%, 0.18);--tp-input-background-color-hover: hsla(230, 15%, 50%, 0.14);--tp-input-foreground-color: hsla(230, 10%, 20%, 1.00);--tp-label-foreground-color: hsla(230, 10%, 10%, 1.00);--tp-monitor-background-color: hsla(230, 15%, 30%, 0.10);--tp-monitor-foreground-color: hsla(230, 10%, 30%, 0.50)}.tp-fldv{margin-top:.25rem;margin-bottom:.25rem;background-blend-mode:luminosity;position:relative}.tp-fldv .tp-fldv{margin-top:.5rem;margin-bottom:.5rem}.tp-fldv_b{height:calc(var(--bld-us)*1.5 + 4px) !important;font-size:.9rem !important;transition:background-color .5s ease}.tp-fldv_b+.tp-brkv .tp-fldv_b{height:calc(var(--bld-us)*1.1 + 4px) !important;font-size:.7rem !important}.tp-lblv_l{font-size:.75rem !important;font-weight:500 !important;flex-grow:1 !important;flex-basis:20% !important}.tp-lblv_v{flex-grow:1 !important;flex-basis:50% !important}.tp-txtv_i{font-size:.75rem !important;font-weight:500 !important}.tp-fldv_t{font-weight:500 !important;padding-left:1.5rem !important}.tp-fldv_m{right:auto !important;left:.75rem;opacity:1 !important}.pluginOptionsButton{position:absolute;right:0;top:.75rem;padding-left:.5rem;padding-right:.5rem;height:-moz-min-content;height:min-content;background:rgba(0,0,0,0);color:var(--tp-container-foreground-color, #eeeeee);font-size:.9rem;border:none}.tp-sldv_k::after{background-color:var(--tp-input-foreground-color, hsl(230, 7%, 75%))}.tp-btnv_b{height:calc(var(--tp-blade-unit-size)*1.15)}.tp-p2dv_b,.tp-btnv_b,.tp-lstv_s{font-weight:500 !important}.tp-rotv{font-size:13px !important}',""]),o.A=u},160:function(d,o,l){var c=l(364),u=l.n(c)()(function(h){return h[1]});u.push([d.id,".wwise-perspective{perspective:1000px;position:fixed;left:0;top:0;width:100vw;height:100vh}.wwise-wrapper{position:fixed;width:0;height:0;font-weight:400}.wwise-wrapper.v-center{top:50%}.wwise-wrapper.h-center{left:50%}.wwise-wrapper.left{left:0}.wwise-wrapper.right{right:0}.wwise-wrapper.top{top:0}.wwise-wrapper.bottom{bottom:0}.wwise *.preset{color:#fafafa}.wwise *.preset.ok{background:rgba(45,193,80,.95)}.wwise *.preset.error{background:rgba(190,17,51,.95)}.wwise *.preset.info{background:rgba(40,34,60,.95)}.wwise *.preset.caution{background:rgba(239,128,0,.95)}.wwise-no-scroll{position:relative;overflow:hidden}.wwise-overlay{position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(50,50,50,.5)}.wwise{position:absolute;left:0;top:0;display:flex;flex-direction:column;border-radius:5px;box-shadow:1px 1px 10px rgba(150,150,150,.5);box-sizing:border-box}.wwise.no-radius{border-radius:0}.wwise *{box-sizing:border-box}.wwise .clear{clear:both}.wwise>.content{padding:0;margin:0;flex-grow:1;border-radius:0 0 4px 4px;background:#fff;color:#333;box-shadow:0 1px 3px rgba(200,200,200,.5) inset}.wwise>.content.no-topbar{border-radius:4px;box-shadow:none}.wwise.no-radius>.content,.wwise.no-radius>.content.no-topbar{border-radius:0}.wwise .modal>.main{width:90vw;max-width:400px;border-radius:4px 4px 0 0;text-align:center;padding-bottom:10px;color:#fff}.wwise .modal>.main .icon{display:block;margin:0 auto;fill:#fff;width:100px}.wwise .modal>.main .title{font-size:30px}.wwise .modal>.main .text{margin:10px 0;font-weight:300;font-size:16px}.wwise .modal>.main.no-op{border-radius:4px}.wwise .modal>.main.ok{background:#2dc150}.wwise .modal>.main.error{background:#be1133}.wwise .modal>.main.info{background:#28223c}.wwise .modal>.main.caution{background:#ef8000}.wwise .modal>.operation .button-wrapper{text-align:center;margin:30px 0 20px 0}.wwise .modal>.operation .button{display:inline-block;line-height:18px;padding:8px 10px;margin:0 15px;line-height:18px;width:100px;border-radius:4px;border:1px solid #eee;box-shadow:1px 1px 3px rgba(220,220,220,.8);color:#555;transition:all ease .2s}.wwise .modal>.operation .button:hover{background:#f5f5f5;cursor:pointer}.wwise .modal>.operation .button.main{color:#fff}.wwise .modal>.operation.ok .main{background:#2dc150}.wwise .modal>.operation.ok .main:hover{background:rgb(35.3571428571,151.6428571429,62.8571428571)}.wwise .modal>.operation.error .main{background:#be1133}.wwise .modal>.operation.error .main:hover{background:rgb(143.1884057971,12.8115942029,38.4347826087)}.wwise .modal>.operation.info .main{background:#28223c}.wwise .modal>.operation.info .main:hover{background:rgb(18.2978723404,15.5531914894,27.4468085106)}.wwise .modal>.operation.caution .main{background:#ef8000}.wwise .modal>.operation.caution .main:hover{background:rgb(188,100.6861924686,0)}.wwise .input-wrapper{margin:15px auto -15px auto}.wwise .input-wrapper .input{display:block;margin:0 auto;width:95%;max-width:300px;outline:none;border:none;background:#f3f3f3;padding:15px;font-size:16px;border-radius:5px}.wwise .input-wrapper .error{width:95%;text-align:center;margin-top:10px;color:red}div:has(>.wwise-wrapper){position:absolute !important}.wwise-wrapper{position:absolute !important}.wwise .modal>.main{padding-top:10px}",""]),o.A=u},333:function(d){var o;o=function(){return function(l){var c={};function u(h){if(c[h])return c[h].exports;var _=c[h]={i:h,l:!1,exports:{}};return l[h].call(_.exports,_,_.exports,u),_.l=!0,_.exports}return u.m=l,u.c=c,u.i=function(h){return h},u.d=function(h,_,A){u.o(h,_)||Object.defineProperty(h,_,{configurable:!1,enumerable:!0,get:A})},u.n=function(h){var _=h&&h.__esModule?function(){return h.default}:function(){return h};return u.d(_,"a",_),_},u.o=function(h,_){return Object.prototype.hasOwnProperty.call(h,_)},u.p="",u(u.s=5)}([function(l,c,u){Object.defineProperty(c,"__esModule",{value:!0});var h={convertToObject:function(_){var A=_.substring(_.indexOf("{")+1).trim().slice(0,-1),w={};return A.split(";").map(function(C){if(C=C.trim()){var M=C.split(":");w[M[0].trim()]=M[1].trim()}}),w},getFromSheets:function(_){var A=document.styleSheets;for(var w in A){var C=null;try{C=A[w].rules||A[w].cssRules}catch{}if(C){for(var M in C)if(C[M].selectorText&&C[M].selectorText.split(",").indexOf(_)!=-1)return C[M].cssText?h.convertToObject(C[M].cssText):h.convertToObject(C[M].style.cssText)}}return{}},getPropertyDefault:function(_){return _=="timing-function"?"ease":_=="iteration-count"?1:_=="direction"?"normal":_=="fill-mode"?"none":null}};c.default=h},function(l,c,u){Object.defineProperty(c,"__esModule",{value:!0});var h={generateId:function(){for(var _="",A=0;A<8;++A)_+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return _},frameToString:function(_){var A="";for(var w in _)A+=w+":"+_[w]+";";return A},convertTimeToMs:function(_){if(!_)return 0;if(typeof _=="number")return _;var A=parseFloat(_);return _.indexOf("ms")!=-1?A:1e3*A},prefixes:["","-webkit-","-moz-","-o-"]};c.default=h},function(l,c,u){Object.defineProperty(c,"__esModule",{value:!0});var h,_=(h=u(0))&&h.__esModule?h:{default:h};c.default=function A(w,C){if(function(ne,ce){if(!(ne instanceof ce))throw new TypeError("Cannot call a class as a function")}(this,A),this.styles=typeof w=="string"?_.default.getFromSheets(w):w,typeof C=="string"){var M=_.default.getFromSheets(C);for(var O in this.options={},M)this.options[O.replace("animation-","")]=M[O]}else this.options=typeof C=="number"?{duration:C}:C}},function(l,c,u){Object.defineProperty(c,"__esModule",{value:!0});var h=function(){function O(ne,ce){for(var ue=0;ue<ce.length;ue++){var ye=ce[ue];ye.enumerable=ye.enumerable||!1,ye.configurable=!0,"value"in ye&&(ye.writable=!0),Object.defineProperty(ne,ye.key,ye)}}return function(ne,ce,ue){return ce&&O(ne.prototype,ce),ue&&O(ne,ue),ne}}(),_=C(u(4)),A=C(u(1)),w=C(u(0));function C(O){return O&&O.__esModule?O:{default:O}}var M=function(){function O(ne,ce,ue,ye){if(function(Ve,tt){if(!(Ve instanceof tt))throw new TypeError("Cannot call a class as a function")}(this,O),ne.constructor===Array?this.doms=ne:this.doms=[ne],ce.constructor===Array?this.frames=ce:this.frames=[ce],this.options={startFrom:0,pauseAt:[],prefix:!1,count:1,clear:!0,applyOnEnd:!1,instant:!1},ue!=null&&ue!=null)if(typeof ue=="boolean")this.options.instant=ue;else if(typeof ue=="number")this.options.count=ue,typeof ye=="boolean"&&(this.options.instant=ye);else for(var Oe in ue)Oe=="pauseAt"&&ue.pauseAt.constructor!==Array?this.options[Oe]=[ue[Oe]]:this.options[Oe]=ue[Oe];for(var ke in this.promiseSupported=typeof Promise<"u"&&Promise.toString().indexOf("[native code]")!==-1,this.countRemainder=[],this.animations=[],this.styleDoms=[],this.superSets=[],this.eventHandler=[],this.options.prefix?this.prefixes=A.default.prefixes:this.prefixes=[""],ne)this.countRemainder[ke]=this.options.count-1;this.options.instant&&this.play()}return h(O,[{key:"play",value:function(){var ne=this;for(var ce in this.clear(),this.promiseSupported&&(this.promise=new Promise(function(ye){ne.promiseResolve=ye})),this.doms){var ue=this.makeAnimation(this.doms[ce]);this.animations[ce]=ue.names,this.styleDoms[ce]=ue.styleDom,this.superSets[ce]=this.makeSuperSet(this.doms[ce],this.animations[ce]),this.playAnimation(this.doms[ce],this.superSets[ce]),this.eventHandler[ce]=this.handleAnimationEnd.bind(this,ce),this.doms[ce].addEventListener("animationend",this.eventHandler[ce])}if(this.promiseSupported)return this.promise}},{key:"clear",value:function(ne){if(!ne){for(var ce in this.doms)this.clear(ce);return this.animationEnded=0,this.promise=void 0,void(this.promiseResolve=void 0)}var ue=this.styleDoms[ne];for(var ye in ue&&ue.parentNode&&ue.parentNode.removeChild(ue),this.superSets[ne])for(var Oe in this.prefixes)this.doms[ne].style[this.prefixes[Oe]+"animation-"+ye]=null;for(var ke in this.prefixes)this.doms[ne].style[this.prefixes[ke]+"animation-play-state"]=null;this.doms[ne].removeEventListener("animationend",this.eventHandler[ne]),this.countRemainder[ne]=this.options.count-1}},{key:"replay",value:function(ne){var ce=this.doms[ne],ue=ce.cloneNode(!0);ce.parentNode.replaceChild(ue,ce),this.doms[ne].removeEventListener("animationend",this.eventHandler[ne]),this.doms[ne]=ue,this.doms[ne].addEventListener("animationend",this.eventHandler[ne])}},{key:"pause",value:function(){for(var ne in this.doms)this.pauseDom(this.doms[ne])}},{key:"resume",value:function(){for(var ne in this.doms)this.resumeDom(this.doms[ne])}},{key:"getPromise",value:function(){return this.promise}},{key:"handleAnimationEnd",value:function(ne,ce){var ue=ce.animationName,ye=ue.substring(ue.lastIndexOf("-")+1);this.options.pauseAt.includes(parseInt(ye))&&this.pauseDom(this.doms[ne]),ye==this.frames.length&&(this.countRemainder[ne]==-1?this.replay(ne):this.countRemainder[ne]>0?(this.countRemainder[ne]--,this.replay(ne)):(this.options.applyOnEnd&&this.applyOnEnd(ne),this.animationEnded++,this.animationEnded==this.doms.length&&(this.promiseSupported&&this.promiseResolve(),this.options.clear&&this.clear())))}},{key:"pauseDom",value:function(ne){for(var ce in this.prefixes)ne.style[this.prefixes[ce]+"animation-play-state"]="paused"}},{key:"resumeDom",value:function(ne){for(var ce in this.prefixes)ne.style[this.prefixes[ce]+"animation-play-state"]="running"}},{key:"applyOnEnd",value:function(ne){var ce=this.newFrames[this.frames.length];for(var ue in ce)this.doms[ne].style[ue]=ce[ue]}},{key:"makeAnimation",value:function(ne){var ce={},ue=[],ye={};for(var Oe in this.frames)for(var ke in ue.push(this.frames[Oe].styles),ue[Oe])ye[ke]=!0;var Ve=window.getComputedStyle(ne);for(var tt in ye)ce[tt]=Ve[tt];ue.unshift(ce);for(var ht=[ue[0]],ut=1;ut<ue.length;++ut){var _t=JSON.parse(JSON.stringify(ht[ut-1]));for(var at in ue[ut])_t[at]=ue[ut][at];ht.push(_t)}return this.newFrames=ht,_.default.make(ht,this.prefixes)}},{key:"makeSuperSet",value:function(ne,ce){var ue=0,ye={};for(var Oe in this.frames)for(var ke in this.frames[Oe].options)ye[ke]="";ye.name="",ye.duration="",ye.delay="";for(var Ve=0;Ve<this.frames.length;++Ve){if(Ve)for(var tt in ye)ye[tt]+=",";var ht=A.default.convertTimeToMs(this.frames[Ve].options.duration),ut=A.default.convertTimeToMs(this.frames[Ve].options.delay);for(var _t in Ve<this.options.startFrom&&(ht=0,ut=0),ye.name+=ce[Ve],ye.duration+=ht+"ms",ye.delay+=ue+ut+"ms",ye)_t!="name"&&_t!="duration"&&_t!="delay"&&(ye[_t]+=this.frames[Ve].options[_t]?this.frames[Ve].options[_t]:w.default.getPropertyDefault(_t));var at=this.frames[Ve].options["iteration-count"];ue+=ht*parseInt(at||1)+ut}return ye}},{key:"playAnimation",value:function(ne,ce){for(var ue in ce)for(var ye in this.prefixes)ne.style[this.prefixes[ye]+"animation-"+ue]=ce[ue];this.options.pauseAt.includes(0)&&this.pauseDom(ne)}}]),O}();c.default=M},function(l,c,u){Object.defineProperty(c,"__esModule",{value:!0});var h,_=(h=u(1))&&h.__esModule?h:{default:h},A={make:function(w,C){for(var M=[],O="",ne="atr-"+_.default.generateId(),ce=document.createElement("style"),ue=0;ue<w.length-1;++ue)M.push(ne+"-"+(ue+1)),O+=A.makeFromTwoFrames(w[ue],w[ue+1],M[ue],C);return ce.innerHTML=O,ce.class="foo",document.getElementsByTagName("head")[0].appendChild(ce),{names:M,styleDom:ce}},makeFromTwoFrames:function(w,C,M,O){var ne="";for(var ce in O)ne+="@"+O[ce]+"keyframes "+M+" {",ne+="0%",ne+="{"+_.default.frameToString(w)+"}",ne+="100%",ne+="{"+_.default.frameToString(C)+"}",ne+="}";return ne}};c.default=A},function(l,c,u){Object.defineProperty(c,"__esModule",{value:!0}),c.Queue=c.Frame=void 0;var h=A(u(2)),_=A(u(3));function A(w){return w&&w.__esModule?w:{default:w}}c.Frame=h.default,c.Queue=_.default}])},d.exports=o()},364:function(d){d.exports=function(o){var l=[];return l.toString=function(){return this.map(function(c){var u=o(c);return c[2]?"@media ".concat(c[2]," {").concat(u,"}"):u}).join("")},l.i=function(c,u,h){typeof c=="string"&&(c=[[null,c,""]]);var _={};if(h)for(var A=0;A<this.length;A++){var w=this[A][0];w!=null&&(_[w]=!0)}for(var C=0;C<c.length;C++){var M=[].concat(c[C]);h&&_[M[0]]||(u&&(M[2]?M[2]="".concat(u," and ").concat(M[2]):M[2]=u),l.push(M))}},l}},101:function(d,o,l){var c=l(986);function u(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}d.exports=function(h){var _=new u;_.pre=h.pre,_.body=h.body,_.post=h.post;var A=h.args.slice(0);_.argTypes=A;for(var w=0;w<A.length;++w){var C=A[w];if(C==="array"||typeof C=="object"&&C.blockIndices){if(_.argTypes[w]="array",_.arrayArgs.push(w),_.arrayBlockIndices.push(C.blockIndices?C.blockIndices:0),_.shimArgs.push("array"+w),w<_.pre.args.length&&_.pre.args[w].count>0)throw new Error("cwise: pre() block may not reference array args");if(w<_.post.args.length&&_.post.args[w].count>0)throw new Error("cwise: post() block may not reference array args")}else if(C==="scalar")_.scalarArgs.push(w),_.shimArgs.push("scalar"+w);else if(C==="index"){if(_.indexArgs.push(w),w<_.pre.args.length&&_.pre.args[w].count>0)throw new Error("cwise: pre() block may not reference array index");if(w<_.body.args.length&&_.body.args[w].lvalue)throw new Error("cwise: body() block may not write to array index");if(w<_.post.args.length&&_.post.args[w].count>0)throw new Error("cwise: post() block may not reference array index")}else if(C==="shape"){if(_.shapeArgs.push(w),w<_.pre.args.length&&_.pre.args[w].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(w<_.body.args.length&&_.body.args[w].lvalue)throw new Error("cwise: body() block may not write to array shape");if(w<_.post.args.length&&_.post.args[w].lvalue)throw new Error("cwise: post() block may not write to array shape")}else{if(typeof C!="object"||!C.offset)throw new Error("cwise: Unknown argument type "+A[w]);_.argTypes[w]="offset",_.offsetArgs.push({array:C.array,offset:C.offset}),_.offsetArgIndex.push(w)}}if(_.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(_.pre.args.length>A.length)throw new Error("cwise: Too many arguments in pre() block");if(_.body.args.length>A.length)throw new Error("cwise: Too many arguments in body() block");if(_.post.args.length>A.length)throw new Error("cwise: Too many arguments in post() block");return _.debug=!!h.printCode||!!h.debug,_.funcName=h.funcName||"cwise",_.blockSize=h.blockSize||64,c(_)}},151:function(d,o,l){var c=l(161);function u(A,w,C){var M,O,ne=A.length,ce=w.arrayArgs.length,ue=w.indexArgs.length>0,ye=[],Oe=[],ke=0,Ve=0;for(M=0;M<ne;++M)Oe.push(["i",M,"=0"].join(""));for(O=0;O<ce;++O)for(M=0;M<ne;++M)Ve=ke,ke=A[M],M===0?Oe.push(["d",O,"s",M,"=t",O,"p",ke].join("")):Oe.push(["d",O,"s",M,"=(t",O,"p",ke,"-s",Ve,"*t",O,"p",Ve,")"].join(""));for(Oe.length>0&&ye.push("var "+Oe.join(",")),M=ne-1;M>=0;--M)ke=A[M],ye.push(["for(i",M,"=0;i",M,"<s",ke,";++i",M,"){"].join(""));for(ye.push(C),M=0;M<ne;++M){for(Ve=ke,ke=A[M],O=0;O<ce;++O)ye.push(["p",O,"+=d",O,"s",M].join(""));ue&&(M>0&&ye.push(["index[",Ve,"]-=s",Ve].join("")),ye.push(["++index[",ke,"]"].join(""))),ye.push("}")}return ye.join(`
`)}function h(A,w,C){for(var M=A.body,O=[],ne=[],ce=0;ce<A.args.length;++ce){var ue=A.args[ce];if(!(ue.count<=0)){var ye=new RegExp(ue.name,"g"),Oe="",ke=w.arrayArgs.indexOf(ce);switch(w.argTypes[ce]){case"offset":var Ve=w.offsetArgIndex.indexOf(ce);ke=w.offsetArgs[Ve].array,Oe="+q"+Ve;case"array":Oe="p"+ke+Oe;var tt="l"+ce,ht="a"+ke;if(w.arrayBlockIndices[ke]===0)ue.count===1?C[ke]==="generic"?ue.lvalue?(O.push(["var ",tt,"=",ht,".get(",Oe,")"].join("")),M=M.replace(ye,tt),ne.push([ht,".set(",Oe,",",tt,")"].join(""))):M=M.replace(ye,[ht,".get(",Oe,")"].join("")):M=M.replace(ye,[ht,"[",Oe,"]"].join("")):C[ke]==="generic"?(O.push(["var ",tt,"=",ht,".get(",Oe,")"].join("")),M=M.replace(ye,tt),ue.lvalue&&ne.push([ht,".set(",Oe,",",tt,")"].join(""))):(O.push(["var ",tt,"=",ht,"[",Oe,"]"].join("")),M=M.replace(ye,tt),ue.lvalue&&ne.push([ht,"[",Oe,"]=",tt].join("")));else{for(var ut=[ue.name],_t=[Oe],at=0;at<Math.abs(w.arrayBlockIndices[ke]);at++)ut.push("\\s*\\[([^\\]]+)\\]"),_t.push("$"+(at+1)+"*t"+ke+"b"+at);if(ye=new RegExp(ut.join(""),"g"),Oe=_t.join("+"),C[ke]==="generic")throw new Error("cwise: Generic arrays not supported in combination with blocks!");M=M.replace(ye,[ht,"[",Oe,"]"].join(""))}break;case"scalar":M=M.replace(ye,"Y"+w.scalarArgs.indexOf(ce));break;case"index":M=M.replace(ye,"index");break;case"shape":M=M.replace(ye,"shape")}}}return[O.join(`
`),M,ne.join(`
`)].join(`
`).trim()}function _(A){for(var w=new Array(A.length),C=!0,M=0;M<A.length;++M){var O=A[M],ne=O.match(/\d+/);ne=ne?ne[0]:"",O.charAt(0)===0?w[M]="u"+O.charAt(1)+ne:w[M]=O.charAt(0)+ne,M>0&&(C=C&&w[M]===w[M-1])}return C?w[0]:w.join("")}d.exports=function(A,w){for(var C=w[1].length-Math.abs(A.arrayBlockIndices[0])|0,M=new Array(A.arrayArgs.length),O=new Array(A.arrayArgs.length),ne=0;ne<A.arrayArgs.length;++ne)O[ne]=w[2*ne],M[ne]=w[2*ne+1];var ce=[],ue=[],ye=[],Oe=[],ke=[];for(ne=0;ne<A.arrayArgs.length;++ne){A.arrayBlockIndices[ne]<0?(ye.push(0),Oe.push(C),ce.push(C),ue.push(C+A.arrayBlockIndices[ne])):(ye.push(A.arrayBlockIndices[ne]),Oe.push(A.arrayBlockIndices[ne]+C),ce.push(0),ue.push(A.arrayBlockIndices[ne]));for(var Ve=[],tt=0;tt<M[ne].length;tt++)ye[ne]<=M[ne][tt]&&M[ne][tt]<Oe[ne]&&Ve.push(M[ne][tt]-ye[ne]);ke.push(Ve)}var ht=["SS"],ut=["'use strict'"],_t=[];for(tt=0;tt<C;++tt)_t.push(["s",tt,"=SS[",tt,"]"].join(""));for(ne=0;ne<A.arrayArgs.length;++ne){for(ht.push("a"+ne),ht.push("t"+ne),ht.push("p"+ne),tt=0;tt<C;++tt)_t.push(["t",ne,"p",tt,"=t",ne,"[",ye[ne]+tt,"]"].join(""));for(tt=0;tt<Math.abs(A.arrayBlockIndices[ne]);++tt)_t.push(["t",ne,"b",tt,"=t",ne,"[",ce[ne]+tt,"]"].join(""))}for(ne=0;ne<A.scalarArgs.length;++ne)ht.push("Y"+ne);if(A.shapeArgs.length>0&&_t.push("shape=SS.slice(0)"),A.indexArgs.length>0){var at=new Array(C);for(ne=0;ne<C;++ne)at[ne]="0";_t.push(["index=[",at.join(","),"]"].join(""))}for(ne=0;ne<A.offsetArgs.length;++ne){var lt=A.offsetArgs[ne],pt=[];for(tt=0;tt<lt.offset.length;++tt)lt.offset[tt]!==0&&(lt.offset[tt]===1?pt.push(["t",lt.array,"p",tt].join("")):pt.push([lt.offset[tt],"*t",lt.array,"p",tt].join("")));pt.length===0?_t.push("q"+ne+"=0"):_t.push(["q",ne,"=",pt.join("+")].join(""))}var xt=c([].concat(A.pre.thisVars).concat(A.body.thisVars).concat(A.post.thisVars));for((_t=_t.concat(xt)).length>0&&ut.push("var "+_t.join(",")),ne=0;ne<A.arrayArgs.length;++ne)ut.push("p"+ne+"|=0");A.pre.body.length>3&&ut.push(h(A.pre,A,O));var Tt=h(A.body,A,O),Pt=function(Bt){for(var Ut=0,kt=Bt[0].length;Ut<kt;){for(var Vt=1;Vt<Bt.length;++Vt)if(Bt[Vt][Ut]!==Bt[0][Ut])return Ut;++Ut}return Ut}(ke);Pt<C?ut.push(function(Bt,Ut,kt,Vt){for(var si=Ut.length,Jt=kt.arrayArgs.length,Wt=kt.blockSize,Zt=kt.indexArgs.length>0,ti=[],ci=0;ci<Jt;++ci)ti.push(["var offset",ci,"=p",ci].join(""));for(ci=Bt;ci<si;++ci)ti.push(["for(var j"+ci+"=SS[",Ut[ci],"]|0;j",ci,">0;){"].join("")),ti.push(["if(j",ci,"<",Wt,"){"].join("")),ti.push(["s",Ut[ci],"=j",ci].join("")),ti.push(["j",ci,"=0"].join("")),ti.push(["}else{s",Ut[ci],"=",Wt].join("")),ti.push(["j",ci,"-=",Wt,"}"].join("")),Zt&&ti.push(["index[",Ut[ci],"]=j",ci].join(""));for(ci=0;ci<Jt;++ci){for(var ri=["offset"+ci],Ct=Bt;Ct<si;++Ct)ri.push(["j",Ct,"*t",ci,"p",Ut[Ct]].join(""));ti.push(["p",ci,"=(",ri.join("+"),")"].join(""))}for(ti.push(u(Ut,kt,Vt)),ci=Bt;ci<si;++ci)ti.push("}");return ti.join(`
`)}(Pt,ke[0],A,Tt)):ut.push(u(ke[0],A,Tt)),A.post.body.length>3&&ut.push(h(A.post,A,O)),A.debug&&console.log("-----Generated cwise routine for ",w,`:
`+ut.join(`
`)+`
----------`);var Lt=[A.funcName||"unnamed","_cwise_loop_",M[0].join("s"),"m",Pt,_(O)].join("");return new Function(["function ",Lt,"(",ht.join(","),"){",ut.join(`
`),"} return ",Lt].join(""))()}},986:function(d,o,l){var c=l(151);d.exports=function(u){var h=["'use strict'","var CACHED={}"],_=[],A=u.funcName+"_cwise_thunk";h.push(["return function ",A,"(",u.shimArgs.join(","),"){"].join(""));for(var w=[],C=[],M=[["array",u.arrayArgs[0],".shape.slice(",Math.max(0,u.arrayBlockIndices[0]),u.arrayBlockIndices[0]<0?","+u.arrayBlockIndices[0]+")":")"].join("")],O=[],ne=[],ce=0;ce<u.arrayArgs.length;++ce){var ue=u.arrayArgs[ce];_.push(["t",ue,"=array",ue,".dtype,","r",ue,"=array",ue,".order"].join("")),w.push("t"+ue),w.push("r"+ue),C.push("t"+ue),C.push("r"+ue+".join()"),M.push("array"+ue+".data"),M.push("array"+ue+".stride"),M.push("array"+ue+".offset|0"),ce>0&&(O.push("array"+u.arrayArgs[0]+".shape.length===array"+ue+".shape.length+"+(Math.abs(u.arrayBlockIndices[0])-Math.abs(u.arrayBlockIndices[ce]))),ne.push("array"+u.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,u.arrayBlockIndices[0])+"]===array"+ue+".shape[shapeIndex+"+Math.max(0,u.arrayBlockIndices[ce])+"]"))}for(u.arrayArgs.length>1&&(h.push("if (!("+O.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),h.push("for(var shapeIndex=array"+u.arrayArgs[0]+".shape.length-"+Math.abs(u.arrayBlockIndices[0])+"; shapeIndex-->0;) {"),h.push("if (!("+ne.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),h.push("}")),ce=0;ce<u.scalarArgs.length;++ce)M.push("scalar"+u.scalarArgs[ce]);return _.push(["type=[",C.join(","),"].join()"].join("")),_.push("proc=CACHED[type]"),h.push("var "+_.join(",")),h.push(["if(!proc){","CACHED[type]=proc=compile([",w.join(","),"])}","return proc(",M.join(","),")}"].join("")),u.debug&&console.log(`-----Generated thunk:
`+h.join(`
`)+`
----------`),new Function("compile",h.join(`
`))(c.bind(void 0,u))}},981:function(d){d.exports=function(o){for(var l=new Array(o),c=0;c<o;++c)l[c]=c;return l}},872:function(d){function o(l){return!!l.constructor&&typeof l.constructor.isBuffer=="function"&&l.constructor.isBuffer(l)}d.exports=function(l){return l!=null&&(o(l)||function(c){return typeof c.readFloatLE=="function"&&typeof c.slice=="function"&&o(c.slice(0,0))}(l)||!!l._isBuffer)}},49:function(d,o,l){var c=l(101),u={body:"",args:[],thisVars:[],localVars:[]};function h(ce){if(!ce)return u;for(var ue=0;ue<ce.args.length;++ue){var ye=ce.args[ue];ce.args[ue]=ue===0?{name:ye,lvalue:!0,rvalue:!!ce.rvalue,count:ce.count||1}:{name:ye,lvalue:!1,rvalue:!0,count:1}}return ce.thisVars||(ce.thisVars=[]),ce.localVars||(ce.localVars=[]),ce}function _(ce){for(var ue=[],ye=0;ye<ce.args.length;++ye)ue.push("a"+ye);return new Function("P",["return function ",ce.funcName,"_ndarrayops(",ue.join(","),") {P(",ue.join(","),");return a0}"].join(""))(function(Oe){return c({args:Oe.args,pre:h(Oe.pre),body:h(Oe.body),post:h(Oe.proc),funcName:Oe.funcName})}(ce))}var A={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};(function(){for(var ce in A){var ue=A[ce];o[ce]=_({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+ue+"c"},funcName:ce}),o[ce+"eq"]=_({args:["array","array"],body:{args:["a","b"],body:"a"+ue+"=b"},rvalue:!0,funcName:ce+"eq"}),o[ce+"s"]=_({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+ue+"s"},funcName:ce+"s"}),o[ce+"seq"]=_({args:["array","scalar"],body:{args:["a","s"],body:"a"+ue+"=s"},rvalue:!0,funcName:ce+"seq"})}})();var w={not:"!",bnot:"~",neg:"-",recip:"1.0/"};(function(){for(var ce in w){var ue=w[ce];o[ce]=_({args:["array","array"],body:{args:["a","b"],body:"a="+ue+"b"},funcName:ce}),o[ce+"eq"]=_({args:["array"],body:{args:["a"],body:"a="+ue+"a"},rvalue:!0,count:2,funcName:ce+"eq"})}})();var C={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};(function(){for(var ce in C){var ue=C[ce];o[ce]=_({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+ue+"c"},funcName:ce}),o[ce+"s"]=_({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+ue+"s"},funcName:ce+"s"}),o[ce+"eq"]=_({args:["array","array"],body:{args:["a","b"],body:"a=a"+ue+"b"},rvalue:!0,count:2,funcName:ce+"eq"}),o[ce+"seq"]=_({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+ue+"s"},rvalue:!0,count:2,funcName:ce+"seq"})}})();var M=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];(function(){for(var ce=0;ce<M.length;++ce){var ue=M[ce];o[ue]=_({args:["array","array"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:ue}),o[ue+"eq"]=_({args:["array"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:ue+"eq"})}})();var O=["max","min","atan2","pow"];(function(){for(var ce=0;ce<O.length;++ce){var ue=O[ce];o[ue]=_({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:ue}),o[ue+"s"]=_({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:ue+"s"}),o[ue+"eq"]=_({args:["array","array"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:ue+"eq"}),o[ue+"seq"]=_({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:ue+"seq"})}})();var ne=["atan2","pow"];(function(){for(var ce=0;ce<ne.length;++ce){var ue=ne[ce];o[ue+"op"]=_({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:ue+"op"}),o[ue+"ops"]=_({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:ue+"ops"}),o[ue+"opeq"]=_({args:["array","array"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:ue+"opeq"}),o[ue+"opseq"]=_({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+ue,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},rvalue:!0,count:2,funcName:ue+"opseq"})}})(),o.any=c({args:["array"],pre:u,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),o.all=c({args:["array"],pre:u,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),o.sum=c({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),o.prod=c({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),o.norm2squared=c({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),o.norm2=c({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),o.norminf=c({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),o.norm1=c({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),o.sup=c({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),o.inf=c({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),o.argmin=c({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),o.argmax=c({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),o.random=_({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),o.assign=_({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),o.assigns=_({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),o.equals=c({args:["array","array"],pre:u,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})},881:function(d,o,l){var c=l(981),u=l(872),h=typeof Float64Array<"u";function _(M,O){return M[0]-O[0]}function A(){var M,O=this.stride,ne=new Array(O.length);for(M=0;M<ne.length;++M)ne[M]=[Math.abs(O[M]),M];ne.sort(_);var ce=new Array(ne.length);for(M=0;M<ce.length;++M)ce[M]=ne[M][1];return ce}function w(M,O){var ne=["View",O,"d",M].join("");O<0&&(ne="View_Nil"+M);var ce=M==="generic";if(O===-1){var ue="function "+ne+"(a){this.data=a;};var proto="+ne+".prototype;proto.dtype='"+M+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+ne+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+ne+"(a){return new "+ne+"(a);}";return new Function(ue)()}if(O===0)return ue="function "+ne+"(a,d) {this.data = a;this.offset = d};var proto="+ne+".prototype;proto.dtype='"+M+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+ne+"_copy() {return new "+ne+"(this.data,this.offset)};proto.pick=function "+ne+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+ne+"_get(){return "+(ce?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+ne+"_set(v){return "+(ce?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+ne+"(a,b,c,d){return new "+ne+"(a,d)}",new Function("TrivialArray",ue)(C[M][0]);ue=["'use strict'"];var ye=c(O),Oe=ye.map(function(pt){return"i"+pt}),ke="this.offset+"+ye.map(function(pt){return"this.stride["+pt+"]*i"+pt}).join("+"),Ve=ye.map(function(pt){return"b"+pt}).join(","),tt=ye.map(function(pt){return"c"+pt}).join(",");ue.push("function "+ne+"(a,"+Ve+","+tt+",d){this.data=a","this.shape=["+Ve+"]","this.stride=["+tt+"]","this.offset=d|0}","var proto="+ne+".prototype","proto.dtype='"+M+"'","proto.dimension="+O),ue.push("Object.defineProperty(proto,'size',{get:function "+ne+"_size(){return "+ye.map(function(pt){return"this.shape["+pt+"]"}).join("*"),"}})"),O===1?ue.push("proto.order=[0]"):(ue.push("Object.defineProperty(proto,'order',{get:"),O<4?(ue.push("function "+ne+"_order(){"),O===2?ue.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):O===3&&ue.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):ue.push("ORDER})")),ue.push("proto.set=function "+ne+"_set("+Oe.join(",")+",v){"),ce?ue.push("return this.data.set("+ke+",v)}"):ue.push("return this.data["+ke+"]=v}"),ue.push("proto.get=function "+ne+"_get("+Oe.join(",")+"){"),ce?ue.push("return this.data.get("+ke+")}"):ue.push("return this.data["+ke+"]}"),ue.push("proto.index=function "+ne+"_index(",Oe.join(),"){return "+ke+"}"),ue.push("proto.hi=function "+ne+"_hi("+Oe.join(",")+"){return new "+ne+"(this.data,"+ye.map(function(pt){return["(typeof i",pt,"!=='number'||i",pt,"<0)?this.shape[",pt,"]:i",pt,"|0"].join("")}).join(",")+","+ye.map(function(pt){return"this.stride["+pt+"]"}).join(",")+",this.offset)}");var ht=ye.map(function(pt){return"a"+pt+"=this.shape["+pt+"]"}),ut=ye.map(function(pt){return"c"+pt+"=this.stride["+pt+"]"});ue.push("proto.lo=function "+ne+"_lo("+Oe.join(",")+"){var b=this.offset,d=0,"+ht.join(",")+","+ut.join(","));for(var _t=0;_t<O;++_t)ue.push("if(typeof i"+_t+"==='number'&&i"+_t+">=0){d=i"+_t+"|0;b+=c"+_t+"*d;a"+_t+"-=d}");for(ue.push("return new "+ne+"(this.data,"+ye.map(function(pt){return"a"+pt}).join(",")+","+ye.map(function(pt){return"c"+pt}).join(",")+",b)}"),ue.push("proto.step=function "+ne+"_step("+Oe.join(",")+"){var "+ye.map(function(pt){return"a"+pt+"=this.shape["+pt+"]"}).join(",")+","+ye.map(function(pt){return"b"+pt+"=this.stride["+pt+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil"),_t=0;_t<O;++_t)ue.push("if(typeof i"+_t+"==='number'){d=i"+_t+"|0;if(d<0){c+=b"+_t+"*(a"+_t+"-1);a"+_t+"=ceil(-a"+_t+"/d)}else{a"+_t+"=ceil(a"+_t+"/d)}b"+_t+"*=d}");ue.push("return new "+ne+"(this.data,"+ye.map(function(pt){return"a"+pt}).join(",")+","+ye.map(function(pt){return"b"+pt}).join(",")+",c)}");var at=new Array(O),lt=new Array(O);for(_t=0;_t<O;++_t)at[_t]="a[i"+_t+"]",lt[_t]="b[i"+_t+"]";for(ue.push("proto.transpose=function "+ne+"_transpose("+Oe+"){"+Oe.map(function(pt,xt){return pt+"=("+pt+"===undefined?"+xt+":"+pt+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+ne+"(this.data,"+at.join(",")+","+lt.join(",")+",this.offset)}"),ue.push("proto.pick=function "+ne+"_pick("+Oe+"){var a=[],b=[],c=this.offset"),_t=0;_t<O;++_t)ue.push("if(typeof i"+_t+"==='number'&&i"+_t+">=0){c=(c+this.stride["+_t+"]*i"+_t+")|0}else{a.push(this.shape["+_t+"]);b.push(this.stride["+_t+"])}");return ue.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),ue.push("return function construct_"+ne+"(data,shape,stride,offset){return new "+ne+"(data,"+ye.map(function(pt){return"shape["+pt+"]"}).join(",")+","+ye.map(function(pt){return"stride["+pt+"]"}).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",ue.join(`
`))(C[M],A)}var C={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};d.exports=function(M,O,ne,ce){if(M===void 0)return(0,C.array[0])([]);typeof M=="number"&&(M=[M]),O===void 0&&(O=[M.length]);var ue=O.length;if(ne===void 0){ne=new Array(ue);for(var ye=ue-1,Oe=1;ye>=0;--ye)ne[ye]=Oe,Oe*=O[ye]}if(ce===void 0)for(ce=0,ye=0;ye<ue;++ye)ne[ye]<0&&(ce-=(O[ye]-1)*ne[ye]);for(var ke=function(tt){if(u(tt))return"buffer";if(h)switch(Object.prototype.toString.call(tt)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(tt)?"array":"generic"}(M),Ve=C[ke];Ve.length<=ue+1;)Ve.push(w(ke,Ve.length-1));return(0,Ve[ue+1])(M,O,ne,ce)}},516:function(d){d.exports=function o(l,c,u){function h(w,C){if(!c[w]){if(!l[w]){if(_)return _(w,!0);throw new Error("Cannot find module '"+w+"'")}var M=c[w]={exports:{}};l[w][0].call(M.exports,function(O){return h(l[w][1][O]||O)},M,M.exports,o,l,c,u)}return c[w].exports}for(var _=void 0,A=0;A<u.length;A++)h(u[A]);return h}({1:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){var ce=o("crypto");function ue(ut,_t){return function(at,lt){var pt;if((pt=lt.algorithm!=="passthrough"?ce.createHash(lt.algorithm):new ht).write===void 0&&(pt.write=pt.update,pt.end=pt.update),tt(lt,pt).dispatch(at),pt.update||pt.end(""),pt.digest)return pt.digest(lt.encoding==="buffer"?void 0:lt.encoding);var xt=pt.read();return lt.encoding!=="buffer"?xt.toString(lt.encoding):xt}(ut,_t=ke(ut,_t))}(c=l.exports=ue).sha1=function(ut){return ue(ut)},c.keys=function(ut){return ue(ut,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},c.MD5=function(ut){return ue(ut,{algorithm:"md5",encoding:"hex"})},c.keysMD5=function(ut){return ue(ut,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var ye=ce.getHashes?ce.getHashes().slice():["sha1","md5"];ye.push("passthrough");var Oe=["buffer","hex","binary","base64"];function ke(ut,_t){_t=_t||{};var at={};if(at.algorithm=_t.algorithm||"sha1",at.encoding=_t.encoding||"hex",at.excludeValues=!!_t.excludeValues,at.algorithm=at.algorithm.toLowerCase(),at.encoding=at.encoding.toLowerCase(),at.ignoreUnknown=_t.ignoreUnknown===!0,at.respectType=_t.respectType!==!1,at.respectFunctionNames=_t.respectFunctionNames!==!1,at.respectFunctionProperties=_t.respectFunctionProperties!==!1,at.unorderedArrays=_t.unorderedArrays===!0,at.unorderedSets=_t.unorderedSets!==!1,at.unorderedObjects=_t.unorderedObjects!==!1,at.replacer=_t.replacer||void 0,at.excludeKeys=_t.excludeKeys||void 0,ut===void 0)throw new Error("Object argument required.");for(var lt=0;lt<ye.length;++lt)ye[lt].toLowerCase()===at.algorithm.toLowerCase()&&(at.algorithm=ye[lt]);if(ye.indexOf(at.algorithm)===-1)throw new Error('Algorithm "'+at.algorithm+'"  not supported. supported values: '+ye.join(", "));if(Oe.indexOf(at.encoding)===-1&&at.algorithm!=="passthrough")throw new Error('Encoding "'+at.encoding+'"  not supported. supported values: '+Oe.join(", "));return at}function Ve(ut){if(typeof ut=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(ut))!=null}function tt(ut,_t,at){function lt(pt){return _t.update?_t.update(pt,"utf8"):_t.write(pt,"utf8")}return at=at||[],{dispatch:function(pt){return ut.replacer&&(pt=ut.replacer(pt)),this["_"+(pt===null?"null":typeof pt)](pt)},_object:function(pt){var xt,Tt=Object.prototype.toString.call(pt),Pt=/\[object (.*)\]/i.exec(Tt);if(Pt=(Pt=Pt?Pt[1]:"unknown:["+Tt+"]").toLowerCase(),0<=(xt=at.indexOf(pt)))return this.dispatch("[CIRCULAR:"+xt+"]");if(at.push(pt),_!==void 0&&_.isBuffer&&_.isBuffer(pt))return lt("buffer:"),lt(pt);if(Pt==="object"||Pt==="function"||Pt==="asyncfunction"){var Lt=Object.keys(pt);ut.unorderedObjects&&(Lt=Lt.sort()),ut.respectType===!1||Ve(pt)||Lt.splice(0,0,"prototype","__proto__","constructor"),ut.excludeKeys&&(Lt=Lt.filter(function(Ut){return!ut.excludeKeys(Ut)})),lt("object:"+Lt.length+":");var Bt=this;return Lt.forEach(function(Ut){Bt.dispatch(Ut),lt(":"),ut.excludeValues||Bt.dispatch(pt[Ut]),lt(",")})}if(!this["_"+Pt]){if(ut.ignoreUnknown)return lt("["+Pt+"]");throw new Error('Unknown object type "'+Pt+'"')}this["_"+Pt](pt)},_array:function(pt,xt){xt=xt!==void 0?xt:ut.unorderedArrays!==!1;var Tt=this;if(lt("array:"+pt.length+":"),!xt||pt.length<=1)return pt.forEach(function(Bt){return Tt.dispatch(Bt)});var Pt=[],Lt=pt.map(function(Bt){var Ut=new ht,kt=at.slice();return tt(ut,Ut,kt).dispatch(Bt),Pt=Pt.concat(kt.slice(at.length)),Ut.read().toString()});return at=at.concat(Pt),Lt.sort(),this._array(Lt,!1)},_date:function(pt){return lt("date:"+pt.toJSON())},_symbol:function(pt){return lt("symbol:"+pt.toString())},_error:function(pt){return lt("error:"+pt.toString())},_boolean:function(pt){return lt("bool:"+pt.toString())},_string:function(pt){lt("string:"+pt.length+":"),lt(pt.toString())},_function:function(pt){lt("fn:"),Ve(pt)?this.dispatch("[native]"):this.dispatch(pt.toString()),ut.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(pt.name)),ut.respectFunctionProperties&&this._object(pt)},_number:function(pt){return lt("number:"+pt.toString())},_xml:function(pt){return lt("xml:"+pt.toString())},_null:function(){return lt("Null")},_undefined:function(){return lt("Undefined")},_regexp:function(pt){return lt("regex:"+pt.toString())},_uint8array:function(pt){return lt("uint8array:"),this.dispatch(Array.prototype.slice.call(pt))},_uint8clampedarray:function(pt){return lt("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(pt))},_int8array:function(pt){return lt("uint8array:"),this.dispatch(Array.prototype.slice.call(pt))},_uint16array:function(pt){return lt("uint16array:"),this.dispatch(Array.prototype.slice.call(pt))},_int16array:function(pt){return lt("uint16array:"),this.dispatch(Array.prototype.slice.call(pt))},_uint32array:function(pt){return lt("uint32array:"),this.dispatch(Array.prototype.slice.call(pt))},_int32array:function(pt){return lt("uint32array:"),this.dispatch(Array.prototype.slice.call(pt))},_float32array:function(pt){return lt("float32array:"),this.dispatch(Array.prototype.slice.call(pt))},_float64array:function(pt){return lt("float64array:"),this.dispatch(Array.prototype.slice.call(pt))},_arraybuffer:function(pt){return lt("arraybuffer:"),this.dispatch(new Uint8Array(pt))},_url:function(pt){return lt("url:"+pt.toString())},_map:function(pt){lt("map:");var xt=Array.from(pt);return this._array(xt,ut.unorderedSets!==!1)},_set:function(pt){lt("set:");var xt=Array.from(pt);return this._array(xt,ut.unorderedSets!==!1)},_file:function(pt){return lt("file:"),this.dispatch([pt.name,pt.size,pt.type,pt.lastModfied])},_blob:function(){if(ut.ignoreUnknown)return lt("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return lt("domwindow")},_bigint:function(pt){return lt("bigint:"+pt.toString())},_process:function(){return lt("process")},_timer:function(){return lt("timer")},_pipe:function(){return lt("pipe")},_tcp:function(){return lt("tcp")},_udp:function(){return lt("udp")},_tty:function(){return lt("tty")},_statwatcher:function(){return lt("statwatcher")},_securecontext:function(){return lt("securecontext")},_connection:function(){return lt("connection")},_zlib:function(){return lt("zlib")},_context:function(){return lt("context")},_nodescript:function(){return lt("nodescript")},_httpparser:function(){return lt("httpparser")},_dataview:function(){return lt("dataview")},_signal:function(){return lt("signal")},_fsevent:function(){return lt("fsevent")},_tlswrap:function(){return lt("tlswrap")}}}function ht(){return{buf:"",write:function(ut){this.buf+=ut},end:function(ut){this.buf+=ut},read:function(){return this.buf}}}c.writeToStream=function(ut,_t,at){return at===void 0&&(at=_t,_t={}),tt(_t=ke(ut,_t),at).dispatch(ut)}}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_7eac155c.js","/")},{buffer:3,crypto:5,lYpoI2:10}],2:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){(function(ce){var ue=typeof Uint8Array<"u"?Uint8Array:Array,ye="+".charCodeAt(0),Oe="/".charCodeAt(0),ke="0".charCodeAt(0),Ve="a".charCodeAt(0),tt="A".charCodeAt(0),ht="-".charCodeAt(0),ut="_".charCodeAt(0);function _t(at){var lt=at.charCodeAt(0);return lt===ye||lt===ht?62:lt===Oe||lt===ut?63:lt<ke?-1:lt<ke+10?lt-ke+26+26:lt<tt+26?lt-tt:lt<Ve+26?lt-Ve+26:void 0}ce.toByteArray=function(at){var lt,pt;if(0<at.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var xt=at.length,Tt=at.charAt(xt-2)==="="?2:at.charAt(xt-1)==="="?1:0,Pt=new ue(3*at.length/4-Tt),Lt=0<Tt?at.length-4:at.length,Bt=0;function Ut(kt){Pt[Bt++]=kt}for(lt=0;lt<Lt;lt+=4,0)Ut((16711680&(pt=_t(at.charAt(lt))<<18|_t(at.charAt(lt+1))<<12|_t(at.charAt(lt+2))<<6|_t(at.charAt(lt+3))))>>16),Ut((65280&pt)>>8),Ut(255&pt);return Tt==2?Ut(255&(pt=_t(at.charAt(lt))<<2|_t(at.charAt(lt+1))>>4)):Tt==1&&(Ut((pt=_t(at.charAt(lt))<<10|_t(at.charAt(lt+1))<<4|_t(at.charAt(lt+2))>>2)>>8&255),Ut(255&pt)),Pt},ce.fromByteArray=function(at){var lt,pt,xt,Tt,Pt=at.length%3,Lt="";function Bt(Ut){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(Ut)}for(lt=0,xt=at.length-Pt;lt<xt;lt+=3)Lt+=Bt((Tt=pt=(at[lt]<<16)+(at[lt+1]<<8)+at[lt+2])>>18&63)+Bt(Tt>>12&63)+Bt(Tt>>6&63)+Bt(63&Tt);switch(Pt){case 1:Lt+=Bt((pt=at[at.length-1])>>2),Lt+=Bt(pt<<4&63),Lt+="==";break;case 2:Lt+=Bt((pt=(at[at.length-2]<<8)+at[at.length-1])>>10),Lt+=Bt(pt>>4&63),Lt+=Bt(pt<<2&63),Lt+="="}return Lt}})(c===void 0?this.base64js={}:c)}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:10}],3:[function(o,l,c){(function(u,h,ye,A,w,C,M,O,ne){var ce=o("base64-js"),ue=o("ieee754");function ye(Ct,Ht,qt){if(!(this instanceof ye))return new ye(Ct,Ht,qt);var Li,Ui,Xi,An,Ln,Nn=typeof Ct;if(Ht==="base64"&&Nn=="string")for(Ct=(Li=Ct).trim?Li.trim():Li.replace(/^\s+|\s+$/g,"");Ct.length%4!=0;)Ct+="=";if(Nn=="number")Ui=Bt(Ct);else if(Nn=="string")Ui=ye.byteLength(Ct,Ht);else{if(Nn!="object")throw new Error("First argument needs to be a number, array or string.");Ui=Bt(Ct.length)}if(ye._useTypedArrays?Xi=ye._augment(new Uint8Array(Ui)):((Xi=this).length=Ui,Xi._isBuffer=!0),ye._useTypedArrays&&typeof Ct.byteLength=="number")Xi._set(Ct);else if(Ut(Ln=Ct)||ye.isBuffer(Ln)||Ln&&typeof Ln=="object"&&typeof Ln.length=="number")for(An=0;An<Ui;An++)ye.isBuffer(Ct)?Xi[An]=Ct.readUInt8(An):Xi[An]=Ct[An];else if(Nn=="string")Xi.write(Ct,0,Ht);else if(Nn=="number"&&!ye._useTypedArrays&&!qt)for(An=0;An<Ui;An++)Xi[An]=0;return Xi}function Oe(Ct,Ht,qt,Li){Li||(ri(typeof qt=="boolean","missing or invalid endian"),ri(Ht!=null,"missing offset"),ri(Ht+1<Ct.length,"Trying to read beyond buffer length"));var Ui,Xi=Ct.length;if(!(Xi<=Ht))return qt?(Ui=Ct[Ht],Ht+1<Xi&&(Ui|=Ct[Ht+1]<<8)):(Ui=Ct[Ht]<<8,Ht+1<Xi&&(Ui|=Ct[Ht+1])),Ui}function ke(Ct,Ht,qt,Li){Li||(ri(typeof qt=="boolean","missing or invalid endian"),ri(Ht!=null,"missing offset"),ri(Ht+3<Ct.length,"Trying to read beyond buffer length"));var Ui,Xi=Ct.length;if(!(Xi<=Ht))return qt?(Ht+2<Xi&&(Ui=Ct[Ht+2]<<16),Ht+1<Xi&&(Ui|=Ct[Ht+1]<<8),Ui|=Ct[Ht],Ht+3<Xi&&(Ui+=Ct[Ht+3]<<24>>>0)):(Ht+1<Xi&&(Ui=Ct[Ht+1]<<16),Ht+2<Xi&&(Ui|=Ct[Ht+2]<<8),Ht+3<Xi&&(Ui|=Ct[Ht+3]),Ui+=Ct[Ht]<<24>>>0),Ui}function Ve(Ct,Ht,qt,Li){if(Li||(ri(typeof qt=="boolean","missing or invalid endian"),ri(Ht!=null,"missing offset"),ri(Ht+1<Ct.length,"Trying to read beyond buffer length")),!(Ct.length<=Ht)){var Ui=Oe(Ct,Ht,qt,!0);return 32768&Ui?-1*(65535-Ui+1):Ui}}function tt(Ct,Ht,qt,Li){if(Li||(ri(typeof qt=="boolean","missing or invalid endian"),ri(Ht!=null,"missing offset"),ri(Ht+3<Ct.length,"Trying to read beyond buffer length")),!(Ct.length<=Ht)){var Ui=ke(Ct,Ht,qt,!0);return 2147483648&Ui?-1*(4294967295-Ui+1):Ui}}function ht(Ct,Ht,qt,Li){return Li||(ri(typeof qt=="boolean","missing or invalid endian"),ri(Ht+3<Ct.length,"Trying to read beyond buffer length")),ue.read(Ct,Ht,qt,23,4)}function ut(Ct,Ht,qt,Li){return Li||(ri(typeof qt=="boolean","missing or invalid endian"),ri(Ht+7<Ct.length,"Trying to read beyond buffer length")),ue.read(Ct,Ht,qt,52,8)}function _t(Ct,Ht,qt,Li,Ui){Ui||(ri(Ht!=null,"missing value"),ri(typeof Li=="boolean","missing or invalid endian"),ri(qt!=null,"missing offset"),ri(qt+1<Ct.length,"trying to write beyond buffer length"),Zt(Ht,65535));var Xi=Ct.length;if(!(Xi<=qt))for(var An=0,Ln=Math.min(Xi-qt,2);An<Ln;An++)Ct[qt+An]=(Ht&255<<8*(Li?An:1-An))>>>8*(Li?An:1-An)}function at(Ct,Ht,qt,Li,Ui){Ui||(ri(Ht!=null,"missing value"),ri(typeof Li=="boolean","missing or invalid endian"),ri(qt!=null,"missing offset"),ri(qt+3<Ct.length,"trying to write beyond buffer length"),Zt(Ht,4294967295));var Xi=Ct.length;if(!(Xi<=qt))for(var An=0,Ln=Math.min(Xi-qt,4);An<Ln;An++)Ct[qt+An]=Ht>>>8*(Li?An:3-An)&255}function lt(Ct,Ht,qt,Li,Ui){Ui||(ri(Ht!=null,"missing value"),ri(typeof Li=="boolean","missing or invalid endian"),ri(qt!=null,"missing offset"),ri(qt+1<Ct.length,"Trying to write beyond buffer length"),ti(Ht,32767,-32768)),Ct.length<=qt||_t(Ct,0<=Ht?Ht:65535+Ht+1,qt,Li,Ui)}function pt(Ct,Ht,qt,Li,Ui){Ui||(ri(Ht!=null,"missing value"),ri(typeof Li=="boolean","missing or invalid endian"),ri(qt!=null,"missing offset"),ri(qt+3<Ct.length,"Trying to write beyond buffer length"),ti(Ht,2147483647,-2147483648)),Ct.length<=qt||at(Ct,0<=Ht?Ht:4294967295+Ht+1,qt,Li,Ui)}function xt(Ct,Ht,qt,Li,Ui){Ui||(ri(Ht!=null,"missing value"),ri(typeof Li=="boolean","missing or invalid endian"),ri(qt!=null,"missing offset"),ri(qt+3<Ct.length,"Trying to write beyond buffer length"),ci(Ht,34028234663852886e22,-34028234663852886e22)),Ct.length<=qt||ue.write(Ct,Ht,qt,Li,23,4)}function Tt(Ct,Ht,qt,Li,Ui){Ui||(ri(Ht!=null,"missing value"),ri(typeof Li=="boolean","missing or invalid endian"),ri(qt!=null,"missing offset"),ri(qt+7<Ct.length,"Trying to write beyond buffer length"),ci(Ht,17976931348623157e292,-17976931348623157e292)),Ct.length<=qt||ue.write(Ct,Ht,qt,Li,52,8)}c.Buffer=ye,c.SlowBuffer=ye,c.INSPECT_MAX_BYTES=50,ye.poolSize=8192,ye._useTypedArrays=function(){try{var Ct=new ArrayBuffer(0),Ht=new Uint8Array(Ct);return Ht.foo=function(){return 42},Ht.foo()===42&&typeof Ht.subarray=="function"}catch{return!1}}(),ye.isEncoding=function(Ct){switch(String(Ct).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},ye.isBuffer=function(Ct){return!(Ct==null||!Ct._isBuffer)},ye.byteLength=function(Ct,Ht){var qt;switch(Ct+="",Ht||"utf8"){case"hex":qt=Ct.length/2;break;case"utf8":case"utf-8":qt=Vt(Ct).length;break;case"ascii":case"binary":case"raw":qt=Ct.length;break;case"base64":qt=si(Ct).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":qt=2*Ct.length;break;default:throw new Error("Unknown encoding")}return qt},ye.concat=function(Ct,Ht){if(ri(Ut(Ct),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),Ct.length===0)return new ye(0);if(Ct.length===1)return Ct[0];if(typeof Ht!="number")for(Ui=Ht=0;Ui<Ct.length;Ui++)Ht+=Ct[Ui].length;for(var qt=new ye(Ht),Li=0,Ui=0;Ui<Ct.length;Ui++){var Xi=Ct[Ui];Xi.copy(qt,Li),Li+=Xi.length}return qt},ye.prototype.write=function(Ct,Ht,qt,Li){var Ui;isFinite(Ht)?isFinite(qt)||(Li=qt,qt=void 0):(Ui=Li,Li=Ht,Ht=qt,qt=Ui),Ht=Number(Ht)||0;var Xi,An,Ln,Nn,Kn,_i,Gi,sn=this.length-Ht;switch((!qt||sn<(qt=Number(qt)))&&(qt=sn),Li=String(Li||"utf8").toLowerCase()){case"hex":Xi=function(jt,Gt,li,vi){li=Number(li)||0;var xi=jt.length-li;(!vi||xi<(vi=Number(vi)))&&(vi=xi);var mi=Gt.length;ri(mi%2==0,"Invalid hex string"),mi/2<vi&&(vi=mi/2);for(var Ri=0;Ri<vi;Ri++){var Zi=parseInt(Gt.substr(2*Ri,2),16);ri(!isNaN(Zi),"Invalid hex string"),jt[li+Ri]=Zi}return ye._charsWritten=2*Ri,Ri}(this,Ct,Ht,qt);break;case"utf8":case"utf-8":Kn=Ct,_i=Ht,Gi=qt,Xi=ye._charsWritten=Jt(Vt(Kn),this,_i,Gi);break;case"ascii":case"binary":Xi=function(jt,Gt,li,vi){return ye._charsWritten=Jt(function(xi){for(var mi=[],Ri=0;Ri<xi.length;Ri++)mi.push(255&xi.charCodeAt(Ri));return mi}(Gt),jt,li,vi)}(this,Ct,Ht,qt);break;case"base64":An=Ct,Ln=Ht,Nn=qt,Xi=ye._charsWritten=Jt(si(An),this,Ln,Nn);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":Xi=function(jt,Gt,li,vi){return ye._charsWritten=Jt(function(xi){for(var mi,Ri,Zi,dn=[],hn=0;hn<xi.length;hn++)Ri=(mi=xi.charCodeAt(hn))>>8,Zi=mi%256,dn.push(Zi),dn.push(Ri);return dn}(Gt),jt,li,vi)}(this,Ct,Ht,qt);break;default:throw new Error("Unknown encoding")}return Xi},ye.prototype.toString=function(Ct,Ht,qt){var Li,Ui,Xi,An,Ln=this;if(Ct=String(Ct||"utf8").toLowerCase(),Ht=Number(Ht)||0,(qt=qt!==void 0?Number(qt):qt=Ln.length)===Ht)return"";switch(Ct){case"hex":Li=function(Nn,Kn,_i){var Gi=Nn.length;(!Kn||Kn<0)&&(Kn=0),(!_i||_i<0||Gi<_i)&&(_i=Gi);for(var sn="",jt=Kn;jt<_i;jt++)sn+=kt(Nn[jt]);return sn}(Ln,Ht,qt);break;case"utf8":case"utf-8":Li=function(Nn,Kn,_i){var Gi="",sn="";_i=Math.min(Nn.length,_i);for(var jt=Kn;jt<_i;jt++)Nn[jt]<=127?(Gi+=Wt(sn)+String.fromCharCode(Nn[jt]),sn=""):sn+="%"+Nn[jt].toString(16);return Gi+Wt(sn)}(Ln,Ht,qt);break;case"ascii":case"binary":Li=function(Nn,Kn,_i){var Gi="";_i=Math.min(Nn.length,_i);for(var sn=Kn;sn<_i;sn++)Gi+=String.fromCharCode(Nn[sn]);return Gi}(Ln,Ht,qt);break;case"base64":Ui=Ln,An=qt,Li=(Xi=Ht)===0&&An===Ui.length?ce.fromByteArray(Ui):ce.fromByteArray(Ui.slice(Xi,An));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":Li=function(Nn,Kn,_i){for(var Gi=Nn.slice(Kn,_i),sn="",jt=0;jt<Gi.length;jt+=2)sn+=String.fromCharCode(Gi[jt]+256*Gi[jt+1]);return sn}(Ln,Ht,qt);break;default:throw new Error("Unknown encoding")}return Li},ye.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},ye.prototype.copy=function(Ct,Ht,qt,Li){if(qt=qt||0,Li||Li===0||(Li=this.length),Ht=Ht||0,Li!==qt&&Ct.length!==0&&this.length!==0){ri(qt<=Li,"sourceEnd < sourceStart"),ri(0<=Ht&&Ht<Ct.length,"targetStart out of bounds"),ri(0<=qt&&qt<this.length,"sourceStart out of bounds"),ri(0<=Li&&Li<=this.length,"sourceEnd out of bounds"),Li>this.length&&(Li=this.length),Ct.length-Ht<Li-qt&&(Li=Ct.length-Ht+qt);var Ui=Li-qt;if(Ui<100||!ye._useTypedArrays)for(var Xi=0;Xi<Ui;Xi++)Ct[Xi+Ht]=this[Xi+qt];else Ct._set(this.subarray(qt,qt+Ui),Ht)}},ye.prototype.slice=function(Ct,Ht){var qt=this.length;if(Ct=Lt(Ct,qt,0),Ht=Lt(Ht,qt,qt),ye._useTypedArrays)return ye._augment(this.subarray(Ct,Ht));for(var Li=Ht-Ct,Ui=new ye(Li,void 0,!0),Xi=0;Xi<Li;Xi++)Ui[Xi]=this[Xi+Ct];return Ui},ye.prototype.get=function(Ct){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(Ct)},ye.prototype.set=function(Ct,Ht){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(Ct,Ht)},ye.prototype.readUInt8=function(Ct,Ht){if(Ht||(ri(Ct!=null,"missing offset"),ri(Ct<this.length,"Trying to read beyond buffer length")),!(Ct>=this.length))return this[Ct]},ye.prototype.readUInt16LE=function(Ct,Ht){return Oe(this,Ct,!0,Ht)},ye.prototype.readUInt16BE=function(Ct,Ht){return Oe(this,Ct,!1,Ht)},ye.prototype.readUInt32LE=function(Ct,Ht){return ke(this,Ct,!0,Ht)},ye.prototype.readUInt32BE=function(Ct,Ht){return ke(this,Ct,!1,Ht)},ye.prototype.readInt8=function(Ct,Ht){if(Ht||(ri(Ct!=null,"missing offset"),ri(Ct<this.length,"Trying to read beyond buffer length")),!(Ct>=this.length))return 128&this[Ct]?-1*(255-this[Ct]+1):this[Ct]},ye.prototype.readInt16LE=function(Ct,Ht){return Ve(this,Ct,!0,Ht)},ye.prototype.readInt16BE=function(Ct,Ht){return Ve(this,Ct,!1,Ht)},ye.prototype.readInt32LE=function(Ct,Ht){return tt(this,Ct,!0,Ht)},ye.prototype.readInt32BE=function(Ct,Ht){return tt(this,Ct,!1,Ht)},ye.prototype.readFloatLE=function(Ct,Ht){return ht(this,Ct,!0,Ht)},ye.prototype.readFloatBE=function(Ct,Ht){return ht(this,Ct,!1,Ht)},ye.prototype.readDoubleLE=function(Ct,Ht){return ut(this,Ct,!0,Ht)},ye.prototype.readDoubleBE=function(Ct,Ht){return ut(this,Ct,!1,Ht)},ye.prototype.writeUInt8=function(Ct,Ht,qt){qt||(ri(Ct!=null,"missing value"),ri(Ht!=null,"missing offset"),ri(Ht<this.length,"trying to write beyond buffer length"),Zt(Ct,255)),Ht>=this.length||(this[Ht]=Ct)},ye.prototype.writeUInt16LE=function(Ct,Ht,qt){_t(this,Ct,Ht,!0,qt)},ye.prototype.writeUInt16BE=function(Ct,Ht,qt){_t(this,Ct,Ht,!1,qt)},ye.prototype.writeUInt32LE=function(Ct,Ht,qt){at(this,Ct,Ht,!0,qt)},ye.prototype.writeUInt32BE=function(Ct,Ht,qt){at(this,Ct,Ht,!1,qt)},ye.prototype.writeInt8=function(Ct,Ht,qt){qt||(ri(Ct!=null,"missing value"),ri(Ht!=null,"missing offset"),ri(Ht<this.length,"Trying to write beyond buffer length"),ti(Ct,127,-128)),Ht>=this.length||(0<=Ct?this.writeUInt8(Ct,Ht,qt):this.writeUInt8(255+Ct+1,Ht,qt))},ye.prototype.writeInt16LE=function(Ct,Ht,qt){lt(this,Ct,Ht,!0,qt)},ye.prototype.writeInt16BE=function(Ct,Ht,qt){lt(this,Ct,Ht,!1,qt)},ye.prototype.writeInt32LE=function(Ct,Ht,qt){pt(this,Ct,Ht,!0,qt)},ye.prototype.writeInt32BE=function(Ct,Ht,qt){pt(this,Ct,Ht,!1,qt)},ye.prototype.writeFloatLE=function(Ct,Ht,qt){xt(this,Ct,Ht,!0,qt)},ye.prototype.writeFloatBE=function(Ct,Ht,qt){xt(this,Ct,Ht,!1,qt)},ye.prototype.writeDoubleLE=function(Ct,Ht,qt){Tt(this,Ct,Ht,!0,qt)},ye.prototype.writeDoubleBE=function(Ct,Ht,qt){Tt(this,Ct,Ht,!1,qt)},ye.prototype.fill=function(Ct,Ht,qt){if(Ct=Ct||0,Ht=Ht||0,qt=qt||this.length,typeof Ct=="string"&&(Ct=Ct.charCodeAt(0)),ri(typeof Ct=="number"&&!isNaN(Ct),"value is not a number"),ri(Ht<=qt,"end < start"),qt!==Ht&&this.length!==0){ri(0<=Ht&&Ht<this.length,"start out of bounds"),ri(0<=qt&&qt<=this.length,"end out of bounds");for(var Li=Ht;Li<qt;Li++)this[Li]=Ct}},ye.prototype.inspect=function(){for(var Ct=[],Ht=this.length,qt=0;qt<Ht;qt++)if(Ct[qt]=kt(this[qt]),qt===c.INSPECT_MAX_BYTES){Ct[qt+1]="...";break}return"<Buffer "+Ct.join(" ")+">"},ye.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(ye._useTypedArrays)return new ye(this).buffer;for(var Ct=new Uint8Array(this.length),Ht=0,qt=Ct.length;Ht<qt;Ht+=1)Ct[Ht]=this[Ht];return Ct.buffer};var Pt=ye.prototype;function Lt(Ct,Ht,qt){return typeof Ct!="number"?qt:Ht<=(Ct=~~Ct)?Ht:0<=Ct||0<=(Ct+=Ht)?Ct:0}function Bt(Ct){return(Ct=~~Math.ceil(+Ct))<0?0:Ct}function Ut(Ct){return(Array.isArray||function(Ht){return Object.prototype.toString.call(Ht)==="[object Array]"})(Ct)}function kt(Ct){return Ct<16?"0"+Ct.toString(16):Ct.toString(16)}function Vt(Ct){for(var Ht=[],qt=0;qt<Ct.length;qt++){var Li=Ct.charCodeAt(qt);if(Li<=127)Ht.push(Ct.charCodeAt(qt));else{var Ui=qt;55296<=Li&&Li<=57343&&qt++;for(var Xi=encodeURIComponent(Ct.slice(Ui,qt+1)).substr(1).split("%"),An=0;An<Xi.length;An++)Ht.push(parseInt(Xi[An],16))}}return Ht}function si(Ct){return ce.toByteArray(Ct)}function Jt(Ct,Ht,qt,Li){for(var Ui=0;Ui<Li&&!(Ui+qt>=Ht.length||Ui>=Ct.length);Ui++)Ht[Ui+qt]=Ct[Ui];return Ui}function Wt(Ct){try{return decodeURIComponent(Ct)}catch{return String.fromCharCode(65533)}}function Zt(Ct,Ht){ri(typeof Ct=="number","cannot write a non-number as a number"),ri(0<=Ct,"specified a negative value for writing an unsigned value"),ri(Ct<=Ht,"value is larger than maximum value for type"),ri(Math.floor(Ct)===Ct,"value has a fractional component")}function ti(Ct,Ht,qt){ri(typeof Ct=="number","cannot write a non-number as a number"),ri(Ct<=Ht,"value larger than maximum allowed value"),ri(qt<=Ct,"value smaller than minimum allowed value"),ri(Math.floor(Ct)===Ct,"value has a fractional component")}function ci(Ct,Ht,qt){ri(typeof Ct=="number","cannot write a non-number as a number"),ri(Ct<=Ht,"value larger than maximum allowed value"),ri(qt<=Ct,"value smaller than minimum allowed value")}function ri(Ct,Ht){if(!Ct)throw new Error(Ht||"Failed assertion")}ye._augment=function(Ct){return Ct._isBuffer=!0,Ct._get=Ct.get,Ct._set=Ct.set,Ct.get=Pt.get,Ct.set=Pt.set,Ct.write=Pt.write,Ct.toString=Pt.toString,Ct.toLocaleString=Pt.toString,Ct.toJSON=Pt.toJSON,Ct.copy=Pt.copy,Ct.slice=Pt.slice,Ct.readUInt8=Pt.readUInt8,Ct.readUInt16LE=Pt.readUInt16LE,Ct.readUInt16BE=Pt.readUInt16BE,Ct.readUInt32LE=Pt.readUInt32LE,Ct.readUInt32BE=Pt.readUInt32BE,Ct.readInt8=Pt.readInt8,Ct.readInt16LE=Pt.readInt16LE,Ct.readInt16BE=Pt.readInt16BE,Ct.readInt32LE=Pt.readInt32LE,Ct.readInt32BE=Pt.readInt32BE,Ct.readFloatLE=Pt.readFloatLE,Ct.readFloatBE=Pt.readFloatBE,Ct.readDoubleLE=Pt.readDoubleLE,Ct.readDoubleBE=Pt.readDoubleBE,Ct.writeUInt8=Pt.writeUInt8,Ct.writeUInt16LE=Pt.writeUInt16LE,Ct.writeUInt16BE=Pt.writeUInt16BE,Ct.writeUInt32LE=Pt.writeUInt32LE,Ct.writeUInt32BE=Pt.writeUInt32BE,Ct.writeInt8=Pt.writeInt8,Ct.writeInt16LE=Pt.writeInt16LE,Ct.writeInt16BE=Pt.writeInt16BE,Ct.writeInt32LE=Pt.writeInt32LE,Ct.writeInt32BE=Pt.writeInt32BE,Ct.writeFloatLE=Pt.writeFloatLE,Ct.writeFloatBE=Pt.writeFloatBE,Ct.writeDoubleLE=Pt.writeDoubleLE,Ct.writeDoubleBE=Pt.writeDoubleBE,Ct.fill=Pt.fill,Ct.inspect=Pt.inspect,Ct.toArrayBuffer=Pt.toArrayBuffer,Ct}}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:11,lYpoI2:10}],4:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){_=o("buffer").Buffer;var ce=new _(4);ce.fill(0),l.exports={hash:function(ue,ye,Oe,ke){return _.isBuffer(ue)||(ue=new _(ue)),function(Ve,tt,ht){for(var ut=new _(tt),_t=ht?ut.writeInt32BE:ut.writeInt32LE,at=0;at<Ve.length;at++)_t.call(ut,Ve[at],4*at,!0);return ut}(ye(function(Ve,tt){var ht;Ve.length%4!=0&&(ht=Ve.length+(4-Ve.length%4),Ve=_.concat([Ve,ce],ht));for(var ut=[],_t=tt?Ve.readInt32BE:Ve.readInt32LE,at=0;at<Ve.length;at+=4)ut.push(_t.call(Ve,at));return ut}(ue,ke),8*ue.length),Oe,ke)}}}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:10}],5:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){_=o("buffer").Buffer;var ce=o("./sha"),ue=o("./sha256"),ye=o("./rng"),Oe={sha1:ce,sha256:ue,md5:o("./md5")},ke=64,Ve=new _(ke);function tt(ut,_t){var at=Oe[ut=ut||"sha1"],lt=[];return at||ht("algorithm:",ut,"is not yet supported"),{update:function(pt){return _.isBuffer(pt)||(pt=new _(pt)),lt.push(pt),pt.length,this},digest:function(pt){var xt=_.concat(lt),Tt=_t?function(Pt,Lt,Bt){_.isBuffer(Lt)||(Lt=new _(Lt)),_.isBuffer(Bt)||(Bt=new _(Bt)),Lt.length>ke?Lt=Pt(Lt):Lt.length<ke&&(Lt=_.concat([Lt,Ve],ke));for(var Ut=new _(ke),kt=new _(ke),Vt=0;Vt<ke;Vt++)Ut[Vt]=54^Lt[Vt],kt[Vt]=92^Lt[Vt];var si=Pt(_.concat([Ut,Bt]));return Pt(_.concat([kt,si]))}(at,_t,xt):at(xt);return lt=null,pt?Tt.toString(pt):Tt}}}function ht(){var ut=[].slice.call(arguments).join(" ");throw new Error([ut,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}Ve.fill(0),c.createHash=function(ut){return tt(ut)},c.createHmac=tt,c.randomBytes=function(ut,_t){if(!_t||!_t.call)return new _(ye(ut));try{_t.call(this,void 0,new _(ye(ut)))}catch(at){_t(at)}},function(ut,_t){for(var at in ut)_t(ut[at])}(["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],function(ut){c[ut]=function(){ht("sorry,",ut,"is not implemented yet")}})}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:10}],6:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){var ce=o("./helpers");function ue(ut,_t){ut[_t>>5]|=128<<_t%32,ut[14+(_t+64>>>9<<4)]=_t;for(var at=1732584193,lt=-271733879,pt=-1732584194,xt=271733878,Tt=0;Tt<ut.length;Tt+=16){var Pt=at,Lt=lt,Bt=pt,Ut=xt;at=Oe(at,lt,pt,xt,ut[Tt+0],7,-680876936),xt=Oe(xt,at,lt,pt,ut[Tt+1],12,-389564586),pt=Oe(pt,xt,at,lt,ut[Tt+2],17,606105819),lt=Oe(lt,pt,xt,at,ut[Tt+3],22,-1044525330),at=Oe(at,lt,pt,xt,ut[Tt+4],7,-176418897),xt=Oe(xt,at,lt,pt,ut[Tt+5],12,1200080426),pt=Oe(pt,xt,at,lt,ut[Tt+6],17,-1473231341),lt=Oe(lt,pt,xt,at,ut[Tt+7],22,-45705983),at=Oe(at,lt,pt,xt,ut[Tt+8],7,1770035416),xt=Oe(xt,at,lt,pt,ut[Tt+9],12,-1958414417),pt=Oe(pt,xt,at,lt,ut[Tt+10],17,-42063),lt=Oe(lt,pt,xt,at,ut[Tt+11],22,-1990404162),at=Oe(at,lt,pt,xt,ut[Tt+12],7,1804603682),xt=Oe(xt,at,lt,pt,ut[Tt+13],12,-40341101),pt=Oe(pt,xt,at,lt,ut[Tt+14],17,-1502002290),at=ke(at,lt=Oe(lt,pt,xt,at,ut[Tt+15],22,1236535329),pt,xt,ut[Tt+1],5,-165796510),xt=ke(xt,at,lt,pt,ut[Tt+6],9,-1069501632),pt=ke(pt,xt,at,lt,ut[Tt+11],14,643717713),lt=ke(lt,pt,xt,at,ut[Tt+0],20,-373897302),at=ke(at,lt,pt,xt,ut[Tt+5],5,-701558691),xt=ke(xt,at,lt,pt,ut[Tt+10],9,38016083),pt=ke(pt,xt,at,lt,ut[Tt+15],14,-660478335),lt=ke(lt,pt,xt,at,ut[Tt+4],20,-405537848),at=ke(at,lt,pt,xt,ut[Tt+9],5,568446438),xt=ke(xt,at,lt,pt,ut[Tt+14],9,-1019803690),pt=ke(pt,xt,at,lt,ut[Tt+3],14,-187363961),lt=ke(lt,pt,xt,at,ut[Tt+8],20,1163531501),at=ke(at,lt,pt,xt,ut[Tt+13],5,-1444681467),xt=ke(xt,at,lt,pt,ut[Tt+2],9,-51403784),pt=ke(pt,xt,at,lt,ut[Tt+7],14,1735328473),at=Ve(at,lt=ke(lt,pt,xt,at,ut[Tt+12],20,-1926607734),pt,xt,ut[Tt+5],4,-378558),xt=Ve(xt,at,lt,pt,ut[Tt+8],11,-2022574463),pt=Ve(pt,xt,at,lt,ut[Tt+11],16,1839030562),lt=Ve(lt,pt,xt,at,ut[Tt+14],23,-35309556),at=Ve(at,lt,pt,xt,ut[Tt+1],4,-1530992060),xt=Ve(xt,at,lt,pt,ut[Tt+4],11,1272893353),pt=Ve(pt,xt,at,lt,ut[Tt+7],16,-155497632),lt=Ve(lt,pt,xt,at,ut[Tt+10],23,-1094730640),at=Ve(at,lt,pt,xt,ut[Tt+13],4,681279174),xt=Ve(xt,at,lt,pt,ut[Tt+0],11,-358537222),pt=Ve(pt,xt,at,lt,ut[Tt+3],16,-722521979),lt=Ve(lt,pt,xt,at,ut[Tt+6],23,76029189),at=Ve(at,lt,pt,xt,ut[Tt+9],4,-640364487),xt=Ve(xt,at,lt,pt,ut[Tt+12],11,-421815835),pt=Ve(pt,xt,at,lt,ut[Tt+15],16,530742520),at=tt(at,lt=Ve(lt,pt,xt,at,ut[Tt+2],23,-995338651),pt,xt,ut[Tt+0],6,-198630844),xt=tt(xt,at,lt,pt,ut[Tt+7],10,1126891415),pt=tt(pt,xt,at,lt,ut[Tt+14],15,-1416354905),lt=tt(lt,pt,xt,at,ut[Tt+5],21,-57434055),at=tt(at,lt,pt,xt,ut[Tt+12],6,1700485571),xt=tt(xt,at,lt,pt,ut[Tt+3],10,-1894986606),pt=tt(pt,xt,at,lt,ut[Tt+10],15,-1051523),lt=tt(lt,pt,xt,at,ut[Tt+1],21,-2054922799),at=tt(at,lt,pt,xt,ut[Tt+8],6,1873313359),xt=tt(xt,at,lt,pt,ut[Tt+15],10,-30611744),pt=tt(pt,xt,at,lt,ut[Tt+6],15,-1560198380),lt=tt(lt,pt,xt,at,ut[Tt+13],21,1309151649),at=tt(at,lt,pt,xt,ut[Tt+4],6,-145523070),xt=tt(xt,at,lt,pt,ut[Tt+11],10,-1120210379),pt=tt(pt,xt,at,lt,ut[Tt+2],15,718787259),lt=tt(lt,pt,xt,at,ut[Tt+9],21,-343485551),at=ht(at,Pt),lt=ht(lt,Lt),pt=ht(pt,Bt),xt=ht(xt,Ut)}return Array(at,lt,pt,xt)}function ye(ut,_t,at,lt,pt,xt){return ht((Tt=ht(ht(_t,ut),ht(lt,xt)))<<(Pt=pt)|Tt>>>32-Pt,at);var Tt,Pt}function Oe(ut,_t,at,lt,pt,xt,Tt){return ye(_t&at|~_t&lt,ut,_t,pt,xt,Tt)}function ke(ut,_t,at,lt,pt,xt,Tt){return ye(_t&lt|at&~lt,ut,_t,pt,xt,Tt)}function Ve(ut,_t,at,lt,pt,xt,Tt){return ye(_t^at^lt,ut,_t,pt,xt,Tt)}function tt(ut,_t,at,lt,pt,xt,Tt){return ye(at^(_t|~lt),ut,_t,pt,xt,Tt)}function ht(ut,_t){var at=(65535&ut)+(65535&_t);return(ut>>16)+(_t>>16)+(at>>16)<<16|65535&at}l.exports=function(ut){return ce.hash(ut,ue,16)}}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:10}],7:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){var ce;ce=function(ue){for(var ye,Oe=new Array(ue),ke=0;ke<ue;ke++)!(3&ke)&&(ye=4294967296*Math.random()),Oe[ke]=ye>>>((3&ke)<<3)&255;return Oe},l.exports=ce}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:10}],8:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){var ce=o("./helpers");function ue(ke,Ve){ke[Ve>>5]|=128<<24-Ve%32,ke[15+(Ve+64>>9<<4)]=Ve;for(var tt,ht,ut,_t,at,lt=Array(80),pt=1732584193,xt=-271733879,Tt=-1732584194,Pt=271733878,Lt=-1009589776,Bt=0;Bt<ke.length;Bt+=16){for(var Ut=pt,kt=xt,Vt=Tt,si=Pt,Jt=Lt,Wt=0;Wt<80;Wt++){lt[Wt]=Wt<16?ke[Bt+Wt]:Oe(lt[Wt-3]^lt[Wt-8]^lt[Wt-14]^lt[Wt-16],1);var Zt=ye(ye(Oe(pt,5),(ut=xt,_t=Tt,at=Pt,(ht=Wt)<20?ut&_t|~ut&at:!(ht<40)&&ht<60?ut&_t|ut&at|_t&at:ut^_t^at)),ye(ye(Lt,lt[Wt]),(tt=Wt)<20?1518500249:tt<40?1859775393:tt<60?-1894007588:-899497514));Lt=Pt,Pt=Tt,Tt=Oe(xt,30),xt=pt,pt=Zt}pt=ye(pt,Ut),xt=ye(xt,kt),Tt=ye(Tt,Vt),Pt=ye(Pt,si),Lt=ye(Lt,Jt)}return Array(pt,xt,Tt,Pt,Lt)}function ye(ke,Ve){var tt=(65535&ke)+(65535&Ve);return(ke>>16)+(Ve>>16)+(tt>>16)<<16|65535&tt}function Oe(ke,Ve){return ke<<Ve|ke>>>32-Ve}l.exports=function(ke){return ce.hash(ke,ue,20,!0)}}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:10}],9:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){function ce(ke,Ve){var tt=(65535&ke)+(65535&Ve);return(ke>>16)+(Ve>>16)+(tt>>16)<<16|65535&tt}function ue(ke,Ve){return ke>>>Ve|ke<<32-Ve}function ye(ke,Ve){var tt,ht,ut,_t,at,lt,pt,xt,Tt,Pt,Lt=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),Bt=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),Ut=new Array(64);ke[Ve>>5]|=128<<24-Ve%32,ke[15+(Ve+64>>9<<4)]=Ve;for(var kt,Vt,si,Jt,Wt,Zt,ti,ci,ri=0;ri<ke.length;ri+=16){tt=Bt[0],ht=Bt[1],ut=Bt[2],_t=Bt[3],at=Bt[4],lt=Bt[5],pt=Bt[6],xt=Bt[7];for(var Ct=0;Ct<64;Ct++)Ut[Ct]=Ct<16?ke[Ct+ri]:ce(ce(ce(ue(ci=Ut[Ct-2],17)^ue(ci,19)^ci>>>10,Ut[Ct-7]),ue(ti=Ut[Ct-15],7)^ue(ti,18)^ti>>>3),Ut[Ct-16]),Tt=ce(ce(ce(ce(xt,ue(Zt=at,6)^ue(Zt,11)^ue(Zt,25)),(Wt=at)&lt^~Wt&pt),Lt[Ct]),Ut[Ct]),Pt=ce(ue(Jt=tt,2)^ue(Jt,13)^ue(Jt,22),(kt=tt)&(Vt=ht)^kt&(si=ut)^Vt&si),xt=pt,pt=lt,lt=at,at=ce(_t,Tt),_t=ut,ut=ht,ht=tt,tt=ce(Tt,Pt);Bt[0]=ce(tt,Bt[0]),Bt[1]=ce(ht,Bt[1]),Bt[2]=ce(ut,Bt[2]),Bt[3]=ce(_t,Bt[3]),Bt[4]=ce(at,Bt[4]),Bt[5]=ce(lt,Bt[5]),Bt[6]=ce(pt,Bt[6]),Bt[7]=ce(xt,Bt[7])}return Bt}var Oe=o("./helpers");l.exports=function(ke){return Oe.hash(ke,ye,32,!0)}}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:10}],10:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){function ce(){}(u=l.exports={}).nextTick=function(){var ue=typeof window<"u"&&window.setImmediate,ye=typeof window<"u"&&window.postMessage&&window.addEventListener;if(ue)return function(ke){return window.setImmediate(ke)};if(ye){var Oe=[];return window.addEventListener("message",function(ke){var Ve=ke.source;Ve!==window&&Ve!==null||ke.data!=="process-tick"||(ke.stopPropagation(),0<Oe.length&&Oe.shift()())},!0),function(ke){Oe.push(ke),window.postMessage("process-tick","*")}}return function(ke){setTimeout(ke,0)}}(),u.title="browser",u.browser=!0,u.env={},u.argv=[],u.on=ce,u.addListener=ce,u.once=ce,u.off=ce,u.removeListener=ce,u.removeAllListeners=ce,u.emit=ce,u.binding=function(ue){throw new Error("process.binding is not supported")},u.cwd=function(){return"/"},u.chdir=function(ue){throw new Error("process.chdir is not supported")}}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:10}],11:[function(o,l,c){(function(u,h,_,A,w,C,M,O,ne){c.read=function(ce,ue,ye,Oe,ke){var Ve,tt,ht=8*ke-Oe-1,ut=(1<<ht)-1,_t=ut>>1,at=-7,lt=ye?ke-1:0,pt=ye?-1:1,xt=ce[ue+lt];for(lt+=pt,Ve=xt&(1<<-at)-1,xt>>=-at,at+=ht;0<at;Ve=256*Ve+ce[ue+lt],lt+=pt,at-=8);for(tt=Ve&(1<<-at)-1,Ve>>=-at,at+=Oe;0<at;tt=256*tt+ce[ue+lt],lt+=pt,at-=8);if(Ve===0)Ve=1-_t;else{if(Ve===ut)return tt?NaN:1/0*(xt?-1:1);tt+=Math.pow(2,Oe),Ve-=_t}return(xt?-1:1)*tt*Math.pow(2,Ve-Oe)},c.write=function(ce,ue,ye,Oe,ke,Ve){var tt,ht,ut,_t=8*Ve-ke-1,at=(1<<_t)-1,lt=at>>1,pt=ke===23?Math.pow(2,-24)-Math.pow(2,-77):0,xt=Oe?0:Ve-1,Tt=Oe?1:-1,Pt=ue<0||ue===0&&1/ue<0?1:0;for(ue=Math.abs(ue),isNaN(ue)||ue===1/0?(ht=isNaN(ue)?1:0,tt=at):(tt=Math.floor(Math.log(ue)/Math.LN2),ue*(ut=Math.pow(2,-tt))<1&&(tt--,ut*=2),2<=(ue+=1<=tt+lt?pt/ut:pt*Math.pow(2,1-lt))*ut&&(tt++,ut/=2),at<=tt+lt?(ht=0,tt=at):1<=tt+lt?(ht=(ue*ut-1)*Math.pow(2,ke),tt+=lt):(ht=ue*Math.pow(2,lt-1)*Math.pow(2,ke),tt=0));8<=ke;ce[ye+xt]=255&ht,xt+=Tt,ht/=256,ke-=8);for(tt=tt<<ke|ht,_t+=ke;0<_t;ce[ye+xt]=255&tt,xt+=Tt,tt/=256,_t-=8);ce[ye+xt-Tt]|=128*Pt}}).call(this,o("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},o("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/ieee754/index.js","/node_modules/ieee754")},{buffer:3,lYpoI2:10}]},{},[1])(1)},391:function(d){var o=function(){function l(ye){return M(ye,O(C(ne(ye.length),ye),1/ye.length))}function c(ye){return C(ce(ye),ye)}function u(ye,Oe){return O(ye,Oe?1/(ye.length-1):1/ye.length)}function h(ye){var Oe=function(tt){var ht,ut=Math.pow(2,-52),_t=1e-64/ut,at=0,lt=0,pt=0,xt=0,Tt=0,Pt=ue(tt),Lt=Pt.length,Bt=Pt[0].length;if(Lt<Bt)throw"Need more rows than columns";var Ut=new Array(Bt),kt=new Array(Bt);for(lt=0;lt<Bt;lt++)Ut[lt]=kt[lt]=0;var Vt=function Ui(Xi,An,Ln){Ln===void 0&&(Ln=0);var Nn,Kn=Xi[Ln],_i=Array(Kn);if(Ln===Xi.length-1){for(Nn=Kn-2;Nn>=0;Nn-=2)_i[Nn+1]=An,_i[Nn]=An;return Nn===-1&&(_i[0]=An),_i}for(Nn=Kn-1;Nn>=0;Nn--)_i[Nn]=Ui(Xi,An,Ln+1);return _i}([Bt,Bt],0);function si(Ui,Xi){return(Ui=Math.abs(Ui))>(Xi=Math.abs(Xi))?Ui*Math.sqrt(1+Xi*Xi/Ui/Ui):Xi==0?Ui:Xi*Math.sqrt(1+Ui*Ui/Xi/Xi)}var Jt=0,Wt=0,Zt=0,ti=0,ci=0,ri=0,Ct=0;for(lt=0;lt<Bt;lt++){for(Ut[lt]=Wt,Ct=0,Tt=lt+1,pt=lt;pt<Lt;pt++)Ct+=Pt[pt][lt]*Pt[pt][lt];if(Ct<=_t)Wt=0;else for(Jt=Pt[lt][lt],Wt=Math.sqrt(Ct),Jt>=0&&(Wt=-Wt),Zt=Jt*Wt-Ct,Pt[lt][lt]=Jt-Wt,pt=Tt;pt<Bt;pt++){for(Ct=0,xt=lt;xt<Lt;xt++)Ct+=Pt[xt][lt]*Pt[xt][pt];for(Jt=Ct/Zt,xt=lt;xt<Lt;xt++)Pt[xt][pt]+=Jt*Pt[xt][lt]}for(kt[lt]=Wt,Ct=0,pt=Tt;pt<Bt;pt++)Ct+=Pt[lt][pt]*Pt[lt][pt];if(Ct<=_t)Wt=0;else{for(Jt=Pt[lt][lt+1],Wt=Math.sqrt(Ct),Jt>=0&&(Wt=-Wt),Zt=Jt*Wt-Ct,Pt[lt][lt+1]=Jt-Wt,pt=Tt;pt<Bt;pt++)Ut[pt]=Pt[lt][pt]/Zt;for(pt=Tt;pt<Lt;pt++){for(Ct=0,xt=Tt;xt<Bt;xt++)Ct+=Pt[pt][xt]*Pt[lt][xt];for(xt=Tt;xt<Bt;xt++)Pt[pt][xt]+=Ct*Ut[xt]}}(ci=Math.abs(kt[lt])+Math.abs(Ut[lt]))>ti&&(ti=ci)}for(lt=Bt-1;lt!=-1;lt+=-1){if(Wt!=0){for(Zt=Wt*Pt[lt][lt+1],pt=Tt;pt<Bt;pt++)Vt[pt][lt]=Pt[lt][pt]/Zt;for(pt=Tt;pt<Bt;pt++){for(Ct=0,xt=Tt;xt<Bt;xt++)Ct+=Pt[lt][xt]*Vt[xt][pt];for(xt=Tt;xt<Bt;xt++)Vt[xt][pt]+=Ct*Vt[xt][lt]}}for(pt=Tt;pt<Bt;pt++)Vt[lt][pt]=0,Vt[pt][lt]=0;Vt[lt][lt]=1,Wt=Ut[lt],Tt=lt}for(lt=Bt-1;lt!=-1;lt+=-1){for(Tt=lt+1,Wt=kt[lt],pt=Tt;pt<Bt;pt++)Pt[lt][pt]=0;if(Wt!=0){for(Zt=Pt[lt][lt]*Wt,pt=Tt;pt<Bt;pt++){for(Ct=0,xt=Tt;xt<Lt;xt++)Ct+=Pt[xt][lt]*Pt[xt][pt];for(Jt=Ct/Zt,xt=lt;xt<Lt;xt++)Pt[xt][pt]+=Jt*Pt[xt][lt]}for(pt=lt;pt<Lt;pt++)Pt[pt][lt]=Pt[pt][lt]/Wt}else for(pt=lt;pt<Lt;pt++)Pt[pt][lt]=0;Pt[lt][lt]+=1}for(ut*=ti,xt=Bt-1;xt!=-1;xt+=-1)for(var Ht=0;Ht<50;Ht++){var qt=!1;for(Tt=xt;Tt!=-1;Tt+=-1){if(Math.abs(Ut[Tt])<=ut){qt=!0;break}if(Math.abs(kt[Tt-1])<=ut)break}if(!qt){at=0,Ct=1;var Li=Tt-1;for(lt=Tt;lt<xt+1&&(Jt=Ct*Ut[lt],Ut[lt]=at*Ut[lt],!(Math.abs(Jt)<=ut));lt++)for(Zt=si(Jt,Wt=kt[lt]),kt[lt]=Zt,at=Wt/Zt,Ct=-Jt/Zt,pt=0;pt<Lt;pt++)ci=Pt[pt][Li],ri=Pt[pt][lt],Pt[pt][Li]=ci*at+ri*Ct,Pt[pt][lt]=-ci*Ct+ri*at}if(ri=kt[xt],Tt==xt){if(ri<0)for(kt[xt]=-ri,pt=0;pt<Bt;pt++)Vt[pt][xt]=-Vt[pt][xt];break}if(Ht>=49)throw"Error: no convergence.";for(ti=kt[Tt],Wt=si(Jt=(((ci=kt[xt-1])-ri)*(ci+ri)+((Wt=Ut[xt-1])-(Zt=Ut[xt]))*(Wt+Zt))/(2*Zt*ci),1),Jt=Jt<0?((ti-ri)*(ti+ri)+Zt*(ci/(Jt-Wt)-Zt))/ti:((ti-ri)*(ti+ri)+Zt*(ci/(Jt+Wt)-Zt))/ti,at=1,Ct=1,lt=Tt+1;lt<xt+1;lt++){for(Wt=Ut[lt],ci=kt[lt],Zt=Ct*Wt,Wt*=at,ri=si(Jt,Zt),Ut[lt-1]=ri,Jt=ti*(at=Jt/ri)+Wt*(Ct=Zt/ri),Wt=-ti*Ct+Wt*at,Zt=ci*Ct,ci*=at,pt=0;pt<Bt;pt++)ti=Vt[pt][lt-1],ri=Vt[pt][lt],Vt[pt][lt-1]=ti*at+ri*Ct,Vt[pt][lt]=-ti*Ct+ri*at;for(ri=si(Jt,Zt),kt[lt-1]=ri,Jt=(at=Jt/ri)*Wt+(Ct=Zt/ri)*ci,ti=-Ct*Wt+at*ci,pt=0;pt<Lt;pt++)ci=Pt[pt][lt-1],ri=Pt[pt][lt],Pt[pt][lt-1]=ci*at+ri*Ct,Pt[pt][lt]=-ci*Ct+ri*at}Ut[Tt]=0,Ut[xt]=Jt,kt[xt]=ti}for(lt=0;lt<kt.length;lt++)kt[lt]<ut&&(kt[lt]=0);for(lt=0;lt<Bt;lt++)for(pt=lt-1;pt>=0;pt--)if(kt[pt]<kt[lt]){for(at=kt[pt],kt[pt]=kt[lt],kt[lt]=at,xt=0;xt<Pt.length;xt++)ht=Pt[xt][lt],Pt[xt][lt]=Pt[xt][pt],Pt[xt][pt]=ht;for(xt=0;xt<Vt.length;xt++)ht=Vt[xt][lt],Vt[xt][lt]=Vt[xt][pt],Vt[xt][pt]=ht;lt=pt}return{U:Pt,S:kt,V:Vt}}(ye);console.log(Oe);var ke=Oe.U,Ve=Oe.S.map(function(tt,ht){var ut={};return ut.eigenvalue=tt,ut.vector=ke.map(function(_t,at){return-1*_t[ht]}),ut});return Ve}function _(ye,...Oe){var ke=Oe.map(function(ht){return ht.vector}),Ve=C(ke,ce(l(ye))),tt=O(C(ne(ye.length),ye),-1/ye.length);return{adjustedData:Ve,formattedAdjustedData:w(Ve,2),avgData:tt,selectedVectors:ke}}function A(ye){return h(u(c(l(ye)),!1))}function w(ye,Oe){var ke=Math.pow(10,Oe||2);return ye.map(function(Ve,tt){return Ve.map(function(ht){return Math.round(ht*ke)/ke})})}function C(ye,Oe){if(!(ye[0]&&Oe[0]&&ye.length&&Oe.length))throw new Error("Both A and B should be matrices");if(Oe.length!==ye[0].length)throw new Error("Columns in A should be the same as the number of rows in B");for(var ke=[],Ve=0;Ve<ye.length;Ve++){ke[Ve]=[];for(var tt=0;tt<Oe[0].length;tt++)for(var ht=0;ht<ye[0].length;ht++)ke[Ve][tt]=ke[Ve][tt]?ke[Ve][tt]+ye[Ve][ht]*Oe[ht][tt]:ye[Ve][ht]*Oe[ht][tt]}return ke}function M(ye,Oe){if(ye.length!==Oe.length||ye[0].length!==Oe[0].length)throw new Error("Both A and B should have the same dimensions");for(var ke=[],Ve=0;Ve<ye.length;Ve++){ke[Ve]=[];for(var tt=0;tt<Oe[0].length;tt++)ke[Ve][tt]=ye[Ve][tt]-Oe[Ve][tt]}return ke}function O(ye,Oe){for(var ke=[],Ve=0;Ve<ye.length;Ve++){ke[Ve]=[];for(var tt=0;tt<ye[0].length;tt++)ke[Ve][tt]=ye[Ve][tt]*Oe}return ke}function ne(ye){for(var Oe=[],ke=0;ke<ye;ke++){Oe[ke]=[];for(var Ve=0;Ve<ye;Ve++)Oe[ke][Ve]=1}return Oe}function ce(ye){return ue(ye)[0].map(function(Oe,ke){return ye.map(function(Ve){return Ve[ke]})})}function ue(ye){var Oe=JSON.stringify(ye);return JSON.parse(Oe)}return{computeDeviationScores:c,computeDeviationMatrix:l,computeSVD:h,computePercentageExplained:function(ye,...Oe){var ke=ye.map(function(tt){return tt.eigenvalue}).reduce(function(tt,ht){return tt+ht}),Ve=Oe.map(function(tt){return tt.eigenvalue}).reduce(function(tt,ht){return tt+ht});return Ve/ke},computeOriginalData:function(ye,Oe,ke){var Ve=M(ce(C(ce(Oe),ye)),ke);return{originalData:Ve,formattedOriginalData:w(Ve,2)}},computeVarianceCovariance:u,computeAdjustedData:_,getEigenVectors:A,analyseTopResult:function(ye){var Oe=A(ye).sort(function(ke,Ve){return Ve.eigenvalue-ke.eigenvalue});return console.log("Sorted Vectors",Oe),_(ye,Oe[0].vector)},transpose:ce,multiply:C,clone:ue,scale:O}}();d.exports=o},186:function(d){var o=[];function l(h){for(var _=-1,A=0;A<o.length;A++)if(o[A].identifier===h){_=A;break}return _}function c(h,_){for(var A={},w=[],C=0;C<h.length;C++){var M=h[C],O=_.base?M[0]+_.base:M[0],ne=A[O]||0,ce="".concat(O," ").concat(ne);A[O]=ne+1;var ue=l(ce),ye={css:M[1],media:M[2],sourceMap:M[3],supports:M[4],layer:M[5]};if(ue!==-1)o[ue].references++,o[ue].updater(ye);else{var Oe=u(ye,_);_.byIndex=C,o.splice(C,0,{identifier:ce,updater:Oe,references:1})}w.push(ce)}return w}function u(h,_){var A=_.domAPI(_);return A.update(h),function(w){if(w){if(w.css===h.css&&w.media===h.media&&w.sourceMap===h.sourceMap&&w.supports===h.supports&&w.layer===h.layer)return;A.update(h=w)}else A.remove()}}d.exports=function(h,_){var A=c(h=h||[],_=_||{});return function(w){w=w||[];for(var C=0;C<A.length;C++){var M=l(A[C]);o[M].references--}for(var O=c(w,_),ne=0;ne<A.length;ne++){var ce=l(A[ne]);o[ce].references===0&&(o[ce].updater(),o.splice(ce,1))}A=O}}},990:function(d){d.exports=function(o){var l=document.createElement("style");return o.setAttributes(l,o.attributes),o.insert(l,o.options),l}},626:function(d,o,l){d.exports=function(c){var u=l.nc;u&&c.setAttribute("nonce",u)}},155:function(d){d.exports=function(o){var l=o.insertStyleElement(o);return{update:function(c){(function(u,h,_){var A="";_.supports&&(A+="@supports (".concat(_.supports,") {")),_.media&&(A+="@media ".concat(_.media," {"));var w=_.layer!==void 0;w&&(A+="@layer".concat(_.layer.length>0?" ".concat(_.layer):""," {")),A+=_.css,w&&(A+="}"),_.media&&(A+="}"),_.supports&&(A+="}");var C=_.sourceMap;C&&typeof btoa<"u"&&(A+=`
/`,A+="*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(C))))," *"),A+="/"),h.styleTagTransform(A,u,h.options)})(l,o,c)},remove:function(){(function(c){if(c.parentNode===null)return!1;c.parentNode.removeChild(c)})(l)}}}},827:function(d){d.exports=function(o,l){if(l.styleSheet)l.styleSheet.cssText=o;else{for(;l.firstChild;)l.removeChild(l.firstChild);l.appendChild(document.createTextNode(o))}}},530:function(d){d.exports=function(){var o={820:function(h,_,A){var w=A(537),C=A.n(w),M=A(645),O=A.n(M)()(C());O.push([h.id,`.treejs {
  -webkit-box-sizing: border-box;
          box-sizing: border-box;
  font-size: 14px;
  margin-left: -18px;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
}
.treejs *:after,
.treejs *:before {
  -webkit-box-sizing: border-box;
          box-sizing: border-box;
}
.treejs > .treejs-node {
  padding-left: 0;
}
.treejs .treejs-nodes {
  list-style: none;
  padding-left: 18px;
  margin: 0;
  overflow: hidden;
  -webkit-transition: height 150ms ease-out, opacity 150ms ease-out;
  -o-transition: height 150ms ease-out, opacity 150ms ease-out;
  transition: height 150ms ease-out, opacity 150ms ease-out;
}
.treejs .treejs-node {
  cursor: pointer;
  overflow: hidden;
}
.treejs .treejs-node.treejs-placeholder {
  padding-left: 18px;
}
.treejs .treejs-switcher {
  display: inline-block;
  vertical-align: middle;
  width: 20px;
  height: 20px;
  cursor: pointer;
  position: relative;
  -webkit-transition: -webkit-transform 150ms ease-out;
  transition: -webkit-transform 150ms ease-out;
  -o-transition: transform 150ms ease-out;
  transition: transform 150ms ease-out;
  transition: transform 150ms ease-out, -webkit-transform 150ms ease-out;
}
.treejs .treejs-switcher:before {
  position: absolute;
  top: 8px;
  left: 6px;
  display: block;
  content: ' ';
  border: 4px solid transparent;
  border-top: 4px solid rgba(245, 245, 245, 0.7);
  -webkit-transition: border-color 150ms;
  -o-transition: border-color 150ms;
  transition: border-color 150ms;
}
.treejs .treejs-switcher:hover:before {
  border-top: 4px solid rgba(245, 245, 245, 0.96);
}
.treejs .treejs-node__close > .treejs-switcher {
  -webkit-transform: rotate(-90deg);
      -ms-transform: rotate(-90deg);
          transform: rotate(-90deg);
}
.treejs .treejs-node__close > .treejs-nodes {
  height: 0;
}
.treejs .treejs-checkbox {
  display: inline-block;
  vertical-align: middle;
  width: 20px;
  height: 20px;
  cursor: pointer;
  position: relative;
}
.treejs .treejs-checkbox:before {
  -webkit-transition: all 0.3s;
  -o-transition: all 0.3s;
  transition: all 0.3s;
  cursor: pointer;
  position: absolute;
  top: 2px;
  content: ' ';
  display: block;
  width: 16px;
  height: 16px;
  border: 1px solid #d9d9d9;
  border-radius: 2px;
}
.treejs .treejs-checkbox:hover:before {
  -webkit-box-shadow: 0 0 2px 1px #1890ff;
          box-shadow: 0 0 2px 1px #1890ff;
}
.treejs .treejs-node__checked > .treejs-checkbox:before {
  background-color: #1890ff;
  border-color: #1890ff;
}
.treejs .treejs-node__checked > .treejs-checkbox:after {
  position: absolute;
  content: ' ';
  display: block;
  top: 4px;
  left: 5px;
  width: 5px;
  height: 9px;
  border: 2px solid #fff;
  border-top: none;
  border-left: none;
  -webkit-transform: rotate(45deg);
      -ms-transform: rotate(45deg);
          transform: rotate(45deg);
}
.treejs .treejs-node__halfchecked > .treejs-checkbox:before {
  background-color: #1890ff;
  border-color: #1890ff;
}
.treejs .treejs-node__halfchecked > .treejs-checkbox:after {
  position: absolute;
  content: ' ';
  display: block;
  top: 9px;
  left: 3px;
  width: 10px;
  height: 2px;
  background-color: #fff;
}
.treejs .treejs-node__disabled {
  cursor: not-allowed;
  color: rgba(255, 255, 255, 0.25);
}
.treejs .treejs-node__disabled .treejs-checkbox {
  cursor: not-allowed;
}
.treejs .treejs-node__disabled .treejs-checkbox:before {
  cursor: not-allowed;
  border-color: #d9d9d9 !important;
  background-color: #f5f5f5 !important;
}
.treejs .treejs-node__disabled .treejs-checkbox:hover:before {
  -webkit-box-shadow: none !important;
          box-shadow: none !important;
}
.treejs .treejs-node__disabled .treejs-node__checked > .treejs-checkbox:after {
  border-color: #d9d9d9;
}
.treejs .treejs-node__disabled .treejs-node__halfchecked > .treejs-checkbox:after {
  background-color: #d9d9d9;
}
.treejs .treejs-node__disabled.treejs-node__checked > .treejs-checkbox:after {
  border-color: #d9d9d9;
}
.treejs .treejs-node__disabled.treejs-node__halfchecked > .treejs-checkbox:after {
  background-color: #d9d9d9;
}
.treejs .treejs-label {
  vertical-align: middle;
}
`,"",{version:3,sources:["webpack://./src/index.less"],names:[],mappings:"AAKA;EACE,8BAAA;UAAA,sBAAA;EACA,eAAA;EACA,kBAAA;EACA,yBAAA;KAAA,sBAAA;MAAA,qBAAA;UAAA,iBAAA;AAJF;AAAA;;EAQI,8BAAA;UAAA,sBAAA;AAJJ;AAOE;EACE,eAAA;AALJ;AAPA;EAgBI,gBAAA;EACA,kBAAA;EACA,SAAA;EACA,gBAAA;EACA,iEAAA;EAAA,4DAAA;EAAA,yDAAA;AANJ;AAdA;EAwBI,eAAA;EACA,gBAAA;AAPJ;AASI;EACE,kBAAA;AAPN;AArBA;EAiCI,qBAAA;EACA,sBAAA;EACA,WAAA;EACA,YAAA;EACA,eAAA;EACA,kBAAA;EACA,oDAAA;EAAA,4CAAA;EAAA,uCAAA;EAAA,oCAAA;EAAA,sEAAA;AATJ;AAWI;EACE,kBAAA;EACA,QAAA;EACA,SAAA;EACA,cAAA;EACA,YAAA;EACA,6BAAA;EACA,8CAAA;EACA,sCAAA;EAAA,iCAAA;EAAA,8BAAA;AATN;AAWI;EACE,+CAAA;AATN;AA3CA;EAwDI,iCAAA;MAAA,6BAAA;UAAA,yBAAA;AAVJ;AA9CA;EA2DI,SAAA;AAVJ;AAjDA;EA+DI,qBAAA;EACA,sBAAA;EACA,WAAA;EACA,YAAA;EACA,eAAA;EACA,kBAAA;AAXJ;AAaI;EACE,4BAAA;EAAA,uBAAA;EAAA,oBAAA;EACA,eAAA;EACA,kBAAA;EACA,QAAA;EACA,YAAA;EACA,cAAA;EACA,WAAA;EACA,YAAA;EACA,yBAAA;EACA,kBAAA;AAXN;AAaI;EACE,uCAAA;UAAA,+BAAA;AAXN;AAgBM;EACE,yBAAA;EACA,qBAAA;AAdR;AAgBM;EACE,kBAAA;EACA,YAAA;EACA,cAAA;EACA,QAAA;EACA,SAAA;EACA,UAAA;EACA,WAAA;EACA,sBAAA;EACA,gBAAA;EACA,iBAAA;EACA,gCAAA;MAAA,4BAAA;UAAA,wBAAA;AAdR;AAoBM;EACE,yBAAA;EACA,qBAAA;AAlBR;AAoBM;EACE,kBAAA;EACA,YAAA;EACA,cAAA;EACA,QAAA;EACA,SAAA;EACA,WAAA;EACA,WAAA;EACA,sBAAA;AAlBR;AAvGA;EA+HI,mBAAA;EACA,gCAAA;AArBJ;AA3GA;EAkIM,mBAAA;AApBN;AAqBM;EACE,mBAAA;EACA,gCAAA;EACA,oCAAA;AAnBR;AAqBM;EACE,mCAAA;UAAA,2BAAA;AAnBR;AAwBQ;EACE,qBAAA;AAtBV;AA4BQ;EACE,yBAAA;AA1BV;AAiCM;EACE,qBAAA;AA/BR;AAqCM;EACE,yBAAA;AAnCR;AAlIA;EA2KI,sBAAA;AAtCJ",sourcesContent:[`@color-disable: #d4d4d4;
@bgcolor-disable: #f5f5f5;
@greyborder: #d9d9d9;
@bluebg: #1890ff;

.treejs {
  box-sizing: border-box;
  font-size: 14px;
  margin-left: -18px;
  user-select: none;

  *:after,
  *:before {
    box-sizing: border-box;
  }

  & > .treejs-node {
    padding-left: 0;
  }

  .treejs-nodes {
    list-style: none;
    padding-left: 18px;
    margin: 0; //  for default ul...
    overflow: hidden;
    transition: height 150ms ease-out, opacity 150ms ease-out;
  }

  .treejs-node {
    cursor: pointer;
    overflow: hidden;

    &.treejs-placeholder {
      padding-left: 18px;
    }
  }

  .treejs-switcher {
    display: inline-block;
    vertical-align: middle;
    width: 20px;
    height: 20px;
    cursor: pointer;
    position: relative;
    transition: transform 150ms ease-out;

    &:before {
      position: absolute;
      top: 8px;
      left: 6px;
      display: block;
      content: ' ';
      border: 4px solid transparent;
      border-top: 4px solid rgba(245, 245, 245, 0.7);
      transition: border-color 150ms;
    }
    &:hover:before {
      border-top: 4px solid rgba(245, 245, 245, 0.96);
    }
  }
  .treejs-node__close > .treejs-switcher {
    transform: rotate(-90deg);
  }
  .treejs-node__close > .treejs-nodes {
    height: 0;
  }

  .treejs-checkbox {
    display: inline-block;
    vertical-align: middle;
    width: 20px;
    height: 20px;
    cursor: pointer;
    position: relative;

    &:before {
      transition: all 0.3s;
      cursor: pointer;
      position: absolute;
      top: 2px;
      content: ' ';
      display: block;
      width: 16px;
      height: 16px;
      border: 1px solid @greyborder;
      border-radius: 2px;
    }
    &:hover:before {
      box-shadow: 0 0 2px 1px @bluebg;
    }
  }
  .treejs-node__checked {
    & > .treejs-checkbox {
      &:before {
        background-color: @bluebg;
        border-color: @bluebg;
      }
      &:after {
        position: absolute;
        content: ' ';
        display: block;
        top: 4px;
        left: 5px;
        width: 5px;
        height: 9px;
        border: 2px solid #fff;
        border-top: none;
        border-left: none;
        transform: rotate(45deg);
      }
    }
  }
  .treejs-node__halfchecked {
    & > .treejs-checkbox {
      &:before {
        background-color: @bluebg;
        border-color: @bluebg;
      }
      &:after {
        position: absolute;
        content: ' ';
        display: block;
        top: 9px;
        left: 3px;
        width: 10px;
        height: 2px;
        background-color: #fff;
      }
    }
  }

  .treejs-node__disabled {
    cursor: not-allowed;
    color: rgba(255, 255, 255, 0.25);
    .treejs-checkbox {
      cursor: not-allowed;
      &:before {
        cursor: not-allowed;
        border-color: @greyborder !important;
        background-color: @bgcolor-disable !important;
      }
      &:hover:before {
        box-shadow: none !important;
      }
    }
    .treejs-node__checked {
      & > .treejs-checkbox {
        &:after {
          border-color: @greyborder;
        }
      }
    }
    .treejs-node__halfchecked {
      & > .treejs-checkbox {
        &:after {
          background-color: @greyborder;
        }
      }
    }
  }
  .treejs-node__disabled.treejs-node__checked {
    & > .treejs-checkbox {
      &:after {
        border-color: @greyborder;
      }
    }
  }
  .treejs-node__disabled.treejs-node__halfchecked {
    & > .treejs-checkbox {
      &:after {
        background-color: @greyborder;
      }
    }
  }

  .treejs-label {
    vertical-align: middle;
  }
}
`],sourceRoot:""}]),_.Z=O},645:function(h){h.exports=function(_){var A=[];return A.toString=function(){return this.map(function(w){var C="",M=w[5]!==void 0;return w[4]&&(C+="@supports (".concat(w[4],") {")),w[2]&&(C+="@media ".concat(w[2]," {")),M&&(C+="@layer".concat(w[5].length>0?" ".concat(w[5]):""," {")),C+=_(w),M&&(C+="}"),w[2]&&(C+="}"),w[4]&&(C+="}"),C}).join("")},A.i=function(w,C,M,O,ne){typeof w=="string"&&(w=[[null,w,void 0]]);var ce={};if(M)for(var ue=0;ue<this.length;ue++){var ye=this[ue][0];ye!=null&&(ce[ye]=!0)}for(var Oe=0;Oe<w.length;Oe++){var ke=[].concat(w[Oe]);M&&ce[ke[0]]||(ne!==void 0&&(ke[5]===void 0||(ke[1]="@layer".concat(ke[5].length>0?" ".concat(ke[5]):""," {").concat(ke[1],"}")),ke[5]=ne),C&&(ke[2]&&(ke[1]="@media ".concat(ke[2]," {").concat(ke[1],"}")),ke[2]=C),O&&(ke[4]?(ke[1]="@supports (".concat(ke[4],") {").concat(ke[1],"}"),ke[4]=O):ke[4]="".concat(O)),A.push(ke))}},A}},537:function(h){h.exports=function(_){var A=_[1],w=_[3];if(!w)return A;if(typeof btoa=="function"){var C=btoa(unescape(encodeURIComponent(JSON.stringify(w)))),M="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(C),O="/*# ".concat(M," */"),ne=w.sources.map(function(ce){return"/*# sourceURL=".concat(w.sourceRoot||"").concat(ce," */")});return[A].concat(ne).concat([O]).join(`
`)}return[A].join(`
`)}},379:function(h){var _=[];function A(M){for(var O=-1,ne=0;ne<_.length;ne++)if(_[ne].identifier===M){O=ne;break}return O}function w(M,O){for(var ne={},ce=[],ue=0;ue<M.length;ue++){var ye=M[ue],Oe=O.base?ye[0]+O.base:ye[0],ke=ne[Oe]||0,Ve="".concat(Oe," ").concat(ke);ne[Oe]=ke+1;var tt=A(Ve),ht={css:ye[1],media:ye[2],sourceMap:ye[3],supports:ye[4],layer:ye[5]};if(tt!==-1)_[tt].references++,_[tt].updater(ht);else{var ut=C(ht,O);O.byIndex=ue,_.splice(ue,0,{identifier:Ve,updater:ut,references:1})}ce.push(Ve)}return ce}function C(M,O){var ne=O.domAPI(O);return ne.update(M),function(ce){if(ce){if(ce.css===M.css&&ce.media===M.media&&ce.sourceMap===M.sourceMap&&ce.supports===M.supports&&ce.layer===M.layer)return;ne.update(M=ce)}else ne.remove()}}h.exports=function(M,O){var ne=w(M=M||[],O=O||{});return function(ce){ce=ce||[];for(var ue=0;ue<ne.length;ue++){var ye=A(ne[ue]);_[ye].references--}for(var Oe=w(ce,O),ke=0;ke<ne.length;ke++){var Ve=A(ne[ke]);_[Ve].references===0&&(_[Ve].updater(),_.splice(Ve,1))}ne=Oe}}},216:function(h){h.exports=function(_){var A=document.createElement("style");return _.setAttributes(A,_.attributes),_.insert(A,_.options),A}},636:function(h,_,A){h.exports=function(w){var C=A.nc;C&&w.setAttribute("nonce",C)}},795:function(h){h.exports=function(_){var A=_.insertStyleElement(_);return{update:function(w){(function(C,M,O){var ne="";O.supports&&(ne+="@supports (".concat(O.supports,") {")),O.media&&(ne+="@media ".concat(O.media," {"));var ce=O.layer!==void 0;ce&&(ne+="@layer".concat(O.layer.length>0?" ".concat(O.layer):""," {")),ne+=O.css,ce&&(ne+="}"),O.media&&(ne+="}"),O.supports&&(ne+="}");var ue=O.sourceMap;ue&&typeof btoa<"u"&&(ne+=`
/`,ne+="*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(ue))))," *"),ne+="/"),M.styleTagTransform(ne,C,M.options)})(A,_,w)},remove:function(){(function(w){if(w.parentNode===null)return!1;w.parentNode.removeChild(w)})(A)}}}},589:function(h){h.exports=function(_,A){if(A.styleSheet)A.styleSheet.cssText=_;else{for(;A.firstChild;)A.removeChild(A.firstChild);A.appendChild(document.createTextNode(_))}}}},l={};function c(h){var _=l[h];if(_!==void 0)return _.exports;var A=l[h]={id:h,exports:{}};return o[h](A,A.exports,c),A.exports}c.n=function(h){var _=h&&h.__esModule?function(){return h.default}:function(){return h};return c.d(_,{a:_}),_},c.d=function(h,_){for(var A in _)c.o(_,A)&&!c.o(h,A)&&Object.defineProperty(h,A,{enumerable:!0,get:_[A]})},c.o=function(h,_){return Object.prototype.hasOwnProperty.call(h,_)},c.nc=void 0;var u={};return function(){c.d(u,{default:function(){return Ut}});var h=c(379),_=c.n(h),A=c(795),w=c.n(A),C=c(636),M=c.n(C),O=c(216),ne=c.n(O),ce=c(589),ue=c.n(ce),ye=c(820),Oe={};ye.Z&&ye.Z.locals&&(Oe.locals=ye.Z.locals);var ke,Ve=0,tt={};tt.styleTagTransform=ue(),tt.setAttributes=M(),tt.insert=function(kt,Vt){(Vt.target||document.head).appendChild(kt)},tt.domAPI=w(),tt.insertStyleElement=ne(),Oe.use=function(kt){return tt.options=kt||{},Ve++||(ke=_()(ye.Z,tt)),Oe},Oe.unuse=function(){Ve>0&&!--Ve&&(ke(),ke=null)};var ht=Oe;function ut(kt,Vt){return function(si){if(Array.isArray(si))return si}(kt)||function(si,Jt){var Wt=si==null?null:typeof Symbol<"u"&&si[Symbol.iterator]||si["@@iterator"];if(Wt!=null){var Zt,ti,ci=[],ri=!0,Ct=!1;try{for(Wt=Wt.call(si);!(ri=(Zt=Wt.next()).done)&&(ci.push(Zt.value),!Jt||ci.length!==Jt);ri=!0);}catch(Ht){Ct=!0,ti=Ht}finally{try{ri||Wt.return==null||Wt.return()}finally{if(Ct)throw ti}}return ci}}(kt,Vt)||function(si,Jt){if(si){if(typeof si=="string")return _t(si,Jt);var Wt=Object.prototype.toString.call(si).slice(8,-1);return Wt==="Object"&&si.constructor&&(Wt=si.constructor.name),Wt==="Map"||Wt==="Set"?Array.from(si):Wt==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(Wt)?_t(si,Jt):void 0}}(kt,Vt)||function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function _t(kt,Vt){(Vt==null||Vt>kt.length)&&(Vt=kt.length);for(var si=0,Jt=new Array(Vt);si<Vt;si++)Jt[si]=kt[si];return Jt}function at(kt,Vt){var si=Object.keys(kt);if(Object.getOwnPropertySymbols){var Jt=Object.getOwnPropertySymbols(kt);Vt&&(Jt=Jt.filter(function(Wt){return Object.getOwnPropertyDescriptor(kt,Wt).enumerable})),si.push.apply(si,Jt)}return si}function lt(kt){for(var Vt=1;Vt<arguments.length;Vt++){var si=arguments[Vt]!=null?arguments[Vt]:{};Vt%2?at(Object(si),!0).forEach(function(Jt){pt(kt,Jt,si[Jt])}):Object.getOwnPropertyDescriptors?Object.defineProperties(kt,Object.getOwnPropertyDescriptors(si)):at(Object(si)).forEach(function(Jt){Object.defineProperty(kt,Jt,Object.getOwnPropertyDescriptor(si,Jt))})}return kt}function pt(kt,Vt,si){return Vt in kt?Object.defineProperty(kt,Vt,{value:si,enumerable:!0,configurable:!0,writable:!0}):kt[Vt]=si,kt}function xt(kt,Vt){for(var si=0;si<Vt.length;si++){var Jt=Vt[si];Jt.enumerable=Jt.enumerable||!1,Jt.configurable=!0,"value"in Jt&&(Jt.writable=!0),Object.defineProperty(kt,Jt.key,Jt)}}function Tt(kt){var Vt={};return kt.reduce(function(si,Jt){return Vt[Jt]||(Vt[Jt]=!0,si.push(Jt)),si},[])}function Pt(kt,Vt){requestAnimationFrame(function(){Vt.enter(),requestAnimationFrame(function(){Vt.active(),setTimeout(function(){Vt.leave()},kt)})})}function Lt(kt,Vt){try{var si=kt.liElementsById[Vt.parent.id];si.classList.contains("treejs-node__close")||si.getElementsByClassName("treejs-switcher")[0].click()}catch{return}Object.prototype.hasOwnProperty.call(Vt,"parent")&&Lt(kt,Vt.parent)}function Bt(kt,Vt){var si=kt.liElementsById[Vt.id];si.classList.contains("treejs-node__close")&&si.getElementsByClassName("treejs-switcher")[0].click(),Object.prototype.hasOwnProperty.call(Vt,"children")&&Vt.children.forEach(function(Jt){return Bt(kt,Jt)})}var Ut=function(){function kt(Wt,Zt){(function(ti,ci){if(!(ti instanceof ci))throw new TypeError("Cannot call a class as a function")})(this,kt),ht.use({target:typeof this.container=="string"?document.querySelector(this.container):this.container}),this.treeNodes=[],this.nodesById={},this.leafNodesById={},this.liElementsById={},this.willUpdateNodesById={},this.container=Wt,this.options=Object.assign({values:[],disables:[],loaded:null,closeDepth:null},Zt),Object.defineProperties(this,{values:{get:function(){return this.getValues()},set:function(ti){this.setValues(Tt(ti))}},disables:{get:function(){return this.getDisables()},set:function(ti){this.setDisables(Tt(ti))}},selectedNodes:{get:function(){var ti=[],ci=this.nodesById;return Object.keys(ci).forEach(function(ri){if(Object.prototype.hasOwnProperty.call(ci,ri)&&(ci[ri].status===1||ci[ri].status===2)){var Ct=lt({},ci[ri]);delete Ct.parent,delete Ct.children,ti.push(Ct)}}),ti}},disabledNodes:{get:function(){var ti=[],ci=this.nodesById;return Object.keys(ci).forEach(function(ri){if(Object.prototype.hasOwnProperty.call(ci,ri)&&ci[ri].disabled){var Ct=lt({},ci[ri]);delete Ct.parent,ti.push(Ct)}}),ti}}}),this.init(this.options.data)}var Vt,si,Jt;return Vt=kt,Jt=[{key:"onSwitcherClick",value:function(Wt){var Zt=Wt.parentNode,ti=Zt.lastChild,ci=ti.scrollHeight;Zt.classList.contains("treejs-node__close")?Pt(150,{enter:function(){ti.style.height=0,ti.style.opacity=0},active:function(){ti.style.height="".concat(ci,"px"),ti.style.opacity=1},leave:function(){ti.style.height="",ti.style.opacity="",Zt.classList.remove("treejs-node__close")}}):Pt(150,{enter:function(){ti.style.height="".concat(ci,"px"),ti.style.opacity=1},active:function(){ti.style.height=0,ti.style.opacity=0},leave:function(){ti.style.height="",ti.style.opacity="",Zt.classList.add("treejs-node__close")}})}},{key:"parseTreeData",value:function(Wt){var Zt,ti=(Zt=Wt,JSON.parse(JSON.stringify(Zt))),ci={},ri={},Ct=[],Ht=[];return function qt(Li,Ui){Li.forEach(function(Xi){ci[Xi.id]=Xi,Xi.checked&&Ct.push(Xi.id),Xi.disabled&&Ht.push(Xi.id),Ui&&(Xi.parent=Ui),Xi.children&&Xi.children.length?qt(Xi.children,Xi):ri[Xi.id]=Xi})}(ti),{treeNodes:ti,nodesById:ci,leafNodesById:ri,defaultValues:Ct,defaultDisables:Ht}}},{key:"createRootEle",value:function(){var Wt=document.createElement("div");return Wt.classList.add("treejs"),Wt}},{key:"createUlEle",value:function(){var Wt=document.createElement("ul");return Wt.classList.add("treejs-nodes"),Wt}},{key:"createLiEle",value:function(Wt,Zt){var ti=document.createElement("li");if(ti.classList.add("treejs-node"),Zt&&ti.classList.add("treejs-node__close"),Wt.children&&Wt.children.length){var ci=document.createElement("span");ci.classList.add("treejs-switcher"),ti.appendChild(ci)}else ti.classList.add("treejs-placeholder");var ri=document.createElement("span");ri.classList.add("treejs-checkbox"),ti.appendChild(ri);var Ct=document.createElement("span");Ct.classList.add("treejs-label");var Ht=document.createTextNode(Wt.text);return Ct.appendChild(Ht),ti.appendChild(Ct),ti.nodeId=Wt.id,ti}}],(si=[{key:"init",value:function(Wt){var Zt=kt.parseTreeData(Wt),ti=Zt.treeNodes,ci=Zt.nodesById,ri=Zt.leafNodesById,Ct=Zt.defaultValues,Ht=Zt.defaultDisables;this.treeNodes=ti,this.nodesById=ci,this.leafNodesById=ri,this.render(this.treeNodes);var qt=this.options,Li=qt.values,Ui=qt.disables,Xi=qt.loaded;Li&&Li.length?this.setValues(Li):Ct&&Ct.length&&this.setValues(Ct),Ui&&Ui.length?this.setDisables(Ui):Ht&&Ht.length&&this.setDisables(Ht),typeof Xi=="function"&&Xi.call(this)}},{key:"render",value:function(Wt){var Zt=kt.createRootEle();Zt.appendChild(this.buildTree(Wt,0)),this.bindEvent(Zt);var ti=typeof this.container=="string"?document.querySelector(this.container):this.container;(function(ci){for(;ci.firstChild;)ci.removeChild(ci.firstChild)})(ti),ti.appendChild(Zt)}},{key:"buildTree",value:function(Wt,Zt){var ti=this,ci=kt.createUlEle();return Wt&&Wt.length&&Wt.forEach(function(ri){var Ct=kt.createLiEle(ri,Zt===ti.options.closeDepth-1);ti.liElementsById[ri.id]=Ct;var Ht=null;ri.children&&ri.children.length&&(Ht=ti.buildTree(ri.children,Zt+1)),Ht&&Ct.appendChild(Ht),ci.appendChild(Ct)}),ci}},{key:"bindEvent",value:function(Wt){var Zt=this;Wt.addEventListener("click",function(ti){var ci=ti.target;ci.nodeName==="SPAN"&&ci.classList.contains("treejs-checkbox")?Zt.onItemClick(ci.parentNode.nodeId):ci.nodeName==="SPAN"&&ci.classList.contains("treejs-label")?Zt.onItemLabelClick(ci.parentNode.nodeId):ci.nodeName==="LI"&&ci.classList.contains("treejs-node")?Zt.onItemClick(ci.nodeId):ci.nodeName==="SPAN"&&ci.classList.contains("treejs-switcher")&&kt.onSwitcherClick(ci)},!1)}},{key:"onItemClick",value:function(Wt){var Zt=this.nodesById[Wt],ti=this.options.onChange;Zt.disabled||(this.setValue(Wt),this.updateLiElements()),ti&&ti.call(this)}},{key:"onItemLabelClick",value:function(Wt){var Zt=this.options.onItemLabelClick;Zt&&Zt.call(this,Wt)}},{key:"setValue",value:function(Wt){var Zt=this.nodesById[Wt];if(Zt){var ti=Zt.status,ci=ti===1||ti===2?0:2;Zt.status=ci,this.markWillUpdateNode(Zt),this.walkUp(Zt,"status"),this.walkDown(Zt,"status")}}},{key:"getValues",value:function(){var Wt=this,Zt=[];return Object.keys(this.leafNodesById).forEach(function(ti){Object.prototype.hasOwnProperty.call(Wt.leafNodesById,ti)&&(Wt.leafNodesById[ti].status!==1&&Wt.leafNodesById[ti].status!==2||Zt.push(ti))}),Zt}},{key:"setValues",value:function(Wt){var Zt=this;this.emptyNodesCheckStatus(),Wt.forEach(function(ci){Zt.setValue(ci)}),this.updateLiElements();var ti=this.options.onChange;ti&&ti.call(this)}},{key:"setDisable",value:function(Wt){var Zt=this.nodesById[Wt];Zt&&(Zt.disabled||(Zt.disabled=!0,this.markWillUpdateNode(Zt),this.walkUp(Zt,"disabled"),this.walkDown(Zt,"disabled")))}},{key:"getDisables",value:function(){var Wt=this,Zt=[];return Object.keys(this.leafNodesById).forEach(function(ti){Object.prototype.hasOwnProperty.call(Wt.leafNodesById,ti)&&Wt.leafNodesById[ti].disabled&&Zt.push(ti)}),Zt}},{key:"setDisables",value:function(Wt){var Zt=this;this.emptyNodesDisable(),Wt.forEach(function(ti){Zt.setDisable(ti)}),this.updateLiElements()}},{key:"emptyNodesCheckStatus",value:function(){this.willUpdateNodesById=this.getSelectedNodesById(),Object.values(this.willUpdateNodesById).forEach(function(Wt){Wt.disabled||(Wt.status=0)})}},{key:"emptyNodesDisable",value:function(){this.willUpdateNodesById=this.getDisabledNodesById(),Object.values(this.willUpdateNodesById).forEach(function(Wt){Wt.disabled=!1})}},{key:"getSelectedNodesById",value:function(){return Object.entries(this.nodesById).reduce(function(Wt,Zt){var ti=ut(Zt,2),ci=ti[0],ri=ti[1];return ri.status!==1&&ri.status!==2||(Wt[ci]=ri),Wt},{})}},{key:"getDisabledNodesById",value:function(){return Object.entries(this.nodesById).reduce(function(Wt,Zt){var ti=ut(Zt,2),ci=ti[0],ri=ti[1];return ri.disabled&&(Wt[ci]=ri),Wt},{})}},{key:"updateLiElements",value:function(){var Wt=this;Object.values(this.willUpdateNodesById).forEach(function(Zt){Wt.updateLiElement(Zt)}),this.willUpdateNodesById={}}},{key:"markWillUpdateNode",value:function(Wt){this.willUpdateNodesById[Wt.id]=Wt}},{key:"walkUp",value:function(Wt,Zt){var ti=Wt.parent;if(ti){if(Zt==="status"){var ci,ri=ti.children.reduce(function(Ht,qt){return Number.isNaN(qt.status)?Ht:Ht+qt.status},0);if(ci=ri?ri===2*ti.children.length?2:1:0,ti.status===ci)return;ti.status=ci}else{var Ct=ti.children.reduce(function(Ht,qt){return Ht&&qt.disabled},!0);if(ti.disabled===Ct)return;ti.disabled=Ct}this.markWillUpdateNode(ti),this.walkUp(ti,Zt)}}},{key:"walkDown",value:function(Wt,Zt){var ti=this;Wt.children&&Wt.children.length&&Wt.children.forEach(function(ci){Zt==="status"&&ci.disabled||(ci[Zt]=Wt[Zt],ti.markWillUpdateNode(ci),ti.walkDown(ci,Zt))})}},{key:"updateLiElement",value:function(Wt){var Zt=this.liElementsById[Wt.id].classList;switch(Wt.status){case 0:Zt.remove("treejs-node__halfchecked","treejs-node__checked");break;case 1:Zt.remove("treejs-node__checked"),Zt.add("treejs-node__halfchecked");break;case 2:Zt.remove("treejs-node__halfchecked"),Zt.add("treejs-node__checked")}switch(Wt.disabled){case!0:Zt.contains("treejs-node__disabled")||Zt.add("treejs-node__disabled");break;case!1:Zt.contains("treejs-node__disabled")&&Zt.remove("treejs-node__disabled")}}},{key:"collapseAll",value:function(){var Wt=this;Object.keys(this.leafNodesById).forEach(function(Zt){var ti=Wt.leafNodesById[Zt];Lt(Wt,ti)})}},{key:"expandAll",value:function(){Bt(this,this.treeNodes[0])}}])&&xt(Vt.prototype,si),Jt&&xt(Vt,Jt),Object.defineProperty(Vt,"prototype",{writable:!1}),kt}()}(),u.default}()},282:function(d,o){(function(l){const c="tp";function u(at){return lt=>pt=>{if(!lt&&pt===void 0)return{succeeded:!1,value:void 0};if(lt&&pt===void 0)return{succeeded:!0,value:void 0};const xt=at(pt);return xt!==void 0?{succeeded:!0,value:xt}:{succeeded:!1,value:void 0}}}function h(at){return{custom:lt=>u(lt)(at),boolean:u(lt=>typeof lt=="boolean"?lt:void 0)(at),number:u(lt=>typeof lt=="number"?lt:void 0)(at),string:u(lt=>typeof lt=="string"?lt:void 0)(at),function:u(lt=>typeof lt=="function"?lt:void 0)(at),constant:lt=>u(pt=>pt===lt?lt:void 0)(at),raw:u(lt=>lt)(at),object:lt=>u(pt=>{if((xt=pt)!==null&&typeof xt=="object")return function(Tt,Pt){return Object.keys(Pt).reduce((Bt,Ut)=>{if(Bt===void 0)return;const kt=(0,Pt[Ut])(Tt[Ut]);return kt.succeeded?Object.assign(Object.assign({},Bt),{[Ut]:kt.value}):void 0},{})}(pt,lt);var xt})(at),array:lt=>u(pt=>{if(Array.isArray(pt))return xt=lt,pt.reduce((Tt,Pt)=>{if(Tt===void 0)return;const Lt=xt(Pt);return Lt.succeeded&&Lt.value!==void 0?[...Tt,Lt.value]:void 0},[]);var xt})(at)}}const _={optional:h(!0),required:h(!1)};function A(at){return lt=>lt.toFixed(Math.max(Math.min(at,20),0))}function w(at){return[at[0],at[1],at[2]]}function C(at){return lt=>function(pt,xt){const Tt=A(xt==="float"?2:0);return`rgb(${w(pt.getComponents("rgb",xt)).map(Pt=>Tt(Pt)).join(", ")})`}(lt,at)}function M(at){return lt=>function(pt,xt){const Tt=A(2),Pt=A(xt==="float"?2:0);return`rgba(${pt.getComponents("rgb",xt).map((Lt,Bt)=>(Bt===3?Tt:Pt)(Lt)).join(", ")})`}(lt,at)}function O(at){return lt=>function(pt,xt){const Tt=A(xt==="float"?2:0),Pt=["r","g","b"];return`{${w(pt.getComponents("rgb",xt)).map((Lt,Bt)=>`${Pt[Bt]}: ${Tt(Lt)}`).join(", ")}}`}(lt,at)}function ne(at){return lt=>function(pt,xt){const Tt=A(2),Pt=A(xt==="float"?2:0),Lt=["r","g","b","a"];return`{${pt.getComponents("rgb",xt).map((Bt,Ut)=>`${Lt[Ut]}: ${(Ut===3?Tt:Pt)(Bt)}`).join(", ")}}`}(lt,at)}function ce(at,lt,pt,xt){return new(pt||(pt=Promise))(function(Tt,Pt){function Lt(kt){try{Ut(xt.next(kt))}catch(Vt){Pt(Vt)}}function Bt(kt){try{Ut(xt.throw(kt))}catch(Vt){Pt(Vt)}}function Ut(kt){var Vt;kt.done?Tt(kt.value):(Vt=kt.value,Vt instanceof pt?Vt:new pt(function(si){si(Vt)})).then(Lt,Bt)}Ut((xt=xt.apply(at,lt||[])).next())})}function ue(at){return ce(this,void 0,void 0,function*(){const lt=new Image;return lt.crossOrigin="anonymous",new Promise((pt,xt)=>{lt.src=at,lt.onload=()=>{pt(lt)},lt.onerror=xt})})}["int","float"].reduce((at,lt)=>[...at,{format:{alpha:!1,mode:"rgb",notation:"func",type:lt},stringifier:C(lt)},{format:{alpha:!0,mode:"rgb",notation:"func",type:lt},stringifier:M(lt)},{format:{alpha:!1,mode:"rgb",notation:"object",type:lt},stringifier:O(lt)},{format:{alpha:!0,mode:"rgb",notation:"object",type:lt},stringifier:ne(lt)}],[]);const ye=(Oe="img",(at,lt)=>[c,"-",Oe,"v",at?`_${at}`:"",lt?`-${lt}`:""].join(""));var Oe;class ke{constructor(lt,pt){this.element=lt.createElement("div"),this.element.classList.add(ye()),pt.viewProps.bindClassModifiers(this.element),this.input=lt.createElement("input"),this.input.classList.add(ye("input")),this.input.setAttribute("type","file"),this.input.setAttribute("accept",pt.extensions.join(",")),this.image_=lt.createElement("img"),this.image_.classList.add(ye("image")),this.image_.classList.add(ye(`image_${pt.imageFit}`)),this.image_.crossOrigin="anonymous",this.image_.onclick=xt=>{pt.clickCallback?pt.clickCallback(xt,this.input):this.input.click()},this.element.classList.add(ye("area_root")),this.element.appendChild(this.image_),this.element.appendChild(this.input)}changeImage(lt){this.image_.src=lt}changeDraggingState(lt){const pt=this.element;lt?pt==null||pt.classList.add(ye("area_dragging")):pt==null||pt.classList.remove(ye("area_dragging"))}}let Ve=null;class tt{constructor(lt,pt){this.value=pt.value,this.viewProps=pt.viewProps,this.view=new ke(lt,{viewProps:this.viewProps,extensions:pt.extensions,imageFit:pt.imageFit,clickCallback:pt.clickCallback}),this.onFile=this.onFile.bind(this),this.onDrop=this.onDrop.bind(this),this.onDragOver=this.onDragOver.bind(this),this.onDragLeave=this.onDragLeave.bind(this),this.view.input.addEventListener("change",this.onFile),this.view.element.addEventListener("drop",this.onDrop),this.view.element.addEventListener("dragover",this.onDragOver),this.view.element.addEventListener("dragleave",this.onDragLeave),this.viewProps.handleDispose(()=>{this.view.input.removeEventListener("change",this.onFile),this.view.input.removeEventListener("drop",this.onDrop),this.view.input.removeEventListener("dragover",this.onDragOver),this.view.input.removeEventListener("dragleave",this.onDragLeave)}),this.value.emitter.on("change",this.handleValueChange.bind(this)),this.handleValueChange()}onFile(lt){const pt=(lt==null?void 0:lt.target).files;if(!pt||!pt.length)return;const xt=pt[0];this.setValue(xt)}onDrop(lt){return ce(this,void 0,void 0,function*(){lt.preventDefault();try{const{dataTransfer:pt}=lt,xt=pt==null?void 0:pt.files[0];if(xt)this.setValue(xt);else{const Tt=pt==null?void 0:pt.getData("url");if(!Tt)throw new Error("No url");this.setValue(Tt)}}catch(pt){console.error("Could not parse the dropped image",pt)}finally{this.view.changeDraggingState(!1)}})}onDragOver(lt){lt.preventDefault(),this.view.changeDraggingState(!0)}onDragLeave(){this.view.changeDraggingState(!1)}handleImage(lt){return ce(this,void 0,void 0,function*(){lt instanceof HTMLImageElement?this.updateImage(lt.src):typeof lt!="string"&&lt?yield this.setValue(lt):(lt!=="placeholder"&&lt||(lt=(yield this.handlePlaceholderImage()).src),this.updateImage(lt))})}updateImage(lt){this.view.changeImage(lt)}setValue(lt){return ce(this,void 0,void 0,function*(){if(lt instanceof HTMLImageElement)this.value.setRawValue(lt);else if(lt instanceof File){const pt=URL.createObjectURL(lt)+"#"+lt.name;lt.src=pt;const xt=yield ue(pt).catch(()=>{});this.value.setRawValue(xt||lt)}else lt?this.value.setRawValue(yield ue(lt)):this.value.setRawValue(yield this.handlePlaceholderImage())})}handleValueChange(){this.handleImage(this.value.rawValue)}handlePlaceholderImage(){return ce(this,void 0,void 0,function*(){return Ve||(Ve=yield function(){const lt=document.createElement("canvas");lt.width=320,lt.height=50;const pt=lt.getContext("2d");return pt.fillStyle="#00000004",pt.fillRect(0,0,lt.width,lt.height),pt.fillStyle="#eee",pt.font='1.25rem "Roboto Mono", "Source Code Pro", Menlo, Courier, monospace',pt.textAlign="center",pt.textBaseline="middle",pt.fillText("No image",.5*lt.width,.5*lt.height),new Promise(xt=>{lt.toBlob(Tt=>{const Pt=new Image;Pt.src=URL.createObjectURL(Tt),Pt.isPlaceholder=!0,Pt.onload=()=>{xt(Pt)}})})}()),Ve})}}const ht=[".jpg",".png",".gif"],ut={id:"input-image",type:"input",css:".tp-imgv{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:rgba(0,0,0,0);border-width:0;font-family:inherit;font-size:inherit;font-weight:inherit;margin:0;outline:none;padding:0}.tp-imgv{background-color:var(--in-bg);border-radius:var(--elm-br);box-sizing:border-box;color:var(--in-fg);font-family:inherit;height:var(--bld-us);line-height:var(--bld-us);min-width:0;width:100%}.tp-imgv:hover{background-color:var(--in-bg-h)}.tp-imgv:focus{background-color:var(--in-bg-f)}.tp-imgv:active{background-color:var(--in-bg-a)}.tp-imgv:disabled{opacity:.5}:root{--tp-plugin-image-dragging-color: hsla(230, 100%, 66%, 1.00)}.tp-imgv{cursor:pointer;display:inline-flex;height:auto !important;max-height:calc(var(--bld-us)*3);border-radius:4px;position:relative}.tp-imgv.tp-v-disabled{opacity:.5}.tp-imgv_input{width:0;height:0;pointer-events:none;visibility:hidden}.tp-imgv_image{width:100%;height:-moz-max-content;height:max-content;max-height:calc(var(--bld-us)*3);border:0}.tp-imgv_image_contain{-o-object-fit:contain;object-fit:contain}.tp-imgv_image_cover{-o-object-fit:cover;object-fit:cover}.tp-imgv_area_root{transition:opacity .16s ease-in-out}.tp-imgv_area_dragging{border:2px dashed var(--tp-plugin-image-dragging-color);border-radius:4px;opacity:.6}",accept(at,lt){if(!(at instanceof HTMLImageElement||typeof at=="string"))return null;const pt=_,xt=function(Tt,Pt){const Lt=_.required.object(Pt)(Tt);return Lt.succeeded?Lt.value:void 0}(lt,{view:pt.required.constant("input-image"),acceptUrl:pt.optional.boolean,clickCallback:pt.optional.function,imageFit:pt.optional.custom(Tt=>Tt==="contain"||Tt==="cover"?Tt:void 0),extensions:pt.optional.array(pt.required.string)});return xt?{initialValue:at,params:xt}:null},binding:{reader(at){return lt=>lt.src!==void 0?lt.src===""?"placeholder":lt.src:lt},writer(at){return(lt,pt)=>{lt.write(pt)}}},controller(at){var lt,pt;return new tt(at.document,{value:at.value,imageFit:(lt=at.params.imageFit)!==null&&lt!==void 0?lt:"cover",clickCallback:at.params.clickCallback,viewProps:at.viewProps,extensions:(pt=at.params.extensions)!==null&&pt!==void 0?pt:ht})}},_t=ut;l.plugin=_t,Object.defineProperty(l,"__esModule",{value:!0})})(o)},578:function(d,o){(function(l){class c{constructor(Ie){this.controller_=Ie}get element(){return this.controller_.view.element}get disabled(){return this.controller_.viewProps.get("disabled")}set disabled(Ie){this.controller_.viewProps.set("disabled",Ie)}get hidden(){return this.controller_.viewProps.get("hidden")}set hidden(Ie){this.controller_.viewProps.set("hidden",Ie)}dispose(){this.controller_.viewProps.set("disposed",!0)}}class u{constructor(Ie){this.target=Ie}}class h extends u{constructor(Ie,Ye,vt,Dt){super(Ie),this.value=Ye,this.presetKey=vt,this.last=Dt==null||Dt}}class _ extends u{constructor(Ie,Ye,vt){super(Ie),this.value=Ye,this.presetKey=vt}}class A extends u{constructor(Ie,Ye){super(Ie),this.expanded=Ye}}class w extends u{constructor(Ie,Ye){super(Ie),this.index=Ye}}function C(ft){return ft==null}function M(ft,Ie){if(ft.length!==Ie.length)return!1;for(let Ye=0;Ye<ft.length;Ye++)if(ft[Ye]!==Ie[Ye])return!1;return!0}function O(ft,Ie){let Ye=ft;do{const vt=Object.getOwnPropertyDescriptor(Ye,Ie);if(vt&&(vt.set!==void 0||vt.writable===!0))return!0;Ye=Object.getPrototypeOf(Ye)}while(Ye!==null);return!1}const ne={alreadydisposed:()=>"View has been already disposed",invalidparams:ft=>`Invalid parameters for '${ft.name}'`,nomatchingcontroller:ft=>`No matching controller for '${ft.key}'`,nomatchingview:ft=>`No matching view for '${JSON.stringify(ft.params)}'`,notbindable:()=>"Value is not bindable",propertynotfound:ft=>`Property '${ft.name}' not found`,shouldneverhappen:()=>"This error should never happen"};class ce{static alreadyDisposed(){return new ce({type:"alreadydisposed"})}static notBindable(){return new ce({type:"notbindable"})}static propertyNotFound(Ie){return new ce({type:"propertynotfound",context:{name:Ie}})}static shouldNeverHappen(){return new ce({type:"shouldneverhappen"})}constructor(Ie){var Ye;this.message=(Ye=ne[Ie.type](Ie.context))!==null&&Ye!==void 0?Ye:"Unexpected error",this.name=this.constructor.name,this.stack=new Error(this.message).stack,this.type=Ie.type}}class ue{constructor(Ie,Ye,vt){this.obj_=Ie,this.key_=Ye,this.presetKey_=vt??Ye}static isBindable(Ie){return Ie!==null&&(typeof Ie=="object"||typeof Ie=="function")}get key(){return this.key_}get presetKey(){return this.presetKey_}read(){return this.obj_[this.key_]}write(Ie){this.obj_[this.key_]=Ie}writeProperty(Ie,Ye){const vt=this.read();if(!ue.isBindable(vt))throw ce.notBindable();if(!(Ie in vt))throw ce.propertyNotFound(Ie);vt[Ie]=Ye}}class ye extends c{get label(){return this.controller_.props.get("label")}set label(Ie){this.controller_.props.set("label",Ie)}get title(){var Ie;return(Ie=this.controller_.valueController.props.get("title"))!==null&&Ie!==void 0?Ie:""}set title(Ie){this.controller_.valueController.props.set("title",Ie)}on(Ie,Ye){const vt=Ye.bind(this);return this.controller_.valueController.emitter.on(Ie,()=>{vt(new u(this))}),this}}class Oe{constructor(){this.observers_={}}on(Ie,Ye){let vt=this.observers_[Ie];return vt||(vt=this.observers_[Ie]=[]),vt.push({handler:Ye}),this}off(Ie,Ye){const vt=this.observers_[Ie];return vt&&(this.observers_[Ie]=vt.filter(Dt=>Dt.handler!==Ye)),this}emit(Ie,Ye){const vt=this.observers_[Ie];vt&&vt.forEach(Dt=>{Dt.handler(Ye)})}}const ke="tp";function Ve(ft){return(Ie,Ye)=>[ke,"-",ft,"v",Ie?`_${Ie}`:"",Ye?`-${Ye}`:""].join("")}function tt(ft){return ft.rawValue}function ht(ft,Ie){var Ye,vt;ft.emitter.on("change",(Ye=tt,vt=Ie,Dt=>vt(Ye(Dt)))),Ie(ft.rawValue)}function ut(ft,Ie,Ye){ht(ft.value(Ie),Ye)}function _t(ft,Ie){return Ye=>{(function(vt,Dt,zt){zt?vt.classList.add(Dt):vt.classList.remove(Dt)})(ft,Ie,Ye)}}function at(ft,Ie){ht(ft,Ye=>{Ie.textContent=Ye??""})}const lt=Ve("btn");class pt{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(lt()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("button");vt.classList.add(lt("b")),Ye.viewProps.bindDisabled(vt),this.element.appendChild(vt),this.buttonElement=vt;const Dt=Ie.createElement("div");Dt.classList.add(lt("t")),at(Ye.props.value("title"),Dt),this.buttonElement.appendChild(Dt)}}class xt{constructor(Ie,Ye){this.emitter=new Oe,this.onClick_=this.onClick_.bind(this),this.props=Ye.props,this.viewProps=Ye.viewProps,this.view=new pt(Ie,{props:this.props,viewProps:this.viewProps}),this.view.buttonElement.addEventListener("click",this.onClick_)}onClick_(){this.emitter.emit("click",{sender:this})}}class Tt{constructor(Ie,Ye){var vt;this.constraint_=Ye==null?void 0:Ye.constraint,this.equals_=(vt=Ye==null?void 0:Ye.equals)!==null&&vt!==void 0?vt:(Dt,zt)=>Dt===zt,this.emitter=new Oe,this.rawValue_=Ie}get constraint(){return this.constraint_}get rawValue(){return this.rawValue_}set rawValue(Ie){this.setRawValue(Ie,{forceEmit:!1,last:!0})}setRawValue(Ie,Ye){const vt=Ye??{forceEmit:!1,last:!0},Dt=this.constraint_?this.constraint_.constrain(Ie):Ie,zt=this.rawValue_;(!this.equals_(zt,Dt)||vt.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.rawValue_=Dt,this.emitter.emit("change",{options:vt,previousRawValue:zt,rawValue:Dt,sender:this}))}}class Pt{constructor(Ie){this.emitter=new Oe,this.value_=Ie}get rawValue(){return this.value_}set rawValue(Ie){this.setRawValue(Ie,{forceEmit:!1,last:!0})}setRawValue(Ie,Ye){const vt=Ye??{forceEmit:!1,last:!0},Dt=this.value_;(Dt!==Ie||vt.forceEmit)&&(this.emitter.emit("beforechange",{sender:this}),this.value_=Ie,this.emitter.emit("change",{options:vt,previousRawValue:Dt,rawValue:this.value_,sender:this}))}}function Lt(ft,Ie){const Ye=Ie==null?void 0:Ie.constraint,vt=Ie==null?void 0:Ie.equals;return Ye||vt?new Tt(ft,Ie):new Pt(ft)}class Bt{constructor(Ie){this.emitter=new Oe,this.valMap_=Ie;for(const Ye in this.valMap_)this.valMap_[Ye].emitter.on("change",()=>{this.emitter.emit("change",{key:Ye,sender:this})})}static createCore(Ie){return Object.keys(Ie).reduce((Ye,vt)=>Object.assign(Ye,{[vt]:Lt(Ie[vt])}),{})}static fromObject(Ie){const Ye=this.createCore(Ie);return new Bt(Ye)}get(Ie){return this.valMap_[Ie].rawValue}set(Ie,Ye){this.valMap_[Ie].rawValue=Ye}value(Ie){return this.valMap_[Ie]}}function Ut(ft){return Ie=>Ye=>{if(!Ie&&Ye===void 0)return{succeeded:!1,value:void 0};if(Ie&&Ye===void 0)return{succeeded:!0,value:void 0};const vt=ft(Ye);return vt!==void 0?{succeeded:!0,value:vt}:{succeeded:!1,value:void 0}}}function kt(ft){return{custom:Ie=>Ut(Ie)(ft),boolean:Ut(Ie=>typeof Ie=="boolean"?Ie:void 0)(ft),number:Ut(Ie=>typeof Ie=="number"?Ie:void 0)(ft),string:Ut(Ie=>typeof Ie=="string"?Ie:void 0)(ft),function:Ut(Ie=>typeof Ie=="function"?Ie:void 0)(ft),constant:Ie=>Ut(Ye=>Ye===Ie?Ie:void 0)(ft),raw:Ut(Ie=>Ie)(ft),object:Ie=>Ut(Ye=>{if((vt=Ye)!==null&&typeof vt=="object")return function(Dt,zt){return Object.keys(zt).reduce((Di,rn)=>{if(Di===void 0)return;const Bn=(0,zt[rn])(Dt[rn]);return Bn.succeeded?Object.assign(Object.assign({},Di),{[rn]:Bn.value}):void 0},{})}(Ye,Ie);var vt})(ft),array:Ie=>Ut(Ye=>{if(Array.isArray(Ye))return vt=Ie,Ye.reduce((Dt,zt)=>{if(Dt===void 0)return;const ni=vt(zt);return ni.succeeded&&ni.value!==void 0?[...Dt,ni.value]:void 0},[]);var vt})(ft)}}const Vt={optional:kt(!0),required:kt(!1)};function si(ft,Ie){const Ye=Vt.required.object(Ie)(ft);return Ye.succeeded?Ye.value:void 0}function Jt(ft){console.warn([`Missing '${ft.key}' of ${ft.target} in ${ft.place}.`,"Please rebuild plugins with the latest core package."].join(" "))}class Wt{constructor(Ie){this.value_=Ie}static create(Ie){return[new Wt(Ie),(Ye,vt)=>{Ie.setRawValue(Ye,vt)}]}get emitter(){return this.value_.emitter}get rawValue(){return this.value_.rawValue}}const Zt=Ve("");function ti(ft,Ie){return _t(ft,Zt(void 0,Ie))}class ci extends Bt{constructor(Ie){var Ye;super(Ie),this.onDisabledChange_=this.onDisabledChange_.bind(this),this.onParentChange_=this.onParentChange_.bind(this),this.onParentGlobalDisabledChange_=this.onParentGlobalDisabledChange_.bind(this),[this.globalDisabled_,this.setGlobalDisabled_]=Wt.create(Lt(this.getGlobalDisabled_())),this.value("disabled").emitter.on("change",this.onDisabledChange_),this.value("parent").emitter.on("change",this.onParentChange_),(Ye=this.get("parent"))===null||Ye===void 0||Ye.globalDisabled.emitter.on("change",this.onParentGlobalDisabledChange_)}static create(Ie){var Ye,vt,Dt;const zt=Ie??{};return new ci(Bt.createCore({disabled:(Ye=zt.disabled)!==null&&Ye!==void 0&&Ye,disposed:!1,hidden:(vt=zt.hidden)!==null&&vt!==void 0&&vt,parent:(Dt=zt.parent)!==null&&Dt!==void 0?Dt:null}))}get globalDisabled(){return this.globalDisabled_}bindClassModifiers(Ie){ht(this.globalDisabled_,ti(Ie,"disabled")),ut(this,"hidden",ti(Ie,"hidden"))}bindDisabled(Ie){ht(this.globalDisabled_,Ye=>{Ie.disabled=Ye})}bindTabIndex(Ie){ht(this.globalDisabled_,Ye=>{Ie.tabIndex=Ye?-1:0})}handleDispose(Ie){this.value("disposed").emitter.on("change",Ye=>{Ye&&Ie()})}getGlobalDisabled_(){const Ie=this.get("parent");return!!Ie&&Ie.globalDisabled.rawValue||this.get("disabled")}updateGlobalDisabled_(){this.setGlobalDisabled_(this.getGlobalDisabled_())}onDisabledChange_(){this.updateGlobalDisabled_()}onParentGlobalDisabledChange_(){this.updateGlobalDisabled_()}onParentChange_(Ie){var Ye;const vt=Ie.previousRawValue;vt==null||vt.globalDisabled.emitter.off("change",this.onParentGlobalDisabledChange_),(Ye=this.get("parent"))===null||Ye===void 0||Ye.globalDisabled.emitter.on("change",this.onParentGlobalDisabledChange_),this.updateGlobalDisabled_()}}const ri=Ve(""),Ct={veryfirst:"vfst",first:"fst",last:"lst",verylast:"vlst"};class Ht{constructor(Ie){this.parent_=null,this.blade=Ie.blade,this.view=Ie.view,this.viewProps=Ie.viewProps;const Ye=this.view.element;this.blade.value("positions").emitter.on("change",()=>{["veryfirst","first","last","verylast"].forEach(vt=>{Ye.classList.remove(ri(void 0,Ct[vt]))}),this.blade.get("positions").forEach(vt=>{Ye.classList.add(ri(void 0,Ct[vt]))})}),this.viewProps.handleDispose(()=>{(function(vt){vt&&vt.parentElement&&vt.parentElement.removeChild(vt)})(Ye)})}get parent(){return this.parent_}set parent(Ie){this.parent_=Ie,"parent"in this.viewProps.valMap_?this.viewProps.set("parent",this.parent_?this.parent_.viewProps:null):Jt({key:"parent",target:ci.name,place:"BladeController.parent"})}}const qt="http://www.w3.org/2000/svg";function Li(ft){ft.offsetHeight}function Ui(ft){return ft.ontouchstart!==void 0}function Xi(){return globalThis.document}const An={check:'<path d="M2 8l4 4l8 -8"/>',dropdown:'<path d="M5 7h6l-3 3 z"/>',p2dpad:'<path d="M8 4v8"/><path d="M4 8h8"/><circle cx="12" cy="12" r="1.2"/>'};function Ln(ft,Ie){const Ye=ft.createElementNS(qt,"svg");return Ye.innerHTML=An[Ie],Ye}function Nn(ft,Ie,Ye){ft.insertBefore(Ie,ft.children[Ye])}function Kn(ft){ft.parentElement&&ft.parentElement.removeChild(ft)}function _i(ft){for(;ft.children.length>0;)ft.removeChild(ft.children[0])}function Gi(ft){return ft.relatedTarget?ft.relatedTarget:"explicitOriginalTarget"in ft?ft.explicitOriginalTarget:null}const sn=Ve("lbl");class jt{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(sn()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("div");vt.classList.add(sn("l")),ut(Ye.props,"label",zt=>{C(zt)?this.element.classList.add(sn(void 0,"nol")):(this.element.classList.remove(sn(void 0,"nol")),function(ni){for(;ni.childNodes.length>0;)ni.removeChild(ni.childNodes[0])}(vt),vt.appendChild(function(ni,Di){const rn=ni.createDocumentFragment();return Di.split(`
`).map(Bn=>ni.createTextNode(Bn)).forEach((Bn,tr)=>{tr>0&&rn.appendChild(ni.createElement("br")),rn.appendChild(Bn)}),rn}(Ie,zt)))}),this.element.appendChild(vt),this.labelElement=vt;const Dt=Ie.createElement("div");Dt.classList.add(sn("v")),this.element.appendChild(Dt),this.valueElement=Dt}}class Gt extends Ht{constructor(Ie,Ye){const vt=Ye.valueController.viewProps;super(Object.assign(Object.assign({},Ye),{view:new jt(Ie,{props:Ye.props,viewProps:vt}),viewProps:vt})),this.props=Ye.props,this.valueController=Ye.valueController,this.view.valueElement.appendChild(this.valueController.view.element)}}const li={id:"button",type:"blade",accept(ft){const Ie=Vt,Ye=si(ft,{title:Ie.required.string,view:Ie.required.constant("button"),label:Ie.optional.string});return Ye?{params:Ye}:null},controller(ft){return new Gt(ft.document,{blade:ft.blade,props:Bt.fromObject({label:ft.params.label}),valueController:new xt(ft.document,{props:Bt.fromObject({title:ft.params.title}),viewProps:ft.viewProps})})},api(ft){return ft.controller instanceof Gt&&ft.controller.valueController instanceof xt?new ye(ft.controller):null}};class vi extends Ht{constructor(Ie){super(Ie),this.value=Ie.value}}function xi(){return new Bt({positions:Lt([],{equals:M})})}class mi extends Bt{constructor(Ie){super(Ie)}static create(Ie){const Ye={completed:!0,expanded:Ie,expandedHeight:null,shouldFixHeight:!1,temporaryExpanded:null},vt=Bt.createCore(Ye);return new mi(vt)}get styleExpanded(){var Ie;return(Ie=this.get("temporaryExpanded"))!==null&&Ie!==void 0?Ie:this.get("expanded")}get styleHeight(){if(!this.styleExpanded)return"0";const Ie=this.get("expandedHeight");return this.get("shouldFixHeight")&&!C(Ie)?`${Ie}px`:"auto"}bindExpandedClass(Ie,Ye){const vt=()=>{this.styleExpanded?Ie.classList.add(Ye):Ie.classList.remove(Ye)};ut(this,"expanded",vt),ut(this,"temporaryExpanded",vt)}cleanUpTransition(){this.set("shouldFixHeight",!1),this.set("expandedHeight",null),this.set("completed",!0)}}function Ri(ft,Ie){Ie.style.height=ft.styleHeight}function Zi(ft,Ie){ft.value("expanded").emitter.on("beforechange",()=>{if(ft.set("completed",!1),C(ft.get("expandedHeight"))){const Ye=function(vt,Dt){let zt=0;return function(ni,Di){const rn=ni.style.transition;ni.style.transition="none",Di(),ni.style.transition=rn}(Dt,()=>{vt.set("expandedHeight",null),vt.set("temporaryExpanded",!0),Li(Dt),zt=Dt.clientHeight,vt.set("temporaryExpanded",null),Li(Dt)}),zt}(ft,Ie);Ye>0&&ft.set("expandedHeight",Ye)}ft.set("shouldFixHeight",!0),Li(Ie)}),ft.emitter.on("change",()=>{Ri(ft,Ie)}),Ri(ft,Ie),Ie.addEventListener("transitionend",Ye=>{Ye.propertyName==="height"&&ft.cleanUpTransition()})}class dn extends c{constructor(Ie,Ye){super(Ie),this.rackApi_=Ye}}class hn{constructor(Ie){this.emitter=new Oe,this.items_=[],this.cache_=new Set,this.onSubListAdd_=this.onSubListAdd_.bind(this),this.onSubListRemove_=this.onSubListRemove_.bind(this),this.extract_=Ie}get items(){return this.items_}allItems(){return Array.from(this.cache_)}find(Ie){for(const Ye of this.allItems())if(Ie(Ye))return Ye;return null}includes(Ie){return this.cache_.has(Ie)}add(Ie,Ye){if(this.includes(Ie))throw ce.shouldNeverHappen();const vt=Ye!==void 0?Ye:this.items_.length;this.items_.splice(vt,0,Ie),this.cache_.add(Ie);const Dt=this.extract_(Ie);Dt&&(Dt.emitter.on("add",this.onSubListAdd_),Dt.emitter.on("remove",this.onSubListRemove_),Dt.allItems().forEach(zt=>{this.cache_.add(zt)})),this.emitter.emit("add",{index:vt,item:Ie,root:this,target:this})}remove(Ie){const Ye=this.items_.indexOf(Ie);if(Ye<0)return;this.items_.splice(Ye,1),this.cache_.delete(Ie);const vt=this.extract_(Ie);vt&&(vt.emitter.off("add",this.onSubListAdd_),vt.emitter.off("remove",this.onSubListRemove_)),this.emitter.emit("remove",{index:Ye,item:Ie,root:this,target:this})}onSubListAdd_(Ie){this.cache_.add(Ie.item),this.emitter.emit("add",{index:Ie.index,item:Ie.item,root:this,target:Ie.target})}onSubListRemove_(Ie){this.cache_.delete(Ie.item),this.emitter.emit("remove",{index:Ie.index,item:Ie.item,root:this,target:Ie.target})}}class an extends c{constructor(Ie){super(Ie),this.onBindingChange_=this.onBindingChange_.bind(this),this.emitter_=new Oe,this.controller_.binding.emitter.on("change",this.onBindingChange_)}get label(){return this.controller_.props.get("label")}set label(Ie){this.controller_.props.set("label",Ie)}on(Ie,Ye){const vt=Ye.bind(this);return this.emitter_.on(Ie,Dt=>{vt(Dt.event)}),this}refresh(){this.controller_.binding.read()}onBindingChange_(Ie){const Ye=Ie.sender.target.read();this.emitter_.emit("change",{event:new h(this,Ye,this.controller_.binding.target.presetKey,Ie.options.last)})}}class pn extends Gt{constructor(Ie,Ye){super(Ie,Ye),this.binding=Ye.binding}}class Yi extends c{constructor(Ie){super(Ie),this.onBindingUpdate_=this.onBindingUpdate_.bind(this),this.emitter_=new Oe,this.controller_.binding.emitter.on("update",this.onBindingUpdate_)}get label(){return this.controller_.props.get("label")}set label(Ie){this.controller_.props.set("label",Ie)}on(Ie,Ye){const vt=Ye.bind(this);return this.emitter_.on(Ie,Dt=>{vt(Dt.event)}),this}refresh(){this.controller_.binding.read()}onBindingUpdate_(Ie){const Ye=Ie.sender.target.read();this.emitter_.emit("update",{event:new _(this,Ye,this.controller_.binding.target.presetKey)})}}class nn extends Gt{constructor(Ie,Ye){super(Ie,Ye),this.binding=Ye.binding,this.viewProps.bindDisabled(this.binding.ticker),this.viewProps.handleDispose(()=>{this.binding.dispose()})}}function kn(ft){return ft instanceof fn?ft.apiSet_:ft instanceof dn?ft.rackApi_.apiSet_:null}function un(ft,Ie){const Ye=ft.find(vt=>vt.controller_===Ie);if(!Ye)throw ce.shouldNeverHappen();return Ye}function On(ft,Ie,Ye){if(!ue.isBindable(ft))throw ce.notBindable();return new ue(ft,Ie,Ye)}class fn extends c{constructor(Ie,Ye){super(Ie),this.onRackAdd_=this.onRackAdd_.bind(this),this.onRackRemove_=this.onRackRemove_.bind(this),this.onRackInputChange_=this.onRackInputChange_.bind(this),this.onRackMonitorUpdate_=this.onRackMonitorUpdate_.bind(this),this.emitter_=new Oe,this.apiSet_=new hn(kn),this.pool_=Ye;const vt=this.controller_.rack;vt.emitter.on("add",this.onRackAdd_),vt.emitter.on("remove",this.onRackRemove_),vt.emitter.on("inputchange",this.onRackInputChange_),vt.emitter.on("monitorupdate",this.onRackMonitorUpdate_),vt.children.forEach(Dt=>{this.setUpApi_(Dt)})}get children(){return this.controller_.rack.children.map(Ie=>un(this.apiSet_,Ie))}addInput(Ie,Ye,vt){const Dt=vt??{},zt=this.controller_.view.element.ownerDocument,ni=this.pool_.createInput(zt,On(Ie,Ye,Dt.presetKey),Dt),Di=new an(ni);return this.add(Di,Dt.index)}addMonitor(Ie,Ye,vt){const Dt=vt??{},zt=this.controller_.view.element.ownerDocument,ni=this.pool_.createMonitor(zt,On(Ie,Ye),Dt),Di=new Yi(ni);return this.add(Di,Dt.index)}addFolder(Ie){return function(Ye,vt){return Ye.addBlade(Object.assign(Object.assign({},vt),{view:"folder"}))}(this,Ie)}addButton(Ie){return function(Ye,vt){return Ye.addBlade(Object.assign(Object.assign({},vt),{view:"button"}))}(this,Ie)}addSeparator(Ie){return function(Ye,vt){const Dt=vt??{};return Ye.addBlade(Object.assign(Object.assign({},Dt),{view:"separator"}))}(this,Ie)}addTab(Ie){return function(Ye,vt){return Ye.addBlade(Object.assign(Object.assign({},vt),{view:"tab"}))}(this,Ie)}add(Ie,Ye){this.controller_.rack.add(Ie.controller_,Ye);const vt=this.apiSet_.find(Dt=>Dt.controller_===Ie.controller_);return vt&&this.apiSet_.remove(vt),this.apiSet_.add(Ie),Ie}remove(Ie){this.controller_.rack.remove(Ie.controller_)}addBlade(Ie){const Ye=this.controller_.view.element.ownerDocument,vt=this.pool_.createBlade(Ye,Ie),Dt=this.pool_.createBladeApi(vt);return this.add(Dt,Ie.index)}on(Ie,Ye){const vt=Ye.bind(this);return this.emitter_.on(Ie,Dt=>{vt(Dt.event)}),this}setUpApi_(Ie){this.apiSet_.find(Ye=>Ye.controller_===Ie)||this.apiSet_.add(this.pool_.createBladeApi(Ie))}onRackAdd_(Ie){this.setUpApi_(Ie.bladeController)}onRackRemove_(Ie){if(Ie.isRoot){const Ye=un(this.apiSet_,Ie.bladeController);this.apiSet_.remove(Ye)}}onRackInputChange_(Ie){const Ye=Ie.bladeController;if(Ye instanceof pn){const vt=un(this.apiSet_,Ye),Dt=Ye.binding;this.emitter_.emit("change",{event:new h(vt,Dt.target.read(),Dt.target.presetKey,Ie.options.last)})}else if(Ye instanceof vi){const vt=un(this.apiSet_,Ye);this.emitter_.emit("change",{event:new h(vt,Ye.value.rawValue,void 0,Ie.options.last)})}}onRackMonitorUpdate_(Ie){if(!(Ie.bladeController instanceof nn))throw ce.shouldNeverHappen();const Ye=un(this.apiSet_,Ie.bladeController),vt=Ie.bladeController.binding;this.emitter_.emit("update",{event:new _(Ye,vt.target.read(),vt.target.presetKey)})}}class Fn extends dn{constructor(Ie,Ye){super(Ie,new fn(Ie.rackController,Ye)),this.emitter_=new Oe,this.controller_.foldable.value("expanded").emitter.on("change",vt=>{this.emitter_.emit("fold",{event:new A(this,vt.sender.rawValue)})}),this.rackApi_.on("change",vt=>{this.emitter_.emit("change",{event:vt})}),this.rackApi_.on("update",vt=>{this.emitter_.emit("update",{event:vt})})}get expanded(){return this.controller_.foldable.get("expanded")}set expanded(Ie){this.controller_.foldable.set("expanded",Ie)}get title(){return this.controller_.props.get("title")}set title(Ie){this.controller_.props.set("title",Ie)}get children(){return this.rackApi_.children}addInput(Ie,Ye,vt){return this.rackApi_.addInput(Ie,Ye,vt)}addMonitor(Ie,Ye,vt){return this.rackApi_.addMonitor(Ie,Ye,vt)}addFolder(Ie){return this.rackApi_.addFolder(Ie)}addButton(Ie){return this.rackApi_.addButton(Ie)}addSeparator(Ie){return this.rackApi_.addSeparator(Ie)}addTab(Ie){return this.rackApi_.addTab(Ie)}add(Ie,Ye){return this.rackApi_.add(Ie,Ye)}remove(Ie){this.rackApi_.remove(Ie)}addBlade(Ie){return this.rackApi_.addBlade(Ie)}on(Ie,Ye){const vt=Ye.bind(this);return this.emitter_.on(Ie,Dt=>{vt(Dt.event)}),this}}class xr extends Ht{constructor(Ie){super({blade:Ie.blade,view:Ie.view,viewProps:Ie.rackController.viewProps}),this.rackController=Ie.rackController}}class Zn{constructor(Ie,Ye){const vt=Ve(Ye.viewName);this.element=Ie.createElement("div"),this.element.classList.add(vt()),Ye.viewProps.bindClassModifiers(this.element)}}function Rn(ft){return ft instanceof Fi?ft.rack:ft instanceof xr?ft.rackController.rack:null}function Un(ft){const Ie=Rn(ft);return Ie?Ie.bcSet_:null}class Ai{constructor(Ie){var Ye,vt;this.onBladePositionsChange_=this.onBladePositionsChange_.bind(this),this.onSetAdd_=this.onSetAdd_.bind(this),this.onSetRemove_=this.onSetRemove_.bind(this),this.onChildDispose_=this.onChildDispose_.bind(this),this.onChildPositionsChange_=this.onChildPositionsChange_.bind(this),this.onChildInputChange_=this.onChildInputChange_.bind(this),this.onChildMonitorUpdate_=this.onChildMonitorUpdate_.bind(this),this.onChildValueChange_=this.onChildValueChange_.bind(this),this.onChildViewPropsChange_=this.onChildViewPropsChange_.bind(this),this.onDescendantLayout_=this.onDescendantLayout_.bind(this),this.onDescendantInputChange_=this.onDescendantInputChange_.bind(this),this.onDescendantMonitorUpdate_=this.onDescendantMonitorUpdate_.bind(this),this.emitter=new Oe,this.blade_=(Ye=Ie.blade)!==null&&Ye!==void 0?Ye:null,(vt=this.blade_)===null||vt===void 0||vt.value("positions").emitter.on("change",this.onBladePositionsChange_),this.viewProps=Ie.viewProps,this.bcSet_=new hn(Un),this.bcSet_.emitter.on("add",this.onSetAdd_),this.bcSet_.emitter.on("remove",this.onSetRemove_)}get children(){return this.bcSet_.items}add(Ie,Ye){var vt;(vt=Ie.parent)===null||vt===void 0||vt.remove(Ie),O(Ie,"parent")?Ie.parent=this:(Ie.parent_=this,Jt({key:"parent",target:"BladeController",place:"BladeRack.add"})),this.bcSet_.add(Ie,Ye)}remove(Ie){O(Ie,"parent")?Ie.parent=null:(Ie.parent_=null,Jt({key:"parent",target:"BladeController",place:"BladeRack.remove"})),this.bcSet_.remove(Ie)}find(Ie){return this.bcSet_.allItems().filter(Ye=>Ye instanceof Ie)}onSetAdd_(Ie){this.updatePositions_();const Ye=Ie.target===Ie.root;if(this.emitter.emit("add",{bladeController:Ie.item,index:Ie.index,isRoot:Ye,sender:this}),!Ye)return;const vt=Ie.item;if(vt.viewProps.emitter.on("change",this.onChildViewPropsChange_),vt.blade.value("positions").emitter.on("change",this.onChildPositionsChange_),vt.viewProps.handleDispose(this.onChildDispose_),vt instanceof pn)vt.binding.emitter.on("change",this.onChildInputChange_);else if(vt instanceof nn)vt.binding.emitter.on("update",this.onChildMonitorUpdate_);else if(vt instanceof vi)vt.value.emitter.on("change",this.onChildValueChange_);else{const Dt=Rn(vt);if(Dt){const zt=Dt.emitter;zt.on("layout",this.onDescendantLayout_),zt.on("inputchange",this.onDescendantInputChange_),zt.on("monitorupdate",this.onDescendantMonitorUpdate_)}}}onSetRemove_(Ie){this.updatePositions_();const Ye=Ie.target===Ie.root;if(this.emitter.emit("remove",{bladeController:Ie.item,isRoot:Ye,sender:this}),!Ye)return;const vt=Ie.item;if(vt instanceof pn)vt.binding.emitter.off("change",this.onChildInputChange_);else if(vt instanceof nn)vt.binding.emitter.off("update",this.onChildMonitorUpdate_);else if(vt instanceof vi)vt.value.emitter.off("change",this.onChildValueChange_);else{const Dt=Rn(vt);if(Dt){const zt=Dt.emitter;zt.off("layout",this.onDescendantLayout_),zt.off("inputchange",this.onDescendantInputChange_),zt.off("monitorupdate",this.onDescendantMonitorUpdate_)}}}updatePositions_(){const Ie=this.bcSet_.items.filter(Dt=>!Dt.viewProps.get("hidden")),Ye=Ie[0],vt=Ie[Ie.length-1];this.bcSet_.items.forEach(Dt=>{const zt=[];Dt===Ye&&(zt.push("first"),this.blade_&&!this.blade_.get("positions").includes("veryfirst")||zt.push("veryfirst")),Dt===vt&&(zt.push("last"),this.blade_&&!this.blade_.get("positions").includes("verylast")||zt.push("verylast")),Dt.blade.set("positions",zt)})}onChildPositionsChange_(){this.updatePositions_(),this.emitter.emit("layout",{sender:this})}onChildViewPropsChange_(Ie){this.updatePositions_(),this.emitter.emit("layout",{sender:this})}onChildDispose_(){this.bcSet_.items.filter(Ie=>Ie.viewProps.get("disposed")).forEach(Ie=>{this.bcSet_.remove(Ie)})}onChildInputChange_(Ie){const Ye=function(vt,Dt){for(let zt=0;zt<vt.length;zt++){const ni=vt[zt];if(ni instanceof pn&&ni.binding===Dt)return ni}return null}(this.find(pn),Ie.sender);if(!Ye)throw ce.alreadyDisposed();this.emitter.emit("inputchange",{bladeController:Ye,options:Ie.options,sender:this})}onChildMonitorUpdate_(Ie){const Ye=function(vt,Dt){for(let zt=0;zt<vt.length;zt++){const ni=vt[zt];if(ni instanceof nn&&ni.binding===Dt)return ni}return null}(this.find(nn),Ie.sender);if(!Ye)throw ce.alreadyDisposed();this.emitter.emit("monitorupdate",{bladeController:Ye,sender:this})}onChildValueChange_(Ie){const Ye=function(vt,Dt){for(let zt=0;zt<vt.length;zt++){const ni=vt[zt];if(ni instanceof vi&&ni.value===Dt)return ni}return null}(this.find(vi),Ie.sender);if(!Ye)throw ce.alreadyDisposed();this.emitter.emit("inputchange",{bladeController:Ye,options:Ie.options,sender:this})}onDescendantLayout_(Ie){this.updatePositions_(),this.emitter.emit("layout",{sender:this})}onDescendantInputChange_(Ie){this.emitter.emit("inputchange",{bladeController:Ie.bladeController,options:Ie.options,sender:this})}onDescendantMonitorUpdate_(Ie){this.emitter.emit("monitorupdate",{bladeController:Ie.bladeController,sender:this})}onBladePositionsChange_(){this.updatePositions_()}}class Fi extends Ht{constructor(Ie,Ye){super(Object.assign(Object.assign({},Ye),{view:new Zn(Ie,{viewName:"brk",viewProps:Ye.viewProps})})),this.onRackAdd_=this.onRackAdd_.bind(this),this.onRackRemove_=this.onRackRemove_.bind(this);const vt=new Ai({blade:Ye.root?void 0:Ye.blade,viewProps:Ye.viewProps});vt.emitter.on("add",this.onRackAdd_),vt.emitter.on("remove",this.onRackRemove_),this.rack=vt,this.viewProps.handleDispose(()=>{for(let Dt=this.rack.children.length-1;Dt>=0;Dt--)this.rack.children[Dt].viewProps.set("disposed",!0)})}onRackAdd_(Ie){Ie.isRoot&&Nn(this.view.element,Ie.bladeController.view.element,Ie.index)}onRackRemove_(Ie){Ie.isRoot&&Kn(Ie.bladeController.view.element)}}const Ki=Ve("cnt");class _n{constructor(Ie,Ye){var vt;this.className_=Ve((vt=Ye.viewName)!==null&&vt!==void 0?vt:"fld"),this.element=Ie.createElement("div"),this.element.classList.add(this.className_(),Ki()),Ye.viewProps.bindClassModifiers(this.element),this.foldable_=Ye.foldable,this.foldable_.bindExpandedClass(this.element,this.className_(void 0,"expanded")),ut(this.foldable_,"completed",_t(this.element,this.className_(void 0,"cpl")));const Dt=Ie.createElement("button");Dt.classList.add(this.className_("b")),ut(Ye.props,"title",Bn=>{C(Bn)?this.element.classList.add(this.className_(void 0,"not")):this.element.classList.remove(this.className_(void 0,"not"))}),Ye.viewProps.bindDisabled(Dt),this.element.appendChild(Dt),this.buttonElement=Dt;const zt=Ie.createElement("div");zt.classList.add(this.className_("i")),this.element.appendChild(zt);const ni=Ie.createElement("div");ni.classList.add(this.className_("t")),at(Ye.props.value("title"),ni),this.buttonElement.appendChild(ni),this.titleElement=ni;const Di=Ie.createElement("div");Di.classList.add(this.className_("m")),this.buttonElement.appendChild(Di);const rn=Ye.containerElement;rn.classList.add(this.className_("c")),this.element.appendChild(rn),this.containerElement=rn}}class yn extends xr{constructor(Ie,Ye){var vt;const Dt=mi.create((vt=Ye.expanded)===null||vt===void 0||vt),zt=new Fi(Ie,{blade:Ye.blade,root:Ye.root,viewProps:Ye.viewProps});super(Object.assign(Object.assign({},Ye),{rackController:zt,view:new _n(Ie,{containerElement:zt.view.element,foldable:Dt,props:Ye.props,viewName:Ye.root?"rot":void 0,viewProps:Ye.viewProps})})),this.onTitleClick_=this.onTitleClick_.bind(this),this.props=Ye.props,this.foldable=Dt,Zi(this.foldable,this.view.containerElement),this.rackController.rack.emitter.on("add",()=>{this.foldable.cleanUpTransition()}),this.rackController.rack.emitter.on("remove",()=>{this.foldable.cleanUpTransition()}),this.view.buttonElement.addEventListener("click",this.onTitleClick_)}get document(){return this.view.element.ownerDocument}onTitleClick_(){this.foldable.set("expanded",!this.foldable.get("expanded"))}}const Tn={id:"folder",type:"blade",accept(ft){const Ie=Vt,Ye=si(ft,{title:Ie.required.string,view:Ie.required.constant("folder"),expanded:Ie.optional.boolean});return Ye?{params:Ye}:null},controller(ft){return new yn(ft.document,{blade:ft.blade,expanded:ft.params.expanded,props:Bt.fromObject({title:ft.params.title}),viewProps:ft.viewProps})},api(ft){return ft.controller instanceof yn?new Fn(ft.controller,ft.pool):null}};class qn extends vi{constructor(Ie,Ye){const vt=Ye.valueController.viewProps;super(Object.assign(Object.assign({},Ye),{value:Ye.valueController.value,view:new jt(Ie,{props:Ye.props,viewProps:vt}),viewProps:vt})),this.props=Ye.props,this.valueController=Ye.valueController,this.view.valueElement.appendChild(this.valueController.view.element)}}class fr extends c{}const wr=Ve("spr");class jr{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(wr()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("hr");vt.classList.add(wr("r")),this.element.appendChild(vt)}}class Xr extends Ht{constructor(Ie,Ye){super(Object.assign(Object.assign({},Ye),{view:new jr(Ie,{viewProps:Ye.viewProps})}))}}const Nr={id:"separator",type:"blade",accept(ft){const Ie=si(ft,{view:Vt.required.constant("separator")});return Ie?{params:Ie}:null},controller(ft){return new Xr(ft.document,{blade:ft.blade,viewProps:ft.viewProps})},api(ft){return ft.controller instanceof Xr?new fr(ft.controller):null}},vn=Ve("tbi");class wn{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(vn()),Ye.viewProps.bindClassModifiers(this.element),ut(Ye.props,"selected",zt=>{zt?this.element.classList.add(vn(void 0,"sel")):this.element.classList.remove(vn(void 0,"sel"))});const vt=Ie.createElement("button");vt.classList.add(vn("b")),Ye.viewProps.bindDisabled(vt),this.element.appendChild(vt),this.buttonElement=vt;const Dt=Ie.createElement("div");Dt.classList.add(vn("t")),at(Ye.props.value("title"),Dt),this.buttonElement.appendChild(Dt),this.titleElement=Dt}}class Zr{constructor(Ie,Ye){this.emitter=new Oe,this.onClick_=this.onClick_.bind(this),this.props=Ye.props,this.viewProps=Ye.viewProps,this.view=new wn(Ie,{props:Ye.props,viewProps:Ye.viewProps}),this.view.buttonElement.addEventListener("click",this.onClick_)}onClick_(){this.emitter.emit("click",{sender:this})}}class or{constructor(Ie,Ye){this.onItemClick_=this.onItemClick_.bind(this),this.ic_=new Zr(Ie,{props:Ye.itemProps,viewProps:ci.create()}),this.ic_.emitter.on("click",this.onItemClick_),this.cc_=new Fi(Ie,{blade:xi(),viewProps:ci.create()}),this.props=Ye.props,ut(this.props,"selected",vt=>{this.itemController.props.set("selected",vt),this.contentController.viewProps.set("hidden",!vt)})}get itemController(){return this.ic_}get contentController(){return this.cc_}onItemClick_(){this.props.set("selected",!0)}}class eo{constructor(Ie,Ye){this.controller_=Ie,this.rackApi_=Ye}get title(){var Ie;return(Ie=this.controller_.itemController.props.get("title"))!==null&&Ie!==void 0?Ie:""}set title(Ie){this.controller_.itemController.props.set("title",Ie)}get selected(){return this.controller_.props.get("selected")}set selected(Ie){this.controller_.props.set("selected",Ie)}get children(){return this.rackApi_.children}addButton(Ie){return this.rackApi_.addButton(Ie)}addFolder(Ie){return this.rackApi_.addFolder(Ie)}addSeparator(Ie){return this.rackApi_.addSeparator(Ie)}addTab(Ie){return this.rackApi_.addTab(Ie)}add(Ie,Ye){this.rackApi_.add(Ie,Ye)}remove(Ie){this.rackApi_.remove(Ie)}addInput(Ie,Ye,vt){return this.rackApi_.addInput(Ie,Ye,vt)}addMonitor(Ie,Ye,vt){return this.rackApi_.addMonitor(Ie,Ye,vt)}addBlade(Ie){return this.rackApi_.addBlade(Ie)}}class Kr extends dn{constructor(Ie,Ye){super(Ie,new fn(Ie.rackController,Ye)),this.onPageAdd_=this.onPageAdd_.bind(this),this.onPageRemove_=this.onPageRemove_.bind(this),this.onSelect_=this.onSelect_.bind(this),this.emitter_=new Oe,this.pageApiMap_=new Map,this.rackApi_.on("change",vt=>{this.emitter_.emit("change",{event:vt})}),this.rackApi_.on("update",vt=>{this.emitter_.emit("update",{event:vt})}),this.controller_.tab.selectedIndex.emitter.on("change",this.onSelect_),this.controller_.pageSet.emitter.on("add",this.onPageAdd_),this.controller_.pageSet.emitter.on("remove",this.onPageRemove_),this.controller_.pageSet.items.forEach(vt=>{this.setUpPageApi_(vt)})}get pages(){return this.controller_.pageSet.items.map(Ie=>{const Ye=this.pageApiMap_.get(Ie);if(!Ye)throw ce.shouldNeverHappen();return Ye})}addPage(Ie){const Ye=this.controller_.view.element.ownerDocument,vt=new or(Ye,{itemProps:Bt.fromObject({selected:!1,title:Ie.title}),props:Bt.fromObject({selected:!1})});this.controller_.add(vt,Ie.index);const Dt=this.pageApiMap_.get(vt);if(!Dt)throw ce.shouldNeverHappen();return Dt}removePage(Ie){this.controller_.remove(Ie)}on(Ie,Ye){const vt=Ye.bind(this);return this.emitter_.on(Ie,Dt=>{vt(Dt.event)}),this}setUpPageApi_(Ie){const Ye=this.rackApi_.apiSet_.find(Dt=>Dt.controller_===Ie.contentController);if(!Ye)throw ce.shouldNeverHappen();const vt=new eo(Ie,Ye);this.pageApiMap_.set(Ie,vt)}onPageAdd_(Ie){this.setUpPageApi_(Ie.item)}onPageRemove_(Ie){if(!this.pageApiMap_.get(Ie.item))throw ce.shouldNeverHappen();this.pageApiMap_.delete(Ie.item)}onSelect_(Ie){this.emitter_.emit("select",{event:new w(this,Ie.rawValue)})}}class to{constructor(){this.onItemSelectedChange_=this.onItemSelectedChange_.bind(this),this.empty=Lt(!0),this.selectedIndex=Lt(-1),this.items_=[]}add(Ie,Ye){const vt=Ye??this.items_.length;this.items_.splice(vt,0,Ie),Ie.emitter.on("change",this.onItemSelectedChange_),this.keepSelection_()}remove(Ie){const Ye=this.items_.indexOf(Ie);Ye<0||(this.items_.splice(Ye,1),Ie.emitter.off("change",this.onItemSelectedChange_),this.keepSelection_())}keepSelection_(){if(this.items_.length===0)return this.selectedIndex.rawValue=-1,void(this.empty.rawValue=!0);const Ie=this.items_.findIndex(Ye=>Ye.rawValue);Ie<0?(this.items_.forEach((Ye,vt)=>{Ye.rawValue=vt===0}),this.selectedIndex.rawValue=0):(this.items_.forEach((Ye,vt)=>{Ye.rawValue=vt===Ie}),this.selectedIndex.rawValue=Ie),this.empty.rawValue=!1}onItemSelectedChange_(Ie){if(Ie.rawValue){const Ye=this.items_.findIndex(vt=>vt===Ie.sender);this.items_.forEach((vt,Dt)=>{vt.rawValue=Dt===Ye}),this.selectedIndex.rawValue=Ye}else this.keepSelection_()}}const cr=Ve("tab");class Er{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(cr(),Ki()),Ye.viewProps.bindClassModifiers(this.element),ht(Ye.empty,_t(this.element,cr(void 0,"nop")));const vt=Ie.createElement("div");vt.classList.add(cr("t")),this.element.appendChild(vt),this.itemsElement=vt;const Dt=Ie.createElement("div");Dt.classList.add(cr("i")),this.element.appendChild(Dt);const zt=Ye.contentsElement;zt.classList.add(cr("c")),this.element.appendChild(zt),this.contentsElement=zt}}class co extends xr{constructor(Ie,Ye){const vt=new Fi(Ie,{blade:Ye.blade,viewProps:Ye.viewProps}),Dt=new to;super({blade:Ye.blade,rackController:vt,view:new Er(Ie,{contentsElement:vt.view.element,empty:Dt.empty,viewProps:Ye.viewProps})}),this.onPageAdd_=this.onPageAdd_.bind(this),this.onPageRemove_=this.onPageRemove_.bind(this),this.pageSet_=new hn(()=>null),this.pageSet_.emitter.on("add",this.onPageAdd_),this.pageSet_.emitter.on("remove",this.onPageRemove_),this.tab=Dt}get pageSet(){return this.pageSet_}add(Ie,Ye){this.pageSet_.add(Ie,Ye)}remove(Ie){this.pageSet_.remove(this.pageSet_.items[Ie])}onPageAdd_(Ie){const Ye=Ie.item;Nn(this.view.itemsElement,Ye.itemController.view.element,Ie.index),Ye.itemController.viewProps.set("parent",this.viewProps),this.rackController.rack.add(Ye.contentController,Ie.index),this.tab.add(Ye.props.value("selected"))}onPageRemove_(Ie){const Ye=Ie.item;Kn(Ye.itemController.view.element),Ye.itemController.viewProps.set("parent",null),this.rackController.rack.remove(Ye.contentController),this.tab.remove(Ye.props.value("selected"))}}const Uo={id:"tab",type:"blade",accept(ft){const Ie=Vt,Ye=si(ft,{pages:Ie.required.array(Ie.required.object({title:Ie.required.string})),view:Ie.required.constant("tab")});return Ye&&Ye.pages.length!==0?{params:Ye}:null},controller(ft){const Ie=new co(ft.document,{blade:ft.blade,viewProps:ft.viewProps});return ft.params.pages.forEach(Ye=>{const vt=new or(ft.document,{itemProps:Bt.fromObject({selected:!1,title:Ye.title}),props:Bt.fromObject({selected:!1})});Ie.add(vt)}),Ie},api(ft){return ft.controller instanceof co?new Kr(ft.controller,ft.pool):null}};class uo{constructor(){this.disabled=!1,this.emitter=new Oe}dispose(){}tick(){this.disabled||this.emitter.emit("tick",{sender:this})}}class rs{constructor(Ie,Ye){this.disabled_=!1,this.timerId_=null,this.onTick_=this.onTick_.bind(this),this.doc_=Ie,this.emitter=new Oe,this.interval_=Ye,this.setTimer_()}get disabled(){return this.disabled_}set disabled(Ie){this.disabled_=Ie,this.disabled_?this.clearTimer_():this.setTimer_()}dispose(){this.clearTimer_()}clearTimer_(){if(this.timerId_===null)return;const Ie=this.doc_.defaultView;Ie&&Ie.clearInterval(this.timerId_),this.timerId_=null}setTimer_(){if(this.clearTimer_(),this.interval_<=0)return;const Ie=this.doc_.defaultView;Ie&&(this.timerId_=Ie.setInterval(this.onTick_,this.interval_))}onTick_(){this.disabled_||this.emitter.emit("tick",{sender:this})}}class uc{constructor(Ie){this.onValueChange_=this.onValueChange_.bind(this),this.reader=Ie.reader,this.writer=Ie.writer,this.emitter=new Oe,this.value=Ie.value,this.value.emitter.on("change",this.onValueChange_),this.target=Ie.target,this.read()}read(){const Ie=this.target.read();Ie!==void 0&&(this.value.rawValue=this.reader(Ie))}write_(Ie){this.writer(this.target,Ie)}onValueChange_(Ie){this.write_(Ie.rawValue),this.emitter.emit("change",{options:Ie.options,rawValue:Ie.rawValue,sender:this})}}function pl(ft,Ie){for(;ft.length<Ie;)ft.push(void 0)}function dc(ft){const Ie=[];return pl(Ie,ft),Lt(Ie)}function hc(ft){const Ie=ft.indexOf(void 0);return Ie<0?ft:ft.slice(0,Ie)}class bu{constructor(Ie){this.onTick_=this.onTick_.bind(this),this.reader_=Ie.reader,this.target=Ie.target,this.emitter=new Oe,this.value=Ie.value,this.ticker=Ie.ticker,this.ticker.emitter.on("tick",this.onTick_),this.read()}dispose(){this.ticker.dispose()}read(){const Ie=this.target.read();if(Ie===void 0)return;const Ye=this.value.rawValue,vt=this.reader_(Ie);this.value.rawValue=function(Dt,zt){const ni=[...hc(Dt),zt];return ni.length>Dt.length?ni.splice(0,ni.length-Dt.length):pl(ni,Dt.length),ni}(Ye,vt),this.emitter.emit("update",{rawValue:vt,sender:this})}onTick_(Ie){this.read()}}class Is{constructor(Ie){this.constraints=Ie}constrain(Ie){return this.constraints.reduce((Ye,vt)=>vt.constrain(Ye),Ie)}}function Fo(ft,Ie){if(ft instanceof Ie)return ft;if(ft instanceof Is){const Ye=ft.constraints.reduce((vt,Dt)=>vt||(Dt instanceof Ie?Dt:null),null);if(Ye)return Ye}return null}class gs{constructor(Ie){this.values=Bt.fromObject({max:Ie.max,min:Ie.min})}constrain(Ie){const Ye=this.values.get("max"),vt=this.values.get("min");return Math.min(Math.max(Ie,vt),Ye)}}class Rs{constructor(Ie){this.values=Bt.fromObject({options:Ie})}get options(){return this.values.get("options")}constrain(Ie){const Ye=this.values.get("options");return Ye.length===0||Ye.filter(vt=>vt.value===Ie).length>0?Ie:Ye[0].value}}class ml{constructor(Ie){this.values=Bt.fromObject({max:Ie.max,min:Ie.min})}get maxValue(){return this.values.get("max")}get minValue(){return this.values.get("min")}constrain(Ie){const Ye=this.values.get("max"),vt=this.values.get("min");let Dt=Ie;return C(vt)||(Dt=Math.max(Dt,vt)),C(Ye)||(Dt=Math.min(Dt,Ye)),Dt}}class Js{constructor(Ie,Ye=0){this.step=Ie,this.origin=Ye}constrain(Ie){const Ye=this.origin%this.step;return Ye+Math.round((Ie-Ye)/this.step)*this.step}}const Ra=Ve("lst");class pc{constructor(Ie,Ye){this.onValueChange_=this.onValueChange_.bind(this),this.props_=Ye.props,this.element=Ie.createElement("div"),this.element.classList.add(Ra()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("select");vt.classList.add(Ra("s")),Ye.viewProps.bindDisabled(vt),this.element.appendChild(vt),this.selectElement=vt;const Dt=Ie.createElement("div");Dt.classList.add(Ra("m")),Dt.appendChild(Ln(Ie,"dropdown")),this.element.appendChild(Dt),Ye.value.emitter.on("change",this.onValueChange_),this.value_=Ye.value,ut(this.props_,"options",zt=>{_i(this.selectElement),zt.forEach(ni=>{const Di=Ie.createElement("option");Di.textContent=ni.text,this.selectElement.appendChild(Di)}),this.update_()})}update_(){const Ie=this.props_.get("options").map(Ye=>Ye.value);this.selectElement.selectedIndex=Ie.indexOf(this.value_.rawValue)}onValueChange_(){this.update_()}}class Ds{constructor(Ie,Ye){this.onSelectChange_=this.onSelectChange_.bind(this),this.props=Ye.props,this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new pc(Ie,{props:this.props,value:this.value,viewProps:this.viewProps}),this.view.selectElement.addEventListener("change",this.onSelectChange_)}onSelectChange_(Ie){const Ye=Ie.currentTarget;this.value.rawValue=this.props.get("options")[Ye.selectedIndex].value}}const gl=Ve("pop");class mc{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(gl()),Ye.viewProps.bindClassModifiers(this.element),ht(Ye.shows,_t(this.element,gl(void 0,"v")))}}class _l{constructor(Ie,Ye){this.shows=Lt(!1),this.viewProps=Ye.viewProps,this.view=new mc(Ie,{shows:this.shows,viewProps:this.viewProps})}}const vl=Ve("txt");class fc{constructor(Ie,Ye){this.onChange_=this.onChange_.bind(this),this.element=Ie.createElement("div"),this.element.classList.add(vl()),Ye.viewProps.bindClassModifiers(this.element),this.props_=Ye.props,this.props_.emitter.on("change",this.onChange_);const vt=Ie.createElement("input");vt.classList.add(vl("i")),vt.type="text",Ye.viewProps.bindDisabled(vt),this.element.appendChild(vt),this.inputElement=vt,Ye.value.emitter.on("change",this.onChange_),this.value_=Ye.value,this.refresh()}refresh(){const Ie=this.props_.get("formatter");this.inputElement.value=Ie(this.value_.rawValue)}onChange_(){this.refresh()}}class Zs{constructor(Ie,Ye){this.onInputChange_=this.onInputChange_.bind(this),this.parser_=Ye.parser,this.props=Ye.props,this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new fc(Ie,{props:Ye.props,value:this.value,viewProps:this.viewProps}),this.view.inputElement.addEventListener("change",this.onInputChange_)}onInputChange_(Ie){const Ye=Ie.currentTarget.value,vt=this.parser_(Ye);C(vt)||(this.value.rawValue=vt),this.view.refresh()}}function yl(ft){return ft!=="false"&&!!ft}function Da(ft){return function(Ie){return String(Ie)}(ft)}class gc{constructor(Ie){this.text=Ie}evaluate(){return Number(this.text)}toString(){return this.text}}const _c={"**":(ft,Ie)=>Math.pow(ft,Ie),"*":(ft,Ie)=>ft*Ie,"/":(ft,Ie)=>ft/Ie,"%":(ft,Ie)=>ft%Ie,"+":(ft,Ie)=>ft+Ie,"-":(ft,Ie)=>ft-Ie,"<<":(ft,Ie)=>ft<<Ie,">>":(ft,Ie)=>ft>>Ie,">>>":(ft,Ie)=>ft>>>Ie,"&":(ft,Ie)=>ft&Ie,"^":(ft,Ie)=>ft^Ie,"|":(ft,Ie)=>ft|Ie};class xu{constructor(Ie,Ye,vt){this.left=Ye,this.operator=Ie,this.right=vt}evaluate(){const Ie=_c[this.operator];if(!Ie)throw new Error(`unexpected binary operator: '${this.operator}`);return Ie(this.left.evaluate(),this.right.evaluate())}toString(){return["b(",this.left.toString(),this.operator,this.right.toString(),")"].join(" ")}}const yc={"+":ft=>ft,"-":ft=>-ft,"~":ft=>~ft};class Ac{constructor(Ie,Ye){this.operator=Ie,this.expression=Ye}evaluate(){const Ie=yc[this.operator];if(!Ie)throw new Error(`unexpected unary operator: '${this.operator}`);return Ie(this.expression.evaluate())}toString(){return["u(",this.operator,this.expression.toString(),")"].join(" ")}}function Ba(ft){return(Ie,Ye)=>{for(let vt=0;vt<ft.length;vt++){const Dt=ft[vt](Ie,Ye);if(Dt!=="")return Dt}return""}}function ea(ft,Ie){var Ye;const vt=ft.substr(Ie).match(/^\s+/);return(Ye=vt&&vt[0])!==null&&Ye!==void 0?Ye:""}function ta(ft,Ie){var Ye;const vt=ft.substr(Ie).match(/^[0-9]+/);return(Ye=vt&&vt[0])!==null&&Ye!==void 0?Ye:""}function Al(ft,Ie){const Ye=ft.substr(Ie,1);if(Ie+=1,Ye.toLowerCase()!=="e")return"";const vt=function(Dt,zt){const ni=ta(Dt,zt);if(ni!=="")return ni;const Di=Dt.substr(zt,1);if(Di!=="-"&&Di!=="+")return"";const rn=ta(Dt,zt+=1);return rn===""?"":Di+rn}(ft,Ie);return vt===""?"":Ye+vt}function ia(ft,Ie){const Ye=ft.substr(Ie,1);if(Ye==="0")return Ye;const vt=function(Dt,zt){const ni=Dt.substr(zt,1);return ni.match(/^[1-9]$/)?ni:""}(ft,Ie);return Ie+=vt.length,vt===""?"":vt+ta(ft,Ie)}const Oa=Ba([function(ft,Ie){const Ye=ia(ft,Ie);if(Ie+=Ye.length,Ye==="")return"";const vt=ft.substr(Ie,1);if(Ie+=vt.length,vt!==".")return"";const Dt=ta(ft,Ie);return Ye+vt+Dt+Al(ft,Ie+=Dt.length)},function(ft,Ie){const Ye=ft.substr(Ie,1);if(Ie+=Ye.length,Ye!==".")return"";const vt=ta(ft,Ie);return Ie+=vt.length,vt===""?"":Ye+vt+Al(ft,Ie)},function(ft,Ie){const Ye=ia(ft,Ie);return Ie+=Ye.length,Ye===""?"":Ye+Al(ft,Ie)}]),bl=Ba([function(ft,Ie){const Ye=ft.substr(Ie,2);if(Ie+=Ye.length,Ye.toLowerCase()!=="0b")return"";const vt=function(Dt,zt){var ni;const Di=Dt.substr(zt).match(/^[01]+/);return(ni=Di&&Di[0])!==null&&ni!==void 0?ni:""}(ft,Ie);return vt===""?"":Ye+vt},function(ft,Ie){const Ye=ft.substr(Ie,2);if(Ie+=Ye.length,Ye.toLowerCase()!=="0o")return"";const vt=function(Dt,zt){var ni;const Di=Dt.substr(zt).match(/^[0-7]+/);return(ni=Di&&Di[0])!==null&&ni!==void 0?ni:""}(ft,Ie);return vt===""?"":Ye+vt},function(ft,Ie){const Ye=ft.substr(Ie,2);if(Ie+=Ye.length,Ye.toLowerCase()!=="0x")return"";const vt=function(Dt,zt){var ni;const Di=Dt.substr(zt).match(/^[0-9a-f]+/i);return(ni=Di&&Di[0])!==null&&ni!==void 0?ni:""}(ft,Ie);return vt===""?"":Ye+vt}]),Bs=Ba([bl,Oa]);function Os(ft,Ie){var Ye;return(Ye=function(vt,Dt){const zt=Bs(vt,Dt);return Dt+=zt.length,zt===""?null:{evaluable:new gc(zt),cursor:Dt}}(ft,Ie))!==null&&Ye!==void 0?Ye:function(vt,Dt){const zt=vt.substr(Dt,1);if(Dt+=zt.length,zt!=="(")return null;const ni=xl(vt,Dt);if(!ni)return null;Dt=ni.cursor,Dt+=ea(vt,Dt).length;const Di=vt.substr(Dt,1);return Dt+=Di.length,Di!==")"?null:{evaluable:ni.evaluable,cursor:Dt}}(ft,Ie)}function La(ft,Ie,Ye){Ye+=ea(Ie,Ye).length;const vt=ft.filter(Dt=>Ie.startsWith(Dt,Ye))[0];return vt?(Ye+=vt.length,{cursor:Ye+=ea(Ie,Ye).length,operator:vt}):null}const bc=[["**"],["*","/","%"],["+","-"],["<<",">>>",">>"],["&"],["^"],["|"]].reduce((ft,Ie)=>function(Ye,vt){return(Dt,zt)=>{const ni=Ye(Dt,zt);if(!ni)return null;zt=ni.cursor;let Di=ni.evaluable;for(;;){const rn=La(vt,Dt,zt);if(!rn)break;zt=rn.cursor;const Bn=Ye(Dt,zt);if(!Bn)return null;zt=Bn.cursor,Di=new xu(rn.operator,Di,Bn.evaluable)}return Di?{cursor:zt,evaluable:Di}:null}}(ft,Ie),function ft(Ie,Ye){const vt=Os(Ie,Ye);if(vt)return vt;const Dt=Ie.substr(Ye,1);if(Ye+=Dt.length,Dt!=="+"&&Dt!=="-"&&Dt!=="~")return null;const zt=ft(Ie,Ye);return zt?{cursor:Ye=zt.cursor,evaluable:new Ac(Dt,zt.evaluable)}:null});function xl(ft,Ie){return Ie+=ea(ft,Ie).length,bc(ft,Ie)}function os(ft){var Ie;const Ye=function(vt){const Dt=xl(vt,0);return Dt?Dt.cursor+ea(vt,Dt.cursor).length!==vt.length?null:Dt.evaluable:null}(ft);return(Ie=Ye==null?void 0:Ye.evaluate())!==null&&Ie!==void 0?Ie:null}function wu(ft){if(typeof ft=="number")return ft;if(typeof ft=="string"){const Ie=os(ft);if(!C(Ie))return Ie}return 0}function rh(ft){return String(ft)}function Vr(ft){return Ie=>Ie.toFixed(Math.max(Math.min(ft,20),0))}const ss=Vr(0);function Na(ft){return ss(ft)+"%"}function xc(ft){return String(ft)}function Yo(ft){return ft}function na({primary:ft,secondary:Ie,forward:Ye,backward:vt}){let Dt=!1;function zt(ni){Dt||(Dt=!0,ni(),Dt=!1)}ft.emitter.on("change",ni=>{zt(()=>{Ie.setRawValue(Ye(ft,Ie),ni.options)})}),Ie.emitter.on("change",ni=>{zt(()=>{ft.setRawValue(vt(ft,Ie),ni.options)}),zt(()=>{Ie.setRawValue(Ye(ft,Ie),ni.options)})}),zt(()=>{Ie.setRawValue(Ye(ft,Ie),{forceEmit:!1,last:!0})})}function Cr(ft,Ie){const Ye=ft*(Ie.altKey?.1:1)*(Ie.shiftKey?10:1);return Ie.upKey?+Ye:Ie.downKey?-Ye:0}function Rr(ft){return{altKey:ft.altKey,downKey:ft.key==="ArrowDown",shiftKey:ft.shiftKey,upKey:ft.key==="ArrowUp"}}function Fr(ft){return{altKey:ft.altKey,downKey:ft.key==="ArrowLeft",shiftKey:ft.shiftKey,upKey:ft.key==="ArrowRight"}}function ka(ft){return function(Ie){return Ie==="ArrowUp"||Ie==="ArrowDown"}(ft)||ft==="ArrowLeft"||ft==="ArrowRight"}function Ls(ft,Ie){var Ye,vt;const Dt=Ie.ownerDocument.defaultView,zt=Ie.getBoundingClientRect();return{x:ft.pageX-(((Ye=Dt&&Dt.scrollX)!==null&&Ye!==void 0?Ye:0)+zt.left),y:ft.pageY-(((vt=Dt&&Dt.scrollY)!==null&&vt!==void 0?vt:0)+zt.top)}}class io{constructor(Ie){this.lastTouch_=null,this.onDocumentMouseMove_=this.onDocumentMouseMove_.bind(this),this.onDocumentMouseUp_=this.onDocumentMouseUp_.bind(this),this.onMouseDown_=this.onMouseDown_.bind(this),this.onTouchEnd_=this.onTouchEnd_.bind(this),this.onTouchMove_=this.onTouchMove_.bind(this),this.onTouchStart_=this.onTouchStart_.bind(this),this.elem_=Ie,this.emitter=new Oe,Ie.addEventListener("touchstart",this.onTouchStart_,{passive:!1}),Ie.addEventListener("touchmove",this.onTouchMove_,{passive:!0}),Ie.addEventListener("touchend",this.onTouchEnd_),Ie.addEventListener("mousedown",this.onMouseDown_)}computePosition_(Ie){const Ye=this.elem_.getBoundingClientRect();return{bounds:{width:Ye.width,height:Ye.height},point:Ie?{x:Ie.x,y:Ie.y}:null}}onMouseDown_(Ie){var Ye;Ie.preventDefault(),(Ye=Ie.currentTarget)===null||Ye===void 0||Ye.focus();const vt=this.elem_.ownerDocument;vt.addEventListener("mousemove",this.onDocumentMouseMove_),vt.addEventListener("mouseup",this.onDocumentMouseUp_),this.emitter.emit("down",{altKey:Ie.altKey,data:this.computePosition_(Ls(Ie,this.elem_)),sender:this,shiftKey:Ie.shiftKey})}onDocumentMouseMove_(Ie){this.emitter.emit("move",{altKey:Ie.altKey,data:this.computePosition_(Ls(Ie,this.elem_)),sender:this,shiftKey:Ie.shiftKey})}onDocumentMouseUp_(Ie){const Ye=this.elem_.ownerDocument;Ye.removeEventListener("mousemove",this.onDocumentMouseMove_),Ye.removeEventListener("mouseup",this.onDocumentMouseUp_),this.emitter.emit("up",{altKey:Ie.altKey,data:this.computePosition_(Ls(Ie,this.elem_)),sender:this,shiftKey:Ie.shiftKey})}onTouchStart_(Ie){Ie.preventDefault();const Ye=Ie.targetTouches.item(0),vt=this.elem_.getBoundingClientRect();this.emitter.emit("down",{altKey:Ie.altKey,data:this.computePosition_(Ye?{x:Ye.clientX-vt.left,y:Ye.clientY-vt.top}:void 0),sender:this,shiftKey:Ie.shiftKey}),this.lastTouch_=Ye}onTouchMove_(Ie){const Ye=Ie.targetTouches.item(0),vt=this.elem_.getBoundingClientRect();this.emitter.emit("move",{altKey:Ie.altKey,data:this.computePosition_(Ye?{x:Ye.clientX-vt.left,y:Ye.clientY-vt.top}:void 0),sender:this,shiftKey:Ie.shiftKey}),this.lastTouch_=Ye}onTouchEnd_(Ie){var Ye;const vt=(Ye=Ie.targetTouches.item(0))!==null&&Ye!==void 0?Ye:this.lastTouch_,Dt=this.elem_.getBoundingClientRect();this.emitter.emit("up",{altKey:Ie.altKey,data:this.computePosition_(vt?{x:vt.clientX-Dt.left,y:vt.clientY-Dt.top}:void 0),sender:this,shiftKey:Ie.shiftKey})}}function Mr(ft,Ie,Ye,vt,Dt){return vt+(ft-Ie)/(Ye-Ie)*(Dt-vt)}function Dr(ft){return String(ft.toFixed(10)).split(".")[1].replace(/0+$/,"").length}function kr(ft,Ie,Ye){return Math.min(Math.max(ft,Ie),Ye)}function ra(ft,Ie){return(ft%Ie+Ie)%Ie}const Do=Ve("txt");class wl{constructor(Ie,Ye){this.onChange_=this.onChange_.bind(this),this.props_=Ye.props,this.props_.emitter.on("change",this.onChange_),this.element=Ie.createElement("div"),this.element.classList.add(Do(),Do(void 0,"num")),Ye.arrayPosition&&this.element.classList.add(Do(void 0,Ye.arrayPosition)),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("input");vt.classList.add(Do("i")),vt.type="text",Ye.viewProps.bindDisabled(vt),this.element.appendChild(vt),this.inputElement=vt,this.onDraggingChange_=this.onDraggingChange_.bind(this),this.dragging_=Ye.dragging,this.dragging_.emitter.on("change",this.onDraggingChange_),this.element.classList.add(Do()),this.inputElement.classList.add(Do("i"));const Dt=Ie.createElement("div");Dt.classList.add(Do("k")),this.element.appendChild(Dt),this.knobElement=Dt;const zt=Ie.createElementNS(qt,"svg");zt.classList.add(Do("g")),this.knobElement.appendChild(zt);const ni=Ie.createElementNS(qt,"path");ni.classList.add(Do("gb")),zt.appendChild(ni),this.guideBodyElem_=ni;const Di=Ie.createElementNS(qt,"path");Di.classList.add(Do("gh")),zt.appendChild(Di),this.guideHeadElem_=Di;const rn=Ie.createElement("div");rn.classList.add(Ve("tt")()),this.knobElement.appendChild(rn),this.tooltipElem_=rn,Ye.value.emitter.on("change",this.onChange_),this.value=Ye.value,this.refresh()}onDraggingChange_(Ie){if(Ie.rawValue===null)return void this.element.classList.remove(Do(void 0,"drg"));this.element.classList.add(Do(void 0,"drg"));const Ye=Ie.rawValue/this.props_.get("draggingScale"),vt=Ye+(Ye>0?-1:Ye<0?1:0),Dt=kr(-vt,-4,4);this.guideHeadElem_.setAttributeNS(null,"d",[`M ${vt+Dt},0 L${vt},4 L${vt+Dt},8`,`M ${Ye},-1 L${Ye},9`].join(" ")),this.guideBodyElem_.setAttributeNS(null,"d",`M 0,4 L${Ye},4`);const zt=this.props_.get("formatter");this.tooltipElem_.textContent=zt(this.value.rawValue),this.tooltipElem_.style.left=`${Ye}px`}refresh(){const Ie=this.props_.get("formatter");this.inputElement.value=Ie(this.value.rawValue)}onChange_(){this.refresh()}}class Ua{constructor(Ie,Ye){var vt;this.originRawValue_=0,this.onInputChange_=this.onInputChange_.bind(this),this.onInputKeyDown_=this.onInputKeyDown_.bind(this),this.onInputKeyUp_=this.onInputKeyUp_.bind(this),this.onPointerDown_=this.onPointerDown_.bind(this),this.onPointerMove_=this.onPointerMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.baseStep_=Ye.baseStep,this.parser_=Ye.parser,this.props=Ye.props,this.sliderProps_=(vt=Ye.sliderProps)!==null&&vt!==void 0?vt:null,this.value=Ye.value,this.viewProps=Ye.viewProps,this.dragging_=Lt(null),this.view=new wl(Ie,{arrayPosition:Ye.arrayPosition,dragging:this.dragging_,props:this.props,value:this.value,viewProps:this.viewProps}),this.view.inputElement.addEventListener("change",this.onInputChange_),this.view.inputElement.addEventListener("keydown",this.onInputKeyDown_),this.view.inputElement.addEventListener("keyup",this.onInputKeyUp_);const Dt=new io(this.view.knobElement);Dt.emitter.on("down",this.onPointerDown_),Dt.emitter.on("move",this.onPointerMove_),Dt.emitter.on("up",this.onPointerUp_)}constrainValue_(Ie){var Ye,vt;const Dt=(Ye=this.sliderProps_)===null||Ye===void 0?void 0:Ye.get("minValue"),zt=(vt=this.sliderProps_)===null||vt===void 0?void 0:vt.get("maxValue");let ni=Ie;return Dt!==void 0&&(ni=Math.max(ni,Dt)),zt!==void 0&&(ni=Math.min(ni,zt)),ni}onInputChange_(Ie){const Ye=Ie.currentTarget.value,vt=this.parser_(Ye);C(vt)||(this.value.rawValue=this.constrainValue_(vt)),this.view.refresh()}onInputKeyDown_(Ie){const Ye=Cr(this.baseStep_,Rr(Ie));Ye!==0&&this.value.setRawValue(this.constrainValue_(this.value.rawValue+Ye),{forceEmit:!1,last:!1})}onInputKeyUp_(Ie){Cr(this.baseStep_,Rr(Ie))!==0&&this.value.setRawValue(this.value.rawValue,{forceEmit:!0,last:!0})}onPointerDown_(){this.originRawValue_=this.value.rawValue,this.dragging_.rawValue=0}computeDraggingValue_(Ie){if(!Ie.point)return null;const Ye=Ie.point.x-Ie.bounds.width/2;return this.constrainValue_(this.originRawValue_+Ye*this.props.get("draggingScale"))}onPointerMove_(Ie){const Ye=this.computeDraggingValue_(Ie.data);Ye!==null&&(this.value.setRawValue(Ye,{forceEmit:!1,last:!1}),this.dragging_.rawValue=this.value.rawValue-this.originRawValue_)}onPointerUp_(Ie){const Ye=this.computeDraggingValue_(Ie.data);Ye!==null&&(this.value.setRawValue(Ye,{forceEmit:!0,last:!0}),this.dragging_.rawValue=null)}}const wc=Ve("sld");class oh{constructor(Ie,Ye){this.onChange_=this.onChange_.bind(this),this.props_=Ye.props,this.props_.emitter.on("change",this.onChange_),this.element=Ie.createElement("div"),this.element.classList.add(wc()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("div");vt.classList.add(wc("t")),Ye.viewProps.bindTabIndex(vt),this.element.appendChild(vt),this.trackElement=vt;const Dt=Ie.createElement("div");Dt.classList.add(wc("k")),this.trackElement.appendChild(Dt),this.knobElement=Dt,Ye.value.emitter.on("change",this.onChange_),this.value=Ye.value,this.update_()}update_(){const Ie=kr(Mr(this.value.rawValue,this.props_.get("minValue"),this.props_.get("maxValue"),0,100),0,100);this.knobElement.style.width=`${Ie}%`}onChange_(){this.update_()}}class sh{constructor(Ie,Ye){this.onKeyDown_=this.onKeyDown_.bind(this),this.onKeyUp_=this.onKeyUp_.bind(this),this.onPointerDownOrMove_=this.onPointerDownOrMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.baseStep_=Ye.baseStep,this.value=Ye.value,this.viewProps=Ye.viewProps,this.props=Ye.props,this.view=new oh(Ie,{props:this.props,value:this.value,viewProps:this.viewProps}),this.ptHandler_=new io(this.view.trackElement),this.ptHandler_.emitter.on("down",this.onPointerDownOrMove_),this.ptHandler_.emitter.on("move",this.onPointerDownOrMove_),this.ptHandler_.emitter.on("up",this.onPointerUp_),this.view.trackElement.addEventListener("keydown",this.onKeyDown_),this.view.trackElement.addEventListener("keyup",this.onKeyUp_)}handlePointerEvent_(Ie,Ye){Ie.point&&this.value.setRawValue(Mr(kr(Ie.point.x,0,Ie.bounds.width),0,Ie.bounds.width,this.props.get("minValue"),this.props.get("maxValue")),Ye)}onPointerDownOrMove_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerUp_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!0,last:!0})}onKeyDown_(Ie){const Ye=Cr(this.baseStep_,Fr(Ie));Ye!==0&&this.value.setRawValue(this.value.rawValue+Ye,{forceEmit:!1,last:!1})}onKeyUp_(Ie){Cr(this.baseStep_,Fr(Ie))!==0&&this.value.setRawValue(this.value.rawValue,{forceEmit:!0,last:!0})}}const Ec=Ve("sldtxt");class ah{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(Ec());const vt=Ie.createElement("div");vt.classList.add(Ec("s")),this.sliderView_=Ye.sliderView,vt.appendChild(this.sliderView_.element),this.element.appendChild(vt);const Dt=Ie.createElement("div");Dt.classList.add(Ec("t")),this.textView_=Ye.textView,Dt.appendChild(this.textView_.element),this.element.appendChild(Dt)}}class Sc{constructor(Ie,Ye){this.value=Ye.value,this.viewProps=Ye.viewProps,this.sliderC_=new sh(Ie,{baseStep:Ye.baseStep,props:Ye.sliderProps,value:Ye.value,viewProps:this.viewProps}),this.textC_=new Ua(Ie,{baseStep:Ye.baseStep,parser:Ye.parser,props:Ye.textProps,sliderProps:Ye.sliderProps,value:Ye.value,viewProps:Ye.viewProps}),this.view=new ah(Ie,{sliderView:this.sliderC_.view,textView:this.textC_.view})}get sliderController(){return this.sliderC_}get textController(){return this.textC_}}function Fa(ft,Ie){ft.write(Ie)}function El(ft){const Ie=Vt;return Array.isArray(ft)?Ie.required.array(Ie.required.object({text:Ie.required.string,value:Ie.required.raw}))(ft).value:typeof ft=="object"?Ie.required.raw(ft).value:void 0}function Eu(ft){if(ft==="inline"||ft==="popup")return ft}function _s(ft){const Ie=Vt;return Ie.required.object({max:Ie.optional.number,min:Ie.optional.number,step:Ie.optional.number})(ft).value}function Su(ft){if(Array.isArray(ft))return ft;const Ie=[];return Object.keys(ft).forEach(Ye=>{Ie.push({text:Ye,value:ft[Ye]})}),Ie}function Tc(ft){return C(ft)?null:new Rs(Su(ft))}function ja(ft,Ie){const Ye=ft&&Fo(ft,Js);return Ye?Dr(Ye.step):Math.max(Dr(Ie),2)}function Ns(ft){const Ie=function(Ye){const vt=Ye?Fo(Ye,Js):null;return vt?vt.step:null}(ft);return Ie??1}function ks(ft,Ie){var Ye;const vt=ft&&Fo(ft,Js),Dt=Math.abs((Ye=vt==null?void 0:vt.step)!==null&&Ye!==void 0?Ye:Ie);return Dt===0?.1:Math.pow(10,Math.floor(Math.log10(Dt))-1)}const Ga=Ve("ckb");class Tu{constructor(Ie,Ye){this.onValueChange_=this.onValueChange_.bind(this),this.element=Ie.createElement("div"),this.element.classList.add(Ga()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("label");vt.classList.add(Ga("l")),this.element.appendChild(vt);const Dt=Ie.createElement("input");Dt.classList.add(Ga("i")),Dt.type="checkbox",vt.appendChild(Dt),this.inputElement=Dt,Ye.viewProps.bindDisabled(this.inputElement);const zt=Ie.createElement("div");zt.classList.add(Ga("w")),vt.appendChild(zt);const ni=Ln(Ie,"check");zt.appendChild(ni),Ye.value.emitter.on("change",this.onValueChange_),this.value=Ye.value,this.update_()}update_(){this.inputElement.checked=this.value.rawValue}onValueChange_(){this.update_()}}class Cu{constructor(Ie,Ye){this.onInputChange_=this.onInputChange_.bind(this),this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new Tu(Ie,{value:this.value,viewProps:this.viewProps}),this.view.inputElement.addEventListener("change",this.onInputChange_)}onInputChange_(Ie){const Ye=Ie.currentTarget;this.value.rawValue=Ye.checked}}const Mu={id:"input-bool",type:"input",accept:(ft,Ie)=>{if(typeof ft!="boolean")return null;const Ye=si(Ie,{options:Vt.optional.custom(El)});return Ye?{initialValue:ft,params:Ye}:null},binding:{reader:ft=>yl,constraint:ft=>function(Ie){const Ye=[],vt=Tc(Ie.options);return vt&&Ye.push(vt),new Is(Ye)}(ft.params),writer:ft=>Fa},controller:ft=>{const Ie=ft.document,Ye=ft.value,vt=ft.constraint,Dt=vt&&Fo(vt,Rs);return Dt?new Ds(Ie,{props:new Bt({options:Dt.values.value("options")}),value:Ye,viewProps:ft.viewProps}):new Cu(Ie,{value:Ye,viewProps:ft.viewProps})}},vs=Ve("col");class Pu{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(vs()),Ye.foldable.bindExpandedClass(this.element,vs(void 0,"expanded")),ut(Ye.foldable,"completed",_t(this.element,vs(void 0,"cpl")));const vt=Ie.createElement("div");vt.classList.add(vs("h")),this.element.appendChild(vt);const Dt=Ie.createElement("div");Dt.classList.add(vs("s")),vt.appendChild(Dt),this.swatchElement=Dt;const zt=Ie.createElement("div");if(zt.classList.add(vs("t")),vt.appendChild(zt),this.textElement=zt,Ye.pickerLayout==="inline"){const ni=Ie.createElement("div");ni.classList.add(vs("p")),this.element.appendChild(ni),this.pickerElement=ni}else this.pickerElement=null}}function oa(ft,Ie,Ye){const vt=ra(ft,360),Dt=kr(Ie/100,0,1),zt=kr(Ye/100,0,1),ni=zt*Dt,Di=ni*(1-Math.abs(vt/60%2-1)),rn=zt-ni;let Bn,tr,Wr;return[Bn,tr,Wr]=vt>=0&&vt<60?[ni,Di,0]:vt>=60&&vt<120?[Di,ni,0]:vt>=120&&vt<180?[0,ni,Di]:vt>=180&&vt<240?[0,Di,ni]:vt>=240&&vt<300?[Di,0,ni]:[ni,0,Di],[255*(Bn+rn),255*(tr+rn),255*(Wr+rn)]}function Us(ft){return[ft[0],ft[1],ft[2]]}function Iu(ft,Ie){return[ft[0],ft[1],ft[2],Ie]}const lh={hsl:{hsl:(ft,Ie,Ye)=>[ft,Ie,Ye],hsv:function(ft,Ie,Ye){const vt=Ye+Ie*(100-Math.abs(2*Ye-100))/200;return[ft,vt!==0?Ie*(100-Math.abs(2*Ye-100))/vt:0,Ye+Ie*(100-Math.abs(2*Ye-100))/200]},rgb:function(ft,Ie,Ye){const vt=(ft%360+360)%360,Dt=kr(Ie/100,0,1),zt=kr(Ye/100,0,1),ni=(1-Math.abs(2*zt-1))*Dt,Di=ni*(1-Math.abs(vt/60%2-1)),rn=zt-ni/2;let Bn,tr,Wr;return[Bn,tr,Wr]=vt>=0&&vt<60?[ni,Di,0]:vt>=60&&vt<120?[Di,ni,0]:vt>=120&&vt<180?[0,ni,Di]:vt>=180&&vt<240?[0,Di,ni]:vt>=240&&vt<300?[Di,0,ni]:[ni,0,Di],[255*(Bn+rn),255*(tr+rn),255*(Wr+rn)]}},hsv:{hsl:function(ft,Ie,Ye){const vt=100-Math.abs(Ye*(200-Ie)/100-100);return[ft,vt!==0?Ie*Ye/vt:0,Ye*(200-Ie)/200]},hsv:(ft,Ie,Ye)=>[ft,Ie,Ye],rgb:oa},rgb:{hsl:function(ft,Ie,Ye){const vt=kr(ft/255,0,1),Dt=kr(Ie/255,0,1),zt=kr(Ye/255,0,1),ni=Math.max(vt,Dt,zt),Di=Math.min(vt,Dt,zt),rn=ni-Di;let Bn=0,tr=0;const Wr=(Di+ni)/2;return rn!==0&&(tr=rn/(1-Math.abs(ni+Di-1)),Bn=vt===ni?(Dt-zt)/rn:Dt===ni?2+(zt-vt)/rn:4+(vt-Dt)/rn,Bn=Bn/6+(Bn<0?1:0)),[360*Bn,100*tr,100*Wr]},hsv:function(ft,Ie,Ye){const vt=kr(ft/255,0,1),Dt=kr(Ie/255,0,1),zt=kr(Ye/255,0,1),ni=Math.max(vt,Dt,zt),Di=ni-Math.min(vt,Dt,zt);let rn;return rn=Di===0?0:ni===vt?((Dt-zt)/Di%6+6)%6*60:ni===Dt?60*((zt-vt)/Di+2):60*((vt-Dt)/Di+4),[rn,100*(ni===0?0:Di/ni),100*ni]},rgb:(ft,Ie,Ye)=>[ft,Ie,Ye]}};function Sl(ft,Ie){return[Ie==="float"?1:ft==="rgb"?255:360,Ie==="float"?1:ft==="rgb"?255:100,Ie==="float"?1:ft==="rgb"?255:100]}function uh(ft,Ie){return ft===Ie?Ie:ra(ft,Ie)}function Ru(ft,Ie,Ye,vt){const Dt=Sl(Ie,Ye),zt=Sl(Ie,vt);return ft.map((ni,Di)=>ni/Dt[Di]*zt[Di])}function Tl(ft,Ie){return typeof ft=="object"&&!C(ft)&&Ie in ft&&typeof ft[Ie]=="number"}class ur{static black(Ie="int"){return new ur([0,0,0],"rgb",Ie)}static fromObject(Ie,Ye="int"){const vt="a"in Ie?[Ie.r,Ie.g,Ie.b,Ie.a]:[Ie.r,Ie.g,Ie.b];return new ur(vt,"rgb",Ye)}static toRgbaObject(Ie,Ye="int"){return Ie.toRgbaObject(Ye)}static isRgbColorObject(Ie){return Tl(Ie,"r")&&Tl(Ie,"g")&&Tl(Ie,"b")}static isRgbaColorObject(Ie){return this.isRgbColorObject(Ie)&&Tl(Ie,"a")}static isColorObject(Ie){return this.isRgbColorObject(Ie)}static equals(Ie,Ye){if(Ie.mode!==Ye.mode)return!1;const vt=Ie.comps_,Dt=Ye.comps_;for(let zt=0;zt<vt.length;zt++)if(vt[zt]!==Dt[zt])return!1;return!0}constructor(Ie,Ye,vt="int"){this.mode=Ye,this.type=vt,this.comps_=function(Dt,zt,ni){var Di;const rn=Sl(zt,ni);return[zt==="rgb"?kr(Dt[0],0,rn[0]):uh(Dt[0],rn[0]),kr(Dt[1],0,rn[1]),kr(Dt[2],0,rn[2]),kr((Di=Dt[3])!==null&&Di!==void 0?Di:1,0,1)]}(Ie,Ye,vt)}getComponents(Ie,Ye="int"){return Iu(function(vt,Dt,zt){const ni=Ru(vt,Dt.mode,Dt.type,"int");return Ru(lh[Dt.mode][zt.mode](...ni),zt.mode,"int",zt.type)}(Us(this.comps_),{mode:this.mode,type:this.type},{mode:Ie??this.mode,type:Ye}),this.comps_[3])}toRgbaObject(Ie="int"){const Ye=this.getComponents("rgb",Ie);return{r:Ye[0],g:Ye[1],b:Ye[2],a:Ye[3]}}}const ys=Ve("colp");class Cc{constructor(Ie,Ye){this.alphaViews_=null,this.element=Ie.createElement("div"),this.element.classList.add(ys()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("div");vt.classList.add(ys("hsv"));const Dt=Ie.createElement("div");Dt.classList.add(ys("sv")),this.svPaletteView_=Ye.svPaletteView,Dt.appendChild(this.svPaletteView_.element),vt.appendChild(Dt);const zt=Ie.createElement("div");zt.classList.add(ys("h")),this.hPaletteView_=Ye.hPaletteView,zt.appendChild(this.hPaletteView_.element),vt.appendChild(zt),this.element.appendChild(vt);const ni=Ie.createElement("div");if(ni.classList.add(ys("rgb")),this.textView_=Ye.textView,ni.appendChild(this.textView_.element),this.element.appendChild(ni),Ye.alphaViews){this.alphaViews_={palette:Ye.alphaViews.palette,text:Ye.alphaViews.text};const Di=Ie.createElement("div");Di.classList.add(ys("a"));const rn=Ie.createElement("div");rn.classList.add(ys("ap")),rn.appendChild(this.alphaViews_.palette.element),Di.appendChild(rn);const Bn=Ie.createElement("div");Bn.classList.add(ys("at")),Bn.appendChild(this.alphaViews_.text.element),Di.appendChild(Bn),this.element.appendChild(Di)}}get allFocusableElements(){const Ie=[this.svPaletteView_.element,this.hPaletteView_.element,this.textView_.modeSelectElement,...this.textView_.textViews.map(Ye=>Ye.inputElement)];return this.alphaViews_&&Ie.push(this.alphaViews_.palette.element,this.alphaViews_.text.inputElement),Ie}}function Cl(ft){return ft==="int"?"int":ft==="float"?"float":void 0}function Bo(ft){const Ie=Vt;return si(ft,{alpha:Ie.optional.boolean,color:Ie.optional.object({alpha:Ie.optional.boolean,type:Ie.optional.custom(Cl)}),expanded:Ie.optional.boolean,picker:Ie.optional.custom(Eu)})}function jo(ft){return ft?.1:1}function ho(ft){var Ie;return(Ie=ft.color)===null||Ie===void 0?void 0:Ie.type}function Br(ft,Ie){const Ye=ft.match(/^(.+)%$/);return Math.min(Ye?.01*parseFloat(Ye[1])*Ie:parseFloat(ft),Ie)}const Du={deg:ft=>ft,grad:ft=>360*ft/400,rad:ft=>360*ft/(2*Math.PI),turn:ft=>360*ft};function As(ft){const Ie=ft.match(/^([0-9.]+?)(deg|grad|rad|turn)$/);if(!Ie)return parseFloat(ft);const Ye=parseFloat(Ie[1]),vt=Ie[2];return Du[vt](Ye)}function Fs(ft){const Ie=ft.match(/^rgb\(\s*([0-9A-Fa-f.]+%?)\s*,\s*([0-9A-Fa-f.]+%?)\s*,\s*([0-9A-Fa-f.]+%?)\s*\)$/);if(!Ie)return null;const Ye=[Br(Ie[1],255),Br(Ie[2],255),Br(Ie[3],255)];return isNaN(Ye[0])||isNaN(Ye[1])||isNaN(Ye[2])?null:Ye}function vo(ft){return Ie=>{const Ye=Fs(Ie);return Ye?new ur(Ye,"rgb",ft):null}}function Ur(ft){const Ie=ft.match(/^rgba\(\s*([0-9A-Fa-f.]+%?)\s*,\s*([0-9A-Fa-f.]+%?)\s*,\s*([0-9A-Fa-f.]+%?)\s*,\s*([0-9A-Fa-f.]+%?)\s*\)$/);if(!Ie)return null;const Ye=[Br(Ie[1],255),Br(Ie[2],255),Br(Ie[3],255),Br(Ie[4],1)];return isNaN(Ye[0])||isNaN(Ye[1])||isNaN(Ye[2])||isNaN(Ye[3])?null:Ye}function Ml(ft){return Ie=>{const Ye=Ur(Ie);return Ye?new ur(Ye,"rgb",ft):null}}function sa(ft){const Ie=ft.match(/^hsl\(\s*([0-9A-Fa-f.]+(?:deg|grad|rad|turn)?)\s*,\s*([0-9A-Fa-f.]+%?)\s*,\s*([0-9A-Fa-f.]+%?)\s*\)$/);if(!Ie)return null;const Ye=[As(Ie[1]),Br(Ie[2],100),Br(Ie[3],100)];return isNaN(Ye[0])||isNaN(Ye[1])||isNaN(Ye[2])?null:Ye}function Pl(ft){return Ie=>{const Ye=sa(Ie);return Ye?new ur(Ye,"hsl",ft):null}}function Mc(ft){const Ie=ft.match(/^hsla\(\s*([0-9A-Fa-f.]+(?:deg|grad|rad|turn)?)\s*,\s*([0-9A-Fa-f.]+%?)\s*,\s*([0-9A-Fa-f.]+%?)\s*,\s*([0-9A-Fa-f.]+%?)\s*\)$/);if(!Ie)return null;const Ye=[As(Ie[1]),Br(Ie[2],100),Br(Ie[3],100),Br(Ie[4],1)];return isNaN(Ye[0])||isNaN(Ye[1])||isNaN(Ye[2])||isNaN(Ye[3])?null:Ye}function za(ft){return Ie=>{const Ye=Mc(Ie);return Ye?new ur(Ye,"hsl",ft):null}}function po(ft){const Ie=ft.match(/^#([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])$/);if(Ie)return[parseInt(Ie[1]+Ie[1],16),parseInt(Ie[2]+Ie[2],16),parseInt(Ie[3]+Ie[3],16)];const Ye=ft.match(/^(?:#|0x)([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})$/);return Ye?[parseInt(Ye[1],16),parseInt(Ye[2],16),parseInt(Ye[3],16)]:null}function $n(ft){const Ie=ft.match(/^#?([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])([0-9A-Fa-f])$/);if(Ie)return[parseInt(Ie[1]+Ie[1],16),parseInt(Ie[2]+Ie[2],16),parseInt(Ie[3]+Ie[3],16),Mr(parseInt(Ie[4]+Ie[4],16),0,255,0,1)];const Ye=ft.match(/^(?:#|0x)?([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})$/);return Ye?[parseInt(Ye[1],16),parseInt(Ye[2],16),parseInt(Ye[3],16),Mr(parseInt(Ye[4],16),0,255,0,1)]:null}function Bu(ft){const Ie=ft.match(/^\{\s*r\s*:\s*([0-9A-Fa-f.]+%?)\s*,\s*g\s*:\s*([0-9A-Fa-f.]+%?)\s*,\s*b\s*:\s*([0-9A-Fa-f.]+%?)\s*\}$/);if(!Ie)return null;const Ye=[parseFloat(Ie[1]),parseFloat(Ie[2]),parseFloat(Ie[3])];return isNaN(Ye[0])||isNaN(Ye[1])||isNaN(Ye[2])?null:Ye}function en(ft){return Ie=>{const Ye=Bu(Ie);return Ye?new ur(Ye,"rgb",ft):null}}function er(ft){const Ie=ft.match(/^\{\s*r\s*:\s*([0-9A-Fa-f.]+%?)\s*,\s*g\s*:\s*([0-9A-Fa-f.]+%?)\s*,\s*b\s*:\s*([0-9A-Fa-f.]+%?)\s*,\s*a\s*:\s*([0-9A-Fa-f.]+%?)\s*\}$/);if(!Ie)return null;const Ye=[parseFloat(Ie[1]),parseFloat(Ie[2]),parseFloat(Ie[3]),parseFloat(Ie[4])];return isNaN(Ye[0])||isNaN(Ye[1])||isNaN(Ye[2])||isNaN(Ye[3])?null:Ye}function Il(ft){return Ie=>{const Ye=er(Ie);return Ye?new ur(Ye,"rgb",ft):null}}const Ou=[{parser:po,result:{alpha:!1,mode:"rgb",notation:"hex"}},{parser:$n,result:{alpha:!0,mode:"rgb",notation:"hex"}},{parser:Fs,result:{alpha:!1,mode:"rgb",notation:"func"}},{parser:Ur,result:{alpha:!0,mode:"rgb",notation:"func"}},{parser:sa,result:{alpha:!1,mode:"hsl",notation:"func"}},{parser:Mc,result:{alpha:!0,mode:"hsl",notation:"func"}},{parser:Bu,result:{alpha:!1,mode:"rgb",notation:"object"}},{parser:er,result:{alpha:!0,mode:"rgb",notation:"object"}}];function Pc(ft,Ie="int"){const Ye=function(vt){return Ou.reduce((Dt,{parser:zt,result:ni})=>Dt||(zt(vt)?ni:null),null)}(ft);return Ye?Ye.notation==="hex"&&Ie!=="float"?Object.assign(Object.assign({},Ye),{type:"int"}):Ye.notation==="func"?Object.assign(Object.assign({},Ye),{type:Ie}):null:null}const js={int:[function(ft){const Ie=po(ft);return Ie?new ur(Ie,"rgb","int"):null},function(ft){const Ie=$n(ft);return Ie?new ur(Ie,"rgb","int"):null},vo("int"),Ml("int"),Pl("int"),za("int"),en("int"),Il("int")],float:[vo("float"),Ml("float"),Pl("float"),za("float"),en("float"),Il("float")]};function Gs(ft){const Ie=js[ft];return Ye=>Ie.reduce((vt,Dt)=>vt||Dt(Ye),null)}function Ic(ft){const Ie=kr(Math.floor(ft),0,255).toString(16);return Ie.length===1?`0${Ie}`:Ie}function Rc(ft,Ie="#"){return`${Ie}${Us(ft.getComponents("rgb")).map(Ic).join("")}`}function zs(ft,Ie="#"){const Ye=ft.getComponents("rgb");return`${Ie}${[Ye[0],Ye[1],Ye[2],255*Ye[3]].map(Ic).join("")}`}function Dc(ft,Ie){const Ye=Vr(Ie==="float"?2:0);return`rgb(${Us(ft.getComponents("rgb",Ie)).map(vt=>Ye(vt)).join(", ")})`}function Lu(ft){return Ie=>Dc(Ie,ft)}function Vs(ft,Ie){const Ye=Vr(2),vt=Vr(Ie==="float"?2:0);return`rgba(${ft.getComponents("rgb",Ie).map((Dt,zt)=>(zt===3?Ye:vt)(Dt)).join(", ")})`}function dh(ft){return Ie=>Vs(Ie,ft)}function Sr(ft,Ie){const Ye=Vr(Ie==="float"?2:0),vt=["r","g","b"];return`{${Us(ft.getComponents("rgb",Ie)).map((Dt,zt)=>`${vt[zt]}: ${Ye(Dt)}`).join(", ")}}`}function aa(ft){return Ie=>Sr(Ie,ft)}function Rl(ft,Ie){const Ye=Vr(2),vt=Vr(Ie==="float"?2:0),Dt=["r","g","b","a"];return`{${ft.getComponents("rgb",Ie).map((zt,ni)=>`${Dt[ni]}: ${(ni===3?Ye:vt)(zt)}`).join(", ")}}`}function la(ft){return Ie=>Rl(Ie,ft)}const Bc=[{format:{alpha:!1,mode:"rgb",notation:"hex",type:"int"},stringifier:Rc},{format:{alpha:!0,mode:"rgb",notation:"hex",type:"int"},stringifier:zs},{format:{alpha:!1,mode:"hsl",notation:"func",type:"int"},stringifier:function(ft){const Ie=[Vr(0),Na,Na];return`hsl(${Us(ft.getComponents("hsl")).map((Ye,vt)=>Ie[vt](Ye)).join(", ")})`}},{format:{alpha:!0,mode:"hsl",notation:"func",type:"int"},stringifier:function(ft){const Ie=[Vr(0),Na,Na,Vr(2)];return`hsla(${ft.getComponents("hsl").map((Ye,vt)=>Ie[vt](Ye)).join(", ")})`}},...["int","float"].reduce((ft,Ie)=>[...ft,{format:{alpha:!1,mode:"rgb",notation:"func",type:Ie},stringifier:Lu(Ie)},{format:{alpha:!0,mode:"rgb",notation:"func",type:Ie},stringifier:dh(Ie)},{format:{alpha:!1,mode:"rgb",notation:"object",type:Ie},stringifier:aa(Ie)},{format:{alpha:!0,mode:"rgb",notation:"object",type:Ie},stringifier:la(Ie)}],[])];function Oc(ft){return Bc.reduce((Ie,Ye)=>{return Ie||(vt=Ye.format,Dt=ft,vt.alpha===Dt.alpha&&vt.mode===Dt.mode&&vt.notation===Dt.notation&&vt.type===Dt.type?Ye.stringifier:null);var vt,Dt},null)}const Go=Ve("apl");class Lc{constructor(Ie,Ye){this.onValueChange_=this.onValueChange_.bind(this),this.value=Ye.value,this.value.emitter.on("change",this.onValueChange_),this.element=Ie.createElement("div"),this.element.classList.add(Go()),Ye.viewProps.bindClassModifiers(this.element),Ye.viewProps.bindTabIndex(this.element);const vt=Ie.createElement("div");vt.classList.add(Go("b")),this.element.appendChild(vt);const Dt=Ie.createElement("div");Dt.classList.add(Go("c")),vt.appendChild(Dt),this.colorElem_=Dt;const zt=Ie.createElement("div");zt.classList.add(Go("m")),this.element.appendChild(zt),this.markerElem_=zt;const ni=Ie.createElement("div");ni.classList.add(Go("p")),this.markerElem_.appendChild(ni),this.previewElem_=ni,this.update_()}update_(){const Ie=this.value.rawValue,Ye=Ie.getComponents("rgb"),vt=new ur([Ye[0],Ye[1],Ye[2],0],"rgb"),Dt=new ur([Ye[0],Ye[1],Ye[2],255],"rgb"),zt=["to right",Vs(vt),Vs(Dt)];this.colorElem_.style.background=`linear-gradient(${zt.join(",")})`,this.previewElem_.style.backgroundColor=Vs(Ie);const ni=Mr(Ye[3],0,1,0,100);this.markerElem_.style.left=`${ni}%`}onValueChange_(){this.update_()}}class hh{constructor(Ie,Ye){this.onKeyDown_=this.onKeyDown_.bind(this),this.onKeyUp_=this.onKeyUp_.bind(this),this.onPointerDown_=this.onPointerDown_.bind(this),this.onPointerMove_=this.onPointerMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new Lc(Ie,{value:this.value,viewProps:this.viewProps}),this.ptHandler_=new io(this.view.element),this.ptHandler_.emitter.on("down",this.onPointerDown_),this.ptHandler_.emitter.on("move",this.onPointerMove_),this.ptHandler_.emitter.on("up",this.onPointerUp_),this.view.element.addEventListener("keydown",this.onKeyDown_),this.view.element.addEventListener("keyup",this.onKeyUp_)}handlePointerEvent_(Ie,Ye){if(!Ie.point)return;const vt=Ie.point.x/Ie.bounds.width,Dt=this.value.rawValue,[zt,ni,Di]=Dt.getComponents("hsv");this.value.setRawValue(new ur([zt,ni,Di,vt],"hsv"),Ye)}onPointerDown_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerMove_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerUp_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!0,last:!0})}onKeyDown_(Ie){const Ye=Cr(jo(!0),Fr(Ie));if(Ye===0)return;const vt=this.value.rawValue,[Dt,zt,ni,Di]=vt.getComponents("hsv");this.value.setRawValue(new ur([Dt,zt,ni,Di+Ye],"hsv"),{forceEmit:!1,last:!1})}onKeyUp_(Ie){Cr(jo(!0),Fr(Ie))!==0&&this.value.setRawValue(this.value.rawValue,{forceEmit:!0,last:!0})}}const Or=Ve("coltxt");class Tr{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(Or()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("div");vt.classList.add(Or("m")),this.modeElem_=function(ni){const Di=ni.createElement("select");return Di.appendChild([{text:"RGB",value:"rgb"},{text:"HSL",value:"hsl"},{text:"HSV",value:"hsv"}].reduce((rn,Bn)=>{const tr=ni.createElement("option");return tr.textContent=Bn.text,tr.value=Bn.value,rn.appendChild(tr),rn},ni.createDocumentFragment())),Di}(Ie),this.modeElem_.classList.add(Or("ms")),vt.appendChild(this.modeSelectElement),Ye.viewProps.bindDisabled(this.modeElem_);const Dt=Ie.createElement("div");Dt.classList.add(Or("mm")),Dt.appendChild(Ln(Ie,"dropdown")),vt.appendChild(Dt),this.element.appendChild(vt);const zt=Ie.createElement("div");zt.classList.add(Or("w")),this.element.appendChild(zt),this.textsElem_=zt,this.textViews_=Ye.textViews,this.applyTextViews_(),ht(Ye.colorMode,ni=>{this.modeElem_.value=ni})}get modeSelectElement(){return this.modeElem_}get textViews(){return this.textViews_}set textViews(Ie){this.textViews_=Ie,this.applyTextViews_()}applyTextViews_(){_i(this.textsElem_);const Ie=this.element.ownerDocument;this.textViews_.forEach(Ye=>{const vt=Ie.createElement("div");vt.classList.add(Or("c")),vt.appendChild(Ye.element),this.textsElem_.appendChild(vt)})}}function Nu(ft,Ie,Ye){const vt=Sl(ft,Ie)[Ye];return new gs({min:0,max:vt})}function yo(ft,Ie,Ye){return new Ua(ft,{arrayPosition:Ye===0?"fst":Ye===2?"lst":"mid",baseStep:jo(!1),parser:Ie.parser,props:Bt.fromObject({draggingScale:Ie.colorType==="float"?.01:1,formatter:(vt=Ie.colorType,Vr(vt==="float"?2:0))}),value:Lt(0,{constraint:Nu(Ie.colorMode,Ie.colorType,Ye)}),viewProps:Ie.viewProps});var vt}class Dl{constructor(Ie,Ye){this.onModeSelectChange_=this.onModeSelectChange_.bind(this),this.colorType_=Ye.colorType,this.parser_=Ye.parser,this.value=Ye.value,this.viewProps=Ye.viewProps,this.colorMode=Lt(this.value.rawValue.mode),this.ccs_=this.createComponentControllers_(Ie),this.view=new Tr(Ie,{colorMode:this.colorMode,textViews:[this.ccs_[0].view,this.ccs_[1].view,this.ccs_[2].view],viewProps:this.viewProps}),this.view.modeSelectElement.addEventListener("change",this.onModeSelectChange_)}createComponentControllers_(Ie){const Ye={colorMode:this.colorMode.rawValue,colorType:this.colorType_,parser:this.parser_,viewProps:this.viewProps},vt=[yo(Ie,Ye,0),yo(Ie,Ye,1),yo(Ie,Ye,2)];return vt.forEach((Dt,zt)=>{na({primary:this.value,secondary:Dt.value,forward:ni=>ni.rawValue.getComponents(this.colorMode.rawValue,this.colorType_)[zt],backward:(ni,Di)=>{const rn=this.colorMode.rawValue,Bn=ni.rawValue.getComponents(rn,this.colorType_);return Bn[zt]=Di.rawValue,new ur(Iu(Us(Bn),Bn[3]),rn,this.colorType_)}})}),vt}onModeSelectChange_(Ie){const Ye=Ie.currentTarget;this.colorMode.rawValue=Ye.value,this.ccs_=this.createComponentControllers_(this.view.element.ownerDocument),this.view.textViews=[this.ccs_[0].view,this.ccs_[1].view,this.ccs_[2].view]}}const Nc=Ve("hpl");class kc{constructor(Ie,Ye){this.onValueChange_=this.onValueChange_.bind(this),this.value=Ye.value,this.value.emitter.on("change",this.onValueChange_),this.element=Ie.createElement("div"),this.element.classList.add(Nc()),Ye.viewProps.bindClassModifiers(this.element),Ye.viewProps.bindTabIndex(this.element);const vt=Ie.createElement("div");vt.classList.add(Nc("c")),this.element.appendChild(vt);const Dt=Ie.createElement("div");Dt.classList.add(Nc("m")),this.element.appendChild(Dt),this.markerElem_=Dt,this.update_()}update_(){const Ie=this.value.rawValue,[Ye]=Ie.getComponents("hsv");this.markerElem_.style.backgroundColor=Dc(new ur([Ye,100,100],"hsv"));const vt=Mr(Ye,0,360,0,100);this.markerElem_.style.left=`${vt}%`}onValueChange_(){this.update_()}}class ph{constructor(Ie,Ye){this.onKeyDown_=this.onKeyDown_.bind(this),this.onKeyUp_=this.onKeyUp_.bind(this),this.onPointerDown_=this.onPointerDown_.bind(this),this.onPointerMove_=this.onPointerMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new kc(Ie,{value:this.value,viewProps:this.viewProps}),this.ptHandler_=new io(this.view.element),this.ptHandler_.emitter.on("down",this.onPointerDown_),this.ptHandler_.emitter.on("move",this.onPointerMove_),this.ptHandler_.emitter.on("up",this.onPointerUp_),this.view.element.addEventListener("keydown",this.onKeyDown_),this.view.element.addEventListener("keyup",this.onKeyUp_)}handlePointerEvent_(Ie,Ye){if(!Ie.point)return;const vt=Mr(kr(Ie.point.x,0,Ie.bounds.width),0,Ie.bounds.width,0,360),Dt=this.value.rawValue,[,zt,ni,Di]=Dt.getComponents("hsv");this.value.setRawValue(new ur([vt,zt,ni,Di],"hsv"),Ye)}onPointerDown_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerMove_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerUp_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!0,last:!0})}onKeyDown_(Ie){const Ye=Cr(jo(!1),Fr(Ie));if(Ye===0)return;const vt=this.value.rawValue,[Dt,zt,ni,Di]=vt.getComponents("hsv");this.value.setRawValue(new ur([Dt+Ye,zt,ni,Di],"hsv"),{forceEmit:!1,last:!1})}onKeyUp_(Ie){Cr(jo(!1),Fr(Ie))!==0&&this.value.setRawValue(this.value.rawValue,{forceEmit:!0,last:!0})}}const Uc=Ve("svp");class Ao{constructor(Ie,Ye){this.onValueChange_=this.onValueChange_.bind(this),this.value=Ye.value,this.value.emitter.on("change",this.onValueChange_),this.element=Ie.createElement("div"),this.element.classList.add(Uc()),Ye.viewProps.bindClassModifiers(this.element),Ye.viewProps.bindTabIndex(this.element);const vt=Ie.createElement("canvas");vt.height=64,vt.width=64,vt.classList.add(Uc("c")),this.element.appendChild(vt),this.canvasElement=vt;const Dt=Ie.createElement("div");Dt.classList.add(Uc("m")),this.element.appendChild(Dt),this.markerElem_=Dt,this.update_()}update_(){const Ie=function(Bn){const tr=Bn.ownerDocument.defaultView;return tr&&"document"in tr?Bn.getContext("2d",{willReadFrequently:!0}):null}(this.canvasElement);if(!Ie)return;const Ye=this.value.rawValue.getComponents("hsv"),vt=this.canvasElement.width,Dt=this.canvasElement.height,zt=Ie.getImageData(0,0,vt,Dt),ni=zt.data;for(let Bn=0;Bn<Dt;Bn++)for(let tr=0;tr<vt;tr++){const Wr=Mr(tr,0,vt,0,100),go=Mr(Bn,0,Dt,100,0),bo=oa(Ye[0],Wr,go),Cn=4*(Bn*vt+tr);ni[Cn]=bo[0],ni[Cn+1]=bo[1],ni[Cn+2]=bo[2],ni[Cn+3]=255}Ie.putImageData(zt,0,0);const Di=Mr(Ye[1],0,100,0,100);this.markerElem_.style.left=`${Di}%`;const rn=Mr(Ye[2],0,100,100,0);this.markerElem_.style.top=`${rn}%`}onValueChange_(){this.update_()}}class ii{constructor(Ie,Ye){this.onKeyDown_=this.onKeyDown_.bind(this),this.onKeyUp_=this.onKeyUp_.bind(this),this.onPointerDown_=this.onPointerDown_.bind(this),this.onPointerMove_=this.onPointerMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new Ao(Ie,{value:this.value,viewProps:this.viewProps}),this.ptHandler_=new io(this.view.element),this.ptHandler_.emitter.on("down",this.onPointerDown_),this.ptHandler_.emitter.on("move",this.onPointerMove_),this.ptHandler_.emitter.on("up",this.onPointerUp_),this.view.element.addEventListener("keydown",this.onKeyDown_),this.view.element.addEventListener("keyup",this.onKeyUp_)}handlePointerEvent_(Ie,Ye){if(!Ie.point)return;const vt=Mr(Ie.point.x,0,Ie.bounds.width,0,100),Dt=Mr(Ie.point.y,0,Ie.bounds.height,100,0),[zt,,,ni]=this.value.rawValue.getComponents("hsv");this.value.setRawValue(new ur([zt,vt,Dt,ni],"hsv"),Ye)}onPointerDown_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerMove_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerUp_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!0,last:!0})}onKeyDown_(Ie){ka(Ie.key)&&Ie.preventDefault();const[Ye,vt,Dt,zt]=this.value.rawValue.getComponents("hsv"),ni=jo(!1),Di=Cr(ni,Fr(Ie)),rn=Cr(ni,Rr(Ie));Di===0&&rn===0||this.value.setRawValue(new ur([Ye,vt+Di,Dt+rn,zt],"hsv"),{forceEmit:!1,last:!1})}onKeyUp_(Ie){const Ye=jo(!1),vt=Cr(Ye,Fr(Ie)),Dt=Cr(Ye,Rr(Ie));vt===0&&Dt===0||this.value.setRawValue(this.value.rawValue,{forceEmit:!0,last:!0})}}class Fc{constructor(Ie,Ye){this.value=Ye.value,this.viewProps=Ye.viewProps,this.hPaletteC_=new ph(Ie,{value:this.value,viewProps:this.viewProps}),this.svPaletteC_=new ii(Ie,{value:this.value,viewProps:this.viewProps}),this.alphaIcs_=Ye.supportsAlpha?{palette:new hh(Ie,{value:this.value,viewProps:this.viewProps}),text:new Ua(Ie,{parser:os,baseStep:.1,props:Bt.fromObject({draggingScale:.01,formatter:Vr(2)}),value:Lt(0,{constraint:new gs({min:0,max:1})}),viewProps:this.viewProps})}:null,this.alphaIcs_&&na({primary:this.value,secondary:this.alphaIcs_.text.value,forward:vt=>vt.rawValue.getComponents()[3],backward:(vt,Dt)=>{const zt=vt.rawValue.getComponents();return zt[3]=Dt.rawValue,new ur(zt,vt.rawValue.mode)}}),this.textC_=new Dl(Ie,{colorType:Ye.colorType,parser:os,value:this.value,viewProps:this.viewProps}),this.view=new Cc(Ie,{alphaViews:this.alphaIcs_?{palette:this.alphaIcs_.palette.view,text:this.alphaIcs_.text.view}:null,hPaletteView:this.hPaletteC_.view,supportsAlpha:Ye.supportsAlpha,svPaletteView:this.svPaletteC_.view,textView:this.textC_.view,viewProps:this.viewProps})}get textController(){return this.textC_}}const Bl=Ve("colsw");class Ko{constructor(Ie,Ye){this.onValueChange_=this.onValueChange_.bind(this),Ye.value.emitter.on("change",this.onValueChange_),this.value=Ye.value,this.element=Ie.createElement("div"),this.element.classList.add(Bl()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("div");vt.classList.add(Bl("sw")),this.element.appendChild(vt),this.swatchElem_=vt;const Dt=Ie.createElement("button");Dt.classList.add(Bl("b")),Ye.viewProps.bindDisabled(Dt),this.element.appendChild(Dt),this.buttonElement=Dt,this.update_()}update_(){const Ie=this.value.rawValue;this.swatchElem_.style.backgroundColor=zs(Ie)}onValueChange_(){this.update_()}}class as{constructor(Ie,Ye){this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new Ko(Ie,{value:this.value,viewProps:this.viewProps})}}class zo{constructor(Ie,Ye){this.onButtonBlur_=this.onButtonBlur_.bind(this),this.onButtonClick_=this.onButtonClick_.bind(this),this.onPopupChildBlur_=this.onPopupChildBlur_.bind(this),this.onPopupChildKeydown_=this.onPopupChildKeydown_.bind(this),this.value=Ye.value,this.viewProps=Ye.viewProps,this.foldable_=mi.create(Ye.expanded),this.swatchC_=new as(Ie,{value:this.value,viewProps:this.viewProps});const vt=this.swatchC_.view.buttonElement;vt.addEventListener("blur",this.onButtonBlur_),vt.addEventListener("click",this.onButtonClick_),this.textC_=new Zs(Ie,{parser:Ye.parser,props:Bt.fromObject({formatter:Ye.formatter}),value:this.value,viewProps:this.viewProps}),this.view=new Pu(Ie,{foldable:this.foldable_,pickerLayout:Ye.pickerLayout}),this.view.swatchElement.appendChild(this.swatchC_.view.element),this.view.textElement.appendChild(this.textC_.view.element),this.popC_=Ye.pickerLayout==="popup"?new _l(Ie,{viewProps:this.viewProps}):null;const Dt=new Fc(Ie,{colorType:Ye.colorType,supportsAlpha:Ye.supportsAlpha,value:this.value,viewProps:this.viewProps});Dt.view.allFocusableElements.forEach(zt=>{zt.addEventListener("blur",this.onPopupChildBlur_),zt.addEventListener("keydown",this.onPopupChildKeydown_)}),this.pickerC_=Dt,this.popC_?(this.view.element.appendChild(this.popC_.view.element),this.popC_.view.element.appendChild(Dt.view.element),na({primary:this.foldable_.value("expanded"),secondary:this.popC_.shows,forward:zt=>zt.rawValue,backward:(zt,ni)=>ni.rawValue})):this.view.pickerElement&&(this.view.pickerElement.appendChild(this.pickerC_.view.element),Zi(this.foldable_,this.view.pickerElement))}get textController(){return this.textC_}onButtonBlur_(Ie){if(!this.popC_)return;const Ye=this.view.element,vt=Ie.relatedTarget;vt&&Ye.contains(vt)||(this.popC_.shows.rawValue=!1)}onButtonClick_(){this.foldable_.set("expanded",!this.foldable_.get("expanded")),this.foldable_.get("expanded")&&this.pickerC_.view.allFocusableElements[0].focus()}onPopupChildBlur_(Ie){if(!this.popC_)return;const Ye=this.popC_.view.element,vt=Gi(Ie);vt&&Ye.contains(vt)||vt&&vt===this.swatchC_.view.buttonElement&&!Ui(Ye.ownerDocument)||(this.popC_.shows.rawValue=!1)}onPopupChildKeydown_(Ie){this.popC_?Ie.key==="Escape"&&(this.popC_.shows.rawValue=!1):this.view.pickerElement&&Ie.key==="Escape"&&this.swatchC_.view.buttonElement.focus()}}function ua(ft){return Us(ft.getComponents("rgb")).reduce((Ie,Ye)=>Ie<<8|255&Math.floor(Ye),0)}function da(ft){return ft.getComponents("rgb").reduce((Ie,Ye,vt)=>Ie<<8|255&Math.floor(vt===3?255*Ye:Ye),0)>>>0}function ha(ft){return typeof ft!="number"?ur.black():new ur([(Ie=ft)>>16&255,Ie>>8&255,255&Ie],"rgb");var Ie}function pa(ft){return typeof ft!="number"?ur.black():new ur([(Ie=ft)>>24&255,Ie>>16&255,Ie>>8&255,Mr(255&Ie,0,255,0,1)],"rgb");var Ie}function $o(ft){var Ie;return!(!(ft!=null&&ft.alpha)&&!(!((Ie=ft==null?void 0:ft.color)===null||Ie===void 0)&&Ie.alpha))}function bs(ft){return ft?Ie=>zs(Ie,"0x"):Ie=>Rc(Ie,"0x")}const Hs={id:"input-color-number",type:"input",accept:(ft,Ie)=>{if(typeof ft!="number"||!function(vt){return"color"in vt||"view"in vt&&vt.view==="color"}(Ie))return null;const Ye=Bo(Ie);return Ye?{initialValue:ft,params:Ye}:null},binding:{reader:ft=>$o(ft.params)?pa:ha,equals:ur.equals,writer:ft=>function(Ie){const Ye=Ie?da:ua;return(vt,Dt)=>{Fa(vt,Ye(Dt))}}($o(ft.params))},controller:ft=>{const Ie=$o(ft.params),Ye="expanded"in ft.params?ft.params.expanded:void 0,vt="picker"in ft.params?ft.params.picker:void 0;return new zo(ft.document,{colorType:"int",expanded:Ye!=null&&Ye,formatter:bs(Ie),parser:Gs("int"),pickerLayout:vt??"popup",supportsAlpha:Ie,value:ft.value,viewProps:ft.viewProps})}};function Va(ft){return Ie=>function(Ye,vt){return ur.isColorObject(Ye)?ur.fromObject(Ye,vt):ur.black(vt)}(Ie,ft)}function Ol(ft,Ie){return Ye=>ft?Rl(Ye,Ie):Sr(Ye,Ie)}const Ll={id:"input-color-object",type:"input",accept:(ft,Ie)=>{if(!ur.isColorObject(ft))return null;const Ye=Bo(Ie);return Ye?{initialValue:ft,params:Ye}:null},binding:{reader:ft=>Va(ho(ft.params)),equals:ur.equals,writer:ft=>{return vt=ft.initialValue,Ie=ur.isRgbaColorObject(vt),Ye=ho(ft.params),(Dt,zt)=>{Ie?function(ni,Di,rn){const Bn=Di.toRgbaObject(rn);ni.writeProperty("r",Bn.r),ni.writeProperty("g",Bn.g),ni.writeProperty("b",Bn.b),ni.writeProperty("a",Bn.a)}(Dt,zt,Ye):function(ni,Di,rn){const Bn=Di.toRgbaObject(rn);ni.writeProperty("r",Bn.r),ni.writeProperty("g",Bn.g),ni.writeProperty("b",Bn.b)}(Dt,zt,Ye)};var Ie,Ye,vt}},controller:ft=>{var Ie;const Ye=ur.isRgbaColorObject(ft.initialValue),vt="expanded"in ft.params?ft.params.expanded:void 0,Dt="picker"in ft.params?ft.params.picker:void 0,zt=(Ie=ho(ft.params))!==null&&Ie!==void 0?Ie:"int";return new zo(ft.document,{colorType:zt,expanded:vt!=null&&vt,formatter:Ol(Ye,zt),parser:Gs(zt),pickerLayout:Dt??"popup",supportsAlpha:Ye,value:ft.value,viewProps:ft.viewProps})}},Qs={id:"input-color-string",type:"input",accept:(ft,Ie)=>{if(typeof ft!="string"||"view"in Ie&&Ie.view==="text")return null;const Ye=Pc(ft,ho(Ie));if(!Ye||!Oc(Ye))return null;const vt=Bo(Ie);return vt?{initialValue:ft,params:vt}:null},binding:{reader:ft=>{var Ie;return function(Ye){const vt=js[Ye];return Dt=>{if(typeof Dt!="string")return ur.black(Ye);const zt=vt.reduce((ni,Di)=>ni||Di(Dt),null);return zt??ur.black(Ye)}}((Ie=ho(ft.params))!==null&&Ie!==void 0?Ie:"int")},equals:ur.equals,writer:ft=>{const Ie=Pc(ft.initialValue,ho(ft.params));if(!Ie)throw ce.shouldNeverHappen();const Ye=function(vt){const Dt=Oc(vt);return Dt?(zt,ni)=>{Fa(zt,Dt(ni))}:null}(Ie);if(!Ye)throw ce.notBindable();return Ye}},controller:ft=>{const Ie=Pc(ft.initialValue,ho(ft.params));if(!Ie)throw ce.shouldNeverHappen();const Ye=Oc(Ie);if(!Ye)throw ce.shouldNeverHappen();const vt="expanded"in ft.params?ft.params.expanded:void 0,Dt="picker"in ft.params?ft.params.picker:void 0;return new zo(ft.document,{colorType:Ie.type,expanded:vt!=null&&vt,formatter:Ye,parser:Gs(Ie.type),pickerLayout:Dt??"popup",supportsAlpha:Ie.alpha,value:ft.value,viewProps:ft.viewProps})}};class Jo{constructor(Ie){this.components=Ie.components,this.asm_=Ie.assembly}constrain(Ie){const Ye=this.asm_.toComponents(Ie).map((vt,Dt)=>{var zt,ni;return(ni=(zt=this.components[Dt])===null||zt===void 0?void 0:zt.constrain(vt))!==null&&ni!==void 0?ni:vt});return this.asm_.fromComponents(Ye)}}const ku=Ve("pndtxt");class Ha{constructor(Ie,Ye){this.textViews=Ye.textViews,this.element=Ie.createElement("div"),this.element.classList.add(ku()),this.textViews.forEach(vt=>{const Dt=Ie.createElement("div");Dt.classList.add(ku("a")),Dt.appendChild(vt.element),this.element.appendChild(Dt)})}}class Qa{constructor(Ie,Ye){this.value=Ye.value,this.viewProps=Ye.viewProps,this.acs_=Ye.axes.map((vt,Dt)=>function(zt,ni,Di){return new Ua(zt,{arrayPosition:Di===0?"fst":Di===ni.axes.length-1?"lst":"mid",baseStep:ni.axes[Di].baseStep,parser:ni.parser,props:ni.axes[Di].textProps,value:Lt(0,{constraint:ni.axes[Di].constraint}),viewProps:ni.viewProps})}(Ie,Ye,Dt)),this.acs_.forEach((vt,Dt)=>{na({primary:this.value,secondary:vt.value,forward:zt=>Ye.assembly.toComponents(zt.rawValue)[Dt],backward:(zt,ni)=>{const Di=Ye.assembly.toComponents(zt.rawValue);return Di[Dt]=ni.rawValue,Ye.assembly.fromComponents(Di)}})}),this.view=new Ha(Ie,{textViews:this.acs_.map(vt=>vt.view)})}}function Oo(ft,Ie){return"step"in ft&&!C(ft.step)?new Js(ft.step,Ie):null}function Zo(ft){return C(ft.max)||C(ft.min)?C(ft.max)&&C(ft.min)?null:new ml({max:ft.max,min:ft.min}):new gs({max:ft.max,min:ft.min})}const jc={id:"input-number",type:"input",accept:(ft,Ie)=>{if(typeof ft!="number")return null;const Ye=Vt,vt=si(Ie,{format:Ye.optional.function,max:Ye.optional.number,min:Ye.optional.number,options:Ye.optional.custom(El),step:Ye.optional.number});return vt?{initialValue:ft,params:vt}:null},binding:{reader:ft=>wu,constraint:ft=>function(Ie,Ye){const vt=[],Dt=Oo(Ie,Ye);Dt&&vt.push(Dt);const zt=Zo(Ie);zt&&vt.push(zt);const ni=Tc(Ie.options);return ni&&vt.push(ni),new Is(vt)}(ft.params,ft.initialValue),writer:ft=>Fa},controller:ft=>{var Ie;const Ye=ft.value,vt=ft.constraint,Dt=vt&&Fo(vt,Rs);if(Dt)return new Ds(ft.document,{props:new Bt({options:Dt.values.value("options")}),value:Ye,viewProps:ft.viewProps});const zt=(Ie="format"in ft.params?ft.params.format:void 0)!==null&&Ie!==void 0?Ie:Vr(ja(vt,Ye.rawValue)),ni=vt&&Fo(vt,gs);return ni?new Sc(ft.document,{baseStep:Ns(vt),parser:os,sliderProps:new Bt({maxValue:ni.values.value("max"),minValue:ni.values.value("min")}),textProps:Bt.fromObject({draggingScale:ks(vt,Ye.rawValue),formatter:zt}),value:Ye,viewProps:ft.viewProps}):new Ua(ft.document,{baseStep:Ns(vt),parser:os,props:Bt.fromObject({draggingScale:ks(vt,Ye.rawValue),formatter:zt}),value:Ye,viewProps:ft.viewProps})}};class Vo{constructor(Ie=0,Ye=0){this.x=Ie,this.y=Ye}getComponents(){return[this.x,this.y]}static isObject(Ie){if(C(Ie))return!1;const Ye=Ie.x,vt=Ie.y;return typeof Ye=="number"&&typeof vt=="number"}static equals(Ie,Ye){return Ie.x===Ye.x&&Ie.y===Ye.y}toObject(){return{x:this.x,y:this.y}}}const ls={toComponents:ft=>ft.getComponents(),fromComponents:ft=>new Vo(...ft)},xs=Ve("p2d");class Nl{constructor(Ie,Ye){this.element=Ie.createElement("div"),this.element.classList.add(xs()),Ye.viewProps.bindClassModifiers(this.element),ht(Ye.expanded,_t(this.element,xs(void 0,"expanded")));const vt=Ie.createElement("div");vt.classList.add(xs("h")),this.element.appendChild(vt);const Dt=Ie.createElement("button");Dt.classList.add(xs("b")),Dt.appendChild(Ln(Ie,"p2dpad")),Ye.viewProps.bindDisabled(Dt),vt.appendChild(Dt),this.buttonElement=Dt;const zt=Ie.createElement("div");if(zt.classList.add(xs("t")),vt.appendChild(zt),this.textElement=zt,Ye.pickerLayout==="inline"){const ni=Ie.createElement("div");ni.classList.add(xs("p")),this.element.appendChild(ni),this.pickerElement=ni}else this.pickerElement=null}}const ts=Ve("p2dp");class ma{constructor(Ie,Ye){this.onFoldableChange_=this.onFoldableChange_.bind(this),this.onValueChange_=this.onValueChange_.bind(this),this.invertsY_=Ye.invertsY,this.maxValue_=Ye.maxValue,this.element=Ie.createElement("div"),this.element.classList.add(ts()),Ye.layout==="popup"&&this.element.classList.add(ts(void 0,"p")),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("div");vt.classList.add(ts("p")),Ye.viewProps.bindTabIndex(vt),this.element.appendChild(vt),this.padElement=vt;const Dt=Ie.createElementNS(qt,"svg");Dt.classList.add(ts("g")),this.padElement.appendChild(Dt),this.svgElem_=Dt;const zt=Ie.createElementNS(qt,"line");zt.classList.add(ts("ax")),zt.setAttributeNS(null,"x1","0"),zt.setAttributeNS(null,"y1","50%"),zt.setAttributeNS(null,"x2","100%"),zt.setAttributeNS(null,"y2","50%"),this.svgElem_.appendChild(zt);const ni=Ie.createElementNS(qt,"line");ni.classList.add(ts("ax")),ni.setAttributeNS(null,"x1","50%"),ni.setAttributeNS(null,"y1","0"),ni.setAttributeNS(null,"x2","50%"),ni.setAttributeNS(null,"y2","100%"),this.svgElem_.appendChild(ni);const Di=Ie.createElementNS(qt,"line");Di.classList.add(ts("l")),Di.setAttributeNS(null,"x1","50%"),Di.setAttributeNS(null,"y1","50%"),this.svgElem_.appendChild(Di),this.lineElem_=Di;const rn=Ie.createElement("div");rn.classList.add(ts("m")),this.padElement.appendChild(rn),this.markerElem_=rn,Ye.value.emitter.on("change",this.onValueChange_),this.value=Ye.value,this.update_()}get allFocusableElements(){return[this.padElement]}update_(){const[Ie,Ye]=this.value.rawValue.getComponents(),vt=this.maxValue_,Dt=Mr(Ie,-vt,+vt,0,100),zt=Mr(Ye,-vt,+vt,0,100),ni=this.invertsY_?100-zt:zt;this.lineElem_.setAttributeNS(null,"x2",`${Dt}%`),this.lineElem_.setAttributeNS(null,"y2",`${ni}%`),this.markerElem_.style.left=`${Dt}%`,this.markerElem_.style.top=`${ni}%`}onValueChange_(){this.update_()}onFoldableChange_(){this.update_()}}function Xn(ft,Ie,Ye){return[Cr(Ie[0],Fr(ft)),Cr(Ie[1],Rr(ft))*(Ye?1:-1)]}class fa{constructor(Ie,Ye){this.onPadKeyDown_=this.onPadKeyDown_.bind(this),this.onPadKeyUp_=this.onPadKeyUp_.bind(this),this.onPointerDown_=this.onPointerDown_.bind(this),this.onPointerMove_=this.onPointerMove_.bind(this),this.onPointerUp_=this.onPointerUp_.bind(this),this.value=Ye.value,this.viewProps=Ye.viewProps,this.baseSteps_=Ye.baseSteps,this.maxValue_=Ye.maxValue,this.invertsY_=Ye.invertsY,this.view=new ma(Ie,{invertsY:this.invertsY_,layout:Ye.layout,maxValue:this.maxValue_,value:this.value,viewProps:this.viewProps}),this.ptHandler_=new io(this.view.padElement),this.ptHandler_.emitter.on("down",this.onPointerDown_),this.ptHandler_.emitter.on("move",this.onPointerMove_),this.ptHandler_.emitter.on("up",this.onPointerUp_),this.view.padElement.addEventListener("keydown",this.onPadKeyDown_),this.view.padElement.addEventListener("keyup",this.onPadKeyUp_)}handlePointerEvent_(Ie,Ye){if(!Ie.point)return;const vt=this.maxValue_,Dt=Mr(Ie.point.x,0,Ie.bounds.width,-vt,+vt),zt=Mr(this.invertsY_?Ie.bounds.height-Ie.point.y:Ie.point.y,0,Ie.bounds.height,-vt,+vt);this.value.setRawValue(new Vo(Dt,zt),Ye)}onPointerDown_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerMove_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!1,last:!1})}onPointerUp_(Ie){this.handlePointerEvent_(Ie.data,{forceEmit:!0,last:!0})}onPadKeyDown_(Ie){ka(Ie.key)&&Ie.preventDefault();const[Ye,vt]=Xn(Ie,this.baseSteps_,this.invertsY_);Ye===0&&vt===0||this.value.setRawValue(new Vo(this.value.rawValue.x+Ye,this.value.rawValue.y+vt),{forceEmit:!1,last:!1})}onPadKeyUp_(Ie){const[Ye,vt]=Xn(Ie,this.baseSteps_,this.invertsY_);Ye===0&&vt===0||this.value.setRawValue(this.value.rawValue,{forceEmit:!0,last:!0})}}class Ho{constructor(Ie,Ye){var vt,Dt;this.onPopupChildBlur_=this.onPopupChildBlur_.bind(this),this.onPopupChildKeydown_=this.onPopupChildKeydown_.bind(this),this.onPadButtonBlur_=this.onPadButtonBlur_.bind(this),this.onPadButtonClick_=this.onPadButtonClick_.bind(this),this.value=Ye.value,this.viewProps=Ye.viewProps,this.foldable_=mi.create(Ye.expanded),this.popC_=Ye.pickerLayout==="popup"?new _l(Ie,{viewProps:this.viewProps}):null;const zt=new fa(Ie,{baseSteps:[Ye.axes[0].baseStep,Ye.axes[1].baseStep],invertsY:Ye.invertsY,layout:Ye.pickerLayout,maxValue:Ye.maxValue,value:this.value,viewProps:this.viewProps});zt.view.allFocusableElements.forEach(ni=>{ni.addEventListener("blur",this.onPopupChildBlur_),ni.addEventListener("keydown",this.onPopupChildKeydown_)}),this.pickerC_=zt,this.textC_=new Qa(Ie,{assembly:ls,axes:Ye.axes,parser:Ye.parser,value:this.value,viewProps:this.viewProps}),this.view=new Nl(Ie,{expanded:this.foldable_.value("expanded"),pickerLayout:Ye.pickerLayout,viewProps:this.viewProps}),this.view.textElement.appendChild(this.textC_.view.element),(vt=this.view.buttonElement)===null||vt===void 0||vt.addEventListener("blur",this.onPadButtonBlur_),(Dt=this.view.buttonElement)===null||Dt===void 0||Dt.addEventListener("click",this.onPadButtonClick_),this.popC_?(this.view.element.appendChild(this.popC_.view.element),this.popC_.view.element.appendChild(this.pickerC_.view.element),na({primary:this.foldable_.value("expanded"),secondary:this.popC_.shows,forward:ni=>ni.rawValue,backward:(ni,Di)=>Di.rawValue})):this.view.pickerElement&&(this.view.pickerElement.appendChild(this.pickerC_.view.element),Zi(this.foldable_,this.view.pickerElement))}onPadButtonBlur_(Ie){if(!this.popC_)return;const Ye=this.view.element,vt=Ie.relatedTarget;vt&&Ye.contains(vt)||(this.popC_.shows.rawValue=!1)}onPadButtonClick_(){this.foldable_.set("expanded",!this.foldable_.get("expanded")),this.foldable_.get("expanded")&&this.pickerC_.view.allFocusableElements[0].focus()}onPopupChildBlur_(Ie){if(!this.popC_)return;const Ye=this.popC_.view.element,vt=Gi(Ie);vt&&Ye.contains(vt)||vt&&vt===this.view.buttonElement&&!Ui(Ye.ownerDocument)||(this.popC_.shows.rawValue=!1)}onPopupChildKeydown_(Ie){this.popC_?Ie.key==="Escape"&&(this.popC_.shows.rawValue=!1):this.view.pickerElement&&Ie.key==="Escape"&&this.view.buttonElement.focus()}}class ga{constructor(Ie=0,Ye=0,vt=0){this.x=Ie,this.y=Ye,this.z=vt}getComponents(){return[this.x,this.y,this.z]}static isObject(Ie){if(C(Ie))return!1;const Ye=Ie.x,vt=Ie.y,Dt=Ie.z;return typeof Ye=="number"&&typeof vt=="number"&&typeof Dt=="number"}static equals(Ie,Ye){return Ie.x===Ye.x&&Ie.y===Ye.y&&Ie.z===Ye.z}toObject(){return{x:this.x,y:this.y,z:this.z}}}const Uu={toComponents:ft=>ft.getComponents(),fromComponents:ft=>new ga(...ft)};function ws(ft){return ga.isObject(ft)?new ga(ft.x,ft.y,ft.z):new ga}function kl(ft,Ie){ft.writeProperty("x",Ie.x),ft.writeProperty("y",Ie.y),ft.writeProperty("z",Ie.z)}function mo(ft,Ie){return{baseStep:Ns(Ie),constraint:Ie,textProps:Bt.fromObject({draggingScale:ks(Ie,ft),formatter:Vr(ja(Ie,ft))})}}const Fu={id:"input-point3d",type:"input",accept:(ft,Ie)=>{if(!ga.isObject(ft))return null;const Ye=Vt,vt=si(Ie,{x:Ye.optional.custom(_s),y:Ye.optional.custom(_s),z:Ye.optional.custom(_s)});return vt?{initialValue:ft,params:vt}:null},binding:{reader:ft=>ws,constraint:ft=>{return Ie=ft.params,Ye=ft.initialValue,new Jo({assembly:Uu,components:[Qo("x"in Ie?Ie.x:void 0,Ye.x),Qo("y"in Ie?Ie.y:void 0,Ye.y),Qo("z"in Ie?Ie.z:void 0,Ye.z)]});var Ie,Ye},equals:ga.equals,writer:ft=>kl},controller:ft=>{const Ie=ft.value,Ye=ft.constraint;if(!(Ye instanceof Jo))throw ce.shouldNeverHappen();return new Qa(ft.document,{assembly:Uu,axes:[mo(Ie.rawValue.x,Ye.components[0]),mo(Ie.rawValue.y,Ye.components[1]),mo(Ie.rawValue.z,Ye.components[2])],parser:os,value:Ie,viewProps:ft.viewProps})}};class Ws{constructor(Ie=0,Ye=0,vt=0,Dt=0){this.x=Ie,this.y=Ye,this.z=vt,this.w=Dt}getComponents(){return[this.x,this.y,this.z,this.w]}static isObject(Ie){if(C(Ie))return!1;const Ye=Ie.x,vt=Ie.y,Dt=Ie.z,zt=Ie.w;return typeof Ye=="number"&&typeof vt=="number"&&typeof Dt=="number"&&typeof zt=="number"}static equals(Ie,Ye){return Ie.x===Ye.x&&Ie.y===Ye.y&&Ie.z===Ye.z&&Ie.w===Ye.w}toObject(){return{x:this.x,y:this.y,z:this.z,w:this.w}}}const ya={toComponents:ft=>ft.getComponents(),fromComponents:ft=>new Ws(...ft)};function Ul(ft){return Ws.isObject(ft)?new Ws(ft.x,ft.y,ft.z,ft.w):new Ws}function mh(ft,Ie){ft.writeProperty("x",Ie.x),ft.writeProperty("y",Ie.y),ft.writeProperty("z",Ie.z),ft.writeProperty("w",Ie.w)}const ju={id:"input-point4d",type:"input",accept:(ft,Ie)=>{if(!Ws.isObject(ft))return null;const Ye=Vt,vt=si(Ie,{x:Ye.optional.custom(_s),y:Ye.optional.custom(_s),z:Ye.optional.custom(_s),w:Ye.optional.custom(_s)});return vt?{initialValue:ft,params:vt}:null},binding:{reader:ft=>Ul,constraint:ft=>{return Ie=ft.params,Ye=ft.initialValue,new Jo({assembly:ya,components:[Qo("x"in Ie?Ie.x:void 0,Ye.x),Qo("y"in Ie?Ie.y:void 0,Ye.y),Qo("z"in Ie?Ie.z:void 0,Ye.z),Qo("w"in Ie?Ie.w:void 0,Ye.w)]});var Ie,Ye},equals:Ws.equals,writer:ft=>mh},controller:ft=>{const Ie=ft.value,Ye=ft.constraint;if(!(Ye instanceof Jo))throw ce.shouldNeverHappen();return new Qa(ft.document,{assembly:ya,axes:Ie.rawValue.getComponents().map((vt,Dt)=>{return zt=vt,{baseStep:Ns(ni=Ye.components[Dt]),constraint:ni,textProps:Bt.fromObject({draggingScale:ks(ni,zt),formatter:Vr(ja(ni,zt))})};var zt,ni}),parser:os,value:Ie,viewProps:ft.viewProps})}},Aa={id:"input-string",type:"input",accept:(ft,Ie)=>{if(typeof ft!="string")return null;const Ye=si(Ie,{options:Vt.optional.custom(El)});return Ye?{initialValue:ft,params:Ye}:null},binding:{reader:ft=>xc,constraint:ft=>function(Ie){const Ye=[],vt=Tc(Ie.options);return vt&&Ye.push(vt),new Is(Ye)}(ft.params),writer:ft=>Fa},controller:ft=>{const Ie=ft.document,Ye=ft.value,vt=ft.constraint,Dt=vt&&Fo(vt,Rs);return Dt?new Ds(Ie,{props:new Bt({options:Dt.values.value("options")}),value:Ye,viewProps:ft.viewProps}):new Zs(Ie,{parser:zt=>zt,props:Bt.fromObject({formatter:Yo}),value:Ye,viewProps:ft.viewProps})}},So={defaultInterval:200,defaultLineCount:3},Wa=Ve("mll");class qa{constructor(Ie,Ye){this.onValueUpdate_=this.onValueUpdate_.bind(this),this.formatter_=Ye.formatter,this.element=Ie.createElement("div"),this.element.classList.add(Wa()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("textarea");vt.classList.add(Wa("i")),vt.style.height=`calc(var(--bld-us) * ${Ye.lineCount})`,vt.readOnly=!0,Ye.viewProps.bindDisabled(vt),this.element.appendChild(vt),this.textareaElem_=vt,Ye.value.emitter.on("change",this.onValueUpdate_),this.value=Ye.value,this.update_()}update_(){const Ie=this.textareaElem_,Ye=Ie.scrollTop===Ie.scrollHeight-Ie.clientHeight,vt=[];this.value.rawValue.forEach(Dt=>{Dt!==void 0&&vt.push(this.formatter_(Dt))}),Ie.textContent=vt.join(`
`),Ye&&(Ie.scrollTop=Ie.scrollHeight)}onValueUpdate_(){this.update_()}}class Gc{constructor(Ie,Ye){this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new qa(Ie,{formatter:Ye.formatter,lineCount:Ye.lineCount,value:this.value,viewProps:this.viewProps})}}const Gu=Ve("sgl");class zu{constructor(Ie,Ye){this.onValueUpdate_=this.onValueUpdate_.bind(this),this.formatter_=Ye.formatter,this.element=Ie.createElement("div"),this.element.classList.add(Gu()),Ye.viewProps.bindClassModifiers(this.element);const vt=Ie.createElement("input");vt.classList.add(Gu("i")),vt.readOnly=!0,vt.type="text",Ye.viewProps.bindDisabled(vt),this.element.appendChild(vt),this.inputElement=vt,Ye.value.emitter.on("change",this.onValueUpdate_),this.value=Ye.value,this.update_()}update_(){const Ie=this.value.rawValue,Ye=Ie[Ie.length-1];this.inputElement.value=Ye!==void 0?this.formatter_(Ye):""}onValueUpdate_(){this.update_()}}class Fl{constructor(Ie,Ye){this.value=Ye.value,this.viewProps=Ye.viewProps,this.view=new zu(Ie,{formatter:Ye.formatter,value:this.value,viewProps:this.viewProps})}}const Vu={id:"monitor-bool",type:"monitor",accept:(ft,Ie)=>{if(typeof ft!="boolean")return null;const Ye=si(Ie,{lineCount:Vt.optional.number});return Ye?{initialValue:ft,params:Ye}:null},binding:{reader:ft=>yl},controller:ft=>{var Ie;return ft.value.rawValue.length===1?new Fl(ft.document,{formatter:Da,value:ft.value,viewProps:ft.viewProps}):new Gc(ft.document,{formatter:Da,lineCount:(Ie=ft.params.lineCount)!==null&&Ie!==void 0?Ie:So.defaultLineCount,value:ft.value,viewProps:ft.viewProps})}},Es=Ve("grl");class fh{constructor(Ie,Ye){this.onCursorChange_=this.onCursorChange_.bind(this),this.onValueUpdate_=this.onValueUpdate_.bind(this),this.element=Ie.createElement("div"),this.element.classList.add(Es()),Ye.viewProps.bindClassModifiers(this.element),this.formatter_=Ye.formatter,this.props_=Ye.props,this.cursor_=Ye.cursor,this.cursor_.emitter.on("change",this.onCursorChange_);const vt=Ie.createElementNS(qt,"svg");vt.classList.add(Es("g")),vt.style.height=`calc(var(--bld-us) * ${Ye.lineCount})`,this.element.appendChild(vt),this.svgElem_=vt;const Dt=Ie.createElementNS(qt,"polyline");this.svgElem_.appendChild(Dt),this.lineElem_=Dt;const zt=Ie.createElement("div");zt.classList.add(Es("t"),Ve("tt")()),this.element.appendChild(zt),this.tooltipElem_=zt,Ye.value.emitter.on("change",this.onValueUpdate_),this.value=Ye.value,this.update_()}get graphElement(){return this.svgElem_}update_(){const Ie=this.svgElem_.getBoundingClientRect(),Ye=this.value.rawValue.length-1,vt=this.props_.get("minValue"),Dt=this.props_.get("maxValue"),zt=[];this.value.rawValue.forEach((tr,Wr)=>{if(tr===void 0)return;const go=Mr(Wr,0,Ye,0,Ie.width),bo=Mr(tr,vt,Dt,Ie.height,0);zt.push([go,bo].join(","))}),this.lineElem_.setAttributeNS(null,"points",zt.join(" "));const ni=this.tooltipElem_,Di=this.value.rawValue[this.cursor_.rawValue];if(Di===void 0)return void ni.classList.remove(Es("t","a"));const rn=Mr(this.cursor_.rawValue,0,Ye,0,Ie.width),Bn=Mr(Di,vt,Dt,Ie.height,0);ni.style.left=`${rn}px`,ni.style.top=`${Bn}px`,ni.textContent=`${this.formatter_(Di)}`,ni.classList.contains(Es("t","a"))||(ni.classList.add(Es("t","a"),Es("t","in")),Li(ni),ni.classList.remove(Es("t","in")))}onValueUpdate_(){this.update_()}onCursorChange_(){this.update_()}}class yr{constructor(Ie,Ye){if(this.onGraphMouseMove_=this.onGraphMouseMove_.bind(this),this.onGraphMouseLeave_=this.onGraphMouseLeave_.bind(this),this.onGraphPointerDown_=this.onGraphPointerDown_.bind(this),this.onGraphPointerMove_=this.onGraphPointerMove_.bind(this),this.onGraphPointerUp_=this.onGraphPointerUp_.bind(this),this.props_=Ye.props,this.value=Ye.value,this.viewProps=Ye.viewProps,this.cursor_=Lt(-1),this.view=new fh(Ie,{cursor:this.cursor_,formatter:Ye.formatter,lineCount:Ye.lineCount,props:this.props_,value:this.value,viewProps:this.viewProps}),Ui(Ie)){const vt=new io(this.view.element);vt.emitter.on("down",this.onGraphPointerDown_),vt.emitter.on("move",this.onGraphPointerMove_),vt.emitter.on("up",this.onGraphPointerUp_)}else this.view.element.addEventListener("mousemove",this.onGraphMouseMove_),this.view.element.addEventListener("mouseleave",this.onGraphMouseLeave_)}onGraphMouseLeave_(){this.cursor_.rawValue=-1}onGraphMouseMove_(Ie){const Ye=this.view.element.getBoundingClientRect();this.cursor_.rawValue=Math.floor(Mr(Ie.offsetX,0,Ye.width,0,this.value.rawValue.length))}onGraphPointerDown_(Ie){this.onGraphPointerMove_(Ie)}onGraphPointerMove_(Ie){Ie.data.point?this.cursor_.rawValue=Math.floor(Mr(Ie.data.point.x,0,Ie.data.bounds.width,0,this.value.rawValue.length)):this.cursor_.rawValue=-1}onGraphPointerUp_(){this.cursor_.rawValue=-1}}function To(ft){return"format"in ft&&!C(ft.format)?ft.format:Vr(2)}function is(ft){return"view"in ft&&ft.view==="graph"}const zc={id:"monitor-number",type:"monitor",accept:(ft,Ie)=>{if(typeof ft!="number")return null;const Ye=Vt,vt=si(Ie,{format:Ye.optional.function,lineCount:Ye.optional.number,max:Ye.optional.number,min:Ye.optional.number,view:Ye.optional.string});return vt?{initialValue:ft,params:vt}:null},binding:{defaultBufferSize:ft=>is(ft)?64:1,reader:ft=>wu},controller:ft=>is(ft.params)?function(Ie){var Ye,vt,Dt;return new yr(Ie.document,{formatter:To(Ie.params),lineCount:(Ye=Ie.params.lineCount)!==null&&Ye!==void 0?Ye:So.defaultLineCount,props:Bt.fromObject({maxValue:(vt="max"in Ie.params?Ie.params.max:null)!==null&&vt!==void 0?vt:100,minValue:(Dt="min"in Ie.params?Ie.params.min:null)!==null&&Dt!==void 0?Dt:0}),value:Ie.value,viewProps:Ie.viewProps})}(ft):function(Ie){var Ye;return Ie.value.rawValue.length===1?new Fl(Ie.document,{formatter:To(Ie.params),value:Ie.value,viewProps:Ie.viewProps}):new Gc(Ie.document,{formatter:To(Ie.params),lineCount:(Ye=Ie.params.lineCount)!==null&&Ye!==void 0?Ye:So.defaultLineCount,value:Ie.value,viewProps:Ie.viewProps})}(ft)},cs={id:"monitor-string",type:"monitor",accept:(ft,Ie)=>{if(typeof ft!="string")return null;const Ye=Vt,vt=si(Ie,{lineCount:Ye.optional.number,multiline:Ye.optional.boolean});return vt?{initialValue:ft,params:vt}:null},binding:{reader:ft=>xc},controller:ft=>{var Ie;const Ye=ft.value;return Ye.rawValue.length>1||"multiline"in ft.params&&ft.params.multiline?new Gc(ft.document,{formatter:Yo,lineCount:(Ie=ft.params.lineCount)!==null&&Ie!==void 0?Ie:So.defaultLineCount,value:Ye,viewProps:ft.viewProps}):new Fl(ft.document,{formatter:Yo,value:Ye,viewProps:ft.viewProps})}};function ba(ft,Ie){return Ie===0?new uo:new rs(ft,Ie??So.defaultInterval)}class xa{constructor(){this.pluginsMap_={blades:[],inputs:[],monitors:[]}}getAll(){return[...this.pluginsMap_.blades,...this.pluginsMap_.inputs,...this.pluginsMap_.monitors]}register(Ie){Ie.type==="blade"?this.pluginsMap_.blades.unshift(Ie):Ie.type==="input"?this.pluginsMap_.inputs.unshift(Ie):Ie.type==="monitor"&&this.pluginsMap_.monitors.unshift(Ie)}createInput(Ie,Ye,vt){if(C(Ye.read()))throw new ce({context:{key:Ye.key},type:"nomatchingcontroller"});const Dt=this.pluginsMap_.inputs.reduce((zt,ni)=>zt??function(Di,rn){var Bn;const tr=Di.accept(rn.target.read(),rn.params);if(C(tr))return null;const Wr=Vt,go={target:rn.target,initialValue:tr.initialValue,params:tr.params},bo=Di.binding.reader(go),Cn=Di.binding.constraint?Di.binding.constraint(go):void 0,qc=Lt(bo(tr.initialValue),{constraint:Cn,equals:Di.binding.equals}),Vl=new uc({reader:bo,target:rn.target,value:qc,writer:Di.binding.writer(go)}),xo=Wr.optional.boolean(rn.params.disabled).value,wa=Wr.optional.boolean(rn.params.hidden).value,ds=Di.controller({constraint:Cn,document:rn.document,initialValue:tr.initialValue,params:tr.params,value:Vl.value,viewProps:ci.create({disabled:xo,hidden:wa})});return new pn(rn.document,{binding:Vl,blade:xi(),props:Bt.fromObject({label:"label"in rn.params?(Bn=Wr.optional.string(rn.params.label).value)!==null&&Bn!==void 0?Bn:null:rn.target.key}),valueController:ds})}(ni,{document:Ie,target:Ye,params:vt}),null);if(Dt)return Dt;throw new ce({context:{key:Ye.key},type:"nomatchingcontroller"})}createMonitor(Ie,Ye,vt){const Dt=this.pluginsMap_.monitors.reduce((zt,ni)=>zt??function(Di,rn){var Bn,tr,Wr;const go=Vt,bo=Di.accept(rn.target.read(),rn.params);if(C(bo))return null;const Cn={target:rn.target,initialValue:bo.initialValue,params:bo.params},qc=Di.binding.reader(Cn),Vl=(tr=(Bn=go.optional.number(rn.params.bufferSize).value)!==null&&Bn!==void 0?Bn:Di.binding.defaultBufferSize&&Di.binding.defaultBufferSize(bo.params))!==null&&tr!==void 0?tr:1,xo=go.optional.number(rn.params.interval).value,wa=new bu({reader:qc,target:rn.target,ticker:ba(rn.document,xo),value:dc(Vl)}),ds=go.optional.boolean(rn.params.disabled).value,Co=go.optional.boolean(rn.params.hidden).value,Xa=Di.controller({document:rn.document,params:bo.params,value:wa.value,viewProps:ci.create({disabled:ds,hidden:Co})});return new nn(rn.document,{binding:wa,blade:xi(),props:Bt.fromObject({label:"label"in rn.params?(Wr=go.optional.string(rn.params.label).value)!==null&&Wr!==void 0?Wr:null:rn.target.key}),valueController:Xa})}(ni,{document:Ie,params:vt,target:Ye}),null);if(Dt)return Dt;throw new ce({context:{key:Ye.key},type:"nomatchingcontroller"})}createBlade(Ie,Ye){const vt=this.pluginsMap_.blades.reduce((Dt,zt)=>Dt??function(ni,Di){const rn=ni.accept(Di.params);if(!rn)return null;const Bn=Vt.optional.boolean(Di.params.disabled).value,tr=Vt.optional.boolean(Di.params.hidden).value;return ni.controller({blade:xi(),document:Di.document,params:Object.assign(Object.assign({},rn.params),{disabled:Bn,hidden:tr}),viewProps:ci.create({disabled:Bn,hidden:tr})})}(zt,{document:Ie,params:Ye}),null);if(!vt)throw new ce({type:"nomatchingview",context:{params:Ye}});return vt}createBladeApi(Ie){if(Ie instanceof pn)return new an(Ie);if(Ie instanceof nn)return new Yi(Ie);if(Ie instanceof Fi)return new fn(Ie,this);const Ye=this.pluginsMap_.blades.reduce((vt,Dt)=>vt??Dt.api({controller:Ie,pool:this}),null);if(!Ye)throw ce.shouldNeverHappen();return Ye}}function Hu(ft){return Vo.isObject(ft)?new Vo(ft.x,ft.y):new Vo}function Vc(ft,Ie){ft.writeProperty("x",Ie.x),ft.writeProperty("y",Ie.y)}function Qo(ft,Ie){if(!ft)return;const Ye=[],vt=Oo(ft,Ie);vt&&Ye.push(vt);const Dt=Zo(ft);return Dt&&Ye.push(Dt),new Is(Ye)}function jl(ft,Ie){const[Ye,vt]=ft?function(zt){const ni=Fo(zt,gs);if(ni)return[ni.values.get("min"),ni.values.get("max")];const Di=Fo(zt,ml);return Di?[Di.minValue,Di.maxValue]:[void 0,void 0]}(ft):[];if(!C(Ye)||!C(vt))return Math.max(Math.abs(Ye??0),Math.abs(vt??0));const Dt=Ns(ft);return Math.max(10*Math.abs(Dt),10*Math.abs(Ie))}function Gl(ft,Ie){const Ye=Ie instanceof Jo?Ie.components[0]:void 0,vt=Ie instanceof Jo?Ie.components[1]:void 0,Dt=jl(Ye,ft.x),zt=jl(vt,ft.y);return Math.max(Dt,zt)}function fo(ft,Ie){return{baseStep:Ns(Ie),constraint:Ie,textProps:Bt.fromObject({draggingScale:ks(Ie,ft),formatter:Vr(ja(Ie,ft))})}}function gh(ft){if(!("y"in ft))return!1;const Ie=ft.y;return!!Ie&&"inverted"in Ie&&!!Ie.inverted}const no={id:"input-point2d",type:"input",accept:(ft,Ie)=>{if(!Vo.isObject(ft))return null;const Ye=Vt,vt=si(Ie,{expanded:Ye.optional.boolean,picker:Ye.optional.custom(Eu),x:Ye.optional.custom(_s),y:Ye.optional.object({inverted:Ye.optional.boolean,max:Ye.optional.number,min:Ye.optional.number,step:Ye.optional.number})});return vt?{initialValue:ft,params:vt}:null},binding:{reader:ft=>Hu,constraint:ft=>{return Ie=ft.params,Ye=ft.initialValue,new Jo({assembly:ls,components:[Qo("x"in Ie?Ie.x:void 0,Ye.x),Qo("y"in Ie?Ie.y:void 0,Ye.y)]});var Ie,Ye},equals:Vo.equals,writer:ft=>Vc},controller:ft=>{const Ie=ft.document,Ye=ft.value,vt=ft.constraint;if(!(vt instanceof Jo))throw ce.shouldNeverHappen();const Dt="expanded"in ft.params?ft.params.expanded:void 0,zt="picker"in ft.params?ft.params.picker:void 0;return new Ho(Ie,{axes:[fo(Ye.rawValue.x,vt.components[0]),fo(Ye.rawValue.y,vt.components[1])],expanded:Dt!=null&&Dt,invertsY:gh(ft.params),maxValue:Gl(Ye.rawValue,vt),parser:os,pickerLayout:zt??"popup",value:Ye,viewProps:ft.viewProps})}};class Hc extends c{constructor(Ie){super(Ie),this.emitter_=new Oe,this.controller_.valueController.value.emitter.on("change",Ye=>{this.emitter_.emit("change",{event:new h(this,Ye.rawValue)})})}get label(){return this.controller_.props.get("label")}set label(Ie){this.controller_.props.set("label",Ie)}get options(){return this.controller_.valueController.props.get("options")}set options(Ie){this.controller_.valueController.props.set("options",Ie)}get value(){return this.controller_.valueController.value.rawValue}set value(Ie){this.controller_.valueController.value.rawValue=Ie}on(Ie,Ye){const vt=Ye.bind(this);return this.emitter_.on(Ie,Dt=>{vt(Dt.event)}),this}}class Qc extends c{constructor(Ie){super(Ie),this.emitter_=new Oe,this.controller_.valueController.value.emitter.on("change",Ye=>{this.emitter_.emit("change",{event:new h(this,Ye.rawValue)})})}get label(){return this.controller_.props.get("label")}set label(Ie){this.controller_.props.set("label",Ie)}get maxValue(){return this.controller_.valueController.sliderController.props.get("maxValue")}set maxValue(Ie){this.controller_.valueController.sliderController.props.set("maxValue",Ie)}get minValue(){return this.controller_.valueController.sliderController.props.get("minValue")}set minValue(Ie){this.controller_.valueController.sliderController.props.set("minValue",Ie)}get value(){return this.controller_.valueController.value.rawValue}set value(Ie){this.controller_.valueController.value.rawValue=Ie}on(Ie,Ye){const vt=Ye.bind(this);return this.emitter_.on(Ie,Dt=>{vt(Dt.event)}),this}}class us extends c{constructor(Ie){super(Ie),this.emitter_=new Oe,this.controller_.valueController.value.emitter.on("change",Ye=>{this.emitter_.emit("change",{event:new h(this,Ye.rawValue)})})}get label(){return this.controller_.props.get("label")}set label(Ie){this.controller_.props.set("label",Ie)}get formatter(){return this.controller_.valueController.props.get("formatter")}set formatter(Ie){this.controller_.valueController.props.set("formatter",Ie)}get value(){return this.controller_.valueController.value.rawValue}set value(Ie){this.controller_.valueController.value.rawValue=Ie}on(Ie,Ye){const vt=Ye.bind(this);return this.emitter_.on(Ie,Dt=>{vt(Dt.event)}),this}}const zl={id:"list",type:"blade",accept(ft){const Ie=Vt,Ye=si(ft,{options:Ie.required.custom(El),value:Ie.required.raw,view:Ie.required.constant("list"),label:Ie.optional.string});return Ye?{params:Ye}:null},controller(ft){const Ie=new Rs(Su(ft.params.options)),Ye=Lt(ft.params.value,{constraint:Ie}),vt=new Ds(ft.document,{props:new Bt({options:Ie.values.value("options")}),value:Ye,viewProps:ft.viewProps});return new qn(ft.document,{blade:ft.blade,props:Bt.fromObject({label:ft.params.label}),valueController:vt})},api(ft){return ft.controller instanceof qn&&ft.controller.valueController instanceof Ds?new Hc(ft.controller):null}};class Wc extends Fn{constructor(Ie,Ye){super(Ie,Ye)}get element(){return this.controller_.view.element}importPreset(Ie){(function(Ye,vt){Ye.forEach(Dt=>{const zt=vt[Dt.target.presetKey];zt!==void 0&&Dt.writer(Dt.target,Dt.reader(zt))})})(this.controller_.rackController.rack.find(pn).map(Ye=>Ye.binding),Ie),this.refresh()}exportPreset(){return this.controller_.rackController.rack.find(pn).map(Ie=>Ie.binding.target).reduce((Ie,Ye)=>Object.assign(Ie,{[Ye.presetKey]:Ye.read()}),{})}refresh(){this.controller_.rackController.rack.find(pn).forEach(Ie=>{Ie.binding.read()}),this.controller_.rackController.rack.find(nn).forEach(Ie=>{Ie.binding.read()})}}class Dn extends yn{constructor(Ie,Ye){super(Ie,{expanded:Ye.expanded,blade:Ye.blade,props:Ye.props,root:!0,viewProps:Ye.viewProps})}}const ro={id:"slider",type:"blade",accept(ft){const Ie=Vt,Ye=si(ft,{max:Ie.required.number,min:Ie.required.number,view:Ie.required.constant("slider"),format:Ie.optional.function,label:Ie.optional.string,value:Ie.optional.number});return Ye?{params:Ye}:null},controller(ft){var Ie,Ye;const vt=(Ie=ft.params.value)!==null&&Ie!==void 0?Ie:0,Dt=new gs({max:ft.params.max,min:ft.params.min}),zt=new Sc(ft.document,{baseStep:1,parser:os,sliderProps:new Bt({maxValue:Dt.values.value("max"),minValue:Dt.values.value("min")}),textProps:Bt.fromObject({draggingScale:ks(void 0,vt),formatter:(Ye=ft.params.format)!==null&&Ye!==void 0?Ye:rh}),value:Lt(vt,{constraint:Dt}),viewProps:ft.viewProps});return new qn(ft.document,{blade:ft.blade,props:Bt.fromObject({label:ft.params.label}),valueController:zt})},api(ft){return ft.controller instanceof qn&&ft.controller.valueController instanceof Sc?new Qc(ft.controller):null}},Ss={id:"text",type:"blade",accept(ft){const Ie=Vt,Ye=si(ft,{parse:Ie.required.function,value:Ie.required.raw,view:Ie.required.constant("text"),format:Ie.optional.function,label:Ie.optional.string});return Ye?{params:Ye}:null},controller(ft){var Ie;const Ye=new Zs(ft.document,{parser:ft.params.parse,props:Bt.fromObject({formatter:(Ie=ft.params.format)!==null&&Ie!==void 0?Ie:vt=>String(vt)}),value:Lt(ft.params.value),viewProps:ft.viewProps});return new qn(ft.document,{blade:ft.blade,props:Bt.fromObject({label:ft.params.label}),valueController:Ye})},api(ft){return ft.controller instanceof qn&&ft.controller.valueController instanceof Zs?new us(ft.controller):null}};function ns(ft,Ie,Ye){if(ft.querySelector(`style[data-tp-style=${Ie}]`))return;const vt=ft.createElement("style");vt.dataset.tpStyle=Ie,vt.textContent=Ye,ft.head.appendChild(vt)}const _h=new class{constructor(ft){const[Ie,Ye]=ft.split("-"),vt=Ie.split(".");this.major=parseInt(vt[0],10),this.minor=parseInt(vt[1],10),this.patch=parseInt(vt[2],10),this.prerelease=Ye??null}toString(){const ft=[this.major,this.minor,this.patch].join(".");return this.prerelease!==null?[ft,this.prerelease].join("-"):ft}}("3.1.10");l.BladeApi=c,l.ButtonApi=ye,l.FolderApi=Fn,l.InputBindingApi=an,l.ListApi=Hc,l.MonitorBindingApi=Yi,l.Pane=class extends Wc{constructor(ft){var Ie,Ye;const vt=ft??{},Dt=(Ie=vt.document)!==null&&Ie!==void 0?Ie:Xi(),zt=function(){const ni=new xa;return[no,Fu,ju,Aa,jc,Qs,Ll,Hs,Mu,Vu,cs,zc,li,Tn,Nr,Uo].forEach(Di=>{ni.register(Di)}),ni}();super(new Dn(Dt,{expanded:vt.expanded,blade:xi(),props:Bt.fromObject({title:vt.title}),viewProps:ci.create()}),zt),this.pool_=zt,this.containerElem_=(Ye=vt.container)!==null&&Ye!==void 0?Ye:function(ni){const Di=ni.createElement("div");return Di.classList.add(Ve("dfw")()),ni.body&&ni.body.appendChild(Di),Di}(Dt),this.containerElem_.appendChild(this.element),this.doc_=Dt,this.usesDefaultWrapper_=!vt.container,this.setUpDefaultPlugins_()}get document(){if(!this.doc_)throw ce.alreadyDisposed();return this.doc_}dispose(){const ft=this.containerElem_;if(!ft)throw ce.alreadyDisposed();if(this.usesDefaultWrapper_){const Ie=ft.parentElement;Ie&&Ie.removeChild(ft)}this.containerElem_=null,this.doc_=null,super.dispose()}registerPlugin(ft){("plugin"in ft?[ft.plugin]:"plugins"in ft?ft.plugins:[]).forEach(Ie=>{this.pool_.register(Ie),this.embedPluginStyle_(Ie)})}embedPluginStyle_(ft){ft.css&&ns(this.document,`plugin-${ft.id}`,ft.css)}setUpDefaultPlugins_(){ns(this.document,"default",'.tp-tbiv_b,.tp-coltxtv_ms,.tp-ckbv_i,.tp-rotv_b,.tp-fldv_b,.tp-mllv_i,.tp-sglv_i,.tp-grlv_g,.tp-txtv_i,.tp-p2dpv_p,.tp-colswv_sw,.tp-p2dv_b,.tp-btnv_b,.tp-lstv_s{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:rgba(0,0,0,0);border-width:0;font-family:inherit;font-size:inherit;font-weight:inherit;margin:0;outline:none;padding:0}.tp-p2dv_b,.tp-btnv_b,.tp-lstv_s{background-color:var(--btn-bg);border-radius:var(--elm-br);color:var(--btn-fg);cursor:pointer;display:block;font-weight:bold;height:var(--bld-us);line-height:var(--bld-us);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.tp-p2dv_b:hover,.tp-btnv_b:hover,.tp-lstv_s:hover{background-color:var(--btn-bg-h)}.tp-p2dv_b:focus,.tp-btnv_b:focus,.tp-lstv_s:focus{background-color:var(--btn-bg-f)}.tp-p2dv_b:active,.tp-btnv_b:active,.tp-lstv_s:active{background-color:var(--btn-bg-a)}.tp-p2dv_b:disabled,.tp-btnv_b:disabled,.tp-lstv_s:disabled{opacity:.5}.tp-txtv_i,.tp-p2dpv_p,.tp-colswv_sw{background-color:var(--in-bg);border-radius:var(--elm-br);box-sizing:border-box;color:var(--in-fg);font-family:inherit;height:var(--bld-us);line-height:var(--bld-us);min-width:0;width:100%}.tp-txtv_i:hover,.tp-p2dpv_p:hover,.tp-colswv_sw:hover{background-color:var(--in-bg-h)}.tp-txtv_i:focus,.tp-p2dpv_p:focus,.tp-colswv_sw:focus{background-color:var(--in-bg-f)}.tp-txtv_i:active,.tp-p2dpv_p:active,.tp-colswv_sw:active{background-color:var(--in-bg-a)}.tp-txtv_i:disabled,.tp-p2dpv_p:disabled,.tp-colswv_sw:disabled{opacity:.5}.tp-mllv_i,.tp-sglv_i,.tp-grlv_g{background-color:var(--mo-bg);border-radius:var(--elm-br);box-sizing:border-box;color:var(--mo-fg);height:var(--bld-us);scrollbar-color:currentColor rgba(0,0,0,0);scrollbar-width:thin;width:100%}.tp-mllv_i::-webkit-scrollbar,.tp-sglv_i::-webkit-scrollbar,.tp-grlv_g::-webkit-scrollbar{height:8px;width:8px}.tp-mllv_i::-webkit-scrollbar-corner,.tp-sglv_i::-webkit-scrollbar-corner,.tp-grlv_g::-webkit-scrollbar-corner{background-color:rgba(0,0,0,0)}.tp-mllv_i::-webkit-scrollbar-thumb,.tp-sglv_i::-webkit-scrollbar-thumb,.tp-grlv_g::-webkit-scrollbar-thumb{background-clip:padding-box;background-color:currentColor;border:rgba(0,0,0,0) solid 2px;border-radius:4px}.tp-rotv{--font-family: var(--tp-font-family, Roboto Mono, Source Code Pro, Menlo, Courier, monospace);--bs-br: var(--tp-base-border-radius, 6px);--cnt-h-p: var(--tp-container-horizontal-padding, 4px);--cnt-v-p: var(--tp-container-vertical-padding, 4px);--elm-br: var(--tp-element-border-radius, 2px);--bld-s: var(--tp-blade-spacing, 4px);--bld-us: var(--tp-blade-unit-size, 20px);--bs-bg: var(--tp-base-background-color, hsl(230, 7%, 17%));--bs-sh: var(--tp-base-shadow-color, rgba(0, 0, 0, 0.2));--btn-bg: var(--tp-button-background-color, hsl(230, 7%, 70%));--btn-bg-a: var(--tp-button-background-color-active, #d6d7db);--btn-bg-f: var(--tp-button-background-color-focus, #c8cad0);--btn-bg-h: var(--tp-button-background-color-hover, #bbbcc4);--btn-fg: var(--tp-button-foreground-color, hsl(230, 7%, 17%));--cnt-bg: var(--tp-container-background-color, rgba(187, 188, 196, 0.1));--cnt-bg-a: var(--tp-container-background-color-active, rgba(187, 188, 196, 0.25));--cnt-bg-f: var(--tp-container-background-color-focus, rgba(187, 188, 196, 0.2));--cnt-bg-h: var(--tp-container-background-color-hover, rgba(187, 188, 196, 0.15));--cnt-fg: var(--tp-container-foreground-color, hsl(230, 7%, 75%));--in-bg: var(--tp-input-background-color, rgba(187, 188, 196, 0.1));--in-bg-a: var(--tp-input-background-color-active, rgba(187, 188, 196, 0.25));--in-bg-f: var(--tp-input-background-color-focus, rgba(187, 188, 196, 0.2));--in-bg-h: var(--tp-input-background-color-hover, rgba(187, 188, 196, 0.15));--in-fg: var(--tp-input-foreground-color, hsl(230, 7%, 75%));--lbl-fg: var(--tp-label-foreground-color, rgba(187, 188, 196, 0.7));--mo-bg: var(--tp-monitor-background-color, rgba(0, 0, 0, 0.2));--mo-fg: var(--tp-monitor-foreground-color, rgba(187, 188, 196, 0.7));--grv-fg: var(--tp-groove-foreground-color, rgba(187, 188, 196, 0.1))}.tp-rotv_c>.tp-cntv.tp-v-lst,.tp-tabv_c .tp-brkv>.tp-cntv.tp-v-lst,.tp-fldv_c>.tp-cntv.tp-v-lst{margin-bottom:calc(-1*var(--cnt-v-p))}.tp-rotv_c>.tp-fldv.tp-v-lst .tp-fldv_c,.tp-tabv_c .tp-brkv>.tp-fldv.tp-v-lst .tp-fldv_c,.tp-fldv_c>.tp-fldv.tp-v-lst .tp-fldv_c{border-bottom-left-radius:0}.tp-rotv_c>.tp-fldv.tp-v-lst .tp-fldv_b,.tp-tabv_c .tp-brkv>.tp-fldv.tp-v-lst .tp-fldv_b,.tp-fldv_c>.tp-fldv.tp-v-lst .tp-fldv_b{border-bottom-left-radius:0}.tp-rotv_c>*:not(.tp-v-fst),.tp-tabv_c .tp-brkv>*:not(.tp-v-fst),.tp-fldv_c>*:not(.tp-v-fst){margin-top:var(--bld-s)}.tp-rotv_c>.tp-sprv:not(.tp-v-fst),.tp-tabv_c .tp-brkv>.tp-sprv:not(.tp-v-fst),.tp-fldv_c>.tp-sprv:not(.tp-v-fst),.tp-rotv_c>.tp-cntv:not(.tp-v-fst),.tp-tabv_c .tp-brkv>.tp-cntv:not(.tp-v-fst),.tp-fldv_c>.tp-cntv:not(.tp-v-fst){margin-top:var(--cnt-v-p)}.tp-rotv_c>.tp-sprv+*:not(.tp-v-hidden),.tp-tabv_c .tp-brkv>.tp-sprv+*:not(.tp-v-hidden),.tp-fldv_c>.tp-sprv+*:not(.tp-v-hidden),.tp-rotv_c>.tp-cntv+*:not(.tp-v-hidden),.tp-tabv_c .tp-brkv>.tp-cntv+*:not(.tp-v-hidden),.tp-fldv_c>.tp-cntv+*:not(.tp-v-hidden){margin-top:var(--cnt-v-p)}.tp-rotv_c>.tp-sprv:not(.tp-v-hidden)+.tp-sprv,.tp-tabv_c .tp-brkv>.tp-sprv:not(.tp-v-hidden)+.tp-sprv,.tp-fldv_c>.tp-sprv:not(.tp-v-hidden)+.tp-sprv,.tp-rotv_c>.tp-cntv:not(.tp-v-hidden)+.tp-cntv,.tp-tabv_c .tp-brkv>.tp-cntv:not(.tp-v-hidden)+.tp-cntv,.tp-fldv_c>.tp-cntv:not(.tp-v-hidden)+.tp-cntv{margin-top:0}.tp-tabv_c .tp-brkv>.tp-cntv,.tp-fldv_c>.tp-cntv{margin-left:4px}.tp-tabv_c .tp-brkv>.tp-fldv>.tp-fldv_b,.tp-fldv_c>.tp-fldv>.tp-fldv_b{border-top-left-radius:var(--elm-br);border-bottom-left-radius:var(--elm-br)}.tp-tabv_c .tp-brkv>.tp-fldv.tp-fldv-expanded>.tp-fldv_b,.tp-fldv_c>.tp-fldv.tp-fldv-expanded>.tp-fldv_b{border-bottom-left-radius:0}.tp-tabv_c .tp-brkv .tp-fldv>.tp-fldv_c,.tp-fldv_c .tp-fldv>.tp-fldv_c{border-bottom-left-radius:var(--elm-br)}.tp-tabv_c .tp-brkv>.tp-cntv+.tp-fldv>.tp-fldv_b,.tp-fldv_c>.tp-cntv+.tp-fldv>.tp-fldv_b{border-top-left-radius:0}.tp-tabv_c .tp-brkv>.tp-cntv+.tp-tabv>.tp-tabv_t,.tp-fldv_c>.tp-cntv+.tp-tabv>.tp-tabv_t{border-top-left-radius:0}.tp-tabv_c .tp-brkv>.tp-tabv>.tp-tabv_t,.tp-fldv_c>.tp-tabv>.tp-tabv_t{border-top-left-radius:var(--elm-br)}.tp-tabv_c .tp-brkv .tp-tabv>.tp-tabv_c,.tp-fldv_c .tp-tabv>.tp-tabv_c{border-bottom-left-radius:var(--elm-br)}.tp-rotv_b,.tp-fldv_b{background-color:var(--cnt-bg);color:var(--cnt-fg);cursor:pointer;display:block;height:calc(var(--bld-us) + 4px);line-height:calc(var(--bld-us) + 4px);overflow:hidden;padding-left:var(--cnt-h-p);padding-right:calc(4px + var(--bld-us) + var(--cnt-h-p));position:relative;text-align:left;text-overflow:ellipsis;white-space:nowrap;width:100%;transition:border-radius .2s ease-in-out .2s}.tp-rotv_b:hover,.tp-fldv_b:hover{background-color:var(--cnt-bg-h)}.tp-rotv_b:focus,.tp-fldv_b:focus{background-color:var(--cnt-bg-f)}.tp-rotv_b:active,.tp-fldv_b:active{background-color:var(--cnt-bg-a)}.tp-rotv_b:disabled,.tp-fldv_b:disabled{opacity:.5}.tp-rotv_m,.tp-fldv_m{background:linear-gradient(to left, var(--cnt-fg), var(--cnt-fg) 2px, transparent 2px, transparent 4px, var(--cnt-fg) 4px);border-radius:2px;bottom:0;content:"";display:block;height:6px;right:calc(var(--cnt-h-p) + (var(--bld-us) + 4px - 6px)/2 - 2px);margin:auto;opacity:.5;position:absolute;top:0;transform:rotate(90deg);transition:transform .2s ease-in-out;width:6px}.tp-rotv.tp-rotv-expanded .tp-rotv_m,.tp-fldv.tp-fldv-expanded>.tp-fldv_b>.tp-fldv_m{transform:none}.tp-rotv_c,.tp-fldv_c{box-sizing:border-box;height:0;opacity:0;overflow:hidden;padding-bottom:0;padding-top:0;position:relative;transition:height .2s ease-in-out,opacity .2s linear,padding .2s ease-in-out}.tp-rotv.tp-rotv-cpl:not(.tp-rotv-expanded) .tp-rotv_c,.tp-fldv.tp-fldv-cpl:not(.tp-fldv-expanded)>.tp-fldv_c{display:none}.tp-rotv.tp-rotv-expanded .tp-rotv_c,.tp-fldv.tp-fldv-expanded>.tp-fldv_c{opacity:1;padding-bottom:var(--cnt-v-p);padding-top:var(--cnt-v-p);transform:none;overflow:visible;transition:height .2s ease-in-out,opacity .2s linear .2s,padding .2s ease-in-out}.tp-lstv,.tp-coltxtv_m{position:relative}.tp-lstv_s{padding:0 20px 0 4px;width:100%}.tp-lstv_m,.tp-coltxtv_mm{bottom:0;margin:auto;pointer-events:none;position:absolute;right:2px;top:0}.tp-lstv_m svg,.tp-coltxtv_mm svg{bottom:0;height:16px;margin:auto;position:absolute;right:0;top:0;width:16px}.tp-lstv_m svg path,.tp-coltxtv_mm svg path{fill:currentColor}.tp-pndtxtv,.tp-coltxtv_w{display:flex}.tp-pndtxtv_a,.tp-coltxtv_c{width:100%}.tp-pndtxtv_a+.tp-pndtxtv_a,.tp-coltxtv_c+.tp-pndtxtv_a,.tp-pndtxtv_a+.tp-coltxtv_c,.tp-coltxtv_c+.tp-coltxtv_c{margin-left:2px}.tp-btnv_b{width:100%}.tp-btnv_t{text-align:center}.tp-ckbv_l{display:block;position:relative}.tp-ckbv_i{left:0;opacity:0;position:absolute;top:0}.tp-ckbv_w{background-color:var(--in-bg);border-radius:var(--elm-br);cursor:pointer;display:block;height:var(--bld-us);position:relative;width:var(--bld-us)}.tp-ckbv_w svg{bottom:0;display:block;height:16px;left:0;margin:auto;opacity:0;position:absolute;right:0;top:0;width:16px}.tp-ckbv_w svg path{fill:none;stroke:var(--in-fg);stroke-width:2}.tp-ckbv_i:hover+.tp-ckbv_w{background-color:var(--in-bg-h)}.tp-ckbv_i:focus+.tp-ckbv_w{background-color:var(--in-bg-f)}.tp-ckbv_i:active+.tp-ckbv_w{background-color:var(--in-bg-a)}.tp-ckbv_i:checked+.tp-ckbv_w svg{opacity:1}.tp-ckbv.tp-v-disabled .tp-ckbv_w{opacity:.5}.tp-colv{position:relative}.tp-colv_h{display:flex}.tp-colv_s{flex-grow:0;flex-shrink:0;width:var(--bld-us)}.tp-colv_t{flex:1;margin-left:4px}.tp-colv_p{height:0;margin-top:0;opacity:0;overflow:hidden;transition:height .2s ease-in-out,opacity .2s linear,margin .2s ease-in-out}.tp-colv.tp-colv-expanded.tp-colv-cpl .tp-colv_p{overflow:visible}.tp-colv.tp-colv-expanded .tp-colv_p{margin-top:var(--bld-s);opacity:1}.tp-colv .tp-popv{left:calc(-1*var(--cnt-h-p));right:calc(-1*var(--cnt-h-p));top:var(--bld-us)}.tp-colpv_h,.tp-colpv_ap{margin-left:6px;margin-right:6px}.tp-colpv_h{margin-top:var(--bld-s)}.tp-colpv_rgb{display:flex;margin-top:var(--bld-s);width:100%}.tp-colpv_a{display:flex;margin-top:var(--cnt-v-p);padding-top:calc(var(--cnt-v-p) + 2px);position:relative}.tp-colpv_a::before{background-color:var(--grv-fg);content:"";height:2px;left:calc(-1*var(--cnt-h-p));position:absolute;right:calc(-1*var(--cnt-h-p));top:0}.tp-colpv.tp-v-disabled .tp-colpv_a::before{opacity:.5}.tp-colpv_ap{align-items:center;display:flex;flex:3}.tp-colpv_at{flex:1;margin-left:4px}.tp-svpv{border-radius:var(--elm-br);outline:none;overflow:hidden;position:relative}.tp-svpv.tp-v-disabled{opacity:.5}.tp-svpv_c{cursor:crosshair;display:block;height:calc(var(--bld-us)*4);width:100%}.tp-svpv_m{border-radius:100%;border:rgba(255,255,255,.75) solid 2px;box-sizing:border-box;filter:drop-shadow(0 0 1px rgba(0, 0, 0, 0.3));height:12px;margin-left:-6px;margin-top:-6px;pointer-events:none;position:absolute;width:12px}.tp-svpv:focus .tp-svpv_m{border-color:#fff}.tp-hplv{cursor:pointer;height:var(--bld-us);outline:none;position:relative}.tp-hplv.tp-v-disabled{opacity:.5}.tp-hplv_c{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAABCAYAAABubagXAAAAQ0lEQVQoU2P8z8Dwn0GCgQEDi2OK/RBgYHjBgIpfovFh8j8YBIgzFGQxuqEgPhaDOT5gOhPkdCxOZeBg+IDFZZiGAgCaSSMYtcRHLgAAAABJRU5ErkJggg==);background-position:left top;background-repeat:no-repeat;background-size:100% 100%;border-radius:2px;display:block;height:4px;left:0;margin-top:-2px;position:absolute;top:50%;width:100%}.tp-hplv_m{border-radius:var(--elm-br);border:rgba(255,255,255,.75) solid 2px;box-shadow:0 0 2px rgba(0,0,0,.1);box-sizing:border-box;height:12px;left:50%;margin-left:-6px;margin-top:-6px;pointer-events:none;position:absolute;top:50%;width:12px}.tp-hplv:focus .tp-hplv_m{border-color:#fff}.tp-aplv{cursor:pointer;height:var(--bld-us);outline:none;position:relative;width:100%}.tp-aplv.tp-v-disabled{opacity:.5}.tp-aplv_b{background-color:#fff;background-image:linear-gradient(to top right, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%),linear-gradient(to top right, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%);background-size:4px 4px;background-position:0 0,2px 2px;border-radius:2px;display:block;height:4px;left:0;margin-top:-2px;overflow:hidden;position:absolute;top:50%;width:100%}.tp-aplv_c{bottom:0;left:0;position:absolute;right:0;top:0}.tp-aplv_m{background-color:#fff;background-image:linear-gradient(to top right, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%),linear-gradient(to top right, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%);background-size:12px 12px;background-position:0 0,6px 6px;border-radius:var(--elm-br);box-shadow:0 0 2px rgba(0,0,0,.1);height:12px;left:50%;margin-left:-6px;margin-top:-6px;overflow:hidden;pointer-events:none;position:absolute;top:50%;width:12px}.tp-aplv_p{border-radius:var(--elm-br);border:rgba(255,255,255,.75) solid 2px;box-sizing:border-box;bottom:0;left:0;position:absolute;right:0;top:0}.tp-aplv:focus .tp-aplv_p{border-color:#fff}.tp-colswv{background-color:#fff;background-image:linear-gradient(to top right, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%),linear-gradient(to top right, #ddd 25%, transparent 25%, transparent 75%, #ddd 75%);background-size:10px 10px;background-position:0 0,5px 5px;border-radius:var(--elm-br);overflow:hidden}.tp-colswv.tp-v-disabled{opacity:.5}.tp-colswv_sw{border-radius:0}.tp-colswv_b{-webkit-appearance:none;-moz-appearance:none;appearance:none;background-color:rgba(0,0,0,0);border-width:0;cursor:pointer;display:block;height:var(--bld-us);left:0;margin:0;outline:none;padding:0;position:absolute;top:0;width:var(--bld-us)}.tp-colswv_b:focus::after{border:rgba(255,255,255,.75) solid 2px;border-radius:var(--elm-br);bottom:0;content:"";display:block;left:0;position:absolute;right:0;top:0}.tp-coltxtv{display:flex;width:100%}.tp-coltxtv_m{margin-right:4px}.tp-coltxtv_ms{border-radius:var(--elm-br);color:var(--lbl-fg);cursor:pointer;height:var(--bld-us);line-height:var(--bld-us);padding:0 18px 0 4px}.tp-coltxtv_ms:hover{background-color:var(--in-bg-h)}.tp-coltxtv_ms:focus{background-color:var(--in-bg-f)}.tp-coltxtv_ms:active{background-color:var(--in-bg-a)}.tp-coltxtv_mm{color:var(--lbl-fg)}.tp-coltxtv.tp-v-disabled .tp-coltxtv_mm{opacity:.5}.tp-coltxtv_w{flex:1}.tp-dfwv{position:absolute;top:8px;right:8px;width:256px}.tp-fldv{position:relative}.tp-fldv.tp-fldv-not .tp-fldv_b{display:none}.tp-fldv_t{padding-left:4px}.tp-fldv_b:disabled .tp-fldv_m{display:none}.tp-fldv_c{padding-left:4px}.tp-fldv_i{bottom:0;color:var(--cnt-bg);left:0;overflow:hidden;position:absolute;top:calc(var(--bld-us) + 4px);width:var(--bs-br)}.tp-fldv_i::before{background-color:currentColor;bottom:0;content:"";left:0;position:absolute;top:0;width:4px}.tp-fldv_b:hover+.tp-fldv_i{color:var(--cnt-bg-h)}.tp-fldv_b:focus+.tp-fldv_i{color:var(--cnt-bg-f)}.tp-fldv_b:active+.tp-fldv_i{color:var(--cnt-bg-a)}.tp-fldv.tp-v-disabled>.tp-fldv_i{opacity:.5}.tp-grlv{position:relative}.tp-grlv_g{display:block;height:calc(var(--bld-us)*3)}.tp-grlv_g polyline{fill:none;stroke:var(--mo-fg);stroke-linejoin:round}.tp-grlv_t{margin-top:-4px;transition:left .05s,top .05s;visibility:hidden}.tp-grlv_t.tp-grlv_t-a{visibility:visible}.tp-grlv_t.tp-grlv_t-in{transition:none}.tp-grlv.tp-v-disabled .tp-grlv_g{opacity:.5}.tp-grlv .tp-ttv{background-color:var(--mo-fg)}.tp-grlv .tp-ttv::before{border-top-color:var(--mo-fg)}.tp-lblv{align-items:center;display:flex;line-height:1.3;padding-left:var(--cnt-h-p);padding-right:var(--cnt-h-p)}.tp-lblv.tp-lblv-nol{display:block}.tp-lblv_l{color:var(--lbl-fg);flex:1;-webkit-hyphens:auto;hyphens:auto;overflow:hidden;padding-left:4px;padding-right:16px}.tp-lblv.tp-v-disabled .tp-lblv_l{opacity:.5}.tp-lblv.tp-lblv-nol .tp-lblv_l{display:none}.tp-lblv_v{align-self:flex-start;flex-grow:0;flex-shrink:0;width:160px}.tp-lblv.tp-lblv-nol .tp-lblv_v{width:100%}.tp-lstv_s{padding:0 20px 0 4px;width:100%}.tp-lstv_m{color:var(--btn-fg)}.tp-sglv_i{padding:0 4px}.tp-sglv.tp-v-disabled .tp-sglv_i{opacity:.5}.tp-mllv_i{display:block;height:calc(var(--bld-us)*3);line-height:var(--bld-us);padding:0 4px;resize:none;white-space:pre}.tp-mllv.tp-v-disabled .tp-mllv_i{opacity:.5}.tp-p2dv{position:relative}.tp-p2dv_h{display:flex}.tp-p2dv_b{height:var(--bld-us);margin-right:4px;position:relative;width:var(--bld-us)}.tp-p2dv_b svg{display:block;height:16px;left:50%;margin-left:-8px;margin-top:-8px;position:absolute;top:50%;width:16px}.tp-p2dv_b svg path{stroke:currentColor;stroke-width:2}.tp-p2dv_b svg circle{fill:currentColor}.tp-p2dv_t{flex:1}.tp-p2dv_p{height:0;margin-top:0;opacity:0;overflow:hidden;transition:height .2s ease-in-out,opacity .2s linear,margin .2s ease-in-out}.tp-p2dv.tp-p2dv-expanded .tp-p2dv_p{margin-top:var(--bld-s);opacity:1}.tp-p2dv .tp-popv{left:calc(-1*var(--cnt-h-p));right:calc(-1*var(--cnt-h-p));top:var(--bld-us)}.tp-p2dpv{padding-left:calc(var(--bld-us) + 4px)}.tp-p2dpv_p{cursor:crosshair;height:0;overflow:hidden;padding-bottom:100%;position:relative}.tp-p2dpv.tp-v-disabled .tp-p2dpv_p{opacity:.5}.tp-p2dpv_g{display:block;height:100%;left:0;pointer-events:none;position:absolute;top:0;width:100%}.tp-p2dpv_ax{opacity:.1;stroke:var(--in-fg);stroke-dasharray:1}.tp-p2dpv_l{opacity:.5;stroke:var(--in-fg);stroke-dasharray:1}.tp-p2dpv_m{border:var(--in-fg) solid 1px;border-radius:50%;box-sizing:border-box;height:4px;margin-left:-2px;margin-top:-2px;position:absolute;width:4px}.tp-p2dpv_p:focus .tp-p2dpv_m{background-color:var(--in-fg);border-width:0}.tp-popv{background-color:var(--bs-bg);border-radius:6px;box-shadow:0 2px 4px var(--bs-sh);display:none;max-width:168px;padding:var(--cnt-v-p) var(--cnt-h-p);position:absolute;visibility:hidden;z-index:1000}.tp-popv.tp-popv-v{display:block;visibility:visible}.tp-sprv_r{background-color:var(--grv-fg);border-width:0;display:block;height:2px;margin:0;width:100%}.tp-sprv.tp-v-disabled .tp-sprv_r{opacity:.5}.tp-sldv.tp-v-disabled{opacity:.5}.tp-sldv_t{box-sizing:border-box;cursor:pointer;height:var(--bld-us);margin:0 6px;outline:none;position:relative}.tp-sldv_t::before{background-color:var(--in-bg);border-radius:1px;bottom:0;content:"";display:block;height:2px;left:0;margin:auto;position:absolute;right:0;top:0}.tp-sldv_k{height:100%;left:0;position:absolute;top:0}.tp-sldv_k::before{background-color:var(--in-fg);border-radius:1px;bottom:0;content:"";display:block;height:2px;left:0;margin-bottom:auto;margin-top:auto;position:absolute;right:0;top:0}.tp-sldv_k::after{background-color:var(--btn-bg);border-radius:var(--elm-br);bottom:0;content:"";display:block;height:12px;margin-bottom:auto;margin-top:auto;position:absolute;right:-6px;top:0;width:12px}.tp-sldv_t:hover .tp-sldv_k::after{background-color:var(--btn-bg-h)}.tp-sldv_t:focus .tp-sldv_k::after{background-color:var(--btn-bg-f)}.tp-sldv_t:active .tp-sldv_k::after{background-color:var(--btn-bg-a)}.tp-sldtxtv{display:flex}.tp-sldtxtv_s{flex:2}.tp-sldtxtv_t{flex:1;margin-left:4px}.tp-tabv{position:relative}.tp-tabv_t{align-items:flex-end;color:var(--cnt-bg);display:flex;overflow:hidden;position:relative}.tp-tabv_t:hover{color:var(--cnt-bg-h)}.tp-tabv_t:has(*:focus){color:var(--cnt-bg-f)}.tp-tabv_t:has(*:active){color:var(--cnt-bg-a)}.tp-tabv_t::before{background-color:currentColor;bottom:0;content:"";height:2px;left:0;pointer-events:none;position:absolute;right:0}.tp-tabv.tp-v-disabled .tp-tabv_t::before{opacity:.5}.tp-tabv.tp-tabv-nop .tp-tabv_t{height:calc(var(--bld-us) + 4px);position:relative}.tp-tabv.tp-tabv-nop .tp-tabv_t::before{background-color:var(--cnt-bg);bottom:0;content:"";height:2px;left:0;position:absolute;right:0}.tp-tabv_c{padding-bottom:var(--cnt-v-p);padding-left:4px;padding-top:var(--cnt-v-p)}.tp-tabv_i{bottom:0;color:var(--cnt-bg);left:0;overflow:hidden;position:absolute;top:calc(var(--bld-us) + 4px);width:var(--bs-br)}.tp-tabv_i::before{background-color:currentColor;bottom:0;content:"";left:0;position:absolute;top:0;width:4px}.tp-tabv_t:hover+.tp-tabv_i{color:var(--cnt-bg-h)}.tp-tabv_t:has(*:focus)+.tp-tabv_i{color:var(--cnt-bg-f)}.tp-tabv_t:has(*:active)+.tp-tabv_i{color:var(--cnt-bg-a)}.tp-tabv.tp-v-disabled>.tp-tabv_i{opacity:.5}.tp-tbiv{flex:1;min-width:0;position:relative}.tp-tbiv+.tp-tbiv{margin-left:2px}.tp-tbiv+.tp-tbiv.tp-v-disabled::before{opacity:.5}.tp-tbiv_b{display:block;padding-left:calc(var(--cnt-h-p) + 4px);padding-right:calc(var(--cnt-h-p) + 4px);position:relative;width:100%}.tp-tbiv_b:disabled{opacity:.5}.tp-tbiv_b::before{background-color:var(--cnt-bg);bottom:2px;content:"";left:0;pointer-events:none;position:absolute;right:0;top:0}.tp-tbiv_b:hover::before{background-color:var(--cnt-bg-h)}.tp-tbiv_b:focus::before{background-color:var(--cnt-bg-f)}.tp-tbiv_b:active::before{background-color:var(--cnt-bg-a)}.tp-tbiv_t{color:var(--cnt-fg);height:calc(var(--bld-us) + 4px);line-height:calc(var(--bld-us) + 4px);opacity:.5;overflow:hidden;text-overflow:ellipsis}.tp-tbiv.tp-tbiv-sel .tp-tbiv_t{opacity:1}.tp-txtv{position:relative}.tp-txtv_i{padding:0 4px}.tp-txtv.tp-txtv-fst .tp-txtv_i{border-bottom-right-radius:0;border-top-right-radius:0}.tp-txtv.tp-txtv-mid .tp-txtv_i{border-radius:0}.tp-txtv.tp-txtv-lst .tp-txtv_i{border-bottom-left-radius:0;border-top-left-radius:0}.tp-txtv.tp-txtv-num .tp-txtv_i{text-align:right}.tp-txtv.tp-txtv-drg .tp-txtv_i{opacity:.3}.tp-txtv_k{cursor:pointer;height:100%;left:-3px;position:absolute;top:0;width:12px}.tp-txtv_k::before{background-color:var(--in-fg);border-radius:1px;bottom:0;content:"";height:calc(var(--bld-us) - 4px);left:50%;margin-bottom:auto;margin-left:-1px;margin-top:auto;opacity:.1;position:absolute;top:0;transition:border-radius .1s,height .1s,transform .1s,width .1s;width:2px}.tp-txtv_k:hover::before,.tp-txtv.tp-txtv-drg .tp-txtv_k::before{opacity:1}.tp-txtv.tp-txtv-drg .tp-txtv_k::before{border-radius:50%;height:4px;transform:translateX(-1px);width:4px}.tp-txtv_g{bottom:0;display:block;height:8px;left:50%;margin:auto;overflow:visible;pointer-events:none;position:absolute;top:0;visibility:hidden;width:100%}.tp-txtv.tp-txtv-drg .tp-txtv_g{visibility:visible}.tp-txtv_gb{fill:none;stroke:var(--in-fg);stroke-dasharray:1}.tp-txtv_gh{fill:none;stroke:var(--in-fg)}.tp-txtv .tp-ttv{margin-left:6px;visibility:hidden}.tp-txtv.tp-txtv-drg .tp-ttv{visibility:visible}.tp-ttv{background-color:var(--in-fg);border-radius:var(--elm-br);color:var(--bs-bg);padding:2px 4px;pointer-events:none;position:absolute;transform:translate(-50%, -100%)}.tp-ttv::before{border-color:var(--in-fg) rgba(0,0,0,0) rgba(0,0,0,0) rgba(0,0,0,0);border-style:solid;border-width:2px;box-sizing:border-box;content:"";font-size:.9em;height:4px;left:50%;margin-left:-2px;position:absolute;top:100%;width:4px}.tp-rotv{background-color:var(--bs-bg);border-radius:var(--bs-br);box-shadow:0 2px 4px var(--bs-sh);font-family:var(--font-family);font-size:11px;font-weight:500;line-height:1;text-align:left}.tp-rotv_b{border-bottom-left-radius:var(--bs-br);border-bottom-right-radius:var(--bs-br);border-top-left-radius:var(--bs-br);border-top-right-radius:var(--bs-br);padding-left:calc(4px + var(--bld-us) + var(--cnt-h-p));text-align:center}.tp-rotv.tp-rotv-expanded .tp-rotv_b{border-bottom-left-radius:0;border-bottom-right-radius:0}.tp-rotv.tp-rotv-not .tp-rotv_b{display:none}.tp-rotv_b:disabled .tp-rotv_m{display:none}.tp-rotv_c>.tp-fldv.tp-v-lst>.tp-fldv_c{border-bottom-left-radius:var(--bs-br);border-bottom-right-radius:var(--bs-br)}.tp-rotv_c>.tp-fldv.tp-v-lst>.tp-fldv_i{border-bottom-left-radius:var(--bs-br)}.tp-rotv_c>.tp-fldv.tp-v-lst:not(.tp-fldv-expanded)>.tp-fldv_b{border-bottom-left-radius:var(--bs-br);border-bottom-right-radius:var(--bs-br)}.tp-rotv_c .tp-fldv.tp-v-vlst:not(.tp-fldv-expanded)>.tp-fldv_b{border-bottom-right-radius:var(--bs-br)}.tp-rotv.tp-rotv-not .tp-rotv_c>.tp-fldv.tp-v-fst{margin-top:calc(-1*var(--cnt-v-p))}.tp-rotv.tp-rotv-not .tp-rotv_c>.tp-fldv.tp-v-fst>.tp-fldv_b{border-top-left-radius:var(--bs-br);border-top-right-radius:var(--bs-br)}.tp-rotv_c>.tp-tabv.tp-v-lst>.tp-tabv_c{border-bottom-left-radius:var(--bs-br);border-bottom-right-radius:var(--bs-br)}.tp-rotv_c>.tp-tabv.tp-v-lst>.tp-tabv_i{border-bottom-left-radius:var(--bs-br)}.tp-rotv.tp-rotv-not .tp-rotv_c>.tp-tabv.tp-v-fst{margin-top:calc(-1*var(--cnt-v-p))}.tp-rotv.tp-rotv-not .tp-rotv_c>.tp-tabv.tp-v-fst>.tp-tabv_t{border-top-left-radius:var(--bs-br);border-top-right-radius:var(--bs-br)}.tp-rotv.tp-v-disabled,.tp-rotv .tp-v-disabled{pointer-events:none}.tp-rotv.tp-v-hidden,.tp-rotv .tp-v-hidden{display:none}'),this.pool_.getAll().forEach(ft=>{this.embedPluginStyle_(ft)}),this.registerPlugin({plugins:[ro,zl,Uo,Ss]})}},l.SeparatorApi=fr,l.SliderApi=Qc,l.TabApi=Kr,l.TabPageApi=eo,l.TextApi=us,l.TpChangeEvent=h,l.VERSION=_h,Object.defineProperty(l,"__esModule",{value:!0})})(o)},161:function(d){d.exports=function(o,l,c){return o.length===0?o:l?(c||o.sort(l),function(u,h){for(var _=1,A=u.length,w=u[0],C=u[0],M=1;M<A;++M)if(C=w,h(w=u[M],C)){if(M===_){_++;continue}u[_++]=w}return u.length=_,u}(o,l)):(c||o.sort(),function(u){for(var h=1,_=u.length,A=u[0],w=u[0],C=1;C<_;++C,w=A)if(w=A,(A=u[C])!==w){if(C===h){h++;continue}u[h++]=A}return u.length=h,u}(o))}},957:function(__unused_webpack_module,__webpackgi_exports__,__webpackgi_require__){__webpackgi_require__.d(__webpackgi_exports__,{Z:function(){return DRACOLoader2}});var three_examples_jsm_loaders_DRACOLoader__WEBPACK_IMPORTED_MODULE_0__=__webpackgi_require__(149),three__WEBPACK_IMPORTED_MODULE_1__=__webpackgi_require__(848);class DRACOLoader2 extends three_examples_jsm_loaders_DRACOLoader__WEBPACK_IMPORTED_MODULE_0__.Z{constructor(d){super(d),this.encoderPending=null,this.encoderConfig={type:"js"},this.isDRACOLoader2=!0,this.setDecoderPath(DRACOLoader2.LIB_CDN_PATH),this.setDecoderConfig({type:"js"})}transform(d,o){return d?new three__WEBPACK_IMPORTED_MODULE_1__.eaF(d,new three__WEBPACK_IMPORTED_MODULE_1__._4j):void 0}preload(d=!0,o=!1){return d&&super.preload(),o&&this.initEncoder(),this}async initEncoder(){if(this.encoderPending)return this.encoderPending;const useJS=typeof WebAssembly!="object"||this.encoderConfig.type==="js",librariesPending=[],libLoader=this._loadLibrary.bind(this);return useJS?librariesPending.push(libLoader("draco_encoder.js","text")):(librariesPending.push(libLoader("draco_wasm_wrapper.js","text")),librariesPending.push(libLoader("draco_encoder.wasm","arraybuffer"))),this.encoderPending=Promise.all(librariesPending).then(libraries=>{var _a;const jsContent=libraries[0];return useJS||(this.encoderConfig.wasmBinary=libraries[1]),(_a=eval(jsContent+`
DracoEncoderModule;`))===null||_a===void 0?void 0:_a()}),this.encoderPending}async initDecoder(){var _a;await this._initDecoder();const jsContent=await fetch(this.workerSourceURL).then(async d=>d.text()).then(d=>{const o=d.indexOf("/* worker */");if(o<1)throw new Error("unable to load decoder module");return d.substring(0,o-1)});return(_a=eval(jsContent+`
DracoDecoderModule;`))===null||_a===void 0?void 0:_a()}async _loadLibrary(d,o){return DRACOLoader2.LibraryValueMap[d]?DRACOLoader2.LibraryValueMap[d]:DRACOLoader2.LibraryValueMap[d]=await super._loadLibrary(d,o)}static SetDecoderJsString(d){this.LibraryValueMap["draco_decoder.js"]=d}}DRACOLoader2.LIB_CDN_PATH="https://cdn.jsdelivr.net/gh/google/draco@1.4.1/javascript/",DRACOLoader2.LibraryValueMap={}},848:function(d,o,l){l.d(o,{$EB:function(){return Oe},$Kf:function(){return Dh},$NF:function(){return fu},$O9:function(){return kn},$_I:function(){return Zn},$ei:function(){return Pt},$p8:function(){return pf},A$4:function(){return tr},AKb:function(){return Z_},ALV:function(){return ph},AT1:function(){return Uc},Am1:function(){return pv},B69:function(){return yr},B6O:function(){return Pm},BH$:function(){return Oh},BKk:function(){return hs},BND:function(){return Wv},BRH:function(){return ov},BXX:function(){return rs},B_h:function(){return Rs},BdL:function(){return xh},CMB:function(){return wn},CR7:function(){return Eu},CSG:function(){return Sh},CV9:function(){return Hh},CVz:function(){return bu},CWW:function(){return Ba},Cfg:function(){return un},CmU:function(){return _f},CwR:function(){return yv},D$Q:function(){return Qm},DAe:function(){return xl},DAr:function(){return io},DXC:function(){return Ts},Df:function(){return Xm},E0M:function(){return Xv},EAD:function(){return _d},EQC:function(){return bl},EZo:function(){return ht},EdD:function(){return _t},F1T:function(){return wp},F1l:function(){return Uv},FCc:function(){return Em},FFZ:function(){return Pu},FNr:function(){return $m},FV:function(){return Gt},FXf:function(){return pt},FZo:function(){return gf},Fn:function(){return Da},Fpm:function(){return Nv},FvD:function(){return xd},Fvt:function(){return Jm},G3T:function(){return ea},GBG:function(){return rf},GJx:function(){return hn},GOR:function(){return z_},GTy:function(){return ke},GWd:function(){return Nr},GYF:function(){return ic},GZZ:function(){return Gh},G_z:function(){return Km},Gu$:function(){return uu},Gwm:function(){return Ui},GxU:function(){return Ye},H23:function(){return gc},HLH:function(){return wc},HO_:function(){return Ac},HPb:function(){return Sc},HXV:function(){return dc},HgN:function(){return Bc},HiM:function(){return df},Hit:function(){return hu},Ho_:function(){return oc},Hrb:function(){return Bn},Hrq:function(){return Ru},I46:function(){return mm},I9Y:function(){return en},IE4:function(){return co},IUQ:function(){return Tr},IWo:function(){return Qv},Ipv:function(){return ps},Iw4:function(){return Tv},IzY:function(){return Yv},JeP:function(){return em},Jnc:function(){return w},K52:function(){return Xi},KDk:function(){return Fo},KLL:function(){return Dr},KPJ:function(){return ep},KRh:function(){return Nn},Ke9:function(){return bc},Kef:function(){return xu},Ktl:function(){return Iu},Kwu:function(){return ut},Kzg:function(){return hv},Kzv:function(){return vn},Ld9:function(){return Kv},LiQ:function(){return kt},LlO:function(){return xp},LoY:function(){return dr},LuO:function(){return Pv},MBL:function(){return ac},MOq:function(){return Tl},MSw:function(){return Fd},MW4:function(){return go},Mjd:function(){return sn},N1A:function(){return Ta},N2s:function(){return Mf},N5j:function(){return xc},NRn:function(){return Ko},NTi:function(){return tt},NZq:function(){return Rn},Nt7:function(){return Wt},Nv2:function(){return U_},Nwf:function(){return Ar},Nz6:function(){return Uo},O0B:function(){return Nu},O3Y:function(){return Gd},O49:function(){return wu},O9p:function(){return ya},ONl:function(){return Tm},OUM:function(){return Un},Oax:function(){return bo},Om:function(){return dn},OuU:function(){return si},P5j:function(){return Ev},PFK:function(){return Vv},PJ3:function(){return Oa},PPD:function(){return nd},PTz:function(){return Ao},Pdi:function(){return tf},Pem:function(){return F_},Pf$:function(){return gv},Pq0:function(){return ii},Q1f:function(){return Dn},QCA:function(){return Nd},QP0:function(){return O},Qev:function(){return ho},Qrf:function(){return Ra},R1W:function(){return jv},RJ4:function(){return os},ROr:function(){return oh},RQf:function(){return Tn},RcT:function(){return _s},RiT:function(){return pu},Riy:function(){return Is},Rkk:function(){return Na},RlV:function(){return ma},RoJ:function(){return Mh},Ru$:function(){return sh},RyA:function(){return ce},S$4:function(){return yl},S20:function(){return wd},S2Q:function(){return ss},S3G:function(){return tm},SUR:function(){return vf},ScU:function(){return rv},T6I:function(){return Zh},TDQ:function(){return Om},THS:function(){return zt},TMh:function(){return Tc},Tap:function(){return sv},TdN:function(){return Bo},TiK:function(){return Tu},TkQ:function(){return cr},U3G:function(){return Li},UJ6:function(){return ms},UPV:function(){return zd},UTZ:function(){return vi},Ua6:function(){return Cl},Ufg:function(){return cu},UpK:function(){return lm},UtB:function(){return Ov},UtX:function(){return op},V3x:function(){return jr},V58:function(){return qc},V5c:function(){return ka},V9B:function(){return Ss},VCu:function(){return Zp},VT0:function(){return eo},VVr:function(){return wl},Vb5:function(){return A},VnP:function(){return Dm},Vnu:function(){return Us},VxR:function(){return Mr},W9U:function(){return _c},WBB:function(){return kd},WNZ:function(){return _},WTh:function(){return Hv},Wdf:function(){return Cc},Wew:function(){return fr},Wk7:function(){return ne},Wyr:function(){return ys},XG_:function(){return yc},XIg:function(){return Ve},XJ7:function(){return Gm},XTe:function(){return uv},XrR:function(){return Kn},Y9S:function(){return Ms},YHV:function(){return Dv},YJl:function(){return Kl},YOZ:function(){return nl},YRT:function(){return nv},Yhb:function(){return nf},Yuy:function(){return _n},Z0B:function(){return jh},Z58:function(){return im},ZLX:function(){return vm},ZM4:function(){return qv},ZQM:function(){return Kr},Zcv:function(){return Sa},Zpd:function(){return jd},Zr2:function(){return Fr},ZyN:function(){return hf},_4j:function(){return Yh},_QJ:function(){return gl},_xc:function(){return kv},a$r:function(){return On},a5J:function(){return Ds},aEY:function(){return ti},aHM:function(){return No},aMy:function(){return ta},aVO:function(){return Th},agE:function(){return oa},amv:function(){return Ns},b4q:function(){return Xc},bC7:function(){return vl},bCz:function(){return at},bI3:function(){return Yo},bTm:function(){return M},baL:function(){return Di},bdM:function(){return Yc},bkx:function(){return yn},brA:function(){return Ht},bw0:function(){return An},c5h:function(){return G_},c90:function(){return Er},cHt:function(){return Ki},cRK:function(){return cd},cZY:function(){return Lv},caT:function(){return Ln},cj9:function(){return Bu},czI:function(){return ml},dAo:function(){return Vh},dYF:function(){return kc},dcC:function(){return or},dhZ:function(){return La},dth:function(){return sf},dwI:function(){return er},dzP:function(){return Mv},eB$:function(){return dd},eHc:function(){return ri},eHs:function(){return Za},eaF:function(){return so},eoi:function(){return Cu},er$:function(){return Rr},ezk:function(){return Jh},f4X:function(){return Ut},fBL:function(){return Fi},fCn:function(){return bn},fJr:function(){return Ec},fP5:function(){return Tf},fTw:function(){return Gv},fc6:function(){return rn},g7M:function(){return li},gJ2:function(){return wr},gO9:function(){return lt},gPd:function(){return Or},gWB:function(){return vs},ghU:function(){return an},h2z:function(){return Os},hB5:function(){return ue},hIf:function(){return Sl},hZF:function(){return rl},h_9:function(){return of},hdd:function(){return Jt},hfX:function(){return $p},hgQ:function(){return ci},hjs:function(){return Bv},hsX:function(){return ye},hxR:function(){return Yi},hy7:function(){return xi},hzE:function(){return zv},i7d:function(){return Zu},i7u:function(){return jo},iNn:function(){return Ea},iOZ:function(){return j_},iUH:function(){return xr},ibB:function(){return Mm},ie2:function(){return Vt},imn:function(){return no},ix0:function(){return qn},iyt:function(){return Oo},j6:function(){return Vd},jGm:function(){return Bm},jR7:function(){return uo},jUj:function(){return ud},jf0:function(){return Cr},jsO:function(){return El},jut:function(){return Hd},jzd:function(){return Mu},k6Q:function(){return uc},k6q:function(){return fn},kBv:function(){return u},kEx:function(){return iv},kG0:function(){return Ua},kLi:function(){return Go},kO0:function(){return Ga},kRr:function(){return Fn},kTW:function(){return pn},kTp:function(){return pl},kYr:function(){return Fa},keZ:function(){return mv},klZ:function(){return Su},kn4:function(){return Xn},kqe:function(){return Do},kxk:function(){return sm},kyO:function(){return Gi},l2R:function(){return qs},lGu:function(){return Ct},lGw:function(){return du},lMl:function(){return fo},lPF:function(){return Ic},lc7:function(){return Al},ljd:function(){return ia},lyL:function(){return _l},mrM:function(){return Io},nCl:function(){return cf},nEu:function(){return Pd},nNL:function(){return jt},nST:function(){return xt},nWS:function(){return yo},nZQ:function(){return Jp},nc$:function(){return lp},nzx:function(){return ou},o6l:function(){return Ep},oVO:function(){return ah},oh6:function(){return Iv},ojh:function(){return Lt},ojs:function(){return Zs},pBf:function(){return hc},pFK:function(){return Ca},pHI:function(){return nn},pPE:function(){return Pf},paN:function(){return to},ppV:function(){return Sr},psI:function(){return pc},q2:function(){return Hm},qBx:function(){return Ym},qFE:function(){return Md},qIQ:function(){return Ls},qU7:function(){return Td},qUd:function(){return od},qa3:function(){return gs},qad:function(){return Bt},qtW:function(){return Cn},r6x:function(){return rp},rFo:function(){return Dl},rKP:function(){return Ud},rOG:function(){return ur},rQf:function(){return Bs},rSH:function(){return Js},rYR:function(){return rh},s0K:function(){return Rm},sKt:function(){return ja},sPf:function(){return c},tBo:function(){return Rv},tJf:function(){return Ai},tXL:function(){return qm},tcD:function(){return Cd},tgE:function(){return Vr},tz3:function(){return mu},uB5:function(){return mc},uSd:function(){return Wm},uV5:function(){return Zi},uWO:function(){return nc},uXQ:function(){return lh},ubm:function(){return _o},uov:function(){return uh},ure:function(){return mf},veJ:function(){return Ma},vim:function(){return ks},vmz:function(){return Wr},vxI:function(){return ar},vyJ:function(){return na},wAk:function(){return ru},wfO:function(){return Ri},wn6:function(){return Zt},wqq:function(){return ra},wrO:function(){return Xr},wtR:function(){return h},wvS:function(){return ni},xFO:function(){return mi},xJ6:function(){return Cs},xOk:function(){return ff},xSv:function(){return qt},xZx:function(){return vv},xfg:function(){return Qh},y3Z:function(){return fc},y9J:function(){return Nc},y_p:function(){return _i},ypk:function(){return el},ywQ:function(){return C},z5:function(){return kr},zD7:function(){return wf},zdS:function(){return Zr},zgK:function(){return Ul},zkh:function(){return Lo},znC:function(){return Tt}});const c="157",u={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},h={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},_=0,A=1,w=2,C=3,M=0,O=1,ne=2,ce=3,ue=0,ye=1,Oe=2,ke=2,Ve=0,tt=1,ht=2,ut=3,_t=4,at=5,lt=100,pt=101,xt=102,Tt=103,Pt=104,Lt=200,Bt=201,Ut=202,kt=203,Vt=204,si=205,Jt=206,Wt=207,Zt=208,ti=209,ci=210,ri=0,Ct=1,Ht=2,qt=3,Li=4,Ui=5,Xi=6,An=7,Ln=0,Nn=1,Kn=2,_i=0,Gi=1,sn=2,jt=3,Gt=4,li=5,vi=300,xi=301,mi=302,Ri=303,Zi=304,dn=306,hn=1e3,an=1001,pn=1002,Yi=1003,nn=1004,kn=1004,un=1005,On=1005,fn=1006,Fn=1007,xr=1007,Zn=1008,Rn=1008,Un=1009,Ai=1010,Fi=1011,Ki=1012,_n=1013,yn=1014,Tn=1015,qn=1016,fr=1017,wr=1018,jr=1020,Xr=1021,Nr=1023,vn=1024,wn=1025,Zr=1026,or=1027,eo=1028,Kr=1029,to=1030,cr=1031,Er=1033,co=33776,Uo=33777,uo=33778,rs=33779,uc=35840,pl=35841,dc=35842,hc=35843,bu=36196,Is=37492,Fo=37496,gs=37808,Rs=37809,ml=37810,Js=37811,Ra=37812,pc=37813,Ds=37814,gl=37815,mc=37816,_l=37817,vl=37818,fc=37819,Zs=37820,yl=37821,Da=36492,gc=36494,_c=36495,xu=36283,yc=36284,Ac=36285,Ba=36286,ea=2200,ta=2201,Al=2202,ia=2300,Oa=2301,bl=2302,Bs=2400,Os=2401,La=2402,bc=2500,xl=2501,os=0,wu=1,rh=2,Vr=3e3,ss=3001,Na=3200,xc=3201,Yo=0,na=1,Cr="",Rr="srgb",Fr="srgb-linear",ka="display-p3",Ls="display-p3-linear",io="rgbm-16",Mr="linear",Dr="srgb",kr="rec709",ra="p3",Do=0,wl=7680,Ua=7681,wc=7682,oh=7683,sh=34055,Ec=34056,ah=5386,Sc=512,Fa=513,El=514,Eu=515,_s=516,Su=517,Tc=518,ja=519,Ns=512,ks=513,Ga=514,Tu=515,Cu=516,Mu=517,vs=518,Pu=519,oa=35044,Us=35048,Iu=35040,lh=35045,Sl=35049,uh=35041,Ru=35046,Tl=35050,ur=35042,ys="100",Cc="300 es",Cl=1035,Bo=2e3,jo=2001;class ho{addEventListener(y,b){this._listeners===void 0&&(this._listeners={});const D=this._listeners;D[y]===void 0&&(D[y]=[]),D[y].indexOf(b)===-1&&D[y].push(b)}hasEventListener(y,b){if(this._listeners===void 0)return!1;const D=this._listeners;return D[y]!==void 0&&D[y].indexOf(b)!==-1}removeEventListener(y,b){if(this._listeners===void 0)return;const D=this._listeners[y];if(D!==void 0){const Y=D.indexOf(b);Y!==-1&&D.splice(Y,1)}}dispatchEvent(y){if(this._listeners===void 0)return;const b=this._listeners[y.type];if(b!==void 0){y.target=this;const D=b.slice(0);for(let Y=0,_e=D.length;Y<_e;Y++)D[Y].call(this,y);y.target=null}}}const Br=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let Du=1234567;const As=Math.PI/180,Fs=180/Math.PI;function vo(){const De=4294967295*Math.random()|0,y=4294967295*Math.random()|0,b=4294967295*Math.random()|0,D=4294967295*Math.random()|0;return(Br[255&De]+Br[De>>8&255]+Br[De>>16&255]+Br[De>>24&255]+"-"+Br[255&y]+Br[y>>8&255]+"-"+Br[y>>16&15|64]+Br[y>>24&255]+"-"+Br[63&b|128]+Br[b>>8&255]+"-"+Br[b>>16&255]+Br[b>>24&255]+Br[255&D]+Br[D>>8&255]+Br[D>>16&255]+Br[D>>24&255]).toLowerCase()}function Ur(De,y,b){return Math.max(y,Math.min(b,De))}function Ml(De,y){return(De%y+y)%y}function sa(De,y,b){return(1-b)*De+b*y}function Pl(De){return!(De&De-1)&&De!==0}function Mc(De){return Math.pow(2,Math.ceil(Math.log(De)/Math.LN2))}function za(De){return Math.pow(2,Math.floor(Math.log(De)/Math.LN2))}function po(De,y){switch(y.constructor){case Float32Array:return De;case Uint32Array:return De/4294967295;case Uint16Array:return De/65535;case Uint8Array:return De/255;case Int32Array:return Math.max(De/2147483647,-1);case Int16Array:return Math.max(De/32767,-1);case Int8Array:return Math.max(De/127,-1);default:throw new Error("Invalid component type.")}}function $n(De,y){switch(y.constructor){case Float32Array:return De;case Uint32Array:return Math.round(4294967295*De);case Uint16Array:return Math.round(65535*De);case Uint8Array:return Math.round(255*De);case Int32Array:return Math.round(2147483647*De);case Int16Array:return Math.round(32767*De);case Int8Array:return Math.round(127*De);default:throw new Error("Invalid component type.")}}const Bu={DEG2RAD:As,RAD2DEG:Fs,generateUUID:vo,clamp:Ur,euclideanModulo:Ml,mapLinear:function(De,y,b,D,Y){return D+(De-y)*(Y-D)/(b-y)},inverseLerp:function(De,y,b){return De!==y?(b-De)/(y-De):0},lerp:sa,damp:function(De,y,b,D){return sa(De,y,1-Math.exp(-b*D))},pingpong:function(De,y=1){return y-Math.abs(Ml(De,2*y)-y)},smoothstep:function(De,y,b){return De<=y?0:De>=b?1:(De=(De-y)/(b-y))*De*(3-2*De)},smootherstep:function(De,y,b){return De<=y?0:De>=b?1:(De=(De-y)/(b-y))*De*De*(De*(6*De-15)+10)},randInt:function(De,y){return De+Math.floor(Math.random()*(y-De+1))},randFloat:function(De,y){return De+Math.random()*(y-De)},randFloatSpread:function(De){return De*(.5-Math.random())},seededRandom:function(De){De!==void 0&&(Du=De);let y=Du+=1831565813;return y=Math.imul(y^y>>>15,1|y),y^=y+Math.imul(y^y>>>7,61|y),((y^y>>>14)>>>0)/4294967296},degToRad:function(De){return De*As},radToDeg:function(De){return De*Fs},isPowerOfTwo:Pl,ceilPowerOfTwo:Mc,floorPowerOfTwo:za,setQuaternionFromProperEuler:function(De,y,b,D,Y){const _e=Math.cos,Le=Math.sin,qe=_e(b/2),it=Le(b/2),nt=_e((y+D)/2),mt=Le((y+D)/2),bt=_e((y-D)/2),At=Le((y-D)/2),wt=_e((D-y)/2),Et=Le((D-y)/2);switch(Y){case"XYX":De.set(qe*mt,it*bt,it*At,qe*nt);break;case"YZY":De.set(it*At,qe*mt,it*bt,qe*nt);break;case"ZXZ":De.set(it*bt,it*At,qe*mt,qe*nt);break;case"XZX":De.set(qe*mt,it*Et,it*wt,qe*nt);break;case"YXY":De.set(it*wt,qe*mt,it*Et,qe*nt);break;case"ZYZ":De.set(it*Et,it*wt,qe*mt,qe*nt);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+Y)}},normalize:$n,denormalize:po};class en{constructor(y=0,b=0){en.prototype.isVector2=!0,this.x=y,this.y=b}get width(){return this.x}set width(y){this.x=y}get height(){return this.y}set height(y){this.y=y}set(y,b){return this.x=y,this.y=b,this}setScalar(y){return this.x=y,this.y=y,this}setX(y){return this.x=y,this}setY(y){return this.y=y,this}setComponent(y,b){switch(y){case 0:this.x=b;break;case 1:this.y=b;break;default:throw new Error("index is out of range: "+y)}return this}getComponent(y){switch(y){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+y)}}clone(){return new this.constructor(this.x,this.y)}copy(y){return this.x=y.x,this.y=y.y,this}add(y){return this.x+=y.x,this.y+=y.y,this}addScalar(y){return this.x+=y,this.y+=y,this}addVectors(y,b){return this.x=y.x+b.x,this.y=y.y+b.y,this}addScaledVector(y,b){return this.x+=y.x*b,this.y+=y.y*b,this}sub(y){return this.x-=y.x,this.y-=y.y,this}subScalar(y){return this.x-=y,this.y-=y,this}subVectors(y,b){return this.x=y.x-b.x,this.y=y.y-b.y,this}multiply(y){return this.x*=y.x,this.y*=y.y,this}multiplyScalar(y){return this.x*=y,this.y*=y,this}divide(y){return this.x/=y.x,this.y/=y.y,this}divideScalar(y){return this.multiplyScalar(1/y)}applyMatrix3(y){const b=this.x,D=this.y,Y=y.elements;return this.x=Y[0]*b+Y[3]*D+Y[6],this.y=Y[1]*b+Y[4]*D+Y[7],this}min(y){return this.x=Math.min(this.x,y.x),this.y=Math.min(this.y,y.y),this}max(y){return this.x=Math.max(this.x,y.x),this.y=Math.max(this.y,y.y),this}clamp(y,b){return this.x=Math.max(y.x,Math.min(b.x,this.x)),this.y=Math.max(y.y,Math.min(b.y,this.y)),this}clampScalar(y,b){return this.x=Math.max(y,Math.min(b,this.x)),this.y=Math.max(y,Math.min(b,this.y)),this}clampLength(y,b){const D=this.length();return this.divideScalar(D||1).multiplyScalar(Math.max(y,Math.min(b,D)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(y){return this.x*y.x+this.y*y.y}cross(y){return this.x*y.y-this.y*y.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(y){const b=Math.sqrt(this.lengthSq()*y.lengthSq());if(b===0)return Math.PI/2;const D=this.dot(y)/b;return Math.acos(Ur(D,-1,1))}distanceTo(y){return Math.sqrt(this.distanceToSquared(y))}distanceToSquared(y){const b=this.x-y.x,D=this.y-y.y;return b*b+D*D}manhattanDistanceTo(y){return Math.abs(this.x-y.x)+Math.abs(this.y-y.y)}setLength(y){return this.normalize().multiplyScalar(y)}lerp(y,b){return this.x+=(y.x-this.x)*b,this.y+=(y.y-this.y)*b,this}lerpVectors(y,b,D){return this.x=y.x+(b.x-y.x)*D,this.y=y.y+(b.y-y.y)*D,this}equals(y){return y.x===this.x&&y.y===this.y}fromArray(y,b=0){return this.x=y[b],this.y=y[b+1],this}toArray(y=[],b=0){return y[b]=this.x,y[b+1]=this.y,y}fromBufferAttribute(y,b){return this.x=y.getX(b),this.y=y.getY(b),this}rotateAround(y,b){const D=Math.cos(b),Y=Math.sin(b),_e=this.x-y.x,Le=this.y-y.y;return this.x=_e*D-Le*Y+y.x,this.y=_e*Y+Le*D+y.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class er{constructor(y,b,D,Y,_e,Le,qe,it,nt){er.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],y!==void 0&&this.set(y,b,D,Y,_e,Le,qe,it,nt)}set(y,b,D,Y,_e,Le,qe,it,nt){const mt=this.elements;return mt[0]=y,mt[1]=Y,mt[2]=qe,mt[3]=b,mt[4]=_e,mt[5]=it,mt[6]=D,mt[7]=Le,mt[8]=nt,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(y){const b=this.elements,D=y.elements;return b[0]=D[0],b[1]=D[1],b[2]=D[2],b[3]=D[3],b[4]=D[4],b[5]=D[5],b[6]=D[6],b[7]=D[7],b[8]=D[8],this}extractBasis(y,b,D){return y.setFromMatrix3Column(this,0),b.setFromMatrix3Column(this,1),D.setFromMatrix3Column(this,2),this}setFromMatrix4(y){const b=y.elements;return this.set(b[0],b[4],b[8],b[1],b[5],b[9],b[2],b[6],b[10]),this}multiply(y){return this.multiplyMatrices(this,y)}premultiply(y){return this.multiplyMatrices(y,this)}multiplyMatrices(y,b){const D=y.elements,Y=b.elements,_e=this.elements,Le=D[0],qe=D[3],it=D[6],nt=D[1],mt=D[4],bt=D[7],At=D[2],wt=D[5],Et=D[8],Mt=Y[0],St=Y[3],Nt=Y[6],It=Y[1],Rt=Y[4],Yt=Y[7],Kt=Y[2],Xt=Y[5],oi=Y[8];return _e[0]=Le*Mt+qe*It+it*Kt,_e[3]=Le*St+qe*Rt+it*Xt,_e[6]=Le*Nt+qe*Yt+it*oi,_e[1]=nt*Mt+mt*It+bt*Kt,_e[4]=nt*St+mt*Rt+bt*Xt,_e[7]=nt*Nt+mt*Yt+bt*oi,_e[2]=At*Mt+wt*It+Et*Kt,_e[5]=At*St+wt*Rt+Et*Xt,_e[8]=At*Nt+wt*Yt+Et*oi,this}multiplyScalar(y){const b=this.elements;return b[0]*=y,b[3]*=y,b[6]*=y,b[1]*=y,b[4]*=y,b[7]*=y,b[2]*=y,b[5]*=y,b[8]*=y,this}determinant(){const y=this.elements,b=y[0],D=y[1],Y=y[2],_e=y[3],Le=y[4],qe=y[5],it=y[6],nt=y[7],mt=y[8];return b*Le*mt-b*qe*nt-D*_e*mt+D*qe*it+Y*_e*nt-Y*Le*it}invert(){const y=this.elements,b=y[0],D=y[1],Y=y[2],_e=y[3],Le=y[4],qe=y[5],it=y[6],nt=y[7],mt=y[8],bt=mt*Le-qe*nt,At=qe*it-mt*_e,wt=nt*_e-Le*it,Et=b*bt+D*At+Y*wt;if(Et===0)return this.set(0,0,0,0,0,0,0,0,0);const Mt=1/Et;return y[0]=bt*Mt,y[1]=(Y*nt-mt*D)*Mt,y[2]=(qe*D-Y*Le)*Mt,y[3]=At*Mt,y[4]=(mt*b-Y*it)*Mt,y[5]=(Y*_e-qe*b)*Mt,y[6]=wt*Mt,y[7]=(D*it-nt*b)*Mt,y[8]=(Le*b-D*_e)*Mt,this}transpose(){let y;const b=this.elements;return y=b[1],b[1]=b[3],b[3]=y,y=b[2],b[2]=b[6],b[6]=y,y=b[5],b[5]=b[7],b[7]=y,this}getNormalMatrix(y){return this.setFromMatrix4(y).invert().transpose()}transposeIntoArray(y){const b=this.elements;return y[0]=b[0],y[1]=b[3],y[2]=b[6],y[3]=b[1],y[4]=b[4],y[5]=b[7],y[6]=b[2],y[7]=b[5],y[8]=b[8],this}setUvTransform(y,b,D,Y,_e,Le,qe){const it=Math.cos(_e),nt=Math.sin(_e);return this.set(D*it,D*nt,-D*(it*Le+nt*qe)+Le+y,-Y*nt,Y*it,-Y*(-nt*Le+it*qe)+qe+b,0,0,1),this}scale(y,b){return this.premultiply(Il.makeScale(y,b)),this}rotate(y){return this.premultiply(Il.makeRotation(-y)),this}translate(y,b){return this.premultiply(Il.makeTranslation(y,b)),this}makeTranslation(y,b){return y.isVector2?this.set(1,0,y.x,0,1,y.y,0,0,1):this.set(1,0,y,0,1,b,0,0,1),this}makeRotation(y){const b=Math.cos(y),D=Math.sin(y);return this.set(b,-D,0,D,b,0,0,0,1),this}makeScale(y,b){return this.set(y,0,0,0,b,0,0,0,1),this}equals(y){const b=this.elements,D=y.elements;for(let Y=0;Y<9;Y++)if(b[Y]!==D[Y])return!1;return!0}fromArray(y,b=0){for(let D=0;D<9;D++)this.elements[D]=y[D+b];return this}toArray(y=[],b=0){const D=this.elements;return y[b]=D[0],y[b+1]=D[1],y[b+2]=D[2],y[b+3]=D[3],y[b+4]=D[4],y[b+5]=D[5],y[b+6]=D[6],y[b+7]=D[7],y[b+8]=D[8],y}clone(){return new this.constructor().fromArray(this.elements)}}const Il=new er;function Ou(De){for(let y=De.length-1;y>=0;--y)if(De[y]>=65535)return!0;return!1}const Pc={Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array};function js(De,y){return new Pc[De](y)}function Gs(De){return document.createElementNS("http://www.w3.org/1999/xhtml",De)}function Ic(){const De=Gs("canvas");return De.style.display="block",De}const Rc={};function zs(De){De in Rc||(Rc[De]=!0,console.warn(De))}const Dc=new er().set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),Lu=new er().set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),Vs={[Fr]:{transfer:Mr,primaries:kr,toReference:De=>De,fromReference:De=>De},[Rr]:{transfer:Dr,primaries:kr,toReference:De=>De.convertSRGBToLinear(),fromReference:De=>De.convertLinearToSRGB()},[Ls]:{transfer:Mr,primaries:ra,toReference:De=>De.applyMatrix3(Lu),fromReference:De=>De.applyMatrix3(Dc)},[ka]:{transfer:Dr,primaries:ra,toReference:De=>De.convertSRGBToLinear().applyMatrix3(Lu),fromReference:De=>De.applyMatrix3(Dc).convertLinearToSRGB()}},dh=new Set([Fr,Ls]),Sr={enabled:!0,_workingColorSpace:Fr,get legacyMode(){return console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),!this.enabled},set legacyMode(De){console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),this.enabled=!De},get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(De){if(!dh.has(De))throw new Error(`Unsupported working color space, "${De}".`);this._workingColorSpace=De},convert:function(De,y,b){if(this.enabled===!1||y===b||!y||!b)return De;const D=Vs[y].toReference;return(0,Vs[b].fromReference)(D(De))},fromWorkingColorSpace:function(De,y){return this.convert(De,this._workingColorSpace,y)},toWorkingColorSpace:function(De,y){return this.convert(De,y,this._workingColorSpace)},getPrimaries:function(De){return Vs[De].primaries},getTransfer:function(De){return De===Cr||De===io?Mr:Vs[De].transfer}};function aa(De){return De<.04045?.0773993808*De:Math.pow(.9478672986*De+.0521327014,2.4)}function Rl(De){return De<.0031308?12.92*De:1.055*Math.pow(De,.41666)-.055}let la;class Bc{static getDataURL(y,b=!1){if(/^data:/i.test(y.src)||typeof HTMLCanvasElement>"u")return y.src;let D;if(y instanceof HTMLCanvasElement)D=y;else{la===void 0&&(la=Gs("canvas")),la.width=y.width,la.height=y.height;const Y=la.getContext("2d");y instanceof ImageData?Y.putImageData(y,0,0):Y.drawImage(y,0,0,y.width,y.height),D=la}return!b&&(D.width>2048||D.height>2048)?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",y),D.toDataURL("image/jpeg",.6)):D.toDataURL("image/png")}static sRGBToLinear(y){if(typeof HTMLImageElement<"u"&&y instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&y instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&y instanceof ImageBitmap){const b=Gs("canvas");b.width=y.width,b.height=y.height;const D=b.getContext("2d");D.drawImage(y,0,0,y.width,y.height);const Y=D.getImageData(0,0,y.width,y.height),_e=Y.data;for(let Le=0;Le<_e.length;Le++)_e[Le]=255*aa(_e[Le]/255);return D.putImageData(Y,0,0),b}if(y.data){const b=y.data.slice(0);for(let D=0;D<b.length;D++)b instanceof Uint8Array||b instanceof Uint8ClampedArray?b[D]=Math.floor(255*aa(b[D]/255)):b[D]=aa(b[D]);return{data:b,width:y.width,height:y.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),y}}let Oc=0;class Go{constructor(y=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Oc++}),this.uuid=vo(),this.data=y,this.version=0}set needsUpdate(y){y===!0&&this.version++}toJSON(y){const b=y===void 0||typeof y=="string";if(!b&&y.images[this.uuid]!==void 0)return y.images[this.uuid];const D={uuid:this.uuid,url:""},Y=this.data;if(Y!==null){let _e;if(Array.isArray(Y)){_e=[];for(let Le=0,qe=Y.length;Le<qe;Le++)Y[Le].isDataTexture?_e.push(Lc(Y[Le].image)):_e.push(Lc(Y[Le]))}else _e=Lc(Y);D.url=_e}return b||(y.images[this.uuid]=D),D}}function Lc(De){if(typeof HTMLImageElement<"u"&&De instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&De instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&De instanceof ImageBitmap)return Bc.getDataURL(De);if(De.data){let y=[];try{y=Array.from(De.data)}catch(b){b.message.includes("Invalid array length")?console.warn("Serializing large texture, might not be saved in JSON structure."):console.error(b),y=De.data}return{data:y,width:De.width,height:De.height,type:De.data.constructor.name}}return De.url!==void 0?De.url:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let hh=0;class Or extends ho{constructor(y=Or.DEFAULT_IMAGE,b=Or.DEFAULT_MAPPING,D=an,Y=an,_e=fn,Le=Zn,qe=Nr,it=Un,nt=Or.DEFAULT_ANISOTROPY,mt=Cr){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:hh++}),this.uuid=vo(),this.name="",this.source=new Go(y),this.mipmaps=[],this.mapping=b,this.channel=0,this.wrapS=D,this.wrapT=Y,this.magFilter=_e,this.minFilter=Le,this.anisotropy=nt,this.format=qe,this.internalFormat=null,this.type=it,this.offset=new en(0,0),this.repeat=new en(1,1),this.center=new en(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new er,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,typeof mt=="string"?this.colorSpace=mt:(zs("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=mt===ss?Rr:Cr),this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1,y instanceof ImageData&&(this.needsUpdate=!0)}get image(){return this.source.data}set image(y=null){this.source.data=y}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(y){return this.name=y.name,this.source=y.source,this.mipmaps=y.mipmaps.slice(0),this.mapping=y.mapping,this.channel=y.channel,this.wrapS=y.wrapS,this.wrapT=y.wrapT,this.magFilter=y.magFilter,this.minFilter=y.minFilter,this.anisotropy=y.anisotropy,this.format=y.format,this.internalFormat=y.internalFormat,this.type=y.type,this.offset.copy(y.offset),this.repeat.copy(y.repeat),this.center.copy(y.center),this.rotation=y.rotation,this.matrixAutoUpdate=y.matrixAutoUpdate,this.matrix.copy(y.matrix),this.generateMipmaps=y.generateMipmaps,this.premultiplyAlpha=y.premultiplyAlpha,this.flipY=y.flipY,this.unpackAlignment=y.unpackAlignment,this.colorSpace=y.colorSpace,this.userData=JSON.parse(JSON.stringify(y.userData)),this.needsUpdate=!0,this}toJSON(y){const b=y===void 0||typeof y=="string";if(!b&&y.textures&&y.textures[this.uuid]!==void 0)return y.textures[this.uuid];const D={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(y).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,encoding:this.colorSpace===Rr?ss:Vr,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(D.userData=this.userData),!b&&y.textures&&(y.textures[this.uuid]=D),D}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(y){if(this.mapping!==vi)return y;if(y.applyMatrix3(this.matrix),y.x<0||y.x>1)switch(this.wrapS){case hn:y.x=y.x-Math.floor(y.x);break;case an:y.x=y.x<0?0:1;break;case pn:Math.abs(Math.floor(y.x)%2)===1?y.x=Math.ceil(y.x)-y.x:y.x=y.x-Math.floor(y.x)}if(y.y<0||y.y>1)switch(this.wrapT){case hn:y.y=y.y-Math.floor(y.y);break;case an:y.y=y.y<0?0:1;break;case pn:Math.abs(Math.floor(y.y)%2)===1?y.y=Math.ceil(y.y)-y.y:y.y=y.y-Math.floor(y.y)}return this.flipY&&(y.y=1-y.y),y}set needsUpdate(y){y===!0&&(this.version++,this.source.needsUpdate=!0,this.dispatchEvent({type:"update"}))}get encoding(){return zs("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace===Rr?ss:Vr}set encoding(y){zs("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=y===ss?Rr:Cr}}Or.DEFAULT_IMAGE=null,Or.DEFAULT_MAPPING=vi,Or.DEFAULT_ANISOTROPY=1;class Tr{constructor(y=0,b=0,D=0,Y=1){Tr.prototype.isVector4=!0,this.x=y,this.y=b,this.z=D,this.w=Y}get width(){return this.z}set width(y){this.z=y}get height(){return this.w}set height(y){this.w=y}set(y,b,D,Y){return this.x=y,this.y=b,this.z=D,this.w=Y,this}setScalar(y){return this.x=y,this.y=y,this.z=y,this.w=y,this}setX(y){return this.x=y,this}setY(y){return this.y=y,this}setZ(y){return this.z=y,this}setW(y){return this.w=y,this}setComponent(y,b){switch(y){case 0:this.x=b;break;case 1:this.y=b;break;case 2:this.z=b;break;case 3:this.w=b;break;default:throw new Error("index is out of range: "+y)}return this}getComponent(y){switch(y){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+y)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(y){return this.x=y.x,this.y=y.y,this.z=y.z,this.w=y.w!==void 0?y.w:1,this}add(y){return this.x+=y.x,this.y+=y.y,this.z+=y.z,this.w+=y.w,this}addScalar(y){return this.x+=y,this.y+=y,this.z+=y,this.w+=y,this}addVectors(y,b){return this.x=y.x+b.x,this.y=y.y+b.y,this.z=y.z+b.z,this.w=y.w+b.w,this}addScaledVector(y,b){return this.x+=y.x*b,this.y+=y.y*b,this.z+=y.z*b,this.w+=y.w*b,this}sub(y){return this.x-=y.x,this.y-=y.y,this.z-=y.z,this.w-=y.w,this}subScalar(y){return this.x-=y,this.y-=y,this.z-=y,this.w-=y,this}subVectors(y,b){return this.x=y.x-b.x,this.y=y.y-b.y,this.z=y.z-b.z,this.w=y.w-b.w,this}multiply(y){return this.x*=y.x,this.y*=y.y,this.z*=y.z,this.w*=y.w,this}multiplyScalar(y){return this.x*=y,this.y*=y,this.z*=y,this.w*=y,this}applyMatrix4(y){const b=this.x,D=this.y,Y=this.z,_e=this.w,Le=y.elements;return this.x=Le[0]*b+Le[4]*D+Le[8]*Y+Le[12]*_e,this.y=Le[1]*b+Le[5]*D+Le[9]*Y+Le[13]*_e,this.z=Le[2]*b+Le[6]*D+Le[10]*Y+Le[14]*_e,this.w=Le[3]*b+Le[7]*D+Le[11]*Y+Le[15]*_e,this}divideScalar(y){return this.multiplyScalar(1/y)}setAxisAngleFromQuaternion(y){this.w=2*Math.acos(y.w);const b=Math.sqrt(1-y.w*y.w);return b<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=y.x/b,this.y=y.y/b,this.z=y.z/b),this}setAxisAngleFromRotationMatrix(y){let b,D,Y,_e;const it=y.elements,nt=it[0],mt=it[4],bt=it[8],At=it[1],wt=it[5],Et=it[9],Mt=it[2],St=it[6],Nt=it[10];if(Math.abs(mt-At)<.01&&Math.abs(bt-Mt)<.01&&Math.abs(Et-St)<.01){if(Math.abs(mt+At)<.1&&Math.abs(bt+Mt)<.1&&Math.abs(Et+St)<.1&&Math.abs(nt+wt+Nt-3)<.1)return this.set(1,0,0,0),this;b=Math.PI;const Rt=(nt+1)/2,Yt=(wt+1)/2,Kt=(Nt+1)/2,Xt=(mt+At)/4,oi=(bt+Mt)/4,wi=(Et+St)/4;return Rt>Yt&&Rt>Kt?Rt<.01?(D=0,Y=.707106781,_e=.707106781):(D=Math.sqrt(Rt),Y=Xt/D,_e=oi/D):Yt>Kt?Yt<.01?(D=.707106781,Y=0,_e=.707106781):(Y=Math.sqrt(Yt),D=Xt/Y,_e=wi/Y):Kt<.01?(D=.707106781,Y=.707106781,_e=0):(_e=Math.sqrt(Kt),D=oi/_e,Y=wi/_e),this.set(D,Y,_e,b),this}let It=Math.sqrt((St-Et)*(St-Et)+(bt-Mt)*(bt-Mt)+(At-mt)*(At-mt));return Math.abs(It)<.001&&(It=1),this.x=(St-Et)/It,this.y=(bt-Mt)/It,this.z=(At-mt)/It,this.w=Math.acos((nt+wt+Nt-1)/2),this}min(y){return this.x=Math.min(this.x,y.x),this.y=Math.min(this.y,y.y),this.z=Math.min(this.z,y.z),this.w=Math.min(this.w,y.w),this}max(y){return this.x=Math.max(this.x,y.x),this.y=Math.max(this.y,y.y),this.z=Math.max(this.z,y.z),this.w=Math.max(this.w,y.w),this}clamp(y,b){return this.x=Math.max(y.x,Math.min(b.x,this.x)),this.y=Math.max(y.y,Math.min(b.y,this.y)),this.z=Math.max(y.z,Math.min(b.z,this.z)),this.w=Math.max(y.w,Math.min(b.w,this.w)),this}clampScalar(y,b){return this.x=Math.max(y,Math.min(b,this.x)),this.y=Math.max(y,Math.min(b,this.y)),this.z=Math.max(y,Math.min(b,this.z)),this.w=Math.max(y,Math.min(b,this.w)),this}clampLength(y,b){const D=this.length();return this.divideScalar(D||1).multiplyScalar(Math.max(y,Math.min(b,D)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(y){return this.x*y.x+this.y*y.y+this.z*y.z+this.w*y.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(y){return this.normalize().multiplyScalar(y)}lerp(y,b){return this.x+=(y.x-this.x)*b,this.y+=(y.y-this.y)*b,this.z+=(y.z-this.z)*b,this.w+=(y.w-this.w)*b,this}lerpVectors(y,b,D){return this.x=y.x+(b.x-y.x)*D,this.y=y.y+(b.y-y.y)*D,this.z=y.z+(b.z-y.z)*D,this.w=y.w+(b.w-y.w)*D,this}equals(y){return y.x===this.x&&y.y===this.y&&y.z===this.z&&y.w===this.w}fromArray(y,b=0){return this.x=y[b],this.y=y[b+1],this.z=y[b+2],this.w=y[b+3],this}toArray(y=[],b=0){return y[b]=this.x,y[b+1]=this.y,y[b+2]=this.z,y[b+3]=this.w,y}fromBufferAttribute(y,b){return this.x=y.getX(b),this.y=y.getY(b),this.z=y.getZ(b),this.w=y.getW(b),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class Nu extends ho{constructor(y=1,b=1,D={}){super(),this.isRenderTarget=!0,this.width=y,this.height=b,this.depth=1,this.scissor=new Tr(0,0,y,b),this.scissorTest=!1,this.viewport=new Tr(0,0,y,b);const Y={width:y,height:b,depth:1};D.encoding!==void 0&&(zs("THREE.WebGLRenderTarget: option.encoding has been replaced by option.colorSpace."),D.colorSpace=D.encoding===ss?Rr:Cr),D=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:fn,depthBuffer:!0,stencilBuffer:!1,depthTexture:null,samples:0},D),this.texture=new Or(Y,D.mapping,D.wrapS,D.wrapT,D.magFilter,D.minFilter,D.format,D.type,D.anisotropy,D.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=D.generateMipmaps,this.texture.internalFormat=D.internalFormat,this.depthBuffer=D.depthBuffer,this.stencilBuffer=D.stencilBuffer,this.depthTexture=D.depthTexture,this.samples=D.samples}setSize(y,b,D=1){this.width===y&&this.height===b&&this.depth===D||(this.width=y,this.height=b,this.depth=D,this.texture.image.width=y,this.texture.image.height=b,this.texture.image.depth=D,this.dispose()),this.viewport.set(0,0,y,b),this.scissor.set(0,0,y,b)}clone(){return new this.constructor().copy(this)}copy(y){this.width=y.width,this.height=y.height,this.depth=y.depth,this.scissor.copy(y.scissor),this.scissorTest=y.scissorTest,this.viewport.copy(y.viewport),this.texture=y.texture.clone(),this.texture.isRenderTargetTexture=!0;const b=Object.assign({},y.texture.image);return this.texture.source=new Go(b),this.depthBuffer=y.depthBuffer,this.stencilBuffer=y.stencilBuffer,y.depthTexture&&(this.depthTexture=y.depthTexture.clone()),this.samples=y.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class yo extends Nu{constructor(y=1,b=1,D={}){super(y,b,D),this.isWebGLRenderTarget=!0}}class Dl extends Or{constructor(y=null,b=1,D=1,Y=1){super(null),this.isDataArrayTexture=!0,this.image={data:y,width:b,height:D,depth:Y},this.magFilter=Yi,this.minFilter=Yi,this.wrapR=an,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Nc extends yo{constructor(y=1,b=1,D=1){super(y,b),this.isWebGLArrayRenderTarget=!0,this.depth=D,this.texture=new Dl(null,y,b,D),this.texture.isRenderTargetTexture=!0}}class kc extends Or{constructor(y=null,b=1,D=1,Y=1){super(null),this.isData3DTexture=!0,this.image={data:y,width:b,height:D,depth:Y},this.magFilter=Yi,this.minFilter=Yi,this.wrapR=an,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class ph extends yo{constructor(y=1,b=1,D=1){super(y,b),this.isWebGL3DRenderTarget=!0,this.depth=D,this.texture=new kc(null,y,b,D),this.texture.isRenderTargetTexture=!0}}class Uc extends yo{constructor(y=1,b=1,D=1,Y={}){super(y,b,Y),this.isWebGLMultipleRenderTargets=!0;const _e=this.texture;this.texture=[];for(let Le=0;Le<D;Le++)this.texture[Le]=_e.clone(),this.texture[Le].isRenderTargetTexture=!0}setSize(y,b,D=1){if(this.width!==y||this.height!==b||this.depth!==D){this.width=y,this.height=b,this.depth=D;for(let Y=0,_e=this.texture.length;Y<_e;Y++)this.texture[Y].image.width=y,this.texture[Y].image.height=b,this.texture[Y].image.depth=D;this.dispose()}this.viewport.set(0,0,y,b),this.scissor.set(0,0,y,b)}copy(y){this.dispose(),this.width=y.width,this.height=y.height,this.depth=y.depth,this.scissor.copy(y.scissor),this.scissorTest=y.scissorTest,this.viewport.copy(y.viewport),this.depthBuffer=y.depthBuffer,this.stencilBuffer=y.stencilBuffer,y.depthTexture!==null&&(this.depthTexture=y.depthTexture.clone()),this.texture.length=0;for(let b=0,D=y.texture.length;b<D;b++)this.texture[b]=y.texture[b].clone(),this.texture[b].isRenderTargetTexture=!0;return this}}class Ao{constructor(y=0,b=0,D=0,Y=1){this.isQuaternion=!0,this._x=y,this._y=b,this._z=D,this._w=Y}static slerpFlat(y,b,D,Y,_e,Le,qe){let it=D[Y+0],nt=D[Y+1],mt=D[Y+2],bt=D[Y+3];const At=_e[Le+0],wt=_e[Le+1],Et=_e[Le+2],Mt=_e[Le+3];if(qe===0)return y[b+0]=it,y[b+1]=nt,y[b+2]=mt,void(y[b+3]=bt);if(qe===1)return y[b+0]=At,y[b+1]=wt,y[b+2]=Et,void(y[b+3]=Mt);if(bt!==Mt||it!==At||nt!==wt||mt!==Et){let St=1-qe;const Nt=it*At+nt*wt+mt*Et+bt*Mt,It=Nt>=0?1:-1,Rt=1-Nt*Nt;if(Rt>Number.EPSILON){const Kt=Math.sqrt(Rt),Xt=Math.atan2(Kt,Nt*It);St=Math.sin(St*Xt)/Kt,qe=Math.sin(qe*Xt)/Kt}const Yt=qe*It;if(it=it*St+At*Yt,nt=nt*St+wt*Yt,mt=mt*St+Et*Yt,bt=bt*St+Mt*Yt,St===1-qe){const Kt=1/Math.sqrt(it*it+nt*nt+mt*mt+bt*bt);it*=Kt,nt*=Kt,mt*=Kt,bt*=Kt}}y[b]=it,y[b+1]=nt,y[b+2]=mt,y[b+3]=bt}static multiplyQuaternionsFlat(y,b,D,Y,_e,Le){const qe=D[Y],it=D[Y+1],nt=D[Y+2],mt=D[Y+3],bt=_e[Le],At=_e[Le+1],wt=_e[Le+2],Et=_e[Le+3];return y[b]=qe*Et+mt*bt+it*wt-nt*At,y[b+1]=it*Et+mt*At+nt*bt-qe*wt,y[b+2]=nt*Et+mt*wt+qe*At-it*bt,y[b+3]=mt*Et-qe*bt-it*At-nt*wt,y}get x(){return this._x}set x(y){this._x=y,this._onChangeCallback()}get y(){return this._y}set y(y){this._y=y,this._onChangeCallback()}get z(){return this._z}set z(y){this._z=y,this._onChangeCallback()}get w(){return this._w}set w(y){this._w=y,this._onChangeCallback()}set(y,b,D,Y){return this._x=y,this._y=b,this._z=D,this._w=Y,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(y){return this._x=y.x,this._y=y.y,this._z=y.z,this._w=y.w,this._onChangeCallback(),this}setFromEuler(y,b){const D=y._x,Y=y._y,_e=y._z,Le=y._order,qe=Math.cos,it=Math.sin,nt=qe(D/2),mt=qe(Y/2),bt=qe(_e/2),At=it(D/2),wt=it(Y/2),Et=it(_e/2);switch(Le){case"XYZ":this._x=At*mt*bt+nt*wt*Et,this._y=nt*wt*bt-At*mt*Et,this._z=nt*mt*Et+At*wt*bt,this._w=nt*mt*bt-At*wt*Et;break;case"YXZ":this._x=At*mt*bt+nt*wt*Et,this._y=nt*wt*bt-At*mt*Et,this._z=nt*mt*Et-At*wt*bt,this._w=nt*mt*bt+At*wt*Et;break;case"ZXY":this._x=At*mt*bt-nt*wt*Et,this._y=nt*wt*bt+At*mt*Et,this._z=nt*mt*Et+At*wt*bt,this._w=nt*mt*bt-At*wt*Et;break;case"ZYX":this._x=At*mt*bt-nt*wt*Et,this._y=nt*wt*bt+At*mt*Et,this._z=nt*mt*Et-At*wt*bt,this._w=nt*mt*bt+At*wt*Et;break;case"YZX":this._x=At*mt*bt+nt*wt*Et,this._y=nt*wt*bt+At*mt*Et,this._z=nt*mt*Et-At*wt*bt,this._w=nt*mt*bt-At*wt*Et;break;case"XZY":this._x=At*mt*bt-nt*wt*Et,this._y=nt*wt*bt-At*mt*Et,this._z=nt*mt*Et+At*wt*bt,this._w=nt*mt*bt+At*wt*Et;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+Le)}return b!==!1&&this._onChangeCallback(),this}setFromAxisAngle(y,b){const D=b/2,Y=Math.sin(D);return this._x=y.x*Y,this._y=y.y*Y,this._z=y.z*Y,this._w=Math.cos(D),this._onChangeCallback(),this}setFromRotationMatrix(y){const b=y.elements,D=b[0],Y=b[4],_e=b[8],Le=b[1],qe=b[5],it=b[9],nt=b[2],mt=b[6],bt=b[10],At=D+qe+bt;if(At>0){const wt=.5/Math.sqrt(At+1);this._w=.25/wt,this._x=(mt-it)*wt,this._y=(_e-nt)*wt,this._z=(Le-Y)*wt}else if(D>qe&&D>bt){const wt=2*Math.sqrt(1+D-qe-bt);this._w=(mt-it)/wt,this._x=.25*wt,this._y=(Y+Le)/wt,this._z=(_e+nt)/wt}else if(qe>bt){const wt=2*Math.sqrt(1+qe-D-bt);this._w=(_e-nt)/wt,this._x=(Y+Le)/wt,this._y=.25*wt,this._z=(it+mt)/wt}else{const wt=2*Math.sqrt(1+bt-D-qe);this._w=(Le-Y)/wt,this._x=(_e+nt)/wt,this._y=(it+mt)/wt,this._z=.25*wt}return this._onChangeCallback(),this}setFromUnitVectors(y,b){let D=y.dot(b)+1;return D<Number.EPSILON?(D=0,Math.abs(y.x)>Math.abs(y.z)?(this._x=-y.y,this._y=y.x,this._z=0,this._w=D):(this._x=0,this._y=-y.z,this._z=y.y,this._w=D)):(this._x=y.y*b.z-y.z*b.y,this._y=y.z*b.x-y.x*b.z,this._z=y.x*b.y-y.y*b.x,this._w=D),this.normalize()}angleTo(y){return 2*Math.acos(Math.abs(Ur(this.dot(y),-1,1)))}rotateTowards(y,b){const D=this.angleTo(y);if(D===0)return this;const Y=Math.min(1,b/D);return this.slerp(y,Y),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(y){return this._x*y._x+this._y*y._y+this._z*y._z+this._w*y._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let y=this.length();return y===0?(this._x=0,this._y=0,this._z=0,this._w=1):(y=1/y,this._x=this._x*y,this._y=this._y*y,this._z=this._z*y,this._w=this._w*y),this._onChangeCallback(),this}multiply(y){return this.multiplyQuaternions(this,y)}premultiply(y){return this.multiplyQuaternions(y,this)}multiplyQuaternions(y,b){const D=y._x,Y=y._y,_e=y._z,Le=y._w,qe=b._x,it=b._y,nt=b._z,mt=b._w;return this._x=D*mt+Le*qe+Y*nt-_e*it,this._y=Y*mt+Le*it+_e*qe-D*nt,this._z=_e*mt+Le*nt+D*it-Y*qe,this._w=Le*mt-D*qe-Y*it-_e*nt,this._onChangeCallback(),this}slerp(y,b){if(b===0)return this;if(b===1)return this.copy(y);const D=this._x,Y=this._y,_e=this._z,Le=this._w;let qe=Le*y._w+D*y._x+Y*y._y+_e*y._z;if(qe<0?(this._w=-y._w,this._x=-y._x,this._y=-y._y,this._z=-y._z,qe=-qe):this.copy(y),qe>=1)return this._w=Le,this._x=D,this._y=Y,this._z=_e,this;const it=1-qe*qe;if(it<=Number.EPSILON){const wt=1-b;return this._w=wt*Le+b*this._w,this._x=wt*D+b*this._x,this._y=wt*Y+b*this._y,this._z=wt*_e+b*this._z,this.normalize(),this._onChangeCallback(),this}const nt=Math.sqrt(it),mt=Math.atan2(nt,qe),bt=Math.sin((1-b)*mt)/nt,At=Math.sin(b*mt)/nt;return this._w=Le*bt+this._w*At,this._x=D*bt+this._x*At,this._y=Y*bt+this._y*At,this._z=_e*bt+this._z*At,this._onChangeCallback(),this}slerpQuaternions(y,b,D){return this.copy(y).slerp(b,D)}random(){const y=Math.random(),b=Math.sqrt(1-y),D=Math.sqrt(y),Y=2*Math.PI*Math.random(),_e=2*Math.PI*Math.random();return this.set(b*Math.cos(Y),D*Math.sin(_e),D*Math.cos(_e),b*Math.sin(Y))}equals(y){return y._x===this._x&&y._y===this._y&&y._z===this._z&&y._w===this._w}fromArray(y,b=0){return this._x=y[b],this._y=y[b+1],this._z=y[b+2],this._w=y[b+3],this._onChangeCallback(),this}toArray(y=[],b=0){return y[b]=this._x,y[b+1]=this._y,y[b+2]=this._z,y[b+3]=this._w,y}fromBufferAttribute(y,b){return this._x=y.getX(b),this._y=y.getY(b),this._z=y.getZ(b),this._w=y.getW(b),this}toJSON(){return this.toArray()}_onChange(y){return this._onChangeCallback=y,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class ii{constructor(y=0,b=0,D=0){ii.prototype.isVector3=!0,this.x=y,this.y=b,this.z=D}set(y,b,D){return D===void 0&&(D=this.z),this.x=y,this.y=b,this.z=D,this}setScalar(y){return this.x=y,this.y=y,this.z=y,this}setX(y){return this.x=y,this}setY(y){return this.y=y,this}setZ(y){return this.z=y,this}setComponent(y,b){switch(y){case 0:this.x=b;break;case 1:this.y=b;break;case 2:this.z=b;break;default:throw new Error("index is out of range: "+y)}return this}getComponent(y){switch(y){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+y)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(y){return this.x=y.x,this.y=y.y,this.z=y.z,this}add(y){return this.x+=y.x,this.y+=y.y,this.z+=y.z,this}addScalar(y){return this.x+=y,this.y+=y,this.z+=y,this}addVectors(y,b){return this.x=y.x+b.x,this.y=y.y+b.y,this.z=y.z+b.z,this}addScaledVector(y,b){return this.x+=y.x*b,this.y+=y.y*b,this.z+=y.z*b,this}sub(y){return this.x-=y.x,this.y-=y.y,this.z-=y.z,this}subScalar(y){return this.x-=y,this.y-=y,this.z-=y,this}subVectors(y,b){return this.x=y.x-b.x,this.y=y.y-b.y,this.z=y.z-b.z,this}multiply(y){return this.x*=y.x,this.y*=y.y,this.z*=y.z,this}multiplyScalar(y){return this.x*=y,this.y*=y,this.z*=y,this}multiplyVectors(y,b){return this.x=y.x*b.x,this.y=y.y*b.y,this.z=y.z*b.z,this}applyEuler(y){return this.applyQuaternion(Bl.setFromEuler(y))}applyAxisAngle(y,b){return this.applyQuaternion(Bl.setFromAxisAngle(y,b))}applyMatrix3(y){const b=this.x,D=this.y,Y=this.z,_e=y.elements;return this.x=_e[0]*b+_e[3]*D+_e[6]*Y,this.y=_e[1]*b+_e[4]*D+_e[7]*Y,this.z=_e[2]*b+_e[5]*D+_e[8]*Y,this}applyNormalMatrix(y){return this.applyMatrix3(y).normalize()}applyMatrix4(y){const b=this.x,D=this.y,Y=this.z,_e=y.elements,Le=1/(_e[3]*b+_e[7]*D+_e[11]*Y+_e[15]);return this.x=(_e[0]*b+_e[4]*D+_e[8]*Y+_e[12])*Le,this.y=(_e[1]*b+_e[5]*D+_e[9]*Y+_e[13])*Le,this.z=(_e[2]*b+_e[6]*D+_e[10]*Y+_e[14])*Le,this}applyQuaternion(y){const b=this.x,D=this.y,Y=this.z,_e=y.x,Le=y.y,qe=y.z,it=y.w,nt=it*b+Le*Y-qe*D,mt=it*D+qe*b-_e*Y,bt=it*Y+_e*D-Le*b,At=-_e*b-Le*D-qe*Y;return this.x=nt*it+At*-_e+mt*-qe-bt*-Le,this.y=mt*it+At*-Le+bt*-_e-nt*-qe,this.z=bt*it+At*-qe+nt*-Le-mt*-_e,this}project(y){return this.applyMatrix4(y.matrixWorldInverse).applyMatrix4(y.projectionMatrix)}unproject(y){return this.applyMatrix4(y.projectionMatrixInverse).applyMatrix4(y.matrixWorld)}transformDirection(y){const b=this.x,D=this.y,Y=this.z,_e=y.elements;return this.x=_e[0]*b+_e[4]*D+_e[8]*Y,this.y=_e[1]*b+_e[5]*D+_e[9]*Y,this.z=_e[2]*b+_e[6]*D+_e[10]*Y,this.normalize()}divide(y){return this.x/=y.x,this.y/=y.y,this.z/=y.z,this}divideScalar(y){return this.multiplyScalar(1/y)}min(y){return this.x=Math.min(this.x,y.x),this.y=Math.min(this.y,y.y),this.z=Math.min(this.z,y.z),this}max(y){return this.x=Math.max(this.x,y.x),this.y=Math.max(this.y,y.y),this.z=Math.max(this.z,y.z),this}clamp(y,b){return this.x=Math.max(y.x,Math.min(b.x,this.x)),this.y=Math.max(y.y,Math.min(b.y,this.y)),this.z=Math.max(y.z,Math.min(b.z,this.z)),this}clampScalar(y,b){return this.x=Math.max(y,Math.min(b,this.x)),this.y=Math.max(y,Math.min(b,this.y)),this.z=Math.max(y,Math.min(b,this.z)),this}clampLength(y,b){const D=this.length();return this.divideScalar(D||1).multiplyScalar(Math.max(y,Math.min(b,D)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(y){return this.x*y.x+this.y*y.y+this.z*y.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(y){return this.normalize().multiplyScalar(y)}lerp(y,b){return this.x+=(y.x-this.x)*b,this.y+=(y.y-this.y)*b,this.z+=(y.z-this.z)*b,this}lerpVectors(y,b,D){return this.x=y.x+(b.x-y.x)*D,this.y=y.y+(b.y-y.y)*D,this.z=y.z+(b.z-y.z)*D,this}cross(y){return this.crossVectors(this,y)}crossVectors(y,b){const D=y.x,Y=y.y,_e=y.z,Le=b.x,qe=b.y,it=b.z;return this.x=Y*it-_e*qe,this.y=_e*Le-D*it,this.z=D*qe-Y*Le,this}projectOnVector(y){const b=y.lengthSq();if(b===0)return this.set(0,0,0);const D=y.dot(this)/b;return this.copy(y).multiplyScalar(D)}projectOnPlane(y){return Fc.copy(this).projectOnVector(y),this.sub(Fc)}reflect(y){return this.sub(Fc.copy(y).multiplyScalar(2*this.dot(y)))}angleTo(y){const b=Math.sqrt(this.lengthSq()*y.lengthSq());if(b===0)return Math.PI/2;const D=this.dot(y)/b;return Math.acos(Ur(D,-1,1))}distanceTo(y){return Math.sqrt(this.distanceToSquared(y))}distanceToSquared(y){const b=this.x-y.x,D=this.y-y.y,Y=this.z-y.z;return b*b+D*D+Y*Y}manhattanDistanceTo(y){return Math.abs(this.x-y.x)+Math.abs(this.y-y.y)+Math.abs(this.z-y.z)}setFromSpherical(y){return this.setFromSphericalCoords(y.radius,y.phi,y.theta)}setFromSphericalCoords(y,b,D){const Y=Math.sin(b)*y;return this.x=Y*Math.sin(D),this.y=Math.cos(b)*y,this.z=Y*Math.cos(D),this}setFromCylindrical(y){return this.setFromCylindricalCoords(y.radius,y.theta,y.y)}setFromCylindricalCoords(y,b,D){return this.x=y*Math.sin(b),this.y=D,this.z=y*Math.cos(b),this}setFromMatrixPosition(y){const b=y.elements;return this.x=b[12],this.y=b[13],this.z=b[14],this}setFromMatrixScale(y){const b=this.setFromMatrixColumn(y,0).length(),D=this.setFromMatrixColumn(y,1).length(),Y=this.setFromMatrixColumn(y,2).length();return this.x=b,this.y=D,this.z=Y,this}setFromMatrixColumn(y,b){return this.fromArray(y.elements,4*b)}setFromMatrix3Column(y,b){return this.fromArray(y.elements,3*b)}setFromEuler(y){return this.x=y._x,this.y=y._y,this.z=y._z,this}setFromColor(y){return this.x=y.r,this.y=y.g,this.z=y.b,this}equals(y){return y.x===this.x&&y.y===this.y&&y.z===this.z}fromArray(y,b=0){return this.x=y[b],this.y=y[b+1],this.z=y[b+2],this}toArray(y=[],b=0){return y[b]=this.x,y[b+1]=this.y,y[b+2]=this.z,y}fromBufferAttribute(y,b){return this.x=y.getX(b),this.y=y.getY(b),this.z=y.getZ(b),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const y=2*(Math.random()-.5),b=Math.random()*Math.PI*2,D=Math.sqrt(1-y**2);return this.x=D*Math.cos(b),this.y=D*Math.sin(b),this.z=y,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const Fc=new ii,Bl=new Ao;class Ko{constructor(y=new ii(1/0,1/0,1/0),b=new ii(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=y,this.max=b}set(y,b){return this.min.copy(y),this.max.copy(b),this}setFromArray(y){this.makeEmpty();for(let b=0,D=y.length;b<D;b+=3)this.expandByPoint(zo.fromArray(y,b));return this}setFromBufferAttribute(y){this.makeEmpty();for(let b=0,D=y.count;b<D;b++)this.expandByPoint(zo.fromBufferAttribute(y,b));return this}setFromPoints(y){this.makeEmpty();for(let b=0,D=y.length;b<D;b++)this.expandByPoint(y[b]);return this}setFromCenterAndSize(y,b){const D=zo.copy(b).multiplyScalar(.5);return this.min.copy(y).sub(D),this.max.copy(y).add(D),this}setFromObject(y,b=!1){return this.makeEmpty(),this.expandByObject(y,b)}clone(){return new this.constructor().copy(this)}copy(y){return this.min.copy(y.min),this.max.copy(y.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(y){return this.isEmpty()?y.set(0,0,0):y.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(y){return this.isEmpty()?y.set(0,0,0):y.subVectors(this.max,this.min)}expandByPoint(y){return this.min.min(y),this.max.max(y),this}expandByVector(y){return this.min.sub(y),this.max.add(y),this}expandByScalar(y){return this.min.addScalar(-y),this.max.addScalar(y),this}expandByObject(y,b=!1){if(y.updateWorldMatrix(!1,!1),y.boundingBox!==void 0)y.boundingBox===null&&y.computeBoundingBox(),ua.copy(y.boundingBox),ua.applyMatrix4(y.matrixWorld),this.union(ua);else{const Y=y.geometry;if(Y!==void 0)if(b&&Y.attributes!==void 0&&Y.attributes.position!==void 0){const _e=Y.attributes.position;for(let Le=0,qe=_e.count;Le<qe;Le++)zo.fromBufferAttribute(_e,Le).applyMatrix4(y.matrixWorld),this.expandByPoint(zo)}else Y.boundingBox===null&&Y.computeBoundingBox(),ua.copy(Y.boundingBox),ua.applyMatrix4(y.matrixWorld),this.union(ua)}const D=y.children;for(let Y=0,_e=D.length;Y<_e;Y++)this.expandByObject(D[Y],b);return this}containsPoint(y){return!(y.x<this.min.x||y.x>this.max.x||y.y<this.min.y||y.y>this.max.y||y.z<this.min.z||y.z>this.max.z)}containsBox(y){return this.min.x<=y.min.x&&y.max.x<=this.max.x&&this.min.y<=y.min.y&&y.max.y<=this.max.y&&this.min.z<=y.min.z&&y.max.z<=this.max.z}getParameter(y,b){return b.set((y.x-this.min.x)/(this.max.x-this.min.x),(y.y-this.min.y)/(this.max.y-this.min.y),(y.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(y){return!(y.max.x<this.min.x||y.min.x>this.max.x||y.max.y<this.min.y||y.min.y>this.max.y||y.max.z<this.min.z||y.min.z>this.max.z)}intersectsSphere(y){return this.clampPoint(y.center,zo),zo.distanceToSquared(y.center)<=y.radius*y.radius}intersectsPlane(y){let b,D;return y.normal.x>0?(b=y.normal.x*this.min.x,D=y.normal.x*this.max.x):(b=y.normal.x*this.max.x,D=y.normal.x*this.min.x),y.normal.y>0?(b+=y.normal.y*this.min.y,D+=y.normal.y*this.max.y):(b+=y.normal.y*this.max.y,D+=y.normal.y*this.min.y),y.normal.z>0?(b+=y.normal.z*this.min.z,D+=y.normal.z*this.max.z):(b+=y.normal.z*this.max.z,D+=y.normal.z*this.min.z),b<=-y.constant&&D>=-y.constant}intersectsTriangle(y){if(this.isEmpty())return!1;this.getCenter(Va),Ol.subVectors(this.max,Va),da.subVectors(y.a,Va),ha.subVectors(y.b,Va),pa.subVectors(y.c,Va),$o.subVectors(ha,da),bs.subVectors(pa,ha),Hs.subVectors(da,pa);let b=[0,-$o.z,$o.y,0,-bs.z,bs.y,0,-Hs.z,Hs.y,$o.z,0,-$o.x,bs.z,0,-bs.x,Hs.z,0,-Hs.x,-$o.y,$o.x,0,-bs.y,bs.x,0,-Hs.y,Hs.x,0];return!!Jo(b,da,ha,pa,Ol)&&(b=[1,0,0,0,1,0,0,0,1],!!Jo(b,da,ha,pa,Ol)&&(Ll.crossVectors($o,bs),b=[Ll.x,Ll.y,Ll.z],Jo(b,da,ha,pa,Ol)))}clampPoint(y,b){return b.copy(y).clamp(this.min,this.max)}distanceToPoint(y){return this.clampPoint(y,zo).distanceTo(y)}getBoundingSphere(y){return this.isEmpty()?y.makeEmpty():(this.getCenter(y.center),y.radius=.5*this.getSize(zo).length()),y}intersect(y){return this.min.max(y.min),this.max.min(y.max),this.isEmpty()&&this.makeEmpty(),this}union(y){return this.min.min(y.min),this.max.max(y.max),this}applyMatrix4(y){return this.isEmpty()||(as[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(y),as[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(y),as[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(y),as[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(y),as[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(y),as[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(y),as[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(y),as[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(y),this.setFromPoints(as)),this}translate(y){return this.min.add(y),this.max.add(y),this}equals(y){return y.min.equals(this.min)&&y.max.equals(this.max)}}const as=[new ii,new ii,new ii,new ii,new ii,new ii,new ii,new ii],zo=new ii,ua=new Ko,da=new ii,ha=new ii,pa=new ii,$o=new ii,bs=new ii,Hs=new ii,Va=new ii,Ol=new ii,Ll=new ii,Qs=new ii;function Jo(De,y,b,D,Y){for(let _e=0,Le=De.length-3;_e<=Le;_e+=3){Qs.fromArray(De,_e);const qe=Y.x*Math.abs(Qs.x)+Y.y*Math.abs(Qs.y)+Y.z*Math.abs(Qs.z),it=y.dot(Qs),nt=b.dot(Qs),mt=D.dot(Qs);if(Math.max(-Math.max(it,nt,mt),Math.min(it,nt,mt))>qe)return!1}return!0}const ku=new Ko,Ha=new ii,Qa=new ii;class Oo{constructor(y=new ii,b=-1){this.center=y,this.radius=b}set(y,b){return this.center.copy(y),this.radius=b,this}setFromPoints(y,b){const D=this.center;b!==void 0?D.copy(b):ku.setFromPoints(y).getCenter(D);let Y=0;for(let _e=0,Le=y.length;_e<Le;_e++)Y=Math.max(Y,D.distanceToSquared(y[_e]));return this.radius=Math.sqrt(Y),this}copy(y){return this.center.copy(y.center),this.radius=y.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(y){return y.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(y){return y.distanceTo(this.center)-this.radius}intersectsSphere(y){const b=this.radius+y.radius;return y.center.distanceToSquared(this.center)<=b*b}intersectsBox(y){return y.intersectsSphere(this)}intersectsPlane(y){return Math.abs(y.distanceToPoint(this.center))<=this.radius}clampPoint(y,b){const D=this.center.distanceToSquared(y);return b.copy(y),D>this.radius*this.radius&&(b.sub(this.center).normalize(),b.multiplyScalar(this.radius).add(this.center)),b}getBoundingBox(y){return this.isEmpty()?(y.makeEmpty(),y):(y.set(this.center,this.center),y.expandByScalar(this.radius),y)}applyMatrix4(y){return this.center.applyMatrix4(y),this.radius=this.radius*y.getMaxScaleOnAxis(),this}translate(y){return this.center.add(y),this}expandByPoint(y){if(this.isEmpty())return this.center.copy(y),this.radius=0,this;Ha.subVectors(y,this.center);const b=Ha.lengthSq();if(b>this.radius*this.radius){const D=Math.sqrt(b),Y=.5*(D-this.radius);this.center.addScaledVector(Ha,Y/D),this.radius+=Y}return this}union(y){return y.isEmpty()?this:this.isEmpty()?(this.copy(y),this):(this.center.equals(y.center)===!0?this.radius=Math.max(this.radius,y.radius):(Qa.subVectors(y.center,this.center).setLength(y.radius),this.expandByPoint(Ha.copy(y.center).add(Qa)),this.expandByPoint(Ha.copy(y.center).sub(Qa))),this)}equals(y){return y.center.equals(this.center)&&y.radius===this.radius}clone(){return new this.constructor().copy(this)}}const Zo=new ii,jc=new ii,Vo=new ii,ls=new ii,xs=new ii,Nl=new ii,ts=new ii;class ma{constructor(y=new ii,b=new ii(0,0,-1)){this.origin=y,this.direction=b}set(y,b){return this.origin.copy(y),this.direction.copy(b),this}copy(y){return this.origin.copy(y.origin),this.direction.copy(y.direction),this}at(y,b){return b.copy(this.origin).addScaledVector(this.direction,y)}lookAt(y){return this.direction.copy(y).sub(this.origin).normalize(),this}recast(y){return this.origin.copy(this.at(y,Zo)),this}closestPointToPoint(y,b){b.subVectors(y,this.origin);const D=b.dot(this.direction);return D<0?b.copy(this.origin):b.copy(this.origin).addScaledVector(this.direction,D)}distanceToPoint(y){return Math.sqrt(this.distanceSqToPoint(y))}distanceSqToPoint(y){const b=Zo.subVectors(y,this.origin).dot(this.direction);return b<0?this.origin.distanceToSquared(y):(Zo.copy(this.origin).addScaledVector(this.direction,b),Zo.distanceToSquared(y))}distanceSqToSegment(y,b,D,Y){jc.copy(y).add(b).multiplyScalar(.5),Vo.copy(b).sub(y).normalize(),ls.copy(this.origin).sub(jc);const _e=.5*y.distanceTo(b),Le=-this.direction.dot(Vo),qe=ls.dot(this.direction),it=-ls.dot(Vo),nt=ls.lengthSq(),mt=Math.abs(1-Le*Le);let bt,At,wt,Et;if(mt>0)if(bt=Le*it-qe,At=Le*qe-it,Et=_e*mt,bt>=0)if(At>=-Et)if(At<=Et){const Mt=1/mt;bt*=Mt,At*=Mt,wt=bt*(bt+Le*At+2*qe)+At*(Le*bt+At+2*it)+nt}else At=_e,bt=Math.max(0,-(Le*At+qe)),wt=-bt*bt+At*(At+2*it)+nt;else At=-_e,bt=Math.max(0,-(Le*At+qe)),wt=-bt*bt+At*(At+2*it)+nt;else At<=-Et?(bt=Math.max(0,-(-Le*_e+qe)),At=bt>0?-_e:Math.min(Math.max(-_e,-it),_e),wt=-bt*bt+At*(At+2*it)+nt):At<=Et?(bt=0,At=Math.min(Math.max(-_e,-it),_e),wt=At*(At+2*it)+nt):(bt=Math.max(0,-(Le*_e+qe)),At=bt>0?_e:Math.min(Math.max(-_e,-it),_e),wt=-bt*bt+At*(At+2*it)+nt);else At=Le>0?-_e:_e,bt=Math.max(0,-(Le*At+qe)),wt=-bt*bt+At*(At+2*it)+nt;return D&&D.copy(this.origin).addScaledVector(this.direction,bt),Y&&Y.copy(jc).addScaledVector(Vo,At),wt}intersectSphere(y,b){Zo.subVectors(y.center,this.origin);const D=Zo.dot(this.direction),Y=Zo.dot(Zo)-D*D,_e=y.radius*y.radius;if(Y>_e)return null;const Le=Math.sqrt(_e-Y),qe=D-Le,it=D+Le;return it<0?null:qe<0?this.at(it,b):this.at(qe,b)}intersectsSphere(y){return this.distanceSqToPoint(y.center)<=y.radius*y.radius}distanceToPlane(y){const b=y.normal.dot(this.direction);if(b===0)return y.distanceToPoint(this.origin)===0?0:null;const D=-(this.origin.dot(y.normal)+y.constant)/b;return D>=0?D:null}intersectPlane(y,b){const D=this.distanceToPlane(y);return D===null?null:this.at(D,b)}intersectsPlane(y){const b=y.distanceToPoint(this.origin);return b===0||y.normal.dot(this.direction)*b<0}intersectBox(y,b){let D,Y,_e,Le,qe,it;const nt=1/this.direction.x,mt=1/this.direction.y,bt=1/this.direction.z,At=this.origin;return nt>=0?(D=(y.min.x-At.x)*nt,Y=(y.max.x-At.x)*nt):(D=(y.max.x-At.x)*nt,Y=(y.min.x-At.x)*nt),mt>=0?(_e=(y.min.y-At.y)*mt,Le=(y.max.y-At.y)*mt):(_e=(y.max.y-At.y)*mt,Le=(y.min.y-At.y)*mt),D>Le||_e>Y?null:((_e>D||isNaN(D))&&(D=_e),(Le<Y||isNaN(Y))&&(Y=Le),bt>=0?(qe=(y.min.z-At.z)*bt,it=(y.max.z-At.z)*bt):(qe=(y.max.z-At.z)*bt,it=(y.min.z-At.z)*bt),D>it||qe>Y?null:((qe>D||D!=D)&&(D=qe),(it<Y||Y!=Y)&&(Y=it),Y<0?null:this.at(D>=0?D:Y,b)))}intersectsBox(y){return this.intersectBox(y,Zo)!==null}intersectTriangle(y,b,D,Y,_e){xs.subVectors(b,y),Nl.subVectors(D,y),ts.crossVectors(xs,Nl);let Le,qe=this.direction.dot(ts);if(qe>0){if(Y)return null;Le=1}else{if(!(qe<0))return null;Le=-1,qe=-qe}ls.subVectors(this.origin,y);const it=Le*this.direction.dot(Nl.crossVectors(ls,Nl));if(it<0)return null;const nt=Le*this.direction.dot(xs.cross(ls));if(nt<0||it+nt>qe)return null;const mt=-Le*ls.dot(ts);return mt<0?null:this.at(mt/qe,_e)}applyMatrix4(y){return this.origin.applyMatrix4(y),this.direction.transformDirection(y),this}equals(y){return y.origin.equals(this.origin)&&y.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class Xn{constructor(y,b,D,Y,_e,Le,qe,it,nt,mt,bt,At,wt,Et,Mt,St){Xn.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],y!==void 0&&this.set(y,b,D,Y,_e,Le,qe,it,nt,mt,bt,At,wt,Et,Mt,St)}set(y,b,D,Y,_e,Le,qe,it,nt,mt,bt,At,wt,Et,Mt,St){const Nt=this.elements;return Nt[0]=y,Nt[4]=b,Nt[8]=D,Nt[12]=Y,Nt[1]=_e,Nt[5]=Le,Nt[9]=qe,Nt[13]=it,Nt[2]=nt,Nt[6]=mt,Nt[10]=bt,Nt[14]=At,Nt[3]=wt,Nt[7]=Et,Nt[11]=Mt,Nt[15]=St,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new Xn().fromArray(this.elements)}copy(y){const b=this.elements,D=y.elements;return b[0]=D[0],b[1]=D[1],b[2]=D[2],b[3]=D[3],b[4]=D[4],b[5]=D[5],b[6]=D[6],b[7]=D[7],b[8]=D[8],b[9]=D[9],b[10]=D[10],b[11]=D[11],b[12]=D[12],b[13]=D[13],b[14]=D[14],b[15]=D[15],this}copyPosition(y){const b=this.elements,D=y.elements;return b[12]=D[12],b[13]=D[13],b[14]=D[14],this}setFromMatrix3(y){const b=y.elements;return this.set(b[0],b[3],b[6],0,b[1],b[4],b[7],0,b[2],b[5],b[8],0,0,0,0,1),this}extractBasis(y,b,D){return y.setFromMatrixColumn(this,0),b.setFromMatrixColumn(this,1),D.setFromMatrixColumn(this,2),this}makeBasis(y,b,D){return this.set(y.x,b.x,D.x,0,y.y,b.y,D.y,0,y.z,b.z,D.z,0,0,0,0,1),this}extractRotation(y){const b=this.elements,D=y.elements,Y=1/fa.setFromMatrixColumn(y,0).length(),_e=1/fa.setFromMatrixColumn(y,1).length(),Le=1/fa.setFromMatrixColumn(y,2).length();return b[0]=D[0]*Y,b[1]=D[1]*Y,b[2]=D[2]*Y,b[3]=0,b[4]=D[4]*_e,b[5]=D[5]*_e,b[6]=D[6]*_e,b[7]=0,b[8]=D[8]*Le,b[9]=D[9]*Le,b[10]=D[10]*Le,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,this}makeRotationFromEuler(y){const b=this.elements,D=y.x,Y=y.y,_e=y.z,Le=Math.cos(D),qe=Math.sin(D),it=Math.cos(Y),nt=Math.sin(Y),mt=Math.cos(_e),bt=Math.sin(_e);if(y.order==="XYZ"){const At=Le*mt,wt=Le*bt,Et=qe*mt,Mt=qe*bt;b[0]=it*mt,b[4]=-it*bt,b[8]=nt,b[1]=wt+Et*nt,b[5]=At-Mt*nt,b[9]=-qe*it,b[2]=Mt-At*nt,b[6]=Et+wt*nt,b[10]=Le*it}else if(y.order==="YXZ"){const At=it*mt,wt=it*bt,Et=nt*mt,Mt=nt*bt;b[0]=At+Mt*qe,b[4]=Et*qe-wt,b[8]=Le*nt,b[1]=Le*bt,b[5]=Le*mt,b[9]=-qe,b[2]=wt*qe-Et,b[6]=Mt+At*qe,b[10]=Le*it}else if(y.order==="ZXY"){const At=it*mt,wt=it*bt,Et=nt*mt,Mt=nt*bt;b[0]=At-Mt*qe,b[4]=-Le*bt,b[8]=Et+wt*qe,b[1]=wt+Et*qe,b[5]=Le*mt,b[9]=Mt-At*qe,b[2]=-Le*nt,b[6]=qe,b[10]=Le*it}else if(y.order==="ZYX"){const At=Le*mt,wt=Le*bt,Et=qe*mt,Mt=qe*bt;b[0]=it*mt,b[4]=Et*nt-wt,b[8]=At*nt+Mt,b[1]=it*bt,b[5]=Mt*nt+At,b[9]=wt*nt-Et,b[2]=-nt,b[6]=qe*it,b[10]=Le*it}else if(y.order==="YZX"){const At=Le*it,wt=Le*nt,Et=qe*it,Mt=qe*nt;b[0]=it*mt,b[4]=Mt-At*bt,b[8]=Et*bt+wt,b[1]=bt,b[5]=Le*mt,b[9]=-qe*mt,b[2]=-nt*mt,b[6]=wt*bt+Et,b[10]=At-Mt*bt}else if(y.order==="XZY"){const At=Le*it,wt=Le*nt,Et=qe*it,Mt=qe*nt;b[0]=it*mt,b[4]=-bt,b[8]=nt*mt,b[1]=At*bt+Mt,b[5]=Le*mt,b[9]=wt*bt-Et,b[2]=Et*bt-wt,b[6]=qe*mt,b[10]=Mt*bt+At}return b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,this}makeRotationFromQuaternion(y){return this.compose(ga,y,Uu)}lookAt(y,b,D){const Y=this.elements;return mo.subVectors(y,b),mo.lengthSq()===0&&(mo.z=1),mo.normalize(),ws.crossVectors(D,mo),ws.lengthSq()===0&&(Math.abs(D.z)===1?mo.x+=1e-4:mo.z+=1e-4,mo.normalize(),ws.crossVectors(D,mo)),ws.normalize(),kl.crossVectors(mo,ws),Y[0]=ws.x,Y[4]=kl.x,Y[8]=mo.x,Y[1]=ws.y,Y[5]=kl.y,Y[9]=mo.y,Y[2]=ws.z,Y[6]=kl.z,Y[10]=mo.z,this}multiply(y){return this.multiplyMatrices(this,y)}premultiply(y){return this.multiplyMatrices(y,this)}multiplyMatrices(y,b){const D=y.elements,Y=b.elements,_e=this.elements,Le=D[0],qe=D[4],it=D[8],nt=D[12],mt=D[1],bt=D[5],At=D[9],wt=D[13],Et=D[2],Mt=D[6],St=D[10],Nt=D[14],It=D[3],Rt=D[7],Yt=D[11],Kt=D[15],Xt=Y[0],oi=Y[4],wi=Y[8],fi=Y[12],yi=Y[1],bi=Y[5],Ci=Y[9],tn=Y[13],$i=Y[2],gn=Y[6],xn=Y[10],Wi=Y[14],Oi=Y[3],ki=Y[7],Hi=Y[11],Vi=Y[15];return _e[0]=Le*Xt+qe*yi+it*$i+nt*Oi,_e[4]=Le*oi+qe*bi+it*gn+nt*ki,_e[8]=Le*wi+qe*Ci+it*xn+nt*Hi,_e[12]=Le*fi+qe*tn+it*Wi+nt*Vi,_e[1]=mt*Xt+bt*yi+At*$i+wt*Oi,_e[5]=mt*oi+bt*bi+At*gn+wt*ki,_e[9]=mt*wi+bt*Ci+At*xn+wt*Hi,_e[13]=mt*fi+bt*tn+At*Wi+wt*Vi,_e[2]=Et*Xt+Mt*yi+St*$i+Nt*Oi,_e[6]=Et*oi+Mt*bi+St*gn+Nt*ki,_e[10]=Et*wi+Mt*Ci+St*xn+Nt*Hi,_e[14]=Et*fi+Mt*tn+St*Wi+Nt*Vi,_e[3]=It*Xt+Rt*yi+Yt*$i+Kt*Oi,_e[7]=It*oi+Rt*bi+Yt*gn+Kt*ki,_e[11]=It*wi+Rt*Ci+Yt*xn+Kt*Hi,_e[15]=It*fi+Rt*tn+Yt*Wi+Kt*Vi,this}multiplyScalar(y){const b=this.elements;return b[0]*=y,b[4]*=y,b[8]*=y,b[12]*=y,b[1]*=y,b[5]*=y,b[9]*=y,b[13]*=y,b[2]*=y,b[6]*=y,b[10]*=y,b[14]*=y,b[3]*=y,b[7]*=y,b[11]*=y,b[15]*=y,this}determinant(){const y=this.elements,b=y[0],D=y[4],Y=y[8],_e=y[12],Le=y[1],qe=y[5],it=y[9],nt=y[13],mt=y[2],bt=y[6],At=y[10],wt=y[14];return y[3]*(+_e*it*bt-Y*nt*bt-_e*qe*At+D*nt*At+Y*qe*wt-D*it*wt)+y[7]*(+b*it*wt-b*nt*At+_e*Le*At-Y*Le*wt+Y*nt*mt-_e*it*mt)+y[11]*(+b*nt*bt-b*qe*wt-_e*Le*bt+D*Le*wt+_e*qe*mt-D*nt*mt)+y[15]*(-Y*qe*mt-b*it*bt+b*qe*At+Y*Le*bt-D*Le*At+D*it*mt)}transpose(){const y=this.elements;let b;return b=y[1],y[1]=y[4],y[4]=b,b=y[2],y[2]=y[8],y[8]=b,b=y[6],y[6]=y[9],y[9]=b,b=y[3],y[3]=y[12],y[12]=b,b=y[7],y[7]=y[13],y[13]=b,b=y[11],y[11]=y[14],y[14]=b,this}setPosition(y,b,D){const Y=this.elements;return y.isVector3?(Y[12]=y.x,Y[13]=y.y,Y[14]=y.z):(Y[12]=y,Y[13]=b,Y[14]=D),this}invert(){const y=this.elements,b=y[0],D=y[1],Y=y[2],_e=y[3],Le=y[4],qe=y[5],it=y[6],nt=y[7],mt=y[8],bt=y[9],At=y[10],wt=y[11],Et=y[12],Mt=y[13],St=y[14],Nt=y[15],It=bt*St*nt-Mt*At*nt+Mt*it*wt-qe*St*wt-bt*it*Nt+qe*At*Nt,Rt=Et*At*nt-mt*St*nt-Et*it*wt+Le*St*wt+mt*it*Nt-Le*At*Nt,Yt=mt*Mt*nt-Et*bt*nt+Et*qe*wt-Le*Mt*wt-mt*qe*Nt+Le*bt*Nt,Kt=Et*bt*it-mt*Mt*it-Et*qe*At+Le*Mt*At+mt*qe*St-Le*bt*St,Xt=b*It+D*Rt+Y*Yt+_e*Kt;if(Xt===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const oi=1/Xt;return y[0]=It*oi,y[1]=(Mt*At*_e-bt*St*_e-Mt*Y*wt+D*St*wt+bt*Y*Nt-D*At*Nt)*oi,y[2]=(qe*St*_e-Mt*it*_e+Mt*Y*nt-D*St*nt-qe*Y*Nt+D*it*Nt)*oi,y[3]=(bt*it*_e-qe*At*_e-bt*Y*nt+D*At*nt+qe*Y*wt-D*it*wt)*oi,y[4]=Rt*oi,y[5]=(mt*St*_e-Et*At*_e+Et*Y*wt-b*St*wt-mt*Y*Nt+b*At*Nt)*oi,y[6]=(Et*it*_e-Le*St*_e-Et*Y*nt+b*St*nt+Le*Y*Nt-b*it*Nt)*oi,y[7]=(Le*At*_e-mt*it*_e+mt*Y*nt-b*At*nt-Le*Y*wt+b*it*wt)*oi,y[8]=Yt*oi,y[9]=(Et*bt*_e-mt*Mt*_e-Et*D*wt+b*Mt*wt+mt*D*Nt-b*bt*Nt)*oi,y[10]=(Le*Mt*_e-Et*qe*_e+Et*D*nt-b*Mt*nt-Le*D*Nt+b*qe*Nt)*oi,y[11]=(mt*qe*_e-Le*bt*_e-mt*D*nt+b*bt*nt+Le*D*wt-b*qe*wt)*oi,y[12]=Kt*oi,y[13]=(mt*Mt*Y-Et*bt*Y+Et*D*At-b*Mt*At-mt*D*St+b*bt*St)*oi,y[14]=(Et*qe*Y-Le*Mt*Y-Et*D*it+b*Mt*it+Le*D*St-b*qe*St)*oi,y[15]=(Le*bt*Y-mt*qe*Y+mt*D*it-b*bt*it-Le*D*At+b*qe*At)*oi,this}scale(y){const b=this.elements,D=y.x,Y=y.y,_e=y.z;return b[0]*=D,b[4]*=Y,b[8]*=_e,b[1]*=D,b[5]*=Y,b[9]*=_e,b[2]*=D,b[6]*=Y,b[10]*=_e,b[3]*=D,b[7]*=Y,b[11]*=_e,this}getMaxScaleOnAxis(){const y=this.elements,b=y[0]*y[0]+y[1]*y[1]+y[2]*y[2],D=y[4]*y[4]+y[5]*y[5]+y[6]*y[6],Y=y[8]*y[8]+y[9]*y[9]+y[10]*y[10];return Math.sqrt(Math.max(b,D,Y))}makeTranslation(y,b,D){return y.isVector3?this.set(1,0,0,y.x,0,1,0,y.y,0,0,1,y.z,0,0,0,1):this.set(1,0,0,y,0,1,0,b,0,0,1,D,0,0,0,1),this}makeRotationX(y){const b=Math.cos(y),D=Math.sin(y);return this.set(1,0,0,0,0,b,-D,0,0,D,b,0,0,0,0,1),this}makeRotationY(y){const b=Math.cos(y),D=Math.sin(y);return this.set(b,0,D,0,0,1,0,0,-D,0,b,0,0,0,0,1),this}makeRotationZ(y){const b=Math.cos(y),D=Math.sin(y);return this.set(b,-D,0,0,D,b,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(y,b){const D=Math.cos(b),Y=Math.sin(b),_e=1-D,Le=y.x,qe=y.y,it=y.z,nt=_e*Le,mt=_e*qe;return this.set(nt*Le+D,nt*qe-Y*it,nt*it+Y*qe,0,nt*qe+Y*it,mt*qe+D,mt*it-Y*Le,0,nt*it-Y*qe,mt*it+Y*Le,_e*it*it+D,0,0,0,0,1),this}makeScale(y,b,D){return this.set(y,0,0,0,0,b,0,0,0,0,D,0,0,0,0,1),this}makeShear(y,b,D,Y,_e,Le){return this.set(1,D,_e,0,y,1,Le,0,b,Y,1,0,0,0,0,1),this}compose(y,b,D){const Y=this.elements,_e=b._x,Le=b._y,qe=b._z,it=b._w,nt=_e+_e,mt=Le+Le,bt=qe+qe,At=_e*nt,wt=_e*mt,Et=_e*bt,Mt=Le*mt,St=Le*bt,Nt=qe*bt,It=it*nt,Rt=it*mt,Yt=it*bt,Kt=D.x,Xt=D.y,oi=D.z;return Y[0]=(1-(Mt+Nt))*Kt,Y[1]=(wt+Yt)*Kt,Y[2]=(Et-Rt)*Kt,Y[3]=0,Y[4]=(wt-Yt)*Xt,Y[5]=(1-(At+Nt))*Xt,Y[6]=(St+It)*Xt,Y[7]=0,Y[8]=(Et+Rt)*oi,Y[9]=(St-It)*oi,Y[10]=(1-(At+Mt))*oi,Y[11]=0,Y[12]=y.x,Y[13]=y.y,Y[14]=y.z,Y[15]=1,this}decompose(y,b,D){const Y=this.elements;let _e=fa.set(Y[0],Y[1],Y[2]).length();const Le=fa.set(Y[4],Y[5],Y[6]).length(),qe=fa.set(Y[8],Y[9],Y[10]).length();this.determinant()<0&&(_e=-_e),y.x=Y[12],y.y=Y[13],y.z=Y[14],Ho.copy(this);const it=1/_e,nt=1/Le,mt=1/qe;return Ho.elements[0]*=it,Ho.elements[1]*=it,Ho.elements[2]*=it,Ho.elements[4]*=nt,Ho.elements[5]*=nt,Ho.elements[6]*=nt,Ho.elements[8]*=mt,Ho.elements[9]*=mt,Ho.elements[10]*=mt,b.setFromRotationMatrix(Ho),D.x=_e,D.y=Le,D.z=qe,this}makePerspective(y,b,D,Y,_e,Le,qe=Bo){const it=this.elements,nt=2*_e/(b-y),mt=2*_e/(D-Y),bt=(b+y)/(b-y),At=(D+Y)/(D-Y);let wt,Et;if(qe===Bo)wt=-(Le+_e)/(Le-_e),Et=-2*Le*_e/(Le-_e);else{if(qe!==jo)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+qe);wt=-Le/(Le-_e),Et=-Le*_e/(Le-_e)}return it[0]=nt,it[4]=0,it[8]=bt,it[12]=0,it[1]=0,it[5]=mt,it[9]=At,it[13]=0,it[2]=0,it[6]=0,it[10]=wt,it[14]=Et,it[3]=0,it[7]=0,it[11]=-1,it[15]=0,this}makeOrthographic(y,b,D,Y,_e,Le,qe=Bo){const it=this.elements,nt=1/(b-y),mt=1/(D-Y),bt=1/(Le-_e),At=(b+y)*nt,wt=(D+Y)*mt;let Et,Mt;if(qe===Bo)Et=(Le+_e)*bt,Mt=-2*bt;else{if(qe!==jo)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+qe);Et=_e*bt,Mt=-1*bt}return it[0]=2*nt,it[4]=0,it[8]=0,it[12]=-At,it[1]=0,it[5]=2*mt,it[9]=0,it[13]=-wt,it[2]=0,it[6]=0,it[10]=Mt,it[14]=-Et,it[3]=0,it[7]=0,it[11]=0,it[15]=1,this}equals(y){const b=this.elements,D=y.elements;for(let Y=0;Y<16;Y++)if(b[Y]!==D[Y])return!1;return!0}fromArray(y,b=0){for(let D=0;D<16;D++)this.elements[D]=y[D+b];return this}toArray(y=[],b=0){const D=this.elements;return y[b]=D[0],y[b+1]=D[1],y[b+2]=D[2],y[b+3]=D[3],y[b+4]=D[4],y[b+5]=D[5],y[b+6]=D[6],y[b+7]=D[7],y[b+8]=D[8],y[b+9]=D[9],y[b+10]=D[10],y[b+11]=D[11],y[b+12]=D[12],y[b+13]=D[13],y[b+14]=D[14],y[b+15]=D[15],y}}const fa=new ii,Ho=new Xn,ga=new ii(0,0,0),Uu=new ii(1,1,1),ws=new ii,kl=new ii,mo=new ii,Fu=new Xn,Ws=new Ao;class ya{constructor(y=0,b=0,D=0,Y=ya.DEFAULT_ORDER){this.isEuler=!0,this._x=y,this._y=b,this._z=D,this._order=Y}get x(){return this._x}set x(y){this._x=y,this._onChangeCallback()}get y(){return this._y}set y(y){this._y=y,this._onChangeCallback()}get z(){return this._z}set z(y){this._z=y,this._onChangeCallback()}get order(){return this._order}set order(y){this._order=y,this._onChangeCallback()}set(y,b,D,Y=this._order){return this._x=y,this._y=b,this._z=D,this._order=Y,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(y){return this._x=y._x,this._y=y._y,this._z=y._z,this._order=y._order,this._onChangeCallback(),this}setFromRotationMatrix(y,b=this._order,D=!0){const Y=y.elements,_e=Y[0],Le=Y[4],qe=Y[8],it=Y[1],nt=Y[5],mt=Y[9],bt=Y[2],At=Y[6],wt=Y[10];switch(b){case"XYZ":this._y=Math.asin(Ur(qe,-1,1)),Math.abs(qe)<.9999999?(this._x=Math.atan2(-mt,wt),this._z=Math.atan2(-Le,_e)):(this._x=Math.atan2(At,nt),this._z=0);break;case"YXZ":this._x=Math.asin(-Ur(mt,-1,1)),Math.abs(mt)<.9999999?(this._y=Math.atan2(qe,wt),this._z=Math.atan2(it,nt)):(this._y=Math.atan2(-bt,_e),this._z=0);break;case"ZXY":this._x=Math.asin(Ur(At,-1,1)),Math.abs(At)<.9999999?(this._y=Math.atan2(-bt,wt),this._z=Math.atan2(-Le,nt)):(this._y=0,this._z=Math.atan2(it,_e));break;case"ZYX":this._y=Math.asin(-Ur(bt,-1,1)),Math.abs(bt)<.9999999?(this._x=Math.atan2(At,wt),this._z=Math.atan2(it,_e)):(this._x=0,this._z=Math.atan2(-Le,nt));break;case"YZX":this._z=Math.asin(Ur(it,-1,1)),Math.abs(it)<.9999999?(this._x=Math.atan2(-mt,nt),this._y=Math.atan2(-bt,_e)):(this._x=0,this._y=Math.atan2(qe,wt));break;case"XZY":this._z=Math.asin(-Ur(Le,-1,1)),Math.abs(Le)<.9999999?(this._x=Math.atan2(At,nt),this._y=Math.atan2(qe,_e)):(this._x=Math.atan2(-mt,wt),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+b)}return this._order=b,D===!0&&this._onChangeCallback(),this}setFromQuaternion(y,b,D){return Fu.makeRotationFromQuaternion(y),this.setFromRotationMatrix(Fu,b,D)}setFromVector3(y,b=this._order){return this.set(y.x,y.y,y.z,b)}reorder(y){return Ws.setFromEuler(this),this.setFromQuaternion(Ws,y)}equals(y){return y._x===this._x&&y._y===this._y&&y._z===this._z&&y._order===this._order}fromArray(y){return this._x=y[0],this._y=y[1],this._z=y[2],y[3]!==void 0&&(this._order=y[3]),this._onChangeCallback(),this}toArray(y=[],b=0){return y[b]=this._x,y[b+1]=this._y,y[b+2]=this._z,y[b+3]=this._order,y}_onChange(y){return this._onChangeCallback=y,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}ya.DEFAULT_ORDER="XYZ";class Ul{constructor(){this.mask=1}set(y){this.mask=1<<y>>>0}enable(y){this.mask|=1<<y}enableAll(){this.mask=-1}toggle(y){this.mask^=1<<y}disable(y){this.mask&=~(1<<y)}disableAll(){this.mask=0}test(y){return!!(this.mask&y.mask)}isEnabled(y){return!!(this.mask&1<<y)}}let mh=0;const ju=new ii,Aa=new Ao,So=new Xn,Wa=new ii,qa=new ii,Gc=new ii,Gu=new Ao,zu=new ii(1,0,0),Fl=new ii(0,1,0),Vu=new ii(0,0,1),Es={type:"added"},fh={type:"removed"};class yr extends ho{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:mh++}),this.uuid=vo(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=yr.DEFAULT_UP.clone();const y=new ii,b=new ya,D=new Ao,Y=new ii(1,1,1);b._onChange(function(){D.setFromEuler(b,!1)}),D._onChange(function(){b.setFromQuaternion(D,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:y},rotation:{configurable:!0,enumerable:!0,value:b},quaternion:{configurable:!0,enumerable:!0,value:D},scale:{configurable:!0,enumerable:!0,value:Y},modelViewMatrix:{value:new Xn},normalMatrix:{value:new er}}),this.matrix=new Xn,this.matrixWorld=new Xn,this.matrixAutoUpdate=yr.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.matrixWorldAutoUpdate=yr.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.layers=new Ul,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(y,b,D,Y,_e,Le){this.dispatchEvent({type:"beforeRender",renderer:y,scene:b,camera:D,geometry:Y,material:_e,group:Le})}onAfterRender(y,b,D,Y,_e,Le){this.dispatchEvent({type:"afterRender",renderer:y,scene:b,camera:D,geometry:Y,material:_e,group:Le})}applyMatrix4(y){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(y),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(y){return this.quaternion.premultiply(y),this}setRotationFromAxisAngle(y,b){this.quaternion.setFromAxisAngle(y,b)}setRotationFromEuler(y){this.quaternion.setFromEuler(y,!0)}setRotationFromMatrix(y){this.quaternion.setFromRotationMatrix(y)}setRotationFromQuaternion(y){this.quaternion.copy(y)}rotateOnAxis(y,b){return Aa.setFromAxisAngle(y,b),this.quaternion.multiply(Aa),this}rotateOnWorldAxis(y,b){return Aa.setFromAxisAngle(y,b),this.quaternion.premultiply(Aa),this}rotateX(y){return this.rotateOnAxis(zu,y)}rotateY(y){return this.rotateOnAxis(Fl,y)}rotateZ(y){return this.rotateOnAxis(Vu,y)}translateOnAxis(y,b){return ju.copy(y).applyQuaternion(this.quaternion),this.position.add(ju.multiplyScalar(b)),this}translateX(y){return this.translateOnAxis(zu,y)}translateY(y){return this.translateOnAxis(Fl,y)}translateZ(y){return this.translateOnAxis(Vu,y)}localToWorld(y){return this.updateWorldMatrix(!0,!1),y.applyMatrix4(this.matrixWorld)}worldToLocal(y){return this.updateWorldMatrix(!0,!1),y.applyMatrix4(So.copy(this.matrixWorld).invert())}lookAt(y,b,D){y.isVector3?Wa.copy(y):Wa.set(y,b,D);const Y=this.parent;this.updateWorldMatrix(!0,!1),qa.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?So.lookAt(qa,Wa,this.up):So.lookAt(Wa,qa,this.up),this.quaternion.setFromRotationMatrix(So),Y&&(So.extractRotation(Y.matrixWorld),Aa.setFromRotationMatrix(So),this.quaternion.premultiply(Aa.invert()))}add(y){if(arguments.length>1){for(let b=0;b<arguments.length;b++)this.add(arguments[b]);return this}return y===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",y),this):(y&&y.isObject3D?(y.parent!==null&&y.parent.remove(y),y.parent=this,this.children.push(y),y.dispatchEvent(Es)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",y),this)}remove(y){if(arguments.length>1){for(let D=0;D<arguments.length;D++)this.remove(arguments[D]);return this}const b=this.children.indexOf(y);return b!==-1&&(y.parent=null,this.children.splice(b,1),y.dispatchEvent(fh)),this}removeFromParent(){const y=this.parent;return y!==null&&y.remove(this),this}clear(){return this.remove(...this.children)}attach(y){return this.updateWorldMatrix(!0,!1),So.copy(this.matrixWorld).invert(),y.parent!==null&&(y.parent.updateWorldMatrix(!0,!1),So.multiply(y.parent.matrixWorld)),y.applyMatrix4(So),this.add(y),y.updateWorldMatrix(!1,!0),this}getObjectById(y){return this.getObjectByProperty("id",y)}getObjectByName(y){return this.getObjectByProperty("name",y)}getObjectByProperty(y,b){if(this[y]===b)return this;for(let D=0,Y=this.children.length;D<Y;D++){const _e=this.children[D].getObjectByProperty(y,b);if(_e!==void 0)return _e}}getObjectsByProperty(y,b){let D=[];this[y]===b&&D.push(this);for(let Y=0,_e=this.children.length;Y<_e;Y++){const Le=this.children[Y].getObjectsByProperty(y,b);Le.length>0&&(D=D.concat(Le))}return D}getWorldPosition(y){return this.updateWorldMatrix(!0,!1),y.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(y){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(qa,y,Gc),y}getWorldScale(y){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(qa,Gu,y),y}getWorldDirection(y){this.updateWorldMatrix(!0,!1);const b=this.matrixWorld.elements;return y.set(b[8],b[9],b[10]).normalize()}raycast(){}traverse(y){y(this);const b=this.children;for(let D=0,Y=b.length;D<Y;D++)b[D].traverse(y)}traverseVisible(y){if(this.visible===!1)return;y(this);const b=this.children;for(let D=0,Y=b.length;D<Y;D++)b[D].traverseVisible(y)}traverseAncestors(y){const b=this.parent;b!==null&&(y(b),b.traverseAncestors(y))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(y){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||y)&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,y=!0);const b=this.children;for(let D=0,Y=b.length;D<Y;D++){const _e=b[D];_e.matrixWorldAutoUpdate!==!0&&y!==!0||_e.updateMatrixWorld(y)}}updateWorldMatrix(y,b){const D=this.parent;if(y===!0&&D!==null&&D.matrixWorldAutoUpdate===!0&&D.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),b===!0){const Y=this.children;for(let _e=0,Le=Y.length;_e<Le;_e++){const qe=Y[_e];qe.matrixWorldAutoUpdate===!0&&qe.updateWorldMatrix(!1,!0)}}}toJSON(y){const b=y===void 0||typeof y=="string",D={};b&&(y={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{},extras:{}},D.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const Y={};function _e(qe,it){return qe[it.uuid]===void 0&&(qe[it.uuid]=it.toJSON(y)),it.uuid}if(Y.uuid=this.uuid,Y.type=this.type,this.name!==""&&(Y.name=this.name),this.castShadow===!0&&(Y.castShadow=!0),this.receiveShadow===!0&&(Y.receiveShadow=!0),this.visible===!1&&(Y.visible=!1),this.frustumCulled===!1&&(Y.frustumCulled=!1),this.renderOrder!==0&&(Y.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(Y.userData=this.userData),Y.layers=this.layers.mask,Y.matrix=this.matrix.toArray(),Y.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(Y.matrixAutoUpdate=!1),this.isInstancedMesh&&(Y.type="InstancedMesh",Y.count=this.count,Y.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(Y.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?Y.background=this.background.toJSON():this.background.isTexture&&(Y.background=this.background.toJSON(y).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(Y.environment=this.environment.toJSON(y).uuid);else if(this.isMesh||this.isLine||this.isPoints){Y.geometry=_e(y.geometries,this.geometry);const qe=this.geometry.parameters;if(qe!==void 0&&qe.shapes!==void 0){const it=qe.shapes;if(Array.isArray(it))for(let nt=0,mt=it.length;nt<mt;nt++){const bt=it[nt];_e(y.shapes,bt)}else _e(y.shapes,it)}}if(this.isSkinnedMesh&&(Y.bindMode=this.bindMode,Y.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(_e(y.skeletons,this.skeleton),Y.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const qe=[];for(let it=0,nt=this.material.length;it<nt;it++)qe.push(_e(y.materials,this.material[it]));Y.material=qe}else Y.material=_e(y.materials,this.material);if(this.children.length>0){Y.children=[];for(let qe=0;qe<this.children.length;qe++)Y.children.push(this.children[qe].toJSON(y).object)}if(this.animations.length>0){Y.animations=[];for(let qe=0;qe<this.animations.length;qe++){const it=this.animations[qe];Y.animations.push(_e(y.animations,it))}}if(b){const qe=Le(y.geometries),it=Le(y.materials),nt=Le(y.textures),mt=Le(y.images),bt=Le(y.shapes),At=Le(y.skeletons),wt=Le(y.animations),Et=Le(y.nodes);qe.length>0&&(D.geometries=qe),it.length>0&&(D.materials=it),nt.length>0&&(D.textures=nt),mt.length>0&&(D.images=mt),bt.length>0&&(D.shapes=bt),At.length>0&&(D.skeletons=At),wt.length>0&&(D.animations=wt),Et.length>0&&(D.nodes=Et)}return D.object=Y,D;function Le(qe){const it=[];for(const nt in qe){const mt=qe[nt];delete mt.metadata,it.push(mt)}return it}}clone(y){return new this.constructor().copy(this,y)}copy(y,b=!0){this.name=y.name,this.up.copy(y.up),this.position.copy(y.position),this.rotation.order=y.rotation.order,this.quaternion.copy(y.quaternion),this.scale.copy(y.scale),this.matrix.copy(y.matrix),this.matrixWorld.copy(y.matrixWorld),this.matrixAutoUpdate=y.matrixAutoUpdate,this.matrixWorldNeedsUpdate=y.matrixWorldNeedsUpdate,this.matrixWorldAutoUpdate=y.matrixWorldAutoUpdate,this.layers.mask=y.layers.mask,this.visible=y.visible,this.castShadow=y.castShadow,this.receiveShadow=y.receiveShadow,this.frustumCulled=y.frustumCulled,this.renderOrder=y.renderOrder,this.animations=y.animations.slice(),this.userData={};for(const[D,Y]of Object.entries(y.userData))this.userData[D]=!Y||Y&&(Y.isTexture||Y.isObject3D)?Y:JSON.parse(JSON.stringify(Y));if(b===!0)for(let D=0;D<y.children.length;D++){const Y=y.children[D];this.add(Y.clone())}return this}}yr.DEFAULT_UP=new ii(0,1,0),yr.DEFAULT_MATRIX_AUTO_UPDATE=!0,yr.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const To=new ii,is=new ii,zc=new ii,cs=new ii,ba=new ii,xa=new ii,Hu=new ii,Vc=new ii,Qo=new ii,jl=new ii;let Gl=!1;class fo{constructor(y=new ii,b=new ii,D=new ii){this.a=y,this.b=b,this.c=D}static getNormal(y,b,D,Y){Y.subVectors(D,b),To.subVectors(y,b),Y.cross(To);const _e=Y.lengthSq();return _e>0?Y.multiplyScalar(1/Math.sqrt(_e)):Y.set(0,0,0)}static getBarycoord(y,b,D,Y,_e){To.subVectors(Y,b),is.subVectors(D,b),zc.subVectors(y,b);const Le=To.dot(To),qe=To.dot(is),it=To.dot(zc),nt=is.dot(is),mt=is.dot(zc),bt=Le*nt-qe*qe;if(bt===0)return _e.set(-2,-1,-1);const At=1/bt,wt=(nt*it-qe*mt)*At,Et=(Le*mt-qe*it)*At;return _e.set(1-wt-Et,Et,wt)}static containsPoint(y,b,D,Y){return this.getBarycoord(y,b,D,Y,cs),cs.x>=0&&cs.y>=0&&cs.x+cs.y<=1}static getUV(y,b,D,Y,_e,Le,qe,it){return Gl===!1&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),Gl=!0),this.getInterpolation(y,b,D,Y,_e,Le,qe,it)}static getInterpolation(y,b,D,Y,_e,Le,qe,it){return this.getBarycoord(y,b,D,Y,cs),it.setScalar(0),it.addScaledVector(_e,cs.x),it.addScaledVector(Le,cs.y),it.addScaledVector(qe,cs.z),it}static isFrontFacing(y,b,D,Y){return To.subVectors(D,b),is.subVectors(y,b),To.cross(is).dot(Y)<0}set(y,b,D){return this.a.copy(y),this.b.copy(b),this.c.copy(D),this}setFromPointsAndIndices(y,b,D,Y){return this.a.copy(y[b]),this.b.copy(y[D]),this.c.copy(y[Y]),this}setFromAttributeAndIndices(y,b,D,Y){return this.a.fromBufferAttribute(y,b),this.b.fromBufferAttribute(y,D),this.c.fromBufferAttribute(y,Y),this}clone(){return new this.constructor().copy(this)}copy(y){return this.a.copy(y.a),this.b.copy(y.b),this.c.copy(y.c),this}getArea(){return To.subVectors(this.c,this.b),is.subVectors(this.a,this.b),.5*To.cross(is).length()}getMidpoint(y){return y.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(y){return fo.getNormal(this.a,this.b,this.c,y)}getPlane(y){return y.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(y,b){return fo.getBarycoord(y,this.a,this.b,this.c,b)}getUV(y,b,D,Y,_e){return Gl===!1&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),Gl=!0),fo.getInterpolation(y,this.a,this.b,this.c,b,D,Y,_e)}getInterpolation(y,b,D,Y,_e){return fo.getInterpolation(y,this.a,this.b,this.c,b,D,Y,_e)}containsPoint(y){return fo.containsPoint(y,this.a,this.b,this.c)}isFrontFacing(y){return fo.isFrontFacing(this.a,this.b,this.c,y)}intersectsBox(y){return y.intersectsTriangle(this)}closestPointToPoint(y,b){const D=this.a,Y=this.b,_e=this.c;let Le,qe;ba.subVectors(Y,D),xa.subVectors(_e,D),Vc.subVectors(y,D);const it=ba.dot(Vc),nt=xa.dot(Vc);if(it<=0&&nt<=0)return b.copy(D);Qo.subVectors(y,Y);const mt=ba.dot(Qo),bt=xa.dot(Qo);if(mt>=0&&bt<=mt)return b.copy(Y);const At=it*bt-mt*nt;if(At<=0&&it>=0&&mt<=0)return Le=it/(it-mt),b.copy(D).addScaledVector(ba,Le);jl.subVectors(y,_e);const wt=ba.dot(jl),Et=xa.dot(jl);if(Et>=0&&wt<=Et)return b.copy(_e);const Mt=wt*nt-it*Et;if(Mt<=0&&nt>=0&&Et<=0)return qe=nt/(nt-Et),b.copy(D).addScaledVector(xa,qe);const St=mt*Et-wt*bt;if(St<=0&&bt-mt>=0&&wt-Et>=0)return Hu.subVectors(_e,Y),qe=(bt-mt)/(bt-mt+(wt-Et)),b.copy(Y).addScaledVector(Hu,qe);const Nt=1/(St+Mt+At);return Le=Mt*Nt,qe=At*Nt,b.copy(D).addScaledVector(ba,Le).addScaledVector(xa,qe)}equals(y){return y.a.equals(this.a)&&y.b.equals(this.b)&&y.c.equals(this.c)}}let gh=0;class no extends ho{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:gh++}),this.uuid=vo(),this.name="",this.type="Material",this.blending=tt,this.side=ue,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=Vt,this.blendDst=si,this.blendEquation=lt,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=qt,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=ja,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=wl,this.stencilZFail=wl,this.stencilZPass=wl,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(y){this._alphaTest>0!=y>0&&this.version++,this._alphaTest=y}onBuild(){}onBeforeRender(){}onAfterRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(y){if(y!==void 0)for(const b in y){const D=y[b];if(D===void 0){console.warn(`THREE.Material: parameter '${b}' has value of undefined.`);continue}const Y=this[b];Y!==void 0&&(Y&&Y.isColor?Y.set(D):Y&&Y.isVector3&&D&&D.isVector3?Y.copy(D):Array.isArray(D)&&Y&&typeof Y.fromArray=="function"?Y.fromArray(D):this[b]=D)}}toJSON(y){const b=y===void 0||typeof y=="string";b&&(y={textures:{},images:{}});const D={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function Y(_e){const Le=[];for(const qe in _e){const it=_e[qe];delete it.metadata,Le.push(it)}return Le}if(D.uuid=this.uuid,D.type=this.type,this.name!==""&&(D.name=this.name),this.color&&this.color.isColor&&(D.color=this.color.getHex()),this.roughness!==void 0&&(D.roughness=this.roughness),this.metalness!==void 0&&(D.metalness=this.metalness),this.sheen!==void 0&&(D.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(D.sheenColor=this.sheenColor.getHex()),this.sheenRoughness!==void 0&&(D.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(D.emissive=this.emissive.getHex()),this.emissiveIntensity&&this.emissiveIntensity!==1&&(D.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(D.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(D.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(D.specularColor=this.specularColor.getHex()),this.shininess!==void 0&&(D.shininess=this.shininess),this.clearcoat!==void 0&&(D.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(D.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(D.clearcoatMap=this.clearcoatMap.toJSON(y).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(D.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(y).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(D.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(y).uuid,D.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.iridescence!==void 0&&(D.iridescence=this.iridescence),this.iridescenceIOR!==void 0&&(D.iridescenceIOR=this.iridescenceIOR),this.iridescenceThicknessRange!==void 0&&(D.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(D.iridescenceMap=this.iridescenceMap.toJSON(y).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(D.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(y).uuid),this.anisotropy!==void 0&&(D.anisotropy=this.anisotropy),this.anisotropyRotation!==void 0&&(D.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(D.anisotropyMap=this.anisotropyMap.toJSON(y).uuid),this.map&&this.map.isTexture&&(D.map=this.map.toJSON(y).uuid),this.matcap&&this.matcap.isTexture&&(D.matcap=this.matcap.toJSON(y).uuid),this.alphaMap&&this.alphaMap.isTexture&&(D.alphaMap=this.alphaMap.toJSON(y).uuid),this.lightMap&&this.lightMap.isTexture&&(D.lightMap=this.lightMap.toJSON(y).uuid,D.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(D.aoMap=this.aoMap.toJSON(y).uuid,D.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(D.bumpMap=this.bumpMap.toJSON(y).uuid,D.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(D.normalMap=this.normalMap.toJSON(y).uuid,D.normalMapType=this.normalMapType,D.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(D.displacementMap=this.displacementMap.toJSON(y).uuid,D.displacementScale=this.displacementScale,D.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(D.roughnessMap=this.roughnessMap.toJSON(y).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(D.metalnessMap=this.metalnessMap.toJSON(y).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(D.emissiveMap=this.emissiveMap.toJSON(y).uuid),this.specularMap&&this.specularMap.isTexture&&(D.specularMap=this.specularMap.toJSON(y).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(D.specularIntensityMap=this.specularIntensityMap.toJSON(y).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(D.specularColorMap=this.specularColorMap.toJSON(y).uuid),this.envMap&&this.envMap.isTexture&&(D.envMap=this.envMap.toJSON(y).uuid,this.combine!==void 0&&(D.combine=this.combine)),this.envMapIntensity!==void 0&&(D.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(D.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(D.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(D.gradientMap=this.gradientMap.toJSON(y).uuid),this.transmission!==void 0&&(D.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(D.transmissionMap=this.transmissionMap.toJSON(y).uuid),this.thickness!==void 0&&(D.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(D.thicknessMap=this.thicknessMap.toJSON(y).uuid),this.attenuationDistance!==void 0&&this.attenuationDistance!==1/0&&(D.attenuationDistance=this.attenuationDistance),this.attenuationColor!==void 0&&(D.attenuationColor=this.attenuationColor.getHex()),this.size!==void 0&&(D.size=this.size),this.shadowSide!==null&&(D.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(D.sizeAttenuation=this.sizeAttenuation),this.blending!==tt&&(D.blending=this.blending),this.side!==ue&&(D.side=this.side),this.vertexColors===!0&&(D.vertexColors=!0),this.opacity<1&&(D.opacity=this.opacity),this.transparent===!0&&(D.transparent=!0),D.depthFunc=this.depthFunc,D.depthTest=this.depthTest,D.depthWrite=this.depthWrite,D.colorWrite=this.colorWrite,D.stencilWrite=this.stencilWrite,D.stencilWriteMask=this.stencilWriteMask,D.stencilFunc=this.stencilFunc,D.stencilRef=this.stencilRef,D.stencilFuncMask=this.stencilFuncMask,D.stencilFail=this.stencilFail,D.stencilZFail=this.stencilZFail,D.stencilZPass=this.stencilZPass,this.rotation!==void 0&&this.rotation!==0&&(D.rotation=this.rotation),this.polygonOffset===!0&&(D.polygonOffset=!0),this.polygonOffsetFactor!==0&&(D.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(D.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth!==void 0&&this.linewidth!==1&&(D.linewidth=this.linewidth),this.dashSize!==void 0&&(D.dashSize=this.dashSize),this.gapSize!==void 0&&(D.gapSize=this.gapSize),this.scale!==void 0&&(D.scale=this.scale),this.dithering===!0&&(D.dithering=!0),this.alphaTest>0&&(D.alphaTest=this.alphaTest),this.alphaHash===!0&&(D.alphaHash=!0),this.alphaToCoverage===!0&&(D.alphaToCoverage=!0),this.premultipliedAlpha===!0&&(D.premultipliedAlpha=!0),this.forceSinglePass===!0&&(D.forceSinglePass=!0),this.wireframe===!0&&(D.wireframe=!0),this.wireframeLinewidth>1&&(D.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(D.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(D.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(D.flatShading=!0),this.visible===!1&&(D.visible=!1),this.toneMapped===!1&&(D.toneMapped=!1),this.fog===!1&&(D.fog=!1),Object.keys(this.userData).length>0&&(D.userData=this.userData),b){const _e=Y(y.textures),Le=Y(y.images);_e.length>0&&(D.textures=_e),Le.length>0&&(D.images=Le)}return D}clone(){return new this.constructor().copy(this)}copy(y){this.name=y.name,this.blending=y.blending,this.side=y.side,this.vertexColors=y.vertexColors,this.opacity=y.opacity,this.transparent=y.transparent,this.blendSrc=y.blendSrc,this.blendDst=y.blendDst,this.blendEquation=y.blendEquation,this.blendSrcAlpha=y.blendSrcAlpha,this.blendDstAlpha=y.blendDstAlpha,this.blendEquationAlpha=y.blendEquationAlpha,this.depthFunc=y.depthFunc,this.depthTest=y.depthTest,this.depthWrite=y.depthWrite,this.stencilWriteMask=y.stencilWriteMask,this.stencilFunc=y.stencilFunc,this.stencilRef=y.stencilRef,this.stencilFuncMask=y.stencilFuncMask,this.stencilFail=y.stencilFail,this.stencilZFail=y.stencilZFail,this.stencilZPass=y.stencilZPass,this.stencilWrite=y.stencilWrite;const b=y.clippingPlanes;let D=null;if(b!==null){const Y=b.length;D=new Array(Y);for(let _e=0;_e!==Y;++_e)D[_e]=b[_e].clone()}return this.clippingPlanes=D,this.clipIntersection=y.clipIntersection,this.clipShadows=y.clipShadows,this.shadowSide=y.shadowSide,this.colorWrite=y.colorWrite,this.precision=y.precision,this.polygonOffset=y.polygonOffset,this.polygonOffsetFactor=y.polygonOffsetFactor,this.polygonOffsetUnits=y.polygonOffsetUnits,this.dithering=y.dithering,this.alphaTest=y.alphaTest,this.alphaHash=y.alphaHash,this.alphaToCoverage=y.alphaToCoverage,this.premultipliedAlpha=y.premultipliedAlpha,this.forceSinglePass=y.forceSinglePass,this.visible=y.visible,this.toneMapped=y.toneMapped,this.userData=Hc({},y.userData),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(y){y===!0&&this.version++}}function Hc(De,y){if(!y)return De;for(const b of Object.keys(y)){if(b.startsWith("__")||typeof De[b]=="function"||typeof y[b]=="function")continue;const D=y[b],Y=!D||D.isTexture||D.isObject3D||D.isMaterial;Y||typeof y[b].clone!="function"?Y||typeof y[b]!="object"&&!Array.isArray(y[b])?De[b]=y[b]:De[b]=Hc(Array.isArray(y[b])?[]:{},y[b]):De[b]=y[b].clone()}return De}const Qc={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},us={h:0,s:0,l:0},zl={h:0,s:0,l:0};function Wc(De,y,b){return b<0&&(b+=1),b>1&&(b-=1),b<1/6?De+6*(y-De)*b:b<.5?y:b<2/3?De+6*(y-De)*(2/3-b):De}class Dn{constructor(y,b,D){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(y,b,D)}set(y,b,D){if(b===void 0&&D===void 0){const Y=y;Y&&Y.isColor?this.copy(Y):typeof Y=="number"?this.setHex(Y):typeof Y=="string"&&this.setStyle(Y)}else this.setRGB(y,b,D);return this}setScalar(y){return this.r=y,this.g=y,this.b=y,this}setHex(y,b=Rr){return y=Math.floor(y),this.r=(y>>16&255)/255,this.g=(y>>8&255)/255,this.b=(255&y)/255,Sr.toWorkingColorSpace(this,b),this}setRGB(y,b,D,Y=Sr.workingColorSpace){return this.r=y,this.g=b,this.b=D,Sr.toWorkingColorSpace(this,Y),this}setHSL(y,b,D,Y=Sr.workingColorSpace){if(y=Ml(y,1),b=Ur(b,0,1),D=Ur(D,0,1),b===0)this.r=this.g=this.b=D;else{const _e=D<=.5?D*(1+b):D+b-D*b,Le=2*D-_e;this.r=Wc(Le,_e,y+1/3),this.g=Wc(Le,_e,y),this.b=Wc(Le,_e,y-1/3)}return Sr.toWorkingColorSpace(this,Y),this}setStyle(y,b=Rr){function D(_e){_e!==void 0&&parseFloat(_e)<1&&console.warn("THREE.Color: Alpha component of "+y+" will be ignored.")}let Y;if(Y=/^(\w+)\(([^\)]*)\)/.exec(y)){let _e;const Le=Y[1],qe=Y[2];switch(Le){case"rgb":case"rgba":if(_e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(qe))return D(_e[4]),this.setRGB(Math.min(255,parseInt(_e[1],10))/255,Math.min(255,parseInt(_e[2],10))/255,Math.min(255,parseInt(_e[3],10))/255,b);if(_e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(qe))return D(_e[4]),this.setRGB(Math.min(100,parseInt(_e[1],10))/100,Math.min(100,parseInt(_e[2],10))/100,Math.min(100,parseInt(_e[3],10))/100,b);break;case"hsl":case"hsla":if(_e=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(qe))return D(_e[4]),this.setHSL(parseFloat(_e[1])/360,parseFloat(_e[2])/100,parseFloat(_e[3])/100,b);break;default:console.warn("THREE.Color: Unknown color model "+y)}}else if(Y=/^\#([A-Fa-f\d]+)$/.exec(y)){const _e=Y[1],Le=_e.length;if(Le===3)return this.setRGB(parseInt(_e.charAt(0),16)/15,parseInt(_e.charAt(1),16)/15,parseInt(_e.charAt(2),16)/15,b);if(Le===6)return this.setHex(parseInt(_e,16),b);console.warn("THREE.Color: Invalid hex color "+y)}else if(y&&y.length>0)return this.setColorName(y,b);return this}setColorName(y,b=Rr){const D=Qc[y.toLowerCase()];return D!==void 0?this.setHex(D,b):console.warn("THREE.Color: Unknown color "+y),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(y){return this.r=y.r,this.g=y.g,this.b=y.b,this}copySRGBToLinear(y){return this.r=aa(y.r),this.g=aa(y.g),this.b=aa(y.b),this}copyLinearToSRGB(y){return this.r=Rl(y.r),this.g=Rl(y.g),this.b=Rl(y.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(y=Rr){return Sr.fromWorkingColorSpace(ro.copy(this),y),65536*Math.round(Ur(255*ro.r,0,255))+256*Math.round(Ur(255*ro.g,0,255))+Math.round(Ur(255*ro.b,0,255))}getHexString(y=Rr){return("000000"+this.getHex(y).toString(16)).slice(-6)}getHSL(y,b=Sr.workingColorSpace){Sr.fromWorkingColorSpace(ro.copy(this),b);const D=ro.r,Y=ro.g,_e=ro.b,Le=Math.max(D,Y,_e),qe=Math.min(D,Y,_e);let it,nt;const mt=(qe+Le)/2;if(qe===Le)it=0,nt=0;else{const bt=Le-qe;switch(nt=mt<=.5?bt/(Le+qe):bt/(2-Le-qe),Le){case D:it=(Y-_e)/bt+(Y<_e?6:0);break;case Y:it=(_e-D)/bt+2;break;case _e:it=(D-Y)/bt+4}it/=6}return y.h=it,y.s=nt,y.l=mt,y}getRGB(y,b=Sr.workingColorSpace){return Sr.fromWorkingColorSpace(ro.copy(this),b),y.r=ro.r,y.g=ro.g,y.b=ro.b,y}getStyle(y=Rr){Sr.fromWorkingColorSpace(ro.copy(this),y);const b=ro.r,D=ro.g,Y=ro.b;return y!==Rr?`color(${y} ${b.toFixed(3)} ${D.toFixed(3)} ${Y.toFixed(3)})`:`rgb(${Math.round(255*b)},${Math.round(255*D)},${Math.round(255*Y)})`}offsetHSL(y,b,D){return this.getHSL(us),this.setHSL(us.h+y,us.s+b,us.l+D)}add(y){return this.r+=y.r,this.g+=y.g,this.b+=y.b,this}addColors(y,b){return this.r=y.r+b.r,this.g=y.g+b.g,this.b=y.b+b.b,this}addScalar(y){return this.r+=y,this.g+=y,this.b+=y,this}sub(y){return this.r=Math.max(0,this.r-y.r),this.g=Math.max(0,this.g-y.g),this.b=Math.max(0,this.b-y.b),this}multiply(y){return this.r*=y.r,this.g*=y.g,this.b*=y.b,this}multiplyScalar(y){return this.r*=y,this.g*=y,this.b*=y,this}lerp(y,b){return this.r+=(y.r-this.r)*b,this.g+=(y.g-this.g)*b,this.b+=(y.b-this.b)*b,this}lerpColors(y,b,D){return this.r=y.r+(b.r-y.r)*D,this.g=y.g+(b.g-y.g)*D,this.b=y.b+(b.b-y.b)*D,this}lerpHSL(y,b){this.getHSL(us),y.getHSL(zl);const D=sa(us.h,zl.h,b),Y=sa(us.s,zl.s,b),_e=sa(us.l,zl.l,b);return this.setHSL(D,Y,_e),this}setFromVector3(y){return this.r=y.x,this.g=y.y,this.b=y.z,this}applyMatrix3(y){const b=this.r,D=this.g,Y=this.b,_e=y.elements;return this.r=_e[0]*b+_e[3]*D+_e[6]*Y,this.g=_e[1]*b+_e[4]*D+_e[7]*Y,this.b=_e[2]*b+_e[5]*D+_e[8]*Y,this}equals(y){return y.r===this.r&&y.g===this.g&&y.b===this.b}fromArray(y,b=0){return this.r=y[b],this.g=y[b+1],this.b=y[b+2],this}toArray(y=[],b=0){return y[b]=this.r,y[b+1]=this.g,y[b+2]=this.b,y}fromBufferAttribute(y,b){return this.r=y.getX(b),this.g=y.getY(b),this.b=y.getZ(b),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const ro=new Dn;Dn.NAMES=Qc;class Ss extends no{constructor(y){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Dn(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Ln,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.color.copy(y.color),this.map=y.map,this.lightMap=y.lightMap,this.lightMapIntensity=y.lightMapIntensity,this.aoMap=y.aoMap,this.aoMapIntensity=y.aoMapIntensity,this.specularMap=y.specularMap,this.alphaMap=y.alphaMap,this.envMap=y.envMap,this.combine=y.combine,this.reflectivity=y.reflectivity,this.refractionRatio=y.refractionRatio,this.wireframe=y.wireframe,this.wireframeLinewidth=y.wireframeLinewidth,this.wireframeLinecap=y.wireframeLinecap,this.wireframeLinejoin=y.wireframeLinejoin,this.fog=y.fog,this}}const ns=_h();function _h(){const De=new ArrayBuffer(4),y=new Float32Array(De),b=new Uint32Array(De),D=new Uint32Array(512),Y=new Uint32Array(512);for(let it=0;it<256;++it){const nt=it-127;nt<-27?(D[it]=0,D[256|it]=32768,Y[it]=24,Y[256|it]=24):nt<-14?(D[it]=1024>>-nt-14,D[256|it]=1024>>-nt-14|32768,Y[it]=-nt-1,Y[256|it]=-nt-1):nt<=15?(D[it]=nt+15<<10,D[256|it]=nt+15<<10|32768,Y[it]=13,Y[256|it]=13):nt<128?(D[it]=31744,D[256|it]=64512,Y[it]=24,Y[256|it]=24):(D[it]=31744,D[256|it]=64512,Y[it]=13,Y[256|it]=13)}const _e=new Uint32Array(2048),Le=new Uint32Array(64),qe=new Uint32Array(64);for(let it=1;it<1024;++it){let nt=it<<13,mt=0;for(;!(8388608&nt);)nt<<=1,mt-=8388608;nt&=-8388609,mt+=947912704,_e[it]=nt|mt}for(let it=1024;it<2048;++it)_e[it]=939524096+(it-1024<<13);for(let it=1;it<31;++it)Le[it]=it<<23;Le[31]=1199570944,Le[32]=2147483648;for(let it=33;it<63;++it)Le[it]=2147483648+(it-32<<23);Le[63]=3347054592;for(let it=1;it<64;++it)it!==32&&(qe[it]=1024);return{floatView:y,uint32View:b,baseTable:D,shiftTable:Y,mantissaTable:_e,exponentTable:Le,offsetTable:qe}}function ft(De){Math.abs(De)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),De=Ur(De,-65504,65504),ns.floatView[0]=De;const y=ns.uint32View[0],b=y>>23&511;return ns.baseTable[b]+((8388607&y)>>ns.shiftTable[b])}function Ie(De){const y=De>>10;return ns.uint32View[0]=ns.mantissaTable[ns.offsetTable[y]+(1023&De)]+ns.exponentTable[y],ns.floatView[0]}const Ye={toHalfFloat:ft,fromHalfFloat:Ie},vt=new ii,Dt=new en;class zt{constructor(y,b,D=!1){if(Array.isArray(y))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=y,this.itemSize=b,this.count=y!==void 0?y.length/b:0,this.normalized=D,this.usage=oa,this.updateRange={offset:0,count:-1},this.gpuType=Tn,this.version=0}onUploadCallback(){}set needsUpdate(y){y===!0&&this.version++}setUsage(y){return this.usage=y,this}copy(y){return this.name=y.name,this.array=new y.array.constructor(y.array),this.itemSize=y.itemSize,this.count=y.count,this.normalized=y.normalized,this.usage=y.usage,this.gpuType=y.gpuType,this}copyAt(y,b,D){y*=this.itemSize,D*=b.itemSize;for(let Y=0,_e=this.itemSize;Y<_e;Y++)this.array[y+Y]=b.array[D+Y];return this}copyArray(y){return this.array.set(y),this}applyMatrix3(y){if(this.itemSize===2)for(let b=0,D=this.count;b<D;b++)Dt.fromBufferAttribute(this,b),Dt.applyMatrix3(y),this.setXY(b,Dt.x,Dt.y);else if(this.itemSize===3)for(let b=0,D=this.count;b<D;b++)vt.fromBufferAttribute(this,b),vt.applyMatrix3(y),this.setXYZ(b,vt.x,vt.y,vt.z);return this}applyMatrix4(y){for(let b=0,D=this.count;b<D;b++)vt.fromBufferAttribute(this,b),vt.applyMatrix4(y),this.setXYZ(b,vt.x,vt.y,vt.z);return this}applyNormalMatrix(y){for(let b=0,D=this.count;b<D;b++)vt.fromBufferAttribute(this,b),vt.applyNormalMatrix(y),this.setXYZ(b,vt.x,vt.y,vt.z);return this}transformDirection(y){for(let b=0,D=this.count;b<D;b++)vt.fromBufferAttribute(this,b),vt.transformDirection(y),this.setXYZ(b,vt.x,vt.y,vt.z);return this}set(y,b=0){return this.array.set(y,b),this}getComponent(y,b){let D=this.array[y*this.itemSize+b];return this.normalized&&(D=po(D,this.array)),D}setComponent(y,b,D){return this.normalized&&(D=$n(D,this.array)),this.array[y*this.itemSize+b]=D,this}getX(y){let b=this.array[y*this.itemSize];return this.normalized&&(b=po(b,this.array)),b}setX(y,b){return this.normalized&&(b=$n(b,this.array)),this.array[y*this.itemSize]=b,this}getY(y){let b=this.array[y*this.itemSize+1];return this.normalized&&(b=po(b,this.array)),b}setY(y,b){return this.normalized&&(b=$n(b,this.array)),this.array[y*this.itemSize+1]=b,this}getZ(y){let b=this.array[y*this.itemSize+2];return this.normalized&&(b=po(b,this.array)),b}setZ(y,b){return this.normalized&&(b=$n(b,this.array)),this.array[y*this.itemSize+2]=b,this}getW(y){let b=this.array[y*this.itemSize+3];return this.normalized&&(b=po(b,this.array)),b}setW(y,b){return this.normalized&&(b=$n(b,this.array)),this.array[y*this.itemSize+3]=b,this}setXY(y,b,D){return y*=this.itemSize,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array)),this.array[y+0]=b,this.array[y+1]=D,this}setXYZ(y,b,D,Y){return y*=this.itemSize,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array),Y=$n(Y,this.array)),this.array[y+0]=b,this.array[y+1]=D,this.array[y+2]=Y,this}setXYZW(y,b,D,Y,_e){return y*=this.itemSize,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array),Y=$n(Y,this.array),_e=$n(_e,this.array)),this.array[y+0]=b,this.array[y+1]=D,this.array[y+2]=Y,this.array[y+3]=_e,this}onUpload(y){return this.onUploadCallback=y,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const y={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return this.name!==""&&(y.name=this.name),this.usage!==oa&&(y.usage=this.usage),this.updateRange.offset===0&&this.updateRange.count===-1||(y.updateRange=this.updateRange),y}}class ni extends zt{constructor(y,b,D){super(new Int8Array(y),b,D)}}class Di extends zt{constructor(y,b,D){super(new Uint8Array(y),b,D)}}class rn extends zt{constructor(y,b,D){super(new Uint8ClampedArray(y),b,D)}}class Bn extends zt{constructor(y,b,D){super(new Int16Array(y),b,D)}}class tr extends zt{constructor(y,b,D){super(new Uint16Array(y),b,D)}}class Wr extends zt{constructor(y,b,D){super(new Int32Array(y),b,D)}}class go extends zt{constructor(y,b,D){super(new Uint32Array(y),b,D)}}class bo extends zt{constructor(y,b,D){super(new Uint16Array(y),b,D),this.isFloat16BufferAttribute=!0}getX(y){let b=Ie(this.array[y*this.itemSize]);return this.normalized&&(b=po(b,this.array)),b}setX(y,b){return this.normalized&&(b=$n(b,this.array)),this.array[y*this.itemSize]=ft(b),this}getY(y){let b=Ie(this.array[y*this.itemSize+1]);return this.normalized&&(b=po(b,this.array)),b}setY(y,b){return this.normalized&&(b=$n(b,this.array)),this.array[y*this.itemSize+1]=ft(b),this}getZ(y){let b=Ie(this.array[y*this.itemSize+2]);return this.normalized&&(b=po(b,this.array)),b}setZ(y,b){return this.normalized&&(b=$n(b,this.array)),this.array[y*this.itemSize+2]=ft(b),this}getW(y){let b=Ie(this.array[y*this.itemSize+3]);return this.normalized&&(b=po(b,this.array)),b}setW(y,b){return this.normalized&&(b=$n(b,this.array)),this.array[y*this.itemSize+3]=ft(b),this}setXY(y,b,D){return y*=this.itemSize,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array)),this.array[y+0]=ft(b),this.array[y+1]=ft(D),this}setXYZ(y,b,D,Y){return y*=this.itemSize,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array),Y=$n(Y,this.array)),this.array[y+0]=ft(b),this.array[y+1]=ft(D),this.array[y+2]=ft(Y),this}setXYZW(y,b,D,Y,_e){return y*=this.itemSize,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array),Y=$n(Y,this.array),_e=$n(_e,this.array)),this.array[y+0]=ft(b),this.array[y+1]=ft(D),this.array[y+2]=ft(Y),this.array[y+3]=ft(_e),this}}class Cn extends zt{constructor(y,b,D){super(new Float32Array(y),b,D)}}class qc extends zt{constructor(y,b,D){super(new Float64Array(y),b,D)}}let Vl=0;const xo=new Xn,wa=new yr,ds=new ii,Co=new Ko,Xa=new Ko,oo=new ii;class dr extends ho{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:Vl++}),this.uuid=vo(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(y){return Array.isArray(y)?this.index=new(Ou(y)?go:tr)(y,1):this.index=y,this}getAttribute(y){return this.attributes[y]}setAttribute(y,b){return this.attributes[y]=b,this}deleteAttribute(y){return delete this.attributes[y],this}hasAttribute(y){return this.attributes[y]!==void 0}addGroup(y,b,D=0){this.groups.push({start:y,count:b,materialIndex:D})}clearGroups(){this.groups=[]}setDrawRange(y,b){this.drawRange.start=y,this.drawRange.count=b}applyMatrix4(y){const b=this.attributes.position;b!==void 0&&(b.applyMatrix4(y),b.needsUpdate=!0);const D=this.attributes.normal;if(D!==void 0){const _e=new er().getNormalMatrix(y);D.applyNormalMatrix(_e),D.needsUpdate=!0}const Y=this.attributes.tangent;return Y!==void 0&&(Y.transformDirection(y),Y.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(y){return xo.makeRotationFromQuaternion(y),this.applyMatrix4(xo),this}rotateX(y){return xo.makeRotationX(y),this.applyMatrix4(xo),this}rotateY(y){return xo.makeRotationY(y),this.applyMatrix4(xo),this}rotateZ(y){return xo.makeRotationZ(y),this.applyMatrix4(xo),this}translate(y,b,D){return xo.makeTranslation(y,b,D),this.applyMatrix4(xo),this}scale(y,b,D){return xo.makeScale(y,b,D),this.applyMatrix4(xo),this}lookAt(y){return wa.lookAt(y),wa.updateMatrix(),this.applyMatrix4(wa.matrix),this}center(y=void 0){return this.computeBoundingBox(),this.boundingBox.getCenter(ds).negate(),this.translate(ds.x,ds.y,ds.z),y&&y.copy(ds),this}setFromPoints(y){const b=[];for(let D=0,Y=y.length;D<Y;D++){const _e=y[D];b.push(_e.x,_e.y,_e.z||0)}return this.setAttribute("position",new Cn(b,3)),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Ko);const y=this.attributes.position,b=this.morphAttributes.position;if(y&&y.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new ii(-1/0,-1/0,-1/0),new ii(1/0,1/0,1/0));if(y!==void 0){if(this.boundingBox.setFromBufferAttribute(y),b)for(let D=0,Y=b.length;D<Y;D++){const _e=b[D];Co.setFromBufferAttribute(_e),this.morphTargetsRelative?(oo.addVectors(this.boundingBox.min,Co.min),this.boundingBox.expandByPoint(oo),oo.addVectors(this.boundingBox.max,Co.max),this.boundingBox.expandByPoint(oo)):(this.boundingBox.expandByPoint(Co.min),this.boundingBox.expandByPoint(Co.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new Oo);const y=this.attributes.position,b=this.morphAttributes.position;if(y&&y.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new ii,1/0);if(y){const D=this.boundingSphere.center;if(Co.setFromBufferAttribute(y),b)for(let _e=0,Le=b.length;_e<Le;_e++){const qe=b[_e];Xa.setFromBufferAttribute(qe),this.morphTargetsRelative?(oo.addVectors(Co.min,Xa.min),Co.expandByPoint(oo),oo.addVectors(Co.max,Xa.max),Co.expandByPoint(oo)):(Co.expandByPoint(Xa.min),Co.expandByPoint(Xa.max))}Co.getCenter(D);let Y=0;for(let _e=0,Le=y.count;_e<Le;_e++)oo.fromBufferAttribute(y,_e),Y=Math.max(Y,D.distanceToSquared(oo));if(b)for(let _e=0,Le=b.length;_e<Le;_e++){const qe=b[_e],it=this.morphTargetsRelative;for(let nt=0,mt=qe.count;nt<mt;nt++)oo.fromBufferAttribute(qe,nt),it&&(ds.fromBufferAttribute(y,nt),oo.add(ds)),Y=Math.max(Y,D.distanceToSquared(oo))}this.boundingSphere.radius=Math.sqrt(Y),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const y=this.index,b=this.attributes;if(y===null||b.position===void 0||b.normal===void 0||b.uv===void 0)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const D=y.array,Y=b.position.array,_e=b.normal.array,Le=b.uv.array,qe=Y.length/3;this.hasAttribute("tangent")===!1&&this.setAttribute("tangent",new zt(new Float32Array(4*qe),4));const it=this.getAttribute("tangent").array,nt=[],mt=[];for(let yi=0;yi<qe;yi++)nt[yi]=new ii,mt[yi]=new ii;const bt=new ii,At=new ii,wt=new ii,Et=new en,Mt=new en,St=new en,Nt=new ii,It=new ii;function Rt(yi,bi,Ci){bt.fromArray(Y,3*yi),At.fromArray(Y,3*bi),wt.fromArray(Y,3*Ci),Et.fromArray(Le,2*yi),Mt.fromArray(Le,2*bi),St.fromArray(Le,2*Ci),At.sub(bt),wt.sub(bt),Mt.sub(Et),St.sub(Et);const tn=1/(Mt.x*St.y-St.x*Mt.y);isFinite(tn)&&(Nt.copy(At).multiplyScalar(St.y).addScaledVector(wt,-Mt.y).multiplyScalar(tn),It.copy(wt).multiplyScalar(Mt.x).addScaledVector(At,-St.x).multiplyScalar(tn),nt[yi].add(Nt),nt[bi].add(Nt),nt[Ci].add(Nt),mt[yi].add(It),mt[bi].add(It),mt[Ci].add(It))}let Yt=this.groups;Yt.length===0&&(Yt=[{start:0,count:D.length}]);for(let yi=0,bi=Yt.length;yi<bi;++yi){const Ci=Yt[yi],tn=Ci.start;for(let $i=tn,gn=tn+Ci.count;$i<gn;$i+=3)Rt(D[$i+0],D[$i+1],D[$i+2])}const Kt=new ii,Xt=new ii,oi=new ii,wi=new ii;function fi(yi){oi.fromArray(_e,3*yi),wi.copy(oi);const bi=nt[yi];Kt.copy(bi),Kt.sub(oi.multiplyScalar(oi.dot(bi))).normalize(),Xt.crossVectors(wi,bi);const Ci=Xt.dot(mt[yi])<0?-1:1;it[4*yi]=Kt.x,it[4*yi+1]=Kt.y,it[4*yi+2]=Kt.z,it[4*yi+3]=Ci}for(let yi=0,bi=Yt.length;yi<bi;++yi){const Ci=Yt[yi],tn=Ci.start;for(let $i=tn,gn=tn+Ci.count;$i<gn;$i+=3)fi(D[$i+0]),fi(D[$i+1]),fi(D[$i+2])}}computeVertexNormals(){const y=this.index,b=this.getAttribute("position");if(b!==void 0){let D=this.getAttribute("normal");if(D===void 0)D=new zt(new Float32Array(3*b.count),3),this.setAttribute("normal",D);else for(let At=0,wt=D.count;At<wt;At++)D.setXYZ(At,0,0,0);const Y=new ii,_e=new ii,Le=new ii,qe=new ii,it=new ii,nt=new ii,mt=new ii,bt=new ii;if(y)for(let At=0,wt=y.count;At<wt;At+=3){const Et=y.getX(At+0),Mt=y.getX(At+1),St=y.getX(At+2);Y.fromBufferAttribute(b,Et),_e.fromBufferAttribute(b,Mt),Le.fromBufferAttribute(b,St),mt.subVectors(Le,_e),bt.subVectors(Y,_e),mt.cross(bt),qe.fromBufferAttribute(D,Et),it.fromBufferAttribute(D,Mt),nt.fromBufferAttribute(D,St),qe.add(mt),it.add(mt),nt.add(mt),D.setXYZ(Et,qe.x,qe.y,qe.z),D.setXYZ(Mt,it.x,it.y,it.z),D.setXYZ(St,nt.x,nt.y,nt.z)}else for(let At=0,wt=b.count;At<wt;At+=3)Y.fromBufferAttribute(b,At+0),_e.fromBufferAttribute(b,At+1),Le.fromBufferAttribute(b,At+2),mt.subVectors(Le,_e),bt.subVectors(Y,_e),mt.cross(bt),D.setXYZ(At+0,mt.x,mt.y,mt.z),D.setXYZ(At+1,mt.x,mt.y,mt.z),D.setXYZ(At+2,mt.x,mt.y,mt.z);this.normalizeNormals(),D.needsUpdate=!0}}normalizeNormals(){const y=this.attributes.normal;for(let b=0,D=y.count;b<D;b++)oo.fromBufferAttribute(y,b),oo.normalize(),y.setXYZ(b,oo.x,oo.y,oo.z)}toNonIndexed(){function y(qe,it){const nt=qe.array,mt=qe.itemSize,bt=qe.normalized,At=new nt.constructor(it.length*mt);let wt=0,Et=0;for(let Mt=0,St=it.length;Mt<St;Mt++){wt=qe.isInterleavedBufferAttribute?it[Mt]*qe.data.stride+qe.offset:it[Mt]*mt;for(let Nt=0;Nt<mt;Nt++)At[Et++]=nt[wt++]}return new zt(At,mt,bt)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const b=new dr,D=this.index.array,Y=this.attributes;for(const qe in Y){const it=y(Y[qe],D);b.setAttribute(qe,it)}const _e=this.morphAttributes;for(const qe in _e){const it=[],nt=_e[qe];for(let mt=0,bt=nt.length;mt<bt;mt++){const At=y(nt[mt],D);it.push(At)}b.morphAttributes[qe]=it}b.morphTargetsRelative=this.morphTargetsRelative;const Le=this.groups;for(let qe=0,it=Le.length;qe<it;qe++){const nt=Le[qe];b.addGroup(nt.start,nt.count,nt.materialIndex)}return b}toJSON(){const y={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(y.uuid=this.uuid,y.type=this.type,this.name!==""&&(y.name=this.name),Object.keys(this.userData).length>0&&(y.userData=this.userData),this.parameters!==void 0){const it=this.parameters;for(const nt in it)it[nt]!==void 0&&(y[nt]=it[nt]);return y}y.data={attributes:{}};const b=this.index;b!==null&&(y.data.index={type:b.array.constructor.name,array:Array.prototype.slice.call(b.array)});const D=this.attributes;for(const it in D){const nt=D[it];y.data.attributes[it]=nt.toJSON(y.data)}const Y={};let _e=!1;for(const it in this.morphAttributes){const nt=this.morphAttributes[it],mt=[];for(let bt=0,At=nt.length;bt<At;bt++){const wt=nt[bt];mt.push(wt.toJSON(y.data))}mt.length>0&&(Y[it]=mt,_e=!0)}_e&&(y.data.morphAttributes=Y,y.data.morphTargetsRelative=this.morphTargetsRelative);const Le=this.groups;Le.length>0&&(y.data.groups=JSON.parse(JSON.stringify(Le)));const qe=this.boundingSphere;return qe!==null&&(y.data.boundingSphere={center:qe.center.toArray(),radius:qe.radius}),y}clone(){return new this.constructor().copy(this)}copy(y){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const b={};this.name=y.name;const D=y.index;D!==null&&this.setIndex(D.clone(b));const Y=y.attributes;for(const nt in Y){const mt=Y[nt];this.setAttribute(nt,mt.clone(b))}const _e=y.morphAttributes;for(const nt in _e){const mt=[],bt=_e[nt];for(let At=0,wt=bt.length;At<wt;At++)mt.push(bt[At].clone(b));this.morphAttributes[nt]=mt}this.morphTargetsRelative=y.morphTargetsRelative;const Le=y.groups;for(let nt=0,mt=Le.length;nt<mt;nt++){const bt=Le[nt];this.addGroup(bt.start,bt.count,bt.materialIndex)}const qe=y.boundingBox;qe!==null&&(this.boundingBox=qe.clone());const it=y.boundingSphere;return it!==null&&(this.boundingSphere=it.clone()),this.drawRange.start=y.drawRange.start,this.drawRange.count=y.drawRange.count,this.userData=y.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const gp=new Xn,Ya=new ma,Qu=new Oo,_p=new ii,Hl=new ii,Ql=new ii,Wl=new ii,vh=new ii,Wu=new ii,qu=new en,Xu=new en,Yu=new en,vp=new ii,yp=new ii,Ap=new ii,Ku=new ii,$u=new ii;class so extends yr{constructor(y=new dr,b=new Ss){super(),this.isMesh=!0,this.type="Mesh",this.geometry=y,this.material=b,this.updateMorphTargets()}copy(y,b){return super.copy(y,b),y.isMesh?(y.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=y.morphTargetInfluences.slice()),y.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},y.morphTargetDictionary)),this.material=Array.isArray(y.material)?y.material.slice():y.material,this.geometry=y.geometry,this):this}updateMorphTargets(){const y=this.geometry.morphAttributes,b=Object.keys(y);if(b.length>0){const D=y[b[0]];if(D!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let Y=0,_e=D.length;Y<_e;Y++){const Le=D[Y].name||String(Y);this.morphTargetInfluences.push(0),this.morphTargetDictionary[Le]=Y}}}}getVertexPosition(y,b){const D=this.geometry,Y=D.attributes.position,_e=D.morphAttributes.position,Le=D.morphTargetsRelative;b.fromBufferAttribute(Y,y);const qe=this.morphTargetInfluences;if(_e&&qe){Wu.set(0,0,0);for(let it=0,nt=_e.length;it<nt;it++){const mt=qe[it],bt=_e[it];mt!==0&&(vh.fromBufferAttribute(bt,y),Le?Wu.addScaledVector(vh,mt):Wu.addScaledVector(vh.sub(b),mt))}b.add(Wu)}return b}raycast(y,b){const D=this.geometry,Y=this.material,_e=this.matrixWorld;if(Y!==void 0){if(D.boundingSphere===null&&D.computeBoundingSphere(),Qu.copy(D.boundingSphere),Qu.applyMatrix4(_e),Ya.copy(y.ray).recast(y.near),Qu.containsPoint(Ya.origin)===!1&&(Ya.intersectSphere(Qu,_p)===null||Ya.origin.distanceToSquared(_p)>(y.far-y.near)**2))return;gp.copy(_e).invert(),Ya.copy(y.ray).applyMatrix4(gp),D.boundingBox!==null&&Ya.intersectsBox(D.boundingBox)===!1||this._computeIntersections(y,b,Ya)}}_computeIntersections(y,b,D){let Y;const _e=this.geometry,Le=this.material,qe=_e.index,it=_e.attributes.position,nt=_e.attributes.uv,mt=_e.attributes.uv1,bt=_e.attributes.normal,At=_e.groups,wt=_e.drawRange;if(qe!==null)if(Array.isArray(Le))for(let Et=0,Mt=At.length;Et<Mt;Et++){const St=At[Et],Nt=Le[St.materialIndex];for(let It=Math.max(St.start,wt.start),Rt=Math.min(qe.count,Math.min(St.start+St.count,wt.start+wt.count));It<Rt;It+=3)Y=Ju(this,Nt,y,D,nt,mt,bt,qe.getX(It),qe.getX(It+1),qe.getX(It+2)),Y&&(Y.faceIndex=Math.floor(It/3),Y.face.materialIndex=St.materialIndex,b.push(Y))}else for(let Et=Math.max(0,wt.start),Mt=Math.min(qe.count,wt.start+wt.count);Et<Mt;Et+=3)Y=Ju(this,Le,y,D,nt,mt,bt,qe.getX(Et),qe.getX(Et+1),qe.getX(Et+2)),Y&&(Y.faceIndex=Math.floor(Et/3),b.push(Y));else if(it!==void 0)if(Array.isArray(Le))for(let Et=0,Mt=At.length;Et<Mt;Et++){const St=At[Et],Nt=Le[St.materialIndex];for(let It=Math.max(St.start,wt.start),Rt=Math.min(it.count,Math.min(St.start+St.count,wt.start+wt.count));It<Rt;It+=3)Y=Ju(this,Nt,y,D,nt,mt,bt,It,It+1,It+2),Y&&(Y.faceIndex=Math.floor(It/3),Y.face.materialIndex=St.materialIndex,b.push(Y))}else for(let Et=Math.max(0,wt.start),Mt=Math.min(it.count,wt.start+wt.count);Et<Mt;Et+=3)Y=Ju(this,Le,y,D,nt,mt,bt,Et,Et+1,Et+2),Y&&(Y.faceIndex=Math.floor(Et/3),b.push(Y))}}function Ju(De,y,b,D,Y,_e,Le,qe,it,nt){De.getVertexPosition(qe,Hl),De.getVertexPosition(it,Ql),De.getVertexPosition(nt,Wl);const mt=function(bt,At,wt,Et,Mt,St,Nt,It){let Rt;if(Rt=At.side===ye?Et.intersectTriangle(Nt,St,Mt,!0,It):Et.intersectTriangle(Mt,St,Nt,At.side===ue,It),Rt===null)return null;$u.copy(It),$u.applyMatrix4(bt.matrixWorld);const Yt=wt.ray.origin.distanceTo($u);return Yt<wt.near||Yt>wt.far?null:{distance:Yt,point:$u.clone(),object:bt}}(De,y,b,D,Hl,Ql,Wl,Ku);if(mt){Y&&(qu.fromBufferAttribute(Y,qe),Xu.fromBufferAttribute(Y,it),Yu.fromBufferAttribute(Y,nt),mt.uv=fo.getInterpolation(Ku,Hl,Ql,Wl,qu,Xu,Yu,new en)),_e&&(qu.fromBufferAttribute(_e,qe),Xu.fromBufferAttribute(_e,it),Yu.fromBufferAttribute(_e,nt),mt.uv1=fo.getInterpolation(Ku,Hl,Ql,Wl,qu,Xu,Yu,new en),mt.uv2=mt.uv1),Le&&(vp.fromBufferAttribute(Le,qe),yp.fromBufferAttribute(Le,it),Ap.fromBufferAttribute(Le,nt),mt.normal=fo.getInterpolation(Ku,Hl,Ql,Wl,vp,yp,Ap,new ii),mt.normal.dot(D.direction)>0&&mt.normal.multiplyScalar(-1));const bt={a:qe,b:it,c:nt,normal:new ii,materialIndex:0};fo.getNormal(Hl,Ql,Wl,bt.normal),mt.face=bt}return mt}class Ea extends dr{constructor(y=1,b=1,D=1,Y=1,_e=1,Le=1){super(),this.type="BoxGeometry",this.parameters={width:y,height:b,depth:D,widthSegments:Y,heightSegments:_e,depthSegments:Le};const qe=this;Y=Math.floor(Y),_e=Math.floor(_e),Le=Math.floor(Le);const it=[],nt=[],mt=[],bt=[];let At=0,wt=0;function Et(Mt,St,Nt,It,Rt,Yt,Kt,Xt,oi,wi,fi){const yi=Yt/oi,bi=Kt/wi,Ci=Yt/2,tn=Kt/2,$i=Xt/2,gn=oi+1,xn=wi+1;let Wi=0,Oi=0;const ki=new ii;for(let Hi=0;Hi<xn;Hi++){const Vi=Hi*bi-tn;for(let Mn=0;Mn<gn;Mn++){const Wn=Mn*yi-Ci;ki[Mt]=Wn*It,ki[St]=Vi*Rt,ki[Nt]=$i,nt.push(ki.x,ki.y,ki.z),ki[Mt]=0,ki[St]=0,ki[Nt]=Xt>0?1:-1,mt.push(ki.x,ki.y,ki.z),bt.push(Mn/oi),bt.push(1-Hi/wi),Wi+=1}}for(let Hi=0;Hi<wi;Hi++)for(let Vi=0;Vi<oi;Vi++){const Mn=At+Vi+gn*Hi,Wn=At+Vi+gn*(Hi+1),zn=At+(Vi+1)+gn*(Hi+1),Pn=At+(Vi+1)+gn*Hi;it.push(Mn,Wn,Pn),it.push(Wn,zn,Pn),Oi+=6}qe.addGroup(wt,Oi,fi),wt+=Oi,At+=Wi}Et("z","y","x",-1,-1,D,b,y,Le,_e,0),Et("z","y","x",1,-1,D,b,-y,Le,_e,1),Et("x","z","y",1,1,y,D,b,Y,Le,2),Et("x","z","y",1,-1,y,D,-b,Y,Le,3),Et("x","y","z",1,-1,y,b,D,Y,_e,4),Et("x","y","z",-1,-1,y,b,-D,Y,_e,5),this.setIndex(it),this.setAttribute("position",new Cn(nt,3)),this.setAttribute("normal",new Cn(mt,3)),this.setAttribute("uv",new Cn(bt,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new Ea(y.width,y.height,y.depth,y.widthSegments,y.heightSegments,y.depthSegments)}}function Ka(De){const y={};for(const b in De){y[b]={};for(const D in De[b]){const Y=De[b][D];Y&&(Y.isColor||Y.isMatrix3||Y.isMatrix4||Y.isVector2||Y.isVector3||Y.isVector4||Y.isTexture||Y.isQuaternion)?Y.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),y[b][D]=null):y[b][D]=Y.clone():Array.isArray(Y)?y[b][D]=Y.slice():y[b][D]=Y}}return y}function Mo(De){const y={};for(let b=0;b<De.length;b++){const D=Ka(De[b]);for(const Y in D)y[Y]=D[Y]}return y}function bp(De){return De.getRenderTarget()===null?De.outputColorSpace:Sr.workingColorSpace}const xp={clone:Ka,merge:Mo};class hs extends no{constructor(y){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,this.fragmentShader=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,y!==void 0&&this.setValues(y)}copy(y){return super.copy(y),this.fragmentShader=y.fragmentShader,this.vertexShader=y.vertexShader,this.uniforms=Ka(y.uniforms),this.uniformsGroups=function(b){const D=[];for(let Y=0;Y<b.length;Y++)D.push(b[Y].clone());return D}(y.uniformsGroups),this.defines=Object.assign({},y.defines),this.wireframe=y.wireframe,this.wireframeLinewidth=y.wireframeLinewidth,this.fog=y.fog,this.lights=y.lights,this.clipping=y.clipping,this.extensions=Object.assign({},y.extensions),this.glslVersion=y.glslVersion,this}toJSON(y){const b=super.toJSON(y);b.glslVersion=this.glslVersion,b.uniforms={};for(const Y in this.uniforms){const _e=this.uniforms[Y].value;_e&&_e.isTexture?b.uniforms[Y]={type:"t",value:_e.toJSON(y).uuid}:_e&&_e.isColor?b.uniforms[Y]={type:"c",value:_e.getHex()}:_e&&_e.isVector2?b.uniforms[Y]={type:"v2",value:_e.toArray()}:_e&&_e.isVector3?b.uniforms[Y]={type:"v3",value:_e.toArray()}:_e&&_e.isVector4?b.uniforms[Y]={type:"v4",value:_e.toArray()}:_e&&_e.isMatrix3?b.uniforms[Y]={type:"m3",value:_e.toArray()}:_e&&_e.isMatrix4?b.uniforms[Y]={type:"m4",value:_e.toArray()}:b.uniforms[Y]={value:_e}}Object.keys(this.defines).length>0&&(b.defines=this.defines),b.vertexShader=this.vertexShader,b.fragmentShader=this.fragmentShader,b.lights=this.lights,b.clipping=this.clipping;const D={};for(const Y in this.extensions)this.extensions[Y]===!0&&(D[Y]=!0);return Object.keys(D).length>0&&(b.extensions=D),b}}class Zu extends yr{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Xn,this.projectionMatrix=new Xn,this.projectionMatrixInverse=new Xn,this.coordinateSystem=Bo}copy(y,b){return super.copy(y,b),this.matrixWorldInverse.copy(y.matrixWorldInverse),this.projectionMatrix.copy(y.projectionMatrix),this.projectionMatrixInverse.copy(y.projectionMatrixInverse),this.coordinateSystem=y.coordinateSystem,this}getWorldDirection(y){return super.getWorldDirection(y).negate()}updateMatrixWorld(y){super.updateMatrixWorld(y),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(y,b){super.updateWorldMatrix(y,b),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}class _o extends Zu{constructor(y=50,b=1,D=.1,Y=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=y,this.zoom=1,this.near=D,this.far=Y,this.focus=10,this.aspect=b,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(y,b){return super.copy(y,b),this.fov=y.fov,this.zoom=y.zoom,this.near=y.near,this.far=y.far,this.focus=y.focus,this.aspect=y.aspect,this.view=y.view===null?null:Object.assign({},y.view),this.filmGauge=y.filmGauge,this.filmOffset=y.filmOffset,this}setFocalLength(y){const b=.5*this.getFilmHeight()/y;this.fov=2*Fs*Math.atan(b),this.updateProjectionMatrix()}getFocalLength(){const y=Math.tan(.5*As*this.fov);return .5*this.getFilmHeight()/y}getEffectiveFOV(){return 2*Fs*Math.atan(Math.tan(.5*As*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(y,b,D,Y,_e,Le){this.aspect=y/b,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=y,this.view.fullHeight=b,this.view.offsetX=D,this.view.offsetY=Y,this.view.width=_e,this.view.height=Le,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const y=this.near;let b=y*Math.tan(.5*As*this.fov)/this.zoom,D=2*b,Y=this.aspect*D,_e=-.5*Y;const Le=this.view;if(this.view!==null&&this.view.enabled){const it=Le.fullWidth,nt=Le.fullHeight;_e+=Le.offsetX*Y/it,b-=Le.offsetY*D/nt,Y*=Le.width/it,D*=Le.height/nt}const qe=this.filmOffset;qe!==0&&(_e+=y*qe/this.getFilmWidth()),this.projectionMatrix.makePerspective(_e,_e+Y,b,b-D,y,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(y){const b=super.toJSON(y);return b.object.fov=this.fov,b.object.zoom=this.zoom,b.object.near=this.near,b.object.far=this.far,b.object.focus=this.focus,b.object.aspect=this.aspect,this.view!==null&&(b.object.view=Object.assign({},this.view)),b.object.filmGauge=this.filmGauge,b.object.filmOffset=this.filmOffset,b}}const ql=-90;class wp extends yr{constructor(y,b,D){super(),this.type="CubeCamera",this.renderTarget=D,this.coordinateSystem=null,this.activeMipmapLevel=0;const Y=new _o(ql,1,y,b);Y.layers=this.layers,this.add(Y);const _e=new _o(ql,1,y,b);_e.layers=this.layers,this.add(_e);const Le=new _o(ql,1,y,b);Le.layers=this.layers,this.add(Le);const qe=new _o(ql,1,y,b);qe.layers=this.layers,this.add(qe);const it=new _o(ql,1,y,b);it.layers=this.layers,this.add(it);const nt=new _o(ql,1,y,b);nt.layers=this.layers,this.add(nt)}updateCoordinateSystem(){const y=this.coordinateSystem,b=this.children.concat(),[D,Y,_e,Le,qe,it]=b;for(const nt of b)this.remove(nt);if(y===Bo)D.up.set(0,1,0),D.lookAt(1,0,0),Y.up.set(0,1,0),Y.lookAt(-1,0,0),_e.up.set(0,0,-1),_e.lookAt(0,1,0),Le.up.set(0,0,1),Le.lookAt(0,-1,0),qe.up.set(0,1,0),qe.lookAt(0,0,1),it.up.set(0,1,0),it.lookAt(0,0,-1);else{if(y!==jo)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+y);D.up.set(0,-1,0),D.lookAt(-1,0,0),Y.up.set(0,-1,0),Y.lookAt(1,0,0),_e.up.set(0,0,1),_e.lookAt(0,1,0),Le.up.set(0,0,-1),Le.lookAt(0,-1,0),qe.up.set(0,-1,0),qe.lookAt(0,0,1),it.up.set(0,-1,0),it.lookAt(0,0,-1)}for(const nt of b)this.add(nt),nt.updateMatrixWorld()}update(y,b){this.parent===null&&this.updateMatrixWorld();const{renderTarget:D,activeMipmapLevel:Y}=this;this.coordinateSystem!==y.coordinateSystem&&(this.coordinateSystem=y.coordinateSystem,this.updateCoordinateSystem());const[_e,Le,qe,it,nt,mt]=this.children,bt=y.getRenderTarget(),At=y.getActiveCubeFace(),wt=y.getActiveMipmapLevel(),Et=y.xr.enabled;y.xr.enabled=!1;const Mt=D.texture.generateMipmaps;D.texture.generateMipmaps=!1,y.setRenderTarget(D,0,Y),y.render(b,_e),y.setRenderTarget(D,1,Y),y.render(b,Le),y.setRenderTarget(D,2,Y),y.render(b,qe),y.setRenderTarget(D,3,Y),y.render(b,it),y.setRenderTarget(D,4,Y),y.render(b,nt),D.texture.generateMipmaps=Mt,y.setRenderTarget(D,5,Y),y.render(b,mt),y.setRenderTarget(bt,At,wt),y.xr.enabled=Et,D.texture.needsPMREMUpdate=!0}}class Xc extends Or{constructor(y,b,D,Y,_e,Le,qe,it,nt,mt){super(y=y!==void 0?y:[],b=b!==void 0?b:xi,D,Y,_e,Le,qe,it,nt,mt),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(y){this.image=y}}class Ep extends yo{constructor(y=1,b={}){super(y,y,b),this.isWebGLCubeRenderTarget=!0;const D={width:y,height:y,depth:1},Y=[D,D,D,D,D,D];b.encoding!==void 0&&(zs("THREE.WebGLCubeRenderTarget: option.encoding has been replaced by option.colorSpace."),b.colorSpace=b.encoding===ss?Rr:Cr),this.texture=new Xc(Y,b.mapping,b.wrapS,b.wrapT,b.magFilter,b.minFilter,b.format,b.type,b.anisotropy,b.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=b.generateMipmaps!==void 0&&b.generateMipmaps,this.texture.minFilter=b.minFilter!==void 0?b.minFilter:fn}fromEquirectangularTexture(y,b){this.texture.type=b.type,this.texture.colorSpace=b.colorSpace,this.texture.generateMipmaps=b.generateMipmaps,this.texture.minFilter=b.minFilter,this.texture.magFilter=b.magFilter;const D={tEquirect:{value:null}},Y=`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,_e=`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`,Le=new Ea(5,5,5),qe=new hs({name:"CubemapFromEquirect",uniforms:Ka(D),vertexShader:Y,fragmentShader:_e,side:ye,blending:Ve});qe.uniforms.tEquirect.value=b;const it=new so(Le,qe),nt=b.minFilter;return b.minFilter===Zn&&(b.minFilter=fn),new wp(1,10,this).update(y,it),b.minFilter=nt,it.geometry.dispose(),it.material.dispose(),this}clear(y,b,D,Y){const _e=y.getRenderTarget();for(let Le=0;Le<6;Le++)y.setRenderTarget(this,Le),y.clear(b,D,Y);y.setRenderTarget(_e)}}const yh=new ii,eg=new ii,tg=new er;class Sa{constructor(y=new ii(1,0,0),b=0){this.isPlane=!0,this.normal=y,this.constant=b}set(y,b){return this.normal.copy(y),this.constant=b,this}setComponents(y,b,D,Y){return this.normal.set(y,b,D),this.constant=Y,this}setFromNormalAndCoplanarPoint(y,b){return this.normal.copy(y),this.constant=-b.dot(this.normal),this}setFromCoplanarPoints(y,b,D){const Y=yh.subVectors(D,b).cross(eg.subVectors(y,b)).normalize();return this.setFromNormalAndCoplanarPoint(Y,y),this}copy(y){return this.normal.copy(y.normal),this.constant=y.constant,this}normalize(){const y=1/this.normal.length();return this.normal.multiplyScalar(y),this.constant*=y,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(y){return this.normal.dot(y)+this.constant}distanceToSphere(y){return this.distanceToPoint(y.center)-y.radius}projectPoint(y,b){return b.copy(y).addScaledVector(this.normal,-this.distanceToPoint(y))}intersectLine(y,b){const D=y.delta(yh),Y=this.normal.dot(D);if(Y===0)return this.distanceToPoint(y.start)===0?b.copy(y.start):null;const _e=-(y.start.dot(this.normal)+this.constant)/Y;return _e<0||_e>1?null:b.copy(y.start).addScaledVector(D,_e)}intersectsLine(y){const b=this.distanceToPoint(y.start),D=this.distanceToPoint(y.end);return b<0&&D>0||D<0&&b>0}intersectsBox(y){return y.intersectsPlane(this)}intersectsSphere(y){return y.intersectsPlane(this)}coplanarPoint(y){return y.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(y,b){const D=b||tg.getNormalMatrix(y),Y=this.coplanarPoint(yh).applyMatrix4(y),_e=this.normal.applyMatrix3(D).normalize();return this.constant=-Y.dot(_e),this}translate(y){return this.constant-=y.dot(this.normal),this}equals(y){return y.normal.equals(this.normal)&&y.constant===this.constant}clone(){return new this.constructor().copy(this)}}const $a=new Oo,ed=new ii;class nd{constructor(y=new Sa,b=new Sa,D=new Sa,Y=new Sa,_e=new Sa,Le=new Sa){this.planes=[y,b,D,Y,_e,Le]}set(y,b,D,Y,_e,Le){const qe=this.planes;return qe[0].copy(y),qe[1].copy(b),qe[2].copy(D),qe[3].copy(Y),qe[4].copy(_e),qe[5].copy(Le),this}copy(y){const b=this.planes;for(let D=0;D<6;D++)b[D].copy(y.planes[D]);return this}setFromProjectionMatrix(y,b=Bo){const D=this.planes,Y=y.elements,_e=Y[0],Le=Y[1],qe=Y[2],it=Y[3],nt=Y[4],mt=Y[5],bt=Y[6],At=Y[7],wt=Y[8],Et=Y[9],Mt=Y[10],St=Y[11],Nt=Y[12],It=Y[13],Rt=Y[14],Yt=Y[15];if(D[0].setComponents(it-_e,At-nt,St-wt,Yt-Nt).normalize(),D[1].setComponents(it+_e,At+nt,St+wt,Yt+Nt).normalize(),D[2].setComponents(it+Le,At+mt,St+Et,Yt+It).normalize(),D[3].setComponents(it-Le,At-mt,St-Et,Yt-It).normalize(),D[4].setComponents(it-qe,At-bt,St-Mt,Yt-Rt).normalize(),b===Bo)D[5].setComponents(it+qe,At+bt,St+Mt,Yt+Rt).normalize();else{if(b!==jo)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+b);D[5].setComponents(qe,bt,Mt,Rt).normalize()}return this}intersectsObject(y){if(y.boundingSphere!==void 0)y.boundingSphere===null&&y.computeBoundingSphere(),$a.copy(y.boundingSphere).applyMatrix4(y.matrixWorld);else{const b=y.geometry;b.boundingSphere===null&&b.computeBoundingSphere(),$a.copy(b.boundingSphere).applyMatrix4(y.matrixWorld)}return this.intersectsSphere($a)}intersectsSprite(y){return $a.center.set(0,0,0),$a.radius=.7071067811865476,$a.applyMatrix4(y.matrixWorld),this.intersectsSphere($a)}intersectsSphere(y){const b=this.planes,D=y.center,Y=-y.radius;for(let _e=0;_e<6;_e++)if(b[_e].distanceToPoint(D)<Y)return!1;return!0}intersectsBox(y){const b=this.planes;for(let D=0;D<6;D++){const Y=b[D];if(ed.x=Y.normal.x>0?y.max.x:y.min.x,ed.y=Y.normal.y>0?y.max.y:y.min.y,ed.z=Y.normal.z>0?y.max.z:y.min.z,Y.distanceToPoint(ed)<0)return!1}return!0}containsPoint(y){const b=this.planes;for(let D=0;D<6;D++)if(b[D].distanceToPoint(y)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}function Sp(){let De=null,y=!1,b=null,D=null;function Y(_e,Le){b(_e,Le),D=De.requestAnimationFrame(Y)}return{start:function(){y!==!0&&b!==null&&(D=De.requestAnimationFrame(Y),y=!0)},stop:function(){De.cancelAnimationFrame(D),y=!1},setAnimationLoop:function(_e){b=_e},setContext:function(_e){De=_e}}}function ig(De,y){const b=y.isWebGL2,D=new WeakMap;return{get:function(Y){return Y.isInterleavedBufferAttribute&&(Y=Y.data),D.get(Y)},remove:function(Y){Y.isInterleavedBufferAttribute&&(Y=Y.data);const _e=D.get(Y);_e&&(De.deleteBuffer(_e.buffer),D.delete(Y))},update:function(Y,_e){if(Y.isGLBufferAttribute){const qe=D.get(Y);return void((!qe||qe.version<Y.version)&&D.set(Y,{buffer:Y.buffer,type:Y.type,bytesPerElement:Y.elementSize,version:Y.version}))}Y.isInterleavedBufferAttribute&&(Y=Y.data);const Le=D.get(Y);Le===void 0?D.set(Y,function(qe,it){const nt=qe.array,mt=qe.usage,bt=De.createBuffer();let At;if(De.bindBuffer(it,bt),De.bufferData(it,nt,mt),qe.onUploadCallback(),nt instanceof Float32Array)At=De.FLOAT;else if(nt instanceof Uint16Array)if(qe.isFloat16BufferAttribute){if(!b)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");At=De.HALF_FLOAT}else At=De.UNSIGNED_SHORT;else if(nt instanceof Int16Array)At=De.SHORT;else if(nt instanceof Uint32Array)At=De.UNSIGNED_INT;else if(nt instanceof Int32Array)At=De.INT;else if(nt instanceof Int8Array)At=De.BYTE;else if(nt instanceof Uint8Array)At=De.UNSIGNED_BYTE;else{if(!(nt instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+nt);At=De.UNSIGNED_BYTE}return{buffer:bt,type:At,bytesPerElement:nt.BYTES_PER_ELEMENT,version:qe.version}}(Y,_e)):Le.version<Y.version&&(function(qe,it,nt){const mt=it.array,bt=it.updateRange;De.bindBuffer(nt,qe),bt.count===-1?De.bufferSubData(nt,0,mt):(b?De.bufferSubData(nt,bt.offset*mt.BYTES_PER_ELEMENT,mt,bt.offset,bt.count):De.bufferSubData(nt,bt.offset*mt.BYTES_PER_ELEMENT,mt.subarray(bt.offset,bt.offset+bt.count)),bt.count=-1),it.onUploadCallback()}(Le.buffer,Y,_e),Le.version=Y.version)}}}class Yc extends dr{constructor(y=1,b=1,D=1,Y=1){super(),this.type="PlaneGeometry",this.parameters={width:y,height:b,widthSegments:D,heightSegments:Y};const _e=y/2,Le=b/2,qe=Math.floor(D),it=Math.floor(Y),nt=qe+1,mt=it+1,bt=y/qe,At=b/it,wt=[],Et=[],Mt=[],St=[];for(let Nt=0;Nt<mt;Nt++){const It=Nt*At-Le;for(let Rt=0;Rt<nt;Rt++){const Yt=Rt*bt-_e;Et.push(Yt,-It,0),Mt.push(0,0,1),St.push(Rt/qe),St.push(1-Nt/it)}}for(let Nt=0;Nt<it;Nt++)for(let It=0;It<qe;It++){const Rt=It+nt*Nt,Yt=It+nt*(Nt+1),Kt=It+1+nt*(Nt+1),Xt=It+1+nt*Nt;wt.push(Rt,Yt,Xt),wt.push(Yt,Kt,Xt)}this.setIndex(wt),this.setAttribute("position",new Cn(Et,3)),this.setAttribute("normal",new Cn(Mt,3)),this.setAttribute("uv",new Cn(St,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new Yc(y.width,y.height,y.widthSegments,y.heightSegments)}}const ar={alphahash_fragment:`#ifdef USE_ALPHAHASH
	if ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;
#endif`,alphahash_pars_fragment:`#ifdef USE_ALPHAHASH
	const float ALPHA_HASH_SCALE = 0.05;
	float hash2D( vec2 value ) {
		return fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );
	}
	float hash3D( vec3 value ) {
		return hash2D( vec2( hash2D( value.xy ), value.z ) );
	}
	float getAlphaHashThreshold( vec3 position ) {
		float maxDeriv = max(
			length( dFdx( position.xyz ) ),
			length( dFdy( position.xyz ) )
		);
		float pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );
		vec2 pixScales = vec2(
			exp2( floor( log2( pixScale ) ) ),
			exp2( ceil( log2( pixScale ) ) )
		);
		vec2 alpha = vec2(
			hash3D( floor( pixScales.x * position.xyz ) ),
			hash3D( floor( pixScales.y * position.xyz ) )
		);
		float lerpFactor = fract( log2( pixScale ) );
		float x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;
		float a = min( lerpFactor, 1.0 - lerpFactor );
		vec3 cases = vec3(
			x * x / ( 2.0 * a * ( 1.0 - a ) ),
			( x - 0.5 * a ) / ( 1.0 - a ),
			1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )
		);
		float threshold = ( x < ( 1.0 - a ) )
			? ( ( x < a ) ? cases.x : cases.y )
			: cases.z;
		return clamp( threshold , 1.0e-6, 1.0 );
	}
#endif`,alphamap_fragment:`#ifdef USE_ALPHAMAP
	#if defined(INVERSE_ALPHAMAP) && INVERSE_ALPHAMAP >= 1
	diffuseColor.a *= 1.0-texture2D( alphaMap, vAlphaMapUv ).g;
	#else
	diffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;
	#endif
#endif`,alphamap_pars_fragment:`#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,alphatest_fragment:`#ifdef USE_ALPHATEST
	if ( diffuseColor.a < alphaTest ) discard;
#endif`,alphatest_pars_fragment:`#ifdef USE_ALPHATEST
	uniform float alphaTest;
#endif`,aomap_fragment:`#ifdef USE_AOMAP
	float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;
	reflectedLight.indirectDiffuse *= ambientOcclusion;
	#if defined( USE_ENVMAP ) && defined( STANDARD )
		float dotNV = saturate( dot( geometryNormal, geometryViewDir ) );
		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );
	#endif
#endif`,aomap_pars_fragment:`#ifdef USE_AOMAP
	uniform sampler2D aoMap;
	uniform float aoMapIntensity;
#endif`,begin_vertex:`vec3 transformed = vec3( position );
#ifdef USE_ALPHAHASH
	vPosition = vec3( position );
#endif`,beginnormal_vertex:`vec3 objectNormal = vec3( normal );
#ifdef USE_TANGENT
	vec3 objectTangent = vec3( tangent.xyz );
#endif`,bsdfs:`float G_BlinnPhong_Implicit( ) {
	return 0.25;
}
float D_BlinnPhong( const in float shininess, const in float dotNH ) {
	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );
}
vec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( specularColor, 1.0, dotVH );
	float G = G_BlinnPhong_Implicit( );
	float D = D_BlinnPhong( shininess, dotNH );
	return F * ( G * D );
} // validated`,iridescence_fragment:`#ifdef USE_IRIDESCENCE
	const mat3 XYZ_TO_REC709 = mat3(
		 3.2404542, -0.9692660,  0.0556434,
		-1.5371385,  1.8760108, -0.2040259,
		-0.4985314,  0.0415560,  1.0572252
	);
	vec3 Fresnel0ToIor( vec3 fresnel0 ) {
		vec3 sqrtF0 = sqrt( fresnel0 );
		return ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );
	}
	vec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {
		return pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );
	}
	float IorToFresnel0( float transmittedIor, float incidentIor ) {
		return pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));
	}
	vec3 evalSensitivity( float OPD, vec3 shift ) {
		float phase = 2.0 * PI * OPD * 1.0e-9;
		vec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );
		vec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );
		vec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );
		vec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );
		xyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );
		xyz /= 1.0685e-7;
		vec3 rgb = XYZ_TO_REC709 * xyz;
		return rgb;
	}
	vec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {
		vec3 I;
		float iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );
		float sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );
		float cosTheta2Sq = 1.0 - sinTheta2Sq;
		if ( cosTheta2Sq < 0.0 ) {
			return vec3( 1.0 );
		}
		float cosTheta2 = sqrt( cosTheta2Sq );
		float R0 = IorToFresnel0( iridescenceIOR, outsideIOR );
		float R12 = F_Schlick( R0, 1.0, cosTheta1 );
		float T121 = 1.0 - R12;
		float phi12 = 0.0;
		if ( iridescenceIOR < outsideIOR ) phi12 = PI;
		float phi21 = PI - phi12;
		vec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );		vec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );
		vec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );
		vec3 phi23 = vec3( 0.0 );
		if ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;
		if ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;
		if ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;
		float OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;
		vec3 phi = vec3( phi21 ) + phi23;
		vec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );
		vec3 r123 = sqrt( R123 );
		vec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );
		vec3 C0 = R12 + Rs;
		I = C0;
		vec3 Cm = Rs - T121;
		for ( int m = 1; m <= 2; ++ m ) {
			Cm *= r123;
			vec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );
			I += Cm * Sm;
		}
		return max( I, vec3( 0.0 ) );
	}
#endif`,bumpmap_pars_fragment:`#ifdef USE_BUMPMAP
	uniform sampler2D bumpMap;
	uniform float bumpScale;
	vec2 dHdxy_fwd() {
		vec2 dSTdx = dFdx( vBumpMapUv );
		vec2 dSTdy = dFdy( vBumpMapUv );
		float Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;
		return vec2( dBx, dBy );
	}
	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {
		vec3 vSigmaX = dFdx( surf_pos.xyz );
		vec3 vSigmaY = dFdy( surf_pos.xyz );
		vec3 vN = surf_norm;
		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );
		float fDet = dot( vSigmaX, R1 ) * faceDirection;
		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );
	}
#endif`,clipping_planes_fragment:`#if NUM_CLIPPING_PLANES > 0
	vec4 plane;
	#pragma unroll_loop_start
	for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
		plane = clippingPlanes[ i ];
		if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;
	}
	#pragma unroll_loop_end
	#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
		bool clipped = true;
		#pragma unroll_loop_start
		for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;
		}
		#pragma unroll_loop_end
		if ( clipped ) discard;
	#endif
#endif`,clipping_planes_pars_fragment:`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
#endif`,clipping_planes_pars_vertex:`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
#endif`,clipping_planes_vertex:`#if NUM_CLIPPING_PLANES > 0
	vClipPosition = - mvPosition.xyz;
#endif`,color_fragment:`#if defined( USE_COLOR_ALPHA )
	diffuseColor *= vColor;
#elif defined( USE_COLOR )
	diffuseColor.rgb *= vColor;
#endif`,color_pars_fragment:`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR )
	varying vec3 vColor;
#endif`,color_pars_vertex:`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	varying vec3 vColor;
#endif`,color_vertex:`#if defined( USE_COLOR_ALPHA )
	vColor = vec4( 1.0 );
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	vColor = vec3( 1.0 );
#endif
#ifdef USE_COLOR
	vColor *= color;
#endif
#ifdef USE_INSTANCING_COLOR
	vColor.xyz *= instanceColor.xyz;
#endif`,common:`#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6
#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement( a ) ( 1.0 - saturate( a ) )
float pow2( const in float x ) { return x*x; }
vec3 pow2( const in vec3 x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }
float average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }
highp float rand( const in vec2 uv ) {
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
	return fract( sin( sn ) * c );
}
#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif
struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};
struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};
#ifdef USE_ALPHAHASH
	varying vec3 vPosition;
#endif
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
}
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
float luminance( const in vec3 rgb ) {
	const vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );
	return dot( weights, rgb );
}
bool isPerspectiveMatrix( mat4 m ) {
	return m[ 2 ][ 3 ] == - 1.0;
}
vec2 equirectUv( in vec3 dir ) {
	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;
	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;
	return vec2( u, v );
}
vec3 BRDF_Lambert( const in vec3 diffuseColor ) {
	return RECIPROCAL_PI * diffuseColor;
}
vec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
}
float F_Schlick( const in float f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
} // validated`,cube_uv_reflection_fragment:`#ifdef ENVMAP_TYPE_CUBE_UV
	#define cubeUV_minMipLevel 4.0
	#define cubeUV_minTileSize 16.0
	float getFace( vec3 direction ) {
		vec3 absDirection = abs( direction );
		float face = - 1.0;
		if ( absDirection.x > absDirection.z ) {
			if ( absDirection.x > absDirection.y )
				face = direction.x > 0.0 ? 0.0 : 3.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		} else {
			if ( absDirection.z > absDirection.y )
				face = direction.z > 0.0 ? 2.0 : 5.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		}
		return face;
	}
	vec2 getUV( vec3 direction, float face ) {
		vec2 uv;
		if ( face == 0.0 ) {
			uv = vec2( direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 1.0 ) {
			uv = vec2( - direction.x, - direction.z ) / abs( direction.y );
		} else if ( face == 2.0 ) {
			uv = vec2( - direction.x, direction.y ) / abs( direction.z );
		} else if ( face == 3.0 ) {
			uv = vec2( - direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 4.0 ) {
			uv = vec2( - direction.x, direction.z ) / abs( direction.y );
		} else {
			uv = vec2( direction.x, direction.y ) / abs( direction.z );
		}
		return 0.5 * ( uv + 1.0 );
	}
	vec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {
		float face = getFace( direction );
		float filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );
		mipInt = max( mipInt, cubeUV_minMipLevel );
		float faceSize = exp2( mipInt );
		highp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;
		if ( face > 2.0 ) {
			uv.y += faceSize;
			face -= 3.0;
		}
		uv.x += face * faceSize;
		uv.x += filterInt * 3.0 * cubeUV_minTileSize;
		uv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );
		uv.x *= CUBEUV_TEXEL_WIDTH;
		uv.y *= CUBEUV_TEXEL_HEIGHT;
		#ifdef texture2DGradEXT
			return texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;
		#else
			return texture2D( envMap, uv ).rgb;
		#endif
	}
	#define cubeUV_r0 1.0
	#define cubeUV_v0 0.339
	#define cubeUV_m0 - 2.0
	#define cubeUV_r1 0.8
	#define cubeUV_v1 0.276
	#define cubeUV_m1 - 1.0
	#define cubeUV_r4 0.4
	#define cubeUV_v4 0.046
	#define cubeUV_m4 2.0
	#define cubeUV_r5 0.305
	#define cubeUV_v5 0.016
	#define cubeUV_m5 3.0
	#define cubeUV_r6 0.21
	#define cubeUV_v6 0.0038
	#define cubeUV_m6 4.0
	float roughnessToMip( float roughness ) {
		float mip = 0.0;
		if ( roughness >= cubeUV_r1 ) {
			mip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;
		} else if ( roughness >= cubeUV_r4 ) {
			mip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;
		} else if ( roughness >= cubeUV_r5 ) {
			mip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;
		} else if ( roughness >= cubeUV_r6 ) {
			mip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;
		} else {
			mip = - 2.0 * log2( 1.16 * roughness );		}
		return mip;
	}
	vec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {
		float mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );
		float mipF = fract( mip );
		float mipInt = floor( mip );
		vec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );
		if ( mipF == 0.0 ) {
			return vec4( color0, 1.0 );
		} else {
			vec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );
			return vec4( mix( color0, color1, mipF ), 1.0 );
		}
	}
#endif`,defaultnormal_vertex:`vec3 transformedNormal = objectNormal;
#ifdef USE_INSTANCING
	mat3 m = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );
	transformedNormal = m * transformedNormal;
#endif
transformedNormal = normalMatrix * transformedNormal;
#ifdef FLIP_SIDED
	transformedNormal = - transformedNormal;
#endif
#ifdef USE_TANGENT
	vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#ifdef FLIP_SIDED
		transformedTangent = - transformedTangent;
	#endif
#endif`,displacementmap_pars_vertex:`#ifdef USE_DISPLACEMENTMAP
	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;
#endif`,displacementmap_vertex:`#ifdef USE_DISPLACEMENTMAP
	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );
#endif`,emissivemap_fragment:`#ifdef USE_EMISSIVEMAP
	vec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );
	totalEmissiveRadiance *= emissiveColor.rgb;
#endif`,emissivemap_pars_fragment:`#ifdef USE_EMISSIVEMAP
	uniform sampler2D emissiveMap;
#endif`,colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:`
const mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(
	vec3( 0.8224621, 0.177538, 0.0 ),
	vec3( 0.0331941, 0.9668058, 0.0 ),
	vec3( 0.0170827, 0.0723974, 0.9105199 )
);
const mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(
	vec3( 1.2249401, - 0.2249404, 0.0 ),
	vec3( - 0.0420569, 1.0420571, 0.0 ),
	vec3( - 0.0196376, - 0.0786361, 1.0982735 )
);
vec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {
	return vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );
}
vec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {
	return vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );
}
vec4 LinearTransferOETF( in vec4 value ) {
	return value;
}
vec4 sRGBTransferOETF( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}
vec4 LinearToLinear( in vec4 value ) {
	return value;
}
vec4 LinearTosRGB( in vec4 value ) {
	return sRGBTransferOETF( value );
}
vec4 sRGBToLinear( in vec4 value ) {
	return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
}
vec4 RGBM16ToLinear( in vec4 value ) {
	return vec4( value.rgb * value.a * 16.0, 1.0 );
}
vec4 LinearToRGBM16( in vec4 value ) {
	float maxRGB = max( value.r, max( value.g, value.b ) );
	float M = clamp( maxRGB / 16.0, 0.0, 1.0 );
	M = ceil( M * 255.0 ) / 255.0;
	return vec4( value.rgb / ( M * 16.0 ), M );
}`,envmap_fragment:`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vec3 cameraToFrag;
		if ( isOrthographic ) {
			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToFrag = normalize( vWorldPosition - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( cameraToFrag, worldNormal );
		#else
			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );
		#endif
	#else
		vec3 reflectVec = vReflect;
	#endif
	reflectVec = transformDirection(reflectVec, rotationMatrix(vec3(0,1,0), envMapRotation));
	#ifdef ENVMAP_TYPE_CUBE
		vec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );
	#else
		vec4 envColor = vec4( 0.0 );
	#endif
	#ifdef ENVMAP_BLENDING_MULTIPLY
		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_MIX )
		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_ADD )
		outgoingLight += envColor.xyz * specularStrength * reflectivity;
	#endif
#endif`,envmap_common_pars_fragment:`#ifdef USE_ENVMAP
	mat4 rotationMatrix(vec3 axis, float angle) {
		axis = normalize(axis);
		float s = sin(angle);
		float c = cos(angle);
		float oc = 1.0 - c;
		return mat4(oc * axis.x * axis.x + c,           oc * axis.x * axis.y - axis.z * s,  oc * axis.z * axis.x + axis.y * s,  0.0,
					oc * axis.x * axis.y + axis.z * s,  oc * axis.y * axis.y + c,           oc * axis.y * axis.z - axis.x * s,  0.0,
					oc * axis.z * axis.x - axis.y * s,  oc * axis.y * axis.z + axis.x * s,  oc * axis.z * axis.z + c,           0.0,
					0.0,                                0.0,                                0.0,                                1.0);
	}
	uniform float envMapIntensity;
	uniform float flipEnvMap;
	uniform float envMapRotation;
	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
#endif`,envmap_pars_fragment:`#ifdef USE_ENVMAP
	uniform float reflectivity;
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
#endif`,envmap_pars_vertex:`#ifdef USE_ENVMAP
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;
	#else
		varying vec3 vReflect;
		uniform float refractionRatio;
	#endif
#endif`,envmap_physical_pars_fragment:`#ifdef USE_ENVMAP
	vec3 getIBLIrradiance( const in vec3 normal ) {
		#ifdef ENVMAP_TYPE_CUBE_UV
		#if defined( FIX_ENV_DIRECTION )
			vec3 worldNormal = normal;
		#else
			vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#endif
			worldNormal = transformDirection(worldNormal, rotationMatrix(vec3(0,1,0), envMapRotation));
			vec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );
			return PI * envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	vec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {
		#ifdef ENVMAP_TYPE_CUBE_UV
			vec3 reflectVec = reflect( - viewDir, normal );
			reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );
			#if !defined( FIX_ENV_DIRECTION )
			reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
			#endif
			reflectVec = transformDirection(reflectVec, rotationMatrix(vec3(0,1,0), envMapRotation));
			vec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );
			return envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	#ifdef USE_ANISOTROPY
		vec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {
			#ifdef ENVMAP_TYPE_CUBE_UV
				vec3 bentNormal = cross( bitangent, viewDir );
				bentNormal = normalize( cross( bentNormal, bitangent ) );
				bentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );
				return getIBLRadiance( viewDir, bentNormal, roughness );
			#else
				return vec3( 0.0 );
			#endif
		}
	#endif
#endif`,envmap_vertex:`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vWorldPosition = worldPosition.xyz;
	#else
		vec3 cameraToVertex;
		if ( isOrthographic ) {
			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vReflect = reflect( cameraToVertex, worldNormal );
		#else
			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );
		#endif
	#endif
#endif`,fog_vertex:`#ifdef USE_FOG
	vFogDepth = - mvPosition.z;
#endif`,fog_pars_vertex:`#ifdef USE_FOG
	varying float vFogDepth;
#endif`,fog_fragment:`#ifdef USE_FOG
	#ifdef FOG_EXP2
		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );
	#else
		float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );
	#endif
	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`,fog_pars_fragment:`#ifdef USE_FOG
	uniform vec3 fogColor;
	varying float vFogDepth;
	#ifdef FOG_EXP2
		uniform float fogDensity;
	#else
		uniform float fogNear;
		uniform float fogFar;
	#endif
#endif`,gradientmap_pars_fragment:`#ifdef USE_GRADIENTMAP
	uniform sampler2D gradientMap;
#endif
vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );
	#ifdef USE_GRADIENTMAP
		return vec3( texture2D( gradientMap, coord ).r );
	#else
		vec2 fw = fwidth( coord ) * 0.5;
		return mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );
	#endif
}`,lightmap_fragment:`#ifdef USE_LIGHTMAP
	vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
	vec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;
	reflectedLight.indirectDiffuse += lightMapIrradiance;
#endif`,lightmap_pars_fragment:`#ifdef USE_LIGHTMAP
	uniform sampler2D lightMap;
	uniform float lightMapIntensity;
#endif`,lights_lambert_fragment:`LambertMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularStrength = specularStrength;`,lights_lambert_pars_fragment:`varying vec3 vViewPosition;
struct LambertMaterial {
	vec3 diffuseColor;
	float specularStrength;
};
void RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Lambert
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Lambert`,lights_pars_begin:`uniform bool receiveShadow;
uniform vec3 ambientLightColor;
#if defined( USE_LIGHT_PROBES )
	uniform vec3 lightProbe[ 9 ];
#endif
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {
	float x = normal.x, y = normal.y, z = normal.z;
	vec3 result = shCoefficients[ 0 ] * 0.886227;
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );
	return result;
}
vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {
	vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );
	return irradiance;
}
vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {
	vec3 irradiance = ambientLightColor;
	return irradiance;
}
float getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
	#if defined ( LEGACY_LIGHTS )
		if ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {
			return pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );
		}
		return 1.0;
	#else
		float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
		if ( cutoffDistance > 0.0 ) {
			distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
		}
		return distanceFalloff;
	#endif
}
float getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {
	return smoothstep( coneCosine, penumbraCosine, angleCosine );
}
#if NUM_DIR_LIGHTS > 0
	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};
	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];
	void getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {
		light.color = directionalLight.color;
		light.direction = directionalLight.direction;
		light.visible = true;
	}
#endif
#if NUM_POINT_LIGHTS > 0
	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};
	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];
	void getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {
		vec3 lVector = pointLight.position - geometryPosition;
		light.direction = normalize( lVector );
		float lightDistance = length( lVector );
		light.color = pointLight.color;
		light.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );
		light.visible = ( light.color != vec3( 0.0 ) );
	}
#endif
#if NUM_SPOT_LIGHTS > 0
	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};
	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];
	void getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {
		vec3 lVector = spotLight.position - geometryPosition;
		light.direction = normalize( lVector );
		float angleCos = dot( light.direction, spotLight.direction );
		float spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );
		if ( spotAttenuation > 0.0 ) {
			float lightDistance = length( lVector );
			light.color = spotLight.color * spotAttenuation;
			light.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );
			light.visible = ( light.color != vec3( 0.0 ) );
		} else {
			light.color = vec3( 0.0 );
			light.visible = false;
		}
	}
#endif
#if NUM_RECT_AREA_LIGHTS > 0
	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};
	uniform sampler2D ltc_1;	uniform sampler2D ltc_2;
	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];
#endif
#if NUM_HEMI_LIGHTS > 0
	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};
	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];
	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {
		float dotNL = dot( normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;
		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );
		return irradiance;
	}
#endif`,lights_toon_fragment:`ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;`,lights_toon_pars_fragment:`varying vec3 vViewPosition;
struct ToonMaterial {
	vec3 diffuseColor;
};
void RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon`,lights_phong_fragment:`BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;`,lights_phong_pars_fragment:`varying vec3 vViewPosition;
struct BlinnPhongMaterial {
	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;
};
void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
	reflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;
}
void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong`,lights_physical_fragment:`PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );
vec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );
material.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;
material.roughness = min( material.roughness, 1.0 );
#ifdef IOR
	material.ior = ior;
	#ifdef USE_SPECULAR
		float specularIntensityFactor = specularIntensity;
		vec3 specularColorFactor = specularColor;
		#ifdef USE_SPECULAR_COLORMAP
			specularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;
		#endif
		#ifdef USE_SPECULAR_INTENSITYMAP
			specularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;
		#endif
		material.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );
	#else
		float specularIntensityFactor = 1.0;
		vec3 specularColorFactor = vec3( 1.0 );
		material.specularF90 = 1.0;
	#endif
	material.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );
#else
	material.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );
	material.specularF90 = 1.0;
#endif
#ifdef USE_CLEARCOAT
	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	material.clearcoatF0 = vec3( 0.04 );
	material.clearcoatF90 = 1.0;
	#ifdef USE_CLEARCOATMAP
		material.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;
	#endif
	#ifdef USE_CLEARCOAT_ROUGHNESSMAP
		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;
	#endif
	material.clearcoat = saturate( material.clearcoat );	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );
#endif
#ifdef USE_IRIDESCENCE
	material.iridescence = iridescence;
	material.iridescenceIOR = iridescenceIOR;
	#ifdef USE_IRIDESCENCEMAP
		material.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;
	#endif
	#ifdef USE_IRIDESCENCE_THICKNESSMAP
		material.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;
	#else
		material.iridescenceThickness = iridescenceThicknessMaximum;
	#endif
#endif
#ifdef USE_SHEEN
	material.sheenColor = sheenColor;
	#ifdef USE_SHEEN_COLORMAP
		material.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;
	#endif
	material.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );
	#ifdef USE_SHEEN_ROUGHNESSMAP
		material.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;
	#endif
#endif
#ifdef USE_ANISOTROPY
	#ifdef USE_ANISOTROPYMAP
		mat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );
		vec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;
		vec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;
	#else
		vec2 anisotropyV = anisotropyVector;
	#endif
	material.anisotropy = length( anisotropyV );
	anisotropyV /= material.anisotropy;
	material.anisotropy = saturate( material.anisotropy );
	material.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );
	material.anisotropyT = tbn[ 0 ] * anisotropyV.x - tbn[ 1 ] * anisotropyV.y;
	material.anisotropyB = tbn[ 1 ] * anisotropyV.x + tbn[ 0 ] * anisotropyV.y;
#endif`,lights_physical_pars_fragment:`struct PhysicalMaterial {
	vec3 diffuseColor;
	float roughness;
	vec3 specularColor;
	float specularF90;
	#ifdef USE_CLEARCOAT
		float clearcoat;
		float clearcoatRoughness;
		vec3 clearcoatF0;
		float clearcoatF90;
	#endif
	#ifdef USE_IRIDESCENCE
		float iridescence;
		float iridescenceIOR;
		float iridescenceThickness;
		vec3 iridescenceFresnel;
		vec3 iridescenceF0;
	#endif
	#ifdef USE_SHEEN
		vec3 sheenColor;
		float sheenRoughness;
	#endif
	#ifdef IOR
		float ior;
	#endif
	#ifdef USE_TRANSMISSION
		float transmission;
		float transmissionAlpha;
		float thickness;
		float attenuationDistance;
		vec3 attenuationColor;
	#endif
	#ifdef USE_ANISOTROPY
		float anisotropy;
		float alphaT;
		vec3 anisotropyT;
		vec3 anisotropyB;
	#endif
};
vec3 clearcoatSpecular = vec3( 0.0 );
vec3 sheenSpecular = vec3( 0.0 );
vec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {
    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );
    float x2 = x * x;
    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );
    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );
}
float V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	return 0.5 / max( gv + gl, EPSILON );
}
float D_GGX( const in float alpha, const in float dotNH ) {
	float a2 = pow2( alpha );
	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;
	return RECIPROCAL_PI * a2 / pow2( denom );
}
#if defined( USE_ANISOTROPY ) || defined( USE_ANISOTROPY_BRDF )
	float V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {
		float gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );
		float gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );
		float v = 0.5 / ( gv + gl );
		return saturate(v);
	}
	float D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {
		float a2 = alphaT * alphaB;
		highp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );
		highp float v2 = dot( v, v );
		float w2 = a2 / v2;
		return RECIPROCAL_PI * a2 * pow2 ( w2 );
	}
#endif
#ifdef USE_CLEARCOAT
	vec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {
		vec3 f0 = material.clearcoatF0;
		float f90 = material.clearcoatF90;
		float roughness = material.clearcoatRoughness;
		float alpha = pow2( roughness );
		vec3 halfDir = normalize( lightDir + viewDir );
		float dotNL = saturate( dot( normal, lightDir ) );
		float dotNV = saturate( dot( normal, viewDir ) );
		float dotNH = saturate( dot( normal, halfDir ) );
		float dotVH = saturate( dot( viewDir, halfDir ) );
		vec3 F = F_Schlick( f0, f90, dotVH );
		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
		float D = D_GGX( alpha, dotNH );
		return F * ( V * D );
	}
#endif
vec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {
	vec3 f0 = material.specularColor;
	float f90 = material.specularF90;
	float roughness = material.roughness;
	float alpha = pow2( roughness );
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( f0, f90, dotVH );
	#ifdef USE_IRIDESCENCE
		F = mix( F, material.iridescenceFresnel, material.iridescence );
	#endif
	#ifdef USE_ANISOTROPY
		float dotTL = dot( material.anisotropyT, lightDir );
		float dotTV = dot( material.anisotropyT, viewDir );
		float dotTH = dot( material.anisotropyT, halfDir );
		float dotBL = dot( material.anisotropyB, lightDir );
		float dotBV = dot( material.anisotropyB, viewDir );
		float dotBH = dot( material.anisotropyB, halfDir );
		float V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );
		float D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );
	#else
		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
		float D = D_GGX( alpha, dotNH );
	#endif
	return F * ( V * D );
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );
	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return vec3( result );
}
#if defined( USE_SHEEN )
float D_Charlie( float roughness, float dotNH ) {
	float alpha = pow2( roughness );
	float invAlpha = 1.0 / alpha;
	float cos2h = dotNH * dotNH;
	float sin2h = max( 1.0 - cos2h, 0.0078125 );
	return ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );
}
float V_Neubelt( float dotNV, float dotNL ) {
	return saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );
}
vec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float D = D_Charlie( sheenRoughness, dotNH );
	float V = V_Neubelt( dotNV, dotNL );
	return sheenColor * ( D * V );
}
#endif
float IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	float r2 = roughness * roughness;
	float a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;
	float b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;
	float DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );
	return saturate( DG * RECIPROCAL_PI );
}
vec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );
	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );
	vec4 r = roughness * c0 + c1;
	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;
	vec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;
	return fab;
}
vec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	return specularColor * fab.x + specularF90 * fab.y;
}
#ifdef USE_IRIDESCENCE
void computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#else
void computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#endif
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	#ifdef USE_IRIDESCENCE
		vec3 Fr = mix( specularColor, iridescenceF0, iridescence );
	#else
		vec3 Fr = specularColor;
	#endif
	vec3 FssEss = Fr * fab.x + specularF90 * fab.y;
	float Ess = fab.x + fab.y;
	float Ems = 1.0 - Ess;
	vec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );
	singleScatter += FssEss;
	multiScatter += Fms * Ems;
}
#if NUM_RECT_AREA_LIGHTS > 0
	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
		vec3 normal = geometryNormal;
		vec3 viewDir = geometryViewDir;
		vec3 position = geometryPosition;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.roughness;
		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight;		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;
		vec2 uv = LTC_Uv( normal, viewDir, roughness );
		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );
		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );
		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );
		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );
	}
#endif
void RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifdef USE_CLEARCOAT
		float dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );
		vec3 ccIrradiance = dotNLcc * directLight.color;
		clearcoatSpecular += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );
	#endif
	#ifdef USE_SHEEN
		sheenSpecular += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );
	#endif
	reflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
	#ifdef USE_CLEARCOAT
		clearcoatSpecular += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );
	#endif
	#ifdef USE_SHEEN
		sheenSpecular += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );
	#endif
	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
	#ifdef USE_IRIDESCENCE
		computeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );
	#else
		computeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );
	#endif
	vec3 totalScattering = singleScattering + multiScattering;
	vec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );
	reflectedLight.indirectSpecular += radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;
	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;
}
#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {
	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );
}`,lights_fragment_begin:`
vec3 geometryPosition = - vViewPosition;
vec3 geometryNormal = normal;
vec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );
vec3 geometryClearcoatNormal;
#ifdef USE_CLEARCOAT
	geometryClearcoatNormal = clearcoatNormal;
#endif
#ifdef USE_IRIDESCENCE
	float dotNVi = saturate( dot( normal, geometryViewDir ) );
	if ( material.iridescenceThickness == 0.0 ) {
		material.iridescence = 0.0;
	} else {
		material.iridescence = saturate( material.iridescence );
	}
	if ( material.iridescence > 0.0 ) {
		material.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );
		material.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );
	}
#endif
IncidentLight directLight;
#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )
	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		pointLight = pointLights[ i ];
		getPointLightInfo( pointLight, geometryPosition, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )
	SpotLight spotLight;
	vec4 spotColor;
	vec3 spotLightCoord;
	bool inSpotLightMap;
	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		spotLight = spotLights[ i ];
		getSpotLightInfo( spotLight, geometryPosition, directLight );
		#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX
		#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS
		#else
		#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#endif
		#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )
			spotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;
			inSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );
			spotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );
			directLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;
		#endif
		#undef SPOT_LIGHT_MAP_INDEX
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		directionalLight = directionalLights[ i ];
		getDirectionalLightInfo( directionalLight, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )
	RectAreaLight rectAreaLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {
		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if defined( RE_IndirectDiffuse )
	vec3 iblIrradiance = vec3( 0.0 );
	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );
	#if defined( USE_LIGHT_PROBES )
		irradiance += getLightProbeIrradiance( lightProbe, geometryNormal );
	#endif
	#if ( NUM_HEMI_LIGHTS > 0 )
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );
		}
		#pragma unroll_loop_end
	#endif
#endif
#if defined( RE_IndirectSpecular )
	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );
#endif`,lights_fragment_maps:`#if defined( RE_IndirectDiffuse )
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		vec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;
		irradiance += lightMapIrradiance;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )
		iblIrradiance += getIBLIrradiance( geometryNormal );
	#endif
#endif
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
	#ifdef USE_ANISOTROPY
		radiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );
	#else
		radiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );
	#endif
	#ifdef USE_CLEARCOAT
		clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );
	#endif
#endif`,lights_fragment_end:`#if defined( RE_IndirectDiffuse )
	RE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
#endif
#if defined( RE_IndirectSpecular )
	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
#endif`,logdepthbuf_fragment:`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	gl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;
#endif`,logdepthbuf_pars_fragment:`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,logdepthbuf_pars_vertex:`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		varying float vFragDepth;
		varying float vIsPerspective;
	#else
		uniform float logDepthBufFC;
	#endif
#endif`,logdepthbuf_vertex:`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		vFragDepth = 1.0 + gl_Position.w;
		vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );
	#else
		if ( isPerspectiveMatrix( projectionMatrix ) ) {
			gl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;
			gl_Position.z *= gl_Position.w;
		}
	#endif
#endif`,map_fragment:`#ifdef USE_MAP
	vec4 sampledDiffuseColor = texture2D( map, vMapUv );
	#ifdef DECODE_VIDEO_TEXTURE
		sampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );
	
	#endif
	diffuseColor *= sampledDiffuseColor;
#endif`,map_pars_fragment:`#ifdef USE_MAP
	uniform sampler2D map;
#endif`,map_particle_fragment:`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	#if defined( USE_POINTS_UV )
		vec2 uv = vUv;
	#else
		vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;
	#endif
#endif
#ifdef USE_MAP
	diffuseColor *= texture2D( map, uv );
#endif
#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, uv ).g;
#endif`,map_particle_pars_fragment:`#if defined( USE_POINTS_UV )
	varying vec2 vUv;
#else
	#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
		uniform mat3 uvTransform;
	#endif
#endif
#ifdef USE_MAP
	uniform sampler2D map;
#endif
#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,metalnessmap_fragment:`float metalnessFactor = metalness;
#ifdef USE_METALNESSMAP
	vec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );
	metalnessFactor *= texelMetalness.b;
#endif`,metalnessmap_pars_fragment:`#ifdef USE_METALNESSMAP
	uniform sampler2D metalnessMap;
#endif`,morphcolor_vertex:`#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )
	vColor *= morphTargetBaseInfluence;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		#if defined( USE_COLOR_ALPHA )
			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];
		#elif defined( USE_COLOR )
			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];
		#endif
	}
#endif`,morphnormal_vertex:`#ifdef USE_MORPHNORMALS
	objectNormal *= morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
			if ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];
		}
	#else
		objectNormal += morphNormal0 * morphTargetInfluences[ 0 ];
		objectNormal += morphNormal1 * morphTargetInfluences[ 1 ];
		objectNormal += morphNormal2 * morphTargetInfluences[ 2 ];
		objectNormal += morphNormal3 * morphTargetInfluences[ 3 ];
	#endif
#endif`,morphtarget_pars_vertex:`#ifdef USE_MORPHTARGETS
	uniform float morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		uniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];
		uniform sampler2DArray morphTargetsTexture;
		uniform ivec2 morphTargetsTextureSize;
		vec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {
			int texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;
			int y = texelIndex / morphTargetsTextureSize.x;
			int x = texelIndex - y * morphTargetsTextureSize.x;
			ivec3 morphUV = ivec3( x, y, morphTargetIndex );
			return texelFetch( morphTargetsTexture, morphUV, 0 );
		}
	#else
		#ifndef USE_MORPHNORMALS
			uniform float morphTargetInfluences[ 8 ];
		#else
			uniform float morphTargetInfluences[ 4 ];
		#endif
	#endif
#endif`,morphtarget_vertex:`#ifdef USE_MORPHTARGETS
	transformed *= morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
			if ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];
		}
	#else
		transformed += morphTarget0 * morphTargetInfluences[ 0 ];
		transformed += morphTarget1 * morphTargetInfluences[ 1 ];
		transformed += morphTarget2 * morphTargetInfluences[ 2 ];
		transformed += morphTarget3 * morphTargetInfluences[ 3 ];
		#ifndef USE_MORPHNORMALS
			transformed += morphTarget4 * morphTargetInfluences[ 4 ];
			transformed += morphTarget5 * morphTargetInfluences[ 5 ];
			transformed += morphTarget6 * morphTargetInfluences[ 6 ];
			transformed += morphTarget7 * morphTargetInfluences[ 7 ];
		#endif
	#endif
#endif`,normal_fragment_begin:`float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;
#ifdef FLAT_SHADED
	vec3 fdx = dFdx( vViewPosition );
	vec3 fdy = dFdy( vViewPosition );
	vec3 normal = normalize( cross( fdx, fdy ) );
#else
	vec3 normal = normalize( vNormal );
	#ifdef DOUBLE_SIDED
		normal *= faceDirection;
	#endif
#endif
#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )
	#ifdef USE_TANGENT
		mat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );
	#else
		mat3 tbn = getTangentFrame( - vViewPosition, normal,
		#if defined( USE_NORMALMAP )
			vNormalMapUv
		#elif defined( USE_CLEARCOAT_NORMALMAP )
			vClearcoatNormalMapUv
		#else
			vUv
		#endif
		);
	#endif
	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )
		tbn[0] *= faceDirection;
		tbn[1] *= faceDirection;
	#endif
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	#ifdef USE_TANGENT
		mat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );
	#else
		mat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );
	#endif
	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )
		tbn2[0] *= faceDirection;
		tbn2[1] *= faceDirection;
	#endif
#endif
vec3 nonPerturbedNormal = normal;`,normal_fragment_maps:`#ifdef USE_NORMALMAP_OBJECTSPACE
	normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	#ifdef FLIP_SIDED
		normal = - normal;
	#endif
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	normal = normalize( normalMatrix * normal );
#elif defined( USE_NORMALMAP_TANGENTSPACE )
	vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;
	normal = normalize( tbn * mapN );
#elif defined( USE_BUMPMAP )
	normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );
#endif`,normal_pars_fragment:`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,normal_pars_vertex:`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,normal_vertex:`#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif`,normalmap_pars_fragment:`#ifdef USE_NORMALMAP
	uniform sampler2D normalMap;
	uniform vec2 normalScale;
#endif
#ifdef USE_NORMALMAP_OBJECTSPACE
	uniform mat3 normalMatrix;
#endif
#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )
	mat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {
		vec3 q0 = dFdx( eye_pos.xyz );
		vec3 q1 = dFdy( eye_pos.xyz );
		vec2 st0 = dFdx( uv.st );
		vec2 st1 = dFdy( uv.st );
		vec3 N = surf_norm;
		vec3 q1perp = cross( q1, N );
		vec3 q0perp = cross( N, q0 );
		vec3 T = q1perp * st0.x + q0perp * st1.x;
		vec3 B = q1perp * st0.y + q0perp * st1.y;
		float det = max( dot( T, T ), dot( B, B ) );
		float scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );
		return mat3( T * scale, B * scale, N );
	}
#endif`,clearcoat_normal_fragment_begin:`#ifdef USE_CLEARCOAT
	vec3 clearcoatNormal = nonPerturbedNormal;
#endif`,clearcoat_normal_fragment_maps:`#ifdef USE_CLEARCOAT_NORMALMAP
	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;
	clearcoatNormal = normalize( tbn2 * clearcoatMapN );
#endif`,clearcoat_pars_fragment:`#ifdef USE_CLEARCOATMAP
	uniform sampler2D clearcoatMap;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform sampler2D clearcoatRoughnessMap;
#endif`,iridescence_pars_fragment:`#ifdef USE_IRIDESCENCEMAP
	uniform sampler2D iridescenceMap;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	uniform sampler2D iridescenceThicknessMap;
#endif`,opaque_fragment:`#ifdef OPAQUE
diffuseColor.a = 1.0;
#endif
#ifdef USE_TRANSMISSION
diffuseColor.a *= material.transmissionAlpha;
diffuseColor.a = min(max(diffuseColor.a, 0.), 1.);
#endif
gl_FragColor = vec4( outgoingLight, diffuseColor.a );`,packing:`vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}
vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}
const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;
const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );
const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );
const float ShiftRight8 = 1. / 256.;
vec4 packDepthToRGBA( const in float v ) {
	vec4 r = vec4( fract( v * PackFactors ), v );
	r.yzw -= r.xyz * ShiftRight8;	return r * PackUpscale;
}
float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors );
}
vec2 packDepthToRG( in highp float v ) {
	return packDepthToRGBA( v ).yx;
}
float unpackRGToDepth( const in highp vec2 v ) {
	return unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );
}
vec4 pack2HalfToRGBA( vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );
}
vec2 unpackRGBATo2Half( vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}
float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	return ( viewZ + near ) / ( near - far );
}
float orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {
	return depth * ( near - far ) - near;
}
float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	return ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );
}
float perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {
	return ( near * far ) / ( ( far - near ) * depth - far );
}`,premultiplied_alpha_fragment:`#ifdef PREMULTIPLIED_ALPHA
	gl_FragColor.rgb *= gl_FragColor.a;
#endif`,project_vertex:`vec4 mvPosition = vec4( transformed, 1.0 );
#ifdef USE_INSTANCING
	mvPosition = instanceMatrix * mvPosition;
#endif
mvPosition = modelViewMatrix * mvPosition;
gl_Position = projectionMatrix * mvPosition;`,dithering_fragment:`#ifdef DITHERING
	gl_FragColor.rgb = dithering( gl_FragColor.rgb );
#endif`,dithering_pars_fragment:`#ifdef DITHERING
	vec3 dithering( vec3 color ) {
		float grid_position = rand( gl_FragCoord.xy );
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );
		return color + dither_shift_RGB;
	}
#endif`,roughnessmap_fragment:`float roughnessFactor = roughness;
#ifdef USE_ROUGHNESSMAP
	vec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );
	roughnessFactor *= texelRoughness.g;
#endif`,roughnessmap_pars_fragment:`#ifdef USE_ROUGHNESSMAP
	uniform sampler2D roughnessMap;
#endif`,shadowmap_pars_fragment:`#if NUM_SPOT_LIGHT_COORDS > 0
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];
#endif
#if NUM_SPOT_LIGHT_MAPS > 0
	uniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];
#endif
#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {
		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );
	}
	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {
		return unpackRGBATo2Half( texture2D( shadow, uv ) );
	}
	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){
		float occlusion = 1.0;
		vec2 distribution = texture2DDistribution( shadow, uv );
		float hard_shadow = step( compare , distribution.x );
		if (hard_shadow != 1.0 ) {
			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance );			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );
		}
		return occlusion;
	}
	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
		float shadow = 1.0;
		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;
		bool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;
		bool frustumTest = inFrustum && shadowCoord.z <= 1.0;
		if ( frustumTest ) {
		#if defined( SHADOWMAP_TYPE_PCF )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;
			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );
		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;
			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;
			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
						  f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
						  f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );
		#elif defined( SHADOWMAP_TYPE_VSM )
			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );
		#else
			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );
		#endif
		}
		return shadow;
	}
	vec2 cubeToUV( vec3 v, float texelSizeY ) {
		vec3 absV = abs( v );
		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );
		vec2 planar = v.xy;
		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;
		if ( absV.z >= almostOne ) {
			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;
		} else if ( absV.x >= almostOne ) {
			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;
		} else if ( absV.y >= almostOne ) {
			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;
		}
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );
	}
	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );
		vec3 lightToPosition = shadowCoord.xyz;
		float dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );		dp += shadowBias;
		vec3 bd3D = normalize( lightToPosition );
		#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )
			vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;
			return (
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
			) * ( 1.0 / 9.0 );
		#else
			return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );
		#endif
	}
#endif`,shadowmap_pars_vertex:`#if NUM_SPOT_LIGHT_COORDS > 0
	uniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];
#endif
#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
#endif`,shadowmap_vertex:`#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )
	vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
	vec4 shadowWorldPosition;
#endif
#if defined( USE_SHADOWMAP )
	#if NUM_DIR_LIGHT_SHADOWS > 0
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
			vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;
		}
		#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
			vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;
		}
		#pragma unroll_loop_end
	#endif
#endif
#if NUM_SPOT_LIGHT_COORDS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {
		shadowWorldPosition = worldPosition;
		#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
			shadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;
		#endif
		vSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
#endif`,shadowmask_pars_fragment:`float getShadowMask() {
	float shadow = 1.0;
	#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#endif
	return shadow;
}`,skinbase_vertex:`#ifdef USE_SKINNING
	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );
#endif`,skinning_pars_vertex:`#ifdef USE_SKINNING
	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;
	uniform highp sampler2D boneTexture;
	uniform int boneTextureSize;
	mat4 getBoneMatrix( const in float i ) {
		float j = i * 4.0;
		float x = mod( j, float( boneTextureSize ) );
		float y = floor( j / float( boneTextureSize ) );
		float dx = 1.0 / float( boneTextureSize );
		float dy = 1.0 / float( boneTextureSize );
		y = dy * ( y + 0.5 );
		vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );
		vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );
		vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );
		vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );
		mat4 bone = mat4( v1, v2, v3, v4 );
		return bone;
	}
#endif`,skinning_vertex:`#ifdef USE_SKINNING
	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );
	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;
	transformed = ( bindMatrixInverse * skinned ).xyz;
#endif`,skinnormal_vertex:`#ifdef USE_SKINNING
	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;
	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;
	#ifdef USE_TANGENT
		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#endif
#endif`,specularmap_fragment:`float specularStrength;
#ifdef USE_SPECULARMAP
	vec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );
	specularStrength = texelSpecular.r;
#else
	specularStrength = 1.0;
#endif`,specularmap_pars_fragment:`#ifdef USE_SPECULARMAP
	uniform sampler2D specularMap;
#endif`,tonemapping_fragment:`#if defined( TONE_MAPPING )
	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );
#endif`,tonemapping_pars_fragment:`#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
uniform float toneMappingExposure;
vec3 LinearToneMapping( vec3 color ) {
	return saturate( toneMappingExposure * color );
}
vec3 ReinhardToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );
}
vec3 OptimizedCineonToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );
}
vec3 RRTAndODTFit( vec3 v ) {
	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;
}
vec3 ACESFilmicToneMapping( vec3 color ) {
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ),		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);
	const mat3 ACESOutputMat = mat3(
		vec3(  1.60475, -0.10208, -0.00327 ),		vec3( -0.53108,  1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,  1.07602 )
	);
	color *= toneMappingExposure / 0.6;
	color = ACESInputMat * color;
	color = RRTAndODTFit( color );
	color = ACESOutputMat * color;
	return saturate( color );
}
vec3 CustomToneMapping( vec3 color ) { return color; }`,transmission_fragment:`#ifdef USE_TRANSMISSION
	material.transmission = transmission;
	material.transmissionAlpha = 1.0;
	material.thickness = thickness;
	material.attenuationDistance = attenuationDistance;
	material.attenuationColor = attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		material.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;
	#endif
	#ifdef USE_THICKNESSMAP
		material.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;
	#endif
	vec3 pos = vWorldPosition;
	vec3 v = normalize( cameraPosition - pos );
	vec3 n = inverseTransformDirection( normal, viewMatrix );
	vec4 transmitted = getIBLVolumeRefraction(
		n, v, roughnessFactor, material.diffuseColor, material.specularColor, material.specularF90,
		pos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,
		material.attenuationColor, material.attenuationDistance );
	material.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );
	totalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );
#endif`,transmission_pars_fragment:`#ifdef USE_TRANSMISSION
	uniform float transmission;
	uniform float thickness;
	uniform float attenuationDistance;
	uniform vec3 attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		uniform sampler2D transmissionMap;
	#endif
	#ifdef USE_THICKNESSMAP
		uniform sampler2D thicknessMap;
	#endif
	uniform vec2 transmissionSamplerSize;
	uniform sampler2D transmissionSamplerMap;
	uniform mat4 modelMatrix;
	uniform mat4 projectionMatrix;
	varying vec3 vWorldPosition;
	float w0( float a ) {
		return ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );
	}
	float w1( float a ) {
		return ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );
	}
	float w2( float a ){
		return ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );
	}
	float w3( float a ) {
		return ( 1.0 / 6.0 ) * ( a * a * a );
	}
	float g0( float a ) {
		return w0( a ) + w1( a );
	}
	float g1( float a ) {
		return w2( a ) + w3( a );
	}
	float h0( float a ) {
		return - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );
	}
	float h1( float a ) {
		return 1.0 + w3( a ) / ( w2( a ) + w3( a ) );
	}
	#ifndef WebGL2Context
	#define textureLod texture2DLodEXT
	#define textureSize(s, lod) vec2(1024./pow(2.,float(lod)),1024./pow(2.,float(lod)))
	#define isinf(x) (x > 1e20 || x < -1e20)
	#endif
	vec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {
		uv = uv * texelSize.zw + 0.5;
		vec2 iuv = floor( uv );
		vec2 fuv = fract( uv );
		float g0x = g0( fuv.x );
		float g1x = g1( fuv.x );
		float h0x = h0( fuv.x );
		float h1x = h1( fuv.x );
		float h0y = h0( fuv.y );
		float h1y = h1( fuv.y );
		vec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		vec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		return g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +
			g1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );
	}
	vec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {
		vec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );
		vec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );
		vec2 fLodSizeInv = 1.0 / fLodSize;
		vec2 cLodSizeInv = 1.0 / cLodSize;
		vec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );
		vec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );
		return mix( fSample, cSample, fract( lod ) );
	}
	vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {
		vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
		vec3 modelScale;
		modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
		modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
		modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
		return normalize( refractionVector ) * thickness * modelScale;
	}
	float applyIorToRoughness( const in float roughness, const in float ior ) {
		return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
	}
	vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {
		if(roughness == 0.0) return transmissionSamplerMapTexelToLinear( texture2D( transmissionSamplerMap, fragCoord.xy ) );
		float lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );
		return transmissionSamplerMapTexelToLinear( textureBicubic( transmissionSamplerMap, fragCoord.xy, lod ) );
	}
	vec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {
		if ( isinf( attenuationDistance ) || attenuationDistance == 0.0) {
			return vec3( 1.0 );
		} else {
			vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
			vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );			return transmittance;
		}
	}
	vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
		const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
		const in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,
		const in vec3 attenuationColor, const in float attenuationDistance ) {
		vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
		vec3 refractedRayExit = position + transmissionRay;
		vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
		vec2 refractionCoords = ndcPos.xy / ndcPos.w;
		refractionCoords += 1.0;
		refractionCoords /= 2.0;
		vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
		vec3 transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );
		vec3 attenuatedColor = transmittance * transmittedLight.rgb;
		vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
		float transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;
		return vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );
	}
#endif`,uv_pars_fragment:`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	varying vec2 vUv;
#endif
#ifdef USE_MAP
	varying vec2 vMapUv;
#endif
#ifdef USE_ALPHAMAP
	varying vec2 vAlphaMapUv;
#endif
#ifdef USE_LIGHTMAP
	varying vec2 vLightMapUv;
#endif
#ifdef USE_AOMAP
	varying vec2 vAoMapUv;
#endif
#ifdef USE_BUMPMAP
	varying vec2 vBumpMapUv;
#endif
#ifdef USE_NORMALMAP
	varying vec2 vNormalMapUv;
#endif
#ifdef USE_EMISSIVEMAP
	varying vec2 vEmissiveMapUv;
#endif
#ifdef USE_METALNESSMAP
	varying vec2 vMetalnessMapUv;
#endif
#ifdef USE_ROUGHNESSMAP
	varying vec2 vRoughnessMapUv;
#endif
#ifdef USE_ANISOTROPYMAP
	varying vec2 vAnisotropyMapUv;
#endif
#ifdef USE_CLEARCOATMAP
	varying vec2 vClearcoatMapUv;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	varying vec2 vClearcoatNormalMapUv;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	varying vec2 vClearcoatRoughnessMapUv;
#endif
#ifdef USE_IRIDESCENCEMAP
	varying vec2 vIridescenceMapUv;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	varying vec2 vIridescenceThicknessMapUv;
#endif
#ifdef USE_SHEEN_COLORMAP
	varying vec2 vSheenColorMapUv;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	varying vec2 vSheenRoughnessMapUv;
#endif
#ifdef USE_SPECULARMAP
	varying vec2 vSpecularMapUv;
#endif
#ifdef USE_SPECULAR_COLORMAP
	varying vec2 vSpecularColorMapUv;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	varying vec2 vSpecularIntensityMapUv;
#endif
#ifdef USE_TRANSMISSIONMAP
	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;
#endif
#ifdef USE_THICKNESSMAP
	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;
#endif`,uv_pars_vertex:`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	varying vec2 vUv;
#endif
#ifdef USE_MAP
	uniform mat3 mapTransform;
	varying vec2 vMapUv;
#endif
#ifdef USE_ALPHAMAP
	uniform mat3 alphaMapTransform;
	varying vec2 vAlphaMapUv;
#endif
#ifdef USE_LIGHTMAP
	uniform mat3 lightMapTransform;
	varying vec2 vLightMapUv;
#endif
#ifdef USE_AOMAP
	uniform mat3 aoMapTransform;
	varying vec2 vAoMapUv;
#endif
#ifdef USE_BUMPMAP
	uniform mat3 bumpMapTransform;
	varying vec2 vBumpMapUv;
#endif
#ifdef USE_NORMALMAP
	uniform mat3 normalMapTransform;
	varying vec2 vNormalMapUv;
#endif
#ifdef USE_DISPLACEMENTMAP
	uniform mat3 displacementMapTransform;
	varying vec2 vDisplacementMapUv;
#endif
#ifdef USE_EMISSIVEMAP
	uniform mat3 emissiveMapTransform;
	varying vec2 vEmissiveMapUv;
#endif
#ifdef USE_METALNESSMAP
	uniform mat3 metalnessMapTransform;
	varying vec2 vMetalnessMapUv;
#endif
#ifdef USE_ROUGHNESSMAP
	uniform mat3 roughnessMapTransform;
	varying vec2 vRoughnessMapUv;
#endif
#ifdef USE_ANISOTROPYMAP
	uniform mat3 anisotropyMapTransform;
	varying vec2 vAnisotropyMapUv;
#endif
#ifdef USE_CLEARCOATMAP
	uniform mat3 clearcoatMapTransform;
	varying vec2 vClearcoatMapUv;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform mat3 clearcoatNormalMapTransform;
	varying vec2 vClearcoatNormalMapUv;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform mat3 clearcoatRoughnessMapTransform;
	varying vec2 vClearcoatRoughnessMapUv;
#endif
#ifdef USE_SHEEN_COLORMAP
	uniform mat3 sheenColorMapTransform;
	varying vec2 vSheenColorMapUv;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	uniform mat3 sheenRoughnessMapTransform;
	varying vec2 vSheenRoughnessMapUv;
#endif
#ifdef USE_IRIDESCENCEMAP
	uniform mat3 iridescenceMapTransform;
	varying vec2 vIridescenceMapUv;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	uniform mat3 iridescenceThicknessMapTransform;
	varying vec2 vIridescenceThicknessMapUv;
#endif
#ifdef USE_SPECULARMAP
	uniform mat3 specularMapTransform;
	varying vec2 vSpecularMapUv;
#endif
#ifdef USE_SPECULAR_COLORMAP
	uniform mat3 specularColorMapTransform;
	varying vec2 vSpecularColorMapUv;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	uniform mat3 specularIntensityMapTransform;
	varying vec2 vSpecularIntensityMapUv;
#endif
#ifdef USE_TRANSMISSIONMAP
	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;
#endif
#ifdef USE_THICKNESSMAP
	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;
#endif`,uv_vertex:`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	vUv = vec3( uv, 1 ).xy;
#endif
#ifdef USE_MAP
	vMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ALPHAMAP
	vAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_LIGHTMAP
	vLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_AOMAP
	vAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_BUMPMAP
	vBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_NORMALMAP
	vNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_DISPLACEMENTMAP
	vDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_EMISSIVEMAP
	vEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_METALNESSMAP
	vMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ROUGHNESSMAP
	vRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ANISOTROPYMAP
	vAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOATMAP
	vClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	vClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	vClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_IRIDESCENCEMAP
	vIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	vIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SHEEN_COLORMAP
	vSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	vSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULARMAP
	vSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULAR_COLORMAP
	vSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	vSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_TRANSMISSIONMAP
	vTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_THICKNESSMAP
	vThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;
#endif`,worldpos_vertex:`#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0
	vec4 worldPosition = vec4( transformed, 1.0 );
	#ifdef USE_INSTANCING
		worldPosition = instanceMatrix * worldPosition;
	#endif
	worldPosition = modelMatrix * worldPosition;
#endif`,background_vert:`#ifdef HAS_TEXTURE
varying vec2 vUv;
uniform mat3 uvTransform;
uniform bool flipX;
uniform bool flipY;
#endif
void main() {
#ifdef HAS_TEXTURE
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
    vUv = flipX ? vec2( 1.0 - vUv.x, vUv.y ) : vUv;
    vUv = flipY ? vec2( vUv.x, 1.0 - vUv.y ) : vUv;
#endif
	gl_Position = vec4( position.xy, 1.0, 1.0 );
}`,background_frag:`#ifdef HAS_TEXTURE
uniform sampler2D t2D;
varying vec2 vUv;
#endif
uniform float backgroundIntensity;
uniform vec3 backgroundColor;
void main() {
#ifdef HAS_TEXTURE
	vec4 texColor = texture2D( t2D, vUv );
	#ifdef DECODE_VIDEO_TEXTURE
		texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );
	#endif
#else
	vec4 texColor = vec4( 1.0 );
#endif
	texColor.rgb *= backgroundColor * backgroundIntensity;
	gl_FragColor = texColor;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,backgroundCube_vert:`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,backgroundCube_frag:`#include <envmap_common_pars_fragment>
uniform float backgroundBlurriness;
uniform float backgroundIntensity;
varying vec3 vWorldDirection;
#include <cube_uv_reflection_fragment>
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
void main() {
	vec3 vReflect = vWorldDirection;
	vReflect = transformDirection(vReflect, rotationMatrix(vec3(0,1,0), envMapRotation));
	#ifdef ENVMAP_TYPE_CUBE
		vec4 texColor = textureCube( envMap, vec3( flipEnvMap * vReflect.x, vReflect.yz ) );
	#elif defined( ENVMAP_TYPE_CUBE_UV )
		vec4 texColor = textureCubeUV( envMap, vReflect, backgroundBlurriness );
	#else
		vec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );
	#endif
	texColor.rgb *= backgroundIntensity;
	texColor.rgb *= envMapIntensity;
	gl_FragColor = texColor;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,cube_vert:`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,cube_frag:`uniform samplerCube tCube;
uniform float tFlip;
uniform float opacity;
varying vec3 vWorldDirection;
void main() {
	vec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );
	gl_FragColor = texColor;
	gl_FragColor.a *= opacity;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,depth_vert:`#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec2 vHighPrecisionZW;
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vHighPrecisionZW = gl_Position.zw;
}`,depth_frag:`#if DEPTH_PACKING == 3200
	uniform float opacity;
#endif
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
varying vec2 vHighPrecisionZW;
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#if DEPTH_PACKING == 3200
		diffuseColor.a = opacity;
	#endif
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <logdepthbuf_fragment>
	float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;
	#if DEPTH_PACKING == 3200
		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );
	#elif DEPTH_PACKING == 3201
		gl_FragColor = packDepthToRGBA( fragCoordZ );
	#endif
}`,distanceRGBA_vert:`#define DISTANCE
varying vec3 vWorldPosition;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	vWorldPosition = worldPosition.xyz;
}`,distanceRGBA_frag:`#define DISTANCE
uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <clipping_planes_pars_fragment>
void main () {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist );
	gl_FragColor = packDepthToRGBA( dist );
}`,equirect_vert:`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
}`,equirect_frag:`uniform sampler2D tEquirect;
varying vec3 vWorldDirection;
#include <common>
void main() {
	vec3 direction = normalize( vWorldDirection );
	vec2 sampleUV = equirectUv( direction );
	gl_FragColor = texture2D( tEquirect, sampleUV );
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,linedashed_vert:`uniform float scale;
attribute float lineDistance;
varying float vLineDistance;
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	vLineDistance = scale * lineDistance;
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,linedashed_frag:`uniform vec3 diffuse;
uniform float opacity;
uniform float dashSize;
uniform float totalSize;
varying float vLineDistance;
#include <common>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	if ( mod( vLineDistance, totalSize ) > dashSize ) {
		discard;
	}
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,meshbasic_vert:`#include <common>
#include <uv_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>
}`,meshbasic_frag:`uniform vec3 diffuse;
uniform float opacity;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;
	#else
		reflectedLight.indirectDiffuse += vec3( 1.0 );
	#endif
	#include <aomap_fragment>
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshlambert_vert:`#define LAMBERT
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,meshlambert_frag:`#define LAMBERT
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_lambert_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_lambert_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshmatcap_vert:`#define MATCAP
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
	vViewPosition = - mvPosition.xyz;
}`,meshmatcap_frag:`#define MATCAP
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;
varying vec3 vViewPosition;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;
	#ifdef USE_MATCAP
		vec4 matcapColor = texture2D( matcap, uv );
	#else
		vec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );
	#endif
	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshnormal_vert:`#define NORMAL
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	varying vec3 vViewPosition;
#endif
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	vViewPosition = - mvPosition.xyz;
#endif
}`,meshnormal_frag:`#define NORMAL
uniform float opacity;
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	varying vec3 vViewPosition;
#endif
#include <packing>
#include <uv_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	gl_FragColor = vec4( packNormalToRGB( normal ), opacity );
	#ifdef OPAQUE
		gl_FragColor.a = 1.0;
	#endif
}`,meshphong_vert:`#define PHONG
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,meshphong_frag:`#define PHONG
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshphysical_vert:`#define STANDARD
varying vec3 vViewPosition;
#ifdef USE_TRANSMISSION
	varying vec3 vWorldPosition;
#endif
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
#ifdef USE_TRANSMISSION
	vWorldPosition = worldPosition.xyz;
#endif
}`,meshphysical_frag:`#define STANDARD
#ifdef PHYSICAL
	#define IOR
	#define USE_SPECULAR
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef IOR
	uniform float ior;
#endif
#ifdef USE_SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularColor;
	#ifdef USE_SPECULAR_COLORMAP
		uniform sampler2D specularColorMap;
	#endif
	#ifdef USE_SPECULAR_INTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
#endif
#ifdef USE_CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif
#ifdef USE_IRIDESCENCE
	uniform float iridescence;
	uniform float iridescenceIOR;
	uniform float iridescenceThicknessMinimum;
	uniform float iridescenceThicknessMaximum;
#endif
#ifdef USE_SHEEN
	uniform vec3 sheenColor;
	uniform float sheenRoughness;
	#ifdef USE_SHEEN_COLORMAP
		uniform sampler2D sheenColorMap;
	#endif
	#ifdef USE_SHEEN_ROUGHNESSMAP
		uniform sampler2D sheenRoughnessMap;
	#endif
#endif
#ifdef USE_ANISOTROPY
	uniform vec2 anisotropyVector;
	#ifdef USE_ANISOTROPYMAP
		uniform sampler2D anisotropyMap;
	#endif
#endif
varying vec3 vViewPosition;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <iridescence_fragment>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <iridescence_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;
	#include <transmission_fragment>
	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
	#ifdef USE_SHEEN
		float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );
		outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;
	#endif
	#ifdef USE_CLEARCOAT
		float dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );
		vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );
		outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;
	#endif
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,meshtoon_vert:`#define TOON
varying vec3 vViewPosition;
#include <common>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,meshtoon_frag:`#define TOON
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,points_vert:`uniform float size;
uniform float scale;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
#ifdef USE_POINTS_UV
	varying vec2 vUv;
	uniform mat3 uvTransform;
#endif
void main() {
	#ifdef USE_POINTS_UV
		vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	#endif
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	gl_PointSize = size;
	#ifdef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );
	#endif
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>
}`,points_frag:`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,shadow_vert:`#include <common>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <shadowmap_pars_vertex>
void main() {
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,shadow_frag:`uniform vec3 color;
uniform float opacity;
#include <common>
#include <packing>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <logdepthbuf_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
void main() {
	#include <logdepthbuf_fragment>
	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
}`,sprite_vert:`uniform float rotation;
uniform vec2 center;
#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec2 scale;
	scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
	scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );
	#ifndef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) scale *= - mvPosition.z;
	#endif
	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;
	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
	mvPosition.xy += rotatedPosition;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,sprite_frag:`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
}`},bn={common:{diffuse:{value:new Dn(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new er},alphaMap:{value:null},alphaMapTransform:{value:new er},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new er}},envmap:{envMap:{value:null},envMapRotation:{value:0},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new er}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new er}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new er},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new er},normalScale:{value:new en(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new er},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new er}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new er}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new er}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Dn(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Dn(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new er},alphaTest:{value:0},uvTransform:{value:new er}},sprite:{diffuse:{value:new Dn(16777215)},opacity:{value:1},center:{value:new en(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new er},alphaMap:{value:null},alphaMapTransform:{value:new er},alphaTest:{value:0}}},Lo={basic:{uniforms:Mo([bn.common,bn.specularmap,bn.envmap,bn.aomap,bn.lightmap,bn.fog]),vertexShader:ar.meshbasic_vert,fragmentShader:ar.meshbasic_frag},lambert:{uniforms:Mo([bn.common,bn.specularmap,bn.envmap,bn.aomap,bn.lightmap,bn.emissivemap,bn.bumpmap,bn.normalmap,bn.displacementmap,bn.fog,bn.lights,{emissive:{value:new Dn(0)}}]),vertexShader:ar.meshlambert_vert,fragmentShader:ar.meshlambert_frag},phong:{uniforms:Mo([bn.common,bn.specularmap,bn.envmap,bn.aomap,bn.lightmap,bn.emissivemap,bn.bumpmap,bn.normalmap,bn.displacementmap,bn.fog,bn.lights,{emissive:{value:new Dn(0)},specular:{value:new Dn(1118481)},shininess:{value:30}}]),vertexShader:ar.meshphong_vert,fragmentShader:ar.meshphong_frag},standard:{uniforms:Mo([bn.common,bn.envmap,bn.aomap,bn.lightmap,bn.emissivemap,bn.bumpmap,bn.normalmap,bn.displacementmap,bn.roughnessmap,bn.metalnessmap,bn.fog,bn.lights,{emissive:{value:new Dn(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:ar.meshphysical_vert,fragmentShader:ar.meshphysical_frag},toon:{uniforms:Mo([bn.common,bn.aomap,bn.lightmap,bn.emissivemap,bn.bumpmap,bn.normalmap,bn.displacementmap,bn.gradientmap,bn.fog,bn.lights,{emissive:{value:new Dn(0)}}]),vertexShader:ar.meshtoon_vert,fragmentShader:ar.meshtoon_frag},matcap:{uniforms:Mo([bn.common,bn.bumpmap,bn.normalmap,bn.displacementmap,bn.fog,{matcap:{value:null}}]),vertexShader:ar.meshmatcap_vert,fragmentShader:ar.meshmatcap_frag},points:{uniforms:Mo([bn.points,bn.fog]),vertexShader:ar.points_vert,fragmentShader:ar.points_frag},dashed:{uniforms:Mo([bn.common,bn.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:ar.linedashed_vert,fragmentShader:ar.linedashed_frag},depth:{uniforms:Mo([bn.common,bn.displacementmap]),vertexShader:ar.depth_vert,fragmentShader:ar.depth_frag},normal:{uniforms:Mo([bn.common,bn.bumpmap,bn.normalmap,bn.displacementmap,{opacity:{value:1}}]),vertexShader:ar.meshnormal_vert,fragmentShader:ar.meshnormal_frag},sprite:{uniforms:Mo([bn.sprite,bn.fog]),vertexShader:ar.sprite_vert,fragmentShader:ar.sprite_frag},background:{uniforms:{uvTransform:{value:new er},t2D:{value:null},backgroundIntensity:{value:1},backgroundColor:{value:new Dn(16777215)},flipX:{value:!1},flipY:{value:!1}},vertexShader:ar.background_vert,fragmentShader:ar.background_frag},backgroundCube:{uniforms:{envMap:{value:null},envMapRotation:{value:0},envMapIntensity:{value:1},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1}},vertexShader:ar.backgroundCube_vert,fragmentShader:ar.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:ar.cube_vert,fragmentShader:ar.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:ar.equirect_vert,fragmentShader:ar.equirect_frag},distanceRGBA:{uniforms:Mo([bn.common,bn.displacementmap,{referencePosition:{value:new ii},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:ar.distanceRGBA_vert,fragmentShader:ar.distanceRGBA_frag},shadow:{uniforms:Mo([bn.lights,bn.fog,{color:{value:new Dn(0)},opacity:{value:1}}]),vertexShader:ar.shadow_vert,fragmentShader:ar.shadow_frag}};Lo.physical={uniforms:Mo([Lo.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new er},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new er},clearcoatNormalScale:{value:new en(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new er},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new er},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new er},sheen:{value:0},sheenColor:{value:new Dn(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new er},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new er},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new er},transmissionSamplerSize:{value:new en},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new er},attenuationDistance:{value:0},attenuationColor:{value:new Dn(0)},specularColor:{value:new Dn(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new er},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new er},anisotropyVector:{value:new en},anisotropyMap:{value:null},anisotropyMapTransform:{value:new er}}]),vertexShader:ar.meshphysical_vert,fragmentShader:ar.meshphysical_frag};const rd={r:0,b:0,g:0};function ng(De,y,b,D,Y,_e,Le){const qe=new Dn(0);let it,nt,mt=_e===!0?0:1,bt=null,At=0,wt=null;function Et(Mt,St){Mt.getRGB(rd,bp(De)),D.buffers.color.setClear(rd.r,rd.g,rd.b,St,Le)}return{getClearColor:function(){return qe},setClearColor:function(Mt,St=1){qe.set(Mt),mt=St,Et(qe,mt)},getClearAlpha:function(){return mt},setClearAlpha:function(Mt){mt=Mt,Et(qe,mt)},getPlaneMesh:function(){return it},getBoxMesh:function(){return nt},getBoxMesh2:function(){return nt===void 0&&(nt=new so(new Ea(1,1,1),new hs({name:"BackgroundCubeMaterial",uniforms:Ka(Lo.backgroundCube.uniforms),vertexShader:Lo.backgroundCube.vertexShader,fragmentShader:Lo.backgroundCube.fragmentShader,side:ye,depthTest:!1,depthWrite:!1,fog:!1})),nt.geometry.deleteAttribute("normal"),nt.geometry.deleteAttribute("uv"),nt.onBeforeRender=function(Mt,St,Nt){this.matrixWorld.copyPosition(Nt.matrixWorld)},Object.defineProperty(nt.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),Y.update(nt)),nt},render:function(Mt,St){let Nt=!1,It=St.isScene===!0?St.background:null;const Rt=St.isScene&&St.backgroundColor!==void 0?St.backgroundColor:null;It==="environment"&&(It=St.environment),It&&It.isTexture&&(It=(St.backgroundBlurriness>0?b:y).get(It)),It===null?Et(qe,mt):It&&It.isColor&&(Et(It,1),Nt=!0);const Yt=De.xr.getEnvironmentBlendMode();if(Yt==="additive"?D.buffers.color.setClear(0,0,0,1,Le):Yt==="alpha-blend"&&D.buffers.color.setClear(0,0,0,0,Le),(De.autoClear||Nt)&&De.clear(De.autoClearColor,De.autoClearDepth,De.autoClearStencil),It&&(It.isCubeTexture||It.mapping===dn))nt===void 0&&(nt=new so(new Ea(1,1,1),new hs({name:"BackgroundCubeMaterial",uniforms:Ka(Lo.backgroundCube.uniforms),vertexShader:Lo.backgroundCube.vertexShader,fragmentShader:Lo.backgroundCube.fragmentShader,side:ye,depthTest:!1,depthWrite:!1,fog:!1})),nt.geometry.deleteAttribute("normal"),nt.geometry.deleteAttribute("uv"),nt.onBeforeRender=function(Kt,Xt,oi){this.matrixWorld.copyPosition(oi.matrixWorld)},Object.defineProperty(nt.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),Y.update(nt)),nt.material.uniforms.envMap.value=It,nt.material.uniforms.envMapRotation.value=It&&It.rotation||0,nt.material.uniforms.envMapIntensity.value=It===St.environment&&St.envMapIntensity||1,nt.material.uniforms.flipEnvMap.value=It.isCubeTexture&&It.isRenderTargetTexture===!1?-1:1,nt.material.uniforms.backgroundBlurriness.value=St.backgroundBlurriness,nt.material.uniforms.backgroundIntensity.value=St.backgroundIntensity,nt.material.toneMapped=Sr.getTransfer(It.colorSpace)!==Dr,bt===It&&At===It.version&&wt===De.toneMapping||(nt.material.needsUpdate=!0,bt=It,At=It.version,wt=De.toneMapping),nt.layers.enableAll(),Mt.unshift(nt,nt.geometry,nt.material,0,0,null);else if(It&&It.isTexture||!It&&Rt){it===void 0&&(it=new so(new Yc(2,2),new hs({name:"BackgroundMaterial",uniforms:Ka(Lo.background.uniforms),vertexShader:Lo.background.vertexShader,fragmentShader:Lo.background.fragmentShader,side:ue,depthTest:!1,depthWrite:!1,fog:!1})),it.geometry.deleteAttribute("normal"),Object.defineProperty(it.material,"map",{get:function(){return this.uniforms.t2D.value}}),Y.update(it)),it.material.uniforms.backgroundColor.value.set(Rt||16777215),it.material.uniforms.t2D.value=It,it.material.uniforms.backgroundIntensity.value=St.backgroundIntensity,It?(it.material.toneMapped=Sr.getTransfer(It.colorSpace)!==Dr,it.material.uniforms.flipX.value=It.userData.flipX||!1,it.material.uniforms.flipY.value=It.userData.flipY||!1,It.matrixAutoUpdate===!0&&It.updateMatrix(),it.material.uniforms.uvTransform.value.copy(It.matrix),it.material.defines.HAS_TEXTURE="1"):it.material.defines.HAS_TEXTURE&&delete it.material.defines.HAS_TEXTURE;const Kt=It?It.version:-1;bt===It&&At===Kt&&wt===De.toneMapping||(it.material.needsUpdate=!0,bt=It,At=Kt,wt=De.toneMapping),it.layers.enableAll(),Mt.unshift(it,it.geometry,it.material,0,0,null)}}}}function rg(De,y,b,D){const Y=De.getParameter(De.MAX_VERTEX_ATTRIBS),_e=D.isWebGL2?null:y.get("OES_vertex_array_object"),Le=D.isWebGL2||_e!==null,qe={},it=wt(null);let nt=it,mt=!1;function bt(Kt){return D.isWebGL2?De.bindVertexArray(Kt):_e.bindVertexArrayOES(Kt)}function At(Kt){return D.isWebGL2?De.deleteVertexArray(Kt):_e.deleteVertexArrayOES(Kt)}function wt(Kt){const Xt=[],oi=[],wi=[];for(let fi=0;fi<Y;fi++)Xt[fi]=0,oi[fi]=0,wi[fi]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:Xt,enabledAttributes:oi,attributeDivisors:wi,object:Kt,attributes:{},index:null}}function Et(){const Kt=nt.newAttributes;for(let Xt=0,oi=Kt.length;Xt<oi;Xt++)Kt[Xt]=0}function Mt(Kt){St(Kt,0)}function St(Kt,Xt){const oi=nt.newAttributes,wi=nt.enabledAttributes,fi=nt.attributeDivisors;oi[Kt]=1,wi[Kt]===0&&(De.enableVertexAttribArray(Kt),wi[Kt]=1),fi[Kt]!==Xt&&((D.isWebGL2?De:y.get("ANGLE_instanced_arrays"))[D.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](Kt,Xt),fi[Kt]=Xt)}function Nt(){const Kt=nt.newAttributes,Xt=nt.enabledAttributes;for(let oi=0,wi=Xt.length;oi<wi;oi++)Xt[oi]!==Kt[oi]&&(De.disableVertexAttribArray(oi),Xt[oi]=0)}function It(Kt,Xt,oi,wi,fi,yi,bi){bi===!0?De.vertexAttribIPointer(Kt,Xt,oi,fi,yi):De.vertexAttribPointer(Kt,Xt,oi,wi,fi,yi)}function Rt(){Yt(),mt=!0,nt!==it&&(nt=it,bt(nt.object))}function Yt(){it.geometry=null,it.program=null,it.wireframe=!1}return{setup:function(Kt,Xt,oi,wi,fi){let yi=!1;if(Le){const bi=function(Ci,tn,$i){const gn=$i.wireframe===!0;let xn=qe[Ci.id];xn===void 0&&(xn={},qe[Ci.id]=xn);let Wi=xn[tn.id];Wi===void 0&&(Wi={},xn[tn.id]=Wi);let Oi=Wi[gn];return Oi===void 0&&(Oi=wt(D.isWebGL2?De.createVertexArray():_e.createVertexArrayOES()),Wi[gn]=Oi),Oi}(wi,oi,Xt);nt!==bi&&(nt=bi,bt(nt.object)),yi=function(Ci,tn,$i,gn){const xn=nt.attributes,Wi=tn.attributes;let Oi=0;const ki=$i.getAttributes();for(const Hi in ki)if(ki[Hi].location>=0){const Vi=xn[Hi];let Mn=Wi[Hi];if(Mn===void 0&&(Hi==="instanceMatrix"&&Ci.instanceMatrix&&(Mn=Ci.instanceMatrix),Hi==="instanceColor"&&Ci.instanceColor&&(Mn=Ci.instanceColor)),Vi===void 0||Vi.attribute!==Mn||Mn&&Vi.data!==Mn.data)return!0;Oi++}return nt.attributesNum!==Oi||nt.index!==gn}(Kt,wi,oi,fi),yi&&function(Ci,tn,$i,gn){const xn={},Wi=tn.attributes;let Oi=0;const ki=$i.getAttributes();for(const Hi in ki)if(ki[Hi].location>=0){let Vi=Wi[Hi];Vi===void 0&&(Hi==="instanceMatrix"&&Ci.instanceMatrix&&(Vi=Ci.instanceMatrix),Hi==="instanceColor"&&Ci.instanceColor&&(Vi=Ci.instanceColor));const Mn={};Mn.attribute=Vi,Vi&&Vi.data&&(Mn.data=Vi.data),xn[Hi]=Mn,Oi++}nt.attributes=xn,nt.attributesNum=Oi,nt.index=gn}(Kt,wi,oi,fi)}else{const bi=Xt.wireframe===!0;nt.geometry===wi.id&&nt.program===oi.id&&nt.wireframe===bi||(nt.geometry=wi.id,nt.program=oi.id,nt.wireframe=bi,yi=!0)}fi!==null&&b.update(fi,De.ELEMENT_ARRAY_BUFFER),(yi||mt)&&(mt=!1,function(bi,Ci,tn,$i){if(D.isWebGL2===!1&&(bi.isInstancedMesh||$i.isInstancedBufferGeometry)&&y.get("ANGLE_instanced_arrays")===null)return;Et();const gn=$i.attributes,xn=tn.getAttributes(),Wi=Ci.defaultAttributeValues;for(const Oi in xn){const ki=xn[Oi];if(ki.location>=0){let Hi=gn[Oi];if(Hi===void 0&&(Oi==="instanceMatrix"&&bi.instanceMatrix&&(Hi=bi.instanceMatrix),Oi==="instanceColor"&&bi.instanceColor&&(Hi=bi.instanceColor)),Hi!==void 0){const Vi=Hi.normalized,Mn=Hi.itemSize,Wn=b.get(Hi);if(Wn===void 0)continue;const zn=Wn.buffer,Pn=Wn.type,ir=Wn.bytesPerElement,di=D.isWebGL2===!0&&(Pn===De.INT||Pn===De.UNSIGNED_INT||Hi.gpuType===_n);if(Hi.isInterleavedBufferAttribute){const ei=Hi.data,gi=ei.stride,Mi=Hi.offset;if(ei.isInstancedInterleavedBuffer){for(let ui=0;ui<ki.locationSize;ui++)St(ki.location+ui,ei.meshPerAttribute);bi.isInstancedMesh!==!0&&$i._maxInstanceCount===void 0&&($i._maxInstanceCount=ei.meshPerAttribute*ei.count)}else for(let ui=0;ui<ki.locationSize;ui++)Mt(ki.location+ui);De.bindBuffer(De.ARRAY_BUFFER,zn);for(let ui=0;ui<ki.locationSize;ui++)It(ki.location+ui,Mn/ki.locationSize,Pn,Vi,gi*ir,(Mi+Mn/ki.locationSize*ui)*ir,di)}else{if(Hi.isInstancedBufferAttribute){for(let ei=0;ei<ki.locationSize;ei++)St(ki.location+ei,Hi.meshPerAttribute);bi.isInstancedMesh!==!0&&$i._maxInstanceCount===void 0&&($i._maxInstanceCount=Hi.meshPerAttribute*Hi.count)}else for(let ei=0;ei<ki.locationSize;ei++)Mt(ki.location+ei);De.bindBuffer(De.ARRAY_BUFFER,zn);for(let ei=0;ei<ki.locationSize;ei++)It(ki.location+ei,Mn/ki.locationSize,Pn,Vi,Mn*ir,Mn/ki.locationSize*ei*ir,di)}}else if(Wi!==void 0){const Vi=Wi[Oi];if(Vi!==void 0)switch(Vi.length){case 2:De.vertexAttrib2fv(ki.location,Vi);break;case 3:De.vertexAttrib3fv(ki.location,Vi);break;case 4:De.vertexAttrib4fv(ki.location,Vi);break;default:De.vertexAttrib1fv(ki.location,Vi)}}}}Nt()}(Kt,Xt,oi,wi),fi!==null&&De.bindBuffer(De.ELEMENT_ARRAY_BUFFER,b.get(fi).buffer))},reset:Rt,resetDefaultState:Yt,dispose:function(){Rt();for(const Kt in qe){const Xt=qe[Kt];for(const oi in Xt){const wi=Xt[oi];for(const fi in wi)At(wi[fi].object),delete wi[fi];delete Xt[oi]}delete qe[Kt]}},releaseStatesOfGeometry:function(Kt){if(qe[Kt.id]===void 0)return;const Xt=qe[Kt.id];for(const oi in Xt){const wi=Xt[oi];for(const fi in wi)At(wi[fi].object),delete wi[fi];delete Xt[oi]}delete qe[Kt.id]},releaseStatesOfProgram:function(Kt){for(const Xt in qe){const oi=qe[Xt];if(oi[Kt.id]===void 0)continue;const wi=oi[Kt.id];for(const fi in wi)At(wi[fi].object),delete wi[fi];delete oi[Kt.id]}},initAttributes:Et,enableAttribute:Mt,disableUnusedAttributes:Nt}}function og(De,y,b,D){const Y=D.isWebGL2;let _e;this.setMode=function(Le){_e=Le},this.render=function(Le,qe){De.drawArrays(_e,Le,qe),b.update(qe,_e,1)},this.renderInstances=function(Le,qe,it){if(it===0)return;let nt,mt;if(Y)nt=De,mt="drawArraysInstanced";else if(nt=y.get("ANGLE_instanced_arrays"),mt="drawArraysInstancedANGLE",nt===null)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");nt[mt](_e,Le,qe,it),b.update(qe,_e,it)}}function sg(De,y,b){let D;function Y(Yt){if(Yt==="highp"){if(De.getShaderPrecisionFormat(De.VERTEX_SHADER,De.HIGH_FLOAT).precision>0&&De.getShaderPrecisionFormat(De.FRAGMENT_SHADER,De.HIGH_FLOAT).precision>0)return"highp";Yt="mediump"}return Yt==="mediump"&&De.getShaderPrecisionFormat(De.VERTEX_SHADER,De.MEDIUM_FLOAT).precision>0&&De.getShaderPrecisionFormat(De.FRAGMENT_SHADER,De.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const _e=typeof WebGL2RenderingContext<"u"&&De.constructor.name==="WebGL2RenderingContext";let Le=b.precision!==void 0?b.precision:"highp";const qe=Y(Le);qe!==Le&&(console.warn("THREE.WebGLRenderer:",Le,"not supported, using",qe,"instead."),Le=qe);const it=_e||y.has("WEBGL_draw_buffers"),nt=b.logarithmicDepthBuffer===!0,mt=De.getParameter(De.MAX_TEXTURE_IMAGE_UNITS),bt=De.getParameter(De.MAX_VERTEX_TEXTURE_IMAGE_UNITS),At=De.getParameter(De.MAX_TEXTURE_SIZE),wt=De.getParameter(De.MAX_CUBE_MAP_TEXTURE_SIZE),Et=De.getParameter(De.MAX_VERTEX_ATTRIBS),Mt=De.getParameter(De.MAX_VERTEX_UNIFORM_VECTORS),St=De.getParameter(De.MAX_VARYING_VECTORS),Nt=De.getParameter(De.MAX_FRAGMENT_UNIFORM_VECTORS),It=bt>0,Rt=_e||y.has("OES_texture_float");return{isWebGL2:_e,drawBuffers:it,getMaxAnisotropy:function(){if(D!==void 0)return D;if(y.has("EXT_texture_filter_anisotropic")===!0){const Yt=y.get("EXT_texture_filter_anisotropic");D=De.getParameter(Yt.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else D=0;return D},getMaxPrecision:Y,precision:Le,logarithmicDepthBuffer:nt,maxTextures:mt,maxVertexTextures:bt,maxTextureSize:At,maxCubemapSize:wt,maxAttributes:Et,maxVertexUniforms:Mt,maxVaryings:St,maxFragmentUniforms:Nt,vertexTextures:It,floatFragmentTextures:Rt,floatVertexTextures:It&&Rt,maxSamples:_e?De.getParameter(De.MAX_SAMPLES):0}}function ag(De){const y=this;let b=null,D=0,Y=!1,_e=!1;const Le=new Sa,qe=new er,it={value:null,needsUpdate:!1};function nt(mt,bt,At,wt){const Et=mt!==null?mt.length:0;let Mt=null;if(Et!==0){if(Mt=it.value,wt!==!0||Mt===null){const St=At+4*Et,Nt=bt.matrixWorldInverse;qe.getNormalMatrix(Nt),(Mt===null||Mt.length<St)&&(Mt=new Float32Array(St));for(let It=0,Rt=At;It!==Et;++It,Rt+=4)Le.copy(mt[It]).applyMatrix4(Nt,qe),Le.normal.toArray(Mt,Rt),Mt[Rt+3]=Le.constant}it.value=Mt,it.needsUpdate=!0}return y.numPlanes=Et,y.numIntersection=0,Mt}this.uniform=it,this.numPlanes=0,this.numIntersection=0,this.init=function(mt,bt){const At=mt.length!==0||bt||D!==0||Y;return Y=bt,D=mt.length,At},this.beginShadows=function(){_e=!0,nt(null)},this.endShadows=function(){_e=!1},this.setGlobalState=function(mt,bt){b=nt(mt,bt,0)},this.setState=function(mt,bt,At){const wt=mt.clippingPlanes,Et=mt.clipIntersection,Mt=mt.clipShadows,St=De.get(mt);if(!Y||wt===null||wt.length===0||_e&&!Mt)_e?nt(null):(it.value!==b&&(it.value=b,it.needsUpdate=D>0),y.numPlanes=D,y.numIntersection=0);else{const Nt=_e?0:D,It=4*Nt;let Rt=St.clippingState||null;it.value=Rt,Rt=nt(wt,bt,It,At);for(let Yt=0;Yt!==It;++Yt)Rt[Yt]=b[Yt];St.clippingState=Rt,this.numIntersection=Et?this.numPlanes:0,this.numPlanes+=Nt}}}function lg(De){let y=new WeakMap;function b(Y,_e){return _e===Ri?Y.mapping=xi:_e===Zi&&(Y.mapping=mi),Y}function D(Y){const _e=Y.target;_e.removeEventListener("dispose",D);const Le=y.get(_e);Le!==void 0&&(y.delete(_e),Le.dispose())}return{get:function(Y){if(Y&&Y.isTexture&&Y.isRenderTargetTexture===!1){const _e=Y.mapping;if(_e===Ri||_e===Zi){if(y.has(Y)){const Le=y.get(Y).texture;return Le.rotation=Y.rotation,b(Le,Y.mapping)}{const Le=Y.image;if(Le&&Le.height>0){const qe=new Ep(Le.height/2);return qe.fromEquirectangularTexture(De,Y),qe.texture.rotation=Y.rotation,y.set(Y,qe),Y.addEventListener("dispose",D),b(qe.texture,Y.mapping)}return null}}}return Y},dispose:function(){y=new WeakMap}}}class od extends Zu{constructor(y=-1,b=1,D=1,Y=-1,_e=.1,Le=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=y,this.right=b,this.top=D,this.bottom=Y,this.near=_e,this.far=Le,this.updateProjectionMatrix()}copy(y,b){return super.copy(y,b),this.left=y.left,this.right=y.right,this.top=y.top,this.bottom=y.bottom,this.near=y.near,this.far=y.far,this.zoom=y.zoom,this.view=y.view===null?null:Object.assign({},y.view),this}setViewOffset(y,b,D,Y,_e,Le){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=y,this.view.fullHeight=b,this.view.offsetX=D,this.view.offsetY=Y,this.view.width=_e,this.view.height=Le,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const y=(this.right-this.left)/(2*this.zoom),b=(this.top-this.bottom)/(2*this.zoom),D=(this.right+this.left)/2,Y=(this.top+this.bottom)/2;let _e=D-y,Le=D+y,qe=Y+b,it=Y-b;if(this.view!==null&&this.view.enabled){const nt=(this.right-this.left)/this.view.fullWidth/this.zoom,mt=(this.top-this.bottom)/this.view.fullHeight/this.zoom;_e+=nt*this.view.offsetX,Le=_e+nt*this.view.width,qe-=mt*this.view.offsetY,it=qe-mt*this.view.height}this.projectionMatrix.makeOrthographic(_e,Le,qe,it,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(y){const b=super.toJSON(y);return b.object.zoom=this.zoom,b.object.left=this.left,b.object.right=this.right,b.object.top=this.top,b.object.bottom=this.bottom,b.object.near=this.near,b.object.far=this.far,this.view!==null&&(b.object.view=Object.assign({},this.view)),b}}const Tp=[.125,.215,.35,.446,.526,.582],Ah=new od,Cp=new Dn;let bh=null;const Ja=(1+Math.sqrt(5))/2,Xl=1/Ja,Mp=[new ii(1,1,1),new ii(-1,1,1),new ii(1,1,-1),new ii(-1,1,-1),new ii(0,Ja,Xl),new ii(0,Ja,-Xl),new ii(Xl,0,Ja),new ii(-Xl,0,Ja),new ii(Ja,Xl,0),new ii(-Ja,Xl,0)];class xh{constructor(y){this._renderer=y,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(y,b=0,D=.1,Y=100){bh=this._renderer.getRenderTarget(),this._setSize(256);const _e=this._allocateTargets();return _e.depthBuffer=!0,this._sceneToCubeUV(y,D,Y,_e),b>0&&this._blur(_e,0,0,b),this._applyPMREM(_e),this._cleanup(_e),_e}fromEquirectangular(y,b=null){return this._fromTexture(y,b)}fromCubemap(y,b=null){return this._fromTexture(y,b)}compileCubemapShader(){this._cubemapMaterial===null&&(this._cubemapMaterial=Rp(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){this._equirectMaterial===null&&(this._equirectMaterial=Ip(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),this._cubemapMaterial!==null&&this._cubemapMaterial.dispose(),this._equirectMaterial!==null&&this._equirectMaterial.dispose()}_setSize(y){this._lodMax=Math.floor(Math.log2(y)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){this._blurMaterial!==null&&this._blurMaterial.dispose(),this._pingPongRenderTarget!==null&&this._pingPongRenderTarget.dispose();for(let y=0;y<this._lodPlanes.length;y++)this._lodPlanes[y].dispose()}_cleanup(y){this._renderer.setRenderTarget(bh),y.scissorTest=!1,sd(y,0,0,y.width,y.height)}_fromTexture(y,b){y.mapping===xi||y.mapping===mi?this._setSize(y.image.length===0?16:y.image[0].width||y.image[0].image.width):this._setSize(y.image.width/4),bh=this._renderer.getRenderTarget();const D=b||this._allocateTargets();return this._textureToCubeUV(y,D),this._applyPMREM(D),this._cleanup(D),D}_allocateTargets(){const y=3*Math.max(this._cubeSize,112),b=4*this._cubeSize,D={magFilter:fn,minFilter:fn,generateMipmaps:!1,type:qn,format:Nr,colorSpace:Fr,depthBuffer:!1},Y=Pp(y,b,D);if(this._pingPongRenderTarget===null||this._pingPongRenderTarget.width!==y||this._pingPongRenderTarget.height!==b){this._pingPongRenderTarget!==null&&this._dispose(),this._pingPongRenderTarget=Pp(y,b,D);const{_lodMax:_e}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(Le){const qe=[],it=[],nt=[];let mt=Le;const bt=Le-4+1+Tp.length;for(let At=0;At<bt;At++){const wt=Math.pow(2,mt);it.push(wt);let Et=1/wt;At>Le-4?Et=Tp[At-Le+4-1]:At===0&&(Et=0),nt.push(Et);const Mt=1/(wt-2),St=-Mt,Nt=1+Mt,It=[St,St,Nt,St,Nt,Nt,St,St,Nt,Nt,St,Nt],Rt=6,Yt=6,Kt=3,Xt=2,oi=1,wi=new Float32Array(Kt*Yt*Rt),fi=new Float32Array(Xt*Yt*Rt),yi=new Float32Array(oi*Yt*Rt);for(let Ci=0;Ci<Rt;Ci++){const tn=Ci%3*2/3-1,$i=Ci>2?0:-1,gn=[tn,$i,0,tn+2/3,$i,0,tn+2/3,$i+1,0,tn,$i,0,tn+2/3,$i+1,0,tn,$i+1,0];wi.set(gn,Kt*Yt*Ci),fi.set(It,Xt*Yt*Ci);const xn=[Ci,Ci,Ci,Ci,Ci,Ci];yi.set(xn,oi*Yt*Ci)}const bi=new dr;bi.setAttribute("position",new zt(wi,Kt)),bi.setAttribute("uv",new zt(fi,Xt)),bi.setAttribute("faceIndex",new zt(yi,oi)),qe.push(bi),mt>4&&mt--}return{lodPlanes:qe,sizeLods:it,sigmas:nt}}(_e)),this._blurMaterial=function(Le,qe,it){const nt=new Float32Array(20),mt=new ii(0,1,0);return new hs({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/qe,CUBEUV_TEXEL_HEIGHT:1/it,CUBEUV_MAX_MIP:`${Le}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:nt},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:mt}},vertexShader:`

		precision mediump float;
		precision mediump int;

		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`,fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

			}
		`,blending:Ve,depthTest:!1,depthWrite:!1})}(_e,y,b)}return Y}_compileMaterial(y){const b=new so(this._lodPlanes[0],y);this._renderer.compile(b,Ah)}_sceneToCubeUV(y,b,D,Y){const _e=new _o(90,1,b,D),Le=[1,-1,1,1,1,1],qe=[1,1,1,-1,-1,-1],it=this._renderer,nt=it.autoClear,mt=it.toneMapping;it.getClearColor(Cp),it.toneMapping=_i,it.autoClear=!1;const bt=new Ss({name:"PMREM.Background",side:ye,depthWrite:!1,depthTest:!1}),At=new so(new Ea,bt);let wt=!1;const Et=y.background;Et?Et.isColor&&(bt.color.copy(Et),y.background=null,wt=!0):(bt.color.copy(Cp),wt=!0);for(let Mt=0;Mt<6;Mt++){const St=Mt%3;St===0?(_e.up.set(0,Le[Mt],0),_e.lookAt(qe[Mt],0,0)):St===1?(_e.up.set(0,0,Le[Mt]),_e.lookAt(0,qe[Mt],0)):(_e.up.set(0,Le[Mt],0),_e.lookAt(0,0,qe[Mt]));const Nt=this._cubeSize;sd(Y,St*Nt,Mt>2?Nt:0,Nt,Nt),it.setRenderTarget(Y),wt&&it.render(At,_e),it.render(y,_e)}At.geometry.dispose(),At.material.dispose(),it.toneMapping=mt,it.autoClear=nt,y.background=Et}_textureToCubeUV(y,b){const D=this._renderer,Y=y.mapping===xi||y.mapping===mi;Y?(this._cubemapMaterial===null&&(this._cubemapMaterial=Rp()),this._cubemapMaterial.uniforms.flipEnvMap.value=y.isRenderTargetTexture===!1?-1:1):this._equirectMaterial===null&&(this._equirectMaterial=Ip());const _e=Y?this._cubemapMaterial:this._equirectMaterial,Le=new so(this._lodPlanes[0],_e);_e.uniforms.envMap.value=y;const qe=this._cubeSize;sd(b,0,0,3*qe,2*qe),D.setRenderTarget(b),D.render(Le,Ah)}_applyPMREM(y){const b=this._renderer,D=b.autoClear;b.autoClear=!1;for(let Y=1;Y<this._lodPlanes.length;Y++){const _e=Math.sqrt(this._sigmas[Y]*this._sigmas[Y]-this._sigmas[Y-1]*this._sigmas[Y-1]),Le=Mp[(Y-1)%Mp.length];this._blur(y,Y-1,Y,_e,Le)}b.autoClear=D}_blur(y,b,D,Y,_e){const Le=this._pingPongRenderTarget;this._halfBlur(y,Le,b,D,Y,"latitudinal",_e),this._halfBlur(Le,y,D,D,Y,"longitudinal",_e)}_halfBlur(y,b,D,Y,_e,Le,qe){const it=this._renderer,nt=this._blurMaterial;Le!=="latitudinal"&&Le!=="longitudinal"&&console.error("blur direction must be either latitudinal or longitudinal!");const mt=new so(this._lodPlanes[Y],nt),bt=nt.uniforms,At=this._sizeLods[D]-1,wt=isFinite(_e)?Math.PI/(2*At):2*Math.PI/39,Et=_e/wt,Mt=isFinite(_e)?1+Math.floor(3*Et):20;Mt>20&&console.warn(`sigmaRadians, ${_e}, is too large and will clip, as it requested ${Mt} samples when the maximum is set to 20`);const St=[];let Nt=0;for(let Yt=0;Yt<20;++Yt){const Kt=Yt/Et,Xt=Math.exp(-Kt*Kt/2);St.push(Xt),Yt===0?Nt+=Xt:Yt<Mt&&(Nt+=2*Xt)}for(let Yt=0;Yt<St.length;Yt++)St[Yt]=St[Yt]/Nt;bt.envMap.value=y.texture,bt.samples.value=Mt,bt.weights.value=St,bt.latitudinal.value=Le==="latitudinal",qe&&(bt.poleAxis.value=qe);const{_lodMax:It}=this;bt.dTheta.value=wt,bt.mipInt.value=It-D;const Rt=this._sizeLods[Y];sd(b,3*Rt*(Y>It-4?Y-It+4:0),4*(this._cubeSize-Rt),3*Rt,2*Rt),it.setRenderTarget(b),it.render(mt,Ah)}}function Pp(De,y,b){const D=new yo(De,y,b);return D.texture.mapping=dn,D.texture.name="PMREM.cubeUv",D.scissorTest=!0,D}function sd(De,y,b,D,Y){De.viewport.set(y,b,D,Y),De.scissor.set(y,b,D,Y)}function Ip(){return new hs({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:`

		precision mediump float;
		precision mediump int;

		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`,fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;

			#include <common>

			void main() {

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				gl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );

			}
		`,blending:Ve,depthTest:!1,depthWrite:!1})}function Rp(){return new hs({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:`

		precision mediump float;
		precision mediump int;

		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`,fragmentShader:`

			precision mediump float;
			precision mediump int;

			uniform float flipEnvMap;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			void main() {

				gl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );

			}
		`,blending:Ve,depthTest:!1,depthWrite:!1})}function cg(De){let y=new WeakMap,b=null;function D(Y){const _e=Y.target;_e.removeEventListener("dispose",D);const Le=y.get(_e);Le!==void 0&&(y.delete(_e),Le.dispose())}return{get:function(Y){if(Y&&Y.isTexture){const _e=Y.mapping,Le=_e===Ri||_e===Zi,qe=_e===xi||_e===mi;if(Le||qe){if(Y.isRenderTargetTexture&&Y.needsPMREMUpdate===!0){Y.needsPMREMUpdate=!1;let it=y.get(Y);return b===null&&(b=new xh(De)),it=Le?b.fromEquirectangular(Y,it):b.fromCubemap(Y,it),y.set(Y,it),it.texture}if(y.has(Y))return y.get(Y).texture;{const it=Y.image;if(Le&&it&&it.height>0||qe&&it&&function(nt){let mt=0;for(let bt=0;bt<6;bt++)nt[bt]!==void 0&&mt++;return mt===6}(it)){b===null&&(b=new xh(De));const nt=Le?b.fromEquirectangular(Y):b.fromCubemap(Y);return y.set(Y,nt),Y.addEventListener("dispose",D),nt.texture}return null}}}return Y},dispose:function(){y=new WeakMap,b!==null&&(b.dispose(),b=null)}}}function ug(De){const y={};function b(D){if(y[D]!==void 0)return y[D];let Y;switch(D){case"WEBGL_depth_texture":Y=De.getExtension("WEBGL_depth_texture")||De.getExtension("MOZ_WEBGL_depth_texture")||De.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":Y=De.getExtension("EXT_texture_filter_anisotropic")||De.getExtension("MOZ_EXT_texture_filter_anisotropic")||De.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":Y=De.getExtension("WEBGL_compressed_texture_s3tc")||De.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||De.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":Y=De.getExtension("WEBGL_compressed_texture_pvrtc")||De.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:Y=De.getExtension(D)}return y[D]=Y,Y}return{has:function(D){return b(D)!==null},init:function(D){D.isWebGL2?b("EXT_color_buffer_float"):(b("WEBGL_depth_texture"),b("OES_texture_float"),b("OES_texture_half_float"),b("OES_texture_half_float_linear"),b("OES_standard_derivatives"),b("OES_element_index_uint"),b("OES_vertex_array_object"),b("ANGLE_instanced_arrays")),b("OES_texture_float_linear"),b("EXT_color_buffer_half_float"),b("WEBGL_multisampled_render_to_texture")},get:function(D){const Y=b(D);return Y===null&&console.warn("THREE.WebGLRenderer: "+D+" extension not supported."),Y}}}function dg(De,y,b,D){const Y={},_e=new WeakMap;function Le(it){const nt=it.target;nt.index!==null&&y.remove(nt.index);for(const bt in nt.attributes)y.remove(nt.attributes[bt]);for(const bt in nt.morphAttributes){const At=nt.morphAttributes[bt];for(let wt=0,Et=At.length;wt<Et;wt++)y.remove(At[wt])}nt.removeEventListener("dispose",Le),delete Y[nt.id];const mt=_e.get(nt);mt&&(y.remove(mt),_e.delete(nt)),D.releaseStatesOfGeometry(nt),nt.isInstancedBufferGeometry===!0&&delete nt._maxInstanceCount,b.memory.geometries--}function qe(it){const nt=[],mt=it.index,bt=it.attributes.position;let At=0;if(mt!==null){const Mt=mt.array;At=mt.version;for(let St=0,Nt=Mt.length;St<Nt;St+=3){const It=Mt[St+0],Rt=Mt[St+1],Yt=Mt[St+2];nt.push(It,Rt,Rt,Yt,Yt,It)}}else{if(bt===void 0)return;{const Mt=bt.array;At=bt.version;for(let St=0,Nt=Mt.length/3-1;St<Nt;St+=3){const It=St+0,Rt=St+1,Yt=St+2;nt.push(It,Rt,Rt,Yt,Yt,It)}}}const wt=new(Ou(nt)?go:tr)(nt,1);wt.version=At;const Et=_e.get(it);Et&&y.remove(Et),_e.set(it,wt)}return{get:function(it,nt){return Y[nt.id]===!0||(nt.addEventListener("dispose",Le),Y[nt.id]=!0,b.memory.geometries++),nt},update:function(it){const nt=it.attributes;for(const bt in nt)y.update(nt[bt],De.ARRAY_BUFFER);const mt=it.morphAttributes;for(const bt in mt){const At=mt[bt];for(let wt=0,Et=At.length;wt<Et;wt++)y.update(At[wt],De.ARRAY_BUFFER)}},getWireframeAttribute:function(it){const nt=_e.get(it);if(nt){const mt=it.index;mt!==null&&nt.version<mt.version&&qe(it)}else qe(it);return _e.get(it)}}}function hg(De,y,b,D){const Y=D.isWebGL2;let _e,Le,qe;this.setMode=function(it){_e=it},this.setIndex=function(it){Le=it.type,qe=it.bytesPerElement},this.render=function(it,nt){De.drawElements(_e,nt,Le,it*qe),b.update(nt,_e,1)},this.renderInstances=function(it,nt,mt){if(mt===0)return;let bt,At;if(Y)bt=De,At="drawElementsInstanced";else if(bt=y.get("ANGLE_instanced_arrays"),At="drawElementsInstancedANGLE",bt===null)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");bt[At](_e,nt,Le,it*qe,mt),b.update(nt,_e,mt)}}function pg(De){const y={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:y,programs:null,autoReset:!0,reset:function(){y.calls=0,y.triangles=0,y.points=0,y.lines=0},update:function(b,D,Y){switch(y.calls++,D){case De.TRIANGLES:y.triangles+=Y*(b/3);break;case De.LINES:y.lines+=Y*(b/2);break;case De.LINE_STRIP:y.lines+=Y*(b-1);break;case De.LINE_LOOP:y.lines+=Y*b;break;case De.POINTS:y.points+=Y*b;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",D)}}}}function mg(De,y){return De[0]-y[0]}function fg(De,y){return Math.abs(y[1])-Math.abs(De[1])}function gg(De,y,b){const D={},Y=new Float32Array(8),_e=new WeakMap,Le=new Tr,qe=[];for(let it=0;it<8;it++)qe[it]=[it,0];return{update:function(it,nt,mt){const bt=it.morphTargetInfluences;if(y.isWebGL2===!0){const At=nt.morphAttributes.position||nt.morphAttributes.normal||nt.morphAttributes.color,wt=At!==void 0?At.length:0;let Et=_e.get(nt);if(Et===void 0||Et.count!==wt){let tn=function(){bi.dispose(),_e.delete(nt),nt.removeEventListener("dispose",tn)};Et!==void 0&&Et.texture.dispose();const Nt=nt.morphAttributes.position!==void 0,It=nt.morphAttributes.normal!==void 0,Rt=nt.morphAttributes.color!==void 0,Yt=nt.morphAttributes.position||[],Kt=nt.morphAttributes.normal||[],Xt=nt.morphAttributes.color||[];let oi=0;Nt===!0&&(oi=1),It===!0&&(oi=2),Rt===!0&&(oi=3);let wi=nt.attributes.position.count*oi,fi=1;wi>y.maxTextureSize&&(fi=Math.ceil(wi/y.maxTextureSize),wi=y.maxTextureSize);const yi=new Float32Array(wi*fi*4*wt),bi=new Dl(yi,wi,fi,wt);bi.type=Tn,bi.needsUpdate=!0;const Ci=4*oi;for(let $i=0;$i<wt;$i++){const gn=Yt[$i],xn=Kt[$i],Wi=Xt[$i],Oi=wi*fi*4*$i;for(let ki=0;ki<gn.count;ki++){const Hi=ki*Ci;Nt===!0&&(Le.fromBufferAttribute(gn,ki),yi[Oi+Hi+0]=Le.x,yi[Oi+Hi+1]=Le.y,yi[Oi+Hi+2]=Le.z,yi[Oi+Hi+3]=0),It===!0&&(Le.fromBufferAttribute(xn,ki),yi[Oi+Hi+4]=Le.x,yi[Oi+Hi+5]=Le.y,yi[Oi+Hi+6]=Le.z,yi[Oi+Hi+7]=0),Rt===!0&&(Le.fromBufferAttribute(Wi,ki),yi[Oi+Hi+8]=Le.x,yi[Oi+Hi+9]=Le.y,yi[Oi+Hi+10]=Le.z,yi[Oi+Hi+11]=Wi.itemSize===4?Le.w:1)}}Et={count:wt,texture:bi,size:new en(wi,fi)},_e.set(nt,Et),nt.addEventListener("dispose",tn)}let Mt=0;for(let Nt=0;Nt<bt.length;Nt++)Mt+=bt[Nt];const St=nt.morphTargetsRelative?1:1-Mt;mt.getUniforms().setValue(De,"morphTargetBaseInfluence",St),mt.getUniforms().setValue(De,"morphTargetInfluences",bt),mt.getUniforms().setValue(De,"morphTargetsTexture",Et.texture,b),mt.getUniforms().setValue(De,"morphTargetsTextureSize",Et.size)}else{const At=bt===void 0?0:bt.length;let wt=D[nt.id];if(wt===void 0||wt.length!==At){wt=[];for(let It=0;It<At;It++)wt[It]=[It,0];D[nt.id]=wt}for(let It=0;It<At;It++){const Rt=wt[It];Rt[0]=It,Rt[1]=bt[It]}wt.sort(fg);for(let It=0;It<8;It++)It<At&&wt[It][1]?(qe[It][0]=wt[It][0],qe[It][1]=wt[It][1]):(qe[It][0]=Number.MAX_SAFE_INTEGER,qe[It][1]=0);qe.sort(mg);const Et=nt.morphAttributes.position,Mt=nt.morphAttributes.normal;let St=0;for(let It=0;It<8;It++){const Rt=qe[It],Yt=Rt[0],Kt=Rt[1];Yt!==Number.MAX_SAFE_INTEGER&&Kt?(Et&&nt.getAttribute("morphTarget"+It)!==Et[Yt]&&nt.setAttribute("morphTarget"+It,Et[Yt]),Mt&&nt.getAttribute("morphNormal"+It)!==Mt[Yt]&&nt.setAttribute("morphNormal"+It,Mt[Yt]),Y[It]=Kt,St+=Kt):(Et&&nt.hasAttribute("morphTarget"+It)===!0&&nt.deleteAttribute("morphTarget"+It),Mt&&nt.hasAttribute("morphNormal"+It)===!0&&nt.deleteAttribute("morphNormal"+It),Y[It]=0)}const Nt=nt.morphTargetsRelative?1:1-St;mt.getUniforms().setValue(De,"morphTargetBaseInfluence",Nt),mt.getUniforms().setValue(De,"morphTargetInfluences",Y)}}}}function _g(De,y,b,D){let Y=new WeakMap;function _e(Le){const qe=Le.target;qe.removeEventListener("dispose",_e),b.remove(qe.instanceMatrix),qe.instanceColor!==null&&b.remove(qe.instanceColor)}return{update:function(Le){const qe=D.render.frame,it=Le.geometry,nt=y.get(Le,it);if(Y.get(nt)!==qe&&(y.update(nt),Y.set(nt,qe)),Le.isInstancedMesh&&(Le.hasEventListener("dispose",_e)===!1&&Le.addEventListener("dispose",_e),Y.get(Le)!==qe&&(b.update(Le.instanceMatrix,De.ARRAY_BUFFER),Le.instanceColor!==null&&b.update(Le.instanceColor,De.ARRAY_BUFFER),Y.set(Le,qe))),Le.isSkinnedMesh){const mt=Le.skeleton;Y.get(mt)!==qe&&(mt.update(),Y.set(mt,qe))}return nt},dispose:function(){Y=new WeakMap}}}const Dp=new Or,Bp=new Dl,Op=new kc,Lp=new Xc,Np=[],kp=[],Up=new Float32Array(16),Fp=new Float32Array(9),jp=new Float32Array(4);function Yl(De,y,b){const D=De[0];if(D<=0||D>0)return De;const Y=y*b;let _e=Np[Y];if(_e===void 0&&(_e=new Float32Array(Y),Np[Y]=_e),y!==0){D.toArray(_e,0);for(let Le=1,qe=0;Le!==y;++Le)qe+=b,De[Le].toArray(_e,qe)}return _e}function $r(De,y){if(De.length!==y.length)return!1;for(let b=0,D=De.length;b<D;b++)if(De[b]!==y[b])return!1;return!0}function Jr(De,y){for(let b=0,D=y.length;b<D;b++)De[b]=y[b]}function ad(De,y){let b=kp[y];b===void 0&&(b=new Int32Array(y),kp[y]=b);for(let D=0;D!==y;++D)b[D]=De.allocateTextureUnit();return b}function vg(De,y){const b=this.cache;b[0]!==y&&(De.uniform1f(this.addr,y),b[0]=y)}function yg(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y||(De.uniform2f(this.addr,y.x,y.y),b[0]=y.x,b[1]=y.y);else{if($r(b,y))return;De.uniform2fv(this.addr,y),Jr(b,y)}}function Ag(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y&&b[2]===y.z||(De.uniform3f(this.addr,y.x,y.y,y.z),b[0]=y.x,b[1]=y.y,b[2]=y.z);else if(y.r!==void 0)b[0]===y.r&&b[1]===y.g&&b[2]===y.b||(De.uniform3f(this.addr,y.r,y.g,y.b),b[0]=y.r,b[1]=y.g,b[2]=y.b);else{if($r(b,y))return;De.uniform3fv(this.addr,y),Jr(b,y)}}function bg(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y&&b[2]===y.z&&b[3]===y.w||(De.uniform4f(this.addr,y.x,y.y,y.z,y.w),b[0]=y.x,b[1]=y.y,b[2]=y.z,b[3]=y.w);else{if($r(b,y))return;De.uniform4fv(this.addr,y),Jr(b,y)}}function xg(De,y){const b=this.cache,D=y.elements;if(D===void 0){if($r(b,y))return;De.uniformMatrix2fv(this.addr,!1,y),Jr(b,y)}else{if($r(b,D))return;jp.set(D),De.uniformMatrix2fv(this.addr,!1,jp),Jr(b,D)}}function wg(De,y){const b=this.cache,D=y.elements;if(D===void 0){if($r(b,y))return;De.uniformMatrix3fv(this.addr,!1,y),Jr(b,y)}else{if($r(b,D))return;Fp.set(D),De.uniformMatrix3fv(this.addr,!1,Fp),Jr(b,D)}}function Eg(De,y){const b=this.cache,D=y.elements;if(D===void 0){if($r(b,y))return;De.uniformMatrix4fv(this.addr,!1,y),Jr(b,y)}else{if($r(b,D))return;Up.set(D),De.uniformMatrix4fv(this.addr,!1,Up),Jr(b,D)}}function Sg(De,y){const b=this.cache;b[0]!==y&&(De.uniform1i(this.addr,y),b[0]=y)}function Tg(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y||(De.uniform2i(this.addr,y.x,y.y),b[0]=y.x,b[1]=y.y);else{if($r(b,y))return;De.uniform2iv(this.addr,y),Jr(b,y)}}function Cg(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y&&b[2]===y.z||(De.uniform3i(this.addr,y.x,y.y,y.z),b[0]=y.x,b[1]=y.y,b[2]=y.z);else{if($r(b,y))return;De.uniform3iv(this.addr,y),Jr(b,y)}}function Mg(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y&&b[2]===y.z&&b[3]===y.w||(De.uniform4i(this.addr,y.x,y.y,y.z,y.w),b[0]=y.x,b[1]=y.y,b[2]=y.z,b[3]=y.w);else{if($r(b,y))return;De.uniform4iv(this.addr,y),Jr(b,y)}}function Pg(De,y){const b=this.cache;b[0]!==y&&(De.uniform1ui(this.addr,y),b[0]=y)}function Ig(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y||(De.uniform2ui(this.addr,y.x,y.y),b[0]=y.x,b[1]=y.y);else{if($r(b,y))return;De.uniform2uiv(this.addr,y),Jr(b,y)}}function Rg(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y&&b[2]===y.z||(De.uniform3ui(this.addr,y.x,y.y,y.z),b[0]=y.x,b[1]=y.y,b[2]=y.z);else{if($r(b,y))return;De.uniform3uiv(this.addr,y),Jr(b,y)}}function Dg(De,y){const b=this.cache;if(y.x!==void 0)b[0]===y.x&&b[1]===y.y&&b[2]===y.z&&b[3]===y.w||(De.uniform4ui(this.addr,y.x,y.y,y.z,y.w),b[0]=y.x,b[1]=y.y,b[2]=y.z,b[3]=y.w);else{if($r(b,y))return;De.uniform4uiv(this.addr,y),Jr(b,y)}}function Bg(De,y,b){const D=this.cache,Y=b.allocateTextureUnit();D[0]!==Y&&(De.uniform1i(this.addr,Y),D[0]=Y),b.setTexture2D(y||Dp,Y)}function Og(De,y,b){const D=this.cache,Y=b.allocateTextureUnit();D[0]!==Y&&(De.uniform1i(this.addr,Y),D[0]=Y),b.setTexture3D(y||Op,Y)}function Lg(De,y,b){const D=this.cache,Y=b.allocateTextureUnit();D[0]!==Y&&(De.uniform1i(this.addr,Y),D[0]=Y),b.setTextureCube(y||Lp,Y)}function Ng(De,y,b){const D=this.cache,Y=b.allocateTextureUnit();D[0]!==Y&&(De.uniform1i(this.addr,Y),D[0]=Y),b.setTexture2DArray(y||Bp,Y)}function kg(De,y){De.uniform1fv(this.addr,y)}function Ug(De,y){const b=Yl(y,this.size,2);De.uniform2fv(this.addr,b)}function Fg(De,y){const b=Yl(y,this.size,3);De.uniform3fv(this.addr,b)}function jg(De,y){const b=Yl(y,this.size,4);De.uniform4fv(this.addr,b)}function Gg(De,y){const b=Yl(y,this.size,4);De.uniformMatrix2fv(this.addr,!1,b)}function zg(De,y){const b=Yl(y,this.size,9);De.uniformMatrix3fv(this.addr,!1,b)}function Vg(De,y){const b=Yl(y,this.size,16);De.uniformMatrix4fv(this.addr,!1,b)}function Hg(De,y){De.uniform1iv(this.addr,y)}function Qg(De,y){De.uniform2iv(this.addr,y)}function Wg(De,y){De.uniform3iv(this.addr,y)}function qg(De,y){De.uniform4iv(this.addr,y)}function Xg(De,y){De.uniform1uiv(this.addr,y)}function Yg(De,y){De.uniform2uiv(this.addr,y)}function Kg(De,y){De.uniform3uiv(this.addr,y)}function $g(De,y){De.uniform4uiv(this.addr,y)}function Jg(De,y,b){const D=this.cache,Y=y.length,_e=ad(b,Y);$r(D,_e)||(De.uniform1iv(this.addr,_e),Jr(D,_e));for(let Le=0;Le!==Y;++Le)b.setTexture2D(y[Le]||Dp,_e[Le])}function Zg(De,y,b){const D=this.cache,Y=y.length,_e=ad(b,Y);$r(D,_e)||(De.uniform1iv(this.addr,_e),Jr(D,_e));for(let Le=0;Le!==Y;++Le)b.setTexture3D(y[Le]||Op,_e[Le])}function e_(De,y,b){const D=this.cache,Y=y.length,_e=ad(b,Y);$r(D,_e)||(De.uniform1iv(this.addr,_e),Jr(D,_e));for(let Le=0;Le!==Y;++Le)b.setTextureCube(y[Le]||Lp,_e[Le])}function t_(De,y,b){const D=this.cache,Y=y.length,_e=ad(b,Y);$r(D,_e)||(De.uniform1iv(this.addr,_e),Jr(D,_e));for(let Le=0;Le!==Y;++Le)b.setTexture2DArray(y[Le]||Bp,_e[Le])}class i_{constructor(y,b,D){this.id=y,this.addr=D,this.cache=[],this.setValue=function(Y){switch(Y){case 5126:return vg;case 35664:return yg;case 35665:return Ag;case 35666:return bg;case 35674:return xg;case 35675:return wg;case 35676:return Eg;case 5124:case 35670:return Sg;case 35667:case 35671:return Tg;case 35668:case 35672:return Cg;case 35669:case 35673:return Mg;case 5125:return Pg;case 36294:return Ig;case 36295:return Rg;case 36296:return Dg;case 35678:case 36198:case 36298:case 36306:case 35682:return Bg;case 35679:case 36299:case 36307:return Og;case 35680:case 36300:case 36308:case 36293:return Lg;case 36289:case 36303:case 36311:case 36292:return Ng}}(b.type)}}class n_{constructor(y,b,D){this.id=y,this.addr=D,this.cache=[],this.size=b.size,this.setValue=function(Y){switch(Y){case 5126:return kg;case 35664:return Ug;case 35665:return Fg;case 35666:return jg;case 35674:return Gg;case 35675:return zg;case 35676:return Vg;case 5124:case 35670:return Hg;case 35667:case 35671:return Qg;case 35668:case 35672:return Wg;case 35669:case 35673:return qg;case 5125:return Xg;case 36294:return Yg;case 36295:return Kg;case 36296:return $g;case 35678:case 36198:case 36298:case 36306:case 35682:return Jg;case 35679:case 36299:case 36307:return Zg;case 35680:case 36300:case 36308:case 36293:return e_;case 36289:case 36303:case 36311:case 36292:return t_}}(b.type)}}class r_{constructor(y){this.id=y,this.seq=[],this.map={}}setValue(y,b,D){const Y=this.seq;for(let _e=0,Le=Y.length;_e!==Le;++_e){const qe=Y[_e];qe.setValue(y,b[qe.id],D)}}}const wh=/(\w+)(\])?(\[|\.)?/g;function Gp(De,y){De.seq.push(y),De.map[y.id]=y}function o_(De,y,b){const D=De.name,Y=D.length;for(wh.lastIndex=0;;){const _e=wh.exec(D),Le=wh.lastIndex;let qe=_e[1];const it=_e[2]==="]",nt=_e[3];if(it&&(qe|=0),nt===void 0||nt==="["&&Le+2===Y){Gp(b,nt===void 0?new i_(qe,De,y):new n_(qe,De,y));break}{let mt=b.map[qe];mt===void 0&&(mt=new r_(qe),Gp(b,mt)),b=mt}}}class ld{constructor(y,b){this.seq=[],this.map={};const D=y.getProgramParameter(b,y.ACTIVE_UNIFORMS);for(let Y=0;Y<D;++Y){const _e=y.getActiveUniform(b,Y);o_(_e,y.getUniformLocation(b,_e.name),this)}}setValue(y,b,D,Y){const _e=this.map[b];_e!==void 0&&_e.setValue(y,D,Y)}setOptional(y,b,D){const Y=b[D];Y!==void 0&&this.setValue(y,D,Y)}static upload(y,b,D,Y){for(let _e=0,Le=b.length;_e!==Le;++_e){const qe=b[_e],it=D[qe.id];it.needsUpdate!==!1&&qe.setValue(y,it.value,Y)}}static seqWithValue(y,b){const D=[];for(let Y=0,_e=y.length;Y!==_e;++Y){const Le=y[Y];Le.id in b&&D.push(Le)}return D}}function zp(De,y,b){const D=De.createShader(y);return De.shaderSource(D,b),De.compileShader(D),D}let s_=0;function Vp(De,y,b){const D=De.getShaderParameter(y,De.COMPILE_STATUS),Y=De.getShaderInfoLog(y).trim();if(D&&Y==="")return"";const _e=/ERROR: 0:(\d+)/.exec(Y);if(_e){const Le=parseInt(_e[1]);return b.toUpperCase()+`

`+Y+`

`+function(qe,it){const nt=qe.split(`
`),mt=[],bt=Math.max(it-6,0),At=Math.min(it+6,nt.length);for(let wt=bt;wt<At;wt++){const Et=wt+1;mt.push(`${Et===it?">":" "} ${Et}: ${nt[wt]}`)}return mt.join(`
`)}(De.getShaderSource(y),Le)}return Y}function a_(De,y){let b;switch(y){case Fr:b="";break;case Rr:b="sRGBToLinear";break;case io:b="RGBM16ToLinear";break;default:console.warn("THREE.WebGLProgram: Unsupported color space:",y),b=""}return`vec4 ${De}( vec4 value ) { return ${b} ( value ); }`}function l_(De,y){const b=function(D){const Y=Sr.getPrimaries(Sr.workingColorSpace),_e=D===Cr||D===io?null:Sr.getPrimaries(D);let Le;switch(Y!==_e&&_e?Y===ra&&_e===kr?Le="LinearDisplayP3ToLinearSRGB":Y===kr&&_e===ra&&(Le="LinearSRGBToLinearDisplayP3"):Le="",D){case Cr:return["",""];case Fr:case Ls:return[Le,"LinearTransferOETF"];case Rr:case ka:return[Le,"sRGBTransferOETF"];case io:return["","LinearToRGBM16"];default:return console.warn("THREE.WebGLProgram: Unsupported color space:",D),[Le,"LinearTransferOETF"]}}(y);return`vec4 ${De}( vec4 value ) { return ${b[0]}( ${b[1]}( value ) ); }`}function c_(De,y){let b;switch(y){case Gi:b="Linear";break;case sn:b="Reinhard";break;case jt:b="OptimizedCineon";break;case Gt:b="ACESFilmic";break;case li:b="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",y),b="Linear"}return"vec3 "+De+"( vec3 color ) { return "+b+"ToneMapping( color ); }"}function Kc(De){return De!==""}function Hp(De,y){const b=y.numSpotLightShadows+y.numSpotLightMaps-y.numSpotLightShadowsWithMaps;return De.replace(/NUM_DIR_LIGHTS/g,y.numDirLights).replace(/NUM_SPOT_LIGHTS/g,y.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,y.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,b).replace(/NUM_RECT_AREA_LIGHTS/g,y.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,y.numPointLights).replace(/NUM_HEMI_LIGHTS/g,y.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,y.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,y.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,y.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,y.numPointLightShadows)}function Qp(De,y){return De.replace(/NUM_CLIPPING_PLANES/g,y.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,y.numClippingPlanes-y.numClipIntersection)}const u_=/^[ \t]*#include +<([\w\d./]+)>/gm;function Eh(De){return De.replace(u_,h_)}const d_=new Map([["encodings_fragment","colorspace_fragment"],["encodings_pars_fragment","colorspace_pars_fragment"],["output_fragment","opaque_fragment"]]);function h_(De,y){let b=ar[y];if(b===void 0){const D=d_.get(y);if(D===void 0)throw new Error("Can not resolve #include <"+y+">");b=ar[D],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',y,D)}return Eh(b)}const p_=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Wp(De){return De.replace(p_,m_)}function m_(De,y,b,D){let Y="";for(let _e=parseInt(y);_e<parseInt(b);_e++)Y+=D.replace(/\[\s*i\s*\]/g,"[ "+_e+" ]").replace(/UNROLLED_LOOP_INDEX/g,_e);return Y}function qp(De){let y="precision "+De.precision+` float;
precision `+De.precision+" int;";return De.precision==="highp"?y+=`
#define HIGH_PRECISION`:De.precision==="mediump"?y+=`
#define MEDIUM_PRECISION`:De.precision==="lowp"&&(y+=`
#define LOW_PRECISION`),y}function f_(De,y,b,D){const Y=De.getContext(),_e=b.defines;let Le=b.vertexShader,qe=b.fragmentShader;const it=function(fi){let yi="SHADOWMAP_TYPE_BASIC";return fi.shadowMapType===O?yi="SHADOWMAP_TYPE_PCF":fi.shadowMapType===ne?yi="SHADOWMAP_TYPE_PCF_SOFT":fi.shadowMapType===ce&&(yi="SHADOWMAP_TYPE_VSM"),yi}(b),nt=function(fi){let yi="ENVMAP_TYPE_CUBE";if(fi.envMap)switch(fi.envMapMode){case xi:case mi:yi="ENVMAP_TYPE_CUBE";break;case dn:yi="ENVMAP_TYPE_CUBE_UV"}return yi}(b),mt=function(fi){let yi="ENVMAP_MODE_REFLECTION";return fi.envMap&&fi.envMapMode===mi&&(yi="ENVMAP_MODE_REFRACTION"),yi}(b),bt=function(fi){let yi="ENVMAP_BLENDING_NONE";if(fi.envMap)switch(fi.combine){case Ln:yi="ENVMAP_BLENDING_MULTIPLY";break;case Nn:yi="ENVMAP_BLENDING_MIX";break;case Kn:yi="ENVMAP_BLENDING_ADD"}return yi}(b),At=function(fi){const yi=fi.envMapCubeUVHeight;if(yi===null)return null;const bi=Math.log2(yi)-2,Ci=1/yi;return{texelWidth:1/(3*Math.max(Math.pow(2,bi),112)),texelHeight:Ci,maxMip:bi}}(b),wt=b.isWebGL2?"":function(fi){return[fi.extensionDerivatives||fi.envMapCubeUVHeight||fi.bumpMap||fi.normalMapTangentSpace||fi.clearcoatNormalMap||fi.flatShading||fi.shaderID==="physical"?"#extension GL_OES_standard_derivatives : enable":"",(fi.extensionFragDepth||fi.logarithmicDepthBuffer)&&fi.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",fi.extensionDrawBuffers&&fi.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(fi.extensionShaderTextureLOD||fi.envMap||fi.transmission)&&fi.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Kc).join(`
`)}(b),Et=function(fi){const yi=[];for(const bi in fi){const Ci=fi[bi];Ci!==!1&&yi.push("#define "+bi+" "+Ci)}return yi.join(`
`)}(_e),Mt=Y.createProgram();let St,Nt,It=b.glslVersion?"#version "+b.glslVersion+`
`:"";b.isRawShaderMaterial?(St=["#define SHADER_TYPE "+b.shaderType,"#define SHADER_NAME "+b.shaderName,Et].filter(Kc).join(`
`),St.length>0&&(St+=`
`),Nt=[wt,"#define SHADER_TYPE "+b.shaderType,"#define SHADER_NAME "+b.shaderName,Et].filter(Kc).join(`
`),Nt.length>0&&(Nt+=`
`)):(St=[qp(b),"#define SHADER_TYPE "+b.shaderType,"#define SHADER_NAME "+b.shaderName,Et,b.instancing?"#define USE_INSTANCING":"",b.instancingColor?"#define USE_INSTANCING_COLOR":"",b.useFog&&b.fog?"#define USE_FOG":"",b.useFog&&b.fogExp2?"#define FOG_EXP2":"",b.map?"#define USE_MAP":"",b.envMap?"#define USE_ENVMAP":"",b.envMap?"#define "+mt:"",b.lightMap?"#define USE_LIGHTMAP":"",b.aoMap?"#define USE_AOMAP":"",b.bumpMap?"#define USE_BUMPMAP":"",b.normalMap?"#define USE_NORMALMAP":"",b.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",b.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",b.displacementMap?"#define USE_DISPLACEMENTMAP":"",b.emissiveMap?"#define USE_EMISSIVEMAP":"",b.anisotropy?"#define USE_ANISOTROPY":"",b.anisotropyMap?"#define USE_ANISOTROPYMAP":"",b.clearcoatMap?"#define USE_CLEARCOATMAP":"",b.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",b.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",b.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",b.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",b.specularMap?"#define USE_SPECULARMAP":"",b.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",b.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",b.roughnessMap?"#define USE_ROUGHNESSMAP":"",b.metalnessMap?"#define USE_METALNESSMAP":"",b.alphaMap?"#define USE_ALPHAMAP":"",b.alphaHash?"#define USE_ALPHAHASH":"",b.transmission?"#define USE_TRANSMISSION":"",b.transmissionMap?"#define USE_TRANSMISSIONMAP":"",b.thicknessMap?"#define USE_THICKNESSMAP":"",b.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",b.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",b.mapUv?"#define MAP_UV "+b.mapUv:"",b.alphaMapUv?"#define ALPHAMAP_UV "+b.alphaMapUv:"",b.lightMapUv?"#define LIGHTMAP_UV "+b.lightMapUv:"",b.aoMapUv?"#define AOMAP_UV "+b.aoMapUv:"",b.emissiveMapUv?"#define EMISSIVEMAP_UV "+b.emissiveMapUv:"",b.bumpMapUv?"#define BUMPMAP_UV "+b.bumpMapUv:"",b.normalMapUv?"#define NORMALMAP_UV "+b.normalMapUv:"",b.displacementMapUv?"#define DISPLACEMENTMAP_UV "+b.displacementMapUv:"",b.metalnessMapUv?"#define METALNESSMAP_UV "+b.metalnessMapUv:"",b.roughnessMapUv?"#define ROUGHNESSMAP_UV "+b.roughnessMapUv:"",b.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+b.anisotropyMapUv:"",b.clearcoatMapUv?"#define CLEARCOATMAP_UV "+b.clearcoatMapUv:"",b.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+b.clearcoatNormalMapUv:"",b.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+b.clearcoatRoughnessMapUv:"",b.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+b.iridescenceMapUv:"",b.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+b.iridescenceThicknessMapUv:"",b.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+b.sheenColorMapUv:"",b.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+b.sheenRoughnessMapUv:"",b.specularMapUv?"#define SPECULARMAP_UV "+b.specularMapUv:"",b.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+b.specularColorMapUv:"",b.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+b.specularIntensityMapUv:"",b.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+b.transmissionMapUv:"",b.thicknessMapUv?"#define THICKNESSMAP_UV "+b.thicknessMapUv:"",b.vertexTangents&&b.flatShading===!1?"#define USE_TANGENT":"",b.vertexColors?"#define USE_COLOR":"",b.vertexAlphas?"#define USE_COLOR_ALPHA":"",b.vertexUv1s?"#define USE_UV1":"",b.vertexUv2s?"#define USE_UV2":"",b.vertexUv3s?"#define USE_UV3":"",b.pointsUvs?"#define USE_POINTS_UV":"",b.flatShading?"#define FLAT_SHADED":"",b.skinning?"#define USE_SKINNING":"",b.morphTargets?"#define USE_MORPHTARGETS":"",b.morphNormals&&b.flatShading===!1?"#define USE_MORPHNORMALS":"",b.morphColors&&b.isWebGL2?"#define USE_MORPHCOLORS":"",b.morphTargetsCount>0&&b.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",b.morphTargetsCount>0&&b.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+b.morphTextureStride:"",b.morphTargetsCount>0&&b.isWebGL2?"#define MORPHTARGETS_COUNT "+b.morphTargetsCount:"",b.doubleSided?"#define DOUBLE_SIDED":"",b.flipSided?"#define FLIP_SIDED":"",b.shadowMapEnabled?"#define USE_SHADOWMAP":"",b.shadowMapEnabled?"#define "+it:"",b.sizeAttenuation?"#define USE_SIZEATTENUATION":"",b.numLightProbes>0?"#define USE_LIGHT_PROBES":"",b.useLegacyLights?"#define LEGACY_LIGHTS":"",b.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",b.logarithmicDepthBuffer&&b.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","	attribute vec2 uv1;","#endif","#ifdef USE_UV2","	attribute vec2 uv2;","#endif","#ifdef USE_UV3","	attribute vec2 uv3;","#endif","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","	attribute vec3 morphTarget0;","	attribute vec3 morphTarget1;","	attribute vec3 morphTarget2;","	attribute vec3 morphTarget3;","	#ifdef USE_MORPHNORMALS","		attribute vec3 morphNormal0;","		attribute vec3 morphNormal1;","		attribute vec3 morphNormal2;","		attribute vec3 morphNormal3;","	#else","		attribute vec3 morphTarget4;","		attribute vec3 morphTarget5;","		attribute vec3 morphTarget6;","		attribute vec3 morphTarget7;","	#endif","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
`].filter(Kc).join(`
`),Nt=[wt,qp(b),"#define SHADER_TYPE "+b.shaderType,"#define SHADER_NAME "+b.shaderName,Et,b.instancing?"#define USE_INSTANCING":"",b.instancingColor?"#define USE_INSTANCING_COLOR":"",b.useFog&&b.fog?"#define USE_FOG":"",b.useFog&&b.fogExp2?"#define FOG_EXP2":"",b.map?"#define USE_MAP":"",b.matcap?"#define USE_MATCAP":"",b.envMap?"#define USE_ENVMAP":"",b.envMap?"#define "+nt:"",b.envMap?"#define "+mt:"",b.envMap?"#define "+bt:"",At?"#define CUBEUV_TEXEL_WIDTH "+At.texelWidth:"",At?"#define CUBEUV_TEXEL_HEIGHT "+At.texelHeight:"",At?"#define CUBEUV_MAX_MIP "+At.maxMip+".0":"",b.lightMap?"#define USE_LIGHTMAP":"",b.aoMap?"#define USE_AOMAP":"",b.bumpMap?"#define USE_BUMPMAP":"",b.normalMap?"#define USE_NORMALMAP":"",b.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",b.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",b.emissiveMap?"#define USE_EMISSIVEMAP":"",b.anisotropy?"#define USE_ANISOTROPY":"",b.anisotropyMap?"#define USE_ANISOTROPYMAP":"",b.clearcoat?"#define USE_CLEARCOAT":"",b.clearcoatMap?"#define USE_CLEARCOATMAP":"",b.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",b.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",b.iridescence?"#define USE_IRIDESCENCE":"",b.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",b.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",b.specularMap?"#define USE_SPECULARMAP":"",b.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",b.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",b.roughnessMap?"#define USE_ROUGHNESSMAP":"",b.metalnessMap?"#define USE_METALNESSMAP":"",b.alphaMap?"#define USE_ALPHAMAP":"",b.alphaTest?"#define USE_ALPHATEST":"",b.alphaHash?"#define USE_ALPHAHASH":"",b.sheen?"#define USE_SHEEN":"",b.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",b.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",b.transmission?"#define USE_TRANSMISSION":"",b.transmissionMap?"#define USE_TRANSMISSIONMAP":"",b.thicknessMap?"#define USE_THICKNESSMAP":"",b.vertexTangents&&b.flatShading===!1?"#define USE_TANGENT":"",b.vertexColors||b.instancingColor?"#define USE_COLOR":"",b.vertexAlphas?"#define USE_COLOR_ALPHA":"",b.vertexUv1s?"#define USE_UV1":"",b.vertexUv2s?"#define USE_UV2":"",b.vertexUv3s?"#define USE_UV3":"",b.pointsUvs?"#define USE_POINTS_UV":"",b.gradientMap?"#define USE_GRADIENTMAP":"",b.flatShading?"#define FLAT_SHADED":"",b.doubleSided?"#define DOUBLE_SIDED":"",b.flipSided?"#define FLIP_SIDED":"",b.shadowMapEnabled?"#define USE_SHADOWMAP":"",b.shadowMapEnabled?"#define "+it:"",b.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",b.numLightProbes>0?"#define USE_LIGHT_PROBES":"",b.useLegacyLights?"#define LEGACY_LIGHTS":"",b.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",b.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",b.logarithmicDepthBuffer&&b.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",b.toneMapping!==_i?"#define TONE_MAPPING":"",b.toneMapping!==_i?ar.tonemapping_pars_fragment:"",b.toneMapping!==_i?c_("toneMapping",b.toneMapping):"",b.dithering?"#define DITHERING":"",b.opaque?"#define OPAQUE":"",ar.colorspace_pars_fragment,l_("linearToOutputTexel",b.outputColorSpace),b.transmissionSamplerMapEncoding?a_("transmissionSamplerMapTexelToLinear",b.transmissionSamplerMapEncoding):"",b.useDepthPacking?"#define DEPTH_PACKING "+b.depthPacking:"",`
`].filter(Kc).join(`
`)),Le=Eh(Le),Le=Hp(Le,b),Le=Qp(Le,b),qe=Eh(qe),qe=Hp(qe,b),qe=Qp(qe,b),Le=Wp(Le),qe=Wp(qe),b.isWebGL2&&b.isRawShaderMaterial!==!0&&(It=`#version 300 es
`,St=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join(`
`)+`
`+St,Nt=["#define varying in",b.glslVersion===Cc?"":"layout(location = 0) out highp vec4 pc_fragColor;",b.glslVersion===Cc?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad","#define WebGL2Context 1"].join(`
`)+`
`+Nt);const Rt=It+St+Le,Yt=It+Nt+qe,Kt=zp(Y,Y.VERTEX_SHADER,Rt),Xt=zp(Y,Y.FRAGMENT_SHADER,Yt);if(Y.attachShader(Mt,Kt),Y.attachShader(Mt,Xt),b.index0AttributeName!==void 0?Y.bindAttribLocation(Mt,0,b.index0AttributeName):b.morphTargets===!0&&Y.bindAttribLocation(Mt,0,"position"),Y.linkProgram(Mt),De.debug.checkShaderErrors){const fi=Y.getProgramInfoLog(Mt).trim(),yi=Y.getShaderInfoLog(Kt).trim(),bi=Y.getShaderInfoLog(Xt).trim();let Ci=!0,tn=!0;if(Y.getProgramParameter(Mt,Y.LINK_STATUS)===!1)if(Ci=!1,typeof De.debug.onShaderError=="function")De.debug.onShaderError(Y,Mt,Kt,Xt);else{const $i=Vp(Y,Kt,"vertex"),gn=Vp(Y,Xt,"fragment");console.error("THREE.WebGLProgram: Shader Error "+Y.getError()+" - VALIDATE_STATUS "+Y.getProgramParameter(Mt,Y.VALIDATE_STATUS)+`

Program Info Log: `+fi+`
`+$i+`
`+gn)}else fi!==""?console.warn("THREE.WebGLProgram: Program Info Log:",fi):yi!==""&&bi!==""||(tn=!1);tn&&(this.diagnostics={runnable:Ci,programLog:fi,vertexShader:{log:yi,prefix:St},fragmentShader:{log:bi,prefix:Nt}})}let oi,wi;return Y.deleteShader(Kt),Y.deleteShader(Xt),this.getUniforms=function(){return oi===void 0&&(oi=new ld(Y,Mt)),oi},this.getAttributes=function(){return wi===void 0&&(wi=function(fi,yi){const bi={},Ci=fi.getProgramParameter(yi,fi.ACTIVE_ATTRIBUTES);for(let tn=0;tn<Ci;tn++){const $i=fi.getActiveAttrib(yi,tn),gn=$i.name;let xn=1;$i.type===fi.FLOAT_MAT2&&(xn=2),$i.type===fi.FLOAT_MAT3&&(xn=3),$i.type===fi.FLOAT_MAT4&&(xn=4),bi[gn]={type:$i.type,location:fi.getAttribLocation(yi,gn),locationSize:xn}}return bi}(Y,Mt)),wi},this.destroy=function(){D.releaseStatesOfProgram(this),Y.deleteProgram(Mt),this.program=void 0},this.type=b.shaderType,this.name=b.shaderName,this.id=s_++,this.cacheKey=y,this.usedTimes=1,this.program=Mt,this.vertexShader=Kt,this.fragmentShader=Xt,this}let g_=0;class __{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(y){const b=y.vertexShader,D=y.fragmentShader,Y=this._getShaderStage(b),_e=this._getShaderStage(D),Le=this._getShaderCacheForMaterial(y);return Le.has(Y)===!1&&(Le.add(Y),Y.usedTimes++),Le.has(_e)===!1&&(Le.add(_e),_e.usedTimes++),this}remove(y){const b=this.materialCache.get(y);for(const D of b)D.usedTimes--,D.usedTimes===0&&this.shaderCache.delete(D.code);return this.materialCache.delete(y),this}getVertexShaderID(y){return this._getShaderStage(y.vertexShader).id}getFragmentShaderID(y){return this._getShaderStage(y.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(y){const b=this.materialCache;let D=b.get(y);return D===void 0&&(D=new Set,b.set(y,D)),D}_getShaderStage(y){const b=this.shaderCache;let D=b.get(y);return D===void 0&&(D=new v_(y),b.set(y,D)),D}}class v_{constructor(y){this.id=g_++,this.code=y,this.usedTimes=0}}function y_(De,y,b,D,Y,_e,Le){const qe=new Ul,it=new __,nt=[],mt=Y.isWebGL2,bt=Y.logarithmicDepthBuffer,At=Y.vertexTextures;let wt=Y.precision;const Et={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function Mt(St){return St===0?"uv":`uv${St}`}return{getParameters:function(St,Nt,It,Rt,Yt){const Kt=Rt.fog,Xt=Yt.geometry,oi=St.isMeshStandardMaterial?Rt.environment:null,wi=(St.isMeshStandardMaterial?b:y).get(St.envMap||oi),fi=wi&&wi.mapping===dn?wi.image.height:null,yi=Et[St.type];St.precision!==null&&(wt=Y.getMaxPrecision(St.precision),wt!==St.precision&&console.warn("THREE.WebGLProgram.getParameters:",St.precision,"not supported, using",wt,"instead."));const bi=Xt.morphAttributes.position||Xt.morphAttributes.normal||Xt.morphAttributes.color,Ci=bi!==void 0?bi.length:0;let tn,$i,gn,xn,Wi=0;if(Xt.morphAttributes.position!==void 0&&(Wi=1),Xt.morphAttributes.normal!==void 0&&(Wi=2),Xt.morphAttributes.color!==void 0&&(Wi=3),yi){const _u=Lo[yi];tn=_u.vertexShader,$i=_u.fragmentShader}else tn=St.vertexShader,$i=St.fragmentShader,it.update(St),gn=it.getVertexShaderID(St),xn=it.getFragmentShaderID(St);const Oi=De.getRenderTarget(),ki=De.userData&&De.userData.transmissionRenderTarget,Hi=Oi?Array.isArray(Oi.texture)?Oi.texture[0]:Oi.texture:null,Vi=Yt.isInstancedMesh===!0,Mn=!!St.map,Wn=!!St.matcap,zn=!!wi,Pn=!!St.aoMap,ir=!!St.lightMap,di=!!St.bumpMap,ei=!!St.normalMap,gi=!!St.displacementMap,Mi=!!St.emissiveMap,ui=!!St.metalnessMap,Qt=!!St.roughnessMap,hi=St.anisotropy>0,pi=St.clearcoat>0,Bi=St.iridescence>0,Ni=St.sheen>0,cn=St.transmission>0,Ji=hi&&!!St.anisotropyMap,lr=pi&&!!St.clearcoatMap,Qn=pi&&!!St.clearcoatNormalMap,mn=pi&&!!St.clearcoatRoughnessMap,Hn=Bi&&!!St.iridescenceMap,jn=Bi&&!!St.iridescenceThicknessMap,nr=Ni&&!!St.sheenColorMap,hr=Ni&&!!St.sheenRoughnessMap,Pr=!!St.specularMap,br=!!St.specularColorMap,Gn=!!St.specularIntensityMap,_r=cn&&!!St.transmissionMap,Wo=cn&&!!St.thicknessMap,rr=!!St.gradientMap,Lr=!!St.alphaMap,vr=St.alphaTest>0,Ys=!!St.alphaHash,Ks=!!St.extensions,ji=!!Xt.attributes.uv1,Jd=!!Xt.attributes.uv2,Zd=!!Xt.attributes.uv3;let wo=_i;return St.toneMapped&&(Oi!==null&&Oi.isXRRenderTarget!==!0||(wo=De.toneMapping)),{isWebGL2:mt,shaderID:yi,shaderType:St.type,shaderName:St.name,vertexShader:tn,fragmentShader:$i,defines:St.defines,customVertexShaderID:gn,customFragmentShaderID:xn,isRawShaderMaterial:St.isRawShaderMaterial===!0,glslVersion:St.glslVersion,precision:wt,instancing:Vi,instancingColor:Vi&&Yt.instanceColor!==null,supportsVertexTextures:At,outputColorSpace:Oi===null?De.outputColorSpace:Oi.isXRRenderTarget===!0||Hi.colorSpace&&Hi.colorSpace!==Rr?Hi.colorSpace:Fr,map:Mn,matcap:Wn,envMap:zn,envMapMode:zn&&wi.mapping,envMapCubeUVHeight:fi,aoMap:Pn,lightMap:ir,bumpMap:di,normalMap:ei,displacementMap:At&&gi,emissiveMap:Mi,normalMapObjectSpace:ei&&St.normalMapType===na,normalMapTangentSpace:ei&&St.normalMapType===Yo,metalnessMap:ui,roughnessMap:Qt,anisotropy:hi,anisotropyMap:Ji,clearcoat:pi,clearcoatMap:lr,clearcoatNormalMap:Qn,clearcoatRoughnessMap:mn,iridescence:Bi,iridescenceMap:Hn,iridescenceThicknessMap:jn,sheen:Ni,sheenColorMap:nr,sheenRoughnessMap:hr,specularMap:Pr,specularColorMap:br,specularIntensityMap:Gn,transmission:cn,transmissionMap:_r,thicknessMap:Wo,transmissionSamplerMapEncoding:ki&&ki.texture.colorSpace||Fr,gradientMap:rr,opaque:St.transparent===!1&&St.blending===tt&&!(St.transmission>0),alphaMap:Lr,alphaTest:vr,alphaHash:Ys,combine:St.combine,mapUv:Mn&&Mt(St.map.channel),aoMapUv:Pn&&Mt(St.aoMap.channel),lightMapUv:ir&&Mt(St.lightMap.channel),bumpMapUv:di&&Mt(St.bumpMap.channel),normalMapUv:ei&&Mt(St.normalMap.channel),displacementMapUv:gi&&Mt(St.displacementMap.channel),emissiveMapUv:Mi&&Mt(St.emissiveMap.channel),metalnessMapUv:ui&&Mt(St.metalnessMap.channel),roughnessMapUv:Qt&&Mt(St.roughnessMap.channel),anisotropyMapUv:Ji&&Mt(St.anisotropyMap.channel),clearcoatMapUv:lr&&Mt(St.clearcoatMap.channel),clearcoatNormalMapUv:Qn&&Mt(St.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:mn&&Mt(St.clearcoatRoughnessMap.channel),iridescenceMapUv:Hn&&Mt(St.iridescenceMap.channel),iridescenceThicknessMapUv:jn&&Mt(St.iridescenceThicknessMap.channel),sheenColorMapUv:nr&&Mt(St.sheenColorMap.channel),sheenRoughnessMapUv:hr&&Mt(St.sheenRoughnessMap.channel),specularMapUv:Pr&&Mt(St.specularMap.channel),specularColorMapUv:br&&Mt(St.specularColorMap.channel),specularIntensityMapUv:Gn&&Mt(St.specularIntensityMap.channel),transmissionMapUv:_r&&Mt(St.transmissionMap.channel),thicknessMapUv:Wo&&Mt(St.thicknessMap.channel),alphaMapUv:Lr&&Mt(St.alphaMap.channel),vertexTangents:!!Xt.attributes.tangent&&(ei||hi||Xt.userData.__forceUseTangent),vertexColors:St.vertexColors,vertexAlphas:St.vertexColors===!0&&!!Xt.attributes.color&&Xt.attributes.color.itemSize===4,vertexUv1s:ji,vertexUv2s:Jd,vertexUv3s:Zd,pointsUvs:Yt.isPoints===!0&&!!Xt.attributes.uv&&(Mn||Lr),fog:!!Kt,useFog:St.fog===!0,fogExp2:Kt&&Kt.isFogExp2,flatShading:St.flatShading===!0,sizeAttenuation:St.sizeAttenuation===!0,logarithmicDepthBuffer:bt,skinning:Yt.isSkinnedMesh===!0,morphTargets:Xt.morphAttributes.position!==void 0,morphNormals:Xt.morphAttributes.normal!==void 0,morphColors:Xt.morphAttributes.color!==void 0,morphTargetsCount:Ci,morphTextureStride:Wi,numDirLights:Nt.directional.length,numPointLights:Nt.point.length,numSpotLights:Nt.spot.length,numSpotLightMaps:Nt.spotLightMap.length,numRectAreaLights:Nt.rectArea.length,numHemiLights:Nt.hemi.length,numDirLightShadows:Nt.directionalShadowMap.length,numPointLightShadows:Nt.pointShadowMap.length,numSpotLightShadows:Nt.spotShadowMap.length,numSpotLightShadowsWithMaps:Nt.numSpotLightShadowsWithMaps,numLightProbes:Nt.numLightProbes,numClippingPlanes:Le.numPlanes,numClipIntersection:Le.numIntersection,dithering:St.dithering,shadowMapEnabled:De.shadowMap.enabled&&It.length>0,shadowMapType:De.shadowMap.type,toneMapping:wo,useLegacyLights:De._useLegacyLights,decodeVideoTexture:Mn&&St.map.isVideoTexture===!0&&Sr.getTransfer(St.map.colorSpace)===Dr,premultipliedAlpha:St.premultipliedAlpha,doubleSided:St.side===Oe,flipSided:St.side===ye,useDepthPacking:St.depthPacking>=0,depthPacking:St.depthPacking||0,index0AttributeName:St.index0AttributeName,extensionDerivatives:Ks&&St.extensions.derivatives===!0,extensionFragDepth:Ks&&St.extensions.fragDepth===!0,extensionDrawBuffers:Ks&&St.extensions.drawBuffers===!0,extensionShaderTextureLOD:Ks&&St.extensions.shaderTextureLOD===!0,rendererExtensionFragDepth:mt||D.has("EXT_frag_depth"),rendererExtensionDrawBuffers:mt||D.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:mt||D.has("EXT_shader_texture_lod"),customProgramCacheKey:St.customProgramCacheKey()}},getProgramCacheKey:function(St){const Nt=[];if(St.shaderID?Nt.push(St.shaderID):(Nt.push(St.customVertexShaderID),Nt.push(St.customFragmentShaderID)),St.defines!==void 0)for(const It in St.defines)Nt.push(It),Nt.push(St.defines[It]);return St.isRawShaderMaterial===!1&&(function(It,Rt){It.push(Rt.precision),It.push(Rt.outputColorSpace),It.push(Rt.envMapMode),It.push(Rt.envMapCubeUVHeight),It.push(Rt.mapUv),It.push(Rt.alphaMapUv),It.push(Rt.lightMapUv),It.push(Rt.aoMapUv),It.push(Rt.bumpMapUv),It.push(Rt.normalMapUv),It.push(Rt.displacementMapUv),It.push(Rt.emissiveMapUv),It.push(Rt.metalnessMapUv),It.push(Rt.roughnessMapUv),It.push(Rt.anisotropyMapUv),It.push(Rt.clearcoatMapUv),It.push(Rt.clearcoatNormalMapUv),It.push(Rt.clearcoatRoughnessMapUv),It.push(Rt.iridescenceMapUv),It.push(Rt.iridescenceThicknessMapUv),It.push(Rt.sheenColorMapUv),It.push(Rt.sheenRoughnessMapUv),It.push(Rt.specularMapUv),It.push(Rt.specularColorMapUv),It.push(Rt.specularIntensityMapUv),It.push(Rt.transmissionMapUv),It.push(Rt.thicknessMapUv),It.push(Rt.combine),It.push(Rt.fogExp2),It.push(Rt.sizeAttenuation),It.push(Rt.morphTargetsCount),It.push(Rt.morphAttributeCount),It.push(Rt.numDirLights),It.push(Rt.numPointLights),It.push(Rt.numSpotLights),It.push(Rt.numSpotLightMaps),It.push(Rt.numHemiLights),It.push(Rt.numRectAreaLights),It.push(Rt.numDirLightShadows),It.push(Rt.numPointLightShadows),It.push(Rt.numSpotLightShadows),It.push(Rt.numSpotLightShadowsWithMaps),It.push(Rt.numLightProbes),It.push(Rt.shadowMapType),It.push(Rt.toneMapping),It.push(Rt.numClippingPlanes),It.push(Rt.numClipIntersection),It.push(Rt.depthPacking)}(Nt,St),function(It,Rt){qe.disableAll(),Rt.isWebGL2&&qe.enable(0),Rt.supportsVertexTextures&&qe.enable(1),Rt.instancing&&qe.enable(2),Rt.instancingColor&&qe.enable(3),Rt.matcap&&qe.enable(4),Rt.envMap&&qe.enable(5),Rt.normalMapObjectSpace&&qe.enable(6),Rt.normalMapTangentSpace&&qe.enable(7),Rt.clearcoat&&qe.enable(8),Rt.iridescence&&qe.enable(9),Rt.alphaTest&&qe.enable(10),Rt.vertexColors&&qe.enable(11),Rt.vertexAlphas&&qe.enable(12),Rt.vertexUv1s&&qe.enable(13),Rt.vertexUv2s&&qe.enable(14),Rt.vertexUv3s&&qe.enable(15),Rt.vertexTangents&&qe.enable(16),Rt.anisotropy&&qe.enable(17),It.push(qe.mask),qe.disableAll(),Rt.fog&&qe.enable(0),Rt.useFog&&qe.enable(1),Rt.flatShading&&qe.enable(2),Rt.logarithmicDepthBuffer&&qe.enable(3),Rt.skinning&&qe.enable(4),Rt.morphTargets&&qe.enable(5),Rt.morphNormals&&qe.enable(6),Rt.morphColors&&qe.enable(7),Rt.premultipliedAlpha&&qe.enable(8),Rt.shadowMapEnabled&&qe.enable(9),Rt.useLegacyLights&&qe.enable(10),Rt.doubleSided&&qe.enable(11),Rt.flipSided&&qe.enable(12),Rt.useDepthPacking&&qe.enable(13),Rt.dithering&&qe.enable(14),Rt.transmission&&qe.enable(15),Rt.sheen&&qe.enable(16),Rt.opaque&&qe.enable(17),Rt.pointsUvs&&qe.enable(18),Rt.decodeVideoTexture&&qe.enable(19),It.push(qe.mask)}(Nt,St),Nt.push(De.outputColorSpace)),Nt.push(St.customProgramCacheKey),Nt.join()},getUniforms:function(St){const Nt=Et[St.type];let It;if(Nt){const Rt=Lo[Nt];It=xp.clone(Rt.uniforms)}else It=St.uniforms;return It},acquireProgram:function(St,Nt){let It;for(let Rt=0,Yt=nt.length;Rt<Yt;Rt++){const Kt=nt[Rt];if(Kt.cacheKey===Nt){It=Kt,++It.usedTimes;break}}return It===void 0&&(It=new f_(De,Nt,St,_e),nt.push(It)),It},releaseProgram:function(St){if(--St.usedTimes==0){const Nt=nt.indexOf(St);nt[Nt]=nt[nt.length-1],nt.pop(),St.destroy()}},releaseShaderCache:function(St){it.remove(St)},programs:nt,dispose:function(){it.dispose()}}}function A_(){let De=new WeakMap;return{get:function(y){let b=De.get(y);return b===void 0&&(b={},De.set(y,b)),b},remove:function(y){De.delete(y)},update:function(y,b,D){De.get(y)[b]=D},dispose:function(){De=new WeakMap}}}function b_(De,y){return De.groupOrder!==y.groupOrder?De.groupOrder-y.groupOrder:De.renderOrder!==y.renderOrder?De.renderOrder-y.renderOrder:De.material.id!==y.material.id?De.material.id-y.material.id:De.z!==y.z?De.z-y.z:De.id-y.id}function Xp(De,y){return De.groupOrder!==y.groupOrder?De.groupOrder-y.groupOrder:De.renderOrder!==y.renderOrder?De.renderOrder-y.renderOrder:De.z!==y.z?y.z-De.z:De.id-y.id}function Yp(){const De=[];let y=0;const b=[],D=[],Y=[];function _e(Le,qe,it,nt,mt,bt){let At=De[y];return At===void 0?(At={id:Le.id,object:Le,geometry:qe,material:it,groupOrder:nt,renderOrder:Le.renderOrder,z:mt,group:bt},De[y]=At):(At.id=Le.id,At.object=Le,At.geometry=qe,At.material=it,At.groupOrder=nt,At.renderOrder=Le.renderOrder,At.z=mt,At.group=bt),y++,At}return{opaque:b,transmissive:D,transparent:Y,init:function(){y=0,b.length=0,D.length=0,Y.length=0},push:function(Le,qe,it,nt,mt,bt){const At=_e(Le,qe,it,nt,mt,bt);it.transmission>0?D.push(At):it.transparent===!0?Y.push(At):b.push(At)},unshift:function(Le,qe,it,nt,mt,bt){const At=_e(Le,qe,it,nt,mt,bt);it.transmission>0?D.unshift(At):it.transparent===!0?Y.unshift(At):b.unshift(At)},finish:function(){for(let Le=y,qe=De.length;Le<qe;Le++){const it=De[Le];if(it.id===null)break;it.id=null,it.object=null,it.geometry=null,it.material=null,it.group=null}},sort:function(Le,qe){b.length>1&&b.sort(Le||b_),D.length>1&&D.sort(qe||Xp),Y.length>1&&Y.sort(qe||Xp)}}}function x_(){let De=new WeakMap;return{get:function(y,b){const D=De.get(y);let Y;return D===void 0?(Y=new Yp,De.set(y,[Y])):b>=D.length?(Y=new Yp,D.push(Y)):Y=D[b],Y},dispose:function(){De=new WeakMap}}}function w_(){const De={};return{get:function(y){if(De[y.id]!==void 0)return De[y.id];let b;switch(y.type){case"DirectionalLight":b={direction:new ii,color:new Dn};break;case"SpotLight":b={position:new ii,direction:new ii,color:new Dn,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":b={position:new ii,color:new Dn,distance:0,decay:0};break;case"HemisphereLight":b={direction:new ii,skyColor:new Dn,groundColor:new Dn};break;case"RectAreaLight":b={color:new Dn,position:new ii,halfWidth:new ii,halfHeight:new ii}}return De[y.id]=b,b}}}let E_=0;function S_(De,y){return(y.castShadow?2:0)-(De.castShadow?2:0)+(y.map?1:0)-(De.map?1:0)}function T_(De,y){const b=new w_,D=function(){const it={};return{get:function(nt){if(it[nt.id]!==void 0)return it[nt.id];let mt;switch(nt.type){case"DirectionalLight":case"SpotLight":mt={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new en};break;case"PointLight":mt={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new en,shadowCameraNear:1,shadowCameraFar:1e3}}return it[nt.id]=mt,mt}}}(),Y={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let it=0;it<9;it++)Y.probe.push(new ii);const _e=new ii,Le=new Xn,qe=new Xn;return{setup:function(it,nt){let mt=0,bt=0,At=0;for(let yi=0;yi<9;yi++)Y.probe[yi].set(0,0,0);let wt=0,Et=0,Mt=0,St=0,Nt=0,It=0,Rt=0,Yt=0,Kt=0,Xt=0,oi=0;it.sort(S_);const wi=nt===!0?Math.PI:1;for(let yi=0,bi=it.length;yi<bi;yi++){const Ci=it[yi],tn=Ci.color,$i=Ci.intensity,gn=Ci.distance,xn=Ci.shadow&&Ci.shadow.map?Ci.shadow.map.texture:null;if(Ci.isAmbientLight)mt+=tn.r*$i*wi,bt+=tn.g*$i*wi,At+=tn.b*$i*wi;else if(Ci.isLightProbe){for(let Wi=0;Wi<9;Wi++)Y.probe[Wi].addScaledVector(Ci.sh.coefficients[Wi],$i);oi++}else if(Ci.isDirectionalLight){const Wi=b.get(Ci);if(Wi.color.copy(Ci.color).multiplyScalar(Ci.intensity*wi),Ci.castShadow){const Oi=Ci.shadow,ki=D.get(Ci);ki.shadowBias=Oi.bias,ki.shadowNormalBias=Oi.normalBias,ki.shadowRadius=Oi.radius,ki.shadowMapSize=Oi.mapSize,Y.directionalShadow[wt]=ki,Y.directionalShadowMap[wt]=xn,Y.directionalShadowMatrix[wt]=Ci.shadow.matrix,It++}Y.directional[wt]=Wi,wt++}else if(Ci.isSpotLight){const Wi=b.get(Ci);Wi.position.setFromMatrixPosition(Ci.matrixWorld),Wi.color.copy(tn).multiplyScalar($i*wi),Wi.distance=gn,Wi.coneCos=Math.cos(Ci.angle),Wi.penumbraCos=Math.cos(Ci.angle*(1-Ci.penumbra)),Wi.decay=Ci.decay,Y.spot[Mt]=Wi;const Oi=Ci.shadow;if(Ci.map&&(Y.spotLightMap[Kt]=Ci.map,Kt++,Oi.updateMatrices(Ci),Ci.castShadow&&Xt++),Y.spotLightMatrix[Mt]=Oi.matrix,Ci.castShadow){const ki=D.get(Ci);ki.shadowBias=Oi.bias,ki.shadowNormalBias=Oi.normalBias,ki.shadowRadius=Oi.radius,ki.shadowMapSize=Oi.mapSize,Y.spotShadow[Mt]=ki,Y.spotShadowMap[Mt]=xn,Yt++}Mt++}else if(Ci.isRectAreaLight){const Wi=b.get(Ci);Wi.color.copy(tn).multiplyScalar($i),Wi.halfWidth.set(.5*Ci.width,0,0),Wi.halfHeight.set(0,.5*Ci.height,0),Y.rectArea[St]=Wi,St++}else if(Ci.isPointLight){const Wi=b.get(Ci);if(Wi.color.copy(Ci.color).multiplyScalar(Ci.intensity*wi),Wi.distance=Ci.distance,Wi.decay=Ci.decay,Ci.castShadow){const Oi=Ci.shadow,ki=D.get(Ci);ki.shadowBias=Oi.bias,ki.shadowNormalBias=Oi.normalBias,ki.shadowRadius=Oi.radius,ki.shadowMapSize=Oi.mapSize,ki.shadowCameraNear=Oi.camera.near,ki.shadowCameraFar=Oi.camera.far,Y.pointShadow[Et]=ki,Y.pointShadowMap[Et]=xn,Y.pointShadowMatrix[Et]=Ci.shadow.matrix,Rt++}Y.point[Et]=Wi,Et++}else if(Ci.isHemisphereLight){const Wi=b.get(Ci);Wi.skyColor.copy(Ci.color).multiplyScalar($i*wi),Wi.groundColor.copy(Ci.groundColor).multiplyScalar($i*wi),Y.hemi[Nt]=Wi,Nt++}}St>0&&(y.isWebGL2||De.has("OES_texture_float_linear")===!0?(Y.rectAreaLTC1=bn.LTC_FLOAT_1,Y.rectAreaLTC2=bn.LTC_FLOAT_2):De.has("OES_texture_half_float_linear")===!0?(Y.rectAreaLTC1=bn.LTC_HALF_1,Y.rectAreaLTC2=bn.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),Y.ambient[0]=mt,Y.ambient[1]=bt,Y.ambient[2]=At;const fi=Y.hash;fi.directionalLength===wt&&fi.pointLength===Et&&fi.spotLength===Mt&&fi.rectAreaLength===St&&fi.hemiLength===Nt&&fi.numDirectionalShadows===It&&fi.numPointShadows===Rt&&fi.numSpotShadows===Yt&&fi.numSpotMaps===Kt&&fi.numLightProbes===oi||(Y.directional.length=wt,Y.spot.length=Mt,Y.rectArea.length=St,Y.point.length=Et,Y.hemi.length=Nt,Y.directionalShadow.length=It,Y.directionalShadowMap.length=It,Y.pointShadow.length=Rt,Y.pointShadowMap.length=Rt,Y.spotShadow.length=Yt,Y.spotShadowMap.length=Yt,Y.directionalShadowMatrix.length=It,Y.pointShadowMatrix.length=Rt,Y.spotLightMatrix.length=Yt+Kt-Xt,Y.spotLightMap.length=Kt,Y.numSpotLightShadowsWithMaps=Xt,Y.numLightProbes=oi,fi.directionalLength=wt,fi.pointLength=Et,fi.spotLength=Mt,fi.rectAreaLength=St,fi.hemiLength=Nt,fi.numDirectionalShadows=It,fi.numPointShadows=Rt,fi.numSpotShadows=Yt,fi.numSpotMaps=Kt,fi.numLightProbes=oi,Y.version=E_++)},setupView:function(it,nt){let mt=0,bt=0,At=0,wt=0,Et=0;const Mt=nt.matrixWorldInverse;for(let St=0,Nt=it.length;St<Nt;St++){const It=it[St];if(It.isDirectionalLight){const Rt=Y.directional[mt];Rt.direction.setFromMatrixPosition(It.matrixWorld),_e.setFromMatrixPosition(It.target.matrixWorld),Rt.direction.sub(_e),Rt.direction.transformDirection(Mt),mt++}else if(It.isSpotLight){const Rt=Y.spot[At];Rt.position.setFromMatrixPosition(It.matrixWorld),Rt.position.applyMatrix4(Mt),Rt.direction.setFromMatrixPosition(It.matrixWorld),_e.setFromMatrixPosition(It.target.matrixWorld),Rt.direction.sub(_e),Rt.direction.transformDirection(Mt),At++}else if(It.isRectAreaLight){const Rt=Y.rectArea[wt];Rt.position.setFromMatrixPosition(It.matrixWorld),Rt.position.applyMatrix4(Mt),qe.identity(),Le.copy(It.matrixWorld),Le.premultiply(Mt),qe.extractRotation(Le),Rt.halfWidth.set(.5*It.width,0,0),Rt.halfHeight.set(0,.5*It.height,0),Rt.halfWidth.applyMatrix4(qe),Rt.halfHeight.applyMatrix4(qe),wt++}else if(It.isPointLight){const Rt=Y.point[bt];Rt.position.setFromMatrixPosition(It.matrixWorld),Rt.position.applyMatrix4(Mt),bt++}else if(It.isHemisphereLight){const Rt=Y.hemi[Et];Rt.direction.setFromMatrixPosition(It.matrixWorld),Rt.direction.transformDirection(Mt),Et++}}},state:Y}}function Kp(De,y){const b=new T_(De,y),D=[],Y=[];return{init:function(){D.length=0,Y.length=0},state:{lightsArray:D,shadowsArray:Y,lights:b},setupLights:function(_e){b.setup(D,_e)},setupLightsView:function(_e){b.setupView(D,_e)},pushLight:function(_e){D.push(_e)},pushShadow:function(_e){Y.push(_e)}}}function C_(De,y){let b=new WeakMap;return{get:function(D,Y=0){const _e=b.get(D);let Le;return _e===void 0?(Le=new Kp(De,y),b.set(D,[Le])):Y>=_e.length?(Le=new Kp(De,y),_e.push(Le)):Le=_e[Y],Le},dispose:function(){b=new WeakMap}}}class Sh extends no{constructor(y){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=Na,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(y)}copy(y){return super.copy(y),this.depthPacking=y.depthPacking,this.map=y.map,this.alphaMap=y.alphaMap,this.displacementMap=y.displacementMap,this.displacementScale=y.displacementScale,this.displacementBias=y.displacementBias,this.wireframe=y.wireframe,this.wireframeLinewidth=y.wireframeLinewidth,this}}class Th extends no{constructor(y){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(y)}copy(y){return super.copy(y),this.map=y.map,this.alphaMap=y.alphaMap,this.displacementMap=y.displacementMap,this.displacementScale=y.displacementScale,this.displacementBias=y.displacementBias,this}}function M_(De,y,b){let D=new nd;const Y=new en,_e=new en,Le=new Tr,qe=new Sh({depthPacking:xc}),it=new Th,nt={},mt=b.maxTextureSize,bt={[ue]:ye,[ye]:ue,[Oe]:Oe},At=new hs({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new en},radius:{value:4}},vertexShader:`void main() {
	gl_Position = vec4( position, 1.0 );
}`,fragmentShader:`uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;
#include <packing>
void main() {
	const float samples = float( VSM_SAMPLES );
	float mean = 0.0;
	float squared_mean = 0.0;
	float uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );
	float uvStart = samples <= 1.0 ? 0.0 : - 1.0;
	for ( float i = 0.0; i < samples; i ++ ) {
		float uvOffset = uvStart + i * uvStride;
		#ifdef HORIZONTAL_PASS
			vec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );
			mean += distribution.x;
			squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;
		#else
			float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );
			mean += depth;
			squared_mean += depth * depth;
		#endif
	}
	mean = mean / samples;
	squared_mean = squared_mean / samples;
	float std_dev = sqrt( squared_mean - mean * mean );
	gl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );
}`}),wt=At.clone();wt.defines.HORIZONTAL_PASS=1;const Et=new dr;Et.setAttribute("position",new zt(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const Mt=new so(Et,At),St=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=O;let Nt=this.type;function It(Kt,Xt){const oi=y.update(Mt);At.defines.VSM_SAMPLES!==Kt.blurSamples&&(At.defines.VSM_SAMPLES=Kt.blurSamples,wt.defines.VSM_SAMPLES=Kt.blurSamples,At.needsUpdate=!0,wt.needsUpdate=!0),Kt.mapPass===null&&(Kt.mapPass=new yo(Y.x,Y.y)),At.uniforms.shadow_pass.value=Kt.map.texture,At.uniforms.resolution.value=Kt.mapSize,At.uniforms.radius.value=Kt.radius,De.setRenderTarget(Kt.mapPass),De.clear(),De.renderBufferDirect(Xt,null,oi,At,Mt,null),wt.uniforms.shadow_pass.value=Kt.mapPass.texture,wt.uniforms.resolution.value=Kt.mapSize,wt.uniforms.radius.value=Kt.radius,De.setRenderTarget(Kt.map),De.clear(),De.renderBufferDirect(Xt,null,oi,wt,Mt,null)}function Rt(Kt,Xt,oi,wi){let fi=null;const yi=oi.isPointLight===!0?Kt.customDistanceMaterial:Kt.customDepthMaterial;if(yi!==void 0)fi=yi;else if(fi=oi.isPointLight===!0?it:qe,De.localClippingEnabled&&Xt.clipShadows===!0&&Array.isArray(Xt.clippingPlanes)&&Xt.clippingPlanes.length!==0||Xt.displacementMap&&Xt.displacementScale!==0||Xt.alphaMap&&Xt.alphaTest>0||Xt.map&&Xt.alphaTest>0){const bi=fi.uuid,Ci=Xt.uuid;let tn=nt[bi];tn===void 0&&(tn={},nt[bi]=tn);let $i=tn[Ci];$i===void 0&&($i=fi.clone(),tn[Ci]=$i),fi=$i}return fi.visible=Xt.visible,fi.wireframe=Xt.wireframe,fi.side=wi===ce?Xt.shadowSide!==null?Xt.shadowSide:Xt.side:Xt.shadowSide!==null?Xt.shadowSide:bt[Xt.side],fi.alphaMap=Xt.alphaMap,fi.alphaTest=Xt.alphaTest,fi.map=Xt.map,fi.clipShadows=Xt.clipShadows,fi.clippingPlanes=Xt.clippingPlanes,fi.clipIntersection=Xt.clipIntersection,fi.displacementMap=Xt.displacementMap,fi.displacementScale=Xt.displacementScale,fi.displacementBias=Xt.displacementBias,fi.wireframeLinewidth=Xt.wireframeLinewidth,fi.linewidth=Xt.linewidth,oi.isPointLight===!0&&fi.isMeshDistanceMaterial===!0&&(De.properties.get(fi).light=oi),fi}function Yt(Kt,Xt,oi,wi,fi){if(Kt.visible===!1)return;if(Kt.layers.test(Xt.layers)&&(Kt.isMesh||Kt.isLine||Kt.isPoints)&&(Kt.castShadow||Kt.receiveShadow&&fi===ce)&&(!Kt.frustumCulled||D.intersectsObject(Kt))){Kt.modelViewMatrix.multiplyMatrices(oi.matrixWorldInverse,Kt.matrixWorld);const bi=y.update(Kt),Ci=Kt.material;if(Array.isArray(Ci)){const tn=bi.groups;for(let $i=0,gn=tn.length;$i<gn;$i++){const xn=tn[$i],Wi=Ci[xn.materialIndex];if(Wi&&Wi.visible){const Oi=Rt(Kt,Wi,wi,fi);De.renderBufferDirect(oi,null,bi,Oi,Kt,xn)}}}else if(Ci.visible){const tn=Rt(Kt,Ci,wi,fi);De.renderBufferDirect(oi,null,bi,tn,Kt,null)}}const yi=Kt.children;for(let bi=0,Ci=yi.length;bi<Ci;bi++)Yt(yi[bi],Xt,oi,wi,fi)}this.render=function(Kt,Xt,oi){if(St.enabled===!1||St.autoUpdate===!1&&St.needsUpdate===!1||Kt.length===0)return;const wi=De.getRenderTarget(),fi=De.getActiveCubeFace(),yi=De.getActiveMipmapLevel(),bi=De.state;bi.setBlending(Ve),bi.buffers.color.setClear(1,1,1,1),bi.buffers.depth.setTest(!0),bi.setScissorTest(!1);const Ci=Nt!==ce&&this.type===ce,tn=Nt===ce&&this.type!==ce;for(let $i=0,gn=Kt.length;$i<gn;$i++){const xn=Kt[$i],Wi=xn.shadow;if(Wi===void 0){console.warn("THREE.WebGLShadowMap:",xn,"has no shadow.");continue}if(Wi.autoUpdate===!1&&Wi.needsUpdate===!1)continue;Y.copy(Wi.mapSize);const Oi=Wi.getFrameExtents();if(Y.multiply(Oi),_e.copy(Wi.mapSize),(Y.x>mt||Y.y>mt)&&(Y.x>mt&&(_e.x=Math.floor(mt/Oi.x),Y.x=_e.x*Oi.x,Wi.mapSize.x=_e.x),Y.y>mt&&(_e.y=Math.floor(mt/Oi.y),Y.y=_e.y*Oi.y,Wi.mapSize.y=_e.y)),Wi.map===null||Ci===!0||tn===!0){const Hi=this.type!==ce?{minFilter:Yi,magFilter:Yi}:{};Wi.map!==null&&Wi.map.dispose(),Wi.map=new yo(Y.x,Y.y,Hi),Wi.map.texture.name=xn.name+".shadowMap",Wi.camera.updateProjectionMatrix()}De.setRenderTarget(Wi.map),De.clear();const ki=Wi.getViewportCount();for(let Hi=0;Hi<ki;Hi++){const Vi=Wi.getViewport(Hi);Le.set(_e.x*Vi.x,_e.y*Vi.y,_e.x*Vi.z,_e.y*Vi.w),bi.viewport(Le),Wi.updateMatrices(xn,Hi),D=Wi.getFrustum(),Yt(Xt,oi,Wi.camera,xn,this.type)}Wi.isPointLightShadow!==!0&&this.type===ce&&It(Wi,oi),Wi.needsUpdate=!1}Nt=this.type,St.needsUpdate=!1,De.setRenderTarget(wi,fi,yi)}}function P_(De,y,b){const D=b.isWebGL2,Y=new function(){let Qt=!1;const hi=new Tr;let pi=null;const Bi=new Tr(0,0,0,0);return{setMask:function(Ni){pi===Ni||Qt||(De.colorMask(Ni,Ni,Ni,Ni),pi=Ni)},setLocked:function(Ni){Qt=Ni},setClear:function(Ni,cn,Ji,lr,Qn){Qn===!0&&(Ni*=lr,cn*=lr,Ji*=lr),hi.set(Ni,cn,Ji,lr),Bi.equals(hi)===!1&&(De.clearColor(Ni,cn,Ji,lr),Bi.copy(hi))},reset:function(){Qt=!1,pi=null,Bi.set(-1,0,0,0)}}},_e=new function(){let Qt=!1,hi=null,pi=null,Bi=null;return{setTest:function(Ni){Ni?zn(De.DEPTH_TEST):Pn(De.DEPTH_TEST)},setMask:function(Ni){hi===Ni||Qt||(De.depthMask(Ni),hi=Ni)},setFunc:function(Ni){if(pi!==Ni){switch(Ni){case ri:De.depthFunc(De.NEVER);break;case Ct:De.depthFunc(De.ALWAYS);break;case Ht:De.depthFunc(De.LESS);break;case qt:De.depthFunc(De.LEQUAL);break;case Li:De.depthFunc(De.EQUAL);break;case Ui:De.depthFunc(De.GEQUAL);break;case Xi:De.depthFunc(De.GREATER);break;case An:De.depthFunc(De.NOTEQUAL);break;default:De.depthFunc(De.LEQUAL)}pi=Ni}},setLocked:function(Ni){Qt=Ni},setClear:function(Ni){Bi!==Ni&&(De.clearDepth(Ni),Bi=Ni)},reset:function(){Qt=!1,hi=null,pi=null,Bi=null}}},Le=new function(){let Qt=!1,hi=null,pi=null,Bi=null,Ni=null,cn=null,Ji=null,lr=null,Qn=null;return{setTest:function(mn){Qt||(mn?zn(De.STENCIL_TEST):Pn(De.STENCIL_TEST))},setMask:function(mn){hi===mn||Qt||(De.stencilMask(mn),hi=mn)},setFunc:function(mn,Hn,jn){pi===mn&&Bi===Hn&&Ni===jn||(De.stencilFunc(mn,Hn,jn),pi=mn,Bi=Hn,Ni=jn)},setOp:function(mn,Hn,jn){cn===mn&&Ji===Hn&&lr===jn||(De.stencilOp(mn,Hn,jn),cn=mn,Ji=Hn,lr=jn)},setLocked:function(mn){Qt=mn},setClear:function(mn){Qn!==mn&&(De.clearStencil(mn),Qn=mn)},reset:function(){Qt=!1,hi=null,pi=null,Bi=null,Ni=null,cn=null,Ji=null,lr=null,Qn=null}}},qe=new WeakMap,it=new WeakMap;let nt={},mt={},bt=new WeakMap,At=[],wt=null,Et=!1,Mt=null,St=null,Nt=null,It=null,Rt=null,Yt=null,Kt=null,Xt=!1,oi=null,wi=null,fi=null,yi=null,bi=null;const Ci=De.getParameter(De.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let tn=!1,$i=0;const gn=De.getParameter(De.VERSION);gn.indexOf("WebGL")!==-1?($i=parseFloat(/^WebGL (\d)/.exec(gn)[1]),tn=$i>=1):gn.indexOf("OpenGL ES")!==-1&&($i=parseFloat(/^OpenGL ES (\d)/.exec(gn)[1]),tn=$i>=2);let xn=null,Wi={};const Oi=De.getParameter(De.SCISSOR_BOX),ki=De.getParameter(De.VIEWPORT),Hi=new Tr().fromArray(Oi),Vi=new Tr().fromArray(ki);function Mn(Qt,hi,pi,Bi){const Ni=new Uint8Array(4),cn=De.createTexture();De.bindTexture(Qt,cn),De.texParameteri(Qt,De.TEXTURE_MIN_FILTER,De.NEAREST),De.texParameteri(Qt,De.TEXTURE_MAG_FILTER,De.NEAREST);for(let Ji=0;Ji<pi;Ji++)!D||Qt!==De.TEXTURE_3D&&Qt!==De.TEXTURE_2D_ARRAY?De.texImage2D(hi+Ji,0,De.RGBA,1,1,0,De.RGBA,De.UNSIGNED_BYTE,Ni):De.texImage3D(hi,0,De.RGBA,1,1,Bi,0,De.RGBA,De.UNSIGNED_BYTE,Ni);return cn}const Wn={};function zn(Qt){nt[Qt]!==!0&&(De.enable(Qt),nt[Qt]=!0)}function Pn(Qt){nt[Qt]!==!1&&(De.disable(Qt),nt[Qt]=!1)}Wn[De.TEXTURE_2D]=Mn(De.TEXTURE_2D,De.TEXTURE_2D,1),Wn[De.TEXTURE_CUBE_MAP]=Mn(De.TEXTURE_CUBE_MAP,De.TEXTURE_CUBE_MAP_POSITIVE_X,6),D&&(Wn[De.TEXTURE_2D_ARRAY]=Mn(De.TEXTURE_2D_ARRAY,De.TEXTURE_2D_ARRAY,1,1),Wn[De.TEXTURE_3D]=Mn(De.TEXTURE_3D,De.TEXTURE_3D,1,1)),Y.setClear(0,0,0,1),_e.setClear(1),Le.setClear(0),zn(De.DEPTH_TEST),_e.setFunc(qt),gi(!1),Mi(A),zn(De.CULL_FACE),ei(Ve);const ir={[lt]:De.FUNC_ADD,[pt]:De.FUNC_SUBTRACT,[xt]:De.FUNC_REVERSE_SUBTRACT};if(D)ir[Tt]=De.MIN,ir[Pt]=De.MAX;else{const Qt=y.get("EXT_blend_minmax");Qt!==null&&(ir[Tt]=Qt.MIN_EXT,ir[Pt]=Qt.MAX_EXT)}const di={[Lt]:De.ZERO,[Bt]:De.ONE,[Ut]:De.SRC_COLOR,[Vt]:De.SRC_ALPHA,[ci]:De.SRC_ALPHA_SATURATE,[Zt]:De.DST_COLOR,[Jt]:De.DST_ALPHA,[kt]:De.ONE_MINUS_SRC_COLOR,[si]:De.ONE_MINUS_SRC_ALPHA,[ti]:De.ONE_MINUS_DST_COLOR,[Wt]:De.ONE_MINUS_DST_ALPHA};function ei(Qt,hi,pi,Bi,Ni,cn,Ji,lr){if(Qt!==Ve){if(Et===!1&&(zn(De.BLEND),Et=!0),Qt===at)Ni=Ni||hi,cn=cn||pi,Ji=Ji||Bi,hi===St&&Ni===Rt||(De.blendEquationSeparate(ir[hi],ir[Ni]),St=hi,Rt=Ni),pi===Nt&&Bi===It&&cn===Yt&&Ji===Kt||(De.blendFuncSeparate(di[pi],di[Bi],di[cn],di[Ji]),Nt=pi,It=Bi,Yt=cn,Kt=Ji),Mt=Qt,Xt=!1;else if(Qt!==Mt||lr!==Xt){if(St===lt&&Rt===lt||(De.blendEquation(De.FUNC_ADD),St=lt,Rt=lt),lr)switch(Qt){case tt:De.blendFuncSeparate(De.ONE,De.ONE_MINUS_SRC_ALPHA,De.ONE,De.ONE_MINUS_SRC_ALPHA);break;case ht:De.blendFunc(De.ONE,De.ONE);break;case ut:De.blendFuncSeparate(De.ZERO,De.ONE_MINUS_SRC_COLOR,De.ZERO,De.ONE);break;case _t:De.blendFuncSeparate(De.ZERO,De.SRC_COLOR,De.ZERO,De.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",Qt)}else switch(Qt){case tt:De.blendFuncSeparate(De.SRC_ALPHA,De.ONE_MINUS_SRC_ALPHA,De.ONE,De.ONE_MINUS_SRC_ALPHA);break;case ht:De.blendFunc(De.SRC_ALPHA,De.ONE);break;case ut:De.blendFuncSeparate(De.ZERO,De.ONE_MINUS_SRC_COLOR,De.ZERO,De.ONE);break;case _t:De.blendFunc(De.ZERO,De.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",Qt)}Nt=null,It=null,Yt=null,Kt=null,Mt=Qt,Xt=lr}}else Et===!0&&(Pn(De.BLEND),Et=!1)}function gi(Qt){oi!==Qt&&(Qt?De.frontFace(De.CW):De.frontFace(De.CCW),oi=Qt)}function Mi(Qt){Qt!==_?(zn(De.CULL_FACE),Qt!==wi&&(Qt===A?De.cullFace(De.BACK):Qt===w?De.cullFace(De.FRONT):De.cullFace(De.FRONT_AND_BACK))):Pn(De.CULL_FACE),wi=Qt}function ui(Qt,hi,pi){Qt?(zn(De.POLYGON_OFFSET_FILL),yi===hi&&bi===pi||(De.polygonOffset(hi,pi),yi=hi,bi=pi)):Pn(De.POLYGON_OFFSET_FILL)}return{buffers:{color:Y,depth:_e,stencil:Le},enable:zn,disable:Pn,bindFramebuffer:function(Qt,hi){return mt[Qt]!==hi&&(De.bindFramebuffer(Qt,hi),mt[Qt]=hi,D&&(Qt===De.DRAW_FRAMEBUFFER&&(mt[De.FRAMEBUFFER]=hi),Qt===De.FRAMEBUFFER&&(mt[De.DRAW_FRAMEBUFFER]=hi)),!0)},drawBuffers:function(Qt,hi){let pi=At,Bi=!1;if(Qt)if(pi=bt.get(hi),pi===void 0&&(pi=[],bt.set(hi,pi)),Qt.isWebGLMultipleRenderTargets){const Ni=Qt.texture;if(pi.length!==Ni.length||pi[0]!==De.COLOR_ATTACHMENT0){for(let cn=0,Ji=Ni.length;cn<Ji;cn++)pi[cn]=De.COLOR_ATTACHMENT0+cn;pi.length=Ni.length,Bi=!0}}else pi[0]!==De.COLOR_ATTACHMENT0&&(pi[0]=De.COLOR_ATTACHMENT0,Bi=!0);else pi[0]!==De.BACK&&(pi[0]=De.BACK,Bi=!0);Bi&&(b.isWebGL2?De.drawBuffers(pi):y.get("WEBGL_draw_buffers").drawBuffersWEBGL(pi))},useProgram:function(Qt){return wt!==Qt&&(De.useProgram(Qt),wt=Qt,!0)},setBlending:ei,setMaterial:function(Qt,hi){Qt.side===Oe?Pn(De.CULL_FACE):zn(De.CULL_FACE);let pi=Qt.side===ye;hi&&(pi=!pi),gi(pi),Qt.blending===tt&&Qt.transparent===!1?ei(Ve):ei(Qt.blending,Qt.blendEquation,Qt.blendSrc,Qt.blendDst,Qt.blendEquationAlpha,Qt.blendSrcAlpha,Qt.blendDstAlpha,Qt.premultipliedAlpha),_e.setFunc(Qt.depthFunc),_e.setTest(Qt.depthTest),_e.setMask(Qt.depthWrite),Y.setMask(Qt.colorWrite);const Bi=Qt.stencilWrite;Le.setTest(Bi),Bi&&(Le.setMask(Qt.stencilWriteMask),Le.setFunc(Qt.stencilFunc,Qt.stencilRef,Qt.stencilFuncMask),Le.setOp(Qt.stencilFail,Qt.stencilZFail,Qt.stencilZPass)),ui(Qt.polygonOffset,Qt.polygonOffsetFactor,Qt.polygonOffsetUnits),Qt.alphaToCoverage===!0?zn(De.SAMPLE_ALPHA_TO_COVERAGE):Pn(De.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:gi,setCullFace:Mi,setLineWidth:function(Qt){Qt!==fi&&(tn&&De.lineWidth(Qt),fi=Qt)},setPolygonOffset:ui,setScissorTest:function(Qt){Qt?zn(De.SCISSOR_TEST):Pn(De.SCISSOR_TEST)},activeTexture:function(Qt){Qt===void 0&&(Qt=De.TEXTURE0+Ci-1),xn!==Qt&&(De.activeTexture(Qt),xn=Qt)},bindTexture:function(Qt,hi,pi){pi===void 0&&(pi=xn===null?De.TEXTURE0+Ci-1:xn);let Bi=Wi[pi];Bi===void 0&&(Bi={type:void 0,texture:void 0},Wi[pi]=Bi),Bi.type===Qt&&Bi.texture===hi||(xn!==pi&&(De.activeTexture(pi),xn=pi),De.bindTexture(Qt,hi||Wn[Qt]),Bi.type=Qt,Bi.texture=hi)},unbindTexture:function(){const Qt=Wi[xn];Qt!==void 0&&Qt.type!==void 0&&(De.bindTexture(Qt.type,null),Qt.type=void 0,Qt.texture=void 0)},compressedTexImage2D:function(){try{De.compressedTexImage2D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},compressedTexImage3D:function(){try{De.compressedTexImage3D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},texImage2D:function(){try{De.texImage2D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},texImage3D:function(){try{De.texImage3D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},updateUBOMapping:function(Qt,hi){let pi=it.get(hi);pi===void 0&&(pi=new WeakMap,it.set(hi,pi));let Bi=pi.get(Qt);Bi===void 0&&(Bi=De.getUniformBlockIndex(hi,Qt.name),pi.set(Qt,Bi))},uniformBlockBinding:function(Qt,hi){const pi=it.get(hi).get(Qt);qe.get(hi)!==pi&&(De.uniformBlockBinding(hi,pi,Qt.__bindingPointIndex),qe.set(hi,pi))},texStorage2D:function(){try{De.texStorage2D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},texStorage3D:function(){try{De.texStorage3D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},texSubImage2D:function(){try{De.texSubImage2D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},texSubImage3D:function(){try{De.texSubImage3D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},compressedTexSubImage2D:function(){try{De.compressedTexSubImage2D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},compressedTexSubImage3D:function(){try{De.compressedTexSubImage3D.apply(De,arguments)}catch(Qt){console.error("THREE.WebGLState:",Qt)}},scissor:function(Qt){Hi.equals(Qt)===!1&&(De.scissor(Qt.x,Qt.y,Qt.z,Qt.w),Hi.copy(Qt))},viewport:function(Qt){Vi.equals(Qt)===!1&&(De.viewport(Qt.x,Qt.y,Qt.z,Qt.w),Vi.copy(Qt))},reset:function(){De.disable(De.BLEND),De.disable(De.CULL_FACE),De.disable(De.DEPTH_TEST),De.disable(De.POLYGON_OFFSET_FILL),De.disable(De.SCISSOR_TEST),De.disable(De.STENCIL_TEST),De.disable(De.SAMPLE_ALPHA_TO_COVERAGE),De.blendEquation(De.FUNC_ADD),De.blendFunc(De.ONE,De.ZERO),De.blendFuncSeparate(De.ONE,De.ZERO,De.ONE,De.ZERO),De.colorMask(!0,!0,!0,!0),De.clearColor(0,0,0,0),De.depthMask(!0),De.depthFunc(De.LESS),De.clearDepth(1),De.stencilMask(4294967295),De.stencilFunc(De.ALWAYS,0,4294967295),De.stencilOp(De.KEEP,De.KEEP,De.KEEP),De.clearStencil(0),De.cullFace(De.BACK),De.frontFace(De.CCW),De.polygonOffset(0,0),De.activeTexture(De.TEXTURE0),De.bindFramebuffer(De.FRAMEBUFFER,null),D===!0&&(De.bindFramebuffer(De.DRAW_FRAMEBUFFER,null),De.bindFramebuffer(De.READ_FRAMEBUFFER,null)),De.useProgram(null),De.lineWidth(1),De.scissor(0,0,De.canvas.width,De.canvas.height),De.viewport(0,0,De.canvas.width,De.canvas.height),nt={},xn=null,Wi={},mt={},bt=new WeakMap,At=[],wt=null,Et=!1,Mt=null,St=null,Nt=null,It=null,Rt=null,Yt=null,Kt=null,Xt=!1,oi=null,wi=null,fi=null,yi=null,bi=null,Hi.set(0,0,De.canvas.width,De.canvas.height),Vi.set(0,0,De.canvas.width,De.canvas.height),Y.reset(),_e.reset(),Le.reset()}}}function I_(De,y,b,D,Y,_e,Le){const qe=Y.isWebGL2,it=Y.maxTextures,nt=Y.maxCubemapSize,mt=Y.maxTextureSize,bt=Y.maxSamples,At=y.has("WEBGL_multisampled_render_to_texture")?y.get("WEBGL_multisampled_render_to_texture"):null,wt=typeof navigator<"u"&&/OculusBrowser/g.test(navigator.userAgent),Et=new WeakMap;let Mt;const St=new WeakMap;let Nt=!1;try{Nt=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")!==null}catch{}function It(di,ei){return Nt?new OffscreenCanvas(di,ei):Gs("canvas")}function Rt(di,ei,gi,Mi){let ui=1;if((di.width>Mi||di.height>Mi)&&(ui=Mi/Math.max(di.width,di.height)),ui<1||ei===!0){if(typeof HTMLImageElement<"u"&&di instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&di instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&di instanceof ImageBitmap){const Qt=ei?za:Math.floor,hi=Qt(ui*di.width),pi=Qt(ui*di.height);Mt===void 0&&(Mt=It(hi,pi));const Bi=gi?It(hi,pi):Mt;return Bi.width=hi,Bi.height=pi,Bi.getContext("2d").drawImage(di,0,0,hi,pi),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+di.width+"x"+di.height+") to ("+hi+"x"+pi+")."),Bi}return"data"in di&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+di.width+"x"+di.height+")."),di}return di}function Yt(di){return Pl(di.width)&&Pl(di.height)}function Kt(di,ei){return di.generateMipmaps&&ei&&di.minFilter!==Yi&&di.minFilter!==fn}function Xt(di){De.generateMipmap(di)}function oi(di,ei,gi,Mi,ui=!1){if(qe===!1)return ei;if(di!==null){if(De[di]!==void 0)return De[di];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+di+"'")}let Qt=ei;if(ei===De.RED&&(gi===De.FLOAT&&(Qt=De.R32F),gi===De.HALF_FLOAT&&(Qt=De.R16F),gi===De.UNSIGNED_BYTE&&(Qt=De.R8)),ei===De.RED_INTEGER&&(gi===De.UNSIGNED_BYTE&&(Qt=De.R8UI),gi===De.UNSIGNED_SHORT&&(Qt=De.R16UI),gi===De.UNSIGNED_INT&&(Qt=De.R32UI),gi===De.BYTE&&(Qt=De.R8I),gi===De.SHORT&&(Qt=De.R16I),gi===De.INT&&(Qt=De.R32I)),ei===De.RG&&(gi===De.FLOAT&&(Qt=De.RG32F),gi===De.HALF_FLOAT&&(Qt=De.RG16F),gi===De.UNSIGNED_BYTE&&(Qt=De.RG8)),ei===De.RGBA){const hi=ui?Mr:Sr.getTransfer(Mi);gi===De.FLOAT&&(Qt=De.RGBA32F),gi===De.HALF_FLOAT&&(Qt=De.RGBA16F),gi===De.UNSIGNED_BYTE&&(Qt=hi===Dr?De.SRGB8_ALPHA8:De.RGBA8),gi===De.UNSIGNED_SHORT_4_4_4_4&&(Qt=De.RGBA4),gi===De.UNSIGNED_SHORT_5_5_5_1&&(Qt=De.RGB5_A1)}return Qt!==De.R16F&&Qt!==De.R32F&&Qt!==De.RG16F&&Qt!==De.RG32F&&Qt!==De.RGBA16F&&Qt!==De.RGBA32F||y.get("EXT_color_buffer_float"),Qt}function wi(di,ei,gi){return Kt(di,gi)===!0||di.isFramebufferTexture&&di.minFilter!==Yi&&di.minFilter!==fn?Math.log2(Math.max(ei.width,ei.height))+1:di.mipmaps!==void 0&&di.mipmaps.length>0?di.mipmaps.length:di.isCompressedTexture&&Array.isArray(di.image)?ei.mipmaps.length:1}function fi(di){return di===Yi||di===nn||di===un?De.NEAREST:De.LINEAR}function yi(di){const ei=di.target;ei.removeEventListener("dispose",yi),function(gi){const Mi=D.get(gi);if(Mi.__webglInit===void 0)return;const ui=gi.source,Qt=St.get(ui);if(Qt){const hi=Qt[Mi.__cacheKey];hi.usedTimes--,hi.usedTimes===0&&Ci(gi),Object.keys(Qt).length===0&&St.delete(ui)}D.remove(gi)}(ei),ei.isVideoTexture&&Et.delete(ei)}function bi(di){const ei=di.target;ei.removeEventListener("dispose",bi),function(gi){const Mi=gi.texture,ui=D.get(gi),Qt=D.get(Mi);if(Qt.__webglTexture!==void 0&&(De.deleteTexture(Qt.__webglTexture),Le.memory.textures--),gi.depthTexture&&gi.depthTexture.dispose(),gi.isWebGLCubeRenderTarget)for(let hi=0;hi<6;hi++){if(Array.isArray(ui.__webglFramebuffer[hi]))for(let pi=0;pi<ui.__webglFramebuffer[hi].length;pi++)De.deleteFramebuffer(ui.__webglFramebuffer[hi][pi]);else De.deleteFramebuffer(ui.__webglFramebuffer[hi]);ui.__webglDepthbuffer&&De.deleteRenderbuffer(ui.__webglDepthbuffer[hi])}else{if(Array.isArray(ui.__webglFramebuffer))for(let hi=0;hi<ui.__webglFramebuffer.length;hi++)De.deleteFramebuffer(ui.__webglFramebuffer[hi]);else De.deleteFramebuffer(ui.__webglFramebuffer);if(ui.__webglDepthbuffer&&De.deleteRenderbuffer(ui.__webglDepthbuffer),ui.__webglMultisampledFramebuffer&&De.deleteFramebuffer(ui.__webglMultisampledFramebuffer),ui.__webglColorRenderbuffer)for(let hi=0;hi<ui.__webglColorRenderbuffer.length;hi++)ui.__webglColorRenderbuffer[hi]&&De.deleteRenderbuffer(ui.__webglColorRenderbuffer[hi]);ui.__webglDepthRenderbuffer&&De.deleteRenderbuffer(ui.__webglDepthRenderbuffer)}if(gi.isWebGLMultipleRenderTargets)for(let hi=0,pi=Mi.length;hi<pi;hi++){const Bi=D.get(Mi[hi]);Bi.__webglTexture&&(De.deleteTexture(Bi.__webglTexture),Le.memory.textures--),D.remove(Mi[hi])}D.remove(Mi),D.remove(gi)}(ei)}function Ci(di){const ei=D.get(di);De.deleteTexture(ei.__webglTexture);const gi=di.source;delete St.get(gi)[ei.__cacheKey],Le.memory.textures--}let tn=0;function $i(di,ei){const gi=D.get(di);if(di.isVideoTexture&&function(Mi){const ui=Le.render.frame;Et.get(Mi)!==ui&&(Et.set(Mi,ui),Mi.update())}(di),di.isRenderTargetTexture===!1&&di.version>0&&gi.__version!==di.version){const Mi=di.image;if(Mi===null)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(Mi.complete!==!1)return void Hi(gi,di,ei);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}b.bindTexture(De.TEXTURE_2D,gi.__webglTexture,De.TEXTURE0+ei)}const gn={[hn]:De.REPEAT,[an]:De.CLAMP_TO_EDGE,[pn]:De.MIRRORED_REPEAT},xn={[Yi]:De.NEAREST,[nn]:De.NEAREST_MIPMAP_NEAREST,[un]:De.NEAREST_MIPMAP_LINEAR,[fn]:De.LINEAR,[Fn]:De.LINEAR_MIPMAP_NEAREST,[Zn]:De.LINEAR_MIPMAP_LINEAR},Wi={[Ns]:De.NEVER,[Pu]:De.ALWAYS,[ks]:De.LESS,[Tu]:De.LEQUAL,[Ga]:De.EQUAL,[vs]:De.GEQUAL,[Cu]:De.GREATER,[Mu]:De.NOTEQUAL};function Oi(di,ei,gi){if(gi?(De.texParameteri(di,De.TEXTURE_WRAP_S,gn[ei.wrapS]),De.texParameteri(di,De.TEXTURE_WRAP_T,gn[ei.wrapT]),di!==De.TEXTURE_3D&&di!==De.TEXTURE_2D_ARRAY||De.texParameteri(di,De.TEXTURE_WRAP_R,gn[ei.wrapR]),De.texParameteri(di,De.TEXTURE_MAG_FILTER,xn[ei.magFilter]),De.texParameteri(di,De.TEXTURE_MIN_FILTER,xn[ei.minFilter])):(De.texParameteri(di,De.TEXTURE_WRAP_S,De.CLAMP_TO_EDGE),De.texParameteri(di,De.TEXTURE_WRAP_T,De.CLAMP_TO_EDGE),di!==De.TEXTURE_3D&&di!==De.TEXTURE_2D_ARRAY||De.texParameteri(di,De.TEXTURE_WRAP_R,De.CLAMP_TO_EDGE),ei.wrapS===an&&ei.wrapT===an||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),De.texParameteri(di,De.TEXTURE_MAG_FILTER,fi(ei.magFilter)),De.texParameteri(di,De.TEXTURE_MIN_FILTER,fi(ei.minFilter)),ei.minFilter!==Yi&&ei.minFilter!==fn&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),ei.compareFunction&&(De.texParameteri(di,De.TEXTURE_COMPARE_MODE,De.COMPARE_REF_TO_TEXTURE),De.texParameteri(di,De.TEXTURE_COMPARE_FUNC,Wi[ei.compareFunction])),y.has("EXT_texture_filter_anisotropic")===!0){const Mi=y.get("EXT_texture_filter_anisotropic");if(ei.magFilter===Yi||ei.minFilter!==un&&ei.minFilter!==Zn||ei.type===Tn&&y.has("OES_texture_float_linear")===!1||qe===!1&&ei.type===qn&&y.has("OES_texture_half_float_linear")===!1)return;(ei.anisotropy>1||D.get(ei).__currentAnisotropy)&&(De.texParameterf(di,Mi.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(ei.anisotropy,Y.getMaxAnisotropy())),D.get(ei).__currentAnisotropy=ei.anisotropy)}}function ki(di,ei){let gi=!1;di.__webglInit===void 0&&(di.__webglInit=!0,ei.addEventListener("dispose",yi));const Mi=ei.source;let ui=St.get(Mi);ui===void 0&&(ui={},St.set(Mi,ui));const Qt=function(hi){const pi=[];return pi.push(hi.wrapS),pi.push(hi.wrapT),pi.push(hi.wrapR||0),pi.push(hi.magFilter),pi.push(hi.minFilter),pi.push(hi.anisotropy),pi.push(hi.internalFormat),pi.push(hi.format),pi.push(hi.type),pi.push(hi.generateMipmaps),pi.push(hi.premultiplyAlpha),pi.push(hi.flipY),pi.push(hi.unpackAlignment),pi.push(hi.colorSpace),pi.join()}(ei);if(Qt!==di.__cacheKey){ui[Qt]===void 0&&(ui[Qt]={texture:De.createTexture(),usedTimes:0},Le.memory.textures++,gi=!0),ui[Qt].usedTimes++;const hi=ui[di.__cacheKey];hi!==void 0&&(ui[di.__cacheKey].usedTimes--,hi.usedTimes===0&&Ci(ei)),di.__cacheKey=Qt,di.__webglTexture=ui[Qt].texture}return gi}function Hi(di,ei,gi){let Mi=De.TEXTURE_2D;(ei.isDataArrayTexture||ei.isCompressedArrayTexture)&&(Mi=De.TEXTURE_2D_ARRAY),ei.isData3DTexture&&(Mi=De.TEXTURE_3D);const ui=ki(di,ei),Qt=ei.source;b.bindTexture(Mi,di.__webglTexture,De.TEXTURE0+gi);const hi=D.get(Qt);if(Qt.version!==hi.__version||ui===!0){b.activeTexture(De.TEXTURE0+gi);const pi=Sr.getPrimaries(Sr.workingColorSpace),Bi=ei.colorSpace===Cr||ei.colorSpace===io?null:Sr.getPrimaries(ei.colorSpace),Ni=ei.colorSpace===Cr||ei.colorSpace===io||pi===Bi?De.NONE:De.BROWSER_DEFAULT_WEBGL;De.pixelStorei(De.UNPACK_FLIP_Y_WEBGL,ei.flipY),De.pixelStorei(De.UNPACK_PREMULTIPLY_ALPHA_WEBGL,ei.premultiplyAlpha),De.pixelStorei(De.UNPACK_ALIGNMENT,ei.unpackAlignment),De.pixelStorei(De.UNPACK_COLORSPACE_CONVERSION_WEBGL,Ni);const cn=function(Gn){return!qe&&(Gn.wrapS!==an||Gn.wrapT!==an||Gn.minFilter!==Yi&&Gn.minFilter!==fn)}(ei)&&Yt(ei.image)===!1;let Ji=Rt(ei.image,cn,!1,mt);Ji=ir(ei,Ji);const lr=Yt(Ji)||qe,Qn=_e.convert(ei.format,ei.colorSpace);let mn,Hn=_e.convert(ei.type),jn=oi(ei.internalFormat,Qn,Hn,ei.colorSpace,ei.isVideoTexture);Oi(Mi,ei,lr);const nr=ei.mipmaps,hr=qe&&ei.isVideoTexture!==!0,Pr=hi.__version===void 0||ui===!0,br=wi(ei,Ji,lr);if(ei.isDepthTexture)jn=De.DEPTH_COMPONENT,qe?jn=ei.type===Tn?De.DEPTH_COMPONENT32F:ei.type===yn?De.DEPTH_COMPONENT24:ei.type===jr?De.DEPTH24_STENCIL8:De.DEPTH_COMPONENT16:ei.type===Tn&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),ei.format===Zr&&jn===De.DEPTH_COMPONENT&&ei.type!==Ki&&ei.type!==yn&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),ei.type=yn,Hn=_e.convert(ei.type)),ei.format===or&&jn===De.DEPTH_COMPONENT&&(jn=De.DEPTH_STENCIL,ei.type!==jr&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),ei.type=jr,Hn=_e.convert(ei.type))),Pr&&(hr?b.texStorage2D(De.TEXTURE_2D,1,jn,Ji.width,Ji.height):b.texImage2D(De.TEXTURE_2D,0,jn,Ji.width,Ji.height,0,Qn,Hn,null));else if(ei.isDataTexture)if(nr.length>0&&lr){hr&&Pr&&b.texStorage2D(De.TEXTURE_2D,br,jn,nr[0].width,nr[0].height);for(let Gn=0,_r=nr.length;Gn<_r;Gn++)mn=nr[Gn],hr?b.texSubImage2D(De.TEXTURE_2D,Gn,0,0,mn.width,mn.height,Qn,Hn,mn.data):b.texImage2D(De.TEXTURE_2D,Gn,jn,mn.width,mn.height,0,Qn,Hn,mn.data);ei.generateMipmaps=!1}else hr?(Pr&&b.texStorage2D(De.TEXTURE_2D,br,jn,Ji.width,Ji.height),b.texSubImage2D(De.TEXTURE_2D,0,0,0,Ji.width,Ji.height,Qn,Hn,Ji.data)):b.texImage2D(De.TEXTURE_2D,0,jn,Ji.width,Ji.height,0,Qn,Hn,Ji.data);else if(ei.isCompressedTexture)if(ei.isCompressedArrayTexture){hr&&Pr&&b.texStorage3D(De.TEXTURE_2D_ARRAY,br,jn,nr[0].width,nr[0].height,Ji.depth);for(let Gn=0,_r=nr.length;Gn<_r;Gn++)mn=nr[Gn],ei.format!==Nr?Qn!==null?hr?b.compressedTexSubImage3D(De.TEXTURE_2D_ARRAY,Gn,0,0,0,mn.width,mn.height,Ji.depth,Qn,mn.data,0,0):b.compressedTexImage3D(De.TEXTURE_2D_ARRAY,Gn,jn,mn.width,mn.height,Ji.depth,0,mn.data,0,0):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):hr?b.texSubImage3D(De.TEXTURE_2D_ARRAY,Gn,0,0,0,mn.width,mn.height,Ji.depth,Qn,Hn,mn.data):b.texImage3D(De.TEXTURE_2D_ARRAY,Gn,jn,mn.width,mn.height,Ji.depth,0,Qn,Hn,mn.data)}else{hr&&Pr&&b.texStorage2D(De.TEXTURE_2D,br,jn,nr[0].width,nr[0].height);for(let Gn=0,_r=nr.length;Gn<_r;Gn++)mn=nr[Gn],ei.format!==Nr?Qn!==null?hr?b.compressedTexSubImage2D(De.TEXTURE_2D,Gn,0,0,mn.width,mn.height,Qn,mn.data):b.compressedTexImage2D(De.TEXTURE_2D,Gn,jn,mn.width,mn.height,0,mn.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):hr?b.texSubImage2D(De.TEXTURE_2D,Gn,0,0,mn.width,mn.height,Qn,Hn,mn.data):b.texImage2D(De.TEXTURE_2D,Gn,jn,mn.width,mn.height,0,Qn,Hn,mn.data)}else if(ei.isDataArrayTexture)hr?(Pr&&b.texStorage3D(De.TEXTURE_2D_ARRAY,br,jn,Ji.width,Ji.height,Ji.depth),b.texSubImage3D(De.TEXTURE_2D_ARRAY,0,0,0,0,Ji.width,Ji.height,Ji.depth,Qn,Hn,Ji.data)):b.texImage3D(De.TEXTURE_2D_ARRAY,0,jn,Ji.width,Ji.height,Ji.depth,0,Qn,Hn,Ji.data);else if(ei.isData3DTexture)hr?(Pr&&b.texStorage3D(De.TEXTURE_3D,br,jn,Ji.width,Ji.height,Ji.depth),b.texSubImage3D(De.TEXTURE_3D,0,0,0,0,Ji.width,Ji.height,Ji.depth,Qn,Hn,Ji.data)):b.texImage3D(De.TEXTURE_3D,0,jn,Ji.width,Ji.height,Ji.depth,0,Qn,Hn,Ji.data);else if(ei.isFramebufferTexture){if(Pr)if(hr)b.texStorage2D(De.TEXTURE_2D,br,jn,Ji.width,Ji.height);else{let Gn=Ji.width,_r=Ji.height;for(let Wo=0;Wo<br;Wo++)b.texImage2D(De.TEXTURE_2D,Wo,jn,Gn,_r,0,Qn,Hn,null),Gn>>=1,_r>>=1}}else if(nr.length>0&&lr){hr&&Pr&&b.texStorage2D(De.TEXTURE_2D,br,jn,nr[0].width,nr[0].height);for(let Gn=0,_r=nr.length;Gn<_r;Gn++)mn=nr[Gn],hr?b.texSubImage2D(De.TEXTURE_2D,Gn,0,0,Qn,Hn,mn):b.texImage2D(De.TEXTURE_2D,Gn,jn,Qn,Hn,mn);ei.generateMipmaps=!1}else hr?(Pr&&b.texStorage2D(De.TEXTURE_2D,br,jn,Ji.width,Ji.height),b.texSubImage2D(De.TEXTURE_2D,0,0,0,Qn,Hn,Ji)):b.texImage2D(De.TEXTURE_2D,0,jn,Qn,Hn,Ji);Kt(ei,lr)&&Xt(Mi),hi.__version=Qt.version,ei.onUpdate&&ei.onUpdate(ei)}di.__version=ei.version}function Vi(di,ei,gi,Mi,ui,Qt){const hi=_e.convert(gi.format,gi.colorSpace),pi=_e.convert(gi.type),Bi=oi(gi.internalFormat,hi,pi,gi.colorSpace);if(!D.get(ei).__hasExternalTextures){const Ni=Math.max(1,ei.width>>Qt),cn=Math.max(1,ei.height>>Qt);ui===De.TEXTURE_3D||ui===De.TEXTURE_2D_ARRAY?b.texImage3D(ui,Qt,Bi,Ni,cn,ei.depth,0,hi,pi,null):b.texImage2D(ui,Qt,Bi,Ni,cn,0,hi,pi,null)}b.bindFramebuffer(De.FRAMEBUFFER,di),Pn(ei)?At.framebufferTexture2DMultisampleEXT(De.FRAMEBUFFER,Mi,ui,D.get(gi).__webglTexture,0,zn(ei)):(ui===De.TEXTURE_2D||ui>=De.TEXTURE_CUBE_MAP_POSITIVE_X&&ui<=De.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&De.framebufferTexture2D(De.FRAMEBUFFER,Mi,ui,D.get(gi).__webglTexture,Qt),b.bindFramebuffer(De.FRAMEBUFFER,null)}function Mn(di,ei,gi){if(De.bindRenderbuffer(De.RENDERBUFFER,di),ei.depthBuffer&&!ei.stencilBuffer){let Mi=qe===!0?De.DEPTH_COMPONENT24:De.DEPTH_COMPONENT16;if(gi||Pn(ei)){const ui=ei.depthTexture;ui&&ui.isDepthTexture&&(ui.type===Tn?Mi=De.DEPTH_COMPONENT32F:ui.type===yn&&(Mi=De.DEPTH_COMPONENT24));const Qt=zn(ei);Pn(ei)?At.renderbufferStorageMultisampleEXT(De.RENDERBUFFER,Qt,Mi,ei.width,ei.height):De.renderbufferStorageMultisample(De.RENDERBUFFER,Qt,Mi,ei.width,ei.height)}else De.renderbufferStorage(De.RENDERBUFFER,Mi,ei.width,ei.height);De.framebufferRenderbuffer(De.FRAMEBUFFER,De.DEPTH_ATTACHMENT,De.RENDERBUFFER,di)}else if(ei.depthBuffer&&ei.stencilBuffer){const Mi=zn(ei);gi&&Pn(ei)===!1?De.renderbufferStorageMultisample(De.RENDERBUFFER,Mi,De.DEPTH24_STENCIL8,ei.width,ei.height):Pn(ei)?At.renderbufferStorageMultisampleEXT(De.RENDERBUFFER,Mi,De.DEPTH24_STENCIL8,ei.width,ei.height):De.renderbufferStorage(De.RENDERBUFFER,De.DEPTH_STENCIL,ei.width,ei.height),De.framebufferRenderbuffer(De.FRAMEBUFFER,De.DEPTH_STENCIL_ATTACHMENT,De.RENDERBUFFER,di)}else{const Mi=ei.isWebGLMultipleRenderTargets===!0?ei.texture:[ei.texture];for(let ui=0;ui<Mi.length;ui++){const Qt=Mi[ui],hi=_e.convert(Qt.format,Qt.colorSpace),pi=_e.convert(Qt.type),Bi=oi(Qt.internalFormat,hi,pi,Qt.colorSpace),Ni=zn(ei);gi&&Pn(ei)===!1?De.renderbufferStorageMultisample(De.RENDERBUFFER,Ni,Bi,ei.width,ei.height):Pn(ei)?At.renderbufferStorageMultisampleEXT(De.RENDERBUFFER,Ni,Bi,ei.width,ei.height):De.renderbufferStorage(De.RENDERBUFFER,Bi,ei.width,ei.height)}}De.bindRenderbuffer(De.RENDERBUFFER,null)}function Wn(di){const ei=D.get(di),gi=di.isWebGLCubeRenderTarget===!0;if(di.depthTexture&&!ei.__autoAllocateDepthBuffer){if(gi)throw new Error("target.depthTexture not supported in Cube render targets");(function(Mi,ui){if(ui&&ui.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(b.bindFramebuffer(De.FRAMEBUFFER,Mi),!ui.depthTexture||!ui.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");D.get(ui.depthTexture).__webglTexture&&ui.depthTexture.image.width===ui.width&&ui.depthTexture.image.height===ui.height||(ui.depthTexture.image.width=ui.width,ui.depthTexture.image.height=ui.height,ui.depthTexture.needsUpdate=!0),$i(ui.depthTexture,0);const Qt=D.get(ui.depthTexture).__webglTexture,hi=zn(ui);if(ui.depthTexture.format===Zr)Pn(ui)?At.framebufferTexture2DMultisampleEXT(De.FRAMEBUFFER,De.DEPTH_ATTACHMENT,De.TEXTURE_2D,Qt,0,hi):De.framebufferTexture2D(De.FRAMEBUFFER,De.DEPTH_ATTACHMENT,De.TEXTURE_2D,Qt,0);else{if(ui.depthTexture.format!==or)throw new Error("Unknown depthTexture format");Pn(ui)?At.framebufferTexture2DMultisampleEXT(De.FRAMEBUFFER,De.DEPTH_STENCIL_ATTACHMENT,De.TEXTURE_2D,Qt,0,hi):De.framebufferTexture2D(De.FRAMEBUFFER,De.DEPTH_STENCIL_ATTACHMENT,De.TEXTURE_2D,Qt,0)}})(ei.__webglFramebuffer,di)}else if(gi){ei.__webglDepthbuffer=[];for(let Mi=0;Mi<6;Mi++)b.bindFramebuffer(De.FRAMEBUFFER,ei.__webglFramebuffer[Mi]),ei.__webglDepthbuffer[Mi]=De.createRenderbuffer(),Mn(ei.__webglDepthbuffer[Mi],di,!1)}else b.bindFramebuffer(De.FRAMEBUFFER,ei.__webglFramebuffer),ei.__webglDepthbuffer=De.createRenderbuffer(),Mn(ei.__webglDepthbuffer,di,!1);b.bindFramebuffer(De.FRAMEBUFFER,null)}function zn(di){return Math.min(bt,di.samples)}function Pn(di){const ei=D.get(di);return qe&&di.samples>0&&y.has("WEBGL_multisampled_render_to_texture")===!0&&ei.__useRenderToTexture!==!1}function ir(di,ei){const gi=di.colorSpace,Mi=di.format,ui=di.type;return di.isCompressedTexture===!0||di.isVideoTexture===!0||di.format===Cl||gi!==Fr&&gi!==Cr&&(Sr.getTransfer(gi)===Dr?qe===!1?y.has("EXT_sRGB")===!0&&Mi===Nr?(di.format=Cl,di.minFilter=fn,di.generateMipmaps=!1):ei=Bc.sRGBToLinear(ei):Mi===Nr&&ui===Un||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):gi===io||console.error("THREE.WebGLTextures: Unsupported texture color space:",gi)),ei}this.allocateTextureUnit=function(){const di=tn;return di>=it&&console.warn("THREE.WebGLTextures: Trying to use "+di+" texture units while this GPU supports only "+it),tn+=1,di},this.resetTextureUnits=function(){tn=0},this.setTexture2D=$i,this.setTexture2DArray=function(di,ei){const gi=D.get(di);di.version>0&&gi.__version!==di.version?Hi(gi,di,ei):b.bindTexture(De.TEXTURE_2D_ARRAY,gi.__webglTexture,De.TEXTURE0+ei)},this.setTexture3D=function(di,ei){const gi=D.get(di);di.version>0&&gi.__version!==di.version?Hi(gi,di,ei):b.bindTexture(De.TEXTURE_3D,gi.__webglTexture,De.TEXTURE0+ei)},this.setTextureCube=function(di,ei){const gi=D.get(di);di.version>0&&gi.__version!==di.version?function(Mi,ui,Qt){if(ui.image.length!==6)return;const hi=ki(Mi,ui),pi=ui.source;b.bindTexture(De.TEXTURE_CUBE_MAP,Mi.__webglTexture,De.TEXTURE0+Qt);const Bi=D.get(pi);if(pi.version!==Bi.__version||hi===!0){b.activeTexture(De.TEXTURE0+Qt);const Ni=Sr.getPrimaries(Sr.workingColorSpace),cn=ui.colorSpace===Cr||ui.colorSpace===io?null:Sr.getPrimaries(ui.colorSpace),Ji=ui.colorSpace===Cr||ui.colorSpace===io||Ni===cn?De.NONE:De.BROWSER_DEFAULT_WEBGL;De.pixelStorei(De.UNPACK_FLIP_Y_WEBGL,ui.flipY),De.pixelStorei(De.UNPACK_PREMULTIPLY_ALPHA_WEBGL,ui.premultiplyAlpha),De.pixelStorei(De.UNPACK_ALIGNMENT,ui.unpackAlignment),De.pixelStorei(De.UNPACK_COLORSPACE_CONVERSION_WEBGL,Ji);const lr=ui.isCompressedTexture||ui.image[0].isCompressedTexture,Qn=ui.image[0]&&ui.image[0].isDataTexture,mn=[];for(let rr=0;rr<6;rr++)mn[rr]=lr||Qn?Qn?ui.image[rr].image:ui.image[rr]:Rt(ui.image[rr],!1,!0,nt),mn[rr]=ir(ui,mn[rr]);const Hn=mn[0],jn=Yt(Hn)||qe,nr=_e.convert(ui.format,ui.colorSpace),hr=_e.convert(ui.type),Pr=oi(ui.internalFormat,nr,hr,ui.colorSpace),br=qe&&ui.isVideoTexture!==!0,Gn=Bi.__version===void 0||hi===!0;let _r,Wo=wi(ui,Hn,jn);if(Oi(De.TEXTURE_CUBE_MAP,ui,jn),lr){br&&Gn&&b.texStorage2D(De.TEXTURE_CUBE_MAP,Wo,Pr,Hn.width,Hn.height);for(let rr=0;rr<6;rr++){_r=mn[rr].mipmaps;for(let Lr=0;Lr<_r.length;Lr++){const vr=_r[Lr];ui.format!==Nr?nr!==null?br?b.compressedTexSubImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,Lr,0,0,vr.width,vr.height,nr,vr.data):b.compressedTexImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,Lr,Pr,vr.width,vr.height,0,vr.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):br?b.texSubImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,Lr,0,0,vr.width,vr.height,nr,hr,vr.data):b.texImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,Lr,Pr,vr.width,vr.height,0,nr,hr,vr.data)}}}else{_r=ui.mipmaps,br&&Gn&&(_r.length>0&&Wo++,b.texStorage2D(De.TEXTURE_CUBE_MAP,Wo,Pr,mn[0].width,mn[0].height));for(let rr=0;rr<6;rr++)if(Qn){br?b.texSubImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,0,0,0,mn[rr].width,mn[rr].height,nr,hr,mn[rr].data):b.texImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,0,Pr,mn[rr].width,mn[rr].height,0,nr,hr,mn[rr].data);for(let Lr=0;Lr<_r.length;Lr++){const vr=_r[Lr].image[rr].image;br?b.texSubImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,Lr+1,0,0,vr.width,vr.height,nr,hr,vr.data):b.texImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,Lr+1,Pr,vr.width,vr.height,0,nr,hr,vr.data)}}else{br?b.texSubImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,0,0,0,nr,hr,mn[rr]):b.texImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,0,Pr,nr,hr,mn[rr]);for(let Lr=0;Lr<_r.length;Lr++){const vr=_r[Lr];br?b.texSubImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,Lr+1,0,0,nr,hr,vr.image[rr]):b.texImage2D(De.TEXTURE_CUBE_MAP_POSITIVE_X+rr,Lr+1,Pr,nr,hr,vr.image[rr])}}}Kt(ui,jn)&&Xt(De.TEXTURE_CUBE_MAP),Bi.__version=pi.version,ui.onUpdate&&ui.onUpdate(ui)}Mi.__version=ui.version}(gi,di,ei):b.bindTexture(De.TEXTURE_CUBE_MAP,gi.__webglTexture,De.TEXTURE0+ei)},this.rebindTextures=function(di,ei,gi){const Mi=D.get(di);ei!==void 0&&Vi(Mi.__webglFramebuffer,di,di.texture,De.COLOR_ATTACHMENT0,De.TEXTURE_2D,0),gi!==void 0&&Wn(di)},this.setupRenderTarget=function(di){const ei=di.texture,gi=D.get(di),Mi=D.get(ei);di.addEventListener("dispose",bi),di.isWebGLMultipleRenderTargets!==!0&&(Mi.__webglTexture===void 0&&(Mi.__webglTexture=De.createTexture()),Mi.__version=ei.version,Le.memory.textures++);const ui=di.isWebGLCubeRenderTarget===!0,Qt=di.isWebGLMultipleRenderTargets===!0,hi=Yt(di)||qe;if(ui){gi.__webglFramebuffer=[];for(let pi=0;pi<6;pi++)if(qe&&ei.mipmaps&&ei.mipmaps.length>0){gi.__webglFramebuffer[pi]=[];for(let Bi=0;Bi<ei.mipmaps.length;Bi++)gi.__webglFramebuffer[pi][Bi]=De.createFramebuffer()}else gi.__webglFramebuffer[pi]=De.createFramebuffer()}else{if(qe&&ei.mipmaps&&ei.mipmaps.length>0){gi.__webglFramebuffer=[];for(let pi=0;pi<ei.mipmaps.length;pi++)gi.__webglFramebuffer[pi]=De.createFramebuffer()}else gi.__webglFramebuffer=De.createFramebuffer();if(Qt)if(Y.drawBuffers){const pi=di.texture;for(let Bi=0,Ni=pi.length;Bi<Ni;Bi++){const cn=D.get(pi[Bi]);cn.__webglTexture===void 0&&(cn.__webglTexture=De.createTexture(),Le.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");if(qe&&di.samples>0&&Pn(di)===!1){const pi=Qt?ei:[ei];gi.__webglMultisampledFramebuffer=De.createFramebuffer(),gi.__webglColorRenderbuffer=[],b.bindFramebuffer(De.FRAMEBUFFER,gi.__webglMultisampledFramebuffer);for(let Bi=0;Bi<pi.length;Bi++){const Ni=pi[Bi];gi.__webglColorRenderbuffer[Bi]=De.createRenderbuffer(),De.bindRenderbuffer(De.RENDERBUFFER,gi.__webglColorRenderbuffer[Bi]);const cn=_e.convert(Ni.format,Ni.colorSpace),Ji=_e.convert(Ni.type),lr=oi(Ni.internalFormat,cn,Ji,Ni.colorSpace,di.isXRRenderTarget===!0),Qn=zn(di);De.renderbufferStorageMultisample(De.RENDERBUFFER,Qn,lr,di.width,di.height),De.framebufferRenderbuffer(De.FRAMEBUFFER,De.COLOR_ATTACHMENT0+Bi,De.RENDERBUFFER,gi.__webglColorRenderbuffer[Bi])}De.bindRenderbuffer(De.RENDERBUFFER,null),di.depthBuffer&&(gi.__webglDepthRenderbuffer=De.createRenderbuffer(),Mn(gi.__webglDepthRenderbuffer,di,!0)),b.bindFramebuffer(De.FRAMEBUFFER,null)}}if(ui){b.bindTexture(De.TEXTURE_CUBE_MAP,Mi.__webglTexture),Oi(De.TEXTURE_CUBE_MAP,ei,hi);for(let pi=0;pi<6;pi++)if(qe&&ei.mipmaps&&ei.mipmaps.length>0)for(let Bi=0;Bi<ei.mipmaps.length;Bi++)Vi(gi.__webglFramebuffer[pi][Bi],di,ei,De.COLOR_ATTACHMENT0,De.TEXTURE_CUBE_MAP_POSITIVE_X+pi,Bi);else Vi(gi.__webglFramebuffer[pi],di,ei,De.COLOR_ATTACHMENT0,De.TEXTURE_CUBE_MAP_POSITIVE_X+pi,0);Kt(ei,hi)&&Xt(De.TEXTURE_CUBE_MAP),b.unbindTexture()}else if(Qt){const pi=di.texture;for(let Bi=0,Ni=pi.length;Bi<Ni;Bi++){const cn=pi[Bi],Ji=D.get(cn);b.bindTexture(De.TEXTURE_2D,Ji.__webglTexture),Oi(De.TEXTURE_2D,cn,hi),Vi(gi.__webglFramebuffer,di,cn,De.COLOR_ATTACHMENT0+Bi,De.TEXTURE_2D,0),Kt(cn,hi)&&Xt(De.TEXTURE_2D)}b.unbindTexture()}else{let pi=De.TEXTURE_2D;if((di.isWebGL3DRenderTarget||di.isWebGLArrayRenderTarget)&&(qe?pi=di.isWebGL3DRenderTarget?De.TEXTURE_3D:De.TEXTURE_2D_ARRAY:console.error("THREE.WebGLTextures: THREE.Data3DTexture and THREE.DataArrayTexture only supported with WebGL2.")),b.bindTexture(pi,Mi.__webglTexture),Oi(pi,ei,hi),qe&&ei.mipmaps&&ei.mipmaps.length>0)for(let Bi=0;Bi<ei.mipmaps.length;Bi++)Vi(gi.__webglFramebuffer[Bi],di,ei,De.COLOR_ATTACHMENT0,pi,Bi);else Vi(gi.__webglFramebuffer,di,ei,De.COLOR_ATTACHMENT0,pi,0);Kt(ei,hi)&&Xt(pi),b.unbindTexture()}di.depthBuffer&&Wn(di)},this.updateRenderTargetMipmap=function(di){const ei=Yt(di)||qe,gi=di.isWebGLMultipleRenderTargets===!0?di.texture:[di.texture],Mi=di.isWebGLCubeRenderTarget?De.TEXTURE_CUBE_MAP:De.TEXTURE_2D;for(let ui=0,Qt=gi.length;ui<Qt;ui++){const hi=gi[ui],pi=D.get(hi),Bi=pi.__webglTexture;pi.__version!==hi.version&&(b.bindTexture(Mi,Bi),Oi(Mi,hi,ei),b.unbindTexture(),pi.__version=hi.version),Kt(hi,ei)&&(b.bindTexture(Mi,Bi),Xt(Mi),b.unbindTexture())}},this.updateMultisampleRenderTarget=function(di){if(qe&&di.samples>0&&Pn(di)===!1){const ei=di.isWebGLMultipleRenderTargets?di.texture:[di.texture],gi=di.width,Mi=di.height;let ui=De.COLOR_BUFFER_BIT;const Qt=[],hi=di.stencilBuffer?De.DEPTH_STENCIL_ATTACHMENT:De.DEPTH_ATTACHMENT,pi=D.get(di),Bi=di.isWebGLMultipleRenderTargets===!0;if(Bi)for(let Ni=0;Ni<ei.length;Ni++)b.bindFramebuffer(De.FRAMEBUFFER,pi.__webglMultisampledFramebuffer),De.framebufferRenderbuffer(De.FRAMEBUFFER,De.COLOR_ATTACHMENT0+Ni,De.RENDERBUFFER,null),b.bindFramebuffer(De.FRAMEBUFFER,pi.__webglFramebuffer),De.framebufferTexture2D(De.DRAW_FRAMEBUFFER,De.COLOR_ATTACHMENT0+Ni,De.TEXTURE_2D,null,0);b.bindFramebuffer(De.READ_FRAMEBUFFER,pi.__webglMultisampledFramebuffer),b.bindFramebuffer(De.DRAW_FRAMEBUFFER,pi.__webglFramebuffer);for(let Ni=0;Ni<ei.length;Ni++){Qt.push(De.COLOR_ATTACHMENT0+Ni),di.depthBuffer&&Qt.push(hi);const cn=pi.__ignoreDepthValues!==void 0&&pi.__ignoreDepthValues;if(cn===!1&&(di.depthBuffer&&(ui|=De.DEPTH_BUFFER_BIT),di.stencilBuffer&&(ui|=De.STENCIL_BUFFER_BIT)),Bi&&De.framebufferRenderbuffer(De.READ_FRAMEBUFFER,De.COLOR_ATTACHMENT0,De.RENDERBUFFER,pi.__webglColorRenderbuffer[Ni]),cn===!0&&(De.invalidateFramebuffer(De.READ_FRAMEBUFFER,[hi]),De.invalidateFramebuffer(De.DRAW_FRAMEBUFFER,[hi])),Bi){const Ji=D.get(ei[Ni]).__webglTexture;De.framebufferTexture2D(De.DRAW_FRAMEBUFFER,De.COLOR_ATTACHMENT0,De.TEXTURE_2D,Ji,0)}De.blitFramebuffer(0,0,gi,Mi,0,0,gi,Mi,ui,De.NEAREST),wt&&De.invalidateFramebuffer(De.READ_FRAMEBUFFER,Qt)}if(b.bindFramebuffer(De.READ_FRAMEBUFFER,null),b.bindFramebuffer(De.DRAW_FRAMEBUFFER,null),Bi)for(let Ni=0;Ni<ei.length;Ni++){b.bindFramebuffer(De.FRAMEBUFFER,pi.__webglMultisampledFramebuffer),De.framebufferRenderbuffer(De.FRAMEBUFFER,De.COLOR_ATTACHMENT0+Ni,De.RENDERBUFFER,pi.__webglColorRenderbuffer[Ni]);const cn=D.get(ei[Ni]).__webglTexture;b.bindFramebuffer(De.FRAMEBUFFER,pi.__webglFramebuffer),De.framebufferTexture2D(De.DRAW_FRAMEBUFFER,De.COLOR_ATTACHMENT0+Ni,De.TEXTURE_2D,cn,0)}b.bindFramebuffer(De.DRAW_FRAMEBUFFER,pi.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=Wn,this.setupFrameBufferTexture=Vi,this.useMultisampledRTT=Pn}function $p(De,y,b){const D=b.isWebGL2;return{convert:function(Y,_e=Cr){let Le;const qe=Sr.getTransfer(_e);if(Y===Un)return De.UNSIGNED_BYTE;if(Y===fr)return De.UNSIGNED_SHORT_4_4_4_4;if(Y===wr)return De.UNSIGNED_SHORT_5_5_5_1;if(Y===Ai)return De.BYTE;if(Y===Fi)return De.SHORT;if(Y===Ki)return De.UNSIGNED_SHORT;if(Y===_n)return De.INT;if(Y===yn)return De.UNSIGNED_INT;if(Y===Tn)return De.FLOAT;if(Y===qn)return D?De.HALF_FLOAT:(Le=y.get("OES_texture_half_float"),Le!==null?Le.HALF_FLOAT_OES:null);if(Y===Xr)return De.ALPHA;if(Y===Nr)return De.RGBA;if(Y===vn)return De.LUMINANCE;if(Y===wn)return De.LUMINANCE_ALPHA;if(Y===Zr)return De.DEPTH_COMPONENT;if(Y===or)return De.DEPTH_STENCIL;if(Y===Cl)return Le=y.get("EXT_sRGB"),Le!==null?Le.SRGB_ALPHA_EXT:null;if(Y===eo)return De.RED;if(Y===Kr)return De.RED_INTEGER;if(Y===to)return De.RG;if(Y===cr)return De.RG_INTEGER;if(Y===Er)return De.RGBA_INTEGER;if(Y===co||Y===Uo||Y===uo||Y===rs)if(qe===Dr){if(Le=y.get("WEBGL_compressed_texture_s3tc_srgb"),Le===null)return null;if(Y===co)return Le.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(Y===Uo)return Le.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(Y===uo)return Le.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(Y===rs)return Le.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(Le=y.get("WEBGL_compressed_texture_s3tc"),Le===null)return null;if(Y===co)return Le.COMPRESSED_RGB_S3TC_DXT1_EXT;if(Y===Uo)return Le.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(Y===uo)return Le.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(Y===rs)return Le.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(Y===uc||Y===pl||Y===dc||Y===hc){if(Le=y.get("WEBGL_compressed_texture_pvrtc"),Le===null)return null;if(Y===uc)return Le.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(Y===pl)return Le.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(Y===dc)return Le.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(Y===hc)return Le.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(Y===bu)return Le=y.get("WEBGL_compressed_texture_etc1"),Le!==null?Le.COMPRESSED_RGB_ETC1_WEBGL:null;if(Y===Is||Y===Fo){if(Le=y.get("WEBGL_compressed_texture_etc"),Le===null)return null;if(Y===Is)return qe===Dr?Le.COMPRESSED_SRGB8_ETC2:Le.COMPRESSED_RGB8_ETC2;if(Y===Fo)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:Le.COMPRESSED_RGBA8_ETC2_EAC}if(Y===gs||Y===Rs||Y===ml||Y===Js||Y===Ra||Y===pc||Y===Ds||Y===gl||Y===mc||Y===_l||Y===vl||Y===fc||Y===Zs||Y===yl){if(Le=y.get("WEBGL_compressed_texture_astc"),Le===null)return null;if(Y===gs)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:Le.COMPRESSED_RGBA_ASTC_4x4_KHR;if(Y===Rs)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:Le.COMPRESSED_RGBA_ASTC_5x4_KHR;if(Y===ml)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:Le.COMPRESSED_RGBA_ASTC_5x5_KHR;if(Y===Js)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:Le.COMPRESSED_RGBA_ASTC_6x5_KHR;if(Y===Ra)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:Le.COMPRESSED_RGBA_ASTC_6x6_KHR;if(Y===pc)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:Le.COMPRESSED_RGBA_ASTC_8x5_KHR;if(Y===Ds)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:Le.COMPRESSED_RGBA_ASTC_8x6_KHR;if(Y===gl)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:Le.COMPRESSED_RGBA_ASTC_8x8_KHR;if(Y===mc)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:Le.COMPRESSED_RGBA_ASTC_10x5_KHR;if(Y===_l)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:Le.COMPRESSED_RGBA_ASTC_10x6_KHR;if(Y===vl)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:Le.COMPRESSED_RGBA_ASTC_10x8_KHR;if(Y===fc)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:Le.COMPRESSED_RGBA_ASTC_10x10_KHR;if(Y===Zs)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:Le.COMPRESSED_RGBA_ASTC_12x10_KHR;if(Y===yl)return qe===Dr?Le.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:Le.COMPRESSED_RGBA_ASTC_12x12_KHR}if(Y===Da||Y===gc||Y===_c){if(Le=y.get("EXT_texture_compression_bptc"),Le===null)return null;if(Y===Da)return qe===Dr?Le.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:Le.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(Y===gc)return Le.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(Y===_c)return Le.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(Y===xu||Y===yc||Y===Ac||Y===Ba){if(Le=y.get("EXT_texture_compression_rgtc"),Le===null)return null;if(Y===Da)return Le.COMPRESSED_RED_RGTC1_EXT;if(Y===yc)return Le.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(Y===Ac)return Le.COMPRESSED_RED_GREEN_RGTC2_EXT;if(Y===Ba)return Le.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return Y===jr?D?De.UNSIGNED_INT_24_8:(Le=y.get("WEBGL_depth_texture"),Le!==null?Le.UNSIGNED_INT_24_8_WEBGL:null):De[Y]!==void 0?De[Y]:null}}}class Jp extends _o{constructor(y=[]){super(),this.isArrayCamera=!0,this.cameras=y}}class Kl extends yr{constructor(){super(),this.isGroup=!0,this.type="Group"}}const R_={type:"move"};class Ch{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new Kl,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new Kl,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new ii,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new ii),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new Kl,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new ii,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new ii),this._grip}dispatchEvent(y){return this._targetRay!==null&&this._targetRay.dispatchEvent(y),this._grip!==null&&this._grip.dispatchEvent(y),this._hand!==null&&this._hand.dispatchEvent(y),this}connect(y){if(y&&y.hand){const b=this._hand;if(b)for(const D of y.hand.values())this._getHandJoint(b,D)}return this.dispatchEvent({type:"connected",data:y}),this}disconnect(y){return this.dispatchEvent({type:"disconnected",data:y}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(y,b,D){let Y=null,_e=null,Le=null;const qe=this._targetRay,it=this._grip,nt=this._hand;if(y&&b.session.visibilityState!=="visible-blurred"){if(nt&&y.hand){Le=!0;for(const Mt of y.hand.values()){const St=b.getJointPose(Mt,D),Nt=this._getHandJoint(nt,Mt);St!==null&&(Nt.matrix.fromArray(St.transform.matrix),Nt.matrix.decompose(Nt.position,Nt.rotation,Nt.scale),Nt.matrixWorldNeedsUpdate=!0,Nt.jointRadius=St.radius),Nt.visible=St!==null}const mt=nt.joints["index-finger-tip"],bt=nt.joints["thumb-tip"],At=mt.position.distanceTo(bt.position),wt=.02,Et=.005;nt.inputState.pinching&&At>wt+Et?(nt.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:y.handedness,target:this})):!nt.inputState.pinching&&At<=wt-Et&&(nt.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:y.handedness,target:this}))}else it!==null&&y.gripSpace&&(_e=b.getPose(y.gripSpace,D),_e!==null&&(it.matrix.fromArray(_e.transform.matrix),it.matrix.decompose(it.position,it.rotation,it.scale),it.matrixWorldNeedsUpdate=!0,_e.linearVelocity?(it.hasLinearVelocity=!0,it.linearVelocity.copy(_e.linearVelocity)):it.hasLinearVelocity=!1,_e.angularVelocity?(it.hasAngularVelocity=!0,it.angularVelocity.copy(_e.angularVelocity)):it.hasAngularVelocity=!1));qe!==null&&(Y=b.getPose(y.targetRaySpace,D),Y===null&&_e!==null&&(Y=_e),Y!==null&&(qe.matrix.fromArray(Y.transform.matrix),qe.matrix.decompose(qe.position,qe.rotation,qe.scale),qe.matrixWorldNeedsUpdate=!0,Y.linearVelocity?(qe.hasLinearVelocity=!0,qe.linearVelocity.copy(Y.linearVelocity)):qe.hasLinearVelocity=!1,Y.angularVelocity?(qe.hasAngularVelocity=!0,qe.angularVelocity.copy(Y.angularVelocity)):qe.hasAngularVelocity=!1,this.dispatchEvent(R_)))}return qe!==null&&(qe.visible=Y!==null),it!==null&&(it.visible=_e!==null),nt!==null&&(nt.visible=Le!==null),this}_getHandJoint(y,b){if(y.joints[b.jointName]===void 0){const D=new Kl;D.matrixAutoUpdate=!1,D.visible=!1,y.joints[b.jointName]=D,y.add(D)}return y.joints[b.jointName]}}class Zp extends Or{constructor(y,b,D,Y,_e,Le,qe,it,nt,mt){if((mt=mt!==void 0?mt:Zr)!==Zr&&mt!==or)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");D===void 0&&mt===Zr&&(D=yn),D===void 0&&mt===or&&(D=jr),super(null,Y,_e,Le,qe,it,mt,D,nt),this.isDepthTexture=!0,this.image={width:y,height:b},this.magFilter=qe!==void 0?qe:Yi,this.minFilter=it!==void 0?it:Yi,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(y){return super.copy(y),this.compareFunction=y.compareFunction,this}toJSON(y){const b=super.toJSON(y);return this.compareFunction!==null&&(b.compareFunction=this.compareFunction),b}}class D_ extends ho{constructor(y,b){super();const D=this;let Y=null,_e=1,Le=null,qe="local-floor",it=1,nt=null,mt=null,bt=null,At=null,wt=null,Et=null;const Mt=b.getContextAttributes();let St=null,Nt=null;const It=[],Rt=[],Yt=new _o;Yt.layers.enable(1),Yt.viewport=new Tr;const Kt=new _o;Kt.layers.enable(2),Kt.viewport=new Tr;const Xt=[Yt,Kt],oi=new Jp;oi.layers.enable(1),oi.layers.enable(2);let wi=null,fi=null;function yi(Oi){const ki=Rt.indexOf(Oi.inputSource);if(ki===-1)return;const Hi=It[ki];Hi!==void 0&&(Hi.update(Oi.inputSource,Oi.frame,nt||Le),Hi.dispatchEvent({type:Oi.type,data:Oi.inputSource}))}function bi(){Y.removeEventListener("select",yi),Y.removeEventListener("selectstart",yi),Y.removeEventListener("selectend",yi),Y.removeEventListener("squeeze",yi),Y.removeEventListener("squeezestart",yi),Y.removeEventListener("squeezeend",yi),Y.removeEventListener("end",bi),Y.removeEventListener("inputsourceschange",Ci);for(let Oi=0;Oi<It.length;Oi++){const ki=Rt[Oi];ki!==null&&(Rt[Oi]=null,It[Oi].disconnect(ki))}wi=null,fi=null,y.setRenderTarget(St),wt=null,At=null,bt=null,Y=null,Nt=null,Wi.stop(),D.isPresenting=!1,D.dispatchEvent({type:"sessionend"})}function Ci(Oi){for(let ki=0;ki<Oi.removed.length;ki++){const Hi=Oi.removed[ki],Vi=Rt.indexOf(Hi);Vi>=0&&(Rt[Vi]=null,It[Vi].disconnect(Hi))}for(let ki=0;ki<Oi.added.length;ki++){const Hi=Oi.added[ki];let Vi=Rt.indexOf(Hi);if(Vi===-1){for(let Wn=0;Wn<It.length;Wn++){if(Wn>=Rt.length){Rt.push(Hi),Vi=Wn;break}if(Rt[Wn]===null){Rt[Wn]=Hi,Vi=Wn;break}}if(Vi===-1)break}const Mn=It[Vi];Mn&&Mn.connect(Hi)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(Oi){let ki=It[Oi];return ki===void 0&&(ki=new Ch,It[Oi]=ki),ki.getTargetRaySpace()},this.getControllerGrip=function(Oi){let ki=It[Oi];return ki===void 0&&(ki=new Ch,It[Oi]=ki),ki.getGripSpace()},this.getHand=function(Oi){let ki=It[Oi];return ki===void 0&&(ki=new Ch,It[Oi]=ki),ki.getHandSpace()},this.setFramebufferScaleFactor=function(Oi){_e=Oi,D.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(Oi){qe=Oi,D.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return nt||Le},this.setReferenceSpace=function(Oi){nt=Oi},this.getBaseLayer=function(){return At!==null?At:wt},this.getBinding=function(){return bt},this.getFrame=function(){return Et},this.getSession=function(){return Y},this.setSession=async function(Oi){if(Y=Oi,Y!==null){if(St=y.getRenderTarget(),Y.addEventListener("select",yi),Y.addEventListener("selectstart",yi),Y.addEventListener("selectend",yi),Y.addEventListener("squeeze",yi),Y.addEventListener("squeezestart",yi),Y.addEventListener("squeezeend",yi),Y.addEventListener("end",bi),Y.addEventListener("inputsourceschange",Ci),Mt.xrCompatible!==!0&&await b.makeXRCompatible(),Y.renderState.layers===void 0||y.capabilities.isWebGL2===!1){const ki={antialias:Y.renderState.layers!==void 0||Mt.antialias,alpha:!0,depth:Mt.depth,stencil:Mt.stencil,framebufferScaleFactor:_e};wt=new XRWebGLLayer(Y,b,ki),Y.updateRenderState({baseLayer:wt}),Nt=new yo(wt.framebufferWidth,wt.framebufferHeight,{format:Nr,type:Un,colorSpace:y.outputColorSpace,stencilBuffer:Mt.stencil})}else{let ki=null,Hi=null,Vi=null;Mt.depth&&(Vi=Mt.stencil?b.DEPTH24_STENCIL8:b.DEPTH_COMPONENT24,ki=Mt.stencil?or:Zr,Hi=Mt.stencil?jr:yn);const Mn={colorFormat:b.RGBA8,depthFormat:Vi,scaleFactor:_e};bt=new XRWebGLBinding(Y,b),At=bt.createProjectionLayer(Mn),Y.updateRenderState({layers:[At]}),Nt=new yo(At.textureWidth,At.textureHeight,{format:Nr,type:Un,depthTexture:new Zp(At.textureWidth,At.textureHeight,Hi,void 0,void 0,void 0,void 0,void 0,void 0,ki),stencilBuffer:Mt.stencil,colorSpace:y.outputColorSpace,samples:Mt.antialias?4:0}),y.properties.get(Nt).__ignoreDepthValues=At.ignoreDepthValues}Nt.isXRRenderTarget=!0,this.setFoveation(it),nt=null,Le=await Y.requestReferenceSpace(qe),Wi.setContext(Y),Wi.start(),D.isPresenting=!0,D.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(Y!==null)return Y.environmentBlendMode};const tn=new ii,$i=new ii;function gn(Oi,ki){ki===null?Oi.matrixWorld.copy(Oi.matrix):Oi.matrixWorld.multiplyMatrices(ki.matrixWorld,Oi.matrix),Oi.matrixWorldInverse.copy(Oi.matrixWorld).invert()}this.updateCamera=function(Oi){if(Y===null)return;oi.near=Kt.near=Yt.near=Oi.near,oi.far=Kt.far=Yt.far=Oi.far,wi===oi.near&&fi===oi.far||(Y.updateRenderState({depthNear:oi.near,depthFar:oi.far}),wi=oi.near,fi=oi.far);const ki=Oi.parent,Hi=oi.cameras;gn(oi,ki);for(let Vi=0;Vi<Hi.length;Vi++)gn(Hi[Vi],ki);Hi.length===2?function(Vi,Mn,Wn){tn.setFromMatrixPosition(Mn.matrixWorld),$i.setFromMatrixPosition(Wn.matrixWorld);const zn=tn.distanceTo($i),Pn=Mn.projectionMatrix.elements,ir=Wn.projectionMatrix.elements,di=Pn[14]/(Pn[10]-1),ei=Pn[14]/(Pn[10]+1),gi=(Pn[9]+1)/Pn[5],Mi=(Pn[9]-1)/Pn[5],ui=(Pn[8]-1)/Pn[0],Qt=(ir[8]+1)/ir[0],hi=di*ui,pi=di*Qt,Bi=zn/(-ui+Qt),Ni=Bi*-ui;Mn.matrixWorld.decompose(Vi.position,Vi.quaternion,Vi.scale),Vi.translateX(Ni),Vi.translateZ(Bi),Vi.matrixWorld.compose(Vi.position,Vi.quaternion,Vi.scale),Vi.matrixWorldInverse.copy(Vi.matrixWorld).invert();const cn=di+Bi,Ji=ei+Bi,lr=hi-Ni,Qn=pi+(zn-Ni),mn=gi*ei/Ji*cn,Hn=Mi*ei/Ji*cn;Vi.projectionMatrix.makePerspective(lr,Qn,mn,Hn,cn,Ji),Vi.projectionMatrixInverse.copy(Vi.projectionMatrix).invert()}(oi,Yt,Kt):oi.projectionMatrix.copy(Yt.projectionMatrix),function(Vi,Mn,Wn){Wn===null?Vi.matrix.copy(Mn.matrixWorld):(Vi.matrix.copy(Wn.matrixWorld),Vi.matrix.invert(),Vi.matrix.multiply(Mn.matrixWorld)),Vi.matrix.decompose(Vi.position,Vi.quaternion,Vi.scale),Vi.updateMatrixWorld(!0),Vi.projectionMatrix.copy(Mn.projectionMatrix),Vi.projectionMatrixInverse.copy(Mn.projectionMatrixInverse),Vi.isPerspectiveCamera&&(Vi.fov=2*Fs*Math.atan(1/Vi.projectionMatrix.elements[5]),Vi.zoom=1)}(Oi,oi,ki)},this.getCamera=function(){return oi},this.getFoveation=function(){if(At!==null||wt!==null)return it},this.setFoveation=function(Oi){it=Oi,At!==null&&(At.fixedFoveation=Oi),wt!==null&&wt.fixedFoveation!==void 0&&(wt.fixedFoveation=Oi)};let xn=null;this.onPreAnimationFrameCallback=null;const Wi=new Sp;Wi.setAnimationLoop(function(Oi,ki){if(D.onPreAnimationFrameCallback&&D.onPreAnimationFrameCallback(Oi,ki),mt=ki.getViewerPose(nt||Le),Et=ki,mt!==null){const Hi=mt.views;wt!==null&&(y.setRenderTargetFramebuffer(Nt,wt.framebuffer),y.setRenderTarget(Nt));let Vi=!1;Hi.length!==oi.cameras.length&&(oi.cameras.length=0,Vi=!0);for(let Mn=0;Mn<Hi.length;Mn++){const Wn=Hi[Mn];let zn=null;if(wt!==null)zn=wt.getViewport(Wn);else{const ir=bt.getViewSubImage(At,Wn);zn=ir.viewport,Mn===0&&(y.setRenderTargetTextures(Nt,ir.colorTexture,At.ignoreDepthValues?void 0:ir.depthStencilTexture),y.setRenderTarget(Nt))}let Pn=Xt[Mn];Pn===void 0&&(Pn=new _o,Pn.layers.enable(Mn),Pn.viewport=new Tr,Xt[Mn]=Pn),Pn.matrix.fromArray(Wn.transform.matrix),Pn.matrix.decompose(Pn.position,Pn.quaternion,Pn.scale),Pn.projectionMatrix.fromArray(Wn.projectionMatrix),Pn.projectionMatrixInverse.copy(Pn.projectionMatrix).invert(),Pn.viewport.set(zn.x,zn.y,zn.width,zn.height),Mn===0&&(oi.matrix.copy(Pn.matrix),oi.matrix.decompose(oi.position,oi.quaternion,oi.scale)),Vi===!0&&oi.cameras.push(Pn)}}for(let Hi=0;Hi<It.length;Hi++){const Vi=Rt[Hi],Mn=It[Hi];Vi!==null&&Mn!==void 0&&Mn.update(Vi,ki,nt||Le)}xn&&xn(Oi,ki),ki.detectedPlanes&&D.dispatchEvent({type:"planesdetected",data:ki}),Et=null}),this.setAnimationLoop=function(Oi){xn=Oi},this.dispose=function(){}}}function B_(De,y){function b(Y,_e){Y.matrixAutoUpdate===!0&&Y.updateMatrix(),_e.value.copy(Y.matrix)}function D(Y,_e){Y.opacity.value=_e.opacity,_e.color&&Y.diffuse.value.copy(_e.color),_e.emissive&&Y.emissive.value.copy(_e.emissive).multiplyScalar(_e.emissiveIntensity),_e.map&&(Y.map.value=_e.map,b(_e.map,Y.mapTransform)),_e.alphaMap&&(Y.alphaMap.value=_e.alphaMap,b(_e.alphaMap,Y.alphaMapTransform)),_e.bumpMap&&(Y.bumpMap.value=_e.bumpMap,b(_e.bumpMap,Y.bumpMapTransform),Y.bumpScale.value=_e.bumpScale,_e.side===ye&&(Y.bumpScale.value*=-1)),_e.normalMap&&(Y.normalMap.value=_e.normalMap,b(_e.normalMap,Y.normalMapTransform),Y.normalScale.value.copy(_e.normalScale),_e.side===ye&&Y.normalScale.value.negate()),_e.displacementMap&&(Y.displacementMap.value=_e.displacementMap,b(_e.displacementMap,Y.displacementMapTransform),Y.displacementScale.value=_e.displacementScale,Y.displacementBias.value=_e.displacementBias),_e.emissiveMap&&(Y.emissiveMap.value=_e.emissiveMap,b(_e.emissiveMap,Y.emissiveMapTransform)),_e.specularMap&&(Y.specularMap.value=_e.specularMap,b(_e.specularMap,Y.specularMapTransform)),_e.alphaTest>0&&(Y.alphaTest.value=_e.alphaTest);const Le=y.get(_e).envMap;if(Le){Y.envMap.value=Le;const qe=_e.envMap||y.get(_e).environment||Le;Y.envMapRotation.value=qe?qe.rotation:0,Y.flipEnvMap.value=Le.isCubeTexture&&Le.isRenderTargetTexture===!1?-1:1,Y.reflectivity.value=_e.reflectivity,Y.ior.value=_e.ior,Y.refractionRatio.value=_e.refractionRatio}if(_e.lightMap){Y.lightMap.value=_e.lightMap;const qe=De._useLegacyLights===!0?Math.PI:1;Y.lightMapIntensity.value=_e.lightMapIntensity*qe,b(_e.lightMap,Y.lightMapTransform)}_e.aoMap&&(Y.aoMap.value=_e.aoMap,Y.aoMapIntensity.value=_e.aoMapIntensity,b(_e.aoMap,Y.aoMapTransform))}return{refreshTransformUniform:b,refreshFogUniforms:function(Y,_e){_e.color.getRGB(Y.fogColor.value,bp(De)),_e.isFog?(Y.fogNear.value=_e.near,Y.fogFar.value=_e.far):_e.isFogExp2&&(Y.fogDensity.value=_e.density)},refreshMaterialUniforms:function(Y,_e,Le,qe,it){_e.isMeshBasicMaterial||_e.isMeshLambertMaterial?D(Y,_e):_e.isMeshToonMaterial?(D(Y,_e),function(nt,mt){mt.gradientMap&&(nt.gradientMap.value=mt.gradientMap)}(Y,_e)):_e.isMeshPhongMaterial?(D(Y,_e),function(nt,mt){nt.specular.value.copy(mt.specular),nt.shininess.value=Math.max(mt.shininess,1e-4)}(Y,_e)):_e.isMeshStandardMaterial?(D(Y,_e),function(nt,mt){nt.metalness.value=mt.metalness,mt.metalnessMap&&(nt.metalnessMap.value=mt.metalnessMap,b(mt.metalnessMap,nt.metalnessMapTransform)),nt.roughness.value=mt.roughness,mt.roughnessMap&&(nt.roughnessMap.value=mt.roughnessMap,b(mt.roughnessMap,nt.roughnessMapTransform)),y.get(mt).envMap&&(nt.envMapIntensity.value=mt.envMapIntensity)}(Y,_e),_e.isMeshPhysicalMaterial&&function(nt,mt,bt){nt.ior.value=mt.ior,mt.sheen>0&&(nt.sheenColor.value.copy(mt.sheenColor).multiplyScalar(mt.sheen),nt.sheenRoughness.value=mt.sheenRoughness,mt.sheenColorMap&&(nt.sheenColorMap.value=mt.sheenColorMap,b(mt.sheenColorMap,nt.sheenColorMapTransform)),mt.sheenRoughnessMap&&(nt.sheenRoughnessMap.value=mt.sheenRoughnessMap,b(mt.sheenRoughnessMap,nt.sheenRoughnessMapTransform))),mt.clearcoat>0&&(nt.clearcoat.value=mt.clearcoat,nt.clearcoatRoughness.value=mt.clearcoatRoughness,mt.clearcoatMap&&(nt.clearcoatMap.value=mt.clearcoatMap,b(mt.clearcoatMap,nt.clearcoatMapTransform)),mt.clearcoatRoughnessMap&&(nt.clearcoatRoughnessMap.value=mt.clearcoatRoughnessMap,b(mt.clearcoatRoughnessMap,nt.clearcoatRoughnessMapTransform)),mt.clearcoatNormalMap&&(nt.clearcoatNormalMap.value=mt.clearcoatNormalMap,b(mt.clearcoatNormalMap,nt.clearcoatNormalMapTransform),nt.clearcoatNormalScale.value.copy(mt.clearcoatNormalScale),mt.side===ye&&nt.clearcoatNormalScale.value.negate())),mt.iridescence>0&&(nt.iridescence.value=mt.iridescence,nt.iridescenceIOR.value=mt.iridescenceIOR,nt.iridescenceThicknessMinimum.value=mt.iridescenceThicknessRange[0],nt.iridescenceThicknessMaximum.value=mt.iridescenceThicknessRange[1],mt.iridescenceMap&&(nt.iridescenceMap.value=mt.iridescenceMap,b(mt.iridescenceMap,nt.iridescenceMapTransform)),mt.iridescenceThicknessMap&&(nt.iridescenceThicknessMap.value=mt.iridescenceThicknessMap,b(mt.iridescenceThicknessMap,nt.iridescenceThicknessMapTransform))),mt.transmission>0&&(nt.transmission.value=mt.transmission,nt.transmissionSamplerMap.value=bt.texture,nt.transmissionSamplerSize.value.set(bt.width,bt.height),mt.transmissionMap&&(nt.transmissionMap.value=mt.transmissionMap,b(mt.transmissionMap,nt.transmissionMapTransform)),nt.thickness.value=mt.thickness,mt.thicknessMap&&(nt.thicknessMap.value=mt.thicknessMap,b(mt.thicknessMap,nt.thicknessMapTransform)),nt.attenuationDistance.value=mt.attenuationDistance,nt.attenuationColor.value.copy(mt.attenuationColor)),mt.anisotropy>0&&(nt.anisotropyVector.value.set(mt.anisotropy*Math.cos(mt.anisotropyRotation),mt.anisotropy*Math.sin(mt.anisotropyRotation)),mt.anisotropyMap&&(nt.anisotropyMap.value=mt.anisotropyMap,b(mt.anisotropyMap,nt.anisotropyMapTransform))),nt.specularIntensity.value=mt.specularIntensity,nt.specularColor.value.copy(mt.specularColor),mt.specularColorMap&&(nt.specularColorMap.value=mt.specularColorMap,b(mt.specularColorMap,nt.specularColorMapTransform)),mt.specularIntensityMap&&(nt.specularIntensityMap.value=mt.specularIntensityMap,b(mt.specularIntensityMap,nt.specularIntensityMapTransform))}(Y,_e,it)):_e.isMeshMatcapMaterial?(D(Y,_e),function(nt,mt){mt.matcap&&(nt.matcap.value=mt.matcap)}(Y,_e)):_e.isMeshDepthMaterial?D(Y,_e):_e.isMeshDistanceMaterial?(D(Y,_e),function(nt,mt){const bt=y.get(mt).light;nt.referencePosition.value.setFromMatrixPosition(bt.matrixWorld),nt.nearDistance.value=bt.shadow.camera.near,nt.farDistance.value=bt.shadow.camera.far}(Y,_e)):_e.isMeshNormalMaterial?D(Y,_e):_e.isLineBasicMaterial?(function(nt,mt){nt.diffuse.value.copy(mt.color),nt.opacity.value=mt.opacity,mt.map&&(nt.map.value=mt.map,b(mt.map,nt.mapTransform))}(Y,_e),_e.isLineDashedMaterial&&function(nt,mt){nt.dashSize.value=mt.dashSize,nt.totalSize.value=mt.dashSize+mt.gapSize,nt.scale.value=mt.scale}(Y,_e)):_e.isPointsMaterial?function(nt,mt,bt,At){nt.diffuse.value.copy(mt.color),nt.opacity.value=mt.opacity,nt.size.value=mt.size*bt,nt.scale.value=.5*At,mt.map&&(nt.map.value=mt.map,b(mt.map,nt.uvTransform)),mt.alphaMap&&(nt.alphaMap.value=mt.alphaMap,b(mt.alphaMap,nt.alphaMapTransform)),mt.alphaTest>0&&(nt.alphaTest.value=mt.alphaTest)}(Y,_e,Le,qe):_e.isSpriteMaterial?function(nt,mt){nt.diffuse.value.copy(mt.color),nt.opacity.value=mt.opacity,nt.rotation.value=mt.rotation,mt.map&&(nt.map.value=mt.map,b(mt.map,nt.mapTransform)),mt.alphaMap&&(nt.alphaMap.value=mt.alphaMap,b(mt.alphaMap,nt.alphaMapTransform)),mt.alphaTest>0&&(nt.alphaTest.value=mt.alphaTest)}(Y,_e):_e.isShadowMaterial?(Y.color.value.copy(_e.color),Y.opacity.value=_e.opacity):_e.isShaderMaterial&&(_e.transmission!==void 0&&(Y.transmission&&(Y.transmission.value=_e.transmission),Y.transmissionSamplerMap&&it&&(Y.transmissionSamplerMap.value=it?it.texture:null),Y.transmissionSamplerSize&&it&&Y.transmissionSamplerSize.value.set(it.width,it.height)),_e.uniformsNeedUpdate=!1)}}}function O_(De,y,b,D){let Y={},_e={},Le=[];const qe=b.isWebGL2?De.getParameter(De.MAX_UNIFORM_BUFFER_BINDINGS):0;function it(bt,At,wt){const Et=bt.value;if(wt[At]===void 0){if(typeof Et=="number")wt[At]=Et;else{const Mt=Array.isArray(Et)?Et:[Et],St=[];for(let Nt=0;Nt<Mt.length;Nt++)St.push(Mt[Nt].clone());wt[At]=St}return!0}if(typeof Et=="number"){if(wt[At]!==Et)return wt[At]=Et,!0}else{const Mt=Array.isArray(wt[At])?wt[At]:[wt[At]],St=Array.isArray(Et)?Et:[Et];for(let Nt=0;Nt<Mt.length;Nt++){const It=Mt[Nt];if(It.equals(St[Nt])===!1)return It.copy(St[Nt]),!0}}return!1}function nt(bt){const At={boundary:0,storage:0};return typeof bt=="number"?(At.boundary=4,At.storage=4):bt.isVector2?(At.boundary=8,At.storage=8):bt.isVector3||bt.isColor?(At.boundary=16,At.storage=12):bt.isVector4?(At.boundary=16,At.storage=16):bt.isMatrix3?(At.boundary=48,At.storage=48):bt.isMatrix4?(At.boundary=64,At.storage=64):bt.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",bt),At}function mt(bt){const At=bt.target;At.removeEventListener("dispose",mt);const wt=Le.indexOf(At.__bindingPointIndex);Le.splice(wt,1),De.deleteBuffer(Y[At.id]),delete Y[At.id],delete _e[At.id]}return{bind:function(bt,At){const wt=At.program;D.uniformBlockBinding(bt,wt)},update:function(bt,At){let wt=Y[bt.id];wt===void 0&&(function(St){const Nt=St.uniforms;let It=0,Rt=0;for(let Yt=0,Kt=Nt.length;Yt<Kt;Yt++){const Xt=Nt[Yt],oi={boundary:0,storage:0},wi=Array.isArray(Xt.value)?Xt.value:[Xt.value];for(let fi=0,yi=wi.length;fi<yi;fi++){const bi=nt(wi[fi]);oi.boundary+=bi.boundary,oi.storage+=bi.storage}Xt.__data=new Float32Array(oi.storage/Float32Array.BYTES_PER_ELEMENT),Xt.__offset=It,Yt>0&&(Rt=It%16,Rt!==0&&16-Rt-oi.boundary<0&&(It+=16-Rt,Xt.__offset=It)),It+=oi.storage}Rt=It%16,Rt>0&&(It+=16-Rt),St.__size=It,St.__cache={}}(bt),wt=function(St){const Nt=function(){for(let Kt=0;Kt<qe;Kt++)if(Le.indexOf(Kt)===-1)return Le.push(Kt),Kt;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();St.__bindingPointIndex=Nt;const It=De.createBuffer(),Rt=St.__size,Yt=St.usage;return De.bindBuffer(De.UNIFORM_BUFFER,It),De.bufferData(De.UNIFORM_BUFFER,Rt,Yt),De.bindBuffer(De.UNIFORM_BUFFER,null),De.bindBufferBase(De.UNIFORM_BUFFER,Nt,It),It}(bt),Y[bt.id]=wt,bt.addEventListener("dispose",mt));const Et=At.program;D.updateUBOMapping(bt,Et);const Mt=y.render.frame;_e[bt.id]!==Mt&&(function(St){const Nt=Y[St.id],It=St.uniforms,Rt=St.__cache;De.bindBuffer(De.UNIFORM_BUFFER,Nt);for(let Yt=0,Kt=It.length;Yt<Kt;Yt++){const Xt=It[Yt];if(it(Xt,Yt,Rt)===!0){const oi=Xt.__offset,wi=Array.isArray(Xt.value)?Xt.value:[Xt.value];let fi=0;for(let yi=0;yi<wi.length;yi++){const bi=wi[yi],Ci=nt(bi);typeof bi=="number"?(Xt.__data[0]=bi,De.bufferSubData(De.UNIFORM_BUFFER,oi+fi,Xt.__data)):bi.isMatrix3?(Xt.__data[0]=bi.elements[0],Xt.__data[1]=bi.elements[1],Xt.__data[2]=bi.elements[2],Xt.__data[3]=bi.elements[0],Xt.__data[4]=bi.elements[3],Xt.__data[5]=bi.elements[4],Xt.__data[6]=bi.elements[5],Xt.__data[7]=bi.elements[0],Xt.__data[8]=bi.elements[6],Xt.__data[9]=bi.elements[7],Xt.__data[10]=bi.elements[8],Xt.__data[11]=bi.elements[0]):(bi.toArray(Xt.__data,fi),fi+=Ci.storage/Float32Array.BYTES_PER_ELEMENT)}De.bufferSubData(De.UNIFORM_BUFFER,oi,Xt.__data)}}De.bindBuffer(De.UNIFORM_BUFFER,null)}(bt),_e[bt.id]=Mt)},dispose:function(){for(const bt in Y)De.deleteBuffer(Y[bt]);Le=[],Y={},_e={}}}}class em{constructor(y={}){const{canvas:b=Ic(),context:D=null,depth:Y=!0,stencil:_e=!0,alpha:Le=!1,antialias:qe=!1,premultipliedAlpha:it=!0,preserveDrawingBuffer:nt=!1,powerPreference:mt="default",failIfMajorPerformanceCaveat:bt=!1}=y;let At;this.isWebGLRenderer=!0,At=D!==null?D.getContextAttributes().alpha:Le;const wt=new Uint32Array(4),Et=new Int32Array(4);let Mt=null,St=null;const Nt=[],It=[];this.domElement=b,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=Rr,this._useLegacyLights=!1,this.toneMapping=_i,this.toneMappingExposure=1,this.userData={},this.onContextLost=()=>{},this.onContextRestore=()=>{},this.onContextCreationError=()=>{};const Rt=this;let Yt=!1,Kt=0,Xt=0,oi=null,wi=-1,fi=null;const yi=new Tr,bi=new Tr;let Ci=null;const tn=new Dn(0);let $i=0,gn=b.width,xn=b.height,Wi=1,Oi=null,ki=null;const Hi=new Tr(0,0,gn,xn),Vi=new Tr(0,0,gn,xn);let Mn=!1;const Wn=new nd;let zn=!1,Pn=!1,ir=null;const di=new Xn,ei=new en,gi=new ii,Mi={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function ui(){return oi===null?Wi:1}let Qt,hi,pi,Bi,Ni,cn,Ji,lr,Qn,mn,Hn,jn,nr,hr,Pr,br,Gn,_r,Wo,rr,Lr,vr,Ys,Ks,ji=D;function Jd(ai,zi){for(let Qi=0;Qi<ai.length;Qi++){const qi=ai[Qi],on=b.getContext(qi,zi);if(on!==null)return on}return null}try{const ai={alpha:!0,depth:Y,stencil:_e,antialias:qe,premultipliedAlpha:it,preserveDrawingBuffer:nt,powerPreference:mt,failIfMajorPerformanceCaveat:bt};if("setAttribute"in b&&b.setAttribute("data-engine",`three.js r${c}`),b.addEventListener("webglcontextlost",_u,!1),b.addEventListener("webglcontextrestored",jf,!1),b.addEventListener("webglcontextcreationerror",Gf,!1),ji===null){const zi=["webgl2","webgl","experimental-webgl"];if(Rt.isWebGL1Renderer===!0&&zi.shift(),ji=Jd(zi,ai),ji===null)throw Jd(zi)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}typeof WebGLRenderingContext<"u"&&ji instanceof WebGLRenderingContext&&console.warn("THREE.WebGLRenderer: WebGL 1 support was deprecated in r153 and will be removed in r163."),ji.getShaderPrecisionFormat===void 0&&(ji.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(ai){throw console.error("THREE.WebGLRenderer: "+ai.message),ai}function Zd(){Qt=new ug(ji),hi=new sg(ji,Qt,y),Qt.init(hi),vr=new $p(ji,Qt,hi),pi=new P_(ji,Qt,hi),Bi=new pg(ji),Ni=new A_,cn=new I_(ji,Qt,pi,Ni,hi,vr,Bi),Ji=new lg(Rt),lr=new cg(Rt),Qn=new ig(ji,hi),Ys=new rg(ji,Qt,Qn,hi),mn=new dg(ji,Qn,Bi,Ys),Hn=new _g(ji,mn,Qn,Bi),Wo=new gg(ji,hi,cn),br=new ag(Ni),jn=new y_(Rt,Ji,lr,Qt,hi,Ys,br),nr=new B_(Rt,Ni),hr=new x_,Pr=new C_(Qt,hi),_r=new ng(Rt,Ji,lr,pi,Hn,At,it),Gn=new M_(Rt,Hn,hi),Ks=new O_(ji,Bi,hi,pi),rr=new og(ji,Qt,Bi,hi),Lr=new hg(ji,Qt,Bi,hi),Bi.programs=jn.programs,Rt.capabilities=hi,Rt.extensions=Qt,Rt.properties=Ni,Rt.renderLists=hr,Rt.shadowMap=Gn,Rt.state=pi,Rt.info=Bi,Rt.background=_r,Rt.cubemaps=Ji,Rt.cubeuvmaps=lr,Rt.materials=nr}Zd();const wo=new D_(Rt,ji);function _u(ai){ai.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),Yt=!0,Rt.onContextLost(ai)}function jf(){console.log("THREE.WebGLRenderer: Context Restored."),Yt=!1;const ai=Rt.info?Rt.info.autoReset:void 0,zi=Gn.enabled,Qi=Gn.autoUpdate,qi=Gn.needsUpdate,on=Gn.type;Zd(),Rt.info&&ai!==void 0&&(Rt.info.autoReset=ai),Gn.enabled=zi,Gn.autoUpdate=Qi,Gn.needsUpdate=qi,Gn.type=on,Rt.onContextRestore&&Rt.onContextRestore()}function Gf(ai){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",ai.statusMessage),Rt.onContextCreationError(ai)}function zf(ai){const zi=ai.target;zi.removeEventListener("dispose",zf),function(Qi){(function(qi){const on=Ni.get(qi).programs;on!==void 0&&(on.forEach(function(En){jn.releaseProgram(En)}),qi.isShaderMaterial&&jn.releaseShaderCache(qi))})(Qi),Ni.remove(Qi)}(zi)}this.xr=wo,this.getContext=function(){return ji},this.getContextAttributes=function(){return ji.getContextAttributes()},this.forceContextLoss=function(){const ai=Qt.get("WEBGL_lose_context");ai&&ai.loseContext()},this.forceContextRestore=function(){const ai=Qt.get("WEBGL_lose_context");ai&&ai.restoreContext()},this.getPixelRatio=function(){return Wi},this.setPixelRatio=function(ai){ai!==void 0&&(Wi=ai,this.setSize(gn,xn,!1))},this.getSize=function(ai){return ai.set(gn,xn)},this.setSize=function(ai,zi,Qi=!0){wo.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(gn=ai,xn=zi,b.width=Math.floor(ai*Wi),b.height=Math.floor(zi*Wi),Qi===!0&&(b.style.width=ai+"px",b.style.height=zi+"px"),this.setViewport(0,0,ai,zi))},this.getDrawingBufferSize=function(ai){return ai.set(gn*Wi,xn*Wi).floor()},this.setDrawingBufferSize=function(ai,zi,Qi){gn=ai,xn=zi,Wi=Qi,b.width=Math.floor(ai*Qi),b.height=Math.floor(zi*Qi),this.setViewport(0,0,ai,zi)},this.getCurrentViewport=function(ai){return ai.copy(yi)},this.getViewport=function(ai){return ai.copy(Hi)},this.setViewport=function(ai,zi,Qi,qi){ai.isVector4?Hi.set(ai.x,ai.y,ai.z,ai.w):Hi.set(ai,zi,Qi,qi),pi.viewport(yi.copy(Hi).multiplyScalar(Wi).floor())},this.getScissor=function(ai){return ai.copy(Vi)},this.setScissor=function(ai,zi,Qi,qi){ai.isVector4?Vi.set(ai.x,ai.y,ai.z,ai.w):Vi.set(ai,zi,Qi,qi),pi.scissor(bi.copy(Vi).multiplyScalar(Wi).floor())},this.getScissorTest=function(){return Mn},this.setScissorTest=function(ai){pi.setScissorTest(Mn=ai)},this.setOpaqueSort=function(ai){Oi=ai},this.setTransparentSort=function(ai){ki=ai},this.getClearColor=function(ai){return ai.copy(_r.getClearColor())},this.setClearColor=function(){_r.setClearColor.apply(_r,arguments)},this.getClearAlpha=function(){return _r.getClearAlpha()},this.setClearAlpha=function(){_r.setClearAlpha.apply(_r,arguments)},this.clear=function(ai=!0,zi=!0,Qi=!0){let qi=0;if(ai){let on=!1;if(oi!==null){const En=oi.texture.format;on=En===Er||En===cr||En===Kr}if(on){const En=oi.texture.type,gr=En===Un||En===yn||En===Ki||En===jr||En===fr||En===wr,Vn=_r.getClearColor(),sr=_r.getClearAlpha(),pr=Vn.r,mr=Vn.g,Jn=Vn.b;gr?(wt[0]=pr,wt[1]=mr,wt[2]=Jn,wt[3]=sr,ji.clearBufferuiv(ji.COLOR,0,wt)):(Et[0]=pr,Et[1]=mr,Et[2]=Jn,Et[3]=sr,ji.clearBufferiv(ji.COLOR,0,Et))}else qi|=ji.COLOR_BUFFER_BIT}zi&&(qi|=ji.DEPTH_BUFFER_BIT),Qi&&(qi|=ji.STENCIL_BUFFER_BIT),ji.clear(qi)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){b.removeEventListener("webglcontextlost",_u,!1),b.removeEventListener("webglcontextrestored",jf,!1),b.removeEventListener("webglcontextcreationerror",Gf,!1),hr.dispose(),Pr.dispose(),Ni.dispose(),Ji.dispose(),lr.dispose(),Hn.dispose(),Ys.dispose(),Ks.dispose(),jn.dispose(),wo.dispose(),wo.removeEventListener("sessionstart",Vf),wo.removeEventListener("sessionend",Hf),ir&&(ir.dispose(),ir=null),ul.stop()},this.renderBufferDirect=function(ai,zi,Qi,qi,on,En){zi===null&&(zi=Mi);const gr=on.isMesh&&on.matrixWorld.determinant()<0,Vn=function(Qr,Xo,ko,Yn,zr){Xo.isScene!==!0&&(Xo=Mi),cn.resetTextureUnits();const vu=Xo.fog,$v=Yn.userData&&Yn.userData.envMapSlotKey&&Xo.textureSlots&&Xo.textureSlots[Yn.userData.envMapSlotKey]?Xo.textureSlots[Yn.userData.envMapSlotKey]:Yn.isMeshStandardMaterial?Xo.environment:null,Jv=oi===null?Rt.outputColorSpace:oi.isXRRenderTarget===!0||oi.texture.colorSpace&&oi.texture.colorSpace!==Rr?oi.texture.colorSpace:Fr,ih=(Yn.isMeshStandardMaterial?lr:Ji).get(Yn.envMap||$v),Zv=Yn.vertexColors===!0&&!!ko.attributes.color&&ko.attributes.color.itemSize===4,e0=!!ko.attributes.tangent&&(!!Yn.normalMap||Yn.anisotropy>0||ko.userData.__forceUseTangent),t0=!!ko.morphAttributes.position,i0=!!ko.morphAttributes.normal,n0=!!ko.morphAttributes.color;let Yf=_i;Yn.toneMapped&&(oi!==null&&oi.isXRRenderTarget!==!0||(Yf=Rt.toneMapping));const Kf=ko.morphAttributes.position||ko.morphAttributes.normal||ko.morphAttributes.color,r0=Kf!==void 0?Kf.length:0,Ir=Ni.get(Yn),o0=St.state.lights;if(zn===!0&&(Pn===!0||Qr!==fi)){const Ro=Qr===fi&&Yn.id===wi;br.setState(Yn,Qr,Ro)}let $s=!1;Yn.version===Ir.__version?Ir.needsLights&&Ir.lightsStateVersion!==o0.state.version||Ir.outputColorSpace!==Jv||zr.isInstancedMesh&&Ir.instancing===!1?$s=!0:zr.isInstancedMesh||Ir.instancing!==!0?zr.isSkinnedMesh&&Ir.skinning===!1?$s=!0:zr.isSkinnedMesh||Ir.skinning!==!0?zr.isInstancedMesh&&Ir.instancingColor===!0&&zr.instanceColor===null||zr.isInstancedMesh&&Ir.instancingColor===!1&&zr.instanceColor!==null||Ir.envMap!==ih||Yn.fog===!0&&Ir.fog!==vu?$s=!0:Ir.numClippingPlanes===void 0||Ir.numClippingPlanes===br.numPlanes&&Ir.numIntersection===br.numIntersection?(Ir.vertexAlphas!==Zv||Ir.vertexTangents!==e0||Ir.morphTargets!==t0||Ir.morphNormals!==i0||Ir.morphColors!==n0||Ir.toneMapping!==Yf||hi.isWebGL2===!0&&Ir.morphTargetsCount!==r0)&&($s=!0):$s=!0:$s=!0:$s=!0:($s=!0,Ir.__version=Yn.version);let dl=Ir.currentProgram;$s===!0&&(dl=th(Yn,Xo,zr));let $f=!1,yu=!1,pp=!1;const Eo=dl.getUniforms(),hl=Ir.uniforms;if(pi.useProgram(dl.program)&&($f=!0,yu=!0,pp=!0),Yn.id!==wi&&(wi=Yn.id,yu=!0),$f||fi!==Qr){Eo.setValue(ji,"projectionMatrix",Qr.projectionMatrix),Eo.setValue(ji,"viewMatrix",Qr.matrixWorldInverse);const Ro=Eo.map.cameraPosition;Ro!==void 0&&Ro.setValue(ji,gi.setFromMatrixPosition(Qr.matrixWorld)),hi.logarithmicDepthBuffer&&Eo.setValue(ji,"logDepthBufFC",2/(Math.log(Qr.far+1)/Math.LN2)),(Yn.isMeshPhongMaterial||Yn.isMeshToonMaterial||Yn.isMeshLambertMaterial||Yn.isMeshBasicMaterial||Yn.isMeshStandardMaterial||Yn.isShaderMaterial)&&Eo.setValue(ji,"isOrthographic",Qr.isOrthographicCamera===!0),fi!==Qr&&(fi=Qr,yu=!0,pp=!0)}if(zr.isSkinnedMesh){Eo.setOptional(ji,zr,"bindMatrix"),Eo.setOptional(ji,zr,"bindMatrixInverse");const Ro=zr.skeleton;Ro&&(hi.floatVertexTextures?(Ro.boneTexture===null&&Ro.computeBoneTexture(),Eo.setValue(ji,"boneTexture",Ro.boneTexture,cn),Eo.setValue(ji,"boneTextureSize",Ro.boneTextureSize)):console.warn("THREE.WebGLRenderer: SkinnedMesh can only be used with WebGL 2. With WebGL 1 OES_texture_float and vertex textures support is required."))}const mp=ko.morphAttributes;var Ps,fs;(mp.position!==void 0||mp.normal!==void 0||mp.color!==void 0&&hi.isWebGL2===!0)&&Wo.update(zr,ko,dl),(yu||Ir.receiveShadow!==zr.receiveShadow)&&(Ir.receiveShadow=zr.receiveShadow,Eo.setValue(ji,"receiveShadow",zr.receiveShadow)),Yn.isMeshGouraudMaterial&&Yn.envMap!==null&&(hl.envMap.value=ih,hl.flipEnvMap.value=ih.isCubeTexture&&ih.isRenderTargetTexture===!1?-1:1),yu&&(Eo.setValue(ji,"toneMappingExposure",Rt.toneMappingExposure),Ir.needsLights&&(fs=pp,(Ps=hl).ambientLightColor.needsUpdate=fs,Ps.lightProbe.needsUpdate=fs,Ps.directionalLights.needsUpdate=fs,Ps.directionalLightShadows.needsUpdate=fs,Ps.pointLights.needsUpdate=fs,Ps.pointLightShadows.needsUpdate=fs,Ps.spotLights.needsUpdate=fs,Ps.spotLightShadows.needsUpdate=fs,Ps.rectAreaLights.needsUpdate=fs,Ps.hemisphereLights.needsUpdate=fs),vu&&Yn.fog===!0&&nr.refreshFogUniforms(hl,vu),nr.refreshMaterialUniforms(hl,Yn,Wi,xn,Rt.userData.transmissionRenderTarget||ir),ld.upload(ji,Ir.uniformsList,hl,cn)),Yn.isShaderMaterial&&Yn.uniformsNeedUpdate===!0&&(ld.upload(ji,Ir.uniformsList,hl,cn),Yn.uniformsNeedUpdate=!1),Yn.isSpriteMaterial&&Eo.setValue(ji,"center",zr.center),Eo.setValue(ji,"modelViewMatrix",zr.modelViewMatrix),Eo.setValue(ji,"normalMatrix",zr.normalMatrix),Eo.setValue(ji,"modelMatrix",zr.matrixWorld);const Jf=Yn.extraUniformsToUpload;if(Jf&&Object.entries(Jf).forEach(([Ro,Au])=>Eo.setValue(ji,Ro,Au.value,cn)),Yn.isShaderMaterial||Yn.isRawShaderMaterial){const Ro=Yn.uniformsGroups;for(let Au=0,s0=Ro.length;Au<s0;Au++)if(hi.isWebGL2){const Zf=Ro[Au];Ks.update(Zf,dl),Ks.bind(Zf,dl)}else console.warn("THREE.WebGLRenderer: Uniform Buffer Objects can only be used with WebGL 2.")}return dl}(ai,zi,Qi,qi,on);pi.setMaterial(qi,gr);let sr=Qi.index,pr=1;if(qi.wireframe===!0){if(sr=mn.getWireframeAttribute(Qi),sr===void 0)return;pr=2}const mr=Qi.drawRange,Jn=Qi.attributes.position;let ao=mr.start*pr,qo=(mr.start+mr.count)*pr;En!==null&&(ao=Math.max(ao,En.start*pr),qo=Math.min(qo,(En.start+En.count)*pr)),sr!==null?(ao=Math.max(ao,0),qo=Math.min(qo,sr.count)):Jn!=null&&(ao=Math.max(ao,0),qo=Math.min(qo,Jn.count));const lo=qo-ao;if(lo<0||lo===1/0)return;let Ia;Ys.setup(on,qi,Vn,Qi,sr);let Yr=rr;if(sr!==null&&(Ia=Qn.get(sr),Yr=Lr,Yr.setIndex(Ia)),on.isMesh)qi.wireframe===!0?(pi.setLineWidth(qi.wireframeLinewidth*ui()),Yr.setMode(ji.LINES)):Yr.setMode(ji.TRIANGLES);else if(on.isLine){let Qr=qi.linewidth;Qr===void 0&&(Qr=1),pi.setLineWidth(Qr*ui()),on.isLineSegments?Yr.setMode(ji.LINES):on.isLineLoop?Yr.setMode(ji.LINE_LOOP):Yr.setMode(ji.LINE_STRIP)}else on.isPoints?Yr.setMode(ji.POINTS):on.isSprite&&Yr.setMode(ji.TRIANGLES);if(on.isInstancedMesh)Yr.renderInstances(ao,lo,on.count);else if(Qi.isInstancedBufferGeometry){const Qr=Qi._maxInstanceCount!==void 0?Qi._maxInstanceCount:1/0,Xo=Math.min(Qi.instanceCount,Qr);Yr.renderInstances(ao,lo,Xo)}else Yr.render(ao,lo)},this.compile=function(ai,zi){function Qi(qi,on,En){qi.transparent===!0&&qi.side===Oe&&qi.forceSinglePass===!1?(qi.side=ye,qi.needsUpdate=!0,th(qi,on,En),qi.side=ue,qi.needsUpdate=!0,th(qi,on,En),qi.side=Oe):th(qi,on,En)}St=Pr.get(ai),St.init(),It.push(St),ai.traverseVisible(function(qi){qi.isLight&&qi.layers.test(zi.layers)&&(St.pushLight(qi),qi.castShadow&&St.pushShadow(qi))}),St.setupLights(Rt._useLegacyLights),ai.traverse(function(qi){const on=qi.material;if(on)if(Array.isArray(on))for(let En=0;En<on.length;En++)Qi(on[En],ai,qi);else Qi(on,ai,qi)}),It.pop(),St=null};let hp=null;function Vf(){ul.stop()}function Hf(){ul.start()}const ul=new Sp;function Qf(ai,zi,Qi,qi){if(ai.visible===!1)return;if(ai.layers.test(zi.layers)){if(ai.isGroup)Qi=ai.renderOrder;else if(ai.isLOD)ai.autoUpdate===!0&&ai.update(zi);else if(ai.isLight)St.pushLight(ai),ai.castShadow&&St.pushShadow(ai);else if(ai.isSprite){if(!ai.frustumCulled||Wn.intersectsSprite(ai)){qi&&gi.setFromMatrixPosition(ai.matrixWorld).applyMatrix4(di);const En=Hn.update(ai),gr=ai.material;gr.visible&&Mt.push(ai,En,gr,Qi,gi.z,null)}}else if((ai.isMesh||ai.isLine||ai.isPoints)&&(!ai.frustumCulled||Wn.intersectsObject(ai))){const En=Hn.update(ai),gr=ai.material;if(qi&&(ai.boundingSphere!==void 0?(ai.boundingSphere===null&&ai.computeBoundingSphere(),gi.copy(ai.boundingSphere.center)):(En.boundingSphere===null&&En.computeBoundingSphere(),gi.copy(En.boundingSphere.center)),gi.applyMatrix4(ai.matrixWorld).applyMatrix4(di)),Array.isArray(gr)){const Vn=En.groups;for(let sr=0,pr=Vn.length;sr<pr;sr++){const mr=Vn[sr],Jn=gr[mr.materialIndex];Jn&&Jn.visible&&Mt.push(ai,En,Jn,Qi,gi.z,mr)}}else gr.visible&&Mt.push(ai,En,gr,Qi,gi.z,null)}}const on=ai.children;for(let En=0,gr=on.length;En<gr;En++)Qf(on[En],zi,Qi,qi)}function Wf(ai,zi,Qi,qi){const on=ai.opaque,En=ai.transmissive,gr=ai.transparent;if(St.setupLightsView(Qi),zn===!0&&br.setGlobalState(Rt.clippingPlanes,Qi),Rt.userData.transmissionRender===void 0&&Rt.userData.renderTransmissionPass!==!1&&En.length>0&&function(Vn,sr,pr,mr){console.warn("three.js internal render transmission pass should not be called");const Jn=hi.isWebGL2;ir===null&&(ir=new yo(1,1,{generateMipmaps:!0,type:Qt.has("EXT_color_buffer_half_float")?qn:Un,minFilter:Zn,samples:Jn?4:0})),Rt.getDrawingBufferSize(ei),Jn?ir.setSize(ei.x,ei.y):ir.setSize(za(ei.x),za(ei.y));const ao=Rt.getRenderTarget();Rt.setRenderTarget(ir),Rt.getClearColor(tn),$i=Rt.getClearAlpha(),$i<1&&Rt.setClearColor(16777215,.5),Rt.clear();const qo=Rt.toneMapping;Rt.toneMapping=_i,eh(Vn,pr,mr),cn.updateMultisampleRenderTarget(ir),cn.updateRenderTargetMipmap(ir);let lo=!1;for(let Ia=0,Yr=sr.length;Ia<Yr;Ia++){const Qr=sr[Ia],Xo=Qr.object,ko=Qr.geometry,Yn=Qr.material,zr=Qr.group;if(Yn.side===Oe&&Xo.layers.test(mr.layers)){const vu=Yn.side;Yn.side=ye,Yn.needsUpdate=!0,qf(Xo,pr,mr,ko,Yn,zr),Yn.side=vu,Yn.needsUpdate=!0,lo=!0}}lo===!0&&(cn.updateMultisampleRenderTarget(ir),cn.updateRenderTargetMipmap(ir)),Rt.setRenderTarget(ao),Rt.setClearColor(tn,$i),Rt.toneMapping=qo}([...on,...gr],En,zi,Qi),qi&&pi.viewport(yi.copy(qi)),Rt.userData.opaqueRender!==!1&&on.length>0&&eh(on,zi,Qi),Rt.userData.transparentRender!==!1&&gr.length>0&&eh(gr,zi,Qi),Rt.userData.transmissionRender!==!1&&En.length>0){ir||(ir=new yo(1,1));const Vn=(Rt.userData.transmissionRenderTarget||ir).texture,sr=hi.isWebGL2,pr=Vn.generateMipmaps,mr=Vn.minFilter;sr&&Rt.userData.blurTransmissionTarget&&Rt.userData.transmissionRenderTarget&&(Vn.generateMipmaps=!0,Vn.minFilter=Zn,Vn.needsUpdate=!0,cn.updateMultisampleRenderTarget(Rt.userData.transmissionRenderTarget),cn.updateRenderTargetMipmap(Rt.userData.transmissionRenderTarget)),eh(En,zi,Qi),sr&&Rt.userData.blurTransmissionTarget&&Rt.userData.transmissionRenderTarget&&(Vn.generateMipmaps=pr,Vn.minFilter=mr,Vn.needsUpdate=!0,cn.updateMultisampleRenderTarget(Rt.userData.transmissionRenderTarget),cn.updateRenderTargetMipmap(Rt.userData.transmissionRenderTarget))}pi.buffers.depth.setTest(!0),pi.buffers.depth.setMask(!0),pi.buffers.color.setMask(!0),pi.setPolygonOffset(!1)}function eh(ai,zi,Qi){const qi={...Rt.userData};Rt.userData.opaqueRender=void 0,Rt.userData.transparentRender=void 0,Rt.userData.transmissionRender=void 0,Rt.userData.backgroundRender=void 0;const on=zi.isScene===!0?zi.overrideMaterial:null;for(let En=0,gr=ai.length;En<gr;En++){const Vn=ai[En],sr=Vn.object,pr=Vn.geometry,mr=on===null?Vn.material:on,Jn=Vn.group;sr.layers.test(Qi.layers)&&qf(sr,zi,Qi,pr,mr,Jn)}Object.assign(Rt.userData,qi)}function qf(ai,zi,Qi,qi,on,En){ai.onBeforeRender(Rt,zi,Qi,qi,on,En),ai.modelViewMatrix.multiplyMatrices(Qi.matrixWorldInverse,ai.matrixWorld),ai.normalMatrix.getNormalMatrix(ai.modelViewMatrix),on.onBeforeRender(Rt,zi,Qi,qi,ai,En),on.transparent===!0&&on.side===Oe&&on.forceSinglePass===!1?(on.side=ye,on.needsUpdate=!0,Rt.renderBufferDirect(Qi,zi,qi,on,ai,En),on.side=ue,on.needsUpdate=!0,Rt.renderBufferDirect(Qi,zi,qi,on,ai,En),on.side=Oe):Rt.renderBufferDirect(Qi,zi,qi,on,ai,En),ai.onAfterRender(Rt,zi,Qi,qi,on,En),on.onAfterRender(Rt,zi,Qi,qi,ai,En)}function th(ai,zi,Qi){zi.isScene!==!0&&(zi=Mi);const qi=Ni.get(ai),on=St.state.lights,En=St.state.shadowsArray,gr=on.state.version,Vn=jn.getParameters(ai,on.state,En,zi,Qi),sr=jn.getProgramCacheKey(Vn);let pr=qi.programs;qi.environment=ai.userData&&ai.userData.envMapSlotKey&&zi.textureSlots&&zi.textureSlots[ai.userData.envMapSlotKey]?zi.textureSlots[ai.userData.envMapSlotKey]:ai.isMeshStandardMaterial?zi.environment:null,qi.fog=zi.fog,qi.envMap=(ai.isMeshStandardMaterial?lr:Ji).get(ai.envMap||qi.environment),pr===void 0&&(ai.addEventListener("dispose",zf),pr=new Map,qi.programs=pr);let mr=pr.get(sr);if(mr!==void 0){if(qi.currentProgram===mr&&qi.lightsStateVersion===gr)return Xf(ai,Vn),mr}else Vn.uniforms=jn.getUniforms(ai),ai.onBuild(Qi,Vn,Rt),ai.onBeforeCompile(Vn,Rt),mr=jn.acquireProgram(Vn,sr),pr.set(sr,mr),qi.uniforms=Vn.uniforms;const Jn=qi.uniforms;(ai.isShaderMaterial||ai.isRawShaderMaterial)&&ai.clipping!==!0||(Jn.clippingPlanes=br.uniform),Xf(ai,Vn),qi.needsLights=function(lo){return lo.isMeshLambertMaterial||lo.isMeshToonMaterial||lo.isMeshPhongMaterial||lo.isMeshStandardMaterial||lo.isShadowMaterial||lo.isShaderMaterial&&lo.lights===!0}(ai),qi.lightsStateVersion=gr,qi.needsLights&&(Jn.ambientLightColor.value=on.state.ambient,Jn.lightProbe.value=on.state.probe,Jn.directionalLights.value=on.state.directional,Jn.directionalLightShadows.value=on.state.directionalShadow,Jn.spotLights.value=on.state.spot,Jn.spotLightShadows.value=on.state.spotShadow,Jn.rectAreaLights.value=on.state.rectArea,Jn.ltc_1.value=on.state.rectAreaLTC1,Jn.ltc_2.value=on.state.rectAreaLTC2,Jn.pointLights.value=on.state.point,Jn.pointLightShadows.value=on.state.pointShadow,Jn.hemisphereLights.value=on.state.hemi,Jn.directionalShadowMap.value=on.state.directionalShadowMap,Jn.directionalShadowMatrix.value=on.state.directionalShadowMatrix,Jn.spotShadowMap.value=on.state.spotShadowMap,Jn.spotLightMatrix.value=on.state.spotLightMatrix,Jn.spotLightMap.value=on.state.spotLightMap,Jn.pointShadowMap.value=on.state.pointShadowMap,Jn.pointShadowMatrix.value=on.state.pointShadowMatrix);const ao=mr.getUniforms(),qo=ld.seqWithValue(ao.seq,Jn);return qi.currentProgram=mr,qi.uniformsList=qo,mr}function Xf(ai,zi){const Qi=Ni.get(ai);Qi.outputColorSpace=zi.outputColorSpace,Qi.instancing=zi.instancing,Qi.instancingColor=zi.instancingColor,Qi.skinning=zi.skinning,Qi.morphTargets=zi.morphTargets,Qi.morphNormals=zi.morphNormals,Qi.morphColors=zi.morphColors,Qi.morphTargetsCount=zi.morphTargetsCount,Qi.numClippingPlanes=zi.numClippingPlanes,Qi.numIntersection=zi.numClipIntersection,Qi.vertexAlphas=zi.vertexAlphas,Qi.vertexTangents=zi.vertexTangents,Qi.toneMapping=zi.toneMapping}ul.setAnimationLoop(function(ai){hp&&hp(ai)}),typeof self<"u"&&ul.setContext(self),this.setAnimationLoop=function(ai){hp=ai,wo.setAnimationLoop(ai),ai===null?ul.stop():ul.start()},wo.addEventListener("sessionstart",Vf),wo.addEventListener("sessionend",Hf),this.render=function(ai,zi){if(zi===void 0||zi.isCamera===!0){if(Yt!==!0){if(ai.matrixWorldAutoUpdate===!0&&ai.updateMatrixWorld(),zi.parent===null&&zi.matrixWorldAutoUpdate===!0&&zi.updateMatrixWorld(),wo.enabled===!0&&wo.isPresenting===!0&&(wo.cameraAutoUpdate===!0&&wo.updateCamera(zi),zi=wo.getCamera()),ai.isScene===!0&&ai.onBeforeRender(Rt,ai,zi,oi),St=Pr.get(ai,It.length),St.init(),It.push(St),di.multiplyMatrices(zi.projectionMatrix,zi.matrixWorldInverse),Wn.setFromProjectionMatrix(di),Pn=this.localClippingEnabled,zn=br.init(this.clippingPlanes,Pn),Mt=hr.get(ai,Nt.length),Mt.init(),Nt.push(Mt),Qf(ai,zi,0,Rt.sortObjects),Mt.finish(),Rt.sortObjects===!0&&Mt.sort(Oi,ki),this.info.render.frame++,Rt.userData.shadowMapRender!==!1){zn===!0&&br.beginShadows();const Qi=St.state.shadowsArray;Qi.length>0&&Gn.render(Qi,ai,zi),zn===!0&&br.endShadows()}if(this.info.autoReset===!0&&this.info.reset(),Rt.userData.backgroundRender!==!1&&_r.render(Mt,ai),Rt.userData.sceneRender!==!1)if(St.setupLights(Rt._useLegacyLights),zi.isArrayCamera){const Qi=zi.cameras;for(let qi=0,on=Qi.length;qi<on;qi++){const En=Qi[qi];Wf(Mt,ai,En,En.viewport)}}else Wf(Mt,ai,zi);oi!==null&&(cn.updateMultisampleRenderTarget(oi),cn.updateRenderTargetMipmap(oi)),ai.isScene===!0&&ai.onAfterRender(Rt,ai,zi),Ys.resetDefaultState(),wi=-1,fi=null,It.pop(),St=It.length>0?It[It.length-1]:null,Nt.pop(),Mt=Nt.length>0?Nt[Nt.length-1]:null}}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.getActiveCubeFace=function(){return Kt},this.getActiveMipmapLevel=function(){return Xt},this.getRenderTarget=function(){return oi},this.setRenderTargetTextures=function(ai,zi,Qi){Ni.get(ai.texture).__webglTexture=zi,Ni.get(ai.depthTexture).__webglTexture=Qi;const qi=Ni.get(ai);qi.__hasExternalTextures=!0,qi.__hasExternalTextures&&(qi.__autoAllocateDepthBuffer=Qi===void 0,qi.__autoAllocateDepthBuffer||Qt.has("WEBGL_multisampled_render_to_texture")===!0&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),qi.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(ai,zi){const Qi=Ni.get(ai);Qi.__webglFramebuffer=zi,Qi.__useDefaultFramebuffer=zi===void 0},this.setRenderTarget=function(ai,zi=0,Qi=0){oi=ai,Kt=zi,Xt=Qi;let qi=!0,on=null,En=!1,gr=!1;if(ai){const Vn=Ni.get(ai);Vn.__useDefaultFramebuffer!==void 0?(pi.bindFramebuffer(ji.FRAMEBUFFER,null),qi=!1):Vn.__webglFramebuffer===void 0?cn.setupRenderTarget(ai):Vn.__hasExternalTextures&&cn.rebindTextures(ai,Ni.get(ai.texture).__webglTexture,Ni.get(ai.depthTexture).__webglTexture);const sr=ai.texture;(sr.isData3DTexture||sr.isDataArrayTexture||sr.isCompressedArrayTexture)&&(gr=!0);const pr=Ni.get(ai).__webglFramebuffer;ai.isWebGLCubeRenderTarget?(on=Array.isArray(pr[zi])?pr[zi][Qi]:pr[zi],En=!0):on=hi.isWebGL2&&ai.samples>0&&cn.useMultisampledRTT(ai)===!1?Ni.get(ai).__webglMultisampledFramebuffer:Array.isArray(pr)?pr[Qi]:pr,yi.copy(ai.viewport),bi.copy(ai.scissor),Ci=ai.scissorTest}else yi.copy(Hi).multiplyScalar(Wi).floor(),bi.copy(Vi).multiplyScalar(Wi).floor(),Ci=Mn;if(pi.bindFramebuffer(ji.FRAMEBUFFER,on)&&hi.drawBuffers&&qi&&pi.drawBuffers(ai,on),pi.viewport(yi),pi.scissor(bi),pi.setScissorTest(Ci),En){const Vn=Ni.get(ai.texture);ji.framebufferTexture2D(ji.FRAMEBUFFER,ji.COLOR_ATTACHMENT0,ji.TEXTURE_CUBE_MAP_POSITIVE_X+zi,Vn.__webglTexture,Qi)}else if(gr){const Vn=Ni.get(ai.texture),sr=zi||0;ji.framebufferTextureLayer(ji.FRAMEBUFFER,ji.COLOR_ATTACHMENT0,Vn.__webglTexture,Qi||0,sr)}wi=-1},this.readRenderTargetPixels=function(ai,zi,Qi,qi,on,En,gr,Vn){if(!ai||!ai.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let sr=Ni.get(ai).__webglFramebuffer;if(ai.isWebGLCubeRenderTarget&&gr!==void 0&&(sr=sr[gr]),sr){pi.bindFramebuffer(ji.FRAMEBUFFER,sr);try{const pr=Array.isArray(ai.texture)?ai.texture[Vn||0]:ai.texture,mr=pr.format,Jn=pr.type;if(mr!==Nr&&vr.convert(mr)!==ji.getParameter(ji.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const ao=Jn===qn&&(Qt.has("EXT_color_buffer_half_float")||hi.isWebGL2&&Qt.has("EXT_color_buffer_float"));if(!(Jn===Un||vr.convert(Jn)===ji.getParameter(ji.IMPLEMENTATION_COLOR_READ_TYPE)||Jn===Tn&&(hi.isWebGL2||Qt.has("OES_texture_float")||Qt.has("WEBGL_color_buffer_float"))||ao))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");zi>=0&&zi<=ai.width-qi&&Qi>=0&&Qi<=ai.height-on&&(ai.isWebGLMultipleRenderTargets&&ji.readBuffer(ji.COLOR_ATTACHMENT0+Vn),ji.readPixels(zi,Qi,qi,on,vr.convert(mr),vr.convert(Jn),En))}finally{const pr=oi?Ni.get(oi).__webglFramebuffer:null;pi.bindFramebuffer(ji.FRAMEBUFFER,pr)}}},this.copyFramebufferToTexture=function(ai,zi,Qi=0){const qi=Math.pow(2,-Qi),on=Math.floor(zi.image.width*qi),En=Math.floor(zi.image.height*qi);cn.setTexture2D(zi,0),ji.copyTexSubImage2D(ji.TEXTURE_2D,Qi,0,0,ai.x,ai.y,on,En),pi.unbindTexture()},this.copyTextureToTexture=function(ai,zi,Qi,qi=0){const on=zi.image.width,En=zi.image.height,gr=vr.convert(Qi.format),Vn=vr.convert(Qi.type);cn.setTexture2D(Qi,0),ji.pixelStorei(ji.UNPACK_FLIP_Y_WEBGL,Qi.flipY),ji.pixelStorei(ji.UNPACK_PREMULTIPLY_ALPHA_WEBGL,Qi.premultiplyAlpha),ji.pixelStorei(ji.UNPACK_ALIGNMENT,Qi.unpackAlignment),zi.isDataTexture?ji.texSubImage2D(ji.TEXTURE_2D,qi,ai.x,ai.y,on,En,gr,Vn,zi.image.data):zi.isCompressedTexture?ji.compressedTexSubImage2D(ji.TEXTURE_2D,qi,ai.x,ai.y,zi.mipmaps[0].width,zi.mipmaps[0].height,gr,zi.mipmaps[0].data):ji.texSubImage2D(ji.TEXTURE_2D,qi,ai.x,ai.y,gr,Vn,zi.image),qi===0&&Qi.generateMipmaps&&ji.generateMipmap(ji.TEXTURE_2D),pi.unbindTexture()},this.copyTextureToTexture3D=function(ai,zi,Qi,qi,on=0){if(Rt.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const En=ai.max.x-ai.min.x+1,gr=ai.max.y-ai.min.y+1,Vn=ai.max.z-ai.min.z+1,sr=vr.convert(qi.format),pr=vr.convert(qi.type);let mr;if(qi.isData3DTexture)cn.setTexture3D(qi,0),mr=ji.TEXTURE_3D;else{if(!qi.isDataArrayTexture)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");cn.setTexture2DArray(qi,0),mr=ji.TEXTURE_2D_ARRAY}ji.pixelStorei(ji.UNPACK_FLIP_Y_WEBGL,qi.flipY),ji.pixelStorei(ji.UNPACK_PREMULTIPLY_ALPHA_WEBGL,qi.premultiplyAlpha),ji.pixelStorei(ji.UNPACK_ALIGNMENT,qi.unpackAlignment);const Jn=ji.getParameter(ji.UNPACK_ROW_LENGTH),ao=ji.getParameter(ji.UNPACK_IMAGE_HEIGHT),qo=ji.getParameter(ji.UNPACK_SKIP_PIXELS),lo=ji.getParameter(ji.UNPACK_SKIP_ROWS),Ia=ji.getParameter(ji.UNPACK_SKIP_IMAGES),Yr=Qi.isCompressedTexture?Qi.mipmaps[0]:Qi.image;ji.pixelStorei(ji.UNPACK_ROW_LENGTH,Yr.width),ji.pixelStorei(ji.UNPACK_IMAGE_HEIGHT,Yr.height),ji.pixelStorei(ji.UNPACK_SKIP_PIXELS,ai.min.x),ji.pixelStorei(ji.UNPACK_SKIP_ROWS,ai.min.y),ji.pixelStorei(ji.UNPACK_SKIP_IMAGES,ai.min.z),Qi.isDataTexture||Qi.isData3DTexture?ji.texSubImage3D(mr,on,zi.x,zi.y,zi.z,En,gr,Vn,sr,pr,Yr.data):Qi.isCompressedArrayTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),ji.compressedTexSubImage3D(mr,on,zi.x,zi.y,zi.z,En,gr,Vn,sr,Yr.data)):ji.texSubImage3D(mr,on,zi.x,zi.y,zi.z,En,gr,Vn,sr,pr,Yr),ji.pixelStorei(ji.UNPACK_ROW_LENGTH,Jn),ji.pixelStorei(ji.UNPACK_IMAGE_HEIGHT,ao),ji.pixelStorei(ji.UNPACK_SKIP_PIXELS,qo),ji.pixelStorei(ji.UNPACK_SKIP_ROWS,lo),ji.pixelStorei(ji.UNPACK_SKIP_IMAGES,Ia),on===0&&qi.generateMipmaps&&ji.generateMipmap(mr),pi.unbindTexture()},this.initTexture=function(ai){ai.isCubeTexture?cn.setTextureCube(ai,0):ai.isData3DTexture?cn.setTexture3D(ai,0):ai.isDataArrayTexture||ai.isCompressedArrayTexture?cn.setTexture2DArray(ai,0):cn.setTexture2D(ai,0),pi.unbindTexture()},this.resetState=function(){Kt=0,Xt=0,oi=null,pi.reset(),Ys.reset()},typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return Bo}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(y){this._outputColorSpace=y;const b=this.getContext();b.drawingBufferColorSpace=y===ka?"display-p3":"srgb",b.unpackColorSpace=Sr.workingColorSpace===Ls?"display-p3":"srgb"}get physicallyCorrectLights(){return console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),!this.useLegacyLights}set physicallyCorrectLights(y){console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),this.useLegacyLights=!y}get outputEncoding(){return console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace===Rr?ss:Vr}set outputEncoding(y){console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace=y===ss?Rr:Fr}get useLegacyLights(){return console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights}set useLegacyLights(y){console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights=y}}class tm extends em{}tm.prototype.isWebGL1Renderer=!0;class cd{constructor(y,b=25e-5){this.isFogExp2=!0,this.name="",this.color=new Dn(y),this.density=b}clone(){return new cd(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class ud{constructor(y,b=1,D=1e3){this.isFog=!0,this.name="",this.color=new Dn(y),this.near=b,this.far=D}clone(){return new ud(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class im extends yr{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.overrideMaterial=null,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(y,b){return super.copy(y,b),y.background!==null&&(this.background=y.background.clone()),y.environment!==null&&(this.environment=y.environment.clone()),y.fog!==null&&(this.fog=y.fog.clone()),this.backgroundBlurriness=y.backgroundBlurriness,this.backgroundIntensity=y.backgroundIntensity,y.overrideMaterial!==null&&(this.overrideMaterial=y.overrideMaterial.clone()),this.matrixAutoUpdate=y.matrixAutoUpdate,this}toJSON(y){const b=super.toJSON(y);return this.fog!==null&&(b.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(b.object.backgroundBlurriness=this.backgroundBlurriness),this.backgroundIntensity!==1&&(b.object.backgroundIntensity=this.backgroundIntensity),b}}class dd{constructor(y,b){this.isInterleavedBuffer=!0,this.array=y,this.stride=b,this.count=y!==void 0?y.length/b:0,this.usage=oa,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=vo()}onUploadCallback(){}set needsUpdate(y){y===!0&&this.version++}setUsage(y){return this.usage=y,this}copy(y){return this.array=new y.array.constructor(y.array),this.count=y.count,this.stride=y.stride,this.usage=y.usage,this}copyAt(y,b,D){y*=this.stride,D*=b.stride;for(let Y=0,_e=this.stride;Y<_e;Y++)this.array[y+Y]=b.array[D+Y];return this}set(y,b=0){return this.array.set(y,b),this}clone(y){y.arrayBuffers===void 0&&(y.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=vo()),y.arrayBuffers[this.array.buffer._uuid]===void 0&&(y.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const b=new this.array.constructor(y.arrayBuffers[this.array.buffer._uuid]),D=new this.constructor(b,this.stride);return D.setUsage(this.usage),D}onUpload(y){return this.onUploadCallback=y,this}toJSON(y){return y.arrayBuffers===void 0&&(y.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=vo()),y.arrayBuffers[this.array.buffer._uuid]===void 0&&(y.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const Po=new ii;class Za{constructor(y,b,D,Y=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=y,this.itemSize=b,this.offset=D,this.normalized=Y}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(y){this.data.needsUpdate=y}applyMatrix4(y){for(let b=0,D=this.data.count;b<D;b++)Po.fromBufferAttribute(this,b),Po.applyMatrix4(y),this.setXYZ(b,Po.x,Po.y,Po.z);return this}applyNormalMatrix(y){for(let b=0,D=this.count;b<D;b++)Po.fromBufferAttribute(this,b),Po.applyNormalMatrix(y),this.setXYZ(b,Po.x,Po.y,Po.z);return this}transformDirection(y){for(let b=0,D=this.count;b<D;b++)Po.fromBufferAttribute(this,b),Po.transformDirection(y),this.setXYZ(b,Po.x,Po.y,Po.z);return this}setX(y,b){return this.normalized&&(b=$n(b,this.array)),this.data.array[y*this.data.stride+this.offset]=b,this}setY(y,b){return this.normalized&&(b=$n(b,this.array)),this.data.array[y*this.data.stride+this.offset+1]=b,this}setZ(y,b){return this.normalized&&(b=$n(b,this.array)),this.data.array[y*this.data.stride+this.offset+2]=b,this}setW(y,b){return this.normalized&&(b=$n(b,this.array)),this.data.array[y*this.data.stride+this.offset+3]=b,this}getX(y){let b=this.data.array[y*this.data.stride+this.offset];return this.normalized&&(b=po(b,this.array)),b}getY(y){let b=this.data.array[y*this.data.stride+this.offset+1];return this.normalized&&(b=po(b,this.array)),b}getZ(y){let b=this.data.array[y*this.data.stride+this.offset+2];return this.normalized&&(b=po(b,this.array)),b}getW(y){let b=this.data.array[y*this.data.stride+this.offset+3];return this.normalized&&(b=po(b,this.array)),b}setXY(y,b,D){return y=y*this.data.stride+this.offset,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array)),this.data.array[y+0]=b,this.data.array[y+1]=D,this}setXYZ(y,b,D,Y){return y=y*this.data.stride+this.offset,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array),Y=$n(Y,this.array)),this.data.array[y+0]=b,this.data.array[y+1]=D,this.data.array[y+2]=Y,this}setXYZW(y,b,D,Y,_e){return y=y*this.data.stride+this.offset,this.normalized&&(b=$n(b,this.array),D=$n(D,this.array),Y=$n(Y,this.array),_e=$n(_e,this.array)),this.data.array[y+0]=b,this.data.array[y+1]=D,this.data.array[y+2]=Y,this.data.array[y+3]=_e,this}clone(y){if(y===void 0){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const b=[];for(let D=0;D<this.count;D++){const Y=D*this.data.stride+this.offset;for(let _e=0;_e<this.itemSize;_e++)b.push(this.data.array[Y+_e])}return new zt(new this.array.constructor(b),this.itemSize,this.normalized)}return y.interleavedBuffers===void 0&&(y.interleavedBuffers={}),y.interleavedBuffers[this.data.uuid]===void 0&&(y.interleavedBuffers[this.data.uuid]=this.data.clone(y)),new Za(y.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(y){if(y===void 0){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const b=[];for(let D=0;D<this.count;D++){const Y=D*this.data.stride+this.offset;for(let _e=0;_e<this.itemSize;_e++)b.push(this.data.array[Y+_e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:b,normalized:this.normalized}}return y.interleavedBuffers===void 0&&(y.interleavedBuffers={}),y.interleavedBuffers[this.data.uuid]===void 0&&(y.interleavedBuffers[this.data.uuid]=this.data.toJSON(y)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class Mh extends no{constructor(y){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new Dn(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.color.copy(y.color),this.map=y.map,this.alphaMap=y.alphaMap,this.rotation=y.rotation,this.sizeAttenuation=y.sizeAttenuation,this.fog=y.fog,this}}let $l;const $c=new ii,Jl=new ii,Zl=new ii,ec=new en,Jc=new en,nm=new Xn,hd=new ii,Zc=new ii,pd=new ii,rm=new en,Ph=new en,om=new en;class sm extends yr{constructor(y=new Mh){if(super(),this.isSprite=!0,this.type="Sprite",$l===void 0){$l=new dr;const b=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),D=new dd(b,5);$l.setIndex([0,1,2,0,2,3]),$l.setAttribute("position",new Za(D,3,0,!1)),$l.setAttribute("uv",new Za(D,2,3,!1))}this.geometry=$l,this.material=y,this.center=new en(.5,.5)}raycast(y,b){y.camera===null&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),Jl.setFromMatrixScale(this.matrixWorld),nm.copy(y.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(y.camera.matrixWorldInverse,this.matrixWorld),Zl.setFromMatrixPosition(this.modelViewMatrix),y.camera.isPerspectiveCamera&&this.material.sizeAttenuation===!1&&Jl.multiplyScalar(-Zl.z);const D=this.material.rotation;let Y,_e;D!==0&&(_e=Math.cos(D),Y=Math.sin(D));const Le=this.center;md(hd.set(-.5,-.5,0),Zl,Le,Jl,Y,_e),md(Zc.set(.5,-.5,0),Zl,Le,Jl,Y,_e),md(pd.set(.5,.5,0),Zl,Le,Jl,Y,_e),rm.set(0,0),Ph.set(1,0),om.set(1,1);let qe=y.ray.intersectTriangle(hd,Zc,pd,!1,$c);if(qe===null&&(md(Zc.set(-.5,.5,0),Zl,Le,Jl,Y,_e),Ph.set(0,1),qe=y.ray.intersectTriangle(hd,pd,Zc,!1,$c),qe===null))return;const it=y.ray.origin.distanceTo($c);it<y.near||it>y.far||b.push({distance:it,point:$c.clone(),uv:fo.getInterpolation($c,hd,Zc,pd,rm,Ph,om,new en),face:null,object:this})}copy(y,b){return super.copy(y,b),y.center!==void 0&&this.center.copy(y.center),this.material=y.material,this}}function md(De,y,b,D,Y,_e){ec.subVectors(De,b).addScalar(.5).multiply(D),Y!==void 0?(Jc.x=_e*ec.x-Y*ec.y,Jc.y=Y*ec.x+_e*ec.y):Jc.copy(ec),De.copy(y),De.x+=Jc.x,De.y+=Jc.y,De.applyMatrix4(nm)}const gd=new ii,am=new ii;class lm extends yr{constructor(){super(),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},isLOD:{value:!0}}),this.autoUpdate=!0}copy(y){super.copy(y,!1);const b=y.levels;for(let D=0,Y=b.length;D<Y;D++){const _e=b[D];this.addLevel(_e.object.clone(),_e.distance,_e.hysteresis)}return this.autoUpdate=y.autoUpdate,this}addLevel(y,b=0,D=0){b=Math.abs(b);const Y=this.levels;let _e;for(_e=0;_e<Y.length&&!(b<Y[_e].distance);_e++);return Y.splice(_e,0,{distance:b,hysteresis:D,object:y}),this.add(y),this}getCurrentLevel(){return this._currentLevel}getObjectForDistance(y){const b=this.levels;if(b.length>0){let D,Y;for(D=1,Y=b.length;D<Y;D++){let _e=b[D].distance;if(b[D].object.visible&&(_e-=_e*b[D].hysteresis),y<_e)break}return b[D-1].object}return null}raycast(y,b){if(this.levels.length>0){gd.setFromMatrixPosition(this.matrixWorld);const D=y.ray.origin.distanceTo(gd);this.getObjectForDistance(D).raycast(y,b)}}update(y){const b=this.levels;if(b.length>1){gd.setFromMatrixPosition(y.matrixWorld),am.setFromMatrixPosition(this.matrixWorld);const D=gd.distanceTo(am)/y.zoom;let Y,_e;for(b[0].object.visible=!0,Y=1,_e=b.length;Y<_e;Y++){let Le=b[Y].distance;if(b[Y].object.visible&&(Le-=Le*b[Y].hysteresis),!(D>=Le))break;b[Y-1].object.visible=!1,b[Y].object.visible=!0}for(this._currentLevel=Y-1;Y<_e;Y++)b[Y].object.visible=!1}}toJSON(y){const b=super.toJSON(y);this.autoUpdate===!1&&(b.object.autoUpdate=!1),b.object.levels=[];const D=this.levels;for(let Y=0,_e=D.length;Y<_e;Y++){const Le=D[Y];b.object.levels.push({object:Le.object.uuid,distance:Le.distance,hysteresis:Le.hysteresis})}return b}}const cm=new ii,um=new Tr,dm=new Tr,L_=new ii,hm=new Xn,tc=new ii,Ih=new Oo,pm=new Xn,Rh=new ma;class mm extends so{constructor(y,b){super(y,b),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Xn,this.bindMatrixInverse=new Xn,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const y=this.geometry;this.boundingBox===null&&(this.boundingBox=new Ko),this.boundingBox.makeEmpty();const b=y.getAttribute("position");for(let D=0;D<b.count;D++)tc.fromBufferAttribute(b,D),this.applyBoneTransform(D,tc),this.boundingBox.expandByPoint(tc)}computeBoundingSphere(){const y=this.geometry;this.boundingSphere===null&&(this.boundingSphere=new Oo),this.boundingSphere.makeEmpty();const b=y.getAttribute("position");for(let D=0;D<b.count;D++)tc.fromBufferAttribute(b,D),this.applyBoneTransform(D,tc),this.boundingSphere.expandByPoint(tc)}copy(y,b){return super.copy(y,b),this.bindMode=y.bindMode,this.bindMatrix.copy(y.bindMatrix),this.bindMatrixInverse.copy(y.bindMatrixInverse),this.skeleton=y.skeleton,y.boundingBox!==null&&(this.boundingBox=y.boundingBox.clone()),y.boundingSphere!==null&&(this.boundingSphere=y.boundingSphere.clone()),this}raycast(y,b){const D=this.material,Y=this.matrixWorld;D!==void 0&&(this.boundingSphere===null&&this.computeBoundingSphere(),Ih.copy(this.boundingSphere),Ih.applyMatrix4(Y),y.ray.intersectsSphere(Ih)!==!1&&(pm.copy(Y).invert(),Rh.copy(y.ray).applyMatrix4(pm),this.boundingBox!==null&&Rh.intersectsBox(this.boundingBox)===!1||this._computeIntersections(y,b,Rh)))}getVertexPosition(y,b){return super.getVertexPosition(y,b),this.applyBoneTransform(y,b),b}bind(y,b){this.skeleton=y,b===void 0&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),b=this.matrixWorld),this.bindMatrix.copy(b),this.bindMatrixInverse.copy(b).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const y=new Tr,b=this.geometry.attributes.skinWeight;for(let D=0,Y=b.count;D<Y;D++){y.fromBufferAttribute(b,D);const _e=1/y.manhattanLength();_e!==1/0?y.multiplyScalar(_e):y.set(1,0,0,0),b.setXYZW(D,y.x,y.y,y.z,y.w)}}updateMatrixWorld(y){super.updateMatrixWorld(y),this.bindMode==="attached"?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode==="detached"?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(y,b){const D=this.skeleton,Y=this.geometry;um.fromBufferAttribute(Y.attributes.skinIndex,y),dm.fromBufferAttribute(Y.attributes.skinWeight,y),cm.copy(b).applyMatrix4(this.bindMatrix),b.set(0,0,0);for(let _e=0;_e<4;_e++){const Le=dm.getComponent(_e);if(Le!==0){const qe=um.getComponent(_e);hm.multiplyMatrices(D.bones[qe].matrixWorld,D.boneInverses[qe]),b.addScaledVector(L_.copy(cm).applyMatrix4(hm),Le)}}return b.applyMatrix4(this.bindMatrixInverse)}boneTransform(y,b){return console.warn("THREE.SkinnedMesh: .boneTransform() was renamed to .applyBoneTransform() in r151."),this.applyBoneTransform(y,b)}}class Dh extends yr{constructor(){super(),this.isBone=!0,this.type="Bone"}}class ic extends Or{constructor(y=null,b=1,D=1,Y,_e,Le,qe,it,nt=Yi,mt=Yi,bt,At){super(null,Le,qe,it,nt,mt,Y,_e,bt,At),this.isDataTexture=!0,this.image={data:y,width:b,height:D},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const fm=new Xn,N_=new Xn;class _d{constructor(y=[],b=[]){this.uuid=vo(),this.bones=y.slice(0),this.boneInverses=b,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.init()}init(){const y=this.bones,b=this.boneInverses;if(this.boneMatrices=new Float32Array(16*y.length),b.length===0)this.calculateInverses();else if(y.length!==b.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let D=0,Y=this.bones.length;D<Y;D++)this.boneInverses.push(new Xn)}}calculateInverses(){this.boneInverses.length=0;for(let y=0,b=this.bones.length;y<b;y++){const D=new Xn;this.bones[y]&&D.copy(this.bones[y].matrixWorld).invert(),this.boneInverses.push(D)}}pose(){for(let y=0,b=this.bones.length;y<b;y++){const D=this.bones[y];D&&D.matrixWorld.copy(this.boneInverses[y]).invert()}for(let y=0,b=this.bones.length;y<b;y++){const D=this.bones[y];D&&(D.parent&&D.parent.isBone?(D.matrix.copy(D.parent.matrixWorld).invert(),D.matrix.multiply(D.matrixWorld)):D.matrix.copy(D.matrixWorld),D.matrix.decompose(D.position,D.quaternion,D.scale))}}update(){const y=this.bones,b=this.boneInverses,D=this.boneMatrices,Y=this.boneTexture;for(let _e=0,Le=y.length;_e<Le;_e++){const qe=y[_e]?y[_e].matrixWorld:N_;fm.multiplyMatrices(qe,b[_e]),fm.toArray(D,16*_e)}Y!==null&&(Y.needsUpdate=!0)}clone(){return new _d(this.bones,this.boneInverses)}computeBoneTexture(){let y=Math.sqrt(4*this.bones.length);y=Mc(y),y=Math.max(y,4);const b=new Float32Array(y*y*4);b.set(this.boneMatrices);const D=new ic(b,y,y,Nr,Tn);return D.needsUpdate=!0,this.boneMatrices=b,this.boneTexture=D,this.boneTextureSize=y,this}getBoneByName(y){for(let b=0,D=this.bones.length;b<D;b++){const Y=this.bones[b];if(Y.name===y)return Y}}dispose(){this.boneTexture!==null&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(y,b){this.uuid=y.uuid;for(let D=0,Y=y.bones.length;D<Y;D++){const _e=y.bones[D];let Le=b[_e];Le===void 0&&(console.warn("THREE.Skeleton: No bone found with UUID:",_e),Le=new Dh),this.bones.push(Le),this.boneInverses.push(new Xn().fromArray(y.boneInverses[D]))}return this.init(),this}toJSON(){const y={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};y.uuid=this.uuid;const b=this.bones,D=this.boneInverses;for(let Y=0,_e=b.length;Y<_e;Y++){const Le=b[Y];y.bones.push(Le.uuid);const qe=D[Y];y.boneInverses.push(qe.toArray())}return y}}class nc extends zt{constructor(y,b,D,Y=1){super(y,b,D),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=Y}copy(y){return super.copy(y),this.meshPerAttribute=y.meshPerAttribute,this}toJSON(){const y=super.toJSON();return y.meshPerAttribute=this.meshPerAttribute,y.isInstancedBufferAttribute=!0,y}}const rc=new Xn,gm=new Xn,vd=[],_m=new Ko,k_=new Xn,eu=new so,tu=new Oo;class vm extends so{constructor(y,b,D){super(y,b),this.isInstancedMesh=!0,this.instanceMatrix=new nc(new Float32Array(16*D),16),this.instanceColor=null,this.sourceTrs=null,this.count=D,this.boundingBox=null,this.boundingSphere=null;for(let Y=0;Y<D;Y++)this.setMatrixAt(Y,k_)}computeBoundingBox(){const y=this.geometry,b=this.count;this.boundingBox===null&&(this.boundingBox=new Ko),y.boundingBox===null&&y.computeBoundingBox(),this.boundingBox.makeEmpty();for(let D=0;D<b;D++)this.getMatrixAt(D,rc),_m.copy(y.boundingBox).applyMatrix4(rc),this.boundingBox.union(_m)}computeBoundingSphere(){const y=this.geometry,b=this.count;this.boundingSphere===null&&(this.boundingSphere=new Oo),y.boundingSphere===null&&y.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let D=0;D<b;D++)this.getMatrixAt(D,rc),tu.copy(y.boundingSphere).applyMatrix4(rc),this.boundingSphere.union(tu)}copy(y,b){return super.copy(y,b),y.isInstancedMesh?(this.instanceMatrix.copy(y.instanceMatrix),y.instanceColor!==null&&(this.instanceColor=y.instanceColor.clone()),this.count=y.count,y.boundingBox!==null&&(this.boundingBox=y.boundingBox.clone()),y.boundingSphere!==null&&(this.boundingSphere=y.boundingSphere.clone()),this):this}getColorAt(y,b){b.fromArray(this.instanceColor.array,3*y)}getMatrixAt(y,b){b.fromArray(this.instanceMatrix.array,16*y)}raycast(y,b){const D=this.matrixWorld,Y=this.count;if(eu.geometry=this.geometry,eu.material=this.material,eu.material!==void 0&&(this.boundingSphere===null&&this.computeBoundingSphere(),tu.copy(this.boundingSphere),tu.applyMatrix4(D),y.ray.intersectsSphere(tu)!==!1))for(let _e=0;_e<Y;_e++){this.getMatrixAt(_e,rc),gm.multiplyMatrices(D,rc),eu.matrixWorld=gm,eu.raycast(y,vd);for(let Le=0,qe=vd.length;Le<qe;Le++){const it=vd[Le];it.instanceId=_e,it.object=this,b.push(it)}vd.length=0}}setColorAt(y,b){this.instanceColor===null&&(this.instanceColor=new nc(new Float32Array(3*this.instanceMatrix.count),3)),b.toArray(this.instanceColor.array,3*y)}setMatrixAt(y,b){b.toArray(this.instanceMatrix.array,16*y)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}class Io extends no{constructor(y){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Dn(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.color.copy(y.color),this.map=y.map,this.linewidth=y.linewidth,this.linecap=y.linecap,this.linejoin=y.linejoin,this.fog=y.fog,this}}const ym=new ii,Am=new ii,bm=new Xn,Bh=new ma,yd=new Oo;class Ta extends yr{constructor(y=new dr,b=new Io){super(),this.isLine=!0,this.type="Line",this.geometry=y,this.material=b,this.updateMorphTargets()}copy(y,b){return super.copy(y,b),this.material=Array.isArray(y.material)?y.material.slice():y.material,this.geometry=y.geometry,this}computeLineDistances(){const y=this.geometry;if(y.index===null){const b=y.attributes.position,D=[0];for(let Y=1,_e=b.count;Y<_e;Y++)ym.fromBufferAttribute(b,Y-1),Am.fromBufferAttribute(b,Y),D[Y]=D[Y-1],D[Y]+=ym.distanceTo(Am);y.setAttribute("lineDistance",new Cn(D,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(y,b){const D=this.geometry,Y=this.matrixWorld,_e=y.params.Line.threshold,Le=D.drawRange;if(D.boundingSphere===null&&D.computeBoundingSphere(),yd.copy(D.boundingSphere),yd.applyMatrix4(Y),yd.radius+=_e,y.ray.intersectsSphere(yd)===!1)return;bm.copy(Y).invert(),Bh.copy(y.ray).applyMatrix4(bm);const qe=_e/((this.scale.x+this.scale.y+this.scale.z)/3),it=qe*qe,nt=new ii,mt=new ii,bt=new ii,At=new ii,wt=this.isLineSegments?2:1,Et=D.index,Mt=D.attributes.position;if(Et!==null)for(let St=Math.max(0,Le.start),Nt=Math.min(Et.count,Le.start+Le.count)-1;St<Nt;St+=wt){const It=Et.getX(St),Rt=Et.getX(St+1);if(nt.fromBufferAttribute(Mt,It),mt.fromBufferAttribute(Mt,Rt),Bh.distanceSqToSegment(nt,mt,At,bt)>it)continue;At.applyMatrix4(this.matrixWorld);const Yt=y.ray.origin.distanceTo(At);Yt<y.near||Yt>y.far||b.push({distance:Yt,point:bt.clone().applyMatrix4(this.matrixWorld),index:St,face:null,faceIndex:null,object:this})}else for(let St=Math.max(0,Le.start),Nt=Math.min(Mt.count,Le.start+Le.count)-1;St<Nt;St+=wt){if(nt.fromBufferAttribute(Mt,St),mt.fromBufferAttribute(Mt,St+1),Bh.distanceSqToSegment(nt,mt,At,bt)>it)continue;At.applyMatrix4(this.matrixWorld);const It=y.ray.origin.distanceTo(At);It<y.near||It>y.far||b.push({distance:It,point:bt.clone().applyMatrix4(this.matrixWorld),index:St,face:null,faceIndex:null,object:this})}}updateMorphTargets(){const y=this.geometry.morphAttributes,b=Object.keys(y);if(b.length>0){const D=y[b[0]];if(D!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let Y=0,_e=D.length;Y<_e;Y++){const Le=D[Y].name||String(Y);this.morphTargetInfluences.push(0),this.morphTargetDictionary[Le]=Y}}}}}const xm=new ii,wm=new ii;class Ts extends Ta{constructor(y,b){super(y,b),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const y=this.geometry;if(y.index===null){const b=y.attributes.position,D=[];for(let Y=0,_e=b.count;Y<_e;Y+=2)xm.fromBufferAttribute(b,Y),wm.fromBufferAttribute(b,Y+1),D[Y]=Y===0?0:D[Y-1],D[Y+1]=D[Y]+xm.distanceTo(wm);y.setAttribute("lineDistance",new Cn(D,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class Em extends Ta{constructor(y,b){super(y,b),this.isLineLoop=!0,this.type="LineLoop"}}class Oh extends no{constructor(y){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new Dn(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.color.copy(y.color),this.map=y.map,this.alphaMap=y.alphaMap,this.size=y.size,this.sizeAttenuation=y.sizeAttenuation,this.fog=y.fog,this}}const Sm=new Xn,Lh=new ma,Ad=new Oo,bd=new ii;class Tm extends yr{constructor(y=new dr,b=new Oh){super(),this.isPoints=!0,this.type="Points",this.geometry=y,this.material=b,this.updateMorphTargets()}copy(y,b){return super.copy(y,b),this.material=Array.isArray(y.material)?y.material.slice():y.material,this.geometry=y.geometry,this}raycast(y,b){const D=this.geometry,Y=this.matrixWorld,_e=y.params.Points.threshold,Le=D.drawRange;if(D.boundingSphere===null&&D.computeBoundingSphere(),Ad.copy(D.boundingSphere),Ad.applyMatrix4(Y),Ad.radius+=_e,y.ray.intersectsSphere(Ad)===!1)return;Sm.copy(Y).invert(),Lh.copy(y.ray).applyMatrix4(Sm);const qe=_e/((this.scale.x+this.scale.y+this.scale.z)/3),it=qe*qe,nt=D.index,mt=D.attributes.position;if(nt!==null)for(let bt=Math.max(0,Le.start),At=Math.min(nt.count,Le.start+Le.count);bt<At;bt++){const wt=nt.getX(bt);bd.fromBufferAttribute(mt,wt),Cm(bd,wt,it,Y,y,b,this)}else for(let bt=Math.max(0,Le.start),At=Math.min(mt.count,Le.start+Le.count);bt<At;bt++)bd.fromBufferAttribute(mt,bt),Cm(bd,bt,it,Y,y,b,this)}updateMorphTargets(){const y=this.geometry.morphAttributes,b=Object.keys(y);if(b.length>0){const D=y[b[0]];if(D!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let Y=0,_e=D.length;Y<_e;Y++){const Le=D[Y].name||String(Y);this.morphTargetInfluences.push(0),this.morphTargetDictionary[Le]=Y}}}}}function Cm(De,y,b,D,Y,_e,Le){const qe=Lh.distanceSqToPoint(De);if(qe<b){const it=new ii;Lh.closestPointToPoint(De,it),it.applyMatrix4(D);const nt=Y.ray.origin.distanceTo(it);if(nt<Y.near||nt>Y.far)return;_e.push({distance:nt,distanceToRay:Math.sqrt(qe),point:it,index:y,face:null,object:Le})}}class U_ extends Or{constructor(y,b,D,Y,_e,Le,qe,it,nt){super(y,b,D,Y,_e,Le,qe,it,nt),this.isVideoTexture=!0,this.minFilter=Le!==void 0?Le:fn,this.magFilter=_e!==void 0?_e:fn,this.generateMipmaps=!1;const mt=this;"requestVideoFrameCallback"in y&&y.requestVideoFrameCallback(function bt(){mt.needsUpdate=!0,y.requestVideoFrameCallback(bt)})}clone(){return new this.constructor(this.image).copy(this)}update(){const y=this.image;!("requestVideoFrameCallback"in y)&&y.readyState>=y.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}class F_ extends Or{constructor(y,b){super({width:y,height:b}),this.isFramebufferTexture=!0,this.magFilter=Yi,this.minFilter=Yi,this.generateMipmaps=!1,this.needsUpdate=!0}}class xd extends Or{constructor(y,b,D,Y,_e,Le,qe,it,nt,mt,bt,At){super(null,Le,qe,it,nt,mt,Y,_e,bt,At),this.isCompressedTexture=!0,this.image={width:b,height:D},this.mipmaps=y,this.flipY=!1,this.generateMipmaps=!1}}class j_ extends xd{constructor(y,b,D,Y,_e,Le){super(y,b,D,_e,Le),this.isCompressedArrayTexture=!0,this.image.depth=Y,this.wrapR=an}}class G_ extends xd{constructor(y,b,D){super(void 0,y[0].width,y[0].height,b,D,xi),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=y}}class z_ extends Or{constructor(y,b,D,Y,_e,Le,qe,it,nt){super(y,b,D,Y,_e,Le,qe,it,nt),this.isCanvasTexture=!0,this.needsUpdate=!0}}class ps{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(y,b){const D=this.getUtoTmapping(y);return this.getPoint(D,b)}getPoints(y=5){const b=[];for(let D=0;D<=y;D++)b.push(this.getPoint(D/y));return b}getSpacedPoints(y=5){const b=[];for(let D=0;D<=y;D++)b.push(this.getPointAt(D/y));return b}getLength(){const y=this.getLengths();return y[y.length-1]}getLengths(y=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===y+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const b=[];let D,Y=this.getPoint(0),_e=0;b.push(0);for(let Le=1;Le<=y;Le++)D=this.getPoint(Le/y),_e+=D.distanceTo(Y),b.push(_e),Y=D;return this.cacheArcLengths=b,b}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(y,b){const D=this.getLengths();let Y=0;const _e=D.length;let Le;Le=b||y*D[_e-1];let qe,it=0,nt=_e-1;for(;it<=nt;)if(Y=Math.floor(it+(nt-it)/2),qe=D[Y]-Le,qe<0)it=Y+1;else{if(!(qe>0)){nt=Y;break}nt=Y-1}if(Y=nt,D[Y]===Le)return Y/(_e-1);const mt=D[Y];return(Y+(Le-mt)/(D[Y+1]-mt))/(_e-1)}getTangent(y,b){let Y=y-1e-4,_e=y+1e-4;Y<0&&(Y=0),_e>1&&(_e=1);const Le=this.getPoint(Y),qe=this.getPoint(_e),it=b||(Le.isVector2?new en:new ii);return it.copy(qe).sub(Le).normalize(),it}getTangentAt(y,b){const D=this.getUtoTmapping(y);return this.getTangent(D,b)}computeFrenetFrames(y,b){const D=new ii,Y=[],_e=[],Le=[],qe=new ii,it=new Xn;for(let wt=0;wt<=y;wt++){const Et=wt/y;Y[wt]=this.getTangentAt(Et,new ii)}_e[0]=new ii,Le[0]=new ii;let nt=Number.MAX_VALUE;const mt=Math.abs(Y[0].x),bt=Math.abs(Y[0].y),At=Math.abs(Y[0].z);mt<=nt&&(nt=mt,D.set(1,0,0)),bt<=nt&&(nt=bt,D.set(0,1,0)),At<=nt&&D.set(0,0,1),qe.crossVectors(Y[0],D).normalize(),_e[0].crossVectors(Y[0],qe),Le[0].crossVectors(Y[0],_e[0]);for(let wt=1;wt<=y;wt++){if(_e[wt]=_e[wt-1].clone(),Le[wt]=Le[wt-1].clone(),qe.crossVectors(Y[wt-1],Y[wt]),qe.length()>Number.EPSILON){qe.normalize();const Et=Math.acos(Ur(Y[wt-1].dot(Y[wt]),-1,1));_e[wt].applyMatrix4(it.makeRotationAxis(qe,Et))}Le[wt].crossVectors(Y[wt],_e[wt])}if(b===!0){let wt=Math.acos(Ur(_e[0].dot(_e[y]),-1,1));wt/=y,Y[0].dot(qe.crossVectors(_e[0],_e[y]))>0&&(wt=-wt);for(let Et=1;Et<=y;Et++)_e[Et].applyMatrix4(it.makeRotationAxis(Y[Et],wt*Et)),Le[Et].crossVectors(Y[Et],_e[Et])}return{tangents:Y,normals:_e,binormals:Le}}clone(){return new this.constructor().copy(this)}copy(y){return this.arcLengthDivisions=y.arcLengthDivisions,this}toJSON(){const y={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return y.arcLengthDivisions=this.arcLengthDivisions,y.type=this.type,y}fromJSON(y){return this.arcLengthDivisions=y.arcLengthDivisions,this}}class wd extends ps{constructor(y=0,b=0,D=1,Y=1,_e=0,Le=2*Math.PI,qe=!1,it=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=y,this.aY=b,this.xRadius=D,this.yRadius=Y,this.aStartAngle=_e,this.aEndAngle=Le,this.aClockwise=qe,this.aRotation=it}getPoint(y,b){const D=b||new en,Y=2*Math.PI;let _e=this.aEndAngle-this.aStartAngle;const Le=Math.abs(_e)<Number.EPSILON;for(;_e<0;)_e+=Y;for(;_e>Y;)_e-=Y;_e<Number.EPSILON&&(_e=Le?0:Y),this.aClockwise!==!0||Le||(_e===Y?_e=-Y:_e-=Y);const qe=this.aStartAngle+y*_e;let it=this.aX+this.xRadius*Math.cos(qe),nt=this.aY+this.yRadius*Math.sin(qe);if(this.aRotation!==0){const mt=Math.cos(this.aRotation),bt=Math.sin(this.aRotation),At=it-this.aX,wt=nt-this.aY;it=At*mt-wt*bt+this.aX,nt=At*bt+wt*mt+this.aY}return D.set(it,nt)}copy(y){return super.copy(y),this.aX=y.aX,this.aY=y.aY,this.xRadius=y.xRadius,this.yRadius=y.yRadius,this.aStartAngle=y.aStartAngle,this.aEndAngle=y.aEndAngle,this.aClockwise=y.aClockwise,this.aRotation=y.aRotation,this}toJSON(){const y=super.toJSON();return y.aX=this.aX,y.aY=this.aY,y.xRadius=this.xRadius,y.yRadius=this.yRadius,y.aStartAngle=this.aStartAngle,y.aEndAngle=this.aEndAngle,y.aClockwise=this.aClockwise,y.aRotation=this.aRotation,y}fromJSON(y){return super.fromJSON(y),this.aX=y.aX,this.aY=y.aY,this.xRadius=y.xRadius,this.yRadius=y.yRadius,this.aStartAngle=y.aStartAngle,this.aEndAngle=y.aEndAngle,this.aClockwise=y.aClockwise,this.aRotation=y.aRotation,this}}class Mm extends wd{constructor(y,b,D,Y,_e,Le){super(y,b,D,D,Y,_e,Le),this.isArcCurve=!0,this.type="ArcCurve"}}function Nh(){let De=0,y=0,b=0,D=0;function Y(_e,Le,qe,it){De=_e,y=qe,b=-3*_e+3*Le-2*qe-it,D=2*_e-2*Le+qe+it}return{initCatmullRom:function(_e,Le,qe,it,nt){Y(Le,qe,nt*(qe-_e),nt*(it-Le))},initNonuniformCatmullRom:function(_e,Le,qe,it,nt,mt,bt){let At=(Le-_e)/nt-(qe-_e)/(nt+mt)+(qe-Le)/mt,wt=(qe-Le)/mt-(it-Le)/(mt+bt)+(it-qe)/bt;At*=mt,wt*=mt,Y(Le,qe,At,wt)},calc:function(_e){const Le=_e*_e;return De+y*_e+b*Le+D*(Le*_e)}}}const Ed=new ii,kh=new Nh,Uh=new Nh,Fh=new Nh;class Pm extends ps{constructor(y=[],b=!1,D="centripetal",Y=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=y,this.closed=b,this.curveType=D,this.tension=Y}getPoint(y,b=new ii){const D=b,Y=this.points,_e=Y.length,Le=(_e-(this.closed?0:1))*y;let qe,it,nt=Math.floor(Le),mt=Le-nt;this.closed?nt+=nt>0?0:(Math.floor(Math.abs(nt)/_e)+1)*_e:mt===0&&nt===_e-1&&(nt=_e-2,mt=1),this.closed||nt>0?qe=Y[(nt-1)%_e]:(Ed.subVectors(Y[0],Y[1]).add(Y[0]),qe=Ed);const bt=Y[nt%_e],At=Y[(nt+1)%_e];if(this.closed||nt+2<_e?it=Y[(nt+2)%_e]:(Ed.subVectors(Y[_e-1],Y[_e-2]).add(Y[_e-1]),it=Ed),this.curveType==="centripetal"||this.curveType==="chordal"){const wt=this.curveType==="chordal"?.5:.25;let Et=Math.pow(qe.distanceToSquared(bt),wt),Mt=Math.pow(bt.distanceToSquared(At),wt),St=Math.pow(At.distanceToSquared(it),wt);Mt<1e-4&&(Mt=1),Et<1e-4&&(Et=Mt),St<1e-4&&(St=Mt),kh.initNonuniformCatmullRom(qe.x,bt.x,At.x,it.x,Et,Mt,St),Uh.initNonuniformCatmullRom(qe.y,bt.y,At.y,it.y,Et,Mt,St),Fh.initNonuniformCatmullRom(qe.z,bt.z,At.z,it.z,Et,Mt,St)}else this.curveType==="catmullrom"&&(kh.initCatmullRom(qe.x,bt.x,At.x,it.x,this.tension),Uh.initCatmullRom(qe.y,bt.y,At.y,it.y,this.tension),Fh.initCatmullRom(qe.z,bt.z,At.z,it.z,this.tension));return D.set(kh.calc(mt),Uh.calc(mt),Fh.calc(mt)),D}copy(y){super.copy(y),this.points=[];for(let b=0,D=y.points.length;b<D;b++){const Y=y.points[b];this.points.push(Y.clone())}return this.closed=y.closed,this.curveType=y.curveType,this.tension=y.tension,this}toJSON(){const y=super.toJSON();y.points=[];for(let b=0,D=this.points.length;b<D;b++){const Y=this.points[b];y.points.push(Y.toArray())}return y.closed=this.closed,y.curveType=this.curveType,y.tension=this.tension,y}fromJSON(y){super.fromJSON(y),this.points=[];for(let b=0,D=y.points.length;b<D;b++){const Y=y.points[b];this.points.push(new ii().fromArray(Y))}return this.closed=y.closed,this.curveType=y.curveType,this.tension=y.tension,this}}function Im(De,y,b,D,Y){const _e=.5*(D-y),Le=.5*(Y-b),qe=De*De;return(2*b-2*D+_e+Le)*(De*qe)+(-3*b+3*D-2*_e-Le)*qe+_e*De+b}function iu(De,y,b,D){return function(Y,_e){const Le=1-Y;return Le*Le*_e}(De,y)+function(Y,_e){return 2*(1-Y)*Y*_e}(De,b)+function(Y,_e){return Y*Y*_e}(De,D)}function nu(De,y,b,D,Y){return function(_e,Le){const qe=1-_e;return qe*qe*qe*Le}(De,y)+function(_e,Le){const qe=1-_e;return 3*qe*qe*_e*Le}(De,b)+function(_e,Le){return 3*(1-_e)*_e*_e*Le}(De,D)+function(_e,Le){return _e*_e*_e*Le}(De,Y)}class jh extends ps{constructor(y=new en,b=new en,D=new en,Y=new en){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=y,this.v1=b,this.v2=D,this.v3=Y}getPoint(y,b=new en){const D=b,Y=this.v0,_e=this.v1,Le=this.v2,qe=this.v3;return D.set(nu(y,Y.x,_e.x,Le.x,qe.x),nu(y,Y.y,_e.y,Le.y,qe.y)),D}copy(y){return super.copy(y),this.v0.copy(y.v0),this.v1.copy(y.v1),this.v2.copy(y.v2),this.v3.copy(y.v3),this}toJSON(){const y=super.toJSON();return y.v0=this.v0.toArray(),y.v1=this.v1.toArray(),y.v2=this.v2.toArray(),y.v3=this.v3.toArray(),y}fromJSON(y){return super.fromJSON(y),this.v0.fromArray(y.v0),this.v1.fromArray(y.v1),this.v2.fromArray(y.v2),this.v3.fromArray(y.v3),this}}class Rm extends ps{constructor(y=new ii,b=new ii,D=new ii,Y=new ii){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=y,this.v1=b,this.v2=D,this.v3=Y}getPoint(y,b=new ii){const D=b,Y=this.v0,_e=this.v1,Le=this.v2,qe=this.v3;return D.set(nu(y,Y.x,_e.x,Le.x,qe.x),nu(y,Y.y,_e.y,Le.y,qe.y),nu(y,Y.z,_e.z,Le.z,qe.z)),D}copy(y){return super.copy(y),this.v0.copy(y.v0),this.v1.copy(y.v1),this.v2.copy(y.v2),this.v3.copy(y.v3),this}toJSON(){const y=super.toJSON();return y.v0=this.v0.toArray(),y.v1=this.v1.toArray(),y.v2=this.v2.toArray(),y.v3=this.v3.toArray(),y}fromJSON(y){return super.fromJSON(y),this.v0.fromArray(y.v0),this.v1.fromArray(y.v1),this.v2.fromArray(y.v2),this.v3.fromArray(y.v3),this}}class Gh extends ps{constructor(y=new en,b=new en){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=y,this.v2=b}getPoint(y,b=new en){const D=b;return y===1?D.copy(this.v2):(D.copy(this.v2).sub(this.v1),D.multiplyScalar(y).add(this.v1)),D}getPointAt(y,b){return this.getPoint(y,b)}getTangent(y,b=new en){return b.subVectors(this.v2,this.v1).normalize()}getTangentAt(y,b){return this.getTangent(y,b)}copy(y){return super.copy(y),this.v1.copy(y.v1),this.v2.copy(y.v2),this}toJSON(){const y=super.toJSON();return y.v1=this.v1.toArray(),y.v2=this.v2.toArray(),y}fromJSON(y){return super.fromJSON(y),this.v1.fromArray(y.v1),this.v2.fromArray(y.v2),this}}class Dm extends ps{constructor(y=new ii,b=new ii){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=y,this.v2=b}getPoint(y,b=new ii){const D=b;return y===1?D.copy(this.v2):(D.copy(this.v2).sub(this.v1),D.multiplyScalar(y).add(this.v1)),D}getPointAt(y,b){return this.getPoint(y,b)}getTangent(y,b=new ii){return b.subVectors(this.v2,this.v1).normalize()}getTangentAt(y,b){return this.getTangent(y,b)}copy(y){return super.copy(y),this.v1.copy(y.v1),this.v2.copy(y.v2),this}toJSON(){const y=super.toJSON();return y.v1=this.v1.toArray(),y.v2=this.v2.toArray(),y}fromJSON(y){return super.fromJSON(y),this.v1.fromArray(y.v1),this.v2.fromArray(y.v2),this}}class Vh extends ps{constructor(y=new en,b=new en,D=new en){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=y,this.v1=b,this.v2=D}getPoint(y,b=new en){const D=b,Y=this.v0,_e=this.v1,Le=this.v2;return D.set(iu(y,Y.x,_e.x,Le.x),iu(y,Y.y,_e.y,Le.y)),D}copy(y){return super.copy(y),this.v0.copy(y.v0),this.v1.copy(y.v1),this.v2.copy(y.v2),this}toJSON(){const y=super.toJSON();return y.v0=this.v0.toArray(),y.v1=this.v1.toArray(),y.v2=this.v2.toArray(),y}fromJSON(y){return super.fromJSON(y),this.v0.fromArray(y.v0),this.v1.fromArray(y.v1),this.v2.fromArray(y.v2),this}}class Hh extends ps{constructor(y=new ii,b=new ii,D=new ii){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=y,this.v1=b,this.v2=D}getPoint(y,b=new ii){const D=b,Y=this.v0,_e=this.v1,Le=this.v2;return D.set(iu(y,Y.x,_e.x,Le.x),iu(y,Y.y,_e.y,Le.y),iu(y,Y.z,_e.z,Le.z)),D}copy(y){return super.copy(y),this.v0.copy(y.v0),this.v1.copy(y.v1),this.v2.copy(y.v2),this}toJSON(){const y=super.toJSON();return y.v0=this.v0.toArray(),y.v1=this.v1.toArray(),y.v2=this.v2.toArray(),y}fromJSON(y){return super.fromJSON(y),this.v0.fromArray(y.v0),this.v1.fromArray(y.v1),this.v2.fromArray(y.v2),this}}class Qh extends ps{constructor(y=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=y}getPoint(y,b=new en){const D=b,Y=this.points,_e=(Y.length-1)*y,Le=Math.floor(_e),qe=_e-Le,it=Y[Le===0?Le:Le-1],nt=Y[Le],mt=Y[Le>Y.length-2?Y.length-1:Le+1],bt=Y[Le>Y.length-3?Y.length-1:Le+2];return D.set(Im(qe,it.x,nt.x,mt.x,bt.x),Im(qe,it.y,nt.y,mt.y,bt.y)),D}copy(y){super.copy(y),this.points=[];for(let b=0,D=y.points.length;b<D;b++){const Y=y.points[b];this.points.push(Y.clone())}return this}toJSON(){const y=super.toJSON();y.points=[];for(let b=0,D=this.points.length;b<D;b++){const Y=this.points[b];y.points.push(Y.toArray())}return y}fromJSON(y){super.fromJSON(y),this.points=[];for(let b=0,D=y.points.length;b<D;b++){const Y=y.points[b];this.points.push(new en().fromArray(Y))}return this}}var Sd=Object.freeze({__proto__:null,ArcCurve:Mm,CatmullRomCurve3:Pm,CubicBezierCurve:jh,CubicBezierCurve3:Rm,EllipseCurve:wd,LineCurve:Gh,LineCurve3:Dm,QuadraticBezierCurve:Vh,QuadraticBezierCurve3:Hh,SplineCurve:Qh});class Bm extends ps{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(y){this.curves.push(y)}closePath(){const y=this.curves[0].getPoint(0),b=this.curves[this.curves.length-1].getPoint(1);if(!y.equals(b)){const D=y.isVector2===!0?"LineCurve":"LineCurve3";this.curves.push(new Sd[D](b,y))}return this}getPoint(y,b){const D=y*this.getLength(),Y=this.getCurveLengths();let _e=0;for(;_e<Y.length;){if(Y[_e]>=D){const Le=Y[_e]-D,qe=this.curves[_e],it=qe.getLength(),nt=it===0?0:1-Le/it;return qe.getPointAt(nt,b)}_e++}return null}getLength(){const y=this.getCurveLengths();return y[y.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const y=[];let b=0;for(let D=0,Y=this.curves.length;D<Y;D++)b+=this.curves[D].getLength(),y.push(b);return this.cacheLengths=y,y}getSpacedPoints(y=40){const b=[];for(let D=0;D<=y;D++)b.push(this.getPoint(D/y));return this.autoClose&&b.push(b[0]),b}getPoints(y=12){const b=[];let D;for(let Y=0,_e=this.curves;Y<_e.length;Y++){const Le=_e[Y],qe=Le.isEllipseCurve?2*y:Le.isLineCurve||Le.isLineCurve3?1:Le.isSplineCurve?y*Le.points.length:y,it=Le.getPoints(qe);for(let nt=0;nt<it.length;nt++){const mt=it[nt];D&&D.equals(mt)||(b.push(mt),D=mt)}}return this.autoClose&&b.length>1&&!b[b.length-1].equals(b[0])&&b.push(b[0]),b}copy(y){super.copy(y),this.curves=[];for(let b=0,D=y.curves.length;b<D;b++){const Y=y.curves[b];this.curves.push(Y.clone())}return this.autoClose=y.autoClose,this}toJSON(){const y=super.toJSON();y.autoClose=this.autoClose,y.curves=[];for(let b=0,D=this.curves.length;b<D;b++){const Y=this.curves[b];y.curves.push(Y.toJSON())}return y}fromJSON(y){super.fromJSON(y),this.autoClose=y.autoClose,this.curves=[];for(let b=0,D=y.curves.length;b<D;b++){const Y=y.curves[b];this.curves.push(new Sd[Y.type]().fromJSON(Y))}return this}}class ru extends Bm{constructor(y){super(),this.type="Path",this.currentPoint=new en,y&&this.setFromPoints(y)}setFromPoints(y){this.moveTo(y[0].x,y[0].y);for(let b=1,D=y.length;b<D;b++)this.lineTo(y[b].x,y[b].y);return this}moveTo(y,b){return this.currentPoint.set(y,b),this}lineTo(y,b){const D=new Gh(this.currentPoint.clone(),new en(y,b));return this.curves.push(D),this.currentPoint.set(y,b),this}quadraticCurveTo(y,b,D,Y){const _e=new Vh(this.currentPoint.clone(),new en(y,b),new en(D,Y));return this.curves.push(_e),this.currentPoint.set(D,Y),this}bezierCurveTo(y,b,D,Y,_e,Le){const qe=new jh(this.currentPoint.clone(),new en(y,b),new en(D,Y),new en(_e,Le));return this.curves.push(qe),this.currentPoint.set(_e,Le),this}splineThru(y){const b=[this.currentPoint.clone()].concat(y),D=new Qh(b);return this.curves.push(D),this.currentPoint.copy(y[y.length-1]),this}arc(y,b,D,Y,_e,Le){const qe=this.currentPoint.x,it=this.currentPoint.y;return this.absarc(y+qe,b+it,D,Y,_e,Le),this}absarc(y,b,D,Y,_e,Le){return this.absellipse(y,b,D,D,Y,_e,Le),this}ellipse(y,b,D,Y,_e,Le,qe,it){const nt=this.currentPoint.x,mt=this.currentPoint.y;return this.absellipse(y+nt,b+mt,D,Y,_e,Le,qe,it),this}absellipse(y,b,D,Y,_e,Le,qe,it){const nt=new wd(y,b,D,Y,_e,Le,qe,it);if(this.curves.length>0){const bt=nt.getPoint(0);bt.equals(this.currentPoint)||this.lineTo(bt.x,bt.y)}this.curves.push(nt);const mt=nt.getPoint(1);return this.currentPoint.copy(mt),this}copy(y){return super.copy(y),this.currentPoint.copy(y.currentPoint),this}toJSON(){const y=super.toJSON();return y.currentPoint=this.currentPoint.toArray(),y}fromJSON(y){return super.fromJSON(y),this.currentPoint.fromArray(y.currentPoint),this}}class ou extends dr{constructor(y=[new en(0,-.5),new en(.5,0),new en(0,.5)],b=12,D=0,Y=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:y,segments:b,phiStart:D,phiLength:Y},b=Math.floor(b),Y=Ur(Y,0,2*Math.PI);const _e=[],Le=[],qe=[],it=[],nt=[],mt=1/b,bt=new ii,At=new en,wt=new ii,Et=new ii,Mt=new ii;let St=0,Nt=0;for(let It=0;It<=y.length-1;It++)switch(It){case 0:St=y[It+1].x-y[It].x,Nt=y[It+1].y-y[It].y,wt.x=1*Nt,wt.y=-St,wt.z=0*Nt,Mt.copy(wt),wt.normalize(),it.push(wt.x,wt.y,wt.z);break;case y.length-1:it.push(Mt.x,Mt.y,Mt.z);break;default:St=y[It+1].x-y[It].x,Nt=y[It+1].y-y[It].y,wt.x=1*Nt,wt.y=-St,wt.z=0*Nt,Et.copy(wt),wt.x+=Mt.x,wt.y+=Mt.y,wt.z+=Mt.z,wt.normalize(),it.push(wt.x,wt.y,wt.z),Mt.copy(Et)}for(let It=0;It<=b;It++){const Rt=D+It*mt*Y,Yt=Math.sin(Rt),Kt=Math.cos(Rt);for(let Xt=0;Xt<=y.length-1;Xt++){bt.x=y[Xt].x*Yt,bt.y=y[Xt].y,bt.z=y[Xt].x*Kt,Le.push(bt.x,bt.y,bt.z),At.x=It/b,At.y=Xt/(y.length-1),qe.push(At.x,At.y);const oi=it[3*Xt+0]*Yt,wi=it[3*Xt+1],fi=it[3*Xt+0]*Kt;nt.push(oi,wi,fi)}}for(let It=0;It<b;It++)for(let Rt=0;Rt<y.length-1;Rt++){const Yt=Rt+It*y.length,Kt=Yt,Xt=Yt+y.length,oi=Yt+y.length+1,wi=Yt+1;_e.push(Kt,Xt,wi),_e.push(oi,wi,Xt)}this.setIndex(_e),this.setAttribute("position",new Cn(Le,3)),this.setAttribute("uv",new Cn(qe,2)),this.setAttribute("normal",new Cn(nt,3))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new ou(y.points,y.segments,y.phiStart,y.phiLength)}}class Td extends ou{constructor(y=1,b=1,D=4,Y=8){const _e=new ru;_e.absarc(0,-b/2,y,1.5*Math.PI,0),_e.absarc(0,b/2,y,0,.5*Math.PI),super(_e.getPoints(D),Y),this.type="CapsuleGeometry",this.parameters={radius:y,length:b,capSegments:D,radialSegments:Y}}static fromJSON(y){return new Td(y.radius,y.length,y.capSegments,y.radialSegments)}}class Cd extends dr{constructor(y=1,b=32,D=0,Y=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:y,segments:b,thetaStart:D,thetaLength:Y},b=Math.max(3,b);const _e=[],Le=[],qe=[],it=[],nt=new ii,mt=new en;Le.push(0,0,0),qe.push(0,0,1),it.push(.5,.5);for(let bt=0,At=3;bt<=b;bt++,At+=3){const wt=D+bt/b*Y;nt.x=y*Math.cos(wt),nt.y=y*Math.sin(wt),Le.push(nt.x,nt.y,nt.z),qe.push(0,0,1),mt.x=(Le[At]/y+1)/2,mt.y=(Le[At+1]/y+1)/2,it.push(mt.x,mt.y)}for(let bt=1;bt<=b;bt++)_e.push(bt,bt+1,0);this.setIndex(_e),this.setAttribute("position",new Cn(Le,3)),this.setAttribute("normal",new Cn(qe,3)),this.setAttribute("uv",new Cn(it,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new Cd(y.radius,y.segments,y.thetaStart,y.thetaLength)}}class oc extends dr{constructor(y=1,b=1,D=1,Y=32,_e=1,Le=!1,qe=0,it=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:y,radiusBottom:b,height:D,radialSegments:Y,heightSegments:_e,openEnded:Le,thetaStart:qe,thetaLength:it};const nt=this;Y=Math.floor(Y),_e=Math.floor(_e);const mt=[],bt=[],At=[],wt=[];let Et=0;const Mt=[],St=D/2;let Nt=0;function It(Rt){const Yt=Et,Kt=new en,Xt=new ii;let oi=0;const wi=Rt===!0?y:b,fi=Rt===!0?1:-1;for(let bi=1;bi<=Y;bi++)bt.push(0,St*fi,0),At.push(0,fi,0),wt.push(.5,.5),Et++;const yi=Et;for(let bi=0;bi<=Y;bi++){const Ci=bi/Y*it+qe,tn=Math.cos(Ci),$i=Math.sin(Ci);Xt.x=wi*$i,Xt.y=St*fi,Xt.z=wi*tn,bt.push(Xt.x,Xt.y,Xt.z),At.push(0,fi,0),Kt.x=.5*tn+.5,Kt.y=.5*$i*fi+.5,wt.push(Kt.x,Kt.y),Et++}for(let bi=0;bi<Y;bi++){const Ci=Yt+bi,tn=yi+bi;Rt===!0?mt.push(tn,tn+1,Ci):mt.push(tn+1,tn,Ci),oi+=3}nt.addGroup(Nt,oi,Rt===!0?1:2),Nt+=oi}(function(){const Rt=new ii,Yt=new ii;let Kt=0;const Xt=(b-y)/D;for(let oi=0;oi<=_e;oi++){const wi=[],fi=oi/_e,yi=fi*(b-y)+y;for(let bi=0;bi<=Y;bi++){const Ci=bi/Y,tn=Ci*it+qe,$i=Math.sin(tn),gn=Math.cos(tn);Yt.x=yi*$i,Yt.y=-fi*D+St,Yt.z=yi*gn,bt.push(Yt.x,Yt.y,Yt.z),Rt.set($i,Xt,gn).normalize(),At.push(Rt.x,Rt.y,Rt.z),wt.push(Ci,1-fi),wi.push(Et++)}Mt.push(wi)}for(let oi=0;oi<Y;oi++)for(let wi=0;wi<_e;wi++){const fi=Mt[wi][oi],yi=Mt[wi+1][oi],bi=Mt[wi+1][oi+1],Ci=Mt[wi][oi+1];mt.push(fi,yi,Ci),mt.push(yi,bi,Ci),Kt+=6}nt.addGroup(Nt,Kt,0),Nt+=Kt})(),Le===!1&&(y>0&&It(!0),b>0&&It(!1)),this.setIndex(mt),this.setAttribute("position",new Cn(bt,3)),this.setAttribute("normal",new Cn(At,3)),this.setAttribute("uv",new Cn(wt,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new oc(y.radiusTop,y.radiusBottom,y.height,y.radialSegments,y.heightSegments,y.openEnded,y.thetaStart,y.thetaLength)}}class Md extends oc{constructor(y=1,b=1,D=32,Y=1,_e=!1,Le=0,qe=2*Math.PI){super(0,y,b,D,Y,_e,Le,qe),this.type="ConeGeometry",this.parameters={radius:y,height:b,radialSegments:D,heightSegments:Y,openEnded:_e,thetaStart:Le,thetaLength:qe}}static fromJSON(y){return new Md(y.radius,y.height,y.radialSegments,y.heightSegments,y.openEnded,y.thetaStart,y.thetaLength)}}class Ca extends dr{constructor(y=[],b=[],D=1,Y=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:y,indices:b,radius:D,detail:Y};const _e=[],Le=[];function qe(At,wt,Et,Mt){const St=Mt+1,Nt=[];for(let It=0;It<=St;It++){Nt[It]=[];const Rt=At.clone().lerp(Et,It/St),Yt=wt.clone().lerp(Et,It/St),Kt=St-It;for(let Xt=0;Xt<=Kt;Xt++)Nt[It][Xt]=Xt===0&&It===St?Rt:Rt.clone().lerp(Yt,Xt/Kt)}for(let It=0;It<St;It++)for(let Rt=0;Rt<2*(St-It)-1;Rt++){const Yt=Math.floor(Rt/2);Rt%2==0?(it(Nt[It][Yt+1]),it(Nt[It+1][Yt]),it(Nt[It][Yt])):(it(Nt[It][Yt+1]),it(Nt[It+1][Yt+1]),it(Nt[It+1][Yt]))}}function it(At){_e.push(At.x,At.y,At.z)}function nt(At,wt){const Et=3*At;wt.x=y[Et+0],wt.y=y[Et+1],wt.z=y[Et+2]}function mt(At,wt,Et,Mt){Mt<0&&At.x===1&&(Le[wt]=At.x-1),Et.x===0&&Et.z===0&&(Le[wt]=Mt/2/Math.PI+.5)}function bt(At){return Math.atan2(At.z,-At.x)}(function(At){const wt=new ii,Et=new ii,Mt=new ii;for(let St=0;St<b.length;St+=3)nt(b[St+0],wt),nt(b[St+1],Et),nt(b[St+2],Mt),qe(wt,Et,Mt,At)})(Y),function(At){const wt=new ii;for(let Et=0;Et<_e.length;Et+=3)wt.x=_e[Et+0],wt.y=_e[Et+1],wt.z=_e[Et+2],wt.normalize().multiplyScalar(At),_e[Et+0]=wt.x,_e[Et+1]=wt.y,_e[Et+2]=wt.z}(D),function(){const At=new ii;for(let Et=0;Et<_e.length;Et+=3){At.x=_e[Et+0],At.y=_e[Et+1],At.z=_e[Et+2];const Mt=bt(At)/2/Math.PI+.5,St=(wt=At,Math.atan2(-wt.y,Math.sqrt(wt.x*wt.x+wt.z*wt.z))/Math.PI+.5);Le.push(Mt,1-St)}var wt;(function(){const Et=new ii,Mt=new ii,St=new ii,Nt=new ii,It=new en,Rt=new en,Yt=new en;for(let Kt=0,Xt=0;Kt<_e.length;Kt+=9,Xt+=6){Et.set(_e[Kt+0],_e[Kt+1],_e[Kt+2]),Mt.set(_e[Kt+3],_e[Kt+4],_e[Kt+5]),St.set(_e[Kt+6],_e[Kt+7],_e[Kt+8]),It.set(Le[Xt+0],Le[Xt+1]),Rt.set(Le[Xt+2],Le[Xt+3]),Yt.set(Le[Xt+4],Le[Xt+5]),Nt.copy(Et).add(Mt).add(St).divideScalar(3);const oi=bt(Nt);mt(It,Xt+0,Et,oi),mt(Rt,Xt+2,Mt,oi),mt(Yt,Xt+4,St,oi)}})(),function(){for(let Et=0;Et<Le.length;Et+=6){const Mt=Le[Et+0],St=Le[Et+2],Nt=Le[Et+4],It=Math.max(Mt,St,Nt),Rt=Math.min(Mt,St,Nt);It>.9&&Rt<.1&&(Mt<.2&&(Le[Et+0]+=1),St<.2&&(Le[Et+2]+=1),Nt<.2&&(Le[Et+4]+=1))}}()}(),this.setAttribute("position",new Cn(_e,3)),this.setAttribute("normal",new Cn(_e.slice(),3)),this.setAttribute("uv",new Cn(Le,2)),Y===0?this.computeVertexNormals():this.normalizeNormals()}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new Ca(y.vertices,y.indices,y.radius,y.details)}}class Pd extends Ca{constructor(y=1,b=0){const D=(1+Math.sqrt(5))/2,Y=1/D;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-Y,-D,0,-Y,D,0,Y,-D,0,Y,D,-Y,-D,0,-Y,D,0,Y,-D,0,Y,D,0,-D,0,-Y,D,0,-Y,-D,0,Y,D,0,Y],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],y,b),this.type="DodecahedronGeometry",this.parameters={radius:y,detail:b}}static fromJSON(y){return new Pd(y.radius,y.detail)}}const Id=new ii,Rd=new ii,Wh=new ii,Dd=new fo;class Om extends dr{constructor(y=null,b=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:y,thresholdAngle:b},y!==null){const Y=Math.pow(10,4),_e=Math.cos(As*b),Le=y.getIndex(),qe=y.getAttribute("position"),it=Le?Le.count:qe.count,nt=[0,0,0],mt=["a","b","c"],bt=new Array(3),At={},wt=[];for(let Et=0;Et<it;Et+=3){Le?(nt[0]=Le.getX(Et),nt[1]=Le.getX(Et+1),nt[2]=Le.getX(Et+2)):(nt[0]=Et,nt[1]=Et+1,nt[2]=Et+2);const{a:Mt,b:St,c:Nt}=Dd;if(Mt.fromBufferAttribute(qe,nt[0]),St.fromBufferAttribute(qe,nt[1]),Nt.fromBufferAttribute(qe,nt[2]),Dd.getNormal(Wh),bt[0]=`${Math.round(Mt.x*Y)},${Math.round(Mt.y*Y)},${Math.round(Mt.z*Y)}`,bt[1]=`${Math.round(St.x*Y)},${Math.round(St.y*Y)},${Math.round(St.z*Y)}`,bt[2]=`${Math.round(Nt.x*Y)},${Math.round(Nt.y*Y)},${Math.round(Nt.z*Y)}`,bt[0]!==bt[1]&&bt[1]!==bt[2]&&bt[2]!==bt[0])for(let It=0;It<3;It++){const Rt=(It+1)%3,Yt=bt[It],Kt=bt[Rt],Xt=Dd[mt[It]],oi=Dd[mt[Rt]],wi=`${Yt}_${Kt}`,fi=`${Kt}_${Yt}`;fi in At&&At[fi]?(Wh.dot(At[fi].normal)<=_e&&(wt.push(Xt.x,Xt.y,Xt.z),wt.push(oi.x,oi.y,oi.z)),At[fi]=null):wi in At||(At[wi]={index0:nt[It],index1:nt[Rt],normal:Wh.clone()})}}for(const Et in At)if(At[Et]){const{index0:Mt,index1:St}=At[Et];Id.fromBufferAttribute(qe,Mt),Rd.fromBufferAttribute(qe,St),wt.push(Id.x,Id.y,Id.z),wt.push(Rd.x,Rd.y,Rd.z)}this.setAttribute("position",new Cn(wt,3))}}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}}class el extends ru{constructor(y){super(y),this.uuid=vo(),this.type="Shape",this.holes=[]}getPointsHoles(y){const b=[];for(let D=0,Y=this.holes.length;D<Y;D++)b[D]=this.holes[D].getPoints(y);return b}extractPoints(y){return{shape:this.getPoints(y),holes:this.getPointsHoles(y)}}copy(y){super.copy(y),this.holes=[];for(let b=0,D=y.holes.length;b<D;b++){const Y=y.holes[b];this.holes.push(Y.clone())}return this}toJSON(){const y=super.toJSON();y.uuid=this.uuid,y.holes=[];for(let b=0,D=this.holes.length;b<D;b++){const Y=this.holes[b];y.holes.push(Y.toJSON())}return y}fromJSON(y){super.fromJSON(y),this.uuid=y.uuid,this.holes=[];for(let b=0,D=y.holes.length;b<D;b++){const Y=y.holes[b];this.holes.push(new ru().fromJSON(Y))}return this}}function Lm(De,y,b,D,Y){let _e,Le;if(Y===function(qe,it,nt,mt){let bt=0;for(let At=it,wt=nt-mt;At<nt;At+=mt)bt+=(qe[wt]-qe[At])*(qe[At+1]+qe[wt+1]),wt=At;return bt}(De,y,b,D)>0)for(_e=y;_e<b;_e+=D)Le=Um(_e,De[_e],De[_e+1],Le);else for(_e=b-D;_e>=y;_e-=D)Le=Um(_e,De[_e],De[_e+1],Le);return Le&&Bd(Le,Le.next)&&(lu(Le),Le=Le.next),Le}function tl(De,y){if(!De)return De;y||(y=De);let b,D=De;do if(b=!1,D.steiner||!Bd(D,D.next)&&Gr(D.prev,D,D.next)!==0)D=D.next;else{if(lu(D),D=y=D.prev,D===D.next)break;b=!0}while(b||D!==y);return y}function su(De,y,b,D,Y,_e,Le){if(!De)return;!Le&&_e&&function(mt,bt,At,wt){let Et=mt;do Et.z===0&&(Et.z=qh(Et.x,Et.y,bt,At,wt)),Et.prevZ=Et.prev,Et.nextZ=Et.next,Et=Et.next;while(Et!==mt);Et.prevZ.nextZ=null,Et.prevZ=null,function(Mt){let St,Nt,It,Rt,Yt,Kt,Xt,oi,wi=1;do{for(Nt=Mt,Mt=null,Yt=null,Kt=0;Nt;){for(Kt++,It=Nt,Xt=0,St=0;St<wi&&(Xt++,It=It.nextZ,It);St++);for(oi=wi;Xt>0||oi>0&&It;)Xt!==0&&(oi===0||!It||Nt.z<=It.z)?(Rt=Nt,Nt=Nt.nextZ,Xt--):(Rt=It,It=It.nextZ,oi--),Yt?Yt.nextZ=Rt:Mt=Rt,Rt.prevZ=Yt,Yt=Rt;Nt=It}Yt.nextZ=null,wi*=2}while(Kt>1)}(Et)}(De,D,Y,_e);let qe,it,nt=De;for(;De.prev!==De.next;)if(qe=De.prev,it=De.next,_e?H_(De,D,Y,_e):V_(De))y.push(qe.i/b|0),y.push(De.i/b|0),y.push(it.i/b|0),lu(De),De=it.next,nt=it.next;else if((De=it)===nt){Le?Le===1?su(De=Q_(tl(De),y,b),y,b,D,Y,_e,2):Le===2&&W_(De,y,b,D,Y,_e):su(tl(De),y,b,D,Y,_e,1);break}}function V_(De){const y=De.prev,b=De,D=De.next;if(Gr(y,b,D)>=0)return!1;const Y=y.x,_e=b.x,Le=D.x,qe=y.y,it=b.y,nt=D.y,mt=Y<_e?Y<Le?Y:Le:_e<Le?_e:Le,bt=qe<it?qe<nt?qe:nt:it<nt?it:nt,At=Y>_e?Y>Le?Y:Le:_e>Le?_e:Le,wt=qe>it?qe>nt?qe:nt:it>nt?it:nt;let Et=D.next;for(;Et!==y;){if(Et.x>=mt&&Et.x<=At&&Et.y>=bt&&Et.y<=wt&&sc(Y,qe,_e,it,Le,nt,Et.x,Et.y)&&Gr(Et.prev,Et,Et.next)>=0)return!1;Et=Et.next}return!0}function H_(De,y,b,D){const Y=De.prev,_e=De,Le=De.next;if(Gr(Y,_e,Le)>=0)return!1;const qe=Y.x,it=_e.x,nt=Le.x,mt=Y.y,bt=_e.y,At=Le.y,wt=qe<it?qe<nt?qe:nt:it<nt?it:nt,Et=mt<bt?mt<At?mt:At:bt<At?bt:At,Mt=qe>it?qe>nt?qe:nt:it>nt?it:nt,St=mt>bt?mt>At?mt:At:bt>At?bt:At,Nt=qh(wt,Et,y,b,D),It=qh(Mt,St,y,b,D);let Rt=De.prevZ,Yt=De.nextZ;for(;Rt&&Rt.z>=Nt&&Yt&&Yt.z<=It;){if(Rt.x>=wt&&Rt.x<=Mt&&Rt.y>=Et&&Rt.y<=St&&Rt!==Y&&Rt!==Le&&sc(qe,mt,it,bt,nt,At,Rt.x,Rt.y)&&Gr(Rt.prev,Rt,Rt.next)>=0||(Rt=Rt.prevZ,Yt.x>=wt&&Yt.x<=Mt&&Yt.y>=Et&&Yt.y<=St&&Yt!==Y&&Yt!==Le&&sc(qe,mt,it,bt,nt,At,Yt.x,Yt.y)&&Gr(Yt.prev,Yt,Yt.next)>=0))return!1;Yt=Yt.nextZ}for(;Rt&&Rt.z>=Nt;){if(Rt.x>=wt&&Rt.x<=Mt&&Rt.y>=Et&&Rt.y<=St&&Rt!==Y&&Rt!==Le&&sc(qe,mt,it,bt,nt,At,Rt.x,Rt.y)&&Gr(Rt.prev,Rt,Rt.next)>=0)return!1;Rt=Rt.prevZ}for(;Yt&&Yt.z<=It;){if(Yt.x>=wt&&Yt.x<=Mt&&Yt.y>=Et&&Yt.y<=St&&Yt!==Y&&Yt!==Le&&sc(qe,mt,it,bt,nt,At,Yt.x,Yt.y)&&Gr(Yt.prev,Yt,Yt.next)>=0)return!1;Yt=Yt.nextZ}return!0}function Q_(De,y,b){let D=De;do{const Y=D.prev,_e=D.next.next;!Bd(Y,_e)&&Nm(Y,D,D.next,_e)&&au(Y,_e)&&au(_e,Y)&&(y.push(Y.i/b|0),y.push(D.i/b|0),y.push(_e.i/b|0),lu(D),lu(D.next),D=De=_e),D=D.next}while(D!==De);return tl(D)}function W_(De,y,b,D,Y,_e){let Le=De;do{let qe=Le.next.next;for(;qe!==Le.prev;){if(Le.i!==qe.i&&$_(Le,qe)){let it=km(Le,qe);return Le=tl(Le,Le.next),it=tl(it,it.next),su(Le,y,b,D,Y,_e,0),void su(it,y,b,D,Y,_e,0)}qe=qe.next}Le=Le.next}while(Le!==De)}function q_(De,y){return De.x-y.x}function X_(De,y){const b=function(Y,_e){let Le,qe=_e,it=-1/0;const nt=Y.x,mt=Y.y;do{if(mt<=qe.y&&mt>=qe.next.y&&qe.next.y!==qe.y){const St=qe.x+(mt-qe.y)*(qe.next.x-qe.x)/(qe.next.y-qe.y);if(St<=nt&&St>it&&(it=St,Le=qe.x<qe.next.x?qe:qe.next,St===nt))return Le}qe=qe.next}while(qe!==_e);if(!Le)return null;const bt=Le,At=Le.x,wt=Le.y;let Et,Mt=1/0;qe=Le;do nt>=qe.x&&qe.x>=At&&nt!==qe.x&&sc(mt<wt?nt:it,mt,At,wt,mt<wt?it:nt,mt,qe.x,qe.y)&&(Et=Math.abs(mt-qe.y)/(nt-qe.x),au(qe,Y)&&(Et<Mt||Et===Mt&&(qe.x>Le.x||qe.x===Le.x&&Y_(Le,qe)))&&(Le=qe,Mt=Et)),qe=qe.next;while(qe!==bt);return Le}(De,y);if(!b)return y;const D=km(b,De);return tl(D,D.next),tl(b,b.next)}function Y_(De,y){return Gr(De.prev,De,y.prev)<0&&Gr(y.next,De,De.next)<0}function qh(De,y,b,D,Y){return(De=1431655765&((De=858993459&((De=252645135&((De=16711935&((De=(De-b)*Y|0)|De<<8))|De<<4))|De<<2))|De<<1))|(y=1431655765&((y=858993459&((y=252645135&((y=16711935&((y=(y-D)*Y|0)|y<<8))|y<<4))|y<<2))|y<<1))<<1}function K_(De){let y=De,b=De;do(y.x<b.x||y.x===b.x&&y.y<b.y)&&(b=y),y=y.next;while(y!==De);return b}function sc(De,y,b,D,Y,_e,Le,qe){return(Y-Le)*(y-qe)>=(De-Le)*(_e-qe)&&(De-Le)*(D-qe)>=(b-Le)*(y-qe)&&(b-Le)*(_e-qe)>=(Y-Le)*(D-qe)}function $_(De,y){return De.next.i!==y.i&&De.prev.i!==y.i&&!function(b,D){let Y=b;do{if(Y.i!==b.i&&Y.next.i!==b.i&&Y.i!==D.i&&Y.next.i!==D.i&&Nm(Y,Y.next,b,D))return!0;Y=Y.next}while(Y!==b);return!1}(De,y)&&(au(De,y)&&au(y,De)&&function(b,D){let Y=b,_e=!1;const Le=(b.x+D.x)/2,qe=(b.y+D.y)/2;do Y.y>qe!=Y.next.y>qe&&Y.next.y!==Y.y&&Le<(Y.next.x-Y.x)*(qe-Y.y)/(Y.next.y-Y.y)+Y.x&&(_e=!_e),Y=Y.next;while(Y!==b);return _e}(De,y)&&(Gr(De.prev,De,y.prev)||Gr(De,y.prev,y))||Bd(De,y)&&Gr(De.prev,De,De.next)>0&&Gr(y.prev,y,y.next)>0)}function Gr(De,y,b){return(y.y-De.y)*(b.x-y.x)-(y.x-De.x)*(b.y-y.y)}function Bd(De,y){return De.x===y.x&&De.y===y.y}function Nm(De,y,b,D){const Y=Ld(Gr(De,y,b)),_e=Ld(Gr(De,y,D)),Le=Ld(Gr(b,D,De)),qe=Ld(Gr(b,D,y));return Y!==_e&&Le!==qe||!(Y!==0||!Od(De,b,y))||!(_e!==0||!Od(De,D,y))||!(Le!==0||!Od(b,De,D))||!(qe!==0||!Od(b,y,D))}function Od(De,y,b){return y.x<=Math.max(De.x,b.x)&&y.x>=Math.min(De.x,b.x)&&y.y<=Math.max(De.y,b.y)&&y.y>=Math.min(De.y,b.y)}function Ld(De){return De>0?1:De<0?-1:0}function au(De,y){return Gr(De.prev,De,De.next)<0?Gr(De,y,De.next)>=0&&Gr(De,De.prev,y)>=0:Gr(De,y,De.prev)<0||Gr(De,De.next,y)<0}function km(De,y){const b=new Xh(De.i,De.x,De.y),D=new Xh(y.i,y.x,y.y),Y=De.next,_e=y.prev;return De.next=y,y.prev=De,b.next=Y,Y.prev=b,D.next=b,b.prev=D,_e.next=D,D.prev=_e,D}function Um(De,y,b,D){const Y=new Xh(De,y,b);return D?(Y.next=D.next,Y.prev=D,D.next.prev=Y,D.next=Y):(Y.prev=Y,Y.next=Y),Y}function lu(De){De.next.prev=De.prev,De.prev.next=De.next,De.prevZ&&(De.prevZ.nextZ=De.nextZ),De.nextZ&&(De.nextZ.prevZ=De.prevZ)}function Xh(De,y,b){this.i=De,this.x=y,this.y=b,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}class Cs{static area(y){const b=y.length;let D=0;for(let Y=b-1,_e=0;_e<b;Y=_e++)D+=y[Y].x*y[_e].y-y[_e].x*y[Y].y;return .5*D}static isClockWise(y){return Cs.area(y)<0}static triangulateShape(y,b){const D=[],Y=[],_e=[];Fm(y),jm(D,y);let Le=y.length;b.forEach(Fm);for(let it=0;it<b.length;it++)Y.push(Le),Le+=b[it].length,jm(D,b[it]);const qe=function(it,nt,mt=2){const bt=nt&&nt.length,At=bt?nt[0]*mt:it.length;let wt=Lm(it,0,At,mt,!0);const Et=[];if(!wt||wt.next===wt.prev)return Et;let Mt,St,Nt,It,Rt,Yt,Kt;if(bt&&(wt=function(Xt,oi,wi,fi){const yi=[];let bi,Ci,tn,$i,gn;for(bi=0,Ci=oi.length;bi<Ci;bi++)tn=oi[bi]*fi,$i=bi<Ci-1?oi[bi+1]*fi:Xt.length,gn=Lm(Xt,tn,$i,fi,!1),gn===gn.next&&(gn.steiner=!0),yi.push(K_(gn));for(yi.sort(q_),bi=0;bi<yi.length;bi++)wi=X_(yi[bi],wi);return wi}(it,nt,wt,mt)),it.length>80*mt){Mt=Nt=it[0],St=It=it[1];for(let Xt=mt;Xt<At;Xt+=mt)Rt=it[Xt],Yt=it[Xt+1],Rt<Mt&&(Mt=Rt),Yt<St&&(St=Yt),Rt>Nt&&(Nt=Rt),Yt>It&&(It=Yt);Kt=Math.max(Nt-Mt,It-St),Kt=Kt!==0?32767/Kt:0}return su(wt,Et,mt,Mt,St,Kt,0),Et}(D,Y);for(let it=0;it<qe.length;it+=3)_e.push(qe.slice(it,it+3));return _e}}function Fm(De){const y=De.length;y>2&&De[y-1].equals(De[0])&&De.pop()}function jm(De,y){for(let b=0;b<y.length;b++)De.push(y[b].x),De.push(y[b].y)}class Nd extends dr{constructor(y=new el([new en(.5,.5),new en(-.5,.5),new en(-.5,-.5),new en(.5,-.5)]),b={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:y,options:b},y=Array.isArray(y)?y:[y];const D=this,Y=[],_e=[];for(let qe=0,it=y.length;qe<it;qe++)Le(y[qe]);function Le(qe){const it=[],nt=b.curveSegments!==void 0?b.curveSegments:12,mt=b.steps!==void 0?b.steps:1,bt=b.depth!==void 0?b.depth:1;let At=b.bevelEnabled===void 0||b.bevelEnabled,wt=b.bevelThickness!==void 0?b.bevelThickness:.2,Et=b.bevelSize!==void 0?b.bevelSize:wt-.1,Mt=b.bevelOffset!==void 0?b.bevelOffset:0,St=b.bevelSegments!==void 0?b.bevelSegments:3;const Nt=b.extrudePath,It=b.UVGenerator!==void 0?b.UVGenerator:J_;let Rt,Yt,Kt,Xt,oi,wi=!1;Nt&&(Rt=Nt.getSpacedPoints(mt),wi=!0,At=!1,Yt=Nt.computeFrenetFrames(mt,!1),Kt=new ii,Xt=new ii,oi=new ii),At||(St=0,wt=0,Et=0,Mt=0);const fi=qe.extractPoints(nt);let yi=fi.shape;const bi=fi.holes;if(!Cs.isClockWise(yi)){yi=yi.reverse();for(let gi=0,Mi=bi.length;gi<Mi;gi++){const ui=bi[gi];Cs.isClockWise(ui)&&(bi[gi]=ui.reverse())}}const Ci=Cs.triangulateShape(yi,bi),tn=yi;for(let gi=0,Mi=bi.length;gi<Mi;gi++){const ui=bi[gi];yi=yi.concat(ui)}function $i(gi,Mi,ui){return Mi||console.error("THREE.ExtrudeGeometry: vec does not exist"),gi.clone().addScaledVector(Mi,ui)}const gn=yi.length,xn=Ci.length;function Wi(gi,Mi,ui){let Qt,hi,pi;const Bi=gi.x-Mi.x,Ni=gi.y-Mi.y,cn=ui.x-gi.x,Ji=ui.y-gi.y,lr=Bi*Bi+Ni*Ni,Qn=Bi*Ji-Ni*cn;if(Math.abs(Qn)>Number.EPSILON){const mn=Math.sqrt(lr),Hn=Math.sqrt(cn*cn+Ji*Ji),jn=Mi.x-Ni/mn,nr=Mi.y+Bi/mn,hr=((ui.x-Ji/Hn-jn)*Ji-(ui.y+cn/Hn-nr)*cn)/(Bi*Ji-Ni*cn);Qt=jn+Bi*hr-gi.x,hi=nr+Ni*hr-gi.y;const Pr=Qt*Qt+hi*hi;if(Pr<=2)return new en(Qt,hi);pi=Math.sqrt(Pr/2)}else{let mn=!1;Bi>Number.EPSILON?cn>Number.EPSILON&&(mn=!0):Bi<-Number.EPSILON?cn<-Number.EPSILON&&(mn=!0):Math.sign(Ni)===Math.sign(Ji)&&(mn=!0),mn?(Qt=-Ni,hi=Bi,pi=Math.sqrt(lr)):(Qt=Bi,hi=Ni,pi=Math.sqrt(lr/2))}return new en(Qt/pi,hi/pi)}const Oi=[];for(let gi=0,Mi=tn.length,ui=Mi-1,Qt=gi+1;gi<Mi;gi++,ui++,Qt++)ui===Mi&&(ui=0),Qt===Mi&&(Qt=0),Oi[gi]=Wi(tn[gi],tn[ui],tn[Qt]);const ki=[];let Hi,Vi=Oi.concat();for(let gi=0,Mi=bi.length;gi<Mi;gi++){const ui=bi[gi];Hi=[];for(let Qt=0,hi=ui.length,pi=hi-1,Bi=Qt+1;Qt<hi;Qt++,pi++,Bi++)pi===hi&&(pi=0),Bi===hi&&(Bi=0),Hi[Qt]=Wi(ui[Qt],ui[pi],ui[Bi]);ki.push(Hi),Vi=Vi.concat(Hi)}for(let gi=0;gi<St;gi++){const Mi=gi/St,ui=wt*Math.cos(Mi*Math.PI/2),Qt=Et*Math.sin(Mi*Math.PI/2)+Mt;for(let hi=0,pi=tn.length;hi<pi;hi++){const Bi=$i(tn[hi],Oi[hi],Qt);zn(Bi.x,Bi.y,-ui)}for(let hi=0,pi=bi.length;hi<pi;hi++){const Bi=bi[hi];Hi=ki[hi];for(let Ni=0,cn=Bi.length;Ni<cn;Ni++){const Ji=$i(Bi[Ni],Hi[Ni],Qt);zn(Ji.x,Ji.y,-ui)}}}const Mn=Et+Mt;for(let gi=0;gi<gn;gi++){const Mi=At?$i(yi[gi],Vi[gi],Mn):yi[gi];wi?(Xt.copy(Yt.normals[0]).multiplyScalar(Mi.x),Kt.copy(Yt.binormals[0]).multiplyScalar(Mi.y),oi.copy(Rt[0]).add(Xt).add(Kt),zn(oi.x,oi.y,oi.z)):zn(Mi.x,Mi.y,0)}for(let gi=1;gi<=mt;gi++)for(let Mi=0;Mi<gn;Mi++){const ui=At?$i(yi[Mi],Vi[Mi],Mn):yi[Mi];wi?(Xt.copy(Yt.normals[gi]).multiplyScalar(ui.x),Kt.copy(Yt.binormals[gi]).multiplyScalar(ui.y),oi.copy(Rt[gi]).add(Xt).add(Kt),zn(oi.x,oi.y,oi.z)):zn(ui.x,ui.y,bt/mt*gi)}for(let gi=St-1;gi>=0;gi--){const Mi=gi/St,ui=wt*Math.cos(Mi*Math.PI/2),Qt=Et*Math.sin(Mi*Math.PI/2)+Mt;for(let hi=0,pi=tn.length;hi<pi;hi++){const Bi=$i(tn[hi],Oi[hi],Qt);zn(Bi.x,Bi.y,bt+ui)}for(let hi=0,pi=bi.length;hi<pi;hi++){const Bi=bi[hi];Hi=ki[hi];for(let Ni=0,cn=Bi.length;Ni<cn;Ni++){const Ji=$i(Bi[Ni],Hi[Ni],Qt);wi?zn(Ji.x,Ji.y+Rt[mt-1].y,Rt[mt-1].x+ui):zn(Ji.x,Ji.y,bt+ui)}}}function Wn(gi,Mi){let ui=gi.length;for(;--ui>=0;){const Qt=ui;let hi=ui-1;hi<0&&(hi=gi.length-1);for(let pi=0,Bi=mt+2*St;pi<Bi;pi++){const Ni=gn*pi,cn=gn*(pi+1);ir(Mi+Qt+Ni,Mi+hi+Ni,Mi+hi+cn,Mi+Qt+cn)}}}function zn(gi,Mi,ui){it.push(gi),it.push(Mi),it.push(ui)}function Pn(gi,Mi,ui){di(gi),di(Mi),di(ui);const Qt=Y.length/3,hi=It.generateTopUV(D,Y,Qt-3,Qt-2,Qt-1);ei(hi[0]),ei(hi[1]),ei(hi[2])}function ir(gi,Mi,ui,Qt){di(gi),di(Mi),di(Qt),di(Mi),di(ui),di(Qt);const hi=Y.length/3,pi=It.generateSideWallUV(D,Y,hi-6,hi-3,hi-2,hi-1);ei(pi[0]),ei(pi[1]),ei(pi[3]),ei(pi[1]),ei(pi[2]),ei(pi[3])}function di(gi){Y.push(it[3*gi+0]),Y.push(it[3*gi+1]),Y.push(it[3*gi+2])}function ei(gi){_e.push(gi.x),_e.push(gi.y)}(function(){const gi=Y.length/3;if(At){let Mi=0,ui=gn*Mi;for(let Qt=0;Qt<xn;Qt++){const hi=Ci[Qt];Pn(hi[2]+ui,hi[1]+ui,hi[0]+ui)}Mi=mt+2*St,ui=gn*Mi;for(let Qt=0;Qt<xn;Qt++){const hi=Ci[Qt];Pn(hi[0]+ui,hi[1]+ui,hi[2]+ui)}}else{for(let Mi=0;Mi<xn;Mi++){const ui=Ci[Mi];Pn(ui[2],ui[1],ui[0])}for(let Mi=0;Mi<xn;Mi++){const ui=Ci[Mi];Pn(ui[0]+gn*mt,ui[1]+gn*mt,ui[2]+gn*mt)}}D.addGroup(gi,Y.length/3-gi,0)})(),function(){const gi=Y.length/3;let Mi=0;Wn(tn,Mi),Mi+=tn.length;for(let ui=0,Qt=bi.length;ui<Qt;ui++){const hi=bi[ui];Wn(hi,Mi),Mi+=hi.length}D.addGroup(gi,Y.length/3-gi,1)}()}this.setAttribute("position",new Cn(Y,3)),this.setAttribute("uv",new Cn(_e,2)),this.computeVertexNormals()}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}toJSON(){const y=super.toJSON();return function(b,D,Y){if(Y.shapes=[],Array.isArray(b))for(let _e=0,Le=b.length;_e<Le;_e++){const qe=b[_e];Y.shapes.push(qe.uuid)}else Y.shapes.push(b.uuid);return Y.options=Object.assign({},D),D.extrudePath!==void 0&&(Y.options.extrudePath=D.extrudePath.toJSON()),Y}(this.parameters.shapes,this.parameters.options,y)}static fromJSON(y,b){const D=[];for(let _e=0,Le=y.shapes.length;_e<Le;_e++){const qe=b[y.shapes[_e]];D.push(qe)}const Y=y.options.extrudePath;return Y!==void 0&&(y.options.extrudePath=new Sd[Y.type]().fromJSON(Y)),new Nd(D,y.options)}}const J_={generateTopUV:function(De,y,b,D,Y){const _e=y[3*b],Le=y[3*b+1],qe=y[3*D],it=y[3*D+1],nt=y[3*Y],mt=y[3*Y+1];return[new en(_e,Le),new en(qe,it),new en(nt,mt)]},generateSideWallUV:function(De,y,b,D,Y,_e){const Le=y[3*b],qe=y[3*b+1],it=y[3*b+2],nt=y[3*D],mt=y[3*D+1],bt=y[3*D+2],At=y[3*Y],wt=y[3*Y+1],Et=y[3*Y+2],Mt=y[3*_e],St=y[3*_e+1],Nt=y[3*_e+2];return Math.abs(qe-mt)<Math.abs(Le-nt)?[new en(Le,1-it),new en(nt,1-bt),new en(At,1-Et),new en(Mt,1-Nt)]:[new en(qe,1-it),new en(mt,1-bt),new en(wt,1-Et),new en(St,1-Nt)]}};class kd extends Ca{constructor(y=1,b=0){const D=(1+Math.sqrt(5))/2;super([-1,D,0,1,D,0,-1,-D,0,1,-D,0,0,-1,D,0,1,D,0,-1,-D,0,1,-D,D,0,-1,D,0,1,-D,0,-1,-D,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],y,b),this.type="IcosahedronGeometry",this.parameters={radius:y,detail:b}}static fromJSON(y){return new kd(y.radius,y.detail)}}class cu extends Ca{constructor(y=1,b=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],y,b),this.type="OctahedronGeometry",this.parameters={radius:y,detail:b}}static fromJSON(y){return new cu(y.radius,y.detail)}}class Ud extends dr{constructor(y=.5,b=1,D=32,Y=1,_e=0,Le=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:y,outerRadius:b,thetaSegments:D,phiSegments:Y,thetaStart:_e,thetaLength:Le},D=Math.max(3,D);const qe=[],it=[],nt=[],mt=[];let bt=y;const At=(b-y)/(Y=Math.max(1,Y)),wt=new ii,Et=new en;for(let Mt=0;Mt<=Y;Mt++){for(let St=0;St<=D;St++){const Nt=_e+St/D*Le;wt.x=bt*Math.cos(Nt),wt.y=bt*Math.sin(Nt),it.push(wt.x,wt.y,wt.z),nt.push(0,0,1),Et.x=(wt.x/b+1)/2,Et.y=(wt.y/b+1)/2,mt.push(Et.x,Et.y)}bt+=At}for(let Mt=0;Mt<Y;Mt++){const St=Mt*(D+1);for(let Nt=0;Nt<D;Nt++){const It=Nt+St,Rt=It,Yt=It+D+1,Kt=It+D+2,Xt=It+1;qe.push(Rt,Yt,Xt),qe.push(Yt,Kt,Xt)}}this.setIndex(qe),this.setAttribute("position",new Cn(it,3)),this.setAttribute("normal",new Cn(nt,3)),this.setAttribute("uv",new Cn(mt,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new Ud(y.innerRadius,y.outerRadius,y.thetaSegments,y.phiSegments,y.thetaStart,y.thetaLength)}}class Fd extends dr{constructor(y=new el([new en(0,.5),new en(-.5,-.5),new en(.5,-.5)]),b=12){super(),this.type="ShapeGeometry",this.parameters={shapes:y,curveSegments:b};const D=[],Y=[],_e=[],Le=[];let qe=0,it=0;if(Array.isArray(y)===!1)nt(y);else for(let mt=0;mt<y.length;mt++)nt(y[mt]),this.addGroup(qe,it,mt),qe+=it,it=0;function nt(mt){const bt=Y.length/3,At=mt.extractPoints(b);let wt=At.shape;const Et=At.holes;Cs.isClockWise(wt)===!1&&(wt=wt.reverse());for(let St=0,Nt=Et.length;St<Nt;St++){const It=Et[St];Cs.isClockWise(It)===!0&&(Et[St]=It.reverse())}const Mt=Cs.triangulateShape(wt,Et);for(let St=0,Nt=Et.length;St<Nt;St++){const It=Et[St];wt=wt.concat(It)}for(let St=0,Nt=wt.length;St<Nt;St++){const It=wt[St];Y.push(It.x,It.y,0),_e.push(0,0,1),Le.push(It.x,It.y)}for(let St=0,Nt=Mt.length;St<Nt;St++){const It=Mt[St],Rt=It[0]+bt,Yt=It[1]+bt,Kt=It[2]+bt;D.push(Rt,Yt,Kt),it+=3}}this.setIndex(D),this.setAttribute("position",new Cn(Y,3)),this.setAttribute("normal",new Cn(_e,3)),this.setAttribute("uv",new Cn(Le,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}toJSON(){const y=super.toJSON();return function(b,D){if(D.shapes=[],Array.isArray(b))for(let Y=0,_e=b.length;Y<_e;Y++){const Le=b[Y];D.shapes.push(Le.uuid)}else D.shapes.push(b.uuid);return D}(this.parameters.shapes,y)}static fromJSON(y,b){const D=[];for(let Y=0,_e=y.shapes.length;Y<_e;Y++){const Le=b[y.shapes[Y]];D.push(Le)}return new Fd(D,y.curveSegments)}}class uu extends dr{constructor(y=1,b=32,D=16,Y=0,_e=2*Math.PI,Le=0,qe=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:y,widthSegments:b,heightSegments:D,phiStart:Y,phiLength:_e,thetaStart:Le,thetaLength:qe},b=Math.max(3,Math.floor(b)),D=Math.max(2,Math.floor(D));const it=Math.min(Le+qe,Math.PI);let nt=0;const mt=[],bt=new ii,At=new ii,wt=[],Et=[],Mt=[],St=[];for(let Nt=0;Nt<=D;Nt++){const It=[],Rt=Nt/D;let Yt=0;Nt===0&&Le===0?Yt=.5/b:Nt===D&&it===Math.PI&&(Yt=-.5/b);for(let Kt=0;Kt<=b;Kt++){const Xt=Kt/b;bt.x=-y*Math.cos(Y+Xt*_e)*Math.sin(Le+Rt*qe),bt.y=y*Math.cos(Le+Rt*qe),bt.z=y*Math.sin(Y+Xt*_e)*Math.sin(Le+Rt*qe),Et.push(bt.x,bt.y,bt.z),At.copy(bt).normalize(),Mt.push(At.x,At.y,At.z),St.push(Xt+Yt,1-Rt),It.push(nt++)}mt.push(It)}for(let Nt=0;Nt<D;Nt++)for(let It=0;It<b;It++){const Rt=mt[Nt][It+1],Yt=mt[Nt][It],Kt=mt[Nt+1][It],Xt=mt[Nt+1][It+1];(Nt!==0||Le>0)&&wt.push(Rt,Yt,Xt),(Nt!==D-1||it<Math.PI)&&wt.push(Yt,Kt,Xt)}this.setIndex(wt),this.setAttribute("position",new Cn(Et,3)),this.setAttribute("normal",new Cn(Mt,3)),this.setAttribute("uv",new Cn(St,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new uu(y.radius,y.widthSegments,y.heightSegments,y.phiStart,y.phiLength,y.thetaStart,y.thetaLength)}}class jd extends Ca{constructor(y=1,b=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],y,b),this.type="TetrahedronGeometry",this.parameters={radius:y,detail:b}}static fromJSON(y){return new jd(y.radius,y.detail)}}class Gd extends dr{constructor(y=1,b=.4,D=12,Y=48,_e=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:y,tube:b,radialSegments:D,tubularSegments:Y,arc:_e},D=Math.floor(D),Y=Math.floor(Y);const Le=[],qe=[],it=[],nt=[],mt=new ii,bt=new ii,At=new ii;for(let wt=0;wt<=D;wt++)for(let Et=0;Et<=Y;Et++){const Mt=Et/Y*_e,St=wt/D*Math.PI*2;bt.x=(y+b*Math.cos(St))*Math.cos(Mt),bt.y=(y+b*Math.cos(St))*Math.sin(Mt),bt.z=b*Math.sin(St),qe.push(bt.x,bt.y,bt.z),mt.x=y*Math.cos(Mt),mt.y=y*Math.sin(Mt),At.subVectors(bt,mt).normalize(),it.push(At.x,At.y,At.z),nt.push(Et/Y),nt.push(wt/D)}for(let wt=1;wt<=D;wt++)for(let Et=1;Et<=Y;Et++){const Mt=(Y+1)*wt+Et-1,St=(Y+1)*(wt-1)+Et-1,Nt=(Y+1)*(wt-1)+Et,It=(Y+1)*wt+Et;Le.push(Mt,St,It),Le.push(St,Nt,It)}this.setIndex(Le),this.setAttribute("position",new Cn(qe,3)),this.setAttribute("normal",new Cn(it,3)),this.setAttribute("uv",new Cn(nt,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new Gd(y.radius,y.tube,y.radialSegments,y.tubularSegments,y.arc)}}class zd extends dr{constructor(y=1,b=.4,D=64,Y=8,_e=2,Le=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:y,tube:b,tubularSegments:D,radialSegments:Y,p:_e,q:Le},D=Math.floor(D),Y=Math.floor(Y);const qe=[],it=[],nt=[],mt=[],bt=new ii,At=new ii,wt=new ii,Et=new ii,Mt=new ii,St=new ii,Nt=new ii;for(let Rt=0;Rt<=D;++Rt){const Yt=Rt/D*_e*Math.PI*2;It(Yt,_e,Le,y,wt),It(Yt+.01,_e,Le,y,Et),St.subVectors(Et,wt),Nt.addVectors(Et,wt),Mt.crossVectors(St,Nt),Nt.crossVectors(Mt,St),Mt.normalize(),Nt.normalize();for(let Kt=0;Kt<=Y;++Kt){const Xt=Kt/Y*Math.PI*2,oi=-b*Math.cos(Xt),wi=b*Math.sin(Xt);bt.x=wt.x+(oi*Nt.x+wi*Mt.x),bt.y=wt.y+(oi*Nt.y+wi*Mt.y),bt.z=wt.z+(oi*Nt.z+wi*Mt.z),it.push(bt.x,bt.y,bt.z),At.subVectors(bt,wt).normalize(),nt.push(At.x,At.y,At.z),mt.push(Rt/D),mt.push(Kt/Y)}}for(let Rt=1;Rt<=D;Rt++)for(let Yt=1;Yt<=Y;Yt++){const Kt=(Y+1)*(Rt-1)+(Yt-1),Xt=(Y+1)*Rt+(Yt-1),oi=(Y+1)*Rt+Yt,wi=(Y+1)*(Rt-1)+Yt;qe.push(Kt,Xt,wi),qe.push(Xt,oi,wi)}function It(Rt,Yt,Kt,Xt,oi){const wi=Math.cos(Rt),fi=Math.sin(Rt),yi=Kt/Yt*Rt,bi=Math.cos(yi);oi.x=Xt*(2+bi)*.5*wi,oi.y=Xt*(2+bi)*fi*.5,oi.z=Xt*Math.sin(yi)*.5}this.setIndex(qe),this.setAttribute("position",new Cn(it,3)),this.setAttribute("normal",new Cn(nt,3)),this.setAttribute("uv",new Cn(mt,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}static fromJSON(y){return new zd(y.radius,y.tube,y.tubularSegments,y.radialSegments,y.p,y.q)}}class Vd extends dr{constructor(y=new Hh(new ii(-1,-1,0),new ii(-1,1,0),new ii(1,1,0)),b=64,D=1,Y=8,_e=!1){super(),this.type="TubeGeometry",this.parameters={path:y,tubularSegments:b,radius:D,radialSegments:Y,closed:_e};const Le=y.computeFrenetFrames(b,_e);this.tangents=Le.tangents,this.normals=Le.normals,this.binormals=Le.binormals;const qe=new ii,it=new ii,nt=new en;let mt=new ii;const bt=[],At=[],wt=[],Et=[];function Mt(St){mt=y.getPointAt(St/b,mt);const Nt=Le.normals[St],It=Le.binormals[St];for(let Rt=0;Rt<=Y;Rt++){const Yt=Rt/Y*Math.PI*2,Kt=Math.sin(Yt),Xt=-Math.cos(Yt);it.x=Xt*Nt.x+Kt*It.x,it.y=Xt*Nt.y+Kt*It.y,it.z=Xt*Nt.z+Kt*It.z,it.normalize(),At.push(it.x,it.y,it.z),qe.x=mt.x+D*it.x,qe.y=mt.y+D*it.y,qe.z=mt.z+D*it.z,bt.push(qe.x,qe.y,qe.z)}}(function(){for(let St=0;St<b;St++)Mt(St);Mt(_e===!1?b:0),function(){for(let St=0;St<=b;St++)for(let Nt=0;Nt<=Y;Nt++)nt.x=St/b,nt.y=Nt/Y,wt.push(nt.x,nt.y)}(),function(){for(let St=1;St<=b;St++)for(let Nt=1;Nt<=Y;Nt++){const It=(Y+1)*(St-1)+(Nt-1),Rt=(Y+1)*St+(Nt-1),Yt=(Y+1)*St+Nt,Kt=(Y+1)*(St-1)+Nt;Et.push(It,Rt,Kt),Et.push(Rt,Yt,Kt)}}()})(),this.setIndex(Et),this.setAttribute("position",new Cn(bt,3)),this.setAttribute("normal",new Cn(At,3)),this.setAttribute("uv",new Cn(wt,2))}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}toJSON(){const y=super.toJSON();return y.path=this.parameters.path.toJSON(),y}static fromJSON(y){return new Vd(new Sd[y.path.type]().fromJSON(y.path),y.tubularSegments,y.radius,y.radialSegments,y.closed)}}class Gm extends dr{constructor(y=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:y},y!==null){const b=[],D=new Set,Y=new ii,_e=new ii;if(y.index!==null){const Le=y.attributes.position,qe=y.index;let it=y.groups;it.length===0&&(it=[{start:0,count:qe.count,materialIndex:0}]);for(let nt=0,mt=it.length;nt<mt;++nt){const bt=it[nt],At=bt.start;for(let wt=At,Et=At+bt.count;wt<Et;wt+=3)for(let Mt=0;Mt<3;Mt++){const St=qe.getX(wt+Mt),Nt=qe.getX(wt+(Mt+1)%3);Y.fromBufferAttribute(Le,St),_e.fromBufferAttribute(Le,Nt),zm(Y,_e,D)===!0&&(b.push(Y.x,Y.y,Y.z),b.push(_e.x,_e.y,_e.z))}}}else{const Le=y.attributes.position;for(let qe=0,it=Le.count/3;qe<it;qe++)for(let nt=0;nt<3;nt++){const mt=3*qe+nt,bt=3*qe+(nt+1)%3;Y.fromBufferAttribute(Le,mt),_e.fromBufferAttribute(Le,bt),zm(Y,_e,D)===!0&&(b.push(Y.x,Y.y,Y.z),b.push(_e.x,_e.y,_e.z))}}this.setAttribute("position",new Cn(b,3))}}copy(y){return super.copy(y),this.parameters=Object.assign({},y.parameters),this}}function zm(De,y,b){const D=`${De.x},${De.y},${De.z}-${y.x},${y.y},${y.z}`,Y=`${y.x},${y.y},${y.z}-${De.x},${De.y},${De.z}`;return b.has(D)!==!0&&b.has(Y)!==!0&&(b.add(D),b.add(Y),!0)}var Vm=Object.freeze({__proto__:null,BoxGeometry:Ea,CapsuleGeometry:Td,CircleGeometry:Cd,ConeGeometry:Md,CylinderGeometry:oc,DodecahedronGeometry:Pd,EdgesGeometry:Om,ExtrudeGeometry:Nd,IcosahedronGeometry:kd,LatheGeometry:ou,OctahedronGeometry:cu,PlaneGeometry:Yc,PolyhedronGeometry:Ca,RingGeometry:Ud,ShapeGeometry:Fd,SphereGeometry:uu,TetrahedronGeometry:jd,TorusGeometry:Gd,TorusKnotGeometry:zd,TubeGeometry:Vd,WireframeGeometry:Gm});class Hm extends no{constructor(y){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new Dn(0),this.transparent=!0,this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.color.copy(y.color),this.fog=y.fog,this}}class Qm extends hs{constructor(y){super(y),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class Yh extends no{constructor(y){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Dn(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Dn(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Yo,this.normalScale=new en(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.defines={STANDARD:""},this.color.copy(y.color),this.roughness=y.roughness,this.metalness=y.metalness,this.map=y.map,this.lightMap=y.lightMap,this.lightMapIntensity=y.lightMapIntensity,this.aoMap=y.aoMap,this.aoMapIntensity=y.aoMapIntensity,this.emissive.copy(y.emissive),this.emissiveMap=y.emissiveMap,this.emissiveIntensity=y.emissiveIntensity,this.bumpMap=y.bumpMap,this.bumpScale=y.bumpScale,this.normalMap=y.normalMap,this.normalMapType=y.normalMapType,this.normalScale.copy(y.normalScale),this.displacementMap=y.displacementMap,this.displacementScale=y.displacementScale,this.displacementBias=y.displacementBias,this.roughnessMap=y.roughnessMap,this.metalnessMap=y.metalnessMap,this.alphaMap=y.alphaMap,this.envMap=y.envMap,this.envMapIntensity=y.envMapIntensity,this.wireframe=y.wireframe,this.wireframeLinewidth=y.wireframeLinewidth,this.wireframeLinecap=y.wireframeLinecap,this.wireframeLinejoin=y.wireframeLinejoin,this.flatShading=y.flatShading,this.fog=y.fog,this}}class Wm extends Yh{constructor(y){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new en(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return Ur(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(b){this.ior=(1+.4*b)/(1-.4*b)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new Dn(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new Dn(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new Dn(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(y)}get anisotropy(){return this._anisotropy}set anisotropy(y){this._anisotropy>0!=y>0&&this.version++,this._anisotropy=y}get clearcoat(){return this._clearcoat}set clearcoat(y){this._clearcoat>0!=y>0&&this.version++,this._clearcoat=y}get iridescence(){return this._iridescence}set iridescence(y){this._iridescence>0!=y>0&&this.version++,this._iridescence=y}get sheen(){return this._sheen}set sheen(y){this._sheen>0!=y>0&&this.version++,this._sheen=y}get transmission(){return this._transmission}set transmission(y){this._transmission>0!=y>0&&this.version++,this._transmission=y}copy(y){return super.copy(y),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=y.anisotropy,this.anisotropyRotation=y.anisotropyRotation,this.anisotropyMap=y.anisotropyMap,this.clearcoat=y.clearcoat,this.clearcoatMap=y.clearcoatMap,this.clearcoatRoughness=y.clearcoatRoughness,this.clearcoatRoughnessMap=y.clearcoatRoughnessMap,this.clearcoatNormalMap=y.clearcoatNormalMap,this.clearcoatNormalScale.copy(y.clearcoatNormalScale),this.ior=y.ior,this.iridescence=y.iridescence,this.iridescenceMap=y.iridescenceMap,this.iridescenceIOR=y.iridescenceIOR,this.iridescenceThicknessRange=[...y.iridescenceThicknessRange],this.iridescenceThicknessMap=y.iridescenceThicknessMap,this.sheen=y.sheen,this.sheenColor.copy(y.sheenColor),this.sheenColorMap=y.sheenColorMap,this.sheenRoughness=y.sheenRoughness,this.sheenRoughnessMap=y.sheenRoughnessMap,this.transmission=y.transmission,this.transmissionMap=y.transmissionMap,this.thickness=y.thickness,this.thicknessMap=y.thicknessMap,this.attenuationDistance=y.attenuationDistance,this.attenuationColor.copy(y.attenuationColor),this.specularIntensity=y.specularIntensity,this.specularIntensityMap=y.specularIntensityMap,this.specularColor.copy(y.specularColor),this.specularColorMap=y.specularColorMap,this}}class qm extends no{constructor(y){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Dn(16777215),this.specular=new Dn(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Dn(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Yo,this.normalScale=new en(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Ln,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.color.copy(y.color),this.specular.copy(y.specular),this.shininess=y.shininess,this.map=y.map,this.lightMap=y.lightMap,this.lightMapIntensity=y.lightMapIntensity,this.aoMap=y.aoMap,this.aoMapIntensity=y.aoMapIntensity,this.emissive.copy(y.emissive),this.emissiveMap=y.emissiveMap,this.emissiveIntensity=y.emissiveIntensity,this.bumpMap=y.bumpMap,this.bumpScale=y.bumpScale,this.normalMap=y.normalMap,this.normalMapType=y.normalMapType,this.normalScale.copy(y.normalScale),this.displacementMap=y.displacementMap,this.displacementScale=y.displacementScale,this.displacementBias=y.displacementBias,this.specularMap=y.specularMap,this.alphaMap=y.alphaMap,this.envMap=y.envMap,this.combine=y.combine,this.reflectivity=y.reflectivity,this.refractionRatio=y.refractionRatio,this.wireframe=y.wireframe,this.wireframeLinewidth=y.wireframeLinewidth,this.wireframeLinecap=y.wireframeLinecap,this.wireframeLinejoin=y.wireframeLinejoin,this.flatShading=y.flatShading,this.fog=y.fog,this}}class Xm extends no{constructor(y){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Dn(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Dn(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Yo,this.normalScale=new en(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.color.copy(y.color),this.map=y.map,this.gradientMap=y.gradientMap,this.lightMap=y.lightMap,this.lightMapIntensity=y.lightMapIntensity,this.aoMap=y.aoMap,this.aoMapIntensity=y.aoMapIntensity,this.emissive.copy(y.emissive),this.emissiveMap=y.emissiveMap,this.emissiveIntensity=y.emissiveIntensity,this.bumpMap=y.bumpMap,this.bumpScale=y.bumpScale,this.normalMap=y.normalMap,this.normalMapType=y.normalMapType,this.normalScale.copy(y.normalScale),this.displacementMap=y.displacementMap,this.displacementScale=y.displacementScale,this.displacementBias=y.displacementBias,this.alphaMap=y.alphaMap,this.wireframe=y.wireframe,this.wireframeLinewidth=y.wireframeLinewidth,this.wireframeLinecap=y.wireframeLinecap,this.wireframeLinejoin=y.wireframeLinejoin,this.fog=y.fog,this}}class Ym extends no{constructor(y){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Yo,this.normalScale=new en(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(y)}copy(y){return super.copy(y),this.bumpMap=y.bumpMap,this.bumpScale=y.bumpScale,this.normalMap=y.normalMap,this.normalMapType=y.normalMapType,this.normalScale.copy(y.normalScale),this.displacementMap=y.displacementMap,this.displacementScale=y.displacementScale,this.displacementBias=y.displacementBias,this.wireframe=y.wireframe,this.wireframeLinewidth=y.wireframeLinewidth,this.flatShading=y.flatShading,this}}class Km extends no{constructor(y){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new Dn(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Dn(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Yo,this.normalScale=new en(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Ln,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.color.copy(y.color),this.map=y.map,this.lightMap=y.lightMap,this.lightMapIntensity=y.lightMapIntensity,this.aoMap=y.aoMap,this.aoMapIntensity=y.aoMapIntensity,this.emissive.copy(y.emissive),this.emissiveMap=y.emissiveMap,this.emissiveIntensity=y.emissiveIntensity,this.bumpMap=y.bumpMap,this.bumpScale=y.bumpScale,this.normalMap=y.normalMap,this.normalMapType=y.normalMapType,this.normalScale.copy(y.normalScale),this.displacementMap=y.displacementMap,this.displacementScale=y.displacementScale,this.displacementBias=y.displacementBias,this.specularMap=y.specularMap,this.alphaMap=y.alphaMap,this.envMap=y.envMap,this.combine=y.combine,this.reflectivity=y.reflectivity,this.refractionRatio=y.refractionRatio,this.wireframe=y.wireframe,this.wireframeLinewidth=y.wireframeLinewidth,this.wireframeLinecap=y.wireframeLinecap,this.wireframeLinejoin=y.wireframeLinejoin,this.flatShading=y.flatShading,this.fog=y.fog,this}}class $m extends no{constructor(y){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Dn(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Yo,this.normalScale=new en(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(y)}copy(y){return super.copy(y),this.defines={MATCAP:""},this.color.copy(y.color),this.matcap=y.matcap,this.map=y.map,this.bumpMap=y.bumpMap,this.bumpScale=y.bumpScale,this.normalMap=y.normalMap,this.normalMapType=y.normalMapType,this.normalScale.copy(y.normalScale),this.displacementMap=y.displacementMap,this.displacementScale=y.displacementScale,this.displacementBias=y.displacementBias,this.alphaMap=y.alphaMap,this.flatShading=y.flatShading,this.fog=y.fog,this}}class Jm extends Io{constructor(y){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(y)}copy(y){return super.copy(y),this.scale=y.scale,this.dashSize=y.dashSize,this.gapSize=y.gapSize,this}}function il(De,y,b){return!De||!b&&De.constructor===y?De:typeof y.BYTES_PER_ELEMENT=="number"?new y(De):Array.prototype.slice.call(De)}function Zm(De){return ArrayBuffer.isView(De)&&!(De instanceof DataView)}function ef(De){const y=De.length,b=new Array(y);for(let D=0;D!==y;++D)b[D]=D;return b.sort(function(D,Y){return De[D]-De[Y]}),b}function Kh(De,y,b){const D=De.length,Y=new De.constructor(D);for(let _e=0,Le=0;Le!==D;++_e){const qe=b[_e]*y;for(let it=0;it!==y;++it)Y[Le++]=De[qe+it]}return Y}function $h(De,y,b,D){let Y=1,_e=De[0];for(;_e!==void 0&&_e[D]===void 0;)_e=De[Y++];if(_e===void 0)return;let Le=_e[D];if(Le!==void 0)if(Array.isArray(Le))do Le=_e[D],Le!==void 0&&(y.push(_e.time),b.push.apply(b,Le)),_e=De[Y++];while(_e!==void 0);else if(Le.toArray!==void 0)do Le=_e[D],Le!==void 0&&(y.push(_e.time),Le.toArray(b,b.length)),_e=De[Y++];while(_e!==void 0);else do Le=_e[D],Le!==void 0&&(y.push(_e.time),b.push(Le)),_e=De[Y++];while(_e!==void 0)}const Z_={convertArray:il,isTypedArray:Zm,getKeyframeOrder:ef,sortedArray:Kh,flattenJSON:$h,subclip:function(De,y,b,D,Y=30){const _e=De.clone();_e.name=y;const Le=[];for(let it=0;it<_e.tracks.length;++it){const nt=_e.tracks[it],mt=nt.getValueSize(),bt=[],At=[];for(let wt=0;wt<nt.times.length;++wt){const Et=nt.times[wt]*Y;if(!(Et<b||Et>=D)){bt.push(nt.times[wt]);for(let Mt=0;Mt<mt;++Mt)At.push(nt.values[wt*mt+Mt])}}bt.length!==0&&(nt.times=il(bt,nt.times.constructor),nt.values=il(At,nt.values.constructor),Le.push(nt))}_e.tracks=Le;let qe=1/0;for(let it=0;it<_e.tracks.length;++it)qe>_e.tracks[it].times[0]&&(qe=_e.tracks[it].times[0]);for(let it=0;it<_e.tracks.length;++it)_e.tracks[it].shift(-1*qe);return _e.resetDuration(),_e},makeClipAdditive:function(De,y=0,b=De,D=30){D<=0&&(D=30);const Y=b.tracks.length,_e=y/D;for(let Le=0;Le<Y;++Le){const qe=b.tracks[Le],it=qe.ValueTypeName;if(it==="bool"||it==="string")continue;const nt=De.tracks.find(function(Nt){return Nt.name===qe.name&&Nt.ValueTypeName===it});if(nt===void 0)continue;let mt=0;const bt=qe.getValueSize();qe.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(mt=bt/3);let At=0;const wt=nt.getValueSize();nt.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(At=wt/3);const Et=qe.times.length-1;let Mt;if(_e<=qe.times[0]){const Nt=mt,It=bt-mt;Mt=qe.values.slice(Nt,It)}else if(_e>=qe.times[Et]){const Nt=Et*bt+mt,It=Nt+bt-mt;Mt=qe.values.slice(Nt,It)}else{const Nt=qe.createInterpolant(),It=mt,Rt=bt-mt;Nt.evaluate(_e),Mt=Nt.resultBuffer.slice(It,Rt)}it==="quaternion"&&new Ao().fromArray(Mt).normalize().conjugate().toArray(Mt);const St=nt.times.length;for(let Nt=0;Nt<St;++Nt){const It=Nt*wt+At;if(it==="quaternion")Ao.multiplyQuaternionsFlat(nt.values,It,Mt,0,nt.values,It);else{const Rt=wt-2*At;for(let Yt=0;Yt<Rt;++Yt)nt.values[It+Yt]-=Mt[Yt]}}}return De.blendMode=xl,De}};class du{constructor(y,b,D,Y){this.parameterPositions=y,this._cachedIndex=0,this.resultBuffer=Y!==void 0?Y:new b.constructor(D),this.sampleValues=b,this.valueSize=D,this.settings=null,this.DefaultSettings_={}}evaluate(y){const b=this.parameterPositions;let D=this._cachedIndex,Y=b[D],_e=b[D-1];e:{t:{let Le;i:{n:if(!(y<Y)){for(let qe=D+2;;){if(Y===void 0){if(y<_e)break n;return D=b.length,this._cachedIndex=D,this.copySampleValue_(D-1)}if(D===qe)break;if(_e=Y,Y=b[++D],y<Y)break t}Le=b.length;break i}if(y>=_e)break e;{const qe=b[1];y<qe&&(D=2,_e=qe);for(let it=D-2;;){if(_e===void 0)return this._cachedIndex=0,this.copySampleValue_(0);if(D===it)break;if(Y=_e,_e=b[--D-1],y>=_e)break t}Le=D,D=0}}for(;D<Le;){const qe=D+Le>>>1;y<b[qe]?Le=qe:D=qe+1}if(Y=b[D],_e=b[D-1],_e===void 0)return this._cachedIndex=0,this.copySampleValue_(0);if(Y===void 0)return D=b.length,this._cachedIndex=D,this.copySampleValue_(D-1)}this._cachedIndex=D,this.intervalChanged_(D,_e,Y)}return this.interpolate_(D,_e,y,Y)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(y){const b=this.resultBuffer,D=this.sampleValues,Y=this.valueSize,_e=y*Y;for(let Le=0;Le!==Y;++Le)b[Le]=D[_e+Le];return b}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class tf extends du{constructor(y,b,D,Y){super(y,b,D,Y),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:Bs,endingEnd:Bs}}intervalChanged_(y,b,D){const Y=this.parameterPositions;let _e=y-2,Le=y+1,qe=Y[_e],it=Y[Le];if(qe===void 0)switch(this.getSettings_().endingStart){case Os:_e=y,qe=2*b-D;break;case La:_e=Y.length-2,qe=b+Y[_e]-Y[_e+1];break;default:_e=y,qe=D}if(it===void 0)switch(this.getSettings_().endingEnd){case Os:Le=y,it=2*D-b;break;case La:Le=1,it=D+Y[1]-Y[0];break;default:Le=y-1,it=b}const nt=.5*(D-b),mt=this.valueSize;this._weightPrev=nt/(b-qe),this._weightNext=nt/(it-D),this._offsetPrev=_e*mt,this._offsetNext=Le*mt}interpolate_(y,b,D,Y){const _e=this.resultBuffer,Le=this.sampleValues,qe=this.valueSize,it=y*qe,nt=it-qe,mt=this._offsetPrev,bt=this._offsetNext,At=this._weightPrev,wt=this._weightNext,Et=(D-b)/(Y-b),Mt=Et*Et,St=Mt*Et,Nt=-At*St+2*At*Mt-At*Et,It=(1+At)*St+(-1.5-2*At)*Mt+(-.5+At)*Et+1,Rt=(-1-wt)*St+(1.5+wt)*Mt+.5*Et,Yt=wt*St-wt*Mt;for(let Kt=0;Kt!==qe;++Kt)_e[Kt]=Nt*Le[mt+Kt]+It*Le[nt+Kt]+Rt*Le[it+Kt]+Yt*Le[bt+Kt];return _e}}class Jh extends du{constructor(y,b,D,Y){super(y,b,D,Y)}interpolate_(y,b,D,Y){const _e=this.resultBuffer,Le=this.sampleValues,qe=this.valueSize,it=y*qe,nt=it-qe,mt=(D-b)/(Y-b),bt=1-mt;for(let At=0;At!==qe;++At)_e[At]=Le[nt+At]*bt+Le[it+At]*mt;return _e}}class nf extends du{constructor(y,b,D,Y){super(y,b,D,Y)}interpolate_(y){return this.copySampleValue_(y-1)}}class ms{constructor(y,b,D,Y){if(y===void 0)throw new Error("THREE.KeyframeTrack: track name is undefined");if(b===void 0||b.length===0)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+y);this.name=y,this.times=il(b,this.TimeBufferType),this.values=il(D,this.ValueBufferType),this.setInterpolation(Y||this.DefaultInterpolation)}static toJSON(y){const b=y.constructor;let D;if(b.toJSON!==this.toJSON)D=b.toJSON(y);else{D={name:y.name,times:il(y.times,Array),values:il(y.values,Array)};const Y=y.getInterpolation();Y!==y.DefaultInterpolation&&(D.interpolation=Y)}return D.type=y.ValueTypeName,D}InterpolantFactoryMethodDiscrete(y){return new nf(this.times,this.values,this.getValueSize(),y)}InterpolantFactoryMethodLinear(y){return new Jh(this.times,this.values,this.getValueSize(),y)}InterpolantFactoryMethodSmooth(y){return new tf(this.times,this.values,this.getValueSize(),y)}setInterpolation(y){let b;switch(y){case ia:b=this.InterpolantFactoryMethodDiscrete;break;case Oa:b=this.InterpolantFactoryMethodLinear;break;case bl:b=this.InterpolantFactoryMethodSmooth}if(b===void 0){const D="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(this.createInterpolant===void 0){if(y===this.DefaultInterpolation)throw new Error(D);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",D),this}return this.createInterpolant=b,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return ia;case this.InterpolantFactoryMethodLinear:return Oa;case this.InterpolantFactoryMethodSmooth:return bl}}getValueSize(){return this.values.length/this.times.length}shift(y){if(y!==0){const b=this.times;for(let D=0,Y=b.length;D!==Y;++D)b[D]+=y}return this}scale(y){if(y!==1){const b=this.times;for(let D=0,Y=b.length;D!==Y;++D)b[D]*=y}return this}trim(y,b){const D=this.times,Y=D.length;let _e=0,Le=Y-1;for(;_e!==Y&&D[_e]<y;)++_e;for(;Le!==-1&&D[Le]>b;)--Le;if(++Le,_e!==0||Le!==Y){_e>=Le&&(Le=Math.max(Le,1),_e=Le-1);const qe=this.getValueSize();this.times=D.slice(_e,Le),this.values=this.values.slice(_e*qe,Le*qe)}return this}validate(){let y=!0;const b=this.getValueSize();b-Math.floor(b)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),y=!1);const D=this.times,Y=this.values,_e=D.length;_e===0&&(console.error("THREE.KeyframeTrack: Track is empty.",this),y=!1);let Le=null;for(let qe=0;qe!==_e;qe++){const it=D[qe];if(typeof it=="number"&&isNaN(it)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,qe,it),y=!1;break}if(Le!==null&&Le>it){console.error("THREE.KeyframeTrack: Out of order keys.",this,qe,it,Le),y=!1;break}Le=it}if(Y!==void 0&&Zm(Y))for(let qe=0,it=Y.length;qe!==it;++qe){const nt=Y[qe];if(isNaN(nt)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,qe,nt),y=!1;break}}return y}optimize(){const y=this.times.slice(),b=this.values.slice(),D=this.getValueSize(),Y=this.getInterpolation()===bl,_e=y.length-1;let Le=1;for(let qe=1;qe<_e;++qe){let it=!1;const nt=y[qe];if(nt!==y[qe+1]&&(qe!==1||nt!==y[0]))if(Y)it=!0;else{const mt=qe*D,bt=mt-D,At=mt+D;for(let wt=0;wt!==D;++wt){const Et=b[mt+wt];if(Et!==b[bt+wt]||Et!==b[At+wt]){it=!0;break}}}if(it){if(qe!==Le){y[Le]=y[qe];const mt=qe*D,bt=Le*D;for(let At=0;At!==D;++At)b[bt+At]=b[mt+At]}++Le}}if(_e>0){y[Le]=y[_e];for(let qe=_e*D,it=Le*D,nt=0;nt!==D;++nt)b[it+nt]=b[qe+nt];++Le}return Le!==y.length?(this.times=y.slice(0,Le),this.values=b.slice(0,Le*D)):(this.times=y,this.values=b),this}clone(){const y=this.times.slice(),b=this.values.slice(),D=new this.constructor(this.name,y,b);return D.createInterpolant=this.createInterpolant,D}}ms.prototype.TimeBufferType=Float32Array,ms.prototype.ValueBufferType=Float32Array,ms.prototype.DefaultInterpolation=Oa;class nl extends ms{}nl.prototype.ValueTypeName="bool",nl.prototype.ValueBufferType=Array,nl.prototype.DefaultInterpolation=ia,nl.prototype.InterpolantFactoryMethodLinear=void 0,nl.prototype.InterpolantFactoryMethodSmooth=void 0;class Zh extends ms{}Zh.prototype.ValueTypeName="color";class hu extends ms{}hu.prototype.ValueTypeName="number";class rf extends du{constructor(y,b,D,Y){super(y,b,D,Y)}interpolate_(y,b,D,Y){const _e=this.resultBuffer,Le=this.sampleValues,qe=this.valueSize,it=(D-b)/(Y-b);let nt=y*qe;for(let mt=nt+qe;nt!==mt;nt+=4)Ao.slerpFlat(_e,0,Le,nt-qe,Le,nt,it);return _e}}class ac extends ms{InterpolantFactoryMethodLinear(y){return new rf(this.times,this.values,this.getValueSize(),y)}}ac.prototype.ValueTypeName="quaternion",ac.prototype.DefaultInterpolation=Oa,ac.prototype.InterpolantFactoryMethodSmooth=void 0;class rl extends ms{}rl.prototype.ValueTypeName="string",rl.prototype.ValueBufferType=Array,rl.prototype.DefaultInterpolation=ia,rl.prototype.InterpolantFactoryMethodLinear=void 0,rl.prototype.InterpolantFactoryMethodSmooth=void 0;class pu extends ms{}pu.prototype.ValueTypeName="vector";class mu{constructor(y,b=-1,D,Y=bc){this.name=y,this.tracks=D,this.duration=b,this.blendMode=Y,this.uuid=vo(),this.duration<0&&this.resetDuration()}static parse(y){const b=[],D=y.tracks,Y=1/(y.fps||1);for(let Le=0,qe=D.length;Le!==qe;++Le)b.push(ev(D[Le]).scale(Y));const _e=new this(y.name,y.duration,b,y.blendMode);return _e.uuid=y.uuid,_e}static toJSON(y){const b=[],D=y.tracks,Y={name:y.name,duration:y.duration,tracks:b,uuid:y.uuid,blendMode:y.blendMode};for(let _e=0,Le=D.length;_e!==Le;++_e)b.push(ms.toJSON(D[_e]));return Y}static CreateFromMorphTargetSequence(y,b,D,Y){const _e=b.length,Le=[];for(let qe=0;qe<_e;qe++){let it=[],nt=[];it.push((qe+_e-1)%_e,qe,(qe+1)%_e),nt.push(0,1,0);const mt=ef(it);it=Kh(it,1,mt),nt=Kh(nt,1,mt),Y||it[0]!==0||(it.push(_e),nt.push(nt[0])),Le.push(new hu(".morphTargetInfluences["+b[qe].name+"]",it,nt).scale(1/D))}return new this(y,-1,Le)}static findByName(y,b){let D=y;if(!Array.isArray(y)){const Y=y;D=Y.geometry&&Y.geometry.animations||Y.animations}for(let Y=0;Y<D.length;Y++)if(D[Y].name===b)return D[Y];return null}static CreateClipsFromMorphTargetSequences(y,b,D){const Y={},_e=/^([\w-]*?)([\d]+)$/;for(let qe=0,it=y.length;qe<it;qe++){const nt=y[qe],mt=nt.name.match(_e);if(mt&&mt.length>1){const bt=mt[1];let At=Y[bt];At||(Y[bt]=At=[]),At.push(nt)}}const Le=[];for(const qe in Y)Le.push(this.CreateFromMorphTargetSequence(qe,Y[qe],b,D));return Le}static parseAnimation(y,b){if(!y)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const D=function(mt,bt,At,wt,Et){if(At.length!==0){const Mt=[],St=[];$h(At,Mt,St,wt),Mt.length!==0&&Et.push(new mt(bt,Mt,St))}},Y=[],_e=y.name||"default",Le=y.fps||30,qe=y.blendMode;let it=y.length||-1;const nt=y.hierarchy||[];for(let mt=0;mt<nt.length;mt++){const bt=nt[mt].keys;if(bt&&bt.length!==0)if(bt[0].morphTargets){const At={};let wt;for(wt=0;wt<bt.length;wt++)if(bt[wt].morphTargets)for(let Et=0;Et<bt[wt].morphTargets.length;Et++)At[bt[wt].morphTargets[Et]]=-1;for(const Et in At){const Mt=[],St=[];for(let Nt=0;Nt!==bt[wt].morphTargets.length;++Nt){const It=bt[wt];Mt.push(It.time),St.push(It.morphTarget===Et?1:0)}Y.push(new hu(".morphTargetInfluence["+Et+"]",Mt,St))}it=At.length*Le}else{const At=".bones["+b[mt].name+"]";D(pu,At+".position",bt,"pos",Y),D(ac,At+".quaternion",bt,"rot",Y),D(pu,At+".scale",bt,"scl",Y)}}return Y.length===0?null:new this(_e,it,Y,qe)}resetDuration(){let y=0;for(let b=0,D=this.tracks.length;b!==D;++b){const Y=this.tracks[b];y=Math.max(y,Y.times[Y.times.length-1])}return this.duration=y,this}trim(){for(let y=0;y<this.tracks.length;y++)this.tracks[y].trim(0,this.duration);return this}validate(){let y=!0;for(let b=0;b<this.tracks.length;b++)y=y&&this.tracks[b].validate();return y}optimize(){for(let y=0;y<this.tracks.length;y++)this.tracks[y].optimize();return this}clone(){const y=[];for(let b=0;b<this.tracks.length;b++)y.push(this.tracks[b].clone());return new this.constructor(this.name,this.duration,y,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function ev(De){if(De.type===void 0)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const y=function(b){switch(b.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return hu;case"vector":case"vector2":case"vector3":case"vector4":return pu;case"color":return Zh;case"quaternion":return ac;case"bool":case"boolean":return nl;case"string":return rl}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+b)}(De.type);if(De.times===void 0){const b=[],D=[];$h(De.keys,b,D,"value"),De.times=b,De.values=D}return y.parse!==void 0?y.parse(De):new y(De.name,De.times,De.values,De.interpolation)}const qs={enabled:!1,files:{},add:function(De,y){this.enabled!==!1&&(this.files[De]=y)},get:function(De,y){return this.enabled===!1?y?Promise.resolve():void 0:y?Promise.resolve(this.files[De]):this.files[De]},remove:function(De){delete this.files[De]},clear:function(){this.files={}}};class ep{constructor(y,b,D){const Y=this;let _e,Le=!1,qe=0,it=0;const nt=[];this.onStart=void 0,this.onLoad=y,this.onProgress=b,this.onError=D,this.itemStart=function(mt){it++,Le===!1&&Y.onStart!==void 0&&Y.onStart(mt,qe,it),Le=!0},this.itemEnd=function(mt){qe++,Y.onProgress!==void 0&&Y.onProgress(mt,qe,it),qe===it&&(Le=!1,Y.onLoad!==void 0&&Y.onLoad())},this.itemError=function(mt){Y.onError!==void 0&&Y.onError(mt)},this.resolveURL=function(mt){return _e?_e(mt):mt},this.setURLModifier=function(mt){return _e=mt,this},this.addHandler=function(mt,bt){return nt.push(mt,bt),this},this.removeHandler=function(mt){const bt=nt.indexOf(mt);return bt!==-1&&nt.splice(bt,2),this},this.getHandler=function(mt){for(let bt=0,At=nt.length;bt<At;bt+=2){const wt=nt[bt],Et=nt[bt+1];if(wt.global&&(wt.lastIndex=0),wt.test(mt))return Et}return null}}}const of=new ep;class No{constructor(y){this.manager=y!==void 0?y:of,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(y,b){const D=this;return new Promise(function(Y,_e){D.load(y,Y,b,_e)})}parse(){}setCrossOrigin(y){return this.crossOrigin=y,this}setWithCredentials(y){return this.withCredentials=y,this}setPath(y){return this.path=y,this}setResourcePath(y){return this.resourcePath=y,this}setRequestHeader(y){return this.requestHeader=y,this}}No.DEFAULT_MATERIAL_NAME="__DEFAULT";const Xs={};class tv extends Error{constructor(y,b){super(y),this.response=b}}class Ms extends No{constructor(y){super(y),this.responseType="text",this.useCache=!0}load(y,b,D,Y){y===void 0&&(y=""),this.path!==void 0&&(y=this.path+y),y=this.manager.resolveURL(y),(this.useCache?qs.get(y,this.responseType,this.mimeType):Promise.resolve(void 0)).then(_e=>{if(_e!==void 0)return this.manager.itemStart(y),setTimeout(()=>{b&&b(_e),this.manager.itemEnd(y)},0),_e;if(Xs[y]!==void 0)return void Xs[y].push({onLoad:b,onProgress:D,onError:Y});Xs[y]=[],Xs[y].push({onLoad:b,onProgress:D,onError:Y});const Le=new Request(y,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),qe=this.mimeType,it=this.responseType;fetch(Le).then(nt=>{if(nt.status===200||nt.status===0){if(nt.status===0&&console.warn("THREE.FileLoader: HTTP Status 0 received."),typeof ReadableStream>"u"||nt.body===void 0||nt.body.getReader===void 0)return nt;const mt=Xs[y],bt=nt.body.getReader(),At=nt.headers.get("Content-Length")||nt.headers.get("X-File-Size"),wt=At?parseInt(At):0,Et=wt!==0;let Mt=0;const St=new ReadableStream({start(Nt){(function It(){bt.read().then(({done:Rt,value:Yt})=>{if(Rt)Nt.close();else{Mt+=Yt.byteLength;const Kt=new ProgressEvent("progress",{lengthComputable:Et,loaded:Mt,total:wt});for(let Xt=0,oi=mt.length;Xt<oi;Xt++){const wi=mt[Xt];wi.onProgress&&wi.onProgress(Kt)}Nt.enqueue(Yt),It()}})})()}});return new Response(St)}throw new tv(`fetch for "${nt.url}" responded with ${nt.status}: ${nt.statusText}`,nt)}).then(nt=>{switch(it){case"arraybuffer":return nt.arrayBuffer();case"blob":return nt.blob();case"document":return nt.text().then(mt=>new DOMParser().parseFromString(mt,qe));case"json":return nt.json();default:if(qe===void 0)return nt.text();{const mt=/charset="?([^;"\s]*)"?/i.exec(qe),bt=mt&&mt[1]?mt[1].toLowerCase():void 0,At=new TextDecoder(bt);return nt.arrayBuffer().then(wt=>At.decode(wt))}}}).then(nt=>{this.useCache&&qs.add(y,nt,this.responseType);const mt=Xs[y];delete Xs[y];for(let bt=0,At=mt.length;bt<At;bt++){const wt=mt[bt];wt.onLoad&&wt.onLoad(nt)}}).catch(nt=>{const mt=Xs[y];if(mt===void 0)throw this.manager.itemError(y),nt;delete Xs[y];for(let bt=0,At=mt.length;bt<At;bt++){const wt=mt[bt];wt.onError&&wt.onError(nt)}this.manager.itemError(y)}).finally(()=>{this.useCache&&this.manager.itemEnd(y)}),this.useCache&&this.manager.itemStart(y)})}setResponseType(y){return this.responseType=y,this}setMimeType(y){return this.mimeType=y,this}}class iv extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=this,Le=new Ms(this.manager);Le.setPath(this.path),Le.setRequestHeader(this.requestHeader),Le.setWithCredentials(this.withCredentials),Le.load(y,function(qe){try{b(_e.parse(JSON.parse(qe)))}catch(it){Y?Y(it):console.error(it),_e.manager.itemError(y)}},D,Y)}parse(y){const b=[];for(let D=0;D<y.length;D++){const Y=mu.parse(y[D]);b.push(Y)}return b}}class nv extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=this,Le=[],qe=new xd,it=new Ms(this.manager);it.setPath(this.path),it.setResponseType("arraybuffer"),it.setRequestHeader(this.requestHeader),it.setWithCredentials(_e.withCredentials);let nt=0;function mt(bt){it.load(y[bt],function(At){const wt=_e.parse(At,!0);Le[bt]={width:wt.width,height:wt.height,format:wt.format,mipmaps:wt.mipmaps},nt+=1,nt===6&&(wt.mipmapCount===1&&(qe.minFilter=fn),qe.image=Le,qe.format=wt.format,qe.needsUpdate=!0,b&&b(qe))},D,Y)}if(Array.isArray(y))for(let bt=0,At=y.length;bt<At;++bt)mt(bt);else it.load(y,function(bt){const At=_e.parse(bt,!0);if(At.isCubemap){const wt=At.mipmaps.length/At.mipmapCount;for(let Et=0;Et<wt;Et++){Le[Et]={mipmaps:[]};for(let Mt=0;Mt<At.mipmapCount;Mt++)Le[Et].mipmaps.push(At.mipmaps[Et*At.mipmapCount+Mt]),Le[Et].format=At.format,Le[Et].width=At.width,Le[Et].height=At.height}qe.image=Le}else qe.image.width=At.width,qe.image.height=At.height,qe.mipmaps=At.mipmaps;At.mipmapCount===1&&(qe.minFilter=fn),qe.format=At.format,qe.needsUpdate=!0,b&&b(qe)},D,Y);return qe}}class fu extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=y;this.path!==void 0&&(y=this.path+y),y=this.manager.resolveURL(y);const Le=this,qe=qs.get(y);if(qe!==void 0)return Le.manager.itemStart(y),setTimeout(function(){b&&b(qe),Le.manager.itemEnd(y)},0),qe;const it=Gs("img");function nt(){bt(),qs.add(y,this),b&&b(this),Le.manager.itemEnd(y)}function mt(At){bt(),Y&&Y(At),Le.manager.itemError(y),Le.manager.itemEnd(y)}function bt(){it.removeEventListener("load",nt,!1),it.removeEventListener("error",mt,!1)}return it.addEventListener("load",nt,!1),it.addEventListener("error",mt,!1),y.slice(0,5)!=="data:"&&this.crossOrigin!==void 0&&(it.crossOrigin=this.crossOrigin),Le.manager.itemStart(y),qs.get(y,"blob").then(At=>{if(At!==void 0&&!At.type.startsWith("text/plain"))return At.type||(y.endsWith(".svg")||y.startsWith("data:image/svg"))&&(At=new Blob([At],{type:"image/svg+xml"})),void(it.src=URL.createObjectURL(At));const wt=new Ms(this.manager);wt.useCache=!1,wt.setPath(this.path),wt.setCrossOrigin(this.crossOrigin),wt.setResponseType("blob"),wt.load(_e,function(Et){Et.type||(y.endsWith(".svg")||y.startsWith("data:image/svg"))&&(Et=new Blob([Et],{type:"image/svg+xml"})),qs.add(y,Et,"blob"),it.src=URL.createObjectURL(Et)},D,Et=>{bt(),Y&&Y(Et)})}),it}}class rv extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=new Xc;_e.colorSpace=Rr;const Le=new fu(this.manager);Le.setCrossOrigin(this.crossOrigin),Le.setPath(this.path);let qe=0;function it(nt){Le.load(y[nt],function(mt){_e.images[nt]=mt,qe++,qe===6&&(_e.needsUpdate=!0,b&&b(_e))},void 0,Y)}for(let nt=0;nt<y.length;++nt)it(nt);return _e}}class ov extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=this,Le=new ic,qe=new Ms(this.manager);return qe.setResponseType("arraybuffer"),qe.setRequestHeader(this.requestHeader),qe.setPath(this.path),qe.setWithCredentials(_e.withCredentials),qe.load(y,function(it){let nt;try{nt=_e.parse(it)}catch(mt){if(Y===void 0)return void console.error(mt);Y(mt)}nt.image!==void 0?Le.image=nt.image:nt.data!==void 0&&(Le.image.width=nt.width,Le.image.height=nt.height,Le.image.data=nt.data,Le.image.complete=!0),Le.wrapS=nt.wrapS!==void 0?nt.wrapS:an,Le.wrapT=nt.wrapT!==void 0?nt.wrapT:an,Le.magFilter=nt.magFilter!==void 0?nt.magFilter:fn,Le.minFilter=nt.minFilter!==void 0?nt.minFilter:fn,Le.anisotropy=nt.anisotropy!==void 0?nt.anisotropy:1,nt.colorSpace!==void 0?Le.colorSpace=nt.colorSpace:nt.encoding!==void 0&&(Le.encoding=nt.encoding),nt.flipY!==void 0&&(Le.flipY=nt.flipY),nt.format!==void 0&&(Le.format=nt.format),nt.type!==void 0&&(Le.type=nt.type),nt.mipmaps!==void 0&&(Le.mipmaps=nt.mipmaps,Le.minFilter=Zn),nt.mipmapCount===1&&(Le.minFilter=fn),nt.generateMipmaps!==void 0&&(Le.generateMipmaps=nt.generateMipmaps),Le.needsUpdate=!0,b&&b(Le,nt)},D,Y),Le}}class sv extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=new Or,Le=new fu(this.manager);return Le.setCrossOrigin(this.crossOrigin),Le.setPath(this.path),Le.load(y,function(qe){_e.image=qe,_e.needsUpdate=!0,b!==void 0&&b(_e)},D,Y),_e}}class Ma extends yr{constructor(y,b=1){super(),this.isLight=!0,this.type="Light",this.color=new Dn(y),this.intensity=b}dispose(){}copy(y,b){return super.copy(y,b),this.color.copy(y.color),this.intensity=y.intensity,this}toJSON(y){const b=super.toJSON(y);return b.object.color=this.color.getHex(),b.object.intensity=this.intensity,this.groundColor!==void 0&&(b.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(b.object.distance=this.distance),this.angle!==void 0&&(b.object.angle=this.angle),this.decay!==void 0&&(b.object.decay=this.decay),this.penumbra!==void 0&&(b.object.penumbra=this.penumbra),this.shadow!==void 0&&(b.object.shadow=this.shadow.toJSON()),b}}class sf extends Ma{constructor(y,b,D){super(y,D),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(yr.DEFAULT_UP),this.updateMatrix(),this.groundColor=new Dn(b)}copy(y,b){return super.copy(y,b),this.groundColor.copy(y.groundColor),this}}const tp=new Xn,af=new ii,lf=new ii;class ip{constructor(y){this.camera=y,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new en(512,512),this.map=null,this.mapPass=null,this.matrix=new Xn,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new nd,this._frameExtents=new en(1,1),this._viewportCount=1,this._viewports=[new Tr(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(y){const b=this.camera,D=this.matrix;af.setFromMatrixPosition(y.matrixWorld),b.position.copy(af),lf.setFromMatrixPosition(y.target.matrixWorld),b.lookAt(lf),b.updateMatrixWorld(),tp.multiplyMatrices(b.projectionMatrix,b.matrixWorldInverse),this._frustum.setFromProjectionMatrix(tp),D.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),D.multiply(tp)}getViewport(y){return this._viewports[y]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(y){return this.camera=y.camera.clone(),this.bias=y.bias,this.normalBias=y.normalBias,this.radius=y.radius,this.mapSize.copy(y.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){const y={};return this.bias!==0&&(y.bias=this.bias),this.normalBias!==0&&(y.normalBias=this.normalBias),this.radius!==1&&(y.radius=this.radius),this.mapSize.x===512&&this.mapSize.y===512||(y.mapSize=this.mapSize.toArray()),y.camera=this.camera.toJSON(!1).object,delete y.camera.matrix,y}}class av extends ip{constructor(){super(new _o(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(y){const b=this.camera,D=2*Fs*y.angle*this.focus,Y=this.mapSize.width/this.mapSize.height,_e=y.distance||b.far;D===b.fov&&Y===b.aspect&&_e===b.far||(b.fov=D,b.aspect=Y,b.far=_e,b.updateProjectionMatrix()),super.updateMatrices(y)}copy(y){return super.copy(y),this.focus=y.focus,this}}class cf extends Ma{constructor(y,b,D=0,Y=Math.PI/3,_e=0,Le=2){super(y,b),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(yr.DEFAULT_UP),this.updateMatrix(),this.target=new yr,this.distance=D,this.angle=Y,this.penumbra=_e,this.decay=Le,this.map=null,this.shadow=new av}get power(){return this.intensity*Math.PI}set power(y){this.intensity=y/Math.PI}dispose(){this.shadow.dispose()}copy(y,b){return super.copy(y,b),this.distance=y.distance,this.angle=y.angle,this.penumbra=y.penumbra,this.decay=y.decay,this.target=y.target.clone(),this.shadow=y.shadow.clone(),this}}const uf=new Xn,gu=new ii,np=new ii;class lv extends ip{constructor(){super(new _o(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new en(4,2),this._viewportCount=6,this._viewports=[new Tr(2,1,1,1),new Tr(0,1,1,1),new Tr(3,1,1,1),new Tr(1,1,1,1),new Tr(3,0,1,1),new Tr(1,0,1,1)],this._cubeDirections=[new ii(1,0,0),new ii(-1,0,0),new ii(0,0,1),new ii(0,0,-1),new ii(0,1,0),new ii(0,-1,0)],this._cubeUps=[new ii(0,1,0),new ii(0,1,0),new ii(0,1,0),new ii(0,1,0),new ii(0,0,1),new ii(0,0,-1)]}updateMatrices(y,b=0){const D=this.camera,Y=this.matrix,_e=y.distance||D.far;_e!==D.far&&(D.far=_e,D.updateProjectionMatrix()),gu.setFromMatrixPosition(y.matrixWorld),D.position.copy(gu),np.copy(D.position),np.add(this._cubeDirections[b]),D.up.copy(this._cubeUps[b]),D.lookAt(np),D.updateMatrixWorld(),Y.makeTranslation(-gu.x,-gu.y,-gu.z),uf.multiplyMatrices(D.projectionMatrix,D.matrixWorldInverse),this._frustum.setFromProjectionMatrix(uf)}}class df extends Ma{constructor(y,b,D=0,Y=2){super(y,b),this.isPointLight=!0,this.type="PointLight",this.distance=D,this.decay=Y,this.shadow=new lv}get power(){return 4*this.intensity*Math.PI}set power(y){this.intensity=y/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(y,b){return super.copy(y,b),this.distance=y.distance,this.decay=y.decay,this.shadow=y.shadow.clone(),this}}class cv extends ip{constructor(){super(new od(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class hf extends Ma{constructor(y,b){super(y,b),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(yr.DEFAULT_UP),this.updateMatrix(),this.target=new yr,this.shadow=new cv}dispose(){this.shadow.dispose()}copy(y){return super.copy(y),this.target=y.target.clone(),this.shadow=y.shadow.clone(),this}}class pf extends Ma{constructor(y,b){super(y,b),this.isAmbientLight=!0,this.type="AmbientLight"}}class mf extends Ma{constructor(y,b,D=10,Y=10){super(y,b),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=D,this.height=Y}get power(){return this.intensity*this.width*this.height*Math.PI}set power(y){this.intensity=y/(this.width*this.height*Math.PI)}copy(y){return super.copy(y),this.width=y.width,this.height=y.height,this}toJSON(y){const b=super.toJSON(y);return b.object.width=this.width,b.object.height=this.height,b}}class ff{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let y=0;y<9;y++)this.coefficients.push(new ii)}set(y){for(let b=0;b<9;b++)this.coefficients[b].copy(y[b]);return this}zero(){for(let y=0;y<9;y++)this.coefficients[y].set(0,0,0);return this}getAt(y,b){const D=y.x,Y=y.y,_e=y.z,Le=this.coefficients;return b.copy(Le[0]).multiplyScalar(.282095),b.addScaledVector(Le[1],.488603*Y),b.addScaledVector(Le[2],.488603*_e),b.addScaledVector(Le[3],.488603*D),b.addScaledVector(Le[4],D*Y*1.092548),b.addScaledVector(Le[5],Y*_e*1.092548),b.addScaledVector(Le[6],.315392*(3*_e*_e-1)),b.addScaledVector(Le[7],D*_e*1.092548),b.addScaledVector(Le[8],.546274*(D*D-Y*Y)),b}getIrradianceAt(y,b){const D=y.x,Y=y.y,_e=y.z,Le=this.coefficients;return b.copy(Le[0]).multiplyScalar(.886227),b.addScaledVector(Le[1],1.023328*Y),b.addScaledVector(Le[2],1.023328*_e),b.addScaledVector(Le[3],1.023328*D),b.addScaledVector(Le[4],.858086*D*Y),b.addScaledVector(Le[5],.858086*Y*_e),b.addScaledVector(Le[6],.743125*_e*_e-.247708),b.addScaledVector(Le[7],.858086*D*_e),b.addScaledVector(Le[8],.429043*(D*D-Y*Y)),b}add(y){for(let b=0;b<9;b++)this.coefficients[b].add(y.coefficients[b]);return this}addScaledSH(y,b){for(let D=0;D<9;D++)this.coefficients[D].addScaledVector(y.coefficients[D],b);return this}scale(y){for(let b=0;b<9;b++)this.coefficients[b].multiplyScalar(y);return this}lerp(y,b){for(let D=0;D<9;D++)this.coefficients[D].lerp(y.coefficients[D],b);return this}equals(y){for(let b=0;b<9;b++)if(!this.coefficients[b].equals(y.coefficients[b]))return!1;return!0}copy(y){return this.set(y.coefficients)}clone(){return new this.constructor().copy(this)}fromArray(y,b=0){const D=this.coefficients;for(let Y=0;Y<9;Y++)D[Y].fromArray(y,b+3*Y);return this}toArray(y=[],b=0){const D=this.coefficients;for(let Y=0;Y<9;Y++)D[Y].toArray(y,b+3*Y);return y}static getBasisAt(y,b){const D=y.x,Y=y.y,_e=y.z;b[0]=.282095,b[1]=.488603*Y,b[2]=.488603*_e,b[3]=.488603*D,b[4]=1.092548*D*Y,b[5]=1.092548*Y*_e,b[6]=.315392*(3*_e*_e-1),b[7]=1.092548*D*_e,b[8]=.546274*(D*D-Y*Y)}}class gf extends Ma{constructor(y=new ff,b=1){super(void 0,b),this.isLightProbe=!0,this.sh=y}copy(y){return super.copy(y),this.sh.copy(y.sh),this}fromJSON(y){return this.intensity=y.intensity,this.sh.fromArray(y.sh),this}toJSON(y){const b=super.toJSON(y);return b.object.sh=this.sh.toArray(),b}}class Hd extends No{constructor(y){super(y),this.textures={}}load(y,b,D,Y){const _e=this,Le=new Ms(_e.manager);Le.setPath(_e.path),Le.setRequestHeader(_e.requestHeader),Le.setWithCredentials(_e.withCredentials),Le.load(y,function(qe){try{b(_e.parse(JSON.parse(qe)))}catch(it){Y?Y(it):console.error(it),_e.manager.itemError(y)}},D,Y)}parse(y){const b=this.textures;function D(Le){return b[Le]===void 0&&console.warn("THREE.MaterialLoader: Undefined texture",Le),b[Le]}const Y=y.metadata&&y.metadata.version<=4.5?Fr:void 0,_e=Hd.createMaterialFromType(y.type);if(y.uuid!==void 0&&(_e.uuid=y.uuid),y.name!==void 0&&(_e.name=y.name),y.color!==void 0&&_e.color!==void 0&&_e.color.setHex(y.color,Y),y.roughness!==void 0&&(_e.roughness=y.roughness),y.metalness!==void 0&&(_e.metalness=y.metalness),y.sheen!==void 0&&(_e.sheen=y.sheen),y.sheenColor!==void 0&&(_e.sheenColor=new Dn().setHex(y.sheenColor,Y)),y.sheenRoughness!==void 0&&(_e.sheenRoughness=y.sheenRoughness),y.emissive!==void 0&&_e.emissive!==void 0&&_e.emissive.setHex(y.emissive,Y),y.specular!==void 0&&_e.specular!==void 0&&_e.specular.setHex(y.specular,Y),y.specularIntensity!==void 0&&(_e.specularIntensity=y.specularIntensity),y.specularColor!==void 0&&_e.specularColor!==void 0&&_e.specularColor.setHex(y.specularColor,Y),y.shininess!==void 0&&(_e.shininess=y.shininess),y.clearcoat!==void 0&&(_e.clearcoat=y.clearcoat),y.clearcoatRoughness!==void 0&&(_e.clearcoatRoughness=y.clearcoatRoughness),y.iridescence!==void 0&&(_e.iridescence=y.iridescence),y.iridescenceIOR!==void 0&&(_e.iridescenceIOR=y.iridescenceIOR),y.iridescenceThicknessRange!==void 0&&(_e.iridescenceThicknessRange=y.iridescenceThicknessRange),y.transmission!==void 0&&(_e.transmission=y.transmission),y.thickness!==void 0&&(_e.thickness=y.thickness),y.attenuationDistance!==void 0&&(_e.attenuationDistance=y.attenuationDistance),y.attenuationColor!==void 0&&_e.attenuationColor!==void 0&&_e.attenuationColor.setHex(y.attenuationColor,Y),y.anisotropy!==void 0&&(_e.anisotropy=y.anisotropy),y.anisotropyRotation!==void 0&&(_e.anisotropyRotation=y.anisotropyRotation),y.fog!==void 0&&(_e.fog=y.fog),y.flatShading!==void 0&&(_e.flatShading=y.flatShading),y.blending!==void 0&&(_e.blending=y.blending),y.combine!==void 0&&(_e.combine=y.combine),y.side!==void 0&&(_e.side=y.side),y.shadowSide!==void 0&&(_e.shadowSide=y.shadowSide),y.opacity!==void 0&&(_e.opacity=y.opacity),y.transparent!==void 0&&(_e.transparent=y.transparent),y.alphaTest!==void 0&&(_e.alphaTest=y.alphaTest),y.alphaHash!==void 0&&(_e.alphaHash=y.alphaHash),y.depthTest!==void 0&&(_e.depthTest=y.depthTest),y.depthWrite!==void 0&&(_e.depthWrite=y.depthWrite),y.colorWrite!==void 0&&(_e.colorWrite=y.colorWrite),y.stencilWrite!==void 0&&(_e.stencilWrite=y.stencilWrite),y.stencilWriteMask!==void 0&&(_e.stencilWriteMask=y.stencilWriteMask),y.stencilFunc!==void 0&&(_e.stencilFunc=y.stencilFunc),y.stencilRef!==void 0&&(_e.stencilRef=y.stencilRef),y.stencilFuncMask!==void 0&&(_e.stencilFuncMask=y.stencilFuncMask),y.stencilFail!==void 0&&(_e.stencilFail=y.stencilFail),y.stencilZFail!==void 0&&(_e.stencilZFail=y.stencilZFail),y.stencilZPass!==void 0&&(_e.stencilZPass=y.stencilZPass),y.wireframe!==void 0&&(_e.wireframe=y.wireframe),y.wireframeLinewidth!==void 0&&(_e.wireframeLinewidth=y.wireframeLinewidth),y.wireframeLinecap!==void 0&&(_e.wireframeLinecap=y.wireframeLinecap),y.wireframeLinejoin!==void 0&&(_e.wireframeLinejoin=y.wireframeLinejoin),y.rotation!==void 0&&(_e.rotation=y.rotation),y.linewidth!==void 0&&(_e.linewidth=y.linewidth),y.dashSize!==void 0&&(_e.dashSize=y.dashSize),y.gapSize!==void 0&&(_e.gapSize=y.gapSize),y.scale!==void 0&&(_e.scale=y.scale),y.polygonOffset!==void 0&&(_e.polygonOffset=y.polygonOffset),y.polygonOffsetFactor!==void 0&&(_e.polygonOffsetFactor=y.polygonOffsetFactor),y.polygonOffsetUnits!==void 0&&(_e.polygonOffsetUnits=y.polygonOffsetUnits),y.dithering!==void 0&&(_e.dithering=y.dithering),y.alphaToCoverage!==void 0&&(_e.alphaToCoverage=y.alphaToCoverage),y.premultipliedAlpha!==void 0&&(_e.premultipliedAlpha=y.premultipliedAlpha),y.forceSinglePass!==void 0&&(_e.forceSinglePass=y.forceSinglePass),y.visible!==void 0&&(_e.visible=y.visible),y.toneMapped!==void 0&&(_e.toneMapped=y.toneMapped),y.userData!==void 0&&(_e.userData=y.userData),y.vertexColors!==void 0&&(typeof y.vertexColors=="number"?_e.vertexColors=y.vertexColors>0:_e.vertexColors=y.vertexColors),y.uniforms!==void 0)for(const Le in y.uniforms){const qe=y.uniforms[Le];switch(_e.uniforms[Le]={},qe.type){case"t":_e.uniforms[Le].value=D(qe.value);break;case"c":_e.uniforms[Le].value=new Dn().setHex(qe.value,Y);break;case"v2":_e.uniforms[Le].value=new en().fromArray(qe.value);break;case"v3":_e.uniforms[Le].value=new ii().fromArray(qe.value);break;case"v4":_e.uniforms[Le].value=new Tr().fromArray(qe.value);break;case"m3":_e.uniforms[Le].value=new er().fromArray(qe.value);break;case"m4":_e.uniforms[Le].value=new Xn().fromArray(qe.value);break;default:_e.uniforms[Le].value=qe.value}}if(y.defines!==void 0&&(_e.defines=y.defines),y.vertexShader!==void 0&&(_e.vertexShader=y.vertexShader),y.fragmentShader!==void 0&&(_e.fragmentShader=y.fragmentShader),y.glslVersion!==void 0&&(_e.glslVersion=y.glslVersion),y.extensions!==void 0)for(const Le in y.extensions)_e.extensions[Le]=y.extensions[Le];if(y.lights!==void 0&&(_e.lights=y.lights),y.clipping!==void 0&&(_e.clipping=y.clipping),y.size!==void 0&&(_e.size=y.size),y.sizeAttenuation!==void 0&&(_e.sizeAttenuation=y.sizeAttenuation),y.map!==void 0&&(_e.map=D(y.map)),y.matcap!==void 0&&(_e.matcap=D(y.matcap)),y.alphaMap!==void 0&&(_e.alphaMap=D(y.alphaMap)),y.bumpMap!==void 0&&(_e.bumpMap=D(y.bumpMap)),y.bumpScale!==void 0&&(_e.bumpScale=y.bumpScale),y.normalMap!==void 0&&(_e.normalMap=D(y.normalMap)),y.normalMapType!==void 0&&(_e.normalMapType=y.normalMapType),y.normalScale!==void 0){let Le=y.normalScale;Array.isArray(Le)===!1&&(Le=[Le,Le]),_e.normalScale=new en().fromArray(Le)}return y.displacementMap!==void 0&&(_e.displacementMap=D(y.displacementMap)),y.displacementScale!==void 0&&(_e.displacementScale=y.displacementScale),y.displacementBias!==void 0&&(_e.displacementBias=y.displacementBias),y.roughnessMap!==void 0&&(_e.roughnessMap=D(y.roughnessMap)),y.metalnessMap!==void 0&&(_e.metalnessMap=D(y.metalnessMap)),y.emissiveMap!==void 0&&(_e.emissiveMap=D(y.emissiveMap)),y.emissiveIntensity!==void 0&&(_e.emissiveIntensity=y.emissiveIntensity),y.specularMap!==void 0&&(_e.specularMap=D(y.specularMap)),y.specularIntensityMap!==void 0&&(_e.specularIntensityMap=D(y.specularIntensityMap)),y.specularColorMap!==void 0&&(_e.specularColorMap=D(y.specularColorMap)),y.envMap!==void 0&&(_e.envMap=D(y.envMap)),y.envMapIntensity!==void 0&&(_e.envMapIntensity=y.envMapIntensity),y.reflectivity!==void 0&&(_e.reflectivity=y.reflectivity),y.refractionRatio!==void 0&&(_e.refractionRatio=y.refractionRatio),y.lightMap!==void 0&&(_e.lightMap=D(y.lightMap)),y.lightMapIntensity!==void 0&&(_e.lightMapIntensity=y.lightMapIntensity),y.aoMap!==void 0&&(_e.aoMap=D(y.aoMap)),y.aoMapIntensity!==void 0&&(_e.aoMapIntensity=y.aoMapIntensity),y.gradientMap!==void 0&&(_e.gradientMap=D(y.gradientMap)),y.clearcoatMap!==void 0&&(_e.clearcoatMap=D(y.clearcoatMap)),y.clearcoatRoughnessMap!==void 0&&(_e.clearcoatRoughnessMap=D(y.clearcoatRoughnessMap)),y.clearcoatNormalMap!==void 0&&(_e.clearcoatNormalMap=D(y.clearcoatNormalMap)),y.clearcoatNormalScale!==void 0&&(_e.clearcoatNormalScale=new en().fromArray(y.clearcoatNormalScale)),y.iridescenceMap!==void 0&&(_e.iridescenceMap=D(y.iridescenceMap)),y.iridescenceThicknessMap!==void 0&&(_e.iridescenceThicknessMap=D(y.iridescenceThicknessMap)),y.transmissionMap!==void 0&&(_e.transmissionMap=D(y.transmissionMap)),y.thicknessMap!==void 0&&(_e.thicknessMap=D(y.thicknessMap)),y.anisotropyMap!==void 0&&(_e.anisotropyMap=D(y.anisotropyMap)),y.sheenColorMap!==void 0&&(_e.sheenColorMap=D(y.sheenColorMap)),y.sheenRoughnessMap!==void 0&&(_e.sheenRoughnessMap=D(y.sheenRoughnessMap)),_e}setTextures(y){return this.textures=y,this}static createMaterialFromType(y){return new{ShadowMaterial:Hm,SpriteMaterial:Mh,RawShaderMaterial:Qm,ShaderMaterial:hs,PointsMaterial:Oh,MeshPhysicalMaterial:Wm,MeshStandardMaterial:Yh,MeshPhongMaterial:qm,MeshToonMaterial:Xm,MeshNormalMaterial:Ym,MeshLambertMaterial:Km,MeshDepthMaterial:Sh,MeshDistanceMaterial:Th,MeshBasicMaterial:Ss,MeshMatcapMaterial:$m,LineDashedMaterial:Jm,LineBasicMaterial:Io,Material:no}[y]}}class rp{static decodeText(y){if(typeof TextDecoder<"u")return new TextDecoder().decode(y);let b="";for(let D=0,Y=y.length;D<Y;D++)b+=String.fromCharCode(y[D]);try{return decodeURIComponent(escape(b))}catch{return b}}static extractUrlBase(y){const b=y.lastIndexOf("/");return b===-1?"./":y.slice(0,b+1)}static resolveURL(y,b){return typeof y!="string"||y===""?"":(/^https?:\/\//i.test(b)&&/^\//.test(y)&&(b=b.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(y)||/^data:.*,.*$/i.test(y)||/^blob:.*$/i.test(y)?y:b+y)}}class _f extends dr{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(y){return super.copy(y),this.instanceCount=y.instanceCount,this}toJSON(){const y=super.toJSON();return y.instanceCount=this.instanceCount,y.isInstancedBufferGeometry=!0,y}}class vf extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=this,Le=new Ms(_e.manager);Le.setPath(_e.path),Le.setRequestHeader(_e.requestHeader),Le.setWithCredentials(_e.withCredentials),Le.load(y,function(qe){try{b(_e.parse(JSON.parse(qe)))}catch(it){Y?Y(it):console.error(it),_e.manager.itemError(y)}},D,Y)}parse(y){const b={},D={};function Y(bt,At){if(b[At]!==void 0)return b[At];const wt=bt.interleavedBuffers[At],Et=function(Nt,It){if(D[It]!==void 0)return D[It];const Rt=Nt.arrayBuffers[It],Yt=new Uint32Array(Rt).buffer;return D[It]=Yt,Yt}(bt,wt.buffer),Mt=js(wt.type,Et),St=new dd(Mt,wt.stride);return St.uuid=wt.uuid,b[At]=St,St}const _e=y.isInstancedBufferGeometry?new _f:new dr,Le=y.data.index;if(Le!==void 0){const bt=js(Le.type,Le.array);_e.setIndex(new zt(bt,1))}const qe=y.data.attributes;for(const bt in qe){const At=qe[bt];let wt;if(At.isInterleavedBufferAttribute){const Et=Y(y.data,At.data);wt=new Za(Et,At.itemSize,At.offset,At.normalized)}else{const Et=js(At.type,At.array);wt=new(At.isInstancedBufferAttribute?nc:zt)(Et,At.itemSize,At.normalized)}At.name!==void 0&&(wt.name=At.name),At.usage!==void 0&&wt.setUsage(At.usage),At.updateRange!==void 0&&(wt.updateRange.offset=At.updateRange.offset,wt.updateRange.count=At.updateRange.count),_e.setAttribute(bt,wt)}const it=y.data.morphAttributes;if(it)for(const bt in it){const At=it[bt],wt=[];for(let Et=0,Mt=At.length;Et<Mt;Et++){const St=At[Et];let Nt;if(St.isInterleavedBufferAttribute){const It=Y(y.data,St.data);Nt=new Za(It,St.itemSize,St.offset,St.normalized)}else{const It=js(St.type,St.array);Nt=new zt(It,St.itemSize,St.normalized)}St.name!==void 0&&(Nt.name=St.name),wt.push(Nt)}_e.morphAttributes[bt]=wt}y.data.morphTargetsRelative&&(_e.morphTargetsRelative=!0);const nt=y.data.groups||y.data.drawcalls||y.data.offsets;if(nt!==void 0)for(let bt=0,At=nt.length;bt!==At;++bt){const wt=nt[bt];_e.addGroup(wt.start,wt.count,wt.materialIndex)}const mt=y.data.boundingSphere;if(mt!==void 0){const bt=new ii;mt.center!==void 0&&bt.fromArray(mt.center),_e.boundingSphere=new Oo(bt,mt.radius)}return y.name&&(_e.name=y.name),y.userData&&(_e.userData=y.userData),_e}}class uv extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=this,Le=this.path===""?rp.extractUrlBase(y):this.path;this.resourcePath=this.resourcePath||Le;const qe=new Ms(this.manager);qe.setPath(this.path),qe.setRequestHeader(this.requestHeader),qe.setWithCredentials(this.withCredentials),qe.load(y,function(it){let nt=null;try{nt=JSON.parse(it)}catch(bt){return Y!==void 0&&Y(bt),void console.error("THREE:ObjectLoader: Can't parse "+y+".",bt.message)}const mt=nt.metadata;if(mt===void 0||mt.type===void 0||mt.type.toLowerCase()==="geometry")return Y!==void 0&&Y(new Error("THREE.ObjectLoader: Can't load "+y)),void console.error("THREE.ObjectLoader: Can't load "+y);_e.parse(nt,b)},D,Y)}async loadAsync(y,b){const D=this.path===""?rp.extractUrlBase(y):this.path;this.resourcePath=this.resourcePath||D;const Y=new Ms(this.manager);Y.setPath(this.path),Y.setRequestHeader(this.requestHeader),Y.setWithCredentials(this.withCredentials);const _e=await Y.loadAsync(y,b),Le=JSON.parse(_e),qe=Le.metadata;if(qe===void 0||qe.type===void 0||qe.type.toLowerCase()==="geometry")throw new Error("THREE.ObjectLoader: Can't load "+y);return await this.parseAsync(Le)}parse(y,b){const D=this.parseAnimations(y.animations),Y=this.parseShapes(y.shapes),_e=this.parseGeometries(y.geometries,Y),Le=this.parseImages(y.images,function(){b!==void 0&&b(nt)}),qe=this.parseTextures(y.textures,Le),it=this.parseMaterials(y.materials,qe),nt=this.parseObject(y.object,_e,it,qe,D),mt=this.parseSkeletons(y.skeletons,nt);if(this.bindSkeletons(nt,mt),b!==void 0){let bt=!1;for(const At in Le)if(Le[At].data instanceof HTMLImageElement){bt=!0;break}bt===!1&&b(nt)}return nt}async parseAsync(y){const b=this.parseAnimations(y.animations),D=this.parseShapes(y.shapes),Y=this.parseGeometries(y.geometries,D),_e=await this.parseImagesAsync(y.images),Le=this.parseTextures(y.textures,_e),qe=this.parseMaterials(y.materials,Le),it=this.parseObject(y.object,Y,qe,Le,b),nt=this.parseSkeletons(y.skeletons,it);return this.bindSkeletons(it,nt),it}parseShapes(y){const b={};if(y!==void 0)for(let D=0,Y=y.length;D<Y;D++){const _e=new el().fromJSON(y[D]);b[_e.uuid]=_e}return b}parseSkeletons(y,b){const D={},Y={};if(b.traverse(function(_e){_e.isBone&&(Y[_e.uuid]=_e)}),y!==void 0)for(let _e=0,Le=y.length;_e<Le;_e++){const qe=new _d().fromJSON(y[_e],Y);D[qe.uuid]=qe}return D}parseGeometries(y,b){const D={};if(y!==void 0){const Y=new vf;for(let _e=0,Le=y.length;_e<Le;_e++){let qe;const it=y[_e];switch(it.type){case"BufferGeometry":case"InstancedBufferGeometry":qe=Y.parse(it);break;default:it.type in Vm?qe=Vm[it.type].fromJSON(it,b):console.warn(`THREE.ObjectLoader: Unsupported geometry type "${it.type}"`)}qe.uuid=it.uuid,it.name!==void 0&&(qe.name=it.name),it.userData!==void 0&&(qe.userData=it.userData),D[it.uuid]=qe}}return D}parseMaterials(y,b){const D={},Y={};if(y!==void 0){const _e=new Hd;_e.setTextures(b);for(let Le=0,qe=y.length;Le<qe;Le++){const it=y[Le];D[it.uuid]===void 0&&(D[it.uuid]=_e.parse(it)),Y[it.uuid]=D[it.uuid]}}return Y}parseAnimations(y){const b={};if(y!==void 0)for(let D=0;D<y.length;D++){const Y=y[D],_e=mu.parse(Y);b[_e.uuid]=_e}return b}parseImages(y,b){const D=this,Y={};let _e;function Le(qe){if(typeof qe=="string"){const it=qe;return function(nt){return D.manager.itemStart(nt),_e.load(nt,function(){D.manager.itemEnd(nt)},void 0,function(){D.manager.itemError(nt),D.manager.itemEnd(nt)})}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(it)?it:D.resourcePath+it)}return qe.data?{data:js(qe.type,qe.data),width:qe.width,height:qe.height,complete:!0}:null}if(y!==void 0&&y.length>0){const qe=new ep(b);_e=new fu(qe),_e.setCrossOrigin(this.crossOrigin);for(let it=0,nt=y.length;it<nt;it++){const mt=y[it],bt=mt.url;if(Array.isArray(bt)){const At=[];for(let wt=0,Et=bt.length;wt<Et;wt++){const Mt=Le(bt[wt]);Mt!==null&&(Mt instanceof HTMLImageElement?At.push(Mt):At.push(new ic(Mt.data,Mt.width,Mt.height)))}Y[mt.uuid]=new Go(At)}else{const At=Le(mt.url);Y[mt.uuid]=new Go(At)}}}return Y}async parseImagesAsync(y){const b=this,D={};let Y;async function _e(Le){if(typeof Le=="string"){const qe=Le,it=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(qe)?qe:b.resourcePath+qe;return await Y.loadAsync(it)}return Le.data?{data:js(Le.type,Le.data),width:Le.width,height:Le.height,complete:!0}:null}if(y!==void 0&&y.length>0){Y=new fu(this.manager),Y.setCrossOrigin(this.crossOrigin);for(let Le=0,qe=y.length;Le<qe;Le++){const it=y[Le],nt=it.url;if(Array.isArray(nt)){const mt=[];for(let bt=0,At=nt.length;bt<At;bt++){const wt=nt[bt],Et=await _e(wt);Et!==null&&(Et instanceof HTMLImageElement?mt.push(Et):mt.push(new ic(Et.data,Et.width,Et.height)))}D[it.uuid]=new Go(mt)}else{const mt=await _e(it.url);D[it.uuid]=new Go(mt)}}}return D}parseTextures(y,b){function D(_e,Le){return typeof _e=="number"?_e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",_e),Le[_e])}const Y={};if(y!==void 0)for(let _e=0,Le=y.length;_e<Le;_e++){const qe=y[_e];qe.image===void 0&&console.warn('THREE.ObjectLoader: No "image" specified for',qe.uuid),b[qe.image]===void 0&&console.warn("THREE.ObjectLoader: Undefined image",qe.image);const it=b[qe.image],nt=it?it.data:void 0;let mt;Array.isArray(nt)?(mt=new Xc,nt.length===6&&(mt.needsUpdate=!0)):(mt=nt&&nt.data?new ic:new Or,nt&&nt.complete&&(mt.needsUpdate=!0)),mt.source=it,mt.uuid=qe.uuid,qe.name!==void 0&&(mt.name=qe.name),qe.mapping!==void 0&&(mt.mapping=D(qe.mapping,dv)),qe.channel!==void 0&&(mt.channel=qe.channel),qe.offset!==void 0&&mt.offset.fromArray(qe.offset),qe.repeat!==void 0&&mt.repeat.fromArray(qe.repeat),qe.center!==void 0&&mt.center.fromArray(qe.center),qe.rotation!==void 0&&(mt.rotation=qe.rotation),qe.wrap!==void 0&&(mt.wrapS=D(qe.wrap[0],yf),mt.wrapT=D(qe.wrap[1],yf)),qe.format!==void 0&&(mt.format=qe.format),qe.internalFormat!==void 0&&(mt.internalFormat=qe.internalFormat),qe.type!==void 0&&(mt.type=qe.type),qe.colorSpace!==void 0?mt.colorSpace=qe.colorSpace:qe.encoding!==void 0&&(mt.encoding=qe.encoding),qe.minFilter!==void 0&&(mt.minFilter=D(qe.minFilter,Af)),qe.magFilter!==void 0&&(mt.magFilter=D(qe.magFilter,Af)),qe.anisotropy!==void 0&&(mt.anisotropy=qe.anisotropy),qe.flipY!==void 0&&(mt.flipY=qe.flipY),qe.generateMipmaps!==void 0&&(mt.generateMipmaps=qe.generateMipmaps),qe.premultiplyAlpha!==void 0&&(mt.premultiplyAlpha=qe.premultiplyAlpha),qe.unpackAlignment!==void 0&&(mt.unpackAlignment=qe.unpackAlignment),qe.compareFunction!==void 0&&(mt.compareFunction=qe.compareFunction),qe.userData!==void 0&&(mt.userData=qe.userData),Y[qe.uuid]=mt}return Y}parseObject(y,b,D,Y,_e){let Le;const qe=y.metadata&&y.metadata.version<=4.5?Fr:void 0;function it(wt){return b[wt]===void 0&&console.warn("THREE.ObjectLoader: Undefined geometry",wt),b[wt]}function nt(wt){if(wt!==void 0){if(Array.isArray(wt)){const Et=[];for(let Mt=0,St=wt.length;Mt<St;Mt++){const Nt=wt[Mt];D[Nt]===void 0&&console.warn("THREE.ObjectLoader: Undefined material",Nt),Et.push(D[Nt])}return Et}return D[wt]===void 0&&console.warn("THREE.ObjectLoader: Undefined material",wt),D[wt]}}function mt(wt){return Y[wt]===void 0&&console.warn("THREE.ObjectLoader: Undefined texture",wt),Y[wt]}let bt,At;switch(y.type){case"Scene":Le=new im,y.background!==void 0&&(Number.isInteger(y.background)?Le.background=new Dn().setHex(y.background,qe):Le.background=mt(y.background)),y.environment!==void 0&&(Le.environment=mt(y.environment)),y.fog!==void 0&&(y.fog.type==="Fog"?Le.fog=new ud(y.fog.color,y.fog.near,y.fog.far):y.fog.type==="FogExp2"&&(Le.fog=new cd(y.fog.color,y.fog.density)),y.fog.name!==""&&(Le.fog.name=y.fog.name)),y.backgroundBlurriness!==void 0&&(Le.backgroundBlurriness=y.backgroundBlurriness),y.backgroundIntensity!==void 0&&(Le.backgroundIntensity=y.backgroundIntensity);break;case"PerspectiveCamera":Le=new _o(y.fov,y.aspect,y.near,y.far),y.focus!==void 0&&(Le.focus=y.focus),y.zoom!==void 0&&(Le.zoom=y.zoom),y.filmGauge!==void 0&&(Le.filmGauge=y.filmGauge),y.filmOffset!==void 0&&(Le.filmOffset=y.filmOffset),y.view!==void 0&&(Le.view=Object.assign({},y.view));break;case"OrthographicCamera":Le=new od(y.left,y.right,y.top,y.bottom,y.near,y.far),y.zoom!==void 0&&(Le.zoom=y.zoom),y.view!==void 0&&(Le.view=Object.assign({},y.view));break;case"AmbientLight":Le=new pf(y.color,y.intensity);break;case"DirectionalLight":Le=new hf(y.color,y.intensity);break;case"PointLight":Le=new df(y.color,y.intensity,y.distance,y.decay);break;case"RectAreaLight":Le=new mf(y.color,y.intensity,y.width,y.height);break;case"SpotLight":Le=new cf(y.color,y.intensity,y.distance,y.angle,y.penumbra,y.decay);break;case"HemisphereLight":Le=new sf(y.color,y.groundColor,y.intensity);break;case"LightProbe":Le=new gf().fromJSON(y);break;case"SkinnedMesh":bt=it(y.geometry),At=nt(y.material),Le=new mm(bt,At),y.bindMode!==void 0&&(Le.bindMode=y.bindMode),y.bindMatrix!==void 0&&Le.bindMatrix.fromArray(y.bindMatrix),y.skeleton!==void 0&&(Le.skeleton=y.skeleton);break;case"Mesh":bt=it(y.geometry),At=nt(y.material),Le=new so(bt,At);break;case"InstancedMesh":bt=it(y.geometry),At=nt(y.material);const wt=y.count,Et=y.instanceMatrix,Mt=y.instanceColor;Le=new vm(bt,At,wt),Le.instanceMatrix=new nc(new Float32Array(Et.array),16),Mt!==void 0&&(Le.instanceColor=new nc(new Float32Array(Mt.array),Mt.itemSize));break;case"LOD":Le=new lm;break;case"Line":Le=new Ta(it(y.geometry),nt(y.material));break;case"LineLoop":Le=new Em(it(y.geometry),nt(y.material));break;case"LineSegments":Le=new Ts(it(y.geometry),nt(y.material));break;case"PointCloud":case"Points":Le=new Tm(it(y.geometry),nt(y.material));break;case"Sprite":Le=new sm(nt(y.material));break;case"Group":Le=new Kl;break;case"Bone":Le=new Dh;break;default:Le=new yr}if(Le.uuid=y.uuid,y.name!==void 0&&(Le.name=y.name),y.matrix!==void 0?(Le.matrix.fromArray(y.matrix),y.matrixAutoUpdate!==void 0&&(Le.matrixAutoUpdate=y.matrixAutoUpdate),Le.matrixAutoUpdate&&Le.matrix.decompose(Le.position,Le.quaternion,Le.scale)):(y.position!==void 0&&Le.position.fromArray(y.position),y.rotation!==void 0&&Le.rotation.fromArray(y.rotation),y.quaternion!==void 0&&Le.quaternion.fromArray(y.quaternion),y.scale!==void 0&&Le.scale.fromArray(y.scale)),y.up!==void 0&&Le.up.fromArray(y.up),y.castShadow!==void 0&&(Le.castShadow=y.castShadow),y.receiveShadow!==void 0&&(Le.receiveShadow=y.receiveShadow),y.shadow&&(y.shadow.bias!==void 0&&(Le.shadow.bias=y.shadow.bias),y.shadow.normalBias!==void 0&&(Le.shadow.normalBias=y.shadow.normalBias),y.shadow.radius!==void 0&&(Le.shadow.radius=y.shadow.radius),y.shadow.mapSize!==void 0&&Le.shadow.mapSize.fromArray(y.shadow.mapSize),y.shadow.camera!==void 0&&(Le.shadow.camera=this.parseObject(y.shadow.camera))),y.visible!==void 0&&(Le.visible=y.visible),y.frustumCulled!==void 0&&(Le.frustumCulled=y.frustumCulled),y.renderOrder!==void 0&&(Le.renderOrder=y.renderOrder),y.userData!==void 0&&(Le.userData=y.userData),y.layers!==void 0&&(Le.layers.mask=y.layers),y.children!==void 0){const wt=y.children;for(let Et=0;Et<wt.length;Et++)Le.add(this.parseObject(wt[Et],b,D,Y,_e))}if(y.animations!==void 0){const wt=y.animations;for(let Et=0;Et<wt.length;Et++){const Mt=wt[Et];Le.animations.push(_e[Mt])}}if(y.type==="LOD"){y.autoUpdate!==void 0&&(Le.autoUpdate=y.autoUpdate);const wt=y.levels;for(let Et=0;Et<wt.length;Et++){const Mt=wt[Et],St=Le.getObjectByProperty("uuid",Mt.object);St!==void 0&&Le.addLevel(St,Mt.distance,Mt.hysteresis)}}return Le}bindSkeletons(y,b){Object.keys(b).length!==0&&y.traverse(function(D){if(D.isSkinnedMesh===!0&&D.skeleton!==void 0){const Y=b[D.skeleton];Y===void 0?console.warn("THREE.ObjectLoader: No skeleton found with UUID:",D.skeleton):D.bind(Y,D.bindMatrix)}})}}const dv={UVMapping:vi,CubeReflectionMapping:xi,CubeRefractionMapping:mi,EquirectangularReflectionMapping:Ri,EquirectangularRefractionMapping:Zi,CubeUVReflectionMapping:dn},yf={RepeatWrapping:hn,ClampToEdgeWrapping:an,MirroredRepeatWrapping:pn},Af={NearestFilter:Yi,NearestMipmapNearestFilter:nn,NearestMipmapLinearFilter:un,LinearFilter:fn,LinearMipmapNearestFilter:Fn,LinearMipmapLinearFilter:Zn};class hv extends No{constructor(y){super(y),this.isImageBitmapLoader=!0,typeof createImageBitmap>"u"&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),typeof fetch>"u"&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(y){return this.options=y,this}load(y,b,D,Y){y===void 0&&(y=""),this.path!==void 0&&(y=this.path+y),y=this.manager.resolveURL(y);const _e=this;qs.get(y,"blob").then(Le=>{if(Le!==void 0)return _e.manager.itemStart(y),void createImageBitmap(Le,Object.assign(_e.options,{colorSpaceConversion:"none"})).then(function(it){b&&b(it),_e.manager.itemEnd(y)}).catch(function(it){Y&&Y(it),_e.manager.itemError(y),_e.manager.itemEnd(y)});const qe={};qe.credentials=this.crossOrigin==="anonymous"?"same-origin":"include",qe.headers=this.requestHeader,fetch(y,qe).then(function(it){return it.blob()}).then(function(it){return qs.add(y,it,"blob"),createImageBitmap(it,Object.assign(_e.options,{colorSpaceConversion:"none"}))}).then(function(it){b&&b(it),_e.manager.itemEnd(y)}).catch(function(it){Y&&Y(it),_e.manager.itemError(y),_e.manager.itemEnd(y)}),_e.manager.itemStart(y)})}}let Qd;class op{static getContext(){return Qd===void 0&&(Qd=new(window.AudioContext||window.webkitAudioContext)),Qd}static setContext(y){Qd=y}}class pv extends No{constructor(y){super(y)}load(y,b,D,Y){const _e=this,Le=new Ms(this.manager);function qe(it){Y?Y(it):console.error(it),_e.manager.itemError(y)}Le.setResponseType("arraybuffer"),Le.setPath(this.path),Le.setRequestHeader(this.requestHeader),Le.setWithCredentials(this.withCredentials),Le.load(y,function(it){try{const nt=it.slice(0);op.getContext().decodeAudioData(nt,function(mt){b(mt)},qe)}catch(nt){qe(nt)}},D,Y)}}const bf=new Xn,xf=new Xn,ol=new Xn;class mv{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new _o,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new _o,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(y){const b=this._cache;if(b.focus!==y.focus||b.fov!==y.fov||b.aspect!==y.aspect*this.aspect||b.near!==y.near||b.far!==y.far||b.zoom!==y.zoom||b.eyeSep!==this.eyeSep){b.focus=y.focus,b.fov=y.fov,b.aspect=y.aspect*this.aspect,b.near=y.near,b.far=y.far,b.zoom=y.zoom,b.eyeSep=this.eyeSep,ol.copy(y.projectionMatrix);const D=b.eyeSep/2,Y=D*b.near/b.focus,_e=b.near*Math.tan(As*b.fov*.5)/b.zoom;let Le,qe;xf.elements[12]=-D,bf.elements[12]=D,Le=-_e*b.aspect+Y,qe=_e*b.aspect+Y,ol.elements[0]=2*b.near/(qe-Le),ol.elements[8]=(qe+Le)/(qe-Le),this.cameraL.projectionMatrix.copy(ol),Le=-_e*b.aspect-Y,qe=_e*b.aspect-Y,ol.elements[0]=2*b.near/(qe-Le),ol.elements[8]=(qe+Le)/(qe-Le),this.cameraR.projectionMatrix.copy(ol)}this.cameraL.matrixWorld.copy(y.matrixWorld).multiply(xf),this.cameraR.matrixWorld.copy(y.matrixWorld).multiply(bf)}}class wf{constructor(y=!0){this.autoStart=y,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=Ef(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let y=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const b=Ef();y=(b-this.oldTime)/1e3,this.oldTime=b,this.elapsedTime+=y}return y}}function Ef(){return(typeof performance>"u"?Date:performance).now()}const sl=new ii,Sf=new Ao,fv=new ii,al=new ii;class gv extends yr{constructor(){super(),this.type="AudioListener",this.context=op.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new wf}getInput(){return this.gain}removeFilter(){return this.filter!==null&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(y){return this.filter!==null?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=y,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(y){return this.gain.gain.setTargetAtTime(y,this.context.currentTime,.01),this}updateMatrixWorld(y){super.updateMatrixWorld(y);const b=this.context.listener,D=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(sl,Sf,fv),al.set(0,0,-1).applyQuaternion(Sf),b.positionX){const Y=this.context.currentTime+this.timeDelta;b.positionX.linearRampToValueAtTime(sl.x,Y),b.positionY.linearRampToValueAtTime(sl.y,Y),b.positionZ.linearRampToValueAtTime(sl.z,Y),b.forwardX.linearRampToValueAtTime(al.x,Y),b.forwardY.linearRampToValueAtTime(al.y,Y),b.forwardZ.linearRampToValueAtTime(al.z,Y),b.upX.linearRampToValueAtTime(D.x,Y),b.upY.linearRampToValueAtTime(D.y,Y),b.upZ.linearRampToValueAtTime(D.z,Y)}else b.setPosition(sl.x,sl.y,sl.z),b.setOrientation(al.x,al.y,al.z,D.x,D.y,D.z)}}class Tf extends yr{constructor(y){super(),this.type="Audio",this.listener=y,this.context=y.context,this.gain=this.context.createGain(),this.gain.connect(y.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(y){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=y,this.connect(),this}setMediaElementSource(y){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(y),this.connect(),this}setMediaStreamSource(y){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(y),this.connect(),this}setBuffer(y){return this.buffer=y,this.sourceType="buffer",this.autoplay&&this.play(),this}play(y=0){if(this.isPlaying===!0)return void console.warn("THREE.Audio: Audio is already playing.");if(this.hasPlaybackControl===!1)return void console.warn("THREE.Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+y;const b=this.context.createBufferSource();return b.buffer=this.buffer,b.loop=this.loop,b.loopStart=this.loopStart,b.loopEnd=this.loopEnd,b.onended=this.onEnded.bind(this),b.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=b,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(this.hasPlaybackControl!==!1)return this.isPlaying===!0&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,this.loop===!0&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this;console.warn("THREE.Audio: this Audio has no playback control.")}stop(){if(this.hasPlaybackControl!==!1)return this._progress=0,this.source!==null&&(this.source.stop(),this.source.onended=null),this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let y=1,b=this.filters.length;y<b;y++)this.filters[y-1].connect(this.filters[y]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(this._connected!==!1){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let y=1,b=this.filters.length;y<b;y++)this.filters[y-1].disconnect(this.filters[y]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}}getFilters(){return this.filters}setFilters(y){return y||(y=[]),this._connected===!0?(this.disconnect(),this.filters=y.slice(),this.connect()):this.filters=y.slice(),this}setDetune(y){if(this.detune=y,this.source.detune!==void 0)return this.isPlaying===!0&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(y){return this.setFilters(y?[y]:[])}setPlaybackRate(y){if(this.hasPlaybackControl!==!1)return this.playbackRate=y,this.isPlaying===!0&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this;console.warn("THREE.Audio: this Audio has no playback control.")}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return this.hasPlaybackControl===!1?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop}setLoop(y){if(this.hasPlaybackControl!==!1)return this.loop=y,this.isPlaying===!0&&(this.source.loop=this.loop),this;console.warn("THREE.Audio: this Audio has no playback control.")}setLoopStart(y){return this.loopStart=y,this}setLoopEnd(y){return this.loopEnd=y,this}getVolume(){return this.gain.gain.value}setVolume(y){return this.gain.gain.setTargetAtTime(y,this.context.currentTime,.01),this}}const ll=new ii,Cf=new Ao,_v=new ii,cl=new ii;class vv extends Tf{constructor(y){super(y),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}connect(){super.connect(),this.panner.connect(this.gain)}disconnect(){super.disconnect(),this.panner.disconnect(this.gain)}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(y){return this.panner.refDistance=y,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(y){return this.panner.rolloffFactor=y,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(y){return this.panner.distanceModel=y,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(y){return this.panner.maxDistance=y,this}setDirectionalCone(y,b,D){return this.panner.coneInnerAngle=y,this.panner.coneOuterAngle=b,this.panner.coneOuterGain=D,this}updateMatrixWorld(y){if(super.updateMatrixWorld(y),this.hasPlaybackControl===!0&&this.isPlaying===!1)return;this.matrixWorld.decompose(ll,Cf,_v),cl.set(0,0,1).applyQuaternion(Cf);const b=this.panner;if(b.positionX){const D=this.context.currentTime+this.listener.timeDelta;b.positionX.linearRampToValueAtTime(ll.x,D),b.positionY.linearRampToValueAtTime(ll.y,D),b.positionZ.linearRampToValueAtTime(ll.z,D),b.orientationX.linearRampToValueAtTime(cl.x,D),b.orientationY.linearRampToValueAtTime(cl.y,D),b.orientationZ.linearRampToValueAtTime(cl.z,D)}else b.setPosition(ll.x,ll.y,ll.z),b.setOrientation(cl.x,cl.y,cl.z)}}class yv{constructor(y,b=2048){this.analyser=y.context.createAnalyser(),this.analyser.fftSize=b,this.data=new Uint8Array(this.analyser.frequencyBinCount),y.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let y=0;const b=this.getFrequencyData();for(let D=0;D<b.length;D++)y+=b[D];return y/b.length}}class Mf{constructor(y,b,D){let Y,_e,Le;switch(this.binding=y,this.valueSize=D,b){case"quaternion":Y=this._slerp,_e=this._slerpAdditive,Le=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*D),this._workIndex=5;break;case"string":case"bool":Y=this._select,_e=this._select,Le=this._setAdditiveIdentityOther,this.buffer=new Array(5*D);break;default:Y=this._lerp,_e=this._lerpAdditive,Le=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*D)}this._mixBufferRegion=Y,this._mixBufferRegionAdditive=_e,this._setIdentity=Le,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(y,b){const D=this.buffer,Y=this.valueSize,_e=y*Y+Y;let Le=this.cumulativeWeight;if(Le===0){for(let qe=0;qe!==Y;++qe)D[_e+qe]=D[qe];Le=b}else{Le+=b;const qe=b/Le;this._mixBufferRegion(D,_e,0,qe,Y)}this.cumulativeWeight=Le}accumulateAdditive(y){const b=this.buffer,D=this.valueSize,Y=D*this._addIndex;this.cumulativeWeightAdditive===0&&this._setIdentity(),this._mixBufferRegionAdditive(b,Y,0,y,D),this.cumulativeWeightAdditive+=y}apply(y){const b=this.valueSize,D=this.buffer,Y=y*b+b,_e=this.cumulativeWeight,Le=this.cumulativeWeightAdditive,qe=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,_e<1){const it=b*this._origIndex;this._mixBufferRegion(D,Y,it,1-_e,b)}Le>0&&this._mixBufferRegionAdditive(D,Y,this._addIndex*b,1,b);for(let it=b,nt=b+b;it!==nt;++it)if(D[it]!==D[it+b]){qe.setValue(D,Y);break}}saveOriginalState(){const y=this.binding,b=this.buffer,D=this.valueSize,Y=D*this._origIndex;y.getValue(b,Y);for(let _e=D,Le=Y;_e!==Le;++_e)b[_e]=b[Y+_e%D];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const y=3*this.valueSize;this.binding.setValue(this.buffer,y)}_setAdditiveIdentityNumeric(){const y=this._addIndex*this.valueSize,b=y+this.valueSize;for(let D=y;D<b;D++)this.buffer[D]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const y=this._origIndex*this.valueSize,b=this._addIndex*this.valueSize;for(let D=0;D<this.valueSize;D++)this.buffer[b+D]=this.buffer[y+D]}_select(y,b,D,Y,_e){if(Y>=.5)for(let Le=0;Le!==_e;++Le)y[b+Le]=y[D+Le]}_slerp(y,b,D,Y){Ao.slerpFlat(y,b,y,b,y,D,Y)}_slerpAdditive(y,b,D,Y,_e){const Le=this._workIndex*_e;Ao.multiplyQuaternionsFlat(y,Le,y,b,y,D),Ao.slerpFlat(y,b,y,b,y,Le,Y)}_lerp(y,b,D,Y,_e){const Le=1-Y;for(let qe=0;qe!==_e;++qe){const it=b+qe;y[it]=y[it]*Le+y[D+qe]*Y}}_lerpAdditive(y,b,D,Y,_e){for(let Le=0;Le!==_e;++Le){const qe=b+Le;y[qe]=y[qe]+y[D+Le]*Y}}}const sp="\\[\\]\\.:\\/",Av=new RegExp("["+sp+"]","g"),ap="[^"+sp+"]",bv="[^"+sp.replace("\\.","")+"]",xv=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",ap)+/(WCOD+)?/.source.replace("WCOD",bv)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",ap)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",ap)+"$"),wv=["material","materials","bones","map"];class Ar{constructor(y,b,D){this.path=b,this.parsedPath=D||Ar.parseTrackName(b),this.node=Ar.findNode(y,this.parsedPath.nodeName),this.rootNode=y,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(y,b,D){return y&&y.isAnimationObjectGroup?new Ar.Composite(y,b,D):new Ar(y,b,D)}static sanitizeNodeName(y){return y.replace(/\s/g,"_").replace(Av,"")}static parseTrackName(y){const b=xv.exec(y);if(b===null)throw new Error("PropertyBinding: Cannot parse trackName: "+y);const D={nodeName:b[2],objectName:b[3],objectIndex:b[4],propertyName:b[5],propertyIndex:b[6]},Y=D.nodeName&&D.nodeName.lastIndexOf(".");if(Y!==void 0&&Y!==-1){const _e=D.nodeName.substring(Y+1);wv.indexOf(_e)!==-1&&(D.nodeName=D.nodeName.substring(0,Y),D.objectName=_e)}if(D.propertyName===null||D.propertyName.length===0)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+y);return D}static findNode(y,b){if(b===void 0||b===""||b==="."||b===-1||b===y.name||b===y.uuid)return y;if(y.skeleton){const D=y.skeleton.getBoneByName(b);if(D!==void 0)return D}if(y.children){const D=function(_e){for(let Le=0;Le<_e.length;Le++){const qe=_e[Le];if(qe.name===b||qe.uuid===b)return qe;const it=D(qe.children);if(it)return it}return null},Y=D(y.children);if(Y)return Y}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(y,b){y[b]=this.targetObject[this.propertyName]}_getValue_array(y,b){const D=this.resolvedProperty;for(let Y=0,_e=D.length;Y!==_e;++Y)y[b++]=D[Y]}_getValue_arrayElement(y,b){y[b]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(y,b){this.resolvedProperty.toArray(y,b)}_setValue_direct(y,b){this.targetObject[this.propertyName]=y[b]}_setValue_direct_setNeedsUpdate(y,b){this.targetObject[this.propertyName]=y[b],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(y,b){this.targetObject[this.propertyName]=y[b],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(y,b){const D=this.resolvedProperty;for(let Y=0,_e=D.length;Y!==_e;++Y)D[Y]=y[b++]}_setValue_array_setNeedsUpdate(y,b){const D=this.resolvedProperty;for(let Y=0,_e=D.length;Y!==_e;++Y)D[Y]=y[b++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(y,b){const D=this.resolvedProperty;for(let Y=0,_e=D.length;Y!==_e;++Y)D[Y]=y[b++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(y,b){this.resolvedProperty[this.propertyIndex]=y[b]}_setValue_arrayElement_setNeedsUpdate(y,b){this.resolvedProperty[this.propertyIndex]=y[b],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(y,b){this.resolvedProperty[this.propertyIndex]=y[b],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(y,b){this.resolvedProperty.fromArray(y,b)}_setValue_fromArray_setNeedsUpdate(y,b){this.resolvedProperty.fromArray(y,b),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(y,b){this.resolvedProperty.fromArray(y,b),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(y,b){this.bind(),this.getValue(y,b)}_setValue_unbound(y,b){this.bind(),this.setValue(y,b)}bind(){let y=this.node;const b=this.parsedPath,D=b.objectName,Y=b.propertyName;let _e=b.propertyIndex;if(y||(y=Ar.findNode(this.rootNode,b.nodeName),this.node=y),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!y)return void console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");if(D){let nt=b.objectIndex;switch(D){case"materials":if(!y.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!y.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);y=y.material.materials;break;case"bones":if(!y.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);y=y.skeleton.bones;for(let mt=0;mt<y.length;mt++)if(y[mt].name===nt){nt=mt;break}break;case"map":if("map"in y){y=y.map;break}if(!y.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!y.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);y=y.material.map;break;default:if(y[D]===void 0)return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);y=y[D]}if(nt!==void 0){if(y[nt]===void 0)return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,y);y=y[nt]}}const Le=y[Y];if(Le===void 0){const nt=b.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+nt+"."+Y+" but it wasn't found.",y)}let qe=this.Versioning.None;this.targetObject=y,y.needsUpdate!==void 0?qe=this.Versioning.NeedsUpdate:y.matrixWorldNeedsUpdate!==void 0&&(qe=this.Versioning.MatrixWorldNeedsUpdate);let it=this.BindingType.Direct;if(_e!==void 0){if(Y==="morphTargetInfluences"){if(!y.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!y.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);y.morphTargetDictionary[_e]!==void 0&&(_e=y.morphTargetDictionary[_e])}it=this.BindingType.ArrayElement,this.resolvedProperty=Le,this.propertyIndex=_e}else Le.fromArray!==void 0&&Le.toArray!==void 0?(it=this.BindingType.HasFromToArray,this.resolvedProperty=Le):Array.isArray(Le)?(it=this.BindingType.EntireArray,this.resolvedProperty=Le):this.propertyName=Y;this.getValue=this.GetterByBindingType[it],this.setValue=this.SetterByBindingTypeAndVersioning[it][qe]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}Ar.Composite=class{constructor(De,y,b){const D=b||Ar.parseTrackName(y);this._targetGroup=De,this._bindings=De.subscribe_(y,D)}getValue(De,y){this.bind();const b=this._targetGroup.nCachedObjects_,D=this._bindings[b];D!==void 0&&D.getValue(De,y)}setValue(De,y){const b=this._bindings;for(let D=this._targetGroup.nCachedObjects_,Y=b.length;D!==Y;++D)b[D].setValue(De,y)}bind(){const De=this._bindings;for(let y=this._targetGroup.nCachedObjects_,b=De.length;y!==b;++y)De[y].bind()}unbind(){const De=this._bindings;for(let y=this._targetGroup.nCachedObjects_,b=De.length;y!==b;++y)De[y].unbind()}},Ar.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Ar.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},Ar.prototype.GetterByBindingType=[Ar.prototype._getValue_direct,Ar.prototype._getValue_array,Ar.prototype._getValue_arrayElement,Ar.prototype._getValue_toArray],Ar.prototype.SetterByBindingTypeAndVersioning=[[Ar.prototype._setValue_direct,Ar.prototype._setValue_direct_setNeedsUpdate,Ar.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[Ar.prototype._setValue_array,Ar.prototype._setValue_array_setNeedsUpdate,Ar.prototype._setValue_array_setMatrixWorldNeedsUpdate],[Ar.prototype._setValue_arrayElement,Ar.prototype._setValue_arrayElement_setNeedsUpdate,Ar.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[Ar.prototype._setValue_fromArray,Ar.prototype._setValue_fromArray_setNeedsUpdate,Ar.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class Ev{constructor(){this.isAnimationObjectGroup=!0,this.uuid=vo(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const y={};this._indicesByUUID=y;for(let D=0,Y=arguments.length;D!==Y;++D)y[arguments[D].uuid]=D;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const b=this;this.stats={objects:{get total(){return b._objects.length},get inUse(){return this.total-b.nCachedObjects_}},get bindingsPerObject(){return b._bindings.length}}}add(){const y=this._objects,b=this._indicesByUUID,D=this._paths,Y=this._parsedPaths,_e=this._bindings,Le=_e.length;let qe,it=y.length,nt=this.nCachedObjects_;for(let mt=0,bt=arguments.length;mt!==bt;++mt){const At=arguments[mt],wt=At.uuid;let Et=b[wt];if(Et===void 0){Et=it++,b[wt]=Et,y.push(At);for(let Mt=0,St=Le;Mt!==St;++Mt)_e[Mt].push(new Ar(At,D[Mt],Y[Mt]))}else if(Et<nt){qe=y[Et];const Mt=--nt,St=y[Mt];b[St.uuid]=Et,y[Et]=St,b[wt]=Mt,y[Mt]=At;for(let Nt=0,It=Le;Nt!==It;++Nt){const Rt=_e[Nt],Yt=Rt[Mt];let Kt=Rt[Et];Rt[Et]=Yt,Kt===void 0&&(Kt=new Ar(At,D[Nt],Y[Nt])),Rt[Mt]=Kt}}else y[Et]!==qe&&console.error("THREE.AnimationObjectGroup: Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes.")}this.nCachedObjects_=nt}remove(){const y=this._objects,b=this._indicesByUUID,D=this._bindings,Y=D.length;let _e=this.nCachedObjects_;for(let Le=0,qe=arguments.length;Le!==qe;++Le){const it=arguments[Le],nt=it.uuid,mt=b[nt];if(mt!==void 0&&mt>=_e){const bt=_e++,At=y[bt];b[At.uuid]=mt,y[mt]=At,b[nt]=bt,y[bt]=it;for(let wt=0,Et=Y;wt!==Et;++wt){const Mt=D[wt],St=Mt[bt],Nt=Mt[mt];Mt[mt]=St,Mt[bt]=Nt}}}this.nCachedObjects_=_e}uncache(){const y=this._objects,b=this._indicesByUUID,D=this._bindings,Y=D.length;let _e=this.nCachedObjects_,Le=y.length;for(let qe=0,it=arguments.length;qe!==it;++qe){const nt=arguments[qe].uuid,mt=b[nt];if(mt!==void 0)if(delete b[nt],mt<_e){const bt=--_e,At=y[bt],wt=--Le,Et=y[wt];b[At.uuid]=mt,y[mt]=At,b[Et.uuid]=bt,y[bt]=Et,y.pop();for(let Mt=0,St=Y;Mt!==St;++Mt){const Nt=D[Mt],It=Nt[bt],Rt=Nt[wt];Nt[mt]=It,Nt[bt]=Rt,Nt.pop()}}else{const bt=--Le,At=y[bt];bt>0&&(b[At.uuid]=mt),y[mt]=At,y.pop();for(let wt=0,Et=Y;wt!==Et;++wt){const Mt=D[wt];Mt[mt]=Mt[bt],Mt.pop()}}}this.nCachedObjects_=_e}subscribe_(y,b){const D=this._bindingsIndicesByPath;let Y=D[y];const _e=this._bindings;if(Y!==void 0)return _e[Y];const Le=this._paths,qe=this._parsedPaths,it=this._objects,nt=it.length,mt=this.nCachedObjects_,bt=new Array(nt);Y=_e.length,D[y]=Y,Le.push(y),qe.push(b),_e.push(bt);for(let At=mt,wt=it.length;At!==wt;++At){const Et=it[At];bt[At]=new Ar(Et,y,b)}return bt}unsubscribe_(y){const b=this._bindingsIndicesByPath,D=b[y];if(D!==void 0){const Y=this._paths,_e=this._parsedPaths,Le=this._bindings,qe=Le.length-1,it=Le[qe];b[y[qe]]=D,Le[D]=it,Le.pop(),_e[D]=_e[qe],_e.pop(),Y[D]=Y[qe],Y.pop()}}}class Pf{constructor(y,b,D=null,Y=b.blendMode){this._mixer=y,this._clip=b,this._localRoot=D,this.blendMode=Y;const _e=b.tracks,Le=_e.length,qe=new Array(Le),it={endingStart:Bs,endingEnd:Bs};for(let nt=0;nt!==Le;++nt){const mt=_e[nt].createInterpolant(null);qe[nt]=mt,mt.settings=it}this._interpolantSettings=it,this._interpolants=qe,this._propertyBindings=new Array(Le),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=ta,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&this.timeScale!==0&&this._startTime===null&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(y){return this._startTime=y,this}setLoop(y,b){return this.loop=y,this.repetitions=b,this}setEffectiveWeight(y){return this.weight=y,this._effectiveWeight=this.enabled?y:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(y){return this._scheduleFading(y,0,1)}fadeOut(y){return this._scheduleFading(y,1,0)}crossFadeFrom(y,b,D){if(y.fadeOut(b),this.fadeIn(b),D){const Y=this._clip.duration,_e=y._clip.duration,Le=_e/Y,qe=Y/_e;y.warp(1,Le,b),this.warp(qe,1,b)}return this}crossFadeTo(y,b,D){return y.crossFadeFrom(this,b,D)}stopFading(){const y=this._weightInterpolant;return y!==null&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(y)),this}setEffectiveTimeScale(y){return this.timeScale=y,this._effectiveTimeScale=this.paused?0:y,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(y){return this.timeScale=this._clip.duration/y,this.stopWarping()}syncWith(y){return this.time=y.time,this.timeScale=y.timeScale,this.stopWarping()}halt(y){return this.warp(this._effectiveTimeScale,0,y)}warp(y,b,D){const Y=this._mixer,_e=Y.time,Le=this.timeScale;let qe=this._timeScaleInterpolant;qe===null&&(qe=Y._lendControlInterpolant(),this._timeScaleInterpolant=qe);const it=qe.parameterPositions,nt=qe.sampleValues;return it[0]=_e,it[1]=_e+D,nt[0]=y/Le,nt[1]=b/Le,this}stopWarping(){const y=this._timeScaleInterpolant;return y!==null&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(y)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(y,b,D,Y){if(!this.enabled)return void this._updateWeight(y);const _e=this._startTime;if(_e!==null){const it=(y-_e)*D;it<0||D===0?b=0:(this._startTime=null,b=D*it)}b*=this._updateTimeScale(y);const Le=this._updateTime(b),qe=this._updateWeight(y);if(qe>0){const it=this._interpolants,nt=this._propertyBindings;if(this.blendMode===xl)for(let mt=0,bt=it.length;mt!==bt;++mt)it[mt].evaluate(Le),nt[mt].accumulateAdditive(qe);else for(let mt=0,bt=it.length;mt!==bt;++mt)it[mt].evaluate(Le),nt[mt].accumulate(Y,qe)}}_updateWeight(y){let b=0;if(this.enabled){b=this.weight;const D=this._weightInterpolant;if(D!==null){const Y=D.evaluate(y)[0];b*=Y,y>D.parameterPositions[1]&&(this.stopFading(),Y===0&&(this.enabled=!1))}}return this._effectiveWeight=b,b}_updateTimeScale(y){let b=0;if(!this.paused){b=this.timeScale;const D=this._timeScaleInterpolant;D!==null&&(b*=D.evaluate(y)[0],y>D.parameterPositions[1]&&(this.stopWarping(),b===0?this.paused=!0:this.timeScale=b))}return this._effectiveTimeScale=b,b}_updateTime(y){const b=this._clip.duration,D=this.loop;let Y=this.time+y,_e=this._loopCount;const Le=D===Al;if(y===0)return _e===-1||!Le||1&~_e?Y:b-Y;if(D===ea){_e===-1&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(Y>=b)Y=b;else{if(!(Y<0)){this.time=Y;break e}Y=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=Y,this._mixer.dispatchEvent({type:"finished",action:this,direction:y<0?-1:1})}}else{if(_e===-1&&(y>=0?(_e=0,this._setEndings(!0,this.repetitions===0,Le)):this._setEndings(this.repetitions===0,!0,Le)),Y>=b||Y<0){const qe=Math.floor(Y/b);Y-=b*qe,_e+=Math.abs(qe);const it=this.repetitions-_e;if(it<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,Y=y>0?b:0,this.time=Y,this._mixer.dispatchEvent({type:"finished",action:this,direction:y>0?1:-1});else{if(it===1){const nt=y<0;this._setEndings(nt,!nt,Le)}else this._setEndings(!1,!1,Le);this._loopCount=_e,this.time=Y,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:qe})}}else this.time=Y;if(Le&&!(1&~_e))return b-Y}return Y}_setEndings(y,b,D){const Y=this._interpolantSettings;D?(Y.endingStart=Os,Y.endingEnd=Os):(Y.endingStart=y?this.zeroSlopeAtStart?Os:Bs:La,Y.endingEnd=b?this.zeroSlopeAtEnd?Os:Bs:La)}_scheduleFading(y,b,D){const Y=this._mixer,_e=Y.time;let Le=this._weightInterpolant;Le===null&&(Le=Y._lendControlInterpolant(),this._weightInterpolant=Le);const qe=Le.parameterPositions,it=Le.sampleValues;return qe[0]=_e,it[0]=b,qe[1]=_e+y,it[1]=D,this}}const Sv=new Float32Array(1);class Tv extends ho{constructor(y){super(),this._root=y,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(y,b){const D=y._localRoot||this._root,Y=y._clip.tracks,_e=Y.length,Le=y._propertyBindings,qe=y._interpolants,it=D.uuid,nt=this._bindingsByRootAndName;let mt=nt[it];mt===void 0&&(mt={},nt[it]=mt);for(let bt=0;bt!==_e;++bt){const At=Y[bt],wt=At.name;let Et=mt[wt];if(Et!==void 0)++Et.referenceCount,Le[bt]=Et;else{if(Et=Le[bt],Et!==void 0){Et._cacheIndex===null&&(++Et.referenceCount,this._addInactiveBinding(Et,it,wt));continue}const Mt=b&&b._propertyBindings[bt].binding.parsedPath;Et=new Mf(Ar.create(D,wt,Mt),At.ValueTypeName,At.getValueSize()),++Et.referenceCount,this._addInactiveBinding(Et,it,wt),Le[bt]=Et}qe[bt].resultBuffer=Et.buffer}}_activateAction(y){if(!this._isActiveAction(y)){if(y._cacheIndex===null){const D=(y._localRoot||this._root).uuid,Y=y._clip.uuid,_e=this._actionsByClip[Y];this._bindAction(y,_e&&_e.knownActions[0]),this._addInactiveAction(y,Y,D)}const b=y._propertyBindings;for(let D=0,Y=b.length;D!==Y;++D){const _e=b[D];_e.useCount++==0&&(this._lendBinding(_e),_e.saveOriginalState())}this._lendAction(y)}}_deactivateAction(y){if(this._isActiveAction(y)){const b=y._propertyBindings;for(let D=0,Y=b.length;D!==Y;++D){const _e=b[D];--_e.useCount==0&&(_e.restoreOriginalState(),this._takeBackBinding(_e))}this._takeBackAction(y)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const y=this;this.stats={actions:{get total(){return y._actions.length},get inUse(){return y._nActiveActions}},bindings:{get total(){return y._bindings.length},get inUse(){return y._nActiveBindings}},controlInterpolants:{get total(){return y._controlInterpolants.length},get inUse(){return y._nActiveControlInterpolants}}}}_isActiveAction(y){const b=y._cacheIndex;return b!==null&&b<this._nActiveActions}_addInactiveAction(y,b,D){const Y=this._actions,_e=this._actionsByClip;let Le=_e[b];if(Le===void 0)Le={knownActions:[y],actionByRoot:{}},y._byClipCacheIndex=0,_e[b]=Le;else{const qe=Le.knownActions;y._byClipCacheIndex=qe.length,qe.push(y)}y._cacheIndex=Y.length,Y.push(y),Le.actionByRoot[D]=y}_removeInactiveAction(y){const b=this._actions,D=b[b.length-1],Y=y._cacheIndex;D._cacheIndex=Y,b[Y]=D,b.pop(),y._cacheIndex=null;const _e=y._clip.uuid,Le=this._actionsByClip,qe=Le[_e],it=qe.knownActions,nt=it[it.length-1],mt=y._byClipCacheIndex;nt._byClipCacheIndex=mt,it[mt]=nt,it.pop(),y._byClipCacheIndex=null,delete qe.actionByRoot[(y._localRoot||this._root).uuid],it.length===0&&delete Le[_e],this._removeInactiveBindingsForAction(y)}_removeInactiveBindingsForAction(y){const b=y._propertyBindings;for(let D=0,Y=b.length;D!==Y;++D){const _e=b[D];--_e.referenceCount==0&&this._removeInactiveBinding(_e)}}_lendAction(y){const b=this._actions,D=y._cacheIndex,Y=this._nActiveActions++,_e=b[Y];y._cacheIndex=Y,b[Y]=y,_e._cacheIndex=D,b[D]=_e}_takeBackAction(y){const b=this._actions,D=y._cacheIndex,Y=--this._nActiveActions,_e=b[Y];y._cacheIndex=Y,b[Y]=y,_e._cacheIndex=D,b[D]=_e}_addInactiveBinding(y,b,D){const Y=this._bindingsByRootAndName,_e=this._bindings;let Le=Y[b];Le===void 0&&(Le={},Y[b]=Le),Le[D]=y,y._cacheIndex=_e.length,_e.push(y)}_removeInactiveBinding(y){const b=this._bindings,D=y.binding,Y=D.rootNode.uuid,_e=D.path,Le=this._bindingsByRootAndName,qe=Le[Y],it=b[b.length-1],nt=y._cacheIndex;it._cacheIndex=nt,b[nt]=it,b.pop(),delete qe[_e],Object.keys(qe).length===0&&delete Le[Y]}_lendBinding(y){const b=this._bindings,D=y._cacheIndex,Y=this._nActiveBindings++,_e=b[Y];y._cacheIndex=Y,b[Y]=y,_e._cacheIndex=D,b[D]=_e}_takeBackBinding(y){const b=this._bindings,D=y._cacheIndex,Y=--this._nActiveBindings,_e=b[Y];y._cacheIndex=Y,b[Y]=y,_e._cacheIndex=D,b[D]=_e}_lendControlInterpolant(){const y=this._controlInterpolants,b=this._nActiveControlInterpolants++;let D=y[b];return D===void 0&&(D=new Jh(new Float32Array(2),new Float32Array(2),1,Sv),D.__cacheIndex=b,y[b]=D),D}_takeBackControlInterpolant(y){const b=this._controlInterpolants,D=y.__cacheIndex,Y=--this._nActiveControlInterpolants,_e=b[Y];y.__cacheIndex=Y,b[Y]=y,_e.__cacheIndex=D,b[D]=_e}clipAction(y,b,D){const Y=b||this._root,_e=Y.uuid;let Le=typeof y=="string"?mu.findByName(Y,y):y;const qe=Le!==null?Le.uuid:y,it=this._actionsByClip[qe];let nt=null;if(D===void 0&&(D=Le!==null?Le.blendMode:bc),it!==void 0){const bt=it.actionByRoot[_e];if(bt!==void 0&&bt.blendMode===D)return bt;nt=it.knownActions[0],Le===null&&(Le=nt._clip)}if(Le===null)return null;const mt=new Pf(this,Le,b,D);return this._bindAction(mt,nt),this._addInactiveAction(mt,qe,_e),mt}existingAction(y,b){const D=b||this._root,Y=D.uuid,_e=typeof y=="string"?mu.findByName(D,y):y,Le=_e?_e.uuid:y,qe=this._actionsByClip[Le];return qe!==void 0&&qe.actionByRoot[Y]||null}stopAllAction(){const y=this._actions;for(let b=this._nActiveActions-1;b>=0;--b)y[b].stop();return this}update(y){y*=this.timeScale;const b=this._actions,D=this._nActiveActions,Y=this.time+=y,_e=Math.sign(y),Le=this._accuIndex^=1;for(let nt=0;nt!==D;++nt)b[nt]._update(Y,y,_e,Le);const qe=this._bindings,it=this._nActiveBindings;for(let nt=0;nt!==it;++nt)qe[nt].apply(Le);return this}setTime(y){this.time=0;for(let b=0;b<this._actions.length;b++)this._actions[b].time=0;return this.update(y)}getRoot(){return this._root}uncacheClip(y){const b=this._actions,D=y.uuid,Y=this._actionsByClip,_e=Y[D];if(_e!==void 0){const Le=_e.knownActions;for(let qe=0,it=Le.length;qe!==it;++qe){const nt=Le[qe];this._deactivateAction(nt);const mt=nt._cacheIndex,bt=b[b.length-1];nt._cacheIndex=null,nt._byClipCacheIndex=null,bt._cacheIndex=mt,b[mt]=bt,b.pop(),this._removeInactiveBindingsForAction(nt)}delete Y[D]}}uncacheRoot(y){const b=y.uuid,D=this._actionsByClip;for(const _e in D){const Le=D[_e].actionByRoot[b];Le!==void 0&&(this._deactivateAction(Le),this._removeInactiveAction(Le))}const Y=this._bindingsByRootAndName[b];if(Y!==void 0)for(const _e in Y){const Le=Y[_e];Le.restoreOriginalState(),this._removeInactiveBinding(Le)}}uncacheAction(y,b){const D=this.existingAction(y,b);D!==null&&(this._deactivateAction(D),this._removeInactiveAction(D))}}class lp{constructor(y){this.value=y}clone(){return new lp(this.value.clone===void 0?this.value:this.value.clone())}}let Cv=0;class Mv extends ho{constructor(){super(),this.isUniformsGroup=!0,Object.defineProperty(this,"id",{value:Cv++}),this.name="",this.usage=oa,this.uniforms=[]}add(y){return this.uniforms.push(y),this}remove(y){const b=this.uniforms.indexOf(y);return b!==-1&&this.uniforms.splice(b,1),this}setName(y){return this.name=y,this}setUsage(y){return this.usage=y,this}dispose(){return this.dispatchEvent({type:"dispose"}),this}copy(y){this.name=y.name,this.usage=y.usage;const b=y.uniforms;this.uniforms.length=0;for(let D=0,Y=b.length;D<Y;D++)this.uniforms.push(b[D].clone());return this}clone(){return new this.constructor().copy(this)}}class Pv extends dd{constructor(y,b,D=1){super(y,b),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=D}copy(y){return super.copy(y),this.meshPerAttribute=y.meshPerAttribute,this}clone(y){const b=super.clone(y);return b.meshPerAttribute=this.meshPerAttribute,b}toJSON(y){const b=super.toJSON(y);return b.isInstancedInterleavedBuffer=!0,b.meshPerAttribute=this.meshPerAttribute,b}}class Iv{constructor(y,b,D,Y,_e){this.isGLBufferAttribute=!0,this.name="",this.buffer=y,this.type=b,this.itemSize=D,this.elementSize=Y,this.count=_e,this.version=0}set needsUpdate(y){y===!0&&this.version++}setBuffer(y){return this.buffer=y,this}setType(y,b){return this.type=y,this.elementSize=b,this}setItemSize(y){return this.itemSize=y,this}setCount(y){return this.count=y,this}}class Rv{constructor(y,b,D=0,Y=1/0){this.ray=new ma(y,b),this.near=D,this.far=Y,this.camera=null,this.layers=new Ul,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(y,b){this.ray.set(y,b)}setFromCamera(y,b){b.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(b.matrixWorld),this.ray.direction.set(y.x,y.y,.5).unproject(b).sub(this.ray.origin).normalize(),this.camera=b):b.isOrthographicCamera?(this.ray.origin.set(y.x,y.y,(b.near+b.far)/(b.near-b.far)).unproject(b),this.ray.direction.set(0,0,-1).transformDirection(b.matrixWorld),this.camera=b):console.error("THREE.Raycaster: Unsupported camera type: "+b.type)}intersectObject(y,b=!0,D=[]){return cp(y,this,D,b),D.sort(If),D}intersectObjects(y,b=!0,D=[]){for(let Y=0,_e=y.length;Y<_e;Y++)cp(y[Y],this,D,b);return D.sort(If),D}}function If(De,y){return De.distance-y.distance}function cp(De,y,b,D){if(De.layers.test(y.layers)&&De.raycast(y,b),D===!0){const Y=De.children;for(let _e=0,Le=Y.length;_e<Le;_e++)cp(Y[_e],y,b,!0)}}class Dv{constructor(y=1,b=0,D=0){return this.radius=y,this.phi=b,this.theta=D,this}set(y,b,D){return this.radius=y,this.phi=b,this.theta=D,this}copy(y){return this.radius=y.radius,this.phi=y.phi,this.theta=y.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(y){return this.setFromCartesianCoords(y.x,y.y,y.z)}setFromCartesianCoords(y,b,D){return this.radius=Math.sqrt(y*y+b*b+D*D),this.radius===0?(this.theta=0,this.phi=0):(this.theta=Math.atan2(y,D),this.phi=Math.acos(Ur(b/this.radius,-1,1))),this}clone(){return new this.constructor().copy(this)}}class Bv{constructor(y=1,b=0,D=0){return this.radius=y,this.theta=b,this.y=D,this}set(y,b,D){return this.radius=y,this.theta=b,this.y=D,this}copy(y){return this.radius=y.radius,this.theta=y.theta,this.y=y.y,this}setFromVector3(y){return this.setFromCartesianCoords(y.x,y.y,y.z)}setFromCartesianCoords(y,b,D){return this.radius=Math.sqrt(y*y+D*D),this.theta=Math.atan2(y,D),this.y=b,this}clone(){return new this.constructor().copy(this)}}const Rf=new en;class Ov{constructor(y=new en(1/0,1/0),b=new en(-1/0,-1/0)){this.isBox2=!0,this.min=y,this.max=b}set(y,b){return this.min.copy(y),this.max.copy(b),this}setFromPoints(y){this.makeEmpty();for(let b=0,D=y.length;b<D;b++)this.expandByPoint(y[b]);return this}setFromCenterAndSize(y,b){const D=Rf.copy(b).multiplyScalar(.5);return this.min.copy(y).sub(D),this.max.copy(y).add(D),this}clone(){return new this.constructor().copy(this)}copy(y){return this.min.copy(y.min),this.max.copy(y.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(y){return this.isEmpty()?y.set(0,0):y.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(y){return this.isEmpty()?y.set(0,0):y.subVectors(this.max,this.min)}expandByPoint(y){return this.min.min(y),this.max.max(y),this}expandByVector(y){return this.min.sub(y),this.max.add(y),this}expandByScalar(y){return this.min.addScalar(-y),this.max.addScalar(y),this}containsPoint(y){return!(y.x<this.min.x||y.x>this.max.x||y.y<this.min.y||y.y>this.max.y)}containsBox(y){return this.min.x<=y.min.x&&y.max.x<=this.max.x&&this.min.y<=y.min.y&&y.max.y<=this.max.y}getParameter(y,b){return b.set((y.x-this.min.x)/(this.max.x-this.min.x),(y.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(y){return!(y.max.x<this.min.x||y.min.x>this.max.x||y.max.y<this.min.y||y.min.y>this.max.y)}clampPoint(y,b){return b.copy(y).clamp(this.min,this.max)}distanceToPoint(y){return this.clampPoint(y,Rf).distanceTo(y)}intersect(y){return this.min.max(y.min),this.max.min(y.max),this.isEmpty()&&this.makeEmpty(),this}union(y){return this.min.min(y.min),this.max.max(y.max),this}translate(y){return this.min.add(y),this.max.add(y),this}equals(y){return y.min.equals(this.min)&&y.max.equals(this.max)}}const Df=new ii,Wd=new ii;class Lv{constructor(y=new ii,b=new ii){this.start=y,this.end=b}set(y,b){return this.start.copy(y),this.end.copy(b),this}copy(y){return this.start.copy(y.start),this.end.copy(y.end),this}getCenter(y){return y.addVectors(this.start,this.end).multiplyScalar(.5)}delta(y){return y.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(y,b){return this.delta(b).multiplyScalar(y).add(this.start)}closestPointToPointParameter(y,b){Df.subVectors(y,this.start),Wd.subVectors(this.end,this.start);const D=Wd.dot(Wd);let Y=Wd.dot(Df)/D;return b&&(Y=Ur(Y,0,1)),Y}closestPointToPoint(y,b,D){const Y=this.closestPointToPointParameter(y,b);return this.delta(D).multiplyScalar(Y).add(this.start)}applyMatrix4(y){return this.start.applyMatrix4(y),this.end.applyMatrix4(y),this}equals(y){return y.start.equals(this.start)&&y.end.equals(this.end)}clone(){return new this.constructor().copy(this)}}const Bf=new ii;class Nv extends yr{constructor(y,b){super(),this.light=y,this.matrix=y.matrixWorld,this.matrixAutoUpdate=!1,this.color=b,this.type="SpotLightHelper";const D=new dr,Y=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let Le=0,qe=1,it=32;Le<it;Le++,qe++){const nt=Le/it*Math.PI*2,mt=qe/it*Math.PI*2;Y.push(Math.cos(nt),Math.sin(nt),1,Math.cos(mt),Math.sin(mt),1)}D.setAttribute("position",new Cn(Y,3));const _e=new Io({fog:!1,toneMapped:!1});this.cone=new Ts(D,_e),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1);const y=this.light.distance?this.light.distance:1e3,b=y*Math.tan(this.light.angle);this.cone.scale.set(b,b,y),Bf.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(Bf),this.color!==void 0?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}const Pa=new ii,qd=new Xn,up=new Xn;class kv extends Ts{constructor(y){const b=Of(y),D=new dr,Y=[],_e=[],Le=new Dn(0,0,1),qe=new Dn(0,1,0);for(let it=0;it<b.length;it++){const nt=b[it];nt.parent&&nt.parent.isBone&&(Y.push(0,0,0),Y.push(0,0,0),_e.push(Le.r,Le.g,Le.b),_e.push(qe.r,qe.g,qe.b))}D.setAttribute("position",new Cn(Y,3)),D.setAttribute("color",new Cn(_e,3)),super(D,new Io({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.isSkeletonHelper=!0,this.type="SkeletonHelper",this.root=y,this.bones=b,this.matrix=y.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(y){const b=this.bones,D=this.geometry,Y=D.getAttribute("position");up.copy(this.root.matrixWorld).invert();for(let _e=0,Le=0;_e<b.length;_e++){const qe=b[_e];qe.parent&&qe.parent.isBone&&(qd.multiplyMatrices(up,qe.matrixWorld),Pa.setFromMatrixPosition(qd),Y.setXYZ(Le,Pa.x,Pa.y,Pa.z),qd.multiplyMatrices(up,qe.parent.matrixWorld),Pa.setFromMatrixPosition(qd),Y.setXYZ(Le+1,Pa.x,Pa.y,Pa.z),Le+=2)}D.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(y)}dispose(){this.geometry.dispose(),this.material.dispose()}}function Of(De){const y=[];De.isBone===!0&&y.push(De);for(let b=0;b<De.children.length;b++)y.push.apply(y,Of(De.children[b]));return y}class Uv extends so{constructor(y,b,D){super(new uu(b,4,2),new Ss({wireframe:!0,fog:!1,toneMapped:!1})),this.light=y,this.color=D,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.color!==void 0?this.material.color.set(this.color):this.material.color.copy(this.light.color)}}const Fv=new ii,Lf=new Dn,Nf=new Dn;class jv extends yr{constructor(y,b,D){super(),this.light=y,this.matrix=y.matrixWorld,this.matrixAutoUpdate=!1,this.color=D,this.type="HemisphereLightHelper";const Y=new cu(b);Y.rotateY(.5*Math.PI),this.material=new Ss({wireframe:!0,fog:!1,toneMapped:!1}),this.color===void 0&&(this.material.vertexColors=!0);const _e=Y.getAttribute("position"),Le=new Float32Array(3*_e.count);Y.setAttribute("color",new zt(Le,3)),this.add(new so(Y,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const y=this.children[0];if(this.color!==void 0)this.material.color.set(this.color);else{const b=y.geometry.getAttribute("color");Lf.copy(this.light.color),Nf.copy(this.light.groundColor);for(let D=0,Y=b.count;D<Y;D++){const _e=D<Y/2?Lf:Nf;b.setXYZ(D,_e.r,_e.g,_e.b)}b.needsUpdate=!0}this.light.updateWorldMatrix(!0,!1),y.lookAt(Fv.setFromMatrixPosition(this.light.matrixWorld).negate())}}class Gv extends Ts{constructor(y=10,b=10,D=4473924,Y=8947848){D=new Dn(D),Y=new Dn(Y);const _e=b/2,Le=y/b,qe=y/2,it=[],nt=[];for(let bt=0,At=0,wt=-qe;bt<=b;bt++,wt+=Le){it.push(-qe,0,wt,qe,0,wt),it.push(wt,0,-qe,wt,0,qe);const Et=bt===_e?D:Y;Et.toArray(nt,At),At+=3,Et.toArray(nt,At),At+=3,Et.toArray(nt,At),At+=3,Et.toArray(nt,At),At+=3}const mt=new dr;mt.setAttribute("position",new Cn(it,3)),mt.setAttribute("color",new Cn(nt,3)),super(mt,new Io({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}class zv extends Ts{constructor(y=10,b=16,D=8,Y=64,_e=4473924,Le=8947848){_e=new Dn(_e),Le=new Dn(Le);const qe=[],it=[];if(b>1)for(let mt=0;mt<b;mt++){const bt=mt/b*(2*Math.PI),At=Math.sin(bt)*y,wt=Math.cos(bt)*y;qe.push(0,0,0),qe.push(At,0,wt);const Et=1&mt?_e:Le;it.push(Et.r,Et.g,Et.b),it.push(Et.r,Et.g,Et.b)}for(let mt=0;mt<D;mt++){const bt=1&mt?_e:Le,At=y-y/D*mt;for(let wt=0;wt<Y;wt++){let Et=wt/Y*(2*Math.PI),Mt=Math.sin(Et)*At,St=Math.cos(Et)*At;qe.push(Mt,0,St),it.push(bt.r,bt.g,bt.b),Et=(wt+1)/Y*(2*Math.PI),Mt=Math.sin(Et)*At,St=Math.cos(Et)*At,qe.push(Mt,0,St),it.push(bt.r,bt.g,bt.b)}}const nt=new dr;nt.setAttribute("position",new Cn(qe,3)),nt.setAttribute("color",new Cn(it,3)),super(nt,new Io({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}const kf=new ii,Xd=new ii,Uf=new ii;class Vv extends yr{constructor(y,b,D){super(),this.light=y,this.matrix=y.matrixWorld,this.matrixAutoUpdate=!1,this.color=D,this.type="DirectionalLightHelper",b===void 0&&(b=1);let Y=new dr;Y.setAttribute("position",new Cn([-b,b,0,b,b,0,b,-b,0,-b,-b,0,-b,b,0],3));const _e=new Io({fog:!1,toneMapped:!1});this.lightPlane=new Ta(Y,_e),this.add(this.lightPlane),Y=new dr,Y.setAttribute("position",new Cn([0,0,0,0,0,1],3)),this.targetLine=new Ta(Y,_e),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1),kf.setFromMatrixPosition(this.light.matrixWorld),Xd.setFromMatrixPosition(this.light.target.matrixWorld),Uf.subVectors(Xd,kf),this.lightPlane.lookAt(Xd),this.color!==void 0?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(Xd),this.targetLine.scale.z=Uf.length()}}const Yd=new ii,Hr=new Zu;class Hv extends Ts{constructor(y){const b=new dr,D=new Io({color:16777215,vertexColors:!0,toneMapped:!1}),Y=[],_e=[],Le={};function qe(Et,Mt){it(Et),it(Mt)}function it(Et){Y.push(0,0,0),_e.push(0,0,0),Le[Et]===void 0&&(Le[Et]=[]),Le[Et].push(Y.length/3-1)}qe("n1","n2"),qe("n2","n4"),qe("n4","n3"),qe("n3","n1"),qe("f1","f2"),qe("f2","f4"),qe("f4","f3"),qe("f3","f1"),qe("n1","f1"),qe("n2","f2"),qe("n3","f3"),qe("n4","f4"),qe("p","n1"),qe("p","n2"),qe("p","n3"),qe("p","n4"),qe("u1","u2"),qe("u2","u3"),qe("u3","u1"),qe("c","t"),qe("p","c"),qe("cn1","cn2"),qe("cn3","cn4"),qe("cf1","cf2"),qe("cf3","cf4"),b.setAttribute("position",new Cn(Y,3)),b.setAttribute("color",new Cn(_e,3)),super(b,D),this.type="CameraHelper",this.camera=y,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=y.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=Le,this.update();const nt=new Dn(16755200),mt=new Dn(16711680),bt=new Dn(43775),At=new Dn(16777215),wt=new Dn(3355443);this.setColors(nt,mt,bt,At,wt)}setColors(y,b,D,Y,_e){const Le=this.geometry.getAttribute("color");Le.setXYZ(0,y.r,y.g,y.b),Le.setXYZ(1,y.r,y.g,y.b),Le.setXYZ(2,y.r,y.g,y.b),Le.setXYZ(3,y.r,y.g,y.b),Le.setXYZ(4,y.r,y.g,y.b),Le.setXYZ(5,y.r,y.g,y.b),Le.setXYZ(6,y.r,y.g,y.b),Le.setXYZ(7,y.r,y.g,y.b),Le.setXYZ(8,y.r,y.g,y.b),Le.setXYZ(9,y.r,y.g,y.b),Le.setXYZ(10,y.r,y.g,y.b),Le.setXYZ(11,y.r,y.g,y.b),Le.setXYZ(12,y.r,y.g,y.b),Le.setXYZ(13,y.r,y.g,y.b),Le.setXYZ(14,y.r,y.g,y.b),Le.setXYZ(15,y.r,y.g,y.b),Le.setXYZ(16,y.r,y.g,y.b),Le.setXYZ(17,y.r,y.g,y.b),Le.setXYZ(18,y.r,y.g,y.b),Le.setXYZ(19,y.r,y.g,y.b),Le.setXYZ(20,y.r,y.g,y.b),Le.setXYZ(21,y.r,y.g,y.b),Le.setXYZ(22,y.r,y.g,y.b),Le.setXYZ(23,y.r,y.g,y.b),Le.setXYZ(24,b.r,b.g,b.b),Le.setXYZ(25,b.r,b.g,b.b),Le.setXYZ(26,b.r,b.g,b.b),Le.setXYZ(27,b.r,b.g,b.b),Le.setXYZ(28,b.r,b.g,b.b),Le.setXYZ(29,b.r,b.g,b.b),Le.setXYZ(30,b.r,b.g,b.b),Le.setXYZ(31,b.r,b.g,b.b),Le.setXYZ(32,D.r,D.g,D.b),Le.setXYZ(33,D.r,D.g,D.b),Le.setXYZ(34,D.r,D.g,D.b),Le.setXYZ(35,D.r,D.g,D.b),Le.setXYZ(36,D.r,D.g,D.b),Le.setXYZ(37,D.r,D.g,D.b),Le.setXYZ(38,Y.r,Y.g,Y.b),Le.setXYZ(39,Y.r,Y.g,Y.b),Le.setXYZ(40,_e.r,_e.g,_e.b),Le.setXYZ(41,_e.r,_e.g,_e.b),Le.setXYZ(42,_e.r,_e.g,_e.b),Le.setXYZ(43,_e.r,_e.g,_e.b),Le.setXYZ(44,_e.r,_e.g,_e.b),Le.setXYZ(45,_e.r,_e.g,_e.b),Le.setXYZ(46,_e.r,_e.g,_e.b),Le.setXYZ(47,_e.r,_e.g,_e.b),Le.setXYZ(48,_e.r,_e.g,_e.b),Le.setXYZ(49,_e.r,_e.g,_e.b),Le.needsUpdate=!0}update(){const y=this.geometry,b=this.pointMap;Hr.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),qr("c",b,y,Hr,0,0,-1),qr("t",b,y,Hr,0,0,1),qr("n1",b,y,Hr,-1,-1,-1),qr("n2",b,y,Hr,1,-1,-1),qr("n3",b,y,Hr,-1,1,-1),qr("n4",b,y,Hr,1,1,-1),qr("f1",b,y,Hr,-1,-1,1),qr("f2",b,y,Hr,1,-1,1),qr("f3",b,y,Hr,-1,1,1),qr("f4",b,y,Hr,1,1,1),qr("u1",b,y,Hr,.7,1.1,-1),qr("u2",b,y,Hr,-.7,1.1,-1),qr("u3",b,y,Hr,0,2,-1),qr("cf1",b,y,Hr,-1,0,1),qr("cf2",b,y,Hr,1,0,1),qr("cf3",b,y,Hr,0,-1,1),qr("cf4",b,y,Hr,0,1,1),qr("cn1",b,y,Hr,-1,0,-1),qr("cn2",b,y,Hr,1,0,-1),qr("cn3",b,y,Hr,0,-1,-1),qr("cn4",b,y,Hr,0,1,-1),y.getAttribute("position").needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}}function qr(De,y,b,D,Y,_e,Le){Yd.set(Y,_e,Le).unproject(D);const qe=y[De];if(qe!==void 0){const it=b.getAttribute("position");for(let nt=0,mt=qe.length;nt<mt;nt++)it.setXYZ(qe[nt],Yd.x,Yd.y,Yd.z)}}const Kd=new Ko;class Qv extends Ts{constructor(y,b=16776960){const D=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),Y=new Float32Array(24),_e=new dr;_e.setIndex(new zt(D,1)),_e.setAttribute("position",new zt(Y,3)),super(_e,new Io({color:b,toneMapped:!1})),this.object=y,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(y){if(y!==void 0&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),this.object!==void 0&&Kd.setFromObject(this.object),Kd.isEmpty())return;const b=Kd.min,D=Kd.max,Y=this.geometry.attributes.position,_e=Y.array;_e[0]=D.x,_e[1]=D.y,_e[2]=D.z,_e[3]=b.x,_e[4]=D.y,_e[5]=D.z,_e[6]=b.x,_e[7]=b.y,_e[8]=D.z,_e[9]=D.x,_e[10]=b.y,_e[11]=D.z,_e[12]=D.x,_e[13]=D.y,_e[14]=b.z,_e[15]=b.x,_e[16]=D.y,_e[17]=b.z,_e[18]=b.x,_e[19]=b.y,_e[20]=b.z,_e[21]=D.x,_e[22]=b.y,_e[23]=b.z,Y.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(y){return this.object=y,this.update(),this}copy(y,b){return super.copy(y,b),this.object=y.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class Wv extends Ts{constructor(y,b=16776960){const D=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),Y=new dr;Y.setIndex(new zt(D,1)),Y.setAttribute("position",new Cn([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(Y,new Io({color:b,toneMapped:!1})),this.box=y,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(y){const b=this.box;b.isEmpty()||(b.getCenter(this.position),b.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(y))}dispose(){this.geometry.dispose(),this.material.dispose()}}class qv extends Ta{constructor(y,b=1,D=16776960){const Y=D,_e=new dr;_e.setAttribute("position",new Cn([1,-1,0,-1,1,0,-1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,-1,0,1,1,0],3)),_e.computeBoundingSphere(),super(_e,new Io({color:Y,toneMapped:!1})),this.type="PlaneHelper",this.plane=y,this.size=b;const Le=new dr;Le.setAttribute("position",new Cn([1,1,0,-1,1,0,-1,-1,0,1,1,0,-1,-1,0,1,-1,0],3)),Le.computeBoundingSphere(),this.add(new so(Le,new Ss({color:Y,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(y){this.position.set(0,0,0),this.scale.set(.5*this.size,.5*this.size,1),this.lookAt(this.plane.normal),this.translateZ(-this.plane.constant),super.updateMatrixWorld(y)}dispose(){this.geometry.dispose(),this.material.dispose(),this.children[0].geometry.dispose(),this.children[0].material.dispose()}}const Ff=new ii;let $d,dp;class Xv extends yr{constructor(y=new ii(0,0,1),b=new ii(0,0,0),D=1,Y=16776960,_e=.2*D,Le=.2*_e){super(),this.type="ArrowHelper",$d===void 0&&($d=new dr,$d.setAttribute("position",new Cn([0,0,0,0,1,0],3)),dp=new oc(0,.5,1,5,1),dp.translate(0,-.5,0)),this.position.copy(b),this.line=new Ta($d,new Io({color:Y,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new so(dp,new Ss({color:Y,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(y),this.setLength(D,_e,Le)}setDirection(y){if(y.y>.99999)this.quaternion.set(0,0,0,1);else if(y.y<-.99999)this.quaternion.set(1,0,0,0);else{Ff.set(y.z,0,-y.x).normalize();const b=Math.acos(y.y);this.quaternion.setFromAxisAngle(Ff,b)}}setLength(y,b=.2*y,D=.2*b){this.line.scale.set(1,Math.max(1e-4,y-b),1),this.line.updateMatrix(),this.cone.scale.set(D,b,D),this.cone.position.y=y,this.cone.updateMatrix()}setColor(y){this.line.material.color.set(y),this.cone.material.color.set(y)}copy(y){return super.copy(y,!1),this.line.copy(y.line),this.cone.copy(y.cone),this}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),this.cone.geometry.dispose(),this.cone.material.dispose()}}class Yv extends Ts{constructor(y=1){const b=[0,0,0,y,0,0,0,0,0,0,y,0,0,0,0,0,0,y],D=new dr;D.setAttribute("position",new Cn(b,3)),D.setAttribute("color",new Cn([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3)),super(D,new Io({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}setColors(y,b,D){const Y=new Dn,_e=this.geometry.attributes.color.array;return Y.set(y),Y.toArray(_e,0),Y.toArray(_e,3),Y.set(b),Y.toArray(_e,6),Y.toArray(_e,9),Y.set(D),Y.toArray(_e,12),Y.toArray(_e,15),this.geometry.attributes.color.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class Kv{constructor(){this.type="ShapePath",this.color=new Dn,this.subPaths=[],this.currentPath=null}moveTo(y,b){return this.currentPath=new ru,this.subPaths.push(this.currentPath),this.currentPath.moveTo(y,b),this}lineTo(y,b){return this.currentPath.lineTo(y,b),this}quadraticCurveTo(y,b,D,Y){return this.currentPath.quadraticCurveTo(y,b,D,Y),this}bezierCurveTo(y,b,D,Y,_e,Le){return this.currentPath.bezierCurveTo(y,b,D,Y,_e,Le),this}splineThru(y){return this.currentPath.splineThru(y),this}toShapes(y){function b(St,Nt){const It=Nt.length;let Rt=!1;for(let Yt=It-1,Kt=0;Kt<It;Yt=Kt++){let Xt=Nt[Yt],oi=Nt[Kt],wi=oi.x-Xt.x,fi=oi.y-Xt.y;if(Math.abs(fi)>Number.EPSILON){if(fi<0&&(Xt=Nt[Kt],wi=-wi,oi=Nt[Yt],fi=-fi),St.y<Xt.y||St.y>oi.y)continue;if(St.y===Xt.y){if(St.x===Xt.x)return!0}else{const yi=fi*(St.x-Xt.x)-wi*(St.y-Xt.y);if(yi===0)return!0;if(yi<0)continue;Rt=!Rt}}else{if(St.y!==Xt.y)continue;if(oi.x<=St.x&&St.x<=Xt.x||Xt.x<=St.x&&St.x<=oi.x)return!0}}return Rt}const D=Cs.isClockWise,Y=this.subPaths;if(Y.length===0)return[];let _e,Le,qe;const it=[];if(Y.length===1)return Le=Y[0],qe=new el,qe.curves=Le.curves,it.push(qe),it;let nt=!D(Y[0].getPoints());nt=y?!nt:nt;const mt=[],bt=[];let At,wt,Et=[],Mt=0;bt[Mt]=void 0,Et[Mt]=[];for(let St=0,Nt=Y.length;St<Nt;St++)Le=Y[St],At=Le.getPoints(),_e=D(At),_e=y?!_e:_e,_e?(!nt&&bt[Mt]&&Mt++,bt[Mt]={s:new el,p:At},bt[Mt].s.curves=Le.curves,nt&&Mt++,Et[Mt]=[]):Et[Mt].push({h:Le,p:At[0]});if(!bt[0])return function(St){const Nt=[];for(let It=0,Rt=St.length;It<Rt;It++){const Yt=St[It],Kt=new el;Kt.curves=Yt.curves,Nt.push(Kt)}return Nt}(Y);if(bt.length>1){let St=!1,Nt=0;for(let It=0,Rt=bt.length;It<Rt;It++)mt[It]=[];for(let It=0,Rt=bt.length;It<Rt;It++){const Yt=Et[It];for(let Kt=0;Kt<Yt.length;Kt++){const Xt=Yt[Kt];let oi=!0;for(let wi=0;wi<bt.length;wi++)b(Xt.p,bt[wi].p)&&(It!==wi&&Nt++,oi?(oi=!1,mt[wi].push(Xt)):St=!0);oi&&mt[It].push(Xt)}}Nt>0&&St===!1&&(Et=mt)}for(let St=0,Nt=bt.length;St<Nt;St++){qe=bt[St].s,it.push(qe),wt=Et[St];for(let It=0,Rt=wt.length;It<Rt;It++)qe.holes.push(wt[It].h)}return it}}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:c}})),typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=c)},149:function(d,o,l){l.d(o,{Z:function(){return h}});var c=l(848);const u=new WeakMap;class h extends c.aHM{constructor(w){super(w),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(w){return this.decoderPath=w,this}setDecoderConfig(w){return this.decoderConfig=w,this}setWorkerLimit(w){return this.workerLimit=w,this}load(w,C,M,O){const ne=new c.Y9S(this.manager);ne.setPath(this.path),ne.setResponseType("arraybuffer"),ne.setRequestHeader(this.requestHeader),ne.setWithCredentials(this.withCredentials),ne.load(w,ce=>{this.parse(ce,C,O)},M,O)}parse(w,C,M){this.decodeDracoFile(w,C,null,null,c.er$).catch(M)}decodeDracoFile(w,C,M,O,ne=c.Zr2){const ce={attributeIDs:M||this.defaultAttributeIDs,attributeTypes:O||this.defaultAttributeTypes,useUniqueIDs:!!M,vertexColorSpace:ne};return this.decodeGeometry(w,ce).then(C)}decodeGeometry(w,C){const M=JSON.stringify(C);if(u.has(w)){const ye=u.get(w);if(ye.key===M)return ye.promise;if(w.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let O;const ne=this.workerNextTaskID++,ce=w.byteLength,ue=this._getWorker(ne,ce).then(ye=>(O=ye,new Promise((Oe,ke)=>{O._callbacks[ne]={resolve:Oe,reject:ke},O.postMessage({type:"decode",id:ne,taskConfig:C,buffer:w},[w])}))).then(ye=>this._createGeometry(ye.geometry));return ue.catch(()=>!0).then(()=>{O&&ne&&this._releaseTask(O,ne)}),u.set(w,{key:M,promise:ue}),ue}_createGeometry(w){const C=new c.LoY;w.index&&C.setIndex(new c.THS(w.index.array,1));for(let M=0;M<w.attributes.length;M++){const O=w.attributes[M],ne=O.name,ce=O.array,ue=O.itemSize,ye=new c.THS(ce,ue);ne==="color"&&(this._assignVertexColorSpace(ye,O.vertexColorSpace),ye.normalized=ce instanceof Float32Array==0),C.setAttribute(ne,ye)}return C}_assignVertexColorSpace(w,C){if(C!==c.er$)return;const M=new c.Q1f;for(let O=0,ne=w.count;O<ne;O++)M.fromBufferAttribute(w,O).convertSRGBToLinear(),w.setXYZ(O,M.r,M.g,M.b)}_loadLibrary(w,C){const M=new c.Y9S(this.manager);return M.setPath(this.decoderPath),M.setResponseType(C),M.setWithCredentials(this.withCredentials),new Promise((O,ne)=>{M.load(w,O,void 0,ne)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const w=typeof WebAssembly!="object"||this.decoderConfig.type==="js",C=[];return w?C.push(this._loadLibrary("draco_decoder.js","text")):(C.push(this._loadLibrary("draco_wasm_wrapper.js","text")),C.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(C).then(M=>{const O=M[0];w||(this.decoderConfig.wasmBinary=M[1]);const ne=_,ce=["/* draco decoder */",O,"","/* worker */",ne.substring(ne.indexOf("{")+1,ne.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([ce]))}),this.decoderPending}_getWorker(w,C){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const O=new Worker(this.workerSourceURL);O._callbacks={},O._taskCosts={},O._taskLoad=0,O.postMessage({type:"init",decoderConfig:this.decoderConfig}),O.onmessage=function(ne){const ce=ne.data;switch(ce.type){case"decode":O._callbacks[ce.id].resolve(ce);break;case"error":O._callbacks[ce.id].reject(ce);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+ce.type+'"')}},this.workerPool.push(O)}else this.workerPool.sort(function(O,ne){return O._taskLoad>ne._taskLoad?-1:1});const M=this.workerPool[this.workerPool.length-1];return M._taskCosts[w]=C,M._taskLoad+=C,M})}_releaseTask(w,C){w._taskLoad-=w._taskCosts[C],delete w._callbacks[C],delete w._taskCosts[C]}debug(){console.log("Task load: ",this.workerPool.map(w=>w._taskLoad))}dispose(){for(let w=0;w<this.workerPool.length;++w)this.workerPool[w].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}const _=`
function DRACOWorker() {

	let decoderConfig;
	let decoderPending;

	onmessage = function ( e ) {

		const message = e.data;

		switch ( message.type ) {

			case 'init':
				decoderConfig = message.decoderConfig;
				decoderPending = new Promise( function ( resolve/*, reject*/ ) {

					decoderConfig.onModuleLoaded = function ( draco ) {

						// Module is Promise-like. Wrap before resolving to avoid loop.
						resolve( { draco: draco } );

					};

					DracoDecoderModule( decoderConfig ); // eslint-disable-line no-undef

				} );
				break;

			case 'decode':
				const buffer = message.buffer;
				const taskConfig = message.taskConfig;
				decoderPending.then( ( module ) => {

					const draco = module.draco;
					const decoder = new draco.Decoder();

					try {

						const geometry = decodeGeometry( draco, decoder, new Int8Array( buffer ), taskConfig );

						const buffers = geometry.attributes.map( ( attr ) => attr.array.buffer );

						if ( geometry.index ) buffers.push( geometry.index.array.buffer );

						self.postMessage( { type: 'decode', id: message.id, geometry }, buffers );

					} catch ( error ) {

						console.error( error );

						self.postMessage( { type: 'error', id: message.id, error: error.message } );

					} finally {

						draco.destroy( decoder );

					}

				} );
				break;

		}

	};

	function decodeGeometry( draco, decoder, array, taskConfig ) {

		const attributeIDs = taskConfig.attributeIDs;
		const attributeTypes = taskConfig.attributeTypes;

		let dracoGeometry;
		let decodingStatus;

		const geometryType = decoder.GetEncodedGeometryType( array );

		if ( geometryType === draco.TRIANGULAR_MESH ) {

			dracoGeometry = new draco.Mesh();
			decodingStatus = decoder.DecodeArrayToMesh( array, array.byteLength, dracoGeometry );

		} else if ( geometryType === draco.POINT_CLOUD ) {

			dracoGeometry = new draco.PointCloud();
			decodingStatus = decoder.DecodeArrayToPointCloud( array, array.byteLength, dracoGeometry );

		} else {

			throw new Error( 'THREE.DRACOLoader: Unexpected geometry type.' );

		}

		if ( ! decodingStatus.ok() || dracoGeometry.ptr === 0 ) {

			throw new Error( 'THREE.DRACOLoader: Decoding failed: ' + decodingStatus.error_msg() );

		}

		const geometry = { index: null, attributes: [] };

		// Gather all vertex attributes.
		for ( const attributeName in attributeIDs ) {

			const attributeType = self[ attributeTypes[ attributeName ] ];

			let attribute;
			let attributeID;

			// A Draco file may be created with default vertex attributes, whose attribute IDs
			// are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,
			// a Draco file may contain a custom set of attributes, identified by known unique
			// IDs. glTF files always do the latter, and .drc files typically do the former.
			if ( taskConfig.useUniqueIDs ) {

				attributeID = attributeIDs[ attributeName ];
				attribute = decoder.GetAttributeByUniqueId( dracoGeometry, attributeID );

			} else {

				attributeID = decoder.GetAttributeId( dracoGeometry, draco[ attributeIDs[ attributeName ] ] );

				if ( attributeID === - 1 ) continue;

				attribute = decoder.GetAttribute( dracoGeometry, attributeID );

			}

			const attributeResult = decodeAttribute( draco, decoder, dracoGeometry, attributeName, attributeType, attribute );

			if ( attributeName === 'color' ) {

				attributeResult.vertexColorSpace = taskConfig.vertexColorSpace;

			}

			geometry.attributes.push( attributeResult );

		}

		// Add index.
		if ( geometryType === draco.TRIANGULAR_MESH ) {

			geometry.index = decodeIndex( draco, decoder, dracoGeometry );

		}

		draco.destroy( dracoGeometry );

		return geometry;

	}

	function decodeIndex( draco, decoder, dracoGeometry ) {

		const numFaces = dracoGeometry.num_faces();
		const numIndices = numFaces * 3;
		const byteLength = numIndices * 4;

		const ptr = draco._malloc( byteLength );
		decoder.GetTrianglesUInt32Array( dracoGeometry, byteLength, ptr );
		const index = new Uint32Array( draco.HEAPF32.buffer, ptr, numIndices ).slice();
		draco._free( ptr );

		return { array: index, itemSize: 1 };

	}

	function decodeAttribute( draco, decoder, dracoGeometry, attributeName, attributeType, attribute ) {

		const numComponents = attribute.num_components();
		const numPoints = dracoGeometry.num_points();
		const numValues = numPoints * numComponents;
		const byteLength = numValues * attributeType.BYTES_PER_ELEMENT;
		const dataType = getDracoDataType( draco, attributeType );

		const ptr = draco._malloc( byteLength );
		decoder.GetAttributeDataArrayForAllPoints( dracoGeometry, attribute, dataType, byteLength, ptr );
		const array = new attributeType( draco.HEAPF32.buffer, ptr, numValues ).slice();
		draco._free( ptr );

		return {
			name: attributeName,
			array: array,
			itemSize: numComponents
		};

	}

	function getDracoDataType( draco, attributeType ) {

		switch ( attributeType ) {

			case Float32Array: return draco.DT_FLOAT32;
			case Int8Array: return draco.DT_INT8;
			case Int16Array: return draco.DT_INT16;
			case Int32Array: return draco.DT_INT32;
			case Uint8Array: return draco.DT_UINT8;
			case Uint16Array: return draco.DT_UINT16;
			case Uint32Array: return draco.DT_UINT32;

		}

	}

}
`}},__webpackgi_module_cache__={},leafPrototypes,getProto,inProgress,dataWebpackPrefix;function __webpackgi_require__(d){var o=__webpackgi_module_cache__[d];if(o!==void 0)return o.exports;var l=__webpackgi_module_cache__[d]={id:d,exports:{}};return __webpackgi_modules__[d].call(l.exports,l,l.exports,__webpackgi_require__),l.exports}__webpackgi_require__.m=__webpackgi_modules__,__webpackgi_require__.n=function(d){var o=d&&d.__esModule?function(){return d.default}:function(){return d};return __webpackgi_require__.d(o,{a:o}),o},getProto=Object.getPrototypeOf?function(d){return Object.getPrototypeOf(d)}:function(d){return d.__proto__},__webpackgi_require__.t=function(d,o){if(1&o&&(d=this(d)),8&o||typeof d=="object"&&d&&(4&o&&d.__esModule||16&o&&typeof d.then=="function"))return d;var l=Object.create(null);__webpackgi_require__.r(l);var c={};leafPrototypes=leafPrototypes||[null,getProto({}),getProto([]),getProto(getProto)];for(var u=2&o&&d;typeof u=="object"&&!~leafPrototypes.indexOf(u);u=getProto(u))Object.getOwnPropertyNames(u).forEach(function(h){c[h]=function(){return d[h]}});return c.default=function(){return d},__webpackgi_require__.d(l,c),l},__webpackgi_require__.d=function(d,o){for(var l in o)__webpackgi_require__.o(o,l)&&!__webpackgi_require__.o(d,l)&&Object.defineProperty(d,l,{enumerable:!0,get:o[l]})},__webpackgi_require__.f={},__webpackgi_require__.e=function(d){return Promise.all(Object.keys(__webpackgi_require__.f).reduce(function(o,l){return __webpackgi_require__.f[l](d,o),o},[]))},__webpackgi_require__.u=function(d){return d+".mjs"},__webpackgi_require__.o=function(d,o){return Object.prototype.hasOwnProperty.call(d,o)},inProgress={},dataWebpackPrefix="webgi:",__webpackgi_require__.l=function(d,o,l,c){if(inProgress[d])inProgress[d].push(o);else{var u,h;if(l!==void 0)for(var _=document.getElementsByTagName("script"),A=0;A<_.length;A++){var w=_[A];if(w.getAttribute("src")==d||w.getAttribute("data-webpack")==dataWebpackPrefix+l){u=w;break}}u||(h=!0,(u=document.createElement("script")).type="module",u.charset="utf-8",u.timeout=120,__webpackgi_require__.nc&&u.setAttribute("nonce",__webpackgi_require__.nc),u.setAttribute("data-webpack",dataWebpackPrefix+l),u.src=d),inProgress[d]=[o];var C=function(O,ne){u.onerror=u.onload=null,clearTimeout(M);var ce=inProgress[d];if(delete inProgress[d],u.parentNode&&u.parentNode.removeChild(u),ce&&ce.forEach(function(ue){return ue(ne)}),O)return O(ne)},M=setTimeout(C.bind(null,void 0,{type:"timeout",target:u}),12e4);u.onerror=C.bind(null,u.onerror),u.onload=C.bind(null,u.onload),h&&document.head.appendChild(u)}},__webpackgi_require__.r=function(d){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(d,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(d,"__esModule",{value:!0})},function(){var d;if(typeof import.meta.url=="string"&&(d=import.meta.url),!d)throw new Error("Automatic publicPath is not supported in this browser");d=d.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),__webpackgi_require__.p=d+"../../"}(),function(){var d={573:0};__webpackgi_require__.f.j=function(c,u){var h=__webpackgi_require__.o(d,c)?d[c]:void 0;if(h!==0)if(h)u.push(h[2]);else{var _=new Promise(function(C,M){h=d[c]=[C,M]});u.push(h[2]=_);var A=__webpackgi_require__.p+__webpackgi_require__.u(c),w=new Error;__webpackgi_require__.l(A,function(C){if(__webpackgi_require__.o(d,c)&&((h=d[c])!==0&&(d[c]=void 0),h)){var M=C&&(C.type==="load"?"missing":C.type),O=C&&C.target&&C.target.src;w.message="Loading chunk "+c+` failed.
(`+M+": "+O+")",w.name="ChunkLoadError",w.type=M,w.request=O,h[1](w)}},"chunk-"+c,c)}};var o=function(c,u){var h,_,A=u[0],w=u[1],C=u[2],M=0;if(A.some(function(O){return d[O]!==0})){for(h in w)__webpackgi_require__.o(w,h)&&(__webpackgi_require__.m[h]=w[h]);C&&C(__webpackgi_require__)}for(c&&c(u);M<A.length;M++)_=A[M],__webpackgi_require__.o(d,_)&&d[_]&&d[_][0](),d[_]=0},l=self.webpackChunkwebgi=self.webpackChunkwebgi||[];l.forEach(o.bind(null,0)),l.push=o.bind(null,l.push.bind(l))}(),__webpackgi_require__.nc=void 0;var __webpackgi_exports__={},ViewerState;__webpackgi_require__.d(__webpackgi_exports__,{CZu:function(){return AAssetManagerProcessStatePlugin},FV:function(){return three_module.FV},oK2:function(){return ACameraControlsPlugin},SLH:function(){return ACanvasRecorder},yo9:function(){return ALL_WEBGI_EXTENSIONS},YJd:function(){return AMaterialManager},qnC:function(){return ARPlacementBox},TtJ:function(){return ARPlugin},rUH:function(){return ARTouchInputHelper},oAs:function(){return AShaderMaterial2},$fV:function(){return AViewerPlugin},upe:function(){return AWSClientPlugin},yPJ:function(){return AddBlendPass},gO9:function(){return three_module.gO9},XrR:function(){return three_module.XrR},DAe:function(){return three_module.DAe},EZo:function(){return three_module.EZo},wrO:function(){return three_module.wrO},FFZ:function(){return three_module.FFZ},lGu:function(){return three_module.lGu},sKt:function(){return three_module.sKt},$p8:function(){return three_module.$p8},nJr:function(){return AmbientLight2},pPE:function(){return three_module.pPE},tz3:function(){return three_module.tz3},kEx:function(){return three_module.kEx},Iw4:function(){return three_module.Iw4},P5j:function(){return three_module.P5j},AKb:function(){return three_module.AKb},GXy:function(){return AnisotropyPlugin},ibB:function(){return three_module.ibB},nZQ:function(){return three_module.nZQ},E0M:function(){return three_module.E0M},GLG:function(){return AssetExporter},$VP:function(){return AssetExporterPlugin},NeI:function(){return AssetImporter},rzc:function(){return AssetManagerBasicPopupPlugin},Kiu:function(){return AssetManagerLoadingBarPlugin},XDT:function(){return AssetManagerPlugin},XiN:function(){return AsyncGzip},_I9:function(){return AsyncDecompress},ShE:function(){return AsyncDeflate},OXP:function(){return AsyncGunzip},JZ8:function(){return AsyncGzip},gS4:function(){return AsyncInflate},eFx:function(){return AsyncUnzipInflate},peq:function(){return AsyncUnzlib},hw0:function(){return AsyncZipDeflate},_DG:function(){return AsyncZlib},fP5:function(){return three_module.fP5},CwR:function(){return three_module.CwR},UtX:function(){return three_module.UtX},Pf$:function(){return three_module.Pf$},Am1:function(){return three_module.Am1},IzY:function(){return three_module.IzY},hsX:function(){return three_module.hsX},XFr:function(){return BackgroundPresetGroup},Eh1:function(){return BaseGroundPlugin},RJS:function(){return BaseRenderer},Rkk:function(){return three_module.Rkk},bTm:function(){return three_module.bTm},Otl:function(){return BeringRingAnimation},pOj:function(){return BlobLoader},jg0:function(){return BloomPlugin},$Kf:function(){return three_module.$Kf},YOZ:function(){return three_module.YOZ},UtB:function(){return three_module.UtB},NRn:function(){return three_module.NRn},DYt:function(){return Box3B},BND:function(){return three_module.BND},iNn:function(){return three_module.iNn},IWo:function(){return three_module.IWo},SYd:function(){return BoxSelectionWidget},THS:function(){return three_module.THS},LoY:function(){return three_module.LoY},SUR:function(){return three_module.SUR},tJf:function(){return three_module.tJf},Y3u:function(){return CSGPluginBSP},poD:function(){return CSGPluginBVH},gaG:function(){return CSGPluginBase},z0x:function(){return CSS3DRendererPlugin},l2R:function(){return three_module.l2R},i7d:function(){return three_module.i7d},mL7:function(){return CameraController},WTh:function(){return three_module.WTh},l5h:function(){return CameraUiPlugin},hzv:function(){return CameraView},f_U:function(){return CameraViewControlPlugin},sxt:function(){return CameraViewPlugin},af0:function(){return CannonPhysicsPlugin},Phj:function(){return CanvasMediaRecorder},p5D:function(){return CanvasRecorder},CS6:function(){return CanvasRecorderPlugin},aKT:function(){return CanvasSnipper},RzO:function(){return CanvasSnipperPlugin},GOR:function(){return three_module.GOR},qU7:function(){return three_module.qU7},B6O:function(){return three_module.B6O},z1d:function(){return ChromaticAberrationPlugin},nNL:function(){return three_module.nNL},tcD:function(){return three_module.tcD},ghU:function(){return three_module.ghU},Dk8:function(){return ClearcoatTintPlugin},zD7:function(){return three_module.zD7},Q1f:function(){return three_module.Q1f},T6I:function(){return three_module.T6I},ppV:function(){return three_module.ppV},FvD:function(){return CombinedPostPlugin},n3b:function(){return Gzip},iOZ:function(){return three_module.iOZ},c5h:function(){return three_module.c5h},YSM:function(){return three_module.FvD},YRT:function(){return three_module.YRT},qFE:function(){return three_module.qFE},fCM:function(){return ContactShadowGroundPlugin},afc:function(){return CoreEditorApp},hLJ:function(){return CoreViewerApp},F1T:function(){return three_module.F1T},SXA:function(){return CubeNormalsCaptureHelper},hy7:function(){return three_module.hy7},xFO:function(){return three_module.xFO},b4q:function(){return three_module.b4q},ScU:function(){return three_module.ScU},Om:function(){return three_module.Om},Z0B:function(){return three_module.Z0B},s0K:function(){return three_module.s0K},Pdi:function(){return three_module.Pdi},Vb5:function(){return three_module.Vb5},Jnc:function(){return three_module.Jnc},ywQ:function(){return three_module.ywQ},WNZ:function(){return three_module.WNZ},Ipv:function(){return three_module.Ipv},jGm:function(){return three_module.jGm},Ogy:function(){return CustomAnimationHelper},xLk:function(){return CustomAnimationHelperPlugin},bCz:function(){return three_module.bCz},bGG:function(){return CustomBumpMapPlugin},g7M:function(){return three_module.g7M},Ho_:function(){return three_module.Ho_},hjs:function(){return three_module.hjs},Zn9:function(){return DRACOLoader2.Z},AHf:function(){return k},dYF:function(){return three_module.dYF},rFo:function(){return three_module.rFo},GYF:function(){return three_module.GYF},BRH:function(){return three_module.BRH},psi:function(){return DataUrlLoader},GxU:function(){return three_module.GxU},n2t:function(){return DebugPlugin},yuL:function(){return DecodeUTF8},YMq:function(){return Decompress},ROr:function(){return three_module.ROr},fJr:function(){return three_module.fJr},h_9:function(){return three_module.h_9},Gyi:function(){return Deflate},zdS:function(){return three_module.zdS},WCV:function(){return DepthOfFieldPass},_Vf:function(){return DepthOfFieldPlugin},dcC:function(){return three_module.dcC},VCu:function(){return three_module.VCu},n1S:function(){return DeviceOrientationControls2},sOF:function(){return DeviceOrientationControlsPlugin},aFP:function(){return DiamondMaterial},GMU:function(){return DiamondPlugin},ZyN:function(){return three_module.ZyN},rFg:function(){return DirectionalLight2},PFK:function(){return three_module.PFK},Yhb:function(){return three_module.Yhb},V5c:function(){return three_module.V5c},nEu:function(){return three_module.nEu},$EB:function(){return three_module.$EB},mRE:function(){return Dropzone},hSt:function(){return DropzonePlugin},hdd:function(){return three_module.hdd},wn6:function(){return three_module.wn6},MOq:function(){return three_module.MOq},Vnu:function(){return three_module.Vnu},hIf:function(){return three_module.hIf},d5G:function(){return EXRExporter2},vr8:function(){return EXRLoadPlugin},JCs:function(){return EasingFunctions$1},TDQ:function(){return three_module.TDQ},WYq:function(){return EffectComposer2},S20:function(){return three_module.S20},LWT:function(){return EllipseCurve3D},MJ1:function(){return EncodeUTF8},KDW:function(){return EncoderMethod},SQT:function(){return EnvironmentPresetGroup},kO0:function(){return three_module.kO0},U3G:function(){return three_module.U3G},jsO:function(){return three_module.jsO},wfO:function(){return three_module.wfO},uV5:function(){return three_module.uV5},O9p:function(){return three_module.O9p},Qev:function(){return three_module.Qev},j8I:function(){return ExtrasUiPlugin},QCA:function(){return three_module.QCA},ol2:function(){return FBXLoadPlugin},y74:function(){return FFMPEGRecorder},lT0:function(){return FSShadowMaterial},Y9S:function(){return three_module.Y9S},ryq:function(){return FileTransferPlugin},xcV:function(){return FilmicGrainPlugin},OMG:function(){return FirstPersonControls2},Vkg:function(){return FirstPersonControlsPlugin},Oax:function(){return three_module.Oax},qtW:function(){return three_module.qtW},V58:function(){return three_module.V58},RQf:function(){return three_module.RQf},jUj:function(){return three_module.jUj},cRK:function(){return three_module.cRK},ziY:function(){return FragmentClippingExtensionPlugin},kzd:function(){return FragmentClippingMode},VNy:function(){return FrameFadePlugin},Pem:function(){return three_module.Pem},hB5:function(){return three_module.hB5},PPD:function(){return three_module.PPD},BH6:function(){return FullScreenPlugin},HSI:function(){return GBufferPlugin},oh6:function(){return three_module.oh6},Wyr:function(){return three_module.Wyr},Wdf:function(){return three_module.Wdf},P3V:function(){return GLTFAnimationPlugin},s0N:function(){return GLTFDracoExportPlugin},_Js:function(){return GLTFDracoExporter},xQA:function(){return GLTFExporter2},Yeh:function(){return GLTFExporterMaterialsVariantsExtensionExport},N30:function(){return GLTFKHRMaterialVariantsPlugin},P44:function(){return GLTFLoader2},MdZ:function(){return GLTFMaterialsVariantsExtensionImport},Cc9:function(){return GLTFMeshGpuInstancingExporter},HjZ:function(){return GLTFMeshOptPlugin},UX5:function(){return GLTFSpecGlossinessConverterPlugin},fGP:function(){return GLTFWriter2},T03:function(){return GammaCorrectionExtension},fPK:function(){return GammaCorrectionPlugin},XpU:function(){return GemEnvironmentPresetGroup},hUz:function(){return GenericBlendTexturePass},pbu:function(){return GenericFilterPlugin},jhn:function(){return GeometryGeneratorPlugin},eoi:function(){return three_module.eoi},K52:function(){return three_module.K52},gWB:function(){return three_module.gWB},Gwm:function(){return three_module.Gwm},TMh:function(){return three_module.TMh},RcT:function(){return three_module.RcT},fTw:function(){return three_module.fTw},Hx_:function(){return GroundPlugin},YJl:function(){return three_module.YJl},asK:function(){return Gunzip},_qo:function(){return GyroInputDevice},Ne:function(){return Gzip},Guc:function(){return HDRiGroundPlugin},ix0:function(){return three_module.ix0},dth:function(){return three_module.dth},R1W:function(){return three_module.R1W},tcR:function(){return HierarchyUiPlugin},WBB:function(){return three_module.WBB},Kzg:function(){return three_module.Kzg},$NF:function(){return three_module.$NF},NuM:function(){return ImageSequenceRecorder},HgN:function(){return three_module.HgN},l9C:function(){return Importer},HLH:function(){return three_module.HLH},Ru$:function(){return three_module.Ru$},ELl:function(){return Inflate},uWO:function(){return three_module.uWO},CmU:function(){return three_module.CmU},LuO:function(){return three_module.LuO},ZLX:function(){return three_module.ZLX},Hrb:function(){return three_module.Hrb},vmz:function(){return three_module.vmz},wvS:function(){return three_module.wvS},Yuy:function(){return three_module.Yuy},K5h:function(){return InteractionPromptPlugin},eB$:function(){return three_module.eB$},eHs:function(){return three_module.eHs},lGw:function(){return three_module.lGw},ljd:function(){return three_module.ljd},PJ3:function(){return three_module.PJ3},EQC:function(){return three_module.EQC},oVO:function(){return three_module.oVO},Yj4:function(){return KHR_TEXTURE_BASISU},ZPL:function(){return KTX2LoadPlugin},$16:function(){return KTXLoadPlugin},VVr:function(){return three_module.VVr},UJ6:function(){return three_module.UJ6},UpK:function(){return three_module.UpK},ZYb:function(){return LUTPlugin},nzx:function(){return three_module.nzx},DLJ:function(){return LayeredMaterialPlugin},zgK:function(){return three_module.zgK},vim:function(){return three_module.vim},brA:function(){return three_module.brA},TiK:function(){return three_module.TiK},xSv:function(){return three_module.xSv},CR7:function(){return three_module.CR7},kYr:function(){return three_module.kYr},veJ:function(){return three_module.veJ},FZo:function(){return three_module.FZo},Dvx:function(){return LightsUiPlugin},N1A:function(){return three_module.N1A},XkL:function(){return Line2},cZY:function(){return three_module.cZY},mrM:function(){return three_module.mrM},GZZ:function(){return three_module.GZZ},VnP:function(){return three_module.VnP},Fvt:function(){return three_module.Fvt},vK6:function(){return LineGeometry},FCc:function(){return three_module.FCc},GV4:function(){return LineMaterial},DXC:function(){return three_module.DXC},bFd:function(){return LineSegments2},n31:function(){return LineSegmentsGeometry},qIQ:function(){return three_module.qIQ},tgE:function(){return three_module.tgE},k6q:function(){return three_module.k6q},ezk:function(){return three_module.ezk},NZq:function(){return three_module.NZq},iUH:function(){return three_module.iUH},$_I:function(){return three_module.$_I},kRr:function(){return three_module.kRr},Zr2:function(){return three_module.Zr2},kyO:function(){return three_module.kyO},VxR:function(){return three_module.VxR},aHM:function(){return three_module.aHM},r6x:function(){return three_module.r6x},KPJ:function(){return three_module.KPJ},O0Q:function(){return LoadingScreenPlugin},G3T:function(){return three_module.G3T},lc7:function(){return three_module.lc7},aMy:function(){return three_module.aMy},CMB:function(){return three_module.CMB},Kzv:function(){return three_module.Kzv},kBv:function(){return three_module.kBv},T6P:function(){return MTLLoader2},imn:function(){return three_module.imn},Bhh:function(){return MaterialConfiguratorBasePlugin},q$N:function(){return MaterialConfiguratorPlugin},pzC:function(){return MaterialExtender},xbg:function(){return MaterialLibPresetGroupPresetGroup},LTv:function(){return MaterialLibraryBasePlugin},usO:function(){return MaterialLibraryPlugin},jut:function(){return three_module.jut},Jxy:function(){return MaterialManager},Kmw:function(){return MaterialPresetPlugin},jR8:function(){return MaterialPreviewGenerator},cj9:function(){return three_module.cj9},dwI:function(){return three_module.dwI},kn4:function(){return three_module.kn4},$ei:function(){return three_module.$ei},eaF:function(){return three_module.eaF},V9B:function(){return three_module.V9B},NLY:function(){return MeshBasicMaterial2},CSG:function(){return three_module.CSG},aVO:function(){return three_module.aVO},G_z:function(){return three_module.G_z},FNr:function(){return three_module.FNr},qBx:function(){return three_module.qBx},onB:function(){return MeshOptSimplifyModifierPlugin},tXL:function(){return three_module.tXL},uSd:function(){return three_module.uSd},_4j:function(){return three_module._4j},gCR:function(){return MeshStandardMaterial2},Df:function(){return three_module.Df},znC:function(){return three_module.znC},kTW:function(){return three_module.kTW},KRh:function(){return three_module.KRh},$iG:function(){return ModelStagePlugin},eti:function(){return ModelStagePresetGroup},Um5:function(){return MouseInputDevice},tF0:function(){return MultiFilterPlugin},EdD:function(){return three_module.EdD},caT:function(){return three_module.caT},hxR:function(){return three_module.hxR},a$r:function(){return three_module.a$r},$O9:function(){return three_module.$O9},Cfg:function(){return three_module.Cfg},pHI:function(){return three_module.pHI},amv:function(){return three_module.amv},eHc:function(){return three_module.eHc},HPb:function(){return three_module.HPb},XIg:function(){return three_module.XIg},jf0:function(){return three_module.jf0},y_p:function(){return three_module.y_p},dFv:function(){return NoiseBumpMaterialPlugin},Ke9:function(){return three_module.Ke9},NTi:function(){return three_module.NTi},nqf:function(){return NormalBufferPlugin},hws:function(){return NormalCaptureMaterial},jzd:function(){return three_module.jzd},bw0:function(){return three_module.bw0},klZ:function(){return three_module.klZ},Hit:function(){return three_module.Hit},DJz:function(){return OBJLoader2},UwE:function(){return ObjMtlLoadPlugin},B69:function(){return three_module.B69},QA8:function(){return Object3DModel},$xz:function(){return Object3DWidgetsPlugin},XTe:function(){return three_module.XTe},zjB:function(){return ObjectLoader2},sHL:function(){return ObjectPicker},Upe:function(){return ObjectProcessorMap},nEH:function(){return ObjectRotationPlugin},vyJ:function(){return three_module.vyJ},Ufg:function(){return three_module.Ufg},qad:function(){return three_module.qad},Nt7:function(){return three_module.Nt7},aEY:function(){return three_module.aEY},OuU:function(){return three_module.OuU},LiQ:function(){return three_module.LiQ},xYO:function(){return OrbitControls2},c07:function(){return OrbitControls3},qUd:function(){return three_module.qUd},I_i:function(){return OutlinePlugin},wqq:function(){return three_module.wqq},QP0:function(){return three_module.QP0},Wk7:function(){return three_module.Wk7},BdL:function(){return three_module.BdL},Q7O:function(){return PMREMGeneratorPlugin},uxM:function(){return ParallaxCameraControllerPlugin},N9C:function(){return ParallaxMappingPlugin},wAk:function(){return three_module.wAk},ubm:function(){return three_module.ubm},PG6:function(){return PickingPlugin},Zcv:function(){return three_module.Zcv},bdM:function(){return three_module.bdM},ZM4:function(){return three_module.ZM4},_EQ:function(){return PluginPresetGroup},HiM:function(){return three_module.HiM},RXx:function(){return PointLight2},F1l:function(){return three_module.F1l},W_W:function(){return Z},FnS:function(){return PointerLockControls2},oPt:function(){return PointerLockControlsPlugin},ONl:function(){return three_module.ONl},BH$:function(){return three_module.BH$},hzE:function(){return three_module.hzE},pFK:function(){return three_module.pFK},j9d:function(){return PopmotionPlugin},DeC:function(){return PosePlugin},xZx:function(){return three_module.xZx},ZaL:function(){return PresetGroup},UwN:function(){return PresetLibraryPlugin},hzf:function(){return ProgressivePlugin},Nwf:function(){return three_module.Nwf},N2s:function(){return three_module.N2s},dAo:function(){return three_module.dAo},CV9:function(){return three_module.CV9},PTz:function(){return three_module.PTz},MBL:function(){return three_module.MBL},GBG:function(){return three_module.GBG},HO_:function(){return three_module.HO_},Kef:function(){return three_module.Kef},sPf:function(){return three_module.sPf},N5j:function(){return three_module.N5j},GWd:function(){return three_module.GWd},c90:function(){return three_module.c90},y3Z:function(){return three_module.y3Z},uB5:function(){return three_module.uB5},lyL:function(){return three_module.lyL},bC7:function(){return three_module.bC7},ojs:function(){return three_module.ojs},S$4:function(){return three_module.S$4},qa3:function(){return three_module.qa3},B_h:function(){return three_module.B_h},czI:function(){return three_module.czI},rSH:function(){return three_module.rSH},Qrf:function(){return three_module.Qrf},psI:function(){return three_module.psI},a5J:function(){return three_module.a5J},_QJ:function(){return three_module._QJ},Fn:function(){return three_module.Fn},KDk:function(){return three_module.KDk},pBf:function(){return three_module.pBf},HXV:function(){return three_module.HXV},Nz6:function(){return three_module.Nz6},jR7:function(){return three_module.jR7},BXX:function(){return three_module.BXX},DAr:function(){return three_module.DAr},uC4:function(){return RGBM16ColorSpace_},H23:function(){return three_module.H23},W9U:function(){return three_module.W9U},CVz:function(){return three_module.CVz},Riy:function(){return three_module.Riy},kTp:function(){return three_module.kTp},k6Q:function(){return three_module.k6Q},IE4:function(){return three_module.IE4},paN:function(){return three_module.paN},TkQ:function(){return three_module.TkQ},qa1:function(){return RainbowDiamondPlugin},EZL:function(){return RandomizedDirectionalLight},fMJ:function(){return RandomizedDirectionalLightPlugin},D$Q:function(){return three_module.D$Q},RlV:function(){return three_module.RlV},tBo:function(){return three_module.tBo},z5:function(){return three_module.z5},ure:function(){return three_module.ure},VT0:function(){return three_module.VT0},ZQM:function(){return three_module.ZQM},TyI:function(){return Reflector2},Mjd:function(){return three_module.Mjd},O0B:function(){return three_module.O0B},FZz:function(){return RendererUiPlugin},GJx:function(){return three_module.GJx},kG0:function(){return three_module.kG0},nST:function(){return three_module.nST},AUf:function(){return Rhino3dmLoadPlugin},oXQ:function(){return Rhino3dmLoader2},rKP:function(){return three_module.rKP},vMJ:function(){return RootScene},CWW:function(){return three_module.CWW},XG_:function(){return three_module.XG_},er$:function(){return three_module.er$},KLL:function(){return three_module.KLL},ye:function(){return SSAOPlugin},czS:function(){return SSBevelPass},UG9:function(){return SSBevelPlugin},aJo:function(){return SSContactShadows},uC9:function(){return SSGIPlugin},k9M:function(){return SSRPlugin},fRH:function(){return STLLoadPlugin},Z58:function(){return three_module.Z58},_I4:function(){return SceneCamerasUiPlugin},Sr:function(){return SceneLoopPlugin},zx2:function(){return ScrollableCameraViewPlugin},r1V:function(){return ScrollableCameraViewPreviewPlugin},tI0:function(){return SelectionWidget},vxI:function(){return three_module.vxI},zkh:function(){return three_module.zkh},BKk:function(){return three_module.BKk},rNP:function(){return ShaderMaterial2},DkA:function(){return ShaderMaterialEncodingSupport},rpH:function(){return ShaderPass2},Q4F:function(){return ShadowMapBaker},q2:function(){return three_module.q2},ypk:function(){return three_module.ypk},MSw:function(){return three_module.MSw},Ld9:function(){return three_module.Ld9},YOp:function(){return ShapeTubeExtrudePlugin},xJ6:function(){return three_module.xJ6},fBL:function(){return three_module.fBL},XTN:function(){return SimpleAssetList},ZXl:function(){return SimpleBackgroundEnvUiPlugin},O9e:function(){return SimpleDataSource},ILd:function(){return I},SQN:function(){return SimpleJSONExporter},GDD:function(){return SimpleJSONLoader},HVh:function(){return SimpleTextExporter},X46:function(){return SimpleTextPlugin},hdr:function(){return SimpleViewerUi},CSJ:function(){return SimplifyModifierPlugin},EAD:function(){return three_module.EAD},_xc:function(){return three_module._xc},I46:function(){return three_module.I46},CSm:function(){return SnowFallPlugin},kLi:function(){return three_module.kLi},iyt:function(){return three_module.iyt},Gu$:function(){return three_module.Gu$},s6s:function(){return SphereSelectionWidget},YHV:function(){return three_module.YHV},xOk:function(){return three_module.xOk},xfg:function(){return three_module.xfg},nCl:function(){return three_module.nCl},Hs2:function(){return SpotLight2},Fpm:function(){return three_module.Fpm},kxk:function(){return three_module.kxk},RoJ:function(){return three_module.RoJ},ie2:function(){return three_module.ie2},hgQ:function(){return three_module.hgQ},f4X:function(){return three_module.f4X},Hrq:function(){return three_module.Hrq},agE:function(){return three_module.agE},uXQ:function(){return three_module.uXQ},keZ:function(){return three_module.keZ},rOG:function(){return three_module.rOG},Ktl:function(){return three_module.Ktl},uov:function(){return three_module.uov},hZF:function(){return three_module.hZF},FXf:function(){return three_module.FXf},Kwu:function(){return three_module.Kwu},hv1:function(){return SwitchNodeBasePlugin},AqU:function(){return SwitchNodePlugin},wtR:function(){return three_module.wtR},cGs:function(){return R},bI3:function(){return three_module.bI3},afA:function(){return TemporalAAPlugin},Zpd:function(){return three_module.Zpd},gO_:function(){return TextSVGOptions},gPd:function(){return three_module.gPd},Tap:function(){return three_module.Tap},k4W:function(){return ThinFilmLayerPlugin},ndu:function(){return ThreeMaterialLoader},el_:function(){return TonemapPlugin},O3Y:function(){return three_module.O3Y},UPV:function(){return three_module.UPV},iu6:function(){return TrackballControlsPlugin},Ijk:function(){return TransformAnimationPlugin},ZU6:function(){return TransformControls},XXP:function(){return TransformControls2},RQH:function(){return TransformControlsGizmo},tUF:function(){return TransformControlsPlane},Tww:function(){return TransfrSharePlugin},lMl:function(){return three_module.lMl},rYR:function(){return three_module.rYR},O49:function(){return three_module.O49},RJ4:function(){return three_module.RJ4},CXS:function(){return TriplanarUVMappingPlugin},j6:function(){return three_module.j6},G8g:function(){return TubeShapeGeometry},SOP:function(){return TweakpaneUiPlugin$1},e2_:function(){return TweakpaneWrapper},GTy:function(){return three_module.GTy},cOZ:function(){return UChartOptions},XxD:function(){return UPackOptions},UTZ:function(){return three_module.UTZ},A$4:function(){return three_module.A$4},MW4:function(){return three_module.MW4},baL:function(){return three_module.baL},fc6:function(){return three_module.fc6},t7h:function(){return Uncharted2Tonemapping},nc$:function(){return three_module.nc$},dzP:function(){return three_module.dzP},fCn:function(){return three_module.fCn},LlO:function(){return three_module.LlO},OUM:function(){return three_module.OUM},V3x:function(){return three_module.V3x},bkx:function(){return three_module.bkx},Wew:function(){return three_module.Wew},gJ2:function(){return three_module.gJ2},cHt:function(){return three_module.cHt},HJp:function(){return Unzip},mMi:function(){return UnzipInflate},XLH:function(){return UnzipPassThrough},TWi:function(){return Unzlib},DcJ:function(){return VJSONPresetGroup},Kmx:function(){return VRPluginBasic},RyA:function(){return three_module.RyA},NPD:function(){return VariationConfiguratorEditorUiPlugin},Gpr:function(){return VariationConfiguratorGridUiPlugin},mKI:function(){return VariationConfiguratorPlugin},I9Y:function(){return three_module.I9Y},Pq0:function(){return three_module.Pq0},IUQ:function(){return three_module.IUQ},RiT:function(){return three_module.RiT},Xkr:function(){return VelocityBufferPlugin},Nv2:function(){return three_module.Nv2},EW5:function(){return ViewerApp},oJ0:function(){return ViewerState},Q1b:function(){return VignettePlugin},jK_:function(){return VirtualCamerasPlugin},gTm:function(){return WaveGroundPlugin},S3G:function(){return three_module.S3G},ALV:function(){return three_module.ALV},y9J:function(){return three_module.y9J},TdN:function(){return three_module.TdN},o6l:function(){return three_module.o6l},AT1:function(){return three_module.AT1},nWS:function(){return three_module.nWS},JeP:function(){return three_module.JeP},hfX:function(){return three_module.hfX},i7u:function(){return three_module.i7u},b5D:function(){return WebGiViewerElement},Z1R:function(){return WindowiseDialogPlugin},pWZ:function(){return Wireframe},XJ7:function(){return three_module.XJ7},r3D:function(){return WireframeGeometry2},dhZ:function(){return three_module.dhZ},$Tl:function(){return XAtlasPlugin},rQf:function(){return three_module.rQf},ojh:function(){return three_module.ojh},h2z:function(){return three_module.h2z},kqe:function(){return three_module.kqe},qQr:function(){return Zip},D8L:function(){return ZipDeflate},p9O:function(){return ZipLoader},uZB:function(){return ZipPassThrough},KK:function(){return Zlib},Ua6:function(){return three_module.Ua6},TYE:function(){return et},rQr:function(){return addBasePlugins},$00:function(){return addBloomData},ued:function(){return addDracoLoader},p$A:function(){return addEditorPlugins},m2A:function(){return addGLTFExporter},MqB:function(){return addGLTFLoader},Dv6:function(){return addLUTData},f9i:function(){return addRGBELoader},qHA:function(){return addSSBevel},sQz:function(){return Pe},G52:function(){return Te},EP1:function(){return afterMain},v5N:function(){return afterRead},SET:function(){return afterWrite},g7h:function(){return angle},i0Z:function(){return animate},GcL:function(){return animateAsync},z67:function(){return animateObject},im4:function(){return animateSet},$bx:function(){return animateTarget},btx:function(){return anticipate},M7c:function(){return applyOffset},ZMO:function(){return modifiers_applyStyles},YiG:function(){return ie},UE8:function(){return modifiers_arrow},uHr:function(){return attract},YYK:function(){return attractExpo},qZL:function(){return auto},XMb:function(){return autoCenterObject3D},utC:function(){return autoGPUInstanceMeshes},uO_:function(){return autoScaleObject3D},dgX:function(){return backIn},ZZ5:function(){return backInOut},Szj:function(){return backOut},Ms4:function(){return re},OMj:function(){return basePlacements},D7g:function(){return basicMaterialPropList},LG_:function(){return beforeMain},cis:function(){return beforeRead},pAB:function(){return beforeWrite},y80:function(){return q},sQg:function(){return bottom},ipZ:function(){return bounceIn},wmn:function(){return bounceInOut},Tel:function(){return bounceOut},Q5:function(){return buildCSGMeshBSP},b1j:function(){return buildCSGMeshBVH},wzf:function(){return cLinearToRGBM},Cq_:function(){return cRGBMToLinear},poN:function(){return circIn},tnX:function(){return circInOut},yT:function(){return circOut},qE8:function(){return clamp},WYS:function(){return clippingParents},Cp1:function(){return be},mz1:function(){return combineDofShader},Bc:function(){return gzip},oSR:function(){return gzipSync},KJu:function(){return computeAverageGeometryNormal},G1I:function(){return computeEigenVectors},dXm:function(){return computeGeometryCenter},lRj:function(){return computeGeometrySize},WL9:function(){return computeMikkTSpaceTangents},OkM:function(){return computeMorphedAttributes},kRU:function(){return computeOffsetMatrix},Xpo:function(){return computeScreenSpaceBoundingBox},KCp:function(){return modifiers_computeStyles},a17:function(){return copyMaterialUserData},prl:function(){return copyObject3DUserData},ij0:function(){return xe},MjE:function(){return copyTextureUserData},bhJ:function(){return createAnticipate},nMR:function(){return createAttractor},p4x:function(){return createBackIn},lPF:function(){return three_module.lPF},SwP:function(){return ee},U2C:function(){return createExpoIn},FOd:function(){return createGenericExtensionClass},WOM:function(){return createIFrameCSS3DObject},mFw:function(){return T},n4h:function(){return popper_createPopper},eRo:function(){return createPopper},LsR:function(){return popper_lite_createPopper},tJ:function(){return createRenderTargetKey},bES:function(){return te},rU:function(){return P},omb:function(){return csgOperations},AHW:function(){return $},AKs:function(){return cubicBezier},VxZ:function(){return dataTextureFromColor},GRd:function(){return dataTextureFromVec4},TVt:function(){return decay},mFv:function(){return decompress},RqU:function(){return decompressSync},UKN:function(){return Se},mmZ:function(){return deepCloneAttribute},Ikv:function(){return defaultPresets},Kcl:function(){return deflate},pdh:function(){return deflateSync},tRv:function(){return degreesToRadians},nNY:function(){return deinterleaveAttribute},LK7:function(){return deinterleaveGeometry},$q:function(){return deserializeObject},vem:function(){return deserializers},__B:function(){return detectOverflow},BF2:function(){return diamondMaterialPropList},IoC:function(){return distance},WNF:function(){return N},PE3:function(){return me},a6C:function(){return easeIn},am_:function(){return easeInOut},vTE:function(){return easeOut},VAT:function(){return Ze},_N2:function(){return end},oib:function(){return envMapBackground},NtM:function(){return F},ru_:function(){return estimateBytesUsed},GcD:function(){return eventListeners},pJG:function(){return extractAnimationKey},vxL:function(){return flattenUiConfig},UUz:function(){return modifiers_flip},mlk:function(){return fontFormatExtensionMap},SVi:function(){return generateUiConfig},QXJ:function(){return generateUiFolder},D01:function(){return Me},$7C:function(){return le},cdn:function(){return Ue},vGk:function(){return Re},GPz:function(){return Ee},NxN:function(){return H},o7j:function(){return getTexelDecoding},yqR:function(){return getTexelDecodingFunction},U_j:function(){return getTextureDataType},mB_:function(){return se},d6c:function(){return rt},zhG:function(){return glbEncryptionPreparser},HJb:function(){return fe},e5R:function(){return gltfExporterMaterialsVariantsExtensionExport},kdR:function(){return gunzip},D85:function(){return gunzipSync},ZIX:function(){return gzip},u3y:function(){return gzipSync},jDu:function(){return modifiers_hide},qyt:function(){return de},Dtr:function(){return Qe},WKP:function(){return je},fJV:function(){return z},tC7:function(){return iGeometryIgnoredUserData},Uan:function(){return iMaterialIgnoredUserData},Uct:function(){return iModelIgnoredUserData},K_U:function(){return iTextureIgnoredUserData},BFA:function(){return Ne},BHX:function(){return We},Pee:function(){return V},$If:function(){return He},RFY:function(){return Ce},Buv:function(){return inertia},UDz:function(){return inflate},HMP:function(){return inflateSync},Zg4:function(){return interleaveAttributes},GWP:function(){return interpolate},r58:function(){return isAnimatableType},fTC:function(){return isPoint},YWz:function(){return isPoint3D},eAs:function(){return W},i7C:function(){return keyframes},jFo:function(){return khrMaterialsVariantsGLTF},kbd:function(){return left},nU8:function(){return lerpAngle},NFx:function(){return lerpAngle2},sns:function(){return linear},S2G:function(){return he},iW4:function(){return main},Se$:function(){return Je},Sop:function(){return Ge},HNH:function(){return makeFilter},jGz:function(){return makeSamplerUi},ll7:function(){return makeSetterFor},SrG:function(){return Xe},UGD:function(){return matDefine},KVf:function(){return mergeAttributes},gDN:function(){return mergeBufferAttributes},h0o:function(){return mergeBufferGeometries},pPQ:function(){return mergeGeometries},hLo:function(){return mergeGroups},ecu:function(){return mergeVertices},mhB:function(){return mirrorEasing},jhA:function(){return mix},iou:function(){return mixColor},JL8:function(){return mixComplex},G8Z:function(){return we},GMB:function(){return modifierPhases},tB5:function(){return g},GnX:function(){return v},cYW:function(){return modifiers_offset},k9K:function(){return x},CTC:function(){return ze},JW6:function(){return Ae},p7C:function(){return ae},OId:function(){return patchShaderEncodingSupport},CN_:function(){return ot},uaX:function(){return physicalMaterialPropList},FsL:function(){return pipe},gtD:function(){return pivotToBBoxCenter},wbL:function(){return pivotToPoint},DDu:function(){return enums_placements},O$W:function(){return pointFromVector},xfb:function(){return popper},UD3:function(){return popperGenerator},ZoD:function(){return modifiers_popperOffsets},hQ_:function(){return pe},V7C:function(){return modifiers_preventOverflow},Sow:function(){return processViewer},qB0:function(){return progress},nv6:function(){return radiansToDegrees},LF4:function(){return enums_read},TAg:function(){return Fe},irg:function(){return reference},Ei4:function(){return ct},Grb:function(){return removeDuplicateGeometries},yhl:function(){return f},Gmo:function(){return reverseEasing},pGT:function(){return right},Gsh:function(){return rotateDuplicatedMesh},S2Q:function(){return three_module.S2Q},pUp:function(){return S},sU3:function(){return serializable},lKg:function(){return serialize},gwL:function(){return serializeObject},EBS:function(){return serializeTextureInExtras},YCG:function(){return serializers},gC:function(){return setMeshGeometry},R5k:function(){return setMeshMaterial},zB$:function(){return setThreeRendererMode},dGw:function(){return st},tNl:function(){return setupCoreWebGiViewer},AAd:function(){return setupIModel},YFt:function(){return setupModesStyles},IRk:function(){return setupModesUi},ZVX:function(){return setupObject3dModel},cTN:function(){return setupSandboxWebGiEditor},PlU:function(){return shaderReplaceString},Mi5:function(){return sign2},nuN:function(){return slerp},Jp2:function(){return smooth},oDA:function(){return smoothFrame},n$K:function(){return snap},w4b:function(){return snapObject},JVv:function(){return sphericalFromObject},ozl:function(){return spring},asH:function(){return standardMaterialPropList},niF:function(){return start},CiD:function(){return steps_steps},heq:function(){return strFromU8},_uk:function(){return strToU8},xrZ:function(){return supportsRequestStreams},aUi:function(){return L},Tmf:function(){return J},AYr:function(){return B},SVO:function(){return texImageToCanvas},mBH:function(){return textureDataToImageData},z73:function(){return textureToCanvas},cyN:function(){return textureToDataUrl},wRz:function(){return X},pbX:function(){return toCreasedNormals},nIf:function(){return toDecimal},RY5:function(){return toIndexedGeometry},SnO:function(){return oe},_cJ:function(){return toTrianglesDrawMode},Mny:function(){return enums_top},X0G:function(){return uiButton},mBY:function(){return uiColor},rpQ:function(){return uiConfig},exO:function(){return uiDropdown},rsv:function(){return uiFolder},gpt:function(){return uiImage},hEL:function(){return uiInput},LIx:function(){return uiMonitor},Z5F:function(){return uiPanel},Eiw:function(){return uiSlider},Jx6:function(){return uiToggle},q00:function(){return uiVector},PiW:function(){return uniform},$15:function(){return unzip},AOo:function(){return unzipSync},VTi:function(){return unzlib},a8Y:function(){return unzlibSync},QMY:function(){return ge},d5o:function(){return vLinearToRGBM},Fxe:function(){return vRGBMToLinear},Nan:function(){return valueToUiType},Ols:function(){return variationPlacements},Ovn:function(){return velocityPerFrame},fjO:function(){return velocityPerSecond},pZl:function(){return Be},R9T:function(){return viewport},LV7:function(){return wrap},M98:function(){return write},_h9:function(){return $e},yU6:function(){return zip},LaF:function(){return zipSync},w58:function(){return zlib},$ax:function(){return zlibSync}}),function(d){d[d.Error=-2]="Error",d[d.Destroyed=-1]="Destroyed",d[d.None=0]="None",d[d.Running=1]="Running",d[d.Paused=2]="Paused"}(ViewerState||(ViewerState={}));class I{constructor(){this._eventListeners={},this.dispatchEvent=this.dispatchEvent.bind(this),this.addEventListener=this.addEventListener.bind(this),this.removeEventListener=this.removeEventListener.bind(this),this.hasEventListener=this.hasEventListener.bind(this)}addEventListener(o,l){const c=this._eventListeners;c[o]===void 0&&(c[o]=[]),c[o].includes(l)||c[o].push(l)}hasEventListener(o,l){const c=this._eventListeners;return c[o]!==void 0&&c[o].includes(l)}removeEventListener(o,l){const c=this._eventListeners[o];if(c!==void 0){const u=c.indexOf(l);u!==-1&&c.splice(u,1)}}dispatchEvent(o){const l=this._eventListeners[o.type];if(l!==void 0){o.target=this;const c=l.slice(0);for(let u=0,h=c.length;u<h;u++)c[u].call(this,o)}}}async function X(d){return new Promise(o=>setTimeout(o,Math.max(0,d)))}function g(){return(typeof performance>"u"?Date:performance).now()}class Z extends I{constructor(){super(...arguments),this._onPointerDown=o=>{if(o.button!==0||!this._element)return;this._pointerUp=void 0;const l=o.clientX/this._element.clientWidth*2-1,c=-o.clientY/this._element.clientHeight*2+1,u=g();this._pointerDown={x:l,y:c,time:u},this._pointer=this._pointerDown,this.dispatchEvent({type:"dragStart",pointer:this._pointerDown})},this._onPointerMove=o=>{if(!this._pointerDown||!this._pointer||!this._element)return;const l=o.clientX/this._element.clientWidth*2-1,c=-o.clientY/this._element.clientHeight*2+1,u=g();this.dispatchEvent({type:"drag",pointer:this._pointer,drag:{x:l-this._pointerDown.x,y:c-this._pointerDown.y,time:u-this._pointerDown.time},delta:{x:l-this._pointer.x,y:c-this._pointer.y,time:u-this._pointer.time}}),this._pointer={x:l,y:c,time:g()},o.buttons%2==0&&this._onPointerUp(o)},this._onPointerUp=o=>{if(o.button!==0||!this._pointerDown||!this._element)return;const l=o.clientX/this._element.clientWidth*2-1,c=-o.clientY/this._element.clientHeight*2+1,u=g();this._pointerUp={x:l,y:c,time:u},this.dispatchEvent({type:"dragEnd",pointer:this._pointerUp,drag:{x:this._pointerUp.x-this._pointerDown.x,y:this._pointerUp.y-this._pointerDown.y,time:this._pointerUp.time-this._pointerDown.time}}),this._pointerDown=void 0,this._pointer=void 0}}get element(){return this._element}set element(o){this._element!==o&&(this._element&&this._removeElement(),this._element=o,this._element&&this._addElement())}_removeElement(){var o,l,c,u,h;(o=this._element)==null||o.removeEventListener("pointerdown",this._onPointerDown),(l=this._element)==null||l.removeEventListener("pointermove",this._onPointerMove),(c=this._element)==null||c.removeEventListener("pointerup",this._onPointerUp),(u=this._element)==null||u.removeEventListener("pointercancel",this._onPointerUp),(h=this._element)==null||h.removeEventListener("pointerout",this._onPointerUp)}_addElement(){var o,l,c,u,h;(o=this._element)==null||o.addEventListener("pointerdown",this._onPointerDown),(l=this._element)==null||l.addEventListener("pointermove",this._onPointerMove),(c=this._element)==null||c.addEventListener("pointerup",this._onPointerUp),(u=this._element)==null||u.addEventListener("pointercancel",this._onPointerUp),(h=this._element)==null||h.addEventListener("pointerout",this._onPointerUp)}dispose(){this.element=void 0}}class Q{constructor(o){this.options={limit:500,debug:!1,bindHotKeys:!1},this.enabled=!0,this.presets={},this._keyDown=l=>{if(!this.enabled)return;const c=l.ctrlKey||l.metaKey;l.code==="KeyZ"&&c&&!l.shiftKey?this.undo():(l.code==="KeyZ"&&c&&l.shiftKey||l.code==="KeyY"&&l.ctrlKey)&&this.redo()},Object.assign(this.options,o),this.limit=o.limit,this.options=o,this.reset(),o.bindHotKeys&&this.bindHotKeys(),this.log(`Initialized with stack limit of ${this.limit} commands`)}bindHotKeys(){return this.log("Bound 'undo' and 'redo' actions to 'Ctrl/Cmd+Z', 'Ctrl+Y' & 'Ctrl/Cmd+Shift+Z' hot keys"),(this.options.hotKeyRoot??document).addEventListener("keydown",this._keyDown),this}dispose(){return(this.options.hotKeyRoot??document).removeEventListener("keydown",this._keyDown),this.reset()}record(o){return this.enabled?(this._record(o),this):this}replaceLast(o){const l=this.peek();if(l)return this.log("replace",l,"with",o),this.stack[this.sp]=o,this}execute(o){if(!this.enabled)return;let l=this._rc(o),c=l.redo;return this.record.apply(this,l),this.log("Executing function..."),c.apply(o),this}_rc(o){if(o.type){const l=this.presets[o.type];if(typeof l=="function")return l(o);throw console.error(o,l,this.presets),new Error("Preset command not found")}return o}_record(o){this.enabled&&(this.log("Recording command",o),this._rebase(),this.stack.push(o),this.sp++,this._keepLimit())}_rebase(){this.canRedo()&&(this.stack.length=this.sp+1)}_keepLimit(){if(this.stack.length<=this.limit)return;let o=this.stack.length-this.limit;this.log("Stack size reached its limit: ${this.limit} commands. Cutting off most old commands..."),o===1?this.stack.shift():this.stack.splice(0,o),this.sp-=o}undo(){if(!this.canUndo())return this;let o=this.stack[this.sp];return this.log("undo"),this.sp--,this._rc(o).undo(),this}canUndo(){return this.sp>=0&&this.enabled}peek(){return this.canUndo()?this.stack[this.sp]:null}redo(){if(!this.canRedo())return this;let o=this.stack[this.sp+1];return this.log("redo"),this.sp++,this._rc(o).redo(),this}canRedo(){return this.sp<this.stack.length-1&&this.enabled}peekForward(){return this.canRedo()?this.stack[this.sp+1]:null}setLimit(o){let l=this.stack.length-this.sp-1;if(o<1||typeof o!="number")throw new TypeError(`JSUndoManager.setLimit(): unexpected argument limit=${o}. Should be a positive number`);return o<l?console.warn(`JSUndoManager.setLimit(): cannot set stack limit (${o}) less than the number of 'redoable' commands (${l})`):(this.limit=Math.floor(o),this._keepLimit()),this}reset(){return this.log("reset"),this.stack=[],this.sp=-1,this}isEmpty(){return!this.stack.length}isFull(){return this.stack.length===this.limit}getSize(){return this.stack.length}log(o,...l){this.options.debug&&console.log(`Command Manager: ${o}`,...l)}}const p=class fp{constructor(o=fp.DECAY_MILLISECONDS){this.velocity=0,this.naturalFrequency=0,this.setDecayTime(o)}setDecayTime(o){this.naturalFrequency=1/Math.max(fp.MIN_DECAY_MILLISECONDS,o)}update(o,l,c,u){const h=2e-4*this.naturalFrequency;if(o==null||u===0||o===l&&this.velocity===0)return l;if(c<0)return o;const _=o-l,A=this.velocity+this.naturalFrequency*_,w=_+c*A,C=Math.exp(-this.naturalFrequency*c),M=(A-this.naturalFrequency*w)*C,O=-this.naturalFrequency*(M+A*C);return Math.abs(M)<h*Math.abs(u)&&O*_>=0?(this.velocity=0,l):(this.velocity=M,l+w*C)}};p.SETTLING_TIME=1e4,p.MIN_DECAY_MILLISECONDS=.001,p.DECAY_MILLISECONDS=50;let k=p;function j(){const d=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return d.style.display="block",d}function ee({innerHTML:d="",id:o,classList:l,addToBody:c=!0,elementTag:u="div"}){const h=document.createElement(u);return o&&(h.id=o),h.innerHTML=d,l&&h.classList.add(...l),c&&document.body.appendChild(h),h}async function T(d){return new Promise((o,l)=>{const c=new Image;c.onload=()=>o(c),c.onerror=l,c.crossOrigin="anonymous",c.decoding="sync",c.src=d})}function P(d,o=document.head){const l=document.createElement("style");return l.type="text/css",l.innerText=d,o==null||o.appendChild(l),l}async function te(d,o=document.head){return new Promise((l,c)=>{const u=document.createElement("script");u.setAttribute("src",d),u.addEventListener("load",()=>l(u)),u.addEventListener("error",c),o.appendChild(u)})}function ie(d){if(!window)return console.warn("window is required"),"";let o="";const l=new Uint8Array(d),c=l.byteLength;for(let u=0;u<c;u++)o+=String.fromCharCode(l[u]);return window.btoa(o)}function re(d){if(!window)return console.warn("window is required"),new Uint8Array(0);const o=window.atob(d),l=o.length,c=new Uint8Array(l);for(let u=0;u<l;u++)c[u]=o.charCodeAt(u);return c.buffer}const R={Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array};function se(d,o){return new R[d](o)}function oe(d){return d.replace(/\w\S*/g,function(o){return o.charAt(0).toUpperCase()+o.substr(1).toLowerCase()})}function ae(d){if(!d||d===""||d.match(/__MACOSX\/.*\._/))return"";const o=(d=d.replace(/\?.*$/,"")).split(/[\\/]/).pop()??"",l=o.lastIndexOf(".");return o===""||l<1?"":o.slice(l+1)}function le(d){return d.substring(d.lastIndexOf("/")+1)}function F(d){return d.replace(/([.*+?^=!:${}()|[\]/\\])/g,"\\$1")}function f(d,o,l){return d.replace(new RegExp(F(o),"g"),l)}function he(d){return d.sort(),d[0].split("").map((o,l)=>d[d.length-1][l]===o?o:"\0").join("").split("\0").at(0)||""}const fe=(d,...o)=>String.raw({raw:d},...o),$=(d,...o)=>String.raw({raw:d},...o),de=(d,...o)=>String.raw({raw:d},...o),B=(d,...o)=>{let l=String.raw({raw:d},...o);return l=f(l,"%","%25"),l=f(l,"> <","><"),l=f(l,"; }",";}"),l=f(l,"<","%3c"),l=f(l,">","%3e"),l=f(l,'"',"'"),l=f(l,"#","%23"),l=f(l,"{","%7b"),l=f(l,"}","%7d"),l=f(l,"|","%7c"),l=f(l,"^","%5e"),l=f(l,"`","%60"),l=f(l,"@","%40"),l=f(l,"&","&amp;"),l=f(l,`
`,"%0A"),"data:image/svg+xml;charset=UTF-8,"+l};function pe(d=document.head){return P($`
      ::-webkit-scrollbar
      {
        width: 8px;  /* for vertical scrollbars */
        height: 8px; /* for horizontal scrollbars */
      }
      ::-webkit-scrollbar-track
      {
        background: rgba(64, 64, 64, 0.4);
        border-radius: 6px;
      }
      ::-webkit-scrollbar-thumb
      {
        background: rgba(128, 128, 128, 0.2);
        border-radius: 6px;
      }
      ::-webkit-scrollbar-corner {background: rgba(0,0,0,0.5);}
    `,d)}function N(d,o){const l=window.URL.createObjectURL(d),c=document.createElement("a");c.style.display="none",c.href=l,c.download=o,document.body.appendChild(c),c.click(),setTimeout(()=>{document.body.removeChild(c),window.URL.revokeObjectURL(l)},1e3)}async function q(d){return new Promise((o,l)=>{const c=new FileReader;c.onload=u=>o(c.result),c.onerror=u=>l(c.error),c.onabort=u=>l(new Error("Read aborted")),c.readAsDataURL(d)})}function me(d,o){return N(d,o??d.name)}async function ge(d=!1,o=!1,l){const c=document.createElement("input");c.type="file",c.multiple=d,c.accept=l||"*",c.webkitdirectory=o,c.style.display="none",document.body.appendChild(c),c.click();const u=await new Promise(h=>{c.onchange=_=>{h(Array.from(c.files||[]))}});return document.body.removeChild(c),u}function we(){let d=!1;return function(o){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(o)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(o.substr(0,4)))&&(d=!0)}(navigator.userAgent||navigator.vendor||window.opera),d}function ve(d){return d<.0031308?12.92*d:1.055*Math.pow(d,.41666)-.055}function be(d,o=1,l=1){const c=document.createElement("canvas");c.width=o,c.height=l;const u=c.getContext("2d");u.fillStyle="#"+d,u.fillRect(0,0,o,l);const h=c.toDataURL();return c.remove(),h}function H(d,o){let l;do l=Object.getOwnPropertyDescriptor(d,o);while(!l&&(d=Object.getPrototypeOf(d)));return l}function W(d,o,l=!0,c=!1){const u=H(d,o);return!(u==null||!u.set)||l&&(u==null?void 0:u.writable)!==!1&&(u==null?void 0:u.get)===void 0||c&&!u}function S(d,o,l,c=!0,u=!1){return!(!d||!W(d,o,c,u)||(d[o]=l,0))}function Ee(d,...o){return typeof d=="function"&&(d=d(...o)),d}function xe(d,o,l){for(const c of l){const u=d[c];u!==void 0&&S(o,c,u,!0)}return o}function Ce(d,o){for(const l of o)if(!d.includes(l))return!1;return!0}function Se(d,o,l=!1){for(typeof d=="string"&&(d=d.split("."));d.length>0;){if(!o)return o;const c=d.splice(0,1)[0];if(!(c.length<1))if(Array.isArray(o))o=o[parseInt(c)];else{if(typeof o!="object"||!(c in o)){if(l)throw new Error("invalid access, check "+c+" in "+o);return}o=o[c]}}return o}function Ue(d,o){return Object.keys(d).find(l=>d[l]===o)}function v(d,o){return Object.hasOwn?Object.hasOwn(d,o):d.hasOwnProperty(o)}const m=class nh{static callFunction(o,l,c=[]){if(!l)return o(...c);if(o.name&&l[o.name]===o)return o.call(l,...c);nh.methodMap.has(l)||nh.methodMap.set(l,new WeakMap);const u=nh.methodMap.get(l);if(!u.has(o)){let h=l;for(;h;){const _=Object.values(Object.getOwnPropertyDescriptors(h));for(let A of _)if(A.value===o)return u.set(o,!0),o.call(l,...c);h=Object.getPrototypeOf(h)}u.set(o,!1)}return u.get(o)?o.call(l,...c):o(...c)}};m.methodMap=new WeakMap;let E=m;function x(d,o="param"){if(!d)throw new Error("onChange: fnKey is undefined, make sure the function exists or provide a string");return(l,c,u)=>{const h={get(){return this[`_oc_${c}`]},set(_){var A;const w=this[`_oc_${c}`];if(w===_)return;this[`_oc_${c}`]=_;const C=o==="param"?[c,_,w,this]:o==="object"?[{key:c,value:_,oldValue:w,target:this}]:[];typeof d=="string"?(A=this[d])==null||A.call(this,...C):typeof d=="function"&&E.callFunction(d,this,C)}};if(u)return v(u,"value")&&delete u.value,v(u,"writable")&&delete u.writable,v(u,"initializer")&&delete u.initializer,Object.assign(u,h);Object.defineProperty(l,c,h)}}function ze(d,o="void"){if(!d)throw new Error("onChange: fnKey is undefined, make sure the function exists or provide a string");return x(d,o)}function Ae(d,o="object"){if(!d)throw new Error("onChange: fnKey is undefined, make sure the function exists or provide a string");return x(d,o)}async function Te(d,o,l){const c=typeof o=="string"?new TextEncoder().encode(o):o,u=await crypto.subtle.digest("SHA-256",c),h=crypto.getRandomValues(new Uint8Array(12)),_=Array.from(h).map(Oe=>String.fromCharCode(Oe)).join(""),A={name:"AES-GCM",iv:h},w=await crypto.subtle.importKey("raw",u,A,!1,["encrypt"]),C=typeof d=="string"?new TextEncoder().encode(d):d,M=await crypto.subtle.encrypt(A,w,C),O=new Uint8Array(M),ne=Array.from(O),ce=ne.map(Oe=>String.fromCharCode(Oe)).join(""),ue=l?typeof l=="string"?l:new TextDecoder().decode(l):"",ye=l?typeof l=="string"?new TextEncoder().encode(l):Array.from(l):[];return typeof d=="string"?ue+_+ce:new Uint8Array([...ye,...h,...ne])}async function Pe(d,o){const l=typeof o=="string"?new TextEncoder().encode(o):o,c=await crypto.subtle.digest("SHA-256",l),u=d.slice(0,12),h={name:"AES-GCM",iv:typeof u=="string"?new Uint8Array(Array.from(u).map(C=>C.charCodeAt(0))):u},_=await crypto.subtle.importKey("raw",c,h,!1,["decrypt"]),A=d.slice(12),w=typeof A=="string"?new Uint8Array(Array.from(A).map(C=>C.charCodeAt(0))):A;try{const C=await crypto.subtle.decrypt(h,_,w);return typeof d=="string"?new TextDecoder().decode(C):new Uint8Array(C)}catch{throw new Error("Decrypt failed")}}async function Me(){return"showOpenFilePicker"in window?window.showOpenFilePicker().then(d=>d[0]):window.chooseFileSystemEntries()}function Re(){if("showSaveFilePicker"in window){const d={types:[{description:"Text file",accept:{"text/plain":[".txt"]}}]};return window.showSaveFilePicker(d)}return window.chooseFileSystemEntries({type:"save-file",accepts:[{description:"Text file",extensions:["txt"],mimeTypes:["text/plain"]}]})}function Fe(d){return d.text?d.text():K(d)}function K(d){return new Promise(o=>{const l=new FileReader;l.addEventListener("loadend",c=>{const u=(c.srcElement||c.target).result;o(u)}),l.readAsText(d)})}async function $e(d,o){if(d.createWriter){const c=await d.createWriter();return await c.write(0,o),void await c.close()}const l=await d.createWritable();await l.write(o),await l.close()}async function Be(d,o){const l={};return o&&(l.writable=!0,l.mode="readwrite"),await d.queryPermission(l)==="granted"||await d.requestPermission(l)==="granted"}function U(d,o=8192,l=!1){var c;if(!d.width||!d.height)throw new Error("Invalid bitmap");const u=document.createElement("canvas");u.width=Math.min(o,d.width),u.height=Math.floor(1+u.width*d.height/d.width);const h=d instanceof ImageBitmap,_=h&&l&&Math.abs(u.width-d.width)<.5?u.getContext("bitmaprenderer"):void 0;return _?_.transferFromImageBitmap(d):(c=u.getContext("2d"))==null||c.drawImage(d,0,0,u.width,u.height),h&&l&&d.close(),u}function Ne(d,o=8192,l=!1,c="image/png"){if(!d.width||!d.height)return"";const u=U(d,o,!1),h=u.toDataURL(c);return u.remove(),l&&d instanceof ImageBitmap&&d.close(),h}async function He(d){return new Promise((o,l)=>{const c=new Image;c.addEventListener("load",()=>{const u=document.createElement("canvas");u.width=c.width,u.height=c.height;const h=u.getContext("2d");if(!h)return void l(new Error("Could not get 2d context"));h.drawImage(c,0,0,u.width,u.height);const _=h.getImageData(0,0,u.width,u.height);o(_),u.remove(),c.remove()},!1),c.addEventListener("error",u=>{c.remove(),l(u)},!1),c.src=d})}function V(d,{backgroundColor:o="",scale:l=1,width:c=512,height:u=512}){const h=document.createElement("canvas"),_=h.getContext("2d"),A=l,w=c,C=u;return h.width=w*A,h.height=C*A,h.style.width=`${w}`,h.style.height=`${C}`,(o==null?void 0:o.length)>0&&(_.fillStyle=o,_.fillRect(0,0,h.width,h.height)),_.drawImage(d,0,0,h.width,h.height),h}function We(d){const o=document.createElement("canvas");return o.width=d.width,o.height=d.height,o.getContext("2d").putImageData(d,0,0),o}function Ke(d){const o=document.createElement("canvas");o.width=d.width,o.height=d.height;const l=o.getContext("2d");if(!l)throw new Error("Unable to get 2d context");return l.translate(0,d.height),l.scale(1,-1),l.drawImage(d,0,0),o}const Je=d=>`data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='16' height='16' fill='%23${d}'/%3E%3C/svg%3E%0A`,Ge=d=>`data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='8' cy='8' r='7' fill='%23${d}'/%3E%3C/svg%3E%0A`,Xe=d=>`data:image/svg+xml,%3Csvg viewBox='0 0 80 14' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext style='font: 8px "Roboto Mono", "Source Code Pro", Menlo, Courier, monospace; fill: white;' x='9' y='9'%3E${d}%3C/text%3E%3C/svg%3E%0A`,L=async(d,o)=>V(await T(d),o),J=async(d,o)=>await L(d,o).then(l=>l.toDataURL("image/png")),G=async d=>q(await(await fetch(d)).blob());async function Ze(d,o=G){const l=d.match(/(((ftp|https?):\/\/)[\-\w@:%_\+.~#?,&\/\/=]+)/g);if(l)for(const c of l){const u=await o(c);d=d.replace(c,u)}return d}function z(d,o,{width:l,height:c},u=!0){const h=`
<svg viewBox="0 0 ${l} ${c}" xmlns="http://www.w3.org/2000/svg">
    <style>
    ${o}
    </style>
    <foreignObject x="0" y="0" width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml" style="height: 100%; width: 100%; position: absolute: top:0; left:0">
            ${d}
        </div>
    </foreignObject>
</svg>
    `;return u?B(h):h}async function Qe(d,o,l){const c=z(d,o,l);return await L(c,l)}async function je(d,o,l){const c=z(d,o,l);return await J(c,l)}function et(d,o){return Math.abs(d)>Math.abs(o)?d:o}function rt(d,o=null){return new URL(window.location.href).searchParams.get(d)??o}function st(d,o,l=!1){const c=new URLSearchParams(location.search);o==null?c.has(d)&&c.delete(d):c.set(d,o),l?window.location.search=c.toString():window.history.replaceState({},"","?"+c.toString())}function ot(d,o="/"){return d.join(o)}function ct(d,o){const l=(o?`var Module = { locateFile: function(s) { return "${o}"; } }; 
`:"")+`importScripts( "${d}" );`;return URL.createObjectURL(new Blob([l],{type:"text/javascript"}))}var three_module=__webpackgi_require__(848);const CopyShader={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class Pass{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const _camera=new three_module.qUd(-1,1,1,-1,0,1),_geometry=new three_module.LoY;_geometry.setAttribute("position",new three_module.qtW([-1,3,0,-1,-1,0,3,-1,0],3)),_geometry.setAttribute("uv",new three_module.qtW([0,2,0,0,2,0],2));class FullScreenQuad{constructor(o){this._mesh=new three_module.eaF(_geometry,o)}dispose(){this._mesh.geometry.dispose()}render(o){o.render(this._mesh,_camera)}get material(){return this._mesh.material}set material(o){this._mesh.material=o}}class ShaderPass extends Pass{constructor(o,l){super(),this.textureID=l!==void 0?l:"tDiffuse",o instanceof three_module.BKk?(this.uniforms=o.uniforms,this.material=o):o&&(this.uniforms=three_module.LlO.clone(o.uniforms),this.material=new three_module.BKk({name:o.name!==void 0?o.name:"unspecified",defines:Object.assign({},o.defines),uniforms:this.uniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader})),this.fsQuad=new FullScreenQuad(this.material),this.useExistingRenderTarget=!1}render(o,l,c){this.uniforms[this.textureID]&&c&&(this.uniforms[this.textureID].value=c.texture),this.fsQuad.material=this.material,this.renderToScreen?(o.setRenderTarget(null),this.fsQuad.render(o)):(this.useExistingRenderTarget||o.setRenderTarget(l||null),this.clear&&o.clear(o.autoClearColor,o.autoClearDepth,o.autoClearStencil),this.fsQuad.render(o))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class MaskPass extends Pass{constructor(o,l){super(),this.scene=o,this.camera=l,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(o,l,c){const u=o.getContext(),h=o.state;let _,A;h.buffers.color.setMask(!1),h.buffers.depth.setMask(!1),h.buffers.color.setLocked(!0),h.buffers.depth.setLocked(!0),this.inverse?(_=0,A=1):(_=1,A=0),h.buffers.stencil.setTest(!0),h.buffers.stencil.setOp(u.REPLACE,u.REPLACE,u.REPLACE),h.buffers.stencil.setFunc(u.ALWAYS,_,4294967295),h.buffers.stencil.setClear(A),h.buffers.stencil.setLocked(!0),o.setRenderTarget(c),this.clear&&o.clear(),o.render(this.scene,this.camera),o.setRenderTarget(l),this.clear&&o.clear(),o.render(this.scene,this.camera),h.buffers.color.setLocked(!1),h.buffers.depth.setLocked(!1),h.buffers.color.setMask(!0),h.buffers.depth.setMask(!0),h.buffers.stencil.setLocked(!1),h.buffers.stencil.setFunc(u.EQUAL,1,4294967295),h.buffers.stencil.setOp(u.KEEP,u.KEEP,u.KEEP),h.buffers.stencil.setLocked(!0)}}class ClearMaskPass extends Pass{constructor(){super(),this.needsSwap=!1}render(o){o.state.buffers.stencil.setLocked(!1),o.state.buffers.stencil.setTest(!1)}}class EffectComposer{constructor(o,l){if(this.renderer=o,this._pixelRatio=o.getPixelRatio(),l===void 0){const c=o.getSize(new three_module.I9Y);this._width=c.width,this._height=c.height,(l=new three_module.nWS(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:three_module.ix0})).texture.name="EffectComposer.rt1"}else this._width=l.width,this._height=l.height;this.renderTarget1=l,this.renderTarget2=l.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new ShaderPass(CopyShader),this.copyPass.material.blending=three_module.XIg,this.clock=new three_module.zD7}swapBuffers(){const o=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=o}addPass(o){this.passes.push(o),o.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(o,l){this.passes.splice(l,0,o),o.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(o){const l=this.passes.indexOf(o);l!==-1&&this.passes.splice(l,1)}isLastEnabledPass(o){for(let l=o+1;l<this.passes.length;l++)if(this.passes[l].enabled)return!1;return!0}render(o){o===void 0&&(o=this.clock.getDelta());const l=this.renderer.getRenderTarget();let c=!1;for(let u=0,h=this.passes.length;u<h;u++){const _=this.passes[u];if(_.enabled!==!1){if(_.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(u),_.render(this.renderer,this.writeBuffer,this.readBuffer,o,c),_.needsSwap){if(c){const A=this.renderer.getContext(),w=this.renderer.state.buffers.stencil;w.setFunc(A.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,o),w.setFunc(A.EQUAL,1,4294967295)}this.swapBuffers()}MaskPass!==void 0&&(_ instanceof MaskPass?c=!0:_ instanceof ClearMaskPass&&(c=!1))}}this.renderer.setRenderTarget(l)}reset(o){if(o===void 0){const l=this.renderer.getSize(new three_module.I9Y);this._pixelRatio=this.renderer.getPixelRatio(),this._width=l.width,this._height=l.height,(o=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=o,this.renderTarget2=o.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(o,l){this._width=o,this._height=l;const c=this._width*this._pixelRatio,u=this._height*this._pixelRatio;this.renderTarget1.setSize(c,u),this.renderTarget2.setSize(c,u);for(let h=0;h<this.passes.length;h++)this.passes[h].setSize(c,u)}setPixelRatio(o){this._pixelRatio=o,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class EffectComposer2 extends EffectComposer{constructor(o,l){super(o,l)}setPixelRatio(o,l=!0){const c=this.setSize;l||(this.setSize=()=>{}),super.setPixelRatio(o),l||(this.setSize=c)}}class Box3B extends three_module.NRn{expandByObject(o,l=!1,c=!1,u){var h;if(((h=o.userData)===null||h===void 0?void 0:h.bboxVisible)===!1)return this;if(!o.visible&&c)return this;if(u&&u(o))return this;if(o.updateWorldMatrix(!1,!1),o.boundingBox!==void 0)o.boundingBox===null&&o.computeBoundingBox(),_box.copy(o.boundingBox),_box.applyMatrix4(o.matrixWorld),this.union(_box);else{const A=o.geometry;if(A!==void 0)if(l&&A.attributes!=null&&A.attributes.position!==void 0){const w=A.attributes.position;for(let C=0,M=w.count;C<M;C++)_vector.fromBufferAttribute(w,C).applyMatrix4(o.matrixWorld),this.expandByPoint(_vector)}else A.boundingBox===null&&A.computeBoundingBox(),_box.copy(A.boundingBox),_box.applyMatrix4(o.matrixWorld),this.union(_box)}const _=o.children;for(let A=0,w=_.length;A<w;A++)this.expandByObject(_[A],l,c,u);return this}expandByObjects(o,l=!1,c=!1,u){for(let h=0,_=o.length;h<_;h++)this.expandByObject(o[h],l,c,u);return this}getPoints(){return[new three_module.Pq0(this.min.x,this.min.y,this.min.z),new three_module.Pq0(this.min.x,this.min.y,this.max.z),new three_module.Pq0(this.min.x,this.max.y,this.min.z),new three_module.Pq0(this.min.x,this.max.y,this.max.z),new three_module.Pq0(this.max.x,this.min.y,this.min.z),new three_module.Pq0(this.max.x,this.min.y,this.max.z),new three_module.Pq0(this.max.x,this.max.y,this.min.z),new three_module.Pq0(this.max.x,this.max.y,this.max.z)]}getScreenSpaceBounds(o){const l=this.getPoints(),c=new three_module.UtB;for(const u of l){const h=u.project(o);c.min.min(h),c.max.max(h)}return c}}const _box=new Box3B,_vector=new three_module.Pq0;function computeMikkTSpaceTangents(d,o,l=!0){if(!o||!o.isReady)throw new Error("BufferGeometryUtils: Initialized MikkTSpace library required.");if(!d.hasAttribute("position")||!d.hasAttribute("normal")||!d.hasAttribute("uv"))throw new Error('BufferGeometryUtils: Tangents require "position", "normal", and "uv" attributes.');function c(_){if(_.normalized||_.isInterleavedBufferAttribute){const A=new Float32Array(_.count*_.itemSize);for(let w=0,C=0;w<_.count;w++)A[C++]=_.getX(w),A[C++]=_.getY(w),_.itemSize>2&&(A[C++]=_.getZ(w));return A}return _.array instanceof Float32Array?_.array:new Float32Array(_.array)}const u=d.index?d.toNonIndexed():d,h=o.generateTangents(c(u.attributes.position),c(u.attributes.normal),c(u.attributes.uv));if(l)for(let _=3;_<h.length;_+=4)h[_]*=-1;return u.setAttribute("tangent",new three_module.THS(h,4)),d!==u&&d.copy(u),d}function mergeGeometries(d,o=!1){const l=d[0].index!==null,c=new Set(Object.keys(d[0].attributes)),u=new Set(Object.keys(d[0].morphAttributes)),h={},_={},A=d[0].morphTargetsRelative,w=new three_module.LoY;let C=0;for(let M=0;M<d.length;++M){const O=d[M];let ne=0;if(l!==(O.index!==null))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+M+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const ce in O.attributes){if(!c.has(ce))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+M+'. All geometries must have compatible attributes; make sure "'+ce+'" attribute exists among all geometries, or in none of them.'),null;h[ce]===void 0&&(h[ce]=[]),h[ce].push(O.attributes[ce]),ne++}if(ne!==c.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+M+". Make sure all geometries have the same number of attributes."),null;if(A!==O.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+M+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const ce in O.morphAttributes){if(!u.has(ce))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+M+".  .morphAttributes must be consistent throughout all geometries."),null;_[ce]===void 0&&(_[ce]=[]),_[ce].push(O.morphAttributes[ce])}if(o){let ce;if(l)ce=O.index.count;else{if(O.attributes.position===void 0)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+M+". The geometry must have either an index or a position attribute"),null;ce=O.attributes.position.count}w.addGroup(C,ce,M),C+=ce}}if(l){let M=0;const O=[];for(let ne=0;ne<d.length;++ne){const ce=d[ne].index;for(let ue=0;ue<ce.count;++ue)O.push(ce.getX(ue)+M);M+=d[ne].attributes.position.count}w.setIndex(O)}for(const M in h){const O=mergeAttributes(h[M]);if(!O)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+M+" attribute."),null;w.setAttribute(M,O)}for(const M in _){const O=_[M][0].length;if(O===0)break;w.morphAttributes=w.morphAttributes||{},w.morphAttributes[M]=[];for(let ne=0;ne<O;++ne){const ce=[];for(let ye=0;ye<_[M].length;++ye)ce.push(_[M][ye][ne]);const ue=mergeAttributes(ce);if(!ue)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+M+" morphAttribute."),null;w.morphAttributes[M].push(ue)}}return w}function mergeAttributes(d){let o,l,c,u=-1,h=0;for(let C=0;C<d.length;++C){const M=d[C];if(M.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(o===void 0&&(o=M.array.constructor),o!==M.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(l===void 0&&(l=M.itemSize),l!==M.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(c===void 0&&(c=M.normalized),c!==M.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(u===-1&&(u=M.gpuType),u!==M.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;h+=M.array.length}const _=new o(h);let A=0;for(let C=0;C<d.length;++C)_.set(d[C].array,A),A+=d[C].array.length;const w=new three_module.THS(_,l,c);return u!==void 0&&(w.gpuType=u),w}function deepCloneAttribute(d){return d.isInstancedInterleavedBufferAttribute||d.isInterleavedBufferAttribute?deinterleaveAttribute(d):d.isInstancedBufferAttribute?new three_module.uWO().copy(d):new three_module.THS().copy(d)}function interleaveAttributes(d){let o,l=0,c=0;for(let C=0,M=d.length;C<M;++C){const O=d[C];if(o===void 0&&(o=O.array.constructor),o!==O.array.constructor)return console.error("AttributeBuffers of different types cannot be interleaved"),null;l+=O.array.length,c+=O.itemSize}const u=new three_module.eB$(new o(l),c);let h=0;const _=[],A=["getX","getY","getZ","getW"],w=["setX","setY","setZ","setW"];for(let C=0,M=d.length;C<M;C++){const O=d[C],ne=O.itemSize,ce=O.count,ue=new three_module.eHs(u,ne,h,O.normalized);_.push(ue),h+=ne;for(let ye=0;ye<ce;ye++)for(let Oe=0;Oe<ne;Oe++)ue[w[Oe]](ye,O[A[Oe]](ye))}return _}function deinterleaveAttribute(d){const o=d.data.array.constructor,l=d.count,c=d.itemSize,u=d.normalized,h=new o(l*c);let _;_=d.isInstancedInterleavedBufferAttribute?new three_module.uWO(h,c,u,d.meshPerAttribute):new three_module.THS(h,c,u);for(let A=0;A<l;A++)_.setX(A,d.getX(A)),c>=2&&_.setY(A,d.getY(A)),c>=3&&_.setZ(A,d.getZ(A)),c>=4&&_.setW(A,d.getW(A));return _}function deinterleaveGeometry(d){const o=d.attributes,l=d.morphTargets,c=new Map;for(const u in o){const h=o[u];h.isInterleavedBufferAttribute&&(c.has(h)||c.set(h,deinterleaveAttribute(h)),o[u]=c.get(h))}for(const u in l){const h=l[u];h.isInterleavedBufferAttribute&&(c.has(h)||c.set(h,deinterleaveAttribute(h)),l[u]=c.get(h))}}function estimateBytesUsed(d){let o=0;for(const c in d.attributes){const u=d.getAttribute(c);o+=u.count*u.itemSize*u.array.BYTES_PER_ELEMENT}const l=d.getIndex();return o+=l?l.count*l.itemSize*l.array.BYTES_PER_ELEMENT:0,o}function mergeVertices(d,o=1e-4){const l=o>0;o=Math.max(o,Number.EPSILON);const c={},u=d.getIndex(),h=d.getAttribute("position"),_=u?u.count:h.count;let A=0;const w=Object.keys(d.attributes),C={},M={},O=[],ne=["getX","getY","getZ","getW"],ce=["setX","setY","setZ","setW"];for(let tt=0,ht=w.length;tt<ht;tt++){const ut=w[tt],_t=d.attributes[ut];C[ut]=new three_module.THS(new _t.array.constructor(_t.count*_t.itemSize),_t.itemSize,_t.normalized);const at=d.morphAttributes[ut];at&&(M[ut]=new three_module.THS(new at.array.constructor(at.count*at.itemSize),at.itemSize,at.normalized))}const ue=.5*o,ye=Math.log10(1/o),Oe=Math.pow(10,ye),ke=ue*Oe;for(let tt=0;tt<_;tt++){const ht=u?u.getX(tt):tt;let ut="";for(let _t=0,at=w.length;_t<at&&l;_t++){const lt=w[_t],pt=d.getAttribute(lt),xt=pt.itemSize;for(let Tt=0;Tt<xt;Tt++)ut+=~~(pt[ne[Tt]](ht)*Oe+ke)+","}if(l&&ut in c)O.push(c[ut]);else{for(let _t=0,at=w.length;_t<at;_t++){const lt=w[_t],pt=d.getAttribute(lt),xt=d.morphAttributes[lt],Tt=pt.itemSize,Pt=C[lt],Lt=M[lt];for(let Bt=0;Bt<Tt;Bt++){const Ut=ne[Bt],kt=ce[Bt];if(Pt[kt](A,pt[Ut](ht)),xt)for(let Vt=0,si=xt.length;Vt<si;Vt++)Lt[Vt][kt](A,xt[Vt][Ut](ht))}}l&&(c[ut]=A),O.push(A),A++}}const Ve=d.clone();for(const tt in d.attributes){const ht=C[tt];if(Ve.setAttribute(tt,new three_module.THS(ht.array.slice(0,A*ht.itemSize),ht.itemSize,ht.normalized)),tt in M)for(let ut=0;ut<M[tt].length;ut++){const _t=M[tt][ut];Ve.morphAttributes[tt][ut]=new three_module.THS(_t.array.slice(0,A*_t.itemSize),_t.itemSize,_t.normalized)}}return Ve.setIndex(O),Ve}function toTrianglesDrawMode(d,o){if(o===three_module.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),d;if(o===three_module.rYR||o===three_module.O49){let l=d.getIndex();if(l===null){const _=[],A=d.getAttribute("position");if(A===void 0)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),d;for(let w=0;w<A.count;w++)_.push(w);d.setIndex(_),l=d.getIndex()}const c=l.count-2,u=[];if(o===three_module.rYR)for(let _=1;_<=c;_++)u.push(l.getX(0)),u.push(l.getX(_)),u.push(l.getX(_+1));else for(let _=0;_<c;_++)_%2==0?(u.push(l.getX(_)),u.push(l.getX(_+1)),u.push(l.getX(_+2))):(u.push(l.getX(_+2)),u.push(l.getX(_+1)),u.push(l.getX(_)));u.length/3!==c&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const h=d.clone();return h.setIndex(u),h.clearGroups(),h}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",o),d}function computeMorphedAttributes(d){const o=new three_module.Pq0,l=new three_module.Pq0,c=new three_module.Pq0,u=new three_module.Pq0,h=new three_module.Pq0,_=new three_module.Pq0,A=new three_module.Pq0,w=new three_module.Pq0,C=new three_module.Pq0;function M(Vt,si,Jt,Wt,Zt,ti,ci,ri){o.fromBufferAttribute(si,Zt),l.fromBufferAttribute(si,ti),c.fromBufferAttribute(si,ci);const Ct=Vt.morphTargetInfluences;if(Jt&&Ct){A.set(0,0,0),w.set(0,0,0),C.set(0,0,0);for(let Ht=0,qt=Jt.length;Ht<qt;Ht++){const Li=Ct[Ht],Ui=Jt[Ht];Li!==0&&(u.fromBufferAttribute(Ui,Zt),h.fromBufferAttribute(Ui,ti),_.fromBufferAttribute(Ui,ci),Wt?(A.addScaledVector(u,Li),w.addScaledVector(h,Li),C.addScaledVector(_,Li)):(A.addScaledVector(u.sub(o),Li),w.addScaledVector(h.sub(l),Li),C.addScaledVector(_.sub(c),Li)))}o.add(A),l.add(w),c.add(C)}Vt.isSkinnedMesh&&(Vt.applyBoneTransform(Zt,o),Vt.applyBoneTransform(ti,l),Vt.applyBoneTransform(ci,c)),ri[3*Zt+0]=o.x,ri[3*Zt+1]=o.y,ri[3*Zt+2]=o.z,ri[3*ti+0]=l.x,ri[3*ti+1]=l.y,ri[3*ti+2]=l.z,ri[3*ci+0]=c.x,ri[3*ci+1]=c.y,ri[3*ci+2]=c.z}const O=d.geometry,ne=d.material;let ce,ue,ye;const Oe=O.index,ke=O.attributes.position,Ve=O.morphAttributes.position,tt=O.morphTargetsRelative,ht=O.attributes.normal,ut=O.morphAttributes.position,_t=O.groups,at=O.drawRange;let lt,pt,xt,Tt,Pt,Lt,Bt;const Ut=new Float32Array(ke.count*ke.itemSize),kt=new Float32Array(ht.count*ht.itemSize);if(Oe!==null)if(Array.isArray(ne))for(lt=0,xt=_t.length;lt<xt;lt++)for(Pt=_t[lt],Lt=Math.max(Pt.start,at.start),Bt=Math.min(Pt.start+Pt.count,at.start+at.count),pt=Lt,Tt=Bt;pt<Tt;pt+=3)ce=Oe.getX(pt),ue=Oe.getX(pt+1),ye=Oe.getX(pt+2),M(d,ke,Ve,tt,ce,ue,ye,Ut),M(d,ht,ut,tt,ce,ue,ye,kt);else for(Lt=Math.max(0,at.start),Bt=Math.min(Oe.count,at.start+at.count),lt=Lt,xt=Bt;lt<xt;lt+=3)ce=Oe.getX(lt),ue=Oe.getX(lt+1),ye=Oe.getX(lt+2),M(d,ke,Ve,tt,ce,ue,ye,Ut),M(d,ht,ut,tt,ce,ue,ye,kt);else if(Array.isArray(ne))for(lt=0,xt=_t.length;lt<xt;lt++)for(Pt=_t[lt],Lt=Math.max(Pt.start,at.start),Bt=Math.min(Pt.start+Pt.count,at.start+at.count),pt=Lt,Tt=Bt;pt<Tt;pt+=3)ce=pt,ue=pt+1,ye=pt+2,M(d,ke,Ve,tt,ce,ue,ye,Ut),M(d,ht,ut,tt,ce,ue,ye,kt);else for(Lt=Math.max(0,at.start),Bt=Math.min(ke.count,at.start+at.count),lt=Lt,xt=Bt;lt<xt;lt+=3)ce=lt,ue=lt+1,ye=lt+2,M(d,ke,Ve,tt,ce,ue,ye,Ut),M(d,ht,ut,tt,ce,ue,ye,kt);return{positionAttribute:ke,normalAttribute:ht,morphedPositionAttribute:new three_module.qtW(Ut,3),morphedNormalAttribute:new three_module.qtW(kt,3)}}function mergeGroups(d){if(d.groups.length===0)return console.warn("THREE.BufferGeometryUtils.mergeGroups(): No groups are defined. Nothing to merge."),d;let o=d.groups;if(o=o.sort((_,A)=>_.materialIndex!==A.materialIndex?_.materialIndex-A.materialIndex:_.start-A.start),d.getIndex()===null){const _=d.getAttribute("position"),A=[];for(let w=0;w<_.count;w+=3)A.push(w,w+1,w+2);d.setIndex(A)}const l=d.getIndex(),c=[];for(let _=0;_<o.length;_++){const A=o[_],w=A.start,C=w+A.count;for(let M=w;M<C;M++)c.push(l.getX(M))}d.dispose(),d.setIndex(c);let u=0;for(let _=0;_<o.length;_++){const A=o[_];A.start=u,u+=A.count}let h=o[0];d.groups=[h];for(let _=1;_<o.length;_++){const A=o[_];h.materialIndex===A.materialIndex?h.count+=A.count:(h=A,d.groups.push(h))}return d}function toCreasedNormals(d,o=Math.PI/3){const l=Math.cos(o),c=100*(1+1e-10),u=[new three_module.Pq0,new three_module.Pq0,new three_module.Pq0],h=new three_module.Pq0,_=new three_module.Pq0,A=new three_module.Pq0,w=new three_module.Pq0;function C(ye){return`${~~(ye.x*c)},${~~(ye.y*c)},${~~(ye.z*c)}`}const M=d.index?d.toNonIndexed():d,O=M.attributes.position,ne={};for(let ye=0,Oe=O.count/3;ye<Oe;ye++){const ke=3*ye,Ve=u[0].fromBufferAttribute(O,ke+0),tt=u[1].fromBufferAttribute(O,ke+1),ht=u[2].fromBufferAttribute(O,ke+2);h.subVectors(ht,tt),_.subVectors(Ve,tt);const ut=new three_module.Pq0().crossVectors(h,_).normalize();for(let _t=0;_t<3;_t++){const at=C(u[_t]);at in ne||(ne[at]=[]),ne[at].push(ut)}}const ce=new Float32Array(3*O.count),ue=new three_module.THS(ce,3,!1);for(let ye=0,Oe=O.count/3;ye<Oe;ye++){const ke=3*ye,Ve=u[0].fromBufferAttribute(O,ke+0),tt=u[1].fromBufferAttribute(O,ke+1),ht=u[2].fromBufferAttribute(O,ke+2);h.subVectors(ht,tt),_.subVectors(Ve,tt),A.crossVectors(h,_).normalize();for(let ut=0;ut<3;ut++){const _t=ne[C(u[ut])];w.set(0,0,0);for(let at=0,lt=_t.length;at<lt;at++){const pt=_t[at];A.dot(pt)>l&&w.add(pt)}w.normalize(),ue.setXYZ(ke+ut,w.x,w.y,w.z)}}return M.setAttribute("normal",ue),M}function mergeBufferGeometries(d,o=!1){return console.warn("THREE.BufferGeometryUtils: mergeBufferGeometries() has been renamed to mergeGeometries()."),mergeGeometries(d,o)}function mergeBufferAttributes(d){return console.warn("THREE.BufferGeometryUtils: mergeBufferAttributes() has been renamed to mergeAttributes()."),mergeAttributes(d)}function computeScreenSpaceBoundingBox(d,o){let l,c;if(Array.isArray(d))for(const h of d){const _=computeScreenSpaceBoundingBox(h,o);l===void 0||c===void 0?(l=_.min.clone(),c=_.max.clone()):(l.min(_.min),c.max(_.max))}const u=d;if(u.geometry!==void 0){const h=u.geometry.vertices;if(h===void 0&&u.geometry.attributes!==void 0&&"position"in u.geometry.attributes){const _=new three_module.Pq0,A=u.geometry.attributes.position;for(let w=0;w<A.count*A.itemSize;w+=A.itemSize){_.set(A.array[w],A.array[w+1],A.array[3]);const C=_.applyMatrix4(d.matrixWorld).project(o),M=new three_module.I9Y(C.x,C.y);l===void 0||c===void 0?(l=M.clone(),c=M.clone()):(l.min(M),c.max(M))}}else for(const _ of h){const A=_.clone().applyMatrix4(d.matrixWorld).project(o),w=new three_module.I9Y(A.x,A.y);l===void 0||c===void 0?(l=w.clone(),c=w.clone()):(l.min(w),c.max(w))}}if(d.children!==void 0)for(const h of d.children){const _=computeScreenSpaceBoundingBox(h,o);l===void 0||c===void 0?(l=_.min.clone(),c=_.max.clone()):(l.min(_.min),c.max(_.max))}return new three_module.UtB(l,c)}const RGBM16ColorSpace_="rgbm-16";function getTexelDecodingFunction(d,o){let l;switch(o){case three_module.jf0:case three_module.Zr2:case three_module.er$:l="";break;case three_module.DAr:l="RGBM16ToLinear";break;default:console.warn("THREE.WebGLProgram: Unsupported color space:",o),l=""}return`#define ${d}( value ) ${l} ( value )`}function getTexelDecoding(d,o){return getTexelDecodingFunction(d+"TexelToLinear",o??three_module.Zr2)+`
`}function uniform({uniforms:d,propKey:o,thisTarget:l=!1}={}){const c=!!d,u=!!o,h=l;return(_,A)=>{const w=C=>{const M=h?C:c?d:C.uniforms||C._uniforms;let O=u?o:A;h&&(O="_"+O);let ne=M[O];return ne||(ne={value:null},M[O]=ne),ne};Object.defineProperty(_,A,{get(){return w(this).value},set(C){w(this).value=C,S(this,"uniformsNeedUpdate",!0,!0)}})}}function matDefine(d,o,l=!1,c){const u=!!o,h=!!d;return(_,A)=>{const w=C=>({t:u?o:C.defines||C._defines,p:h?d:A});Object.defineProperty(_,A,{get(){const{t:C,p:M}=w(l?this:this.material);return C[M]},set(C){const{t:M,p:O}=w(l?this:this.material);if(S(M,O,C,!0),typeof c=="function"){const ne=[O,C];if(c.name){const ce=this[c.name];ce===c?c.call(this,...ne):ce.name===`bound ${c.name}`?ce(...ne):c(...ne)}else c(...ne)}else S(l?this:this.material,"needsUpdate",!0,!0)}})}}function dataTextureFromColor(d){const o=new three_module.GYF(new Uint8Array([Math.floor(255*d.r),Math.floor(255*d.g),Math.floor(255*d.b),255]),1,1,three_module.GWd,three_module.OUM);return o.needsUpdate=!0,o.colorSpace=three_module.jf0,o}function dataTextureFromVec4(d){const o=new three_module.GYF(new Uint8Array([Math.floor(255*d.x),Math.floor(255*d.y),Math.floor(255*d.z),Math.floor(255*d.w)]),1,1,three_module.GWd,three_module.OUM);return o.needsUpdate=!0,o}function setThreeRendererMode(d,o,l){const c=d.userData,{backgroundRender:u,transparentRender:h,shadowMapRender:_,mainRenderPass:A,opaqueRender:w,transmissionRender:C,sceneRender:M,screenSpaceRendering:O}=c;o.backgroundRender!==void 0&&(c.backgroundRender=o.backgroundRender),o.transparentRender!==void 0&&(c.transparentRender=o.transparentRender),o.shadowMapRender!==void 0&&(c.shadowMapRender=o.shadowMapRender),o.mainRenderPass!==void 0&&(c.mainRenderPass=o.mainRenderPass),o.opaqueRender!==void 0&&(c.opaqueRender=o.opaqueRender),o.sceneRender!==void 0&&(c.sceneRender=o.sceneRender),o.transmissionRender!==void 0&&(c.transmissionRender=o.transmissionRender),o.screenSpaceRendering!==void 0&&(c.screenSpaceRendering=o.screenSpaceRendering),l(),c.backgroundRender=u,c.transparentRender=h,c.shadowMapRender=_,c.mainRenderPass=A,c.opaqueRender=w,c.sceneRender=M,c.transmissionRender=C,c.screenSpaceRendering=O}function autoCenterObject3D(d,o=!1){if(o){if(!d.userData.autoCentered||!d.userData._lastCenter)return d;d.position.add(d.userData._lastCenter),delete d.userData.autoCentered,delete d.userData.isCentered,delete d.userData._lastCenter}else{const l=new Box3B().expandByObject(d,!0,!0).getCenter(new three_module.Pq0);d.userData._lastCenter=l,d.position.sub(l),d.userData.autoCentered=!0,d.userData.isCentered=!0}return d.dispatchEvent({type:"objectUpdate",undo:o}),d}function pivotToBBoxCenter(d){return pivotToPoint(d,new Box3B().expandByObject(d,!0,!0).getCenter(new three_module.Pq0))}function pivotToPoint(d,o){var l;const c=new three_module.Pq0().copy(o),u=new three_module.Pq0().copy(c),h=new three_module.kn4().copy(d.matrixWorld).invert(),_=(l=d.parent)===null||l===void 0?void 0:l.matrixWorld,A=new three_module.kn4;_!==void 0&&A.copy(_).invert(),c.applyMatrix4(A);const w=d.position.clone();return d.position.copy(c),u.applyMatrix4(h).negate(),d.geometry&&d.geometry.translate(u.x,u.y,u.z),d.children.forEach(C=>{C.position.add(u)}),d.dispatchEvent({type:"objectUpdate"}),()=>{d.position.copy(w),d.geometry&&d.geometry.translate(-u.x,-u.y,-u.z),d.children.forEach(C=>{C.position.sub(u)}),d.dispatchEvent({type:"objectUpdate",undo:!0})}}function autoScaleObject3D(d,o,l,c=!1){let u=1;if(c){if(!d.userData.autoScaled||!d.userData._lastScaleRadius)return d;const h=d.userData.autoScaleRadius||o||1;if(u=d.userData._lastScaleRadius/h,!isFinite(u))return d;d.userData.autoScaled=!0,d.userData.autoScaleRadius=o,delete d.userData._lastScaleRadius}else{const h=.5*new Box3B().expandByObject(d,!0,!0).getSize(new three_module.Pq0).length();if(o===void 0&&(o=d.userData.autoScaleRadius||1),u=o/h,!isFinite(u))return d;d.userData.autoScaled=!0,d.userData.autoScaleRadius=o,d.userData._lastScaleRadius=h}return d.userData.pseudoCentered?d.children.forEach(h=>{h.scale.multiplyScalar(u)}):d.scale.multiplyScalar(u),(l||d.userData.isCentered)&&d.position.multiplyScalar(u),d.traverse(h=>{var _,A;h.isLight&&(!((A=(_=h.shadow)===null||_===void 0?void 0:_.camera)===null||A===void 0)&&A.right)&&(h.shadow.camera.right*=u,h.shadow.camera.left*=u,h.shadow.camera.top*=u,h.shadow.camera.bottom*=u),h.isCamera&&h.right&&(h.right*=u,h.left*=u,h.top*=u,h.bottom*=u)}),d.dispatchEvent({type:"objectUpdate",undo:c}),d}function toIndexedGeometry(d,o=-1){return mergeVertices(d,o)}function makeSamplerUi(d,o,l,c,u){return u=u??(()=>d.setDirty&&d.setDirty()),{type:"folder",label:l??o+" Sampler",hidden:()=>!d[o]||c&&c(),children:[()=>({type:"vec2",label:"Repeat",bounds:[-100,100],stepSize:.001,property:[d[o],"repeat"],onChange:u}),()=>({type:"vec2",label:"Offset",bounds:[-2,2],stepSize:.001,property:[d[o],"offset"],onChange:u}),()=>({type:"vec2",label:"Center",bounds:[-2,2],stepSize:.001,property:[d[o],"center"],onChange:u}),()=>({type:"input",label:"Rotation",stepSize:.001,bounds:[-Math.PI,Math.PI],property:[d[o],"rotation"],onChange:u}),()=>({type:"dropdown",label:"Color Space",property:[d[o],"colorSpace"],children:[["Linear",three_module.Zr2],["sRGB",three_module.er$]].map(h=>({label:h[0],value:h[1]})),onChange:[()=>{const h=d[o];h&&(h.needsUpdate=!0)},u]}),()=>({type:"checkbox",label:"Flip Y",getValue:()=>{var h,_;return(_=(h=d[o])===null||h===void 0?void 0:h.flipY)!==null&&_!==void 0&&_},setValue:h=>{const _=d[o];if(_&&_.flipY!==h)if(_.image&&ImageBitmap&&_.image instanceof ImageBitmap){const A=_,w=_.source.data;createImageBitmap(w,{imageOrientation:"flipY"}).then(C=>{w.close&&w.close(),A.flipY=h,A.source.data=C,A.source.needsUpdate=!0,A.needsUpdate=!0,u&&u()})}else _.flipY=h,_.needsUpdate=!0,u&&u()}}),()=>({type:"dropdown",label:"Wrap S",property:[d[o],"wrapS"],children:[["ClampToEdge",three_module.ghU],["MirroredRepeat",three_module.kTW],["Repeat",three_module.GJx]].map(h=>({label:h[0],value:h[1]})),onChange:[()=>{d[o]&&(d[o].needsUpdate=!0)},u]}),()=>({type:"dropdown",label:"Wrap T",property:[d[o],"wrapT"],children:[["ClampToEdge",three_module.ghU],["MirroredRepeat",three_module.kTW],["Repeat",three_module.GJx]].map(h=>({label:h[0],value:h[1]})),onChange:[()=>{d[o]&&(d[o].needsUpdate=!0)},u]}),()=>({type:"input",label:"Anisotropy",bounds:[1,6],stepSize:1,property:[d[o],"anisotropy"],onChange:[()=>{d[o]&&(d[o].needsUpdate=!0),d.needsUpdate=!0},u]}),()=>({type:"dropdown",label:"Min Filter",property:[d[o],"minFilter"],children:[["Linear",three_module.k6q],["Nearest",three_module.hxR],["NearestMipmapNearest",three_module.pHI],["NearestMipmapLinear",three_module.a$r],["LinearMipmapNearest",three_module.kRr],["LinearMipmapLinear",three_module.$_I]].map(h=>({label:h[0],value:h[1]})),onChange:[()=>{d[o]&&(d[o].needsUpdate=!0)},u]}),()=>({type:"dropdown",label:"Mag Filter",property:[d[o],"magFilter"],children:[["Linear",three_module.k6q],["Nearest",three_module.hxR]].map(h=>({label:h[0],value:h[1]})),onChange:[()=>{d[o]&&(d[o].needsUpdate=!0)},u]})]}}const iMaterialIgnoredUserData=["appliedMeshes","imageLoadAwaiter","inverseModelMatrix","uvTransform","uuid","iMaterial"];function copyMaterialUserData(d,o,l=!0){if(!o)return d;for(const c of Object.keys(o)){if(l&&iMaterialIgnoredUserData.includes(c)||c.startsWith("__"))continue;const u=o[c];if(typeof d[c]=="function"||typeof u=="function")continue;const h=!u||u.isTexture||u.isObject3D||u.isMaterial;h||typeof u.clone!="function"?h||typeof u!="object"&&!Array.isArray(u)?d[c]=u:d[c]=copyMaterialUserData(Array.isArray(u)?[]:{},u,!1):d[c]=u.clone()}return d}const iTextureIgnoredUserData=["appliedMaterials","uuid"];function copyTextureUserData(d,o){if(o)for(const l of Object.keys(o))iTextureIgnoredUserData.includes(l)||l.startsWith("__")||typeof d[l]!="function"&&typeof o[l]!="function"&&(d[l]=o[l]);return d}function textureDataToImageData(d,o,l){var c;const u=(c=l==null?void 0:l.data)!==null&&c!==void 0?c:new Uint8ClampedArray(d.height*d.width*4),h=d.data instanceof Float32Array,_=d.data instanceof Uint16Array;for(let A=0;A<u.length;A++)u[A]=h?255*d.data[A]:_?255*three_module.GxU.fromHalfFloat(d.data[A]):d.data[A],o===three_module.Zr2&&(u[A]=255*ve(u[A]/255));return l??new ImageData(u,d.width,d.height)}function textureToCanvas(d,o,l=!1){let c;return c=d.isDataTexture?textureDataToImageData(d.image,d.colorSpace):d.image,texImageToCanvas(c,o,l)}function texImageToCanvas(d,o,l=!1){const c=document.createElement("canvas");c.width=Math.min(o,d.width),c.height=Math.floor(1+c.width*d.height/d.width);const u=c.getContext("2d");if(!u)return console.error("textureToDataUrl: could not get canvas context"),c;l===!0&&(u.translate(0,c.height),u.scale(1,-1));let h=!1;if(d.data!==void 0){const _=d;if(d.width!==c.width||d.height!==c.height){const A=document.createElement("canvas");A.width=d.width,A.height=d.height;const w=A.getContext("2d");w?(w.putImageData(_,0,0),u.drawImage(A,0,0,c.width,c.height)):(console.error("textureToDataUrl: could not get temp canvas context"),u.putImageData(_,0,0))}else u.putImageData(_,0,0),l&&(h=!0)}else u.drawImage(d,0,0,c.width,c.height);return h?Ke(c):c}function textureToDataUrl(d,o,l,c,u){return textureToCanvas(d,o,l).toDataURL(c,u)}String.prototype.replaceAll||(String.prototype.replaceAll=function(d,o){return Object.prototype.toString.call(d).toLowerCase()==="[object regexp]"?this.replace(d,o):this.replace(new RegExp(d,"g"),o)});const typeMap=new Map;function serialize(d){return(o,l)=>{const c=o.constructor;if(c===Object)throw new Error("All properties in an object are serialized by default");typeMap.has(c)||typeMap.set(c,[]),typeMap.get(c).push([d||l,l])}}const serializers={obj:(d,o)=>Object.fromEntries(Object.entries(d).map(([l,c])=>[l,serializeObject(c,!1,o)])),vec4:d=>({x:d.x,y:d.y,z:d.z,w:d.w,isVector4:!0}),vec3:d=>({x:d.x,y:d.y,z:d.z,isVector3:!0}),vec2:d=>({x:d.x,y:d.y,isVector2:!0}),color:d=>({r:d.r,g:d.g,b:d.b,isColor:!0}),quat:d=>({x:d.x,y:d.y,z:d.z,w:d.w,isQuaternion:!0}),texture:(d,o)=>{var l;if(!(d!=null&&d.isTexture))throw new Error("Expected a texture");if(o!=null&&o.textures[d.uuid])return{uuid:d.uuid,resource:"textures"};if(d.isRenderTargetTexture&&!(!((l=d.userData)===null||l===void 0)&&l.serializableRenderTarget))return;const c=d.source.data,u=!d.isRenderTargetTexture&&d.userData.rootPath;u&&d.source.data&&(d.userData.__embedUrlImagePreviews?d.source.data=textureToCanvas(d,16,d.flipY):d.source.data=null);const h=d.userData;d.userData={};const _={images:{}};let A={};try{A=d.toJSON(o||_),!o&&A.image&&(A.image=u&&!d.userData.__embedUrlImagePreviews?void 0:_.images[A.image]),A.userData=serializeObject(copyTextureUserData({},h),!1,o)}catch(w){console.error(w)}return d.userData=h,u&&(o&&!d.userData.__embedUrlImagePreviews&&delete o.images[d.source.uuid],d.source.data=c),o!=null&&o.textures&&!A.resource&&(o.textures[A.uuid]||(o.textures[A.uuid]=A),A={uuid:A.uuid,resource:"textures"}),A},material:(d,o)=>{var l;if(!(d!=null&&d.isMaterial))throw new Error("Expected a material");if(!((l=o==null?void 0:o.materials)===null||l===void 0)&&l[d.uuid])return{uuid:d.uuid,resource:"materials"};d.userData.rootPath&&console.error("TODO: handle material with root path with material inheritance/hierarchy");const c=o??{textures:{},images:{}},u={},h={};for(const[A,w]of Object.entries(d))if(w!=null&&w.isTexture&&!A.startsWith("__")){const C=serializers.texture(w,c);u[A]=C,h[A]=w,d[A]=C?{isTexture:!0,toJSON:()=>C}:null}let _=d.toJSON(o||c);for(const[A,w]of Object.entries(h))d[A]=w,delete h[A];if(o){for(const[A,w]of Object.entries(u))w&&(_[A]=w);o!=null&&o.materials&&(o.materials[_.uuid]||(o.materials[_.uuid]=_),_={uuid:_.uuid,resource:"materials"})}else{for(const[A,w]of Object.entries(u))w&&(_[A]=w.uuid);_.textures=Object.values(c.textures),_.images=Object.values(c.images)}return _}},copier=d=>(o,l)=>{var c,u;return(u=(c=l==null?void 0:l.copy)===null||c===void 0?void 0:c.call(l,o))!==null&&u!==void 0?u:new d().copy(o)},deserializers={obj:(d,o,l)=>Object.assign(o,Object.fromEntries(Object.entries(d).map(([c,u])=>[c,deserializeObject(u,o==null?void 0:o[c],!1,l)]))),vec4:copier(three_module.IUQ),vec3:copier(three_module.Pq0),vec2:copier(three_module.I9Y),color:copier(three_module.Q1f),quat:copier(three_module.PTz)};function serializeObject(d,o,l){var c,u;if(typeof d=="function")return;if(Array.isArray(d))return d.map(A=>serializeObject(A,!1,l));if(typeof d!="object"){if(typeof d=="number"){if(d===1/0)return"Infinity";if(d===-1/0)return"-Infinity";if(isNaN(d))return"NaN"}return d}if(!d)return d;let h=(c=d.constructor)!==null&&c!==void 0?c:Object;if(h===Object)return serializers.obj(d,l);if(d.isVector2)return serializers.vec2(d);if(d.isVector3)return serializers.vec3(d);if(d.isVector4)return serializers.vec4(d);if(d.isColor)return serializers.color(d);if(d.isQuaternion)return serializers.quat(d);if(d.isTexture)return serializers.texture(d,l);if(d.isMaterial)return serializers.material(d,l);if(!o&&typeof d.toJSON=="function"){const A=d.toJSON(l);return d.serializableClassId&&A&&(A.serializableClassId=d.serializableClassId),A}const _={};for(;h&&h!==Object;)(u=typeMap.get(h))===null||u===void 0||u.forEach(([A,w])=>{const C=d[w];_[A]=serializeObject(C,!1,l)}),h=Object.getPrototypeOf(h);return d.serializableClassId&&(_.serializableClassId=d.serializableClassId),_}function deserializeObject(d,o,l,c={}){var u,h,_;let A=o;if(d===void 0)return A;if(typeof o=="number"){if(d==="Infinity")return 1/0;if(d==="-Infinity")return-1/0;if(d==="NaN")return NaN;if(typeof d=="number"||!d)return d}if(Array.isArray(d)){const M=d.length;Array.isArray(A)||(A=[]);for(let O=0;O<M;O++){const ne=d[O],ce=A.length>O?deserializeObject(ne,A[O],!1,c):deserializeObject(ne,void 0,!1,c);A.length<=O?A.push(ce):A[O]=ce}return A}let w=!1;if(d&&d.resource&&typeof d.resource=="string"&&(d=(u=c[d.resource])===null||u===void 0?void 0:u[d.uuid],w=!0),!A&&d&&!w)if(d.serializableClassId){const M=serializableClasses.get(d.serializableClassId);M&&(A=M.DataInConstructor?new M(d):new M)}else typeof d!="object"||d.constructor&&d.constructor!==Object||(A={});if(typeof A=="function")return console.error("cannot deserialize over function",A,d),A;if(d&&typeof d=="object"&&!w){if(d.isVector2)return deserializers.vec2(d,A);if(d.isVector3)return deserializers.vec3(d,A);if(d.isVector4)return deserializers.vec4(d,A);if(d.isColor)return deserializers.color(d,A);if(d.isQuaternion)return deserializers.quat(d,A)}if(d==null||A==null||typeof A!="object"||A.isTexture)return w&&(d?d.__useCount=d.__useCount?d.__useCount+1:1:console.warn("probable error deserialize: resource not found.")),d;let C=(h=A.constructor)!==null&&h!==void 0?h:Object;if(C===Object)return deserializers.obj(d,A,c);if(!l&&typeof A.fromJSON=="function")return A.isMaterial&&(Object.entries(d).forEach(([M,O])=>{var ne;if(!O||!O.resource||typeof O.resource!="string")return;const ce=(ne=c[O.resource])===null||ne===void 0?void 0:ne[O.uuid];d[M]=ce||null}),d.userData&&(d.userData=deserializeObject(d.userData,void 0,!1,c))),A.fromJSON(d,c),A;for(;C&&C!==Object;)(_=typeMap.get(C))===null||_===void 0||_.forEach(([M,O])=>{const ne=A[O],ce=deserializeObject(d[M],ne,!1,c);ce!==ne&&S(A,O,ce,!0)}),C=Object.getPrototypeOf(C);return A}const serializableClasses=new Map;function serializable(d){return o=>(o=class extends o{constructor(){super(...arguments),this.serializableClassId=d}},serializableClasses.set(d,o),o)}function serializeTextureInExtras(d,o,l,c){var u,h,_;if(o!=null&&o.extras[d.uuid])return{uuid:d.uuid,resource:"extras"};let A="";if(!((u=d.source)===null||u===void 0)&&u._sourceImgBuffer||d.userData.__sourceBuffer){const C=new Uint8Array(((h=d.source)===null||h===void 0?void 0:h._sourceImgBuffer)||d.userData.__sourceBuffer),M=c||d.userData.mimeType||"";A={data:Array.from(C),type:C.constructor.name,path:((_=d.userData.__sourceBlob)===null||_===void 0?void 0:_.name)||d.userData.rootPath||"file."+M.split("/")[1]},M&&(A.mimeType=M)}else d.userData.rootPath?A=d.userData.rootPath:console.error("Unable to serialize LUT texture, not loaded through asset manager.");const w={uuid:d.uuid,url:A,userData:copyTextureUserData({},d.userData),type:d.type,name:l||d.name};return o!=null&&o.extras?(o.extras[d.uuid]=w,{uuid:d.uuid,resource:"extras"}):w}var __decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let BaseRenderer=class extends I{get composer(){return this._composer}get passes(){return this._passes}get isWebGL2(){return this._isWebGL2}get composerTarget(){return this._composerTarget}get renderSize(){return this._renderSize}get displayCanvasScaling(){return this._displayCanvasScaling}set displayCanvasScaling(d){d!==this._displayCanvasScaling&&(this._displayCanvasScaling=d,this.setSize(void 0,void 0,!0))}get frameCount(){return this._frameCount}get totalFrameCount(){return this._totalFrameCount}set pipeline(d){this._pipeline=d,this._passesNeedsUpdate=!0}get pipeline(){return this._pipeline}refreshPipeline(){var d,o,l;const c=this._passes,u=[],h={};for(const _ of c){if(_.enabled===!1)continue;const A={after:(d=_.after)!==null&&d!==void 0?d:[],before:(o=_.before)!==null&&o!==void 0?o:[],dependencies:new Set((l=_.required)!==null&&l!==void 0?l:[])};h[_.passId]=A}for(const[_,A]of Object.entries(h)){const w=new Set([...A.after,...A.before]);A.dependencies.forEach(C=>w.has(C)&&w.delete(C)),w.forEach(C=>{const M=h[C];if(M){if(M.dependencies.has(_))throw console.error("cyclic",_,C),"Cyclic dependency";A.dependencies.add(C)}})}for(;;){let _=!1;const A=[...Object.entries(h)];for(const[w,C]of A)if(!u.includes(w)&&Ce(u,C.dependencies.values())){const M=Math.max(-1,...C.after.map(ne=>u.indexOf(ne))),O=Math.min(u.length,...C.before.map(ne=>{const ce=u.indexOf(ne);return ce<0?u.length:ce}));if(M>=O)throw console.error(C,c,u,M,O),"Not possible";u.splice(C.after.length>0?M+1:O,0,w),_=!0,delete h[w]}if(Object.keys(h).length<1)break;if(!_)throw console.error(A,h,u),"Not possible 2"}return this.pipeline=u,this.pipeline}get context(){return this._context}get rendererObject(){return this._renderer}_animationLoop(d,o){const l=d-this._lastTime;this._lastTime=d,this.frameWaitTime-=l,this.frameWaitTime>0||(this.frameWaitTime=0,this.dispatchEvent({type:"animationLoop",deltaTime:l,time:d,renderer:this,xrFrame:o}))}get clock(){return this._composer.clock}registerPass(d,o=!0){var l;if(o)for(const c of[...this._passes])d.passId===c.passId&&this.unregisterPass(c);this._passes.push(d),(l=d.onRegister)===null||l===void 0||l.call(d,this),this._passesNeedsUpdate=!0,this._updated()}unregisterPass(d){var o;const l=this._passes.indexOf(d);l>=0&&((o=d.onUnregister)===null||o===void 0||o.call(d,this),this._passes.splice(l,1),this._passesNeedsUpdate=!0,this._updated())}constructor({animationLoop:d,canvas:o,alpha:l=!0,targetOptions:c,maxHDRIntensity:u}){super(),this._isWebGL2=!1,this._trackedTargets=[],this.dirty=!0,this._lastTime=0,this.frameWaitTime=0,this._passes=[],this._pipeline=[],this._passesNeedsUpdate=!0,this._displayCanvasScaling=1,this._renderSize=new three_module.I9Y(512,512),this._frameCount=0,this.defaultRenderToScreen=!0,this._tempTargets={},this.maxTempPerKey=5,this._totalFrameCount=0,this.stableNoise=!1,this._animationLoop=this._animationLoop.bind(this),this._processNewTarget=this._processNewTarget.bind(this),this._processNewTempTarget=this._processNewTempTarget.bind(this),this.trackTarget=this.trackTarget.bind(this),this.disposeTarget=this.disposeTarget.bind(this),this.createTarget=this.createTarget.bind(this),this.createTargetCustom=this.createTargetCustom.bind(this),this.maxHDRIntensity=u||120,this._renderer=new three_module.JeP({canvas:o,antialias:!1,alpha:l,premultipliedAlpha:!0,preserveDrawingBuffer:!0,powerPreference:"high-performance"}),this._renderer.baseRenderer=this,this._renderer.setAnimationLoop(this._animationLoop),this._context=this._renderer.getContext(),this._isWebGL2=this._renderer.capabilities.isWebGL2,this._isWebGL2||console.error("WebGi BaseRenderer: WebGL1 is not supported anymore. Some features may not work"),this._renderer.onContextLost=h=>{this.dispatchEvent({type:"contextLost",event:h})},this._renderer.onContextRestore=()=>{this.dispatchEvent({type:"contextRestored"})},this._renderSize=new three_module.I9Y(o.clientWidth,o.clientHeight),this._renderer.setSize(this._renderSize.width,this._renderSize.height,!1),this._renderer.setPixelRatio(this._displayCanvasScaling),this._renderer.toneMapping=three_module.y_p,this._renderer.toneMappingExposure=1,this._renderer.outputColorSpace=three_module.jf0,this._renderer.shadowMap.enabled=!0,this._renderer.shadowMap.type=three_module.QP0,this._renderer.shadowMap.autoUpdate=!1,this.resetShadows(),this._composerTarget=this.createTarget(c,!1),this._composerTarget.texture.name="EffectComposer.rt1",this._composer=new EffectComposer2(this._renderer,this._composerTarget),d&&this.addEventListener("animationLoop",d)}setSize(d,o,l=!1){!l&&(d?Math.abs(d-this._renderSize.width):0)+(o?Math.abs(o-this._renderSize.height):0)<.1||(d&&(this._renderSize.width=d),o&&(this._renderSize.height=o),this.rendererObject.xr.enabled&&this.rendererObject.xr.isPresenting||(this._renderer.setSize(this._renderSize.width,this._renderSize.height,!1),this._renderer.setPixelRatio(this._displayCanvasScaling)),this._composer.setPixelRatio(this._displayCanvasScaling,!1),this._composer.setSize(this._renderSize.width,this._renderSize.height),this._trackedTargets.forEach(c=>{const u=c,h=u.sizeMultiplier;if(h){const _=this._renderSize.clone().multiplyScalar(this._displayCanvasScaling*h);u.setSize(Math.floor(_.width),Math.floor(_.height))}}),this.dispatchEvent({type:"resize"}),this._updated(),this.reset())}blit(d,o,{viewport:l,material:c,shader:u,pass:h,clear:_=!0}={}){const A=this._composer.copyPass,{renderToScreen:w,material:C,uniforms:M,clear:O}=A;c&&(A.material=c);const ne=this._renderer.getViewport(new three_module.IUQ),ce=this._renderer.autoClear,ue=this._renderer.getRenderTarget();l&&this._renderer.setViewport(new three_module.IUQ().fromArray(l)),this._renderer.autoClear=!1,A.uniforms=A.material.uniforms,A.renderToScreen=!1,A.clear=_,setThreeRendererMode(this._renderer,{sceneRender:!0,opaqueRender:!0,shadowMapRender:!1,backgroundRender:!1,transparentRender:!0,transmissionRender:!1},()=>{A.render(this._renderer,o??null,{texture:d},0,!1)}),A.renderToScreen=w,A.clear=O,A.material=C,A.uniforms=M,this._renderer.autoClear=ce,l&&this._renderer.setViewport(ne),this._renderer.setRenderTarget(ue)}clearColor({r:d,g:o,b:l,a:c,target:u,depth:h=!0,stencil:_=!0}){var A;const w=this._renderer.getClearColor(new three_module.Q1f),C=this._renderer.getClearAlpha();this._renderer.setClearColor(new three_module.Q1f(d??w.r,o??w.g,l??w.b),c??C);const M=this._renderer.getRenderTarget(),O=this._renderer.getActiveCubeFace(),ne=this._renderer.getActiveMipmapLevel();u&&typeof u.clear=="function"?u.clear(this._renderer,!0,h,_):(this._renderer.setRenderTarget((A=u)!==null&&A!==void 0?A:null),this._renderer.clear(!0,h,_)),this._renderer.setRenderTarget(M,O,ne),this._renderer.setClearColor(w,C)}renderModel(d,o){this._renderer.render(d.modelObject,o.cameraObject)}renderScene(d){const o=d.activeCamera;o&&this.renderModel(d,o)}_updated(){this.dispatchEvent({type:"update"})}render(d){var o;this._passesNeedsUpdate&&this.refreshPasses();for(const l of this._passes)l.passObject.enabled&&((o=l.update)===null||o===void 0||o.call(l));d=d??this.defaultRenderToScreen,this._composer.renderToScreen=d,this._composer.render(),this._composer.renderToScreen=!0,d&&(this._frameCount+=1,this._totalFrameCount+=1),this.dirty=!1}updateDirty(){this.dirty=this.dirty||this._passes.findIndex(d=>d.dirty)>=0}reset(){this._frameCount=0,this.dirty=!0}resetShadows(){this._renderer.shadowMap.needsUpdate=!0}refreshPasses(){if(!this._passesNeedsUpdate)return;this._passesNeedsUpdate=!1;const d=[];for(const o of this._pipeline){const l=this._passes.find(c=>c.passId===o);l?d.push(l.passObject):console.warn("WebGi BaseRenderer: Unable to find pass: ",o)}[...this._composer.passes].forEach(o=>this._composer.removePass(o)),d.forEach(o=>this._composer.addPass(o)),this._updated()}dispose(){this._trackedTargets.forEach(d=>d.dispose()),this._trackedTargets=[],this._renderer.dispose()}trackTarget(d){this._trackedTargets.push(d)}removeTrackedTarget(d){const o=this._trackedTargets.indexOf(d);o>=0&&this._trackedTargets.splice(o,1)}createTarget({sizeMultiplier:d,samples:o=0,colorSpace:l=three_module.jf0,type:c=three_module.OUM,format:u=three_module.GWd,depthBuffer:h=!0,depthTexture:_=!1,depthTextureType:A=three_module.bkx,depthTextureFormat:w=three_module.zdS,size:C,textureCount:M=1,...O}={},ne=!0){this.isWebGL2||(o=0),d!==void 0&&C!==void 0&&console.error("Both sizeMultiplier and size are defined. sizeMultiplier will be ignored."),(C=C||this._renderSize.clone().multiplyScalar(this._displayCanvasScaling*(d=d||1))).width=Math.floor(C.width),C.height=Math.floor(C.height);const ce=_?new three_module.VCu(C.width,C.height,A):null;ce&&(ce.format=w);const ue=this.createTargetCustom(M>1?{width:C.width,height:C.height,count:M}:C,{samples:o,colorSpace:l,type:c,format:u,depthBuffer:h,depthTexture:ce},M>1?three_module.AT1:three_module.nWS);return this._processNewTarget(ue,d,ne),this._setTargetOptions(ue,O),ue}_processNewTarget(d,o,l){return o!==void 0&&(d.sizeMultiplier=o),l&&this.trackTarget(d),d}disposeTarget(d){if(d){if(d.isTemporary)return this.releaseTempTarget(d);this.removeTrackedTarget(d),d.dispose()}}createTargetCustom({width:d,height:o,count:l},c={},u){var h;const _=this._processNewTarget,A=this.renderTargetToDataUrl.bind(this);this.renderTargetToBuffer.bind(this);let w=[d,o];if(l&&l>1&&w.push(l),(u==null?void 0:u.prototype)===three_module.o6l.prototype){if(d!==o)throw"Width and height of cube render target must be equal";w=[d]}c={format:three_module.GWd,minFilter:three_module.k6q,magFilter:three_module.k6q,generateMipmaps:!1,type:three_module.OUM,colorSpace:three_module.jf0,...c};const C=[this,...w,c];return new class extends((h=u)!==null&&h!==void 0?h:three_module.nWS){constructor(M,...O){super(...O),this.renderer=M,this.assetType="renderTarget",this.name="RenderTarget",Array.isArray(this.texture)?this.texture.forEach(ne=>{ne.__target=this,ne.userData||(ne.userData={}),ne.colorSpace=c.colorSpace,ne.toJSON=()=>(console.warn("WebGi RenderTarget: Multiple render target texture.toJSON not supported yet."),{})}):(this.texture.userData||(this.texture.userData={}),this.texture.__toJSON=this.texture.toJSON,this.texture.__target=this,this.texture.toJSON=function(ne){console.warn("WebGi RenderTarget: Render target texture.toJSON might be buggy."),this.source.data.url=A(this.__target,"image/png",90);const ce=this.__toJSON.call(this,ne);return delete this.source.data.url,ce.isRenderTargetTexture=!0,ce})}setSize(M,O,ne){super.setSize(Math.floor(M),Math.floor(O),ne)}clone(M=!0){if(this.isTemporary)throw"Cloning temporary render targets not supported";if(Array.isArray(this.texture))throw"Cloning multiple render targets not supported";const O=super.clone();return O.texture.isRenderTargetTexture=!0,_(O,this.sizeMultiplier||1,M)}}(...C)}getTempTarget(d={}){var o;const l=createRenderTargetKey(d);let c;return!((o=this._tempTargets[l])===null||o===void 0)&&o.length&&(c=this._tempTargets[l].pop()),c?this._setTargetOptions(c,d):(c=this.createTarget(d),this._processNewTempTarget(c,l)),c}_processNewTempTarget(d,o){return d.isTemporary=!0,d.targetKey=o,this._tempTargets[o]===void 0&&(this._tempTargets[o]=[]),d}releaseTempTarget(d){const o=d.targetKey;if(!o||!d.isTemporary)throw"Not a temp target";this._tempTargets[o].length>this.maxTempPerKey?(this.removeTrackedTarget(d),d.dispose()):this._tempTargets[o].push(d)}updateShaderProperties(d){return this.stableNoise?d.uniforms.frameCount?d.uniforms.frameCount.value=this._totalFrameCount:console.warn("WebGi BaseRenderer: no uniform: frameCount"):d.uniforms.frameCount?d.uniforms.frameCount.value=this.frameCount:console.warn("WebGi BaseRenderer:  no uniform: frameCount"),d.uniforms.frameCount2&&(d.uniforms.frameCount2.value=this.frameCount),this}_setTargetOptions(d,o){var l,c,u;d.texture.minFilter=(l=o.minFilter)!==null&&l!==void 0?l:three_module.k6q,d.texture.magFilter=(c=o.magFilter)!==null&&c!==void 0?c:three_module.k6q,d.texture.generateMipmaps=(u=o.generateMipmaps)!==null&&u!==void 0&&u,d.texture.generateMipmaps&&d.texture.minFilter===three_module.k6q&&(d.texture.minFilter=three_module.NZq),d.texture.generateMipmaps||d.texture.minFilter!==three_module.NZq||(d.texture.minFilter=three_module.k6q)}renderTargetToDataUrl(d,o="image/png",l=90,c=0){const u=document.createElement("canvas");u.width=d.width,u.height=d.height;const h=u.getContext("2d");if(!h)throw new Error("Unable to get 2d context");const _=Array.isArray(d.texture)?d.texture[c]:d.texture,A=h.createImageData(d.width,d.height,{colorSpace:["display-p3","srgb"].includes(_.colorSpace)?_.colorSpace:void 0});if(_.type===three_module.ix0){const C=new Uint16Array(d.width*d.height*4);this._renderer.readRenderTargetPixels(d,0,0,d.width,d.height,C,void 0,c),textureDataToImageData({data:C,width:d.width,height:d.height},_.colorSpace,A)}else if(_.type===three_module.RQf){const C=new Float32Array(d.width*d.height*4);this._renderer.readRenderTargetPixels(d,0,0,d.width,d.height,C,void 0,c),textureDataToImageData({data:C,width:d.width,height:d.height},_.colorSpace,A)}else this._renderer.readRenderTargetPixels(d,0,0,d.width,d.height,A.data,void 0,c);h.putImageData(A,0,0);const w=u.toDataURL(o,l);return u.remove(),w}renderTargetToBuffer(d,o=0){const l=(Array.isArray(d.texture)?d.texture[o]:d.texture).type===three_module.ix0?new Uint16Array(d.width*d.height*4):new Uint8Array(d.width*d.height*4);return this._renderer.readRenderTargetPixels(d,0,0,d.width,d.height,l,void 0,o),l}get useLegacyLights(){return this.rendererObject.useLegacyLights}set useLegacyLights(d){this.rendererObject.useLegacyLights=d,this._updated(),this.resetShadows()}get useTotalFrameCount(){return console.warn("WebGi BaseRenderer: useTotalFrameCount is deprecated, use stableNoise instead"),this.stableNoise}set useTotalFrameCount(d){console.warn("WebGi BaseRenderer: useTotalFrameCount is deprecated, use stableNoise instead"),this.stableNoise=d}get renderScale(){return this.displayCanvasScaling}set renderScale(d){this.displayCanvasScaling=d}};function createRenderTargetKey(d={}){var o,l;return[d.sizeMultiplier,d.samples,d.colorSpace,d.type,d.format,d.depthBuffer,d.depthTexture,(o=d.size)===null||o===void 0?void 0:o.width,(l=d.size)===null||l===void 0?void 0:l.height].join(";")}function autoGPUInstanceMeshes(d){var o,l,c,u,h,_,A,w;if(!d.isMaterial&&!d.isBufferGeometry)return;const C=Array.from(d.userData.__appliedMeshes).filter(ce=>!ce.isInstancedMesh&&!!ce.parent&&ce.children.length===0&&!Array.isArray(ce.material));if(C.length<2)return;const M=ce=>{var ue;return ce.parent.uuid+"_"+ce.geometry.uuid+"_"+((ue=ce.material)===null||ue===void 0?void 0:ue.uuid)},O=new Map;for(const ce of C){const ue=M(ce);O.has(ue)||O.set(ue,[]),O.get(ue).push(ce),ce.updateMatrix()}const ne=O.keys();for(const ce of ne){const ue=O.get(ce),ye=ue[0];if(!ye||ue.length<2)continue;const Oe=new three_module.ZLX(ye.geometry,ye.material,ue.length),ke=ye.userData;ye.userData={},Oe.copy(ye),copyObject3DUserData(Oe.userData,ke);const Ve=ye.parent;Oe.position.set(0,0,0),Oe.rotation.set(0,0,0),Oe.scale.set(1,1,1),Oe.updateMatrix();const tt=new Float32Array(3*Oe.count),ht=new Float32Array(4*Oe.count),ut=new Float32Array(3*Oe.count);for(let _t=0;_t<ue.length;_t++){const at=ue[_t],lt=at.matrix;lt.determinant()<0&&(lt.elements[0]*=-1,lt.elements[1]*=-1,lt.elements[2]*=-1),Oe.setMatrixAt(_t,lt),at.position.toArray(tt,3*_t),at.quaternion.toArray(ht,4*_t),at.scale.toArray(ut,3*_t),at.removeFromParent(),(c=(l=(o=at.material)===null||o===void 0?void 0:o.userData)===null||l===void 0?void 0:l.__appliedMeshes)===null||c===void 0||c.delete(at),(_=(h=(u=at.geometry)===null||u===void 0?void 0:u.userData)===null||h===void 0?void 0:h.__appliedMeshes)===null||_===void 0||_.delete(at)}(w=(A=Oe.material.userData)===null||A===void 0?void 0:A.__appliedMeshes)===null||w===void 0||w.add(Oe),Oe.geometry.userData.__appliedMeshes.add(Oe),Oe.sourceTrs={TRANSLATION:new three_module.THS(tt,3),ROTATION:new three_module.THS(ht,4),SCALE:new three_module.THS(ut,3)},Oe.instanceMatrix.needsUpdate=!0,Ve.add(Oe),Ve.setDirty(),console.log("autoGPUInstanceMeshes",ce,ue.length,ye,Oe)}}__decorate([serialize()],BaseRenderer.prototype,"stableNoise",void 0),__decorate([serialize()],BaseRenderer.prototype,"useLegacyLights",null),BaseRenderer=__decorate([serializable("RenderManager")],BaseRenderer);class GLTFMeshGpuInstancingExporter{constructor(o){this.writer=o,this.name="EXT_mesh_gpu_instancing"}writeNode(o,l){if(!o.isInstancedMesh)return;const c=this.writer,u=o;let h=u.sourceTrs;if(!h){const _=new Float32Array(3*u.count),A=new Float32Array(4*u.count),w=new Float32Array(3*u.count),C=new three_module.kn4,M=new three_module.Pq0,O=new three_module.PTz,ne=new three_module.Pq0;for(let ce=0;ce<u.count;ce++)u.getMatrixAt(ce,C),C.decompose(M,O,ne),M.toArray(_,3*ce),O.toArray(A,4*ce),ne.toArray(w,3*ce);h={TRANSLATION:new three_module.THS(_,3),ROTATION:new three_module.THS(A,4),SCALE:new three_module.THS(w,3)}}h={TRANSLATION:c.processAccessor(h.TRANSLATION),ROTATION:c.processAccessor(h.ROTATION),SCALE:c.processAccessor(h.SCALE)},u.instanceColor&&(h._COLOR_0=c.processAccessor(u.instanceColor)),c.extensionsUsed[this.name]=!0,c.extensionsRequired[this.name]=!0,l.extensions=l.extensions||{},l.extensions[this.name]={attributes:h}}}function makeObject3DUiConfig(d,o){if(d.uiConfig)return d.uiConfig;const l={type:"folder",label:()=>d.name||"unnamed",expanded:!0,limitedUi:!0,children:[{type:"checkbox",label:"Visible",property:[d,"visible"],limitedUi:!0},{type:"button",label:"Pick/Focus",value:()=>{d.dispatchEvent({type:"select",ui:!0,value:d,focusCamera:!0})}},{type:"button",label:"Pick Parent",hidden:()=>!d.parent,value:()=>{const u=d.parent;u&&u.dispatchEvent({type:"select",ui:!0,value:u})}},{type:"input",label:"Name",property:[d,"name"],onChange:u=>{var h;u.last&&((h=d.setDirty)===null||h===void 0||h.call(d,{sceneUpdate:!0,refreshUi:!0}))}},{type:"checkbox",label:"Casts Shadow",hidden:()=>!d.isMesh,property:[d,"castShadow"]},{type:"checkbox",label:"Receive Shadow",hidden:()=>!d.isMesh,property:[d,"receiveShadow"]},{type:"checkbox",label:"Frustum culled",property:[d,"frustumCulled"]},{type:"vec3",label:"Position",property:[d,"position"],limitedUi:!0},{type:"vec3",label:"Rotation",property:[d,"rotation"],limitedUi:!0},{type:"vec3",label:"Scale",property:[d,"scale"]},{type:"input",label:"Render Order",property:[d,"renderOrder"]},{type:"button",label:"Auto Scale",prompt:["Auto Scale Radius: Object will be scaled to the given radius",d.userData.autoScaleRadius||"2",!0],value:u=>{if(!u)return;const h=parseFloat(u);return Math.abs(h)>0?(autoScaleObject3D(d,h),()=>autoScaleObject3D(d,h,void 0,!0)):void 0}},{type:"button",label:"Auto Center",value:()=>{if(confirm("Auto Center: Object will be centered, are you sure you want to proceed?"))return autoCenterObject3D(d),()=>autoCenterObject3D(d,!0)}},{type:"button",label:"Pivot to Node Center",value:()=>{if(confirm("Pivot to Center: Adjust the pivot to bounding box center. The object will rotate around the new pivot, are you sure you want to proceed?"))return pivotToBBoxCenter(d)}},{type:"folder",label:"Rotate model",children:["X +","X -","Y +","Y -","Z +","Z -"].map(u=>({type:"button",label:"Rotate "+u+"90",value:()=>{var h;d.rotateOnAxis(new three_module.Pq0(u.includes("X")?1:0,u.includes("Y")?1:0,u.includes("Z")?1:0),Math.PI/2*(u.includes("-")?-1:1)),(h=d.setDirty)===null||h===void 0||h.call(d,{sceneUpdate:!0,refreshUi:!1})}}))},d.userData.license!==void 0?{type:"input",label:"License/Credits",property:[d.userData,"license"],limitedUi:!0}:{}]},c=d;if(c!=null&&c.isMesh&&o!==!1){const u=[()=>{const h=Object.entries(c.morphTargetDictionary||{});return h.length?{label:"Morph Targets",type:"folder",children:h.map(([_,A])=>({type:"slider",label:_,bounds:[0,1],stepSize:1e-4,property:[c.morphTargetInfluences,A],onChange:w=>{var C;(C=d.setDirty)===null||C===void 0||C.call(d,{sceneUpdate:w.last,frameFade:!1,refreshUi:!1})}}))}:void 0},()=>{var h;return(h=c.geometry)===null||h===void 0?void 0:h.uiConfig},()=>{var h;return Array.isArray(c.material)?c.material.length<1?void 0:{label:"Materials",type:"folder",children:c.material.map(_=>_==null?void 0:_.uiConfig).filter(_=>_)}:(h=c.material)===null||h===void 0?void 0:h.uiConfig}];l.children.push(...u)}if(d!=null&&d.isCamera){const u=[{type:"button",label:"Set View",value:()=>{var h;d.dispatchEvent({type:"setView",ui:!0,camera:d}),(h=l.uiRefresh)===null||h===void 0||h.call(l,"postFrame",!0)}},{type:"button",label:"Activate main",hidden:()=>{var h;return(h=d.userData.iCamera)===null||h===void 0?void 0:h.isActiveCamera},value:()=>{var h;d.dispatchEvent({type:"activateMain",ui:!0,camera:d}),(h=l.uiRefresh)===null||h===void 0||h.call(l,"postFrame",!0)}},{type:"button",label:"Deactivate main",hidden:()=>{var h;return!(!((h=d.userData.iCamera)===null||h===void 0)&&h.isActiveCamera)},value:()=>{var h;d.dispatchEvent({type:"activateMain",ui:!0,camera:void 0}),(h=l.uiRefresh)===null||h===void 0||h.call(l,"postFrame",!0)}},{type:"checkbox",label:"Auto LookAt Target",getValue:()=>{var h;return(h=d.userData.autoLookAtTarget)!==null&&h!==void 0&&h},setValue:h=>{var _;d.userData.autoLookAtTarget=h,(_=l.uiRefresh)===null||_===void 0||_.call(l,"postFrame",!0)}}];l.children.push(...u)}return d.uiConfig=l,l}function makeGeometryUiConfig(d){return{label:"Geometry",type:"folder",children:[{type:"input",property:[d,"uuid"],disabled:!0},{type:"input",property:[d,"name"]},{type:"button",label:"Center Geometry",value:()=>{d.center()}},{type:"button",label:"Center Geometry (keep position)",value:()=>{const o=new three_module.Pq0;d.center(o),o.negate();const l=d.userData.__appliedMeshes;for(const c of l)c.updateMatrix(),c.position.copy(o).applyMatrix4(c.matrix),c.setDirty&&c.setDirty()}},{type:"button",label:"Compute vertex normals",value:()=>{d.computeVertexNormals()}},{type:"button",label:"Compute vertex tangents",value:()=>{d.computeTangents()}},{type:"button",label:"Normalize normals",value:()=>{d.normalizeNormals()}},{type:"button",label:"Convert to indexed",hidden:()=>!!d.index,value:()=>{var o;if(d.attributes.index)return;const l=parseFloat((o=prompt("Tolerance","-1"))!==null&&o!==void 0?o:"-1");toIndexedGeometry(d,l)}},{type:"button",label:"Convert to non-indexed",hidden:()=>!d.index,value:()=>{d.attributes.index&&d.toNonIndexed()}},{type:"button",label:"Create uv1 from uv",value:()=>{d.hasAttribute("uv1")&&!confirm("uv1 already exists, replace with uv data?")||d.setAttribute("uv1",d.getAttribute("uv"))}},{type:"button",label:"Remove vertex color attribute",hidden:()=>!d.hasAttribute("color"),value:()=>{d.hasAttribute("color")?confirm("Remove color attribute?")&&d.deleteAttribute("color"):prompt("No color attribute found")}},{type:"button",label:"Auto GPU Instances",hidden:()=>!d.userData.__appliedMeshes||d.userData.__appliedMeshes.size<2,value:()=>{autoGPUInstanceMeshes(d)}},{type:"input",label:"Mesh count",get value(){var o,l,c;return(c=(l=(o=d.userData)===null||o===void 0?void 0:o.__appliedMeshes)===null||l===void 0?void 0:l.size)!==null&&c!==void 0?c:0},set value(o){},disabled:!0}]}}function setupIModel(d,o,l){var c;if(!d)return void console.warn("WebGi: setupIModel: object is undefined");if(d.__disposed&&(console.warn("WebGi: re-init/re-add disposed object, things might not work as intended",d),delete d.__disposed),d.userData||(d.userData={}),d.userData.__iModelSetup&&d.modelObject)return d;d.userData.__iModelSetup=!0;let u=[];u.push(()=>{[...d.children].forEach(O=>{var ne;(ne=O==null?void 0:O.dispose)===null||ne===void 0||ne.call(O),d.add(O)}),d.parent&&d.removeFromParent()}),d.isLight&&!d.assetType?(d.assetType="light",d.lightObject=d):d.isCamera?(d.assetType="camera",d.cameraObject=d):d.assetType||(d.assetType="model"),d.modelObject||(d.modelObject=d),d.setDirty||(d.setDirty=(O={})=>{d.dispatchEvent({...O,type:"objectUpdate",object:d})},d.userData.setDirty&&console.warn("WebGi: userData.setDirty already defined",d.userData.setDirty,d),d.userData.setDirty=O=>{var ne;console.warn("WebGi: userData.setDirty is deprecated, use setDirty directly"),(ne=d.setDirty)===null||ne===void 0||ne.call(d,O)}),d.addEventListener("added",O=>{var ne,ce,ue;const ye=(ce=(ne=d.parent)===null||ne===void 0?void 0:ne.userData.parentRoot)!==null&&ce!==void 0?ce:d.parent;ye!==d.userData.parentRoot&&d.traverse(Oe=>{Oe.userData.parentRoot=ye}),(ue=d.setDirty)===null||ue===void 0||ue.call(d,{change:"addedToParent"})}),d.addEventListener("removed",()=>{var O;(O=d.setDirty)===null||O===void 0||O.call(d,{change:"removedFromParent"}),d.userData.parentRoot!==void 0&&d.traverse(ne=>{ne.userData.parentRoot=void 0})}),u.push(()=>{});const h=d.dispose;d.dispose=()=>{d.dispatchEvent({type:"dispose"}),h==null||h.call(d)},d.userData.dispose&&console.warn("WebGi: userData.dispose already defined"),d.userData.dispose=()=>{var O;console.warn("WebGi: userData.dispose is deprecated, use dispose directly"),(O=d.dispose)===null||O===void 0||O.call(d)};const _=d;!_.isMesh&&!_.isLine||_.userData.__meshSetup||(_.userData.__meshSetup=!0,_.setMaterial||(_.setMaterial=O=>setMeshMaterial(_,O)),_.setGeometry||(_.setGeometry=(O,ne=!1)=>setMeshGeometry(_,O,ne),_.setGeometry(_.geometry,!0)),d.userData.setMaterial&&console.warn("WebGi: userData.setMaterial already defined"),d.userData.setMaterial=O=>{var ne;console.warn("WebGi: userData.setMaterial is deprecated, use setMaterial directly"),(ne=d.setMaterial)===null||ne===void 0||ne.call(d,O)},d.userData.setGeometry&&console.warn("WebGi: userData.setGeometry already defined"),d.userData.setGeometry=(O,...ne)=>{var ce;console.warn("WebGi: userData.setGeometry is deprecated, use setGeometry directly"),(ce=d.setGeometry)===null||ce===void 0||ce.call(d,O,...ne)},d.userData.__keepShadowDef||(d.castShadow=!0,d.receiveShadow=!0,d.userData.__keepShadowDef=!0),u.push(()=>{var O,ne,ce,ue;const ye=((O=_.setMaterial)===null||O===void 0?void 0:O.call(_,void 0))||[],Oe=(ne=_.setGeometry)===null||ne===void 0?void 0:ne.call(_,void 0);for(const ke of ye)ke&&ke.userData&&ke.userData.disposeOnIdle!==!1&&ke.dispose();Oe&&Oe.userData&&Oe.userData.disposeOnIdle!==!1&&Oe.dispose(),(ce=_.setMaterial)===null||ce===void 0||ce.call(_,ye),(ue=_.setGeometry)===null||ue===void 0||ue.call(_,Oe)})),d.uiConfig||d.assetType!=="model"&&d.assetType!=="camera"||(makeObject3DUiConfig(d),u.push(()=>{})),d.addEventListener("objectUpdate",({last:O,refreshUi:ne})=>{var ce,ue;return O!==!1&&ne!==!1&&((ue=(ce=d.uiConfig)===null||ce===void 0?void 0:ce.uiRefresh)===null||ue===void 0?void 0:ue.call(ce,"postFrame",!0,1))}),d.userData.__autoParentDispatchEvents?console.warn("WebGi: object.userData.__autoParentDispatchEvents already set"):(d.userData.__autoParentDispatchEvents=d.userData.__autoParentDispatchEvents||["objectUpdate","materialUpdate","select","materialChanged","textureUpdate"],d.isCamera&&d.userData.__autoParentDispatchEvents.push("activateMain","setView")),o&&(d.userData.parentRoot=o);const A=d.dispatchEvent;d.dispatchEvent=O=>{var ne;!((ne=d.userData.__autoParentDispatchEvents)===null||ne===void 0)&&ne.includes(O.type)&&(O.parentDispatch=!0),O.parentDispatch&&(ce=>{var ue;const ye=(ue=d.userData.parentRoot)!==null&&ue!==void 0?ue:d.parent;ye!=null&&ye.modelObject&&ye.dispatchEvent(ce)})(O),A.call(d,O)};const w=d.clone;d.clone=(...O)=>{const ne=d.userData;d.userData={};let ce=w.call(d,...O);d.userData=ne,copyObject3DUserData(ce.userData,ne);const ue=d.userData.parentRoot;return ue&&ue.assetType!=="model"&&console.warn("WebGi: Cloning an object with a parent that is not an IModel is not supported"),ce=setupIModel(ce,ue,l),ce.userData.cloneParent=d.uuid,ce};const C=d.copy;d.copy=(O,...ne)=>{const ce=O.userData;O.userData={};const ue=C.call(d,O,...ne);return O.userData=ce,copyObject3DUserData(d.userData,O),ue};const M=d.add;return d.add=(...O)=>(O.forEach(ne=>setupIModel(ne,d.userData.parentRoot||d,l)),M.call(d,...O)),(d=(c=l==null?void 0:l(d))!==null&&c!==void 0?c:d).addEventListener("dispose",()=>{u.forEach(O=>O()),u=[]}),[...d.children].forEach(O=>setupIModel(O,d,l)),d}function setMeshMaterial(d,o){var l,c,u,h,_;const A=(Array.isArray(o)?o:[o]).map(ne=>ne==null?void 0:ne.materialObject).filter(ne=>ne);if(d.material==A||A.length===1&&d.material===A[0])return[];d.userData.__materialUpdater||(d.userData.__materialUpdater=()=>{d.dispatchEvent({type:"materialUpdate"})}),d.userData.__textureUpdater||(d.userData.__textureUpdater=()=>{d.dispatchEvent({type:"textureUpdate"})});let w=[];const C=[],M=Array.isArray(d.material)?[...d.material]:[d.material];for(const ne of M)ne&&w.push(ne);const O=[];for(const ne of A)ne.userData.__appliedMeshes||(ne.userData.__appliedMeshes=new Set),O.push(ne),ne&&(w.includes(ne)?w=w.filter(ce=>ce!==ne):C.push(ne));d.material=O.length!==1?O:(l=O[0])!==null&&l!==void 0?l:void 0;for(const ne of w)ne.removeEventListener("materialUpdate",d.userData.__materialUpdater),ne.removeEventListener("textureUpdate",d.userData.__textureUpdater),(u=(c=ne.userData)===null||c===void 0?void 0:c.__appliedMeshes)===null||u===void 0||u.delete(d),ne.dispatchEvent({type:"removeFromMesh",mesh:d,object:d});for(const ne of C)ne.addEventListener("materialUpdate",d.userData.__materialUpdater),ne.addEventListener("textureUpdate",d.userData.__textureUpdater),ne.userData.__appliedMeshes.add(d),ne.dispatchEvent({type:"addToMesh",mesh:d,object:d});return d.dispatchEvent({type:"materialChanged",material:o??void 0,mesh:d}),(_=(h=d.uiConfig)===null||h===void 0?void 0:h.uiRefresh)===null||_===void 0||_.call(h,"postFrame",!0),M}function setMeshGeometry(d,o,l=!1){var c,u,h,_,A,w,C;d.userData.__objectUpdater||(d.userData.__objectUpdater=ne=>{d.dispatchEvent({...ne,type:"objectUpdate"})});let M=d.geometry;const O=M;return(M!==o||l)&&(M&&(M.removeEventListener("geometryUpdate",d.userData.__objectUpdater),(u=(c=M.userData)===null||c===void 0?void 0:c.__appliedMeshes)===null||u===void 0||u.delete(d)),M=o,M&&!M.userData.__appliedMeshes&&(M.userData.__appliedMeshes=new Set),d.geometry=(h=M)!==null&&h!==void 0?h:void 0,M&&(d.updateMorphTargets(),M.addEventListener("geometryUpdate",d.userData.__objectUpdater),(A=(_=M.userData)===null||_===void 0?void 0:_.__appliedMeshes)===null||A===void 0||A.add(d))),o&&!o.uiConfig&&(o.uiConfig=makeGeometryUiConfig(d.geometry)),d.dispatchEvent({type:"geometryChanged",geometry:o??void 0}),(C=(w=d.uiConfig)===null||w===void 0?void 0:w.uiRefresh)===null||C===void 0||C.call(w,"postFrame",!0),O===M?void 0:O||void 0}const iGeometryIgnoredUserData=["appliedMeshes"],iModelIgnoredUserData=["parentRoot","iCamera","iModel"];function copyObject3DUserData(d,o){if(o)for(const l of Object.keys(o))iModelIgnoredUserData.includes(l)||l.startsWith("__")||typeof d[l]!="function"&&typeof o[l]!="function"&&(d[l]=o[l]);return d}var getRandomValues,rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&!(getRandomValues=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}var regex=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(d){return typeof d=="string"&&regex.test(d)}for(var esm_browser_validate=validate,byteToHex=[],i=0;i<256;++i)byteToHex.push((i+256).toString(16).substr(1));function stringify(d){var o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=(byteToHex[d[o+0]]+byteToHex[d[o+1]]+byteToHex[d[o+2]]+byteToHex[d[o+3]]+"-"+byteToHex[d[o+4]]+byteToHex[d[o+5]]+"-"+byteToHex[d[o+6]]+byteToHex[d[o+7]]+"-"+byteToHex[d[o+8]]+byteToHex[d[o+9]]+"-"+byteToHex[d[o+10]]+byteToHex[d[o+11]]+byteToHex[d[o+12]]+byteToHex[d[o+13]]+byteToHex[d[o+14]]+byteToHex[d[o+15]]).toLowerCase();if(!esm_browser_validate(l))throw TypeError("Stringified UUID is invalid");return l}var esm_browser_stringify=stringify;function v4(d,o,l){var c=(d=d||{}).random||(d.rng||rng)();if(c[6]=15&c[6]|64,c[8]=63&c[8]|128,o){l=l||0;for(var u=0;u<16;++u)o[l+u]=c[u];return o}return esm_browser_stringify(c)}var esm_browser_v4=v4;const uiConfigDecorators_typeMap=new Map;function uiConfig(d,o){return(l,c)=>{const u=l.constructor;if(u===Object)throw new Error("All properties in an object are serialized by default");uiConfigDecorators_typeMap.has(u)||uiConfigDecorators_typeMap.set(u,[]);const h=uiConfigDecorators_typeMap.get(u);if(!(h.findIndex(_=>_.propKey===c)<0))throw new Error(`Property ${c} already has a uiConfig decorator`);h.push({params:o||{},propKey:c,uiType:d})}}function uiToggle(d,o){return uiConfig("checkbox",{label:d,params:o})}function uiMonitor(d,o){return uiConfig("monitor",{label:d,params:o})}function uiSlider(d,o,l,c){return uiConfig("slider",{label:d,bounds:o,stepSize:l,params:c})}function uiVector(d,o,l,c){return uiConfig("vec",{label:d,bounds:o,stepSize:l,params:c})}function uiDropdown(d,o,l){return uiConfig("dropdown",{label:d,children:o,params:l})}function uiButton(d,o){return uiConfig("button",{label:d,params:o})}function uiInput(d,o){return uiConfig("input",{label:d,params:o})}function uiColor(d,o){return uiConfig("color",{label:d,params:o})}function uiImage(d,o){return uiConfig("image",{label:d,params:o})}function generateUiConfig(d){let o=d==null?void 0:d.constructor;if(!d||!o)return[];const l=[],c=[];for(;o&&o!==Object;)c.push(o),o=Object.getPrototypeOf(o);if(!c.length||Array.isArray(d)){const u=typeof d=="object"?Object.keys(d):Array.isArray(d)?d.map((h,_)=>_):[];for(const h of u){const _=d[h];if(_==null)continue;const A=_==null?void 0:_.uiConfig;if(A)l.push(A);else{const w=valueToUiType(_);w==="folder"?l.push(generateUiFolder(h+"",_,void 0,"folder",!0)):w&&l.push({type:w,label:h+"",property:[d,h]})}}}return c.reverse().forEach(u=>{var h;(h=uiConfigDecorators_typeMap.get(u))===null||h===void 0||h.forEach(({params:_,propKey:A,uiType:w})=>{let C;if(!w){const M=d[A];C=M==null?void 0:M.uiConfig,C?l.push(C):M!=null&&((w=valueToUiType(M))==="folder"?C=generateUiFolder(A+"",M,void 0,"folder",!0):w&&(C={type:w,label:A+"",property:[d,A]}))}if(C||(C={property:[d,A],type:w||"input"}),_){const M=typeof _.params=="function"?_.params(d):_.params||{};delete _.params,Object.assign(C,{..._,...M})}l.push(C)})}),l}function generateUiFolder(d,o,l={},c="folder",u=!1){return{type:c,label:d,children:u?[()=>generateUiConfig(Ee(o))]:generateUiConfig(Ee(o)),uuid:esm_browser_v4(),...l}}function uiFolder(d,o,l="folder"){return c=>class extends c{constructor(){super(...arguments),this.uiConfig=generateUiFolder(d,this,o||{},l)}}}function uiPanel(d,o){return uiFolder(d,o,"panel")}function valueToUiType(d){return d==null?null:Array.isArray(d)?"folder":typeof d=="boolean"?"checkbox":typeof d=="number"?"number":typeof d=="string"?"input":typeof d=="function"?"button":typeof d.x=="number"?"vec":typeof d.r=="number"?"color":d.isTexture?"image":typeof d=="object"?"folder":null}const _changeEvent={type:"change"},_startEvent={type:"start"},_endEvent={type:"end"},_ray=new three_module.RlV,_plane=new three_module.Zcv,TILT_LIMIT=Math.cos(70*three_module.cj9.DEG2RAD);class OrbitControls extends three_module.Qev{constructor(o,l){super(),this.object=o,this.domElement=l,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new three_module.Pq0,this.minDistance=1e-5,this.maxDistance=1/0,this.autoPushTarget=!0,this.autoPullTarget=!0,this.clampMax=new three_module.Pq0(1/0,1/0,1/0),this.clampMin=new three_module.Pq0(-1/0,-1/0,-1/0),this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.maxZoomSpeed=1,this.maxZoomSpeed=1,this.dollyZoom=!1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.throttleUpdate=0,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:three_module.kBv.ROTATE,MIDDLE:three_module.kBv.DOLLY,RIGHT:three_module.kBv.PAN},this.touches={ONE:three_module.wtR.ROTATE,TWO:three_module.wtR.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return A.phi},this.getAzimuthalAngle=function(){return A.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(_i){_i.addEventListener("keydown",An),this._domElementKeyEvents=_i},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",An),this._domElementKeyEvents=null},this.saveState=function(){c.target0.copy(c.target),c.position0.copy(c.object.position),c.zoom0=c.object.zoom},this.reset=function(){c.target.copy(c.target0),c.object.position.copy(c.position0),c.object.zoom=c.zoom0,c.object.updateProjectionMatrix(),c.dispatchEvent(_changeEvent),c.update(),h=u.NONE},this.update=function(){const _i=new three_module.Pq0,Gi=new three_module.PTz().setFromUnitVectors(o.up,new three_module.Pq0(0,1,0)),sn=Gi.clone().invert(),jt=new three_module.Pq0,Gt=new three_module.PTz,li=new three_module.Pq0,vi=2*Math.PI;return function(xi=null){if(this.throttleUpdate&&this.throttleUpdate>=1&&Date.now()-0<1e3/this.throttleUpdate)return;const mi=c.object.position;_i.copy(mi).sub(c.target),_i.applyQuaternion(Gi),A.setFromVector3(_i),c.autoRotate&&h===u.NONE&&xt(function(pn){return pn!==null?2*Math.PI/60*c.autoRotateSpeed*pn:2*Math.PI/60/60*c.autoRotateSpeed}(xi)),c.enableDamping?(A.theta+=w.theta*c.dampingFactor,A.phi+=w.phi*c.dampingFactor):(A.theta+=w.theta,A.phi+=w.phi);let Ri=c.minAzimuthAngle,Zi=c.maxAzimuthAngle;isFinite(Ri)&&isFinite(Zi)&&(Ri<-Math.PI?Ri+=vi:Ri>Math.PI&&(Ri-=vi),Zi<-Math.PI?Zi+=vi:Zi>Math.PI&&(Zi-=vi),A.theta=Ri<=Zi?Math.max(Ri,Math.min(Zi,A.theta)):A.theta>(Ri+Zi)/2?Math.max(Ri,A.theta):Math.min(Zi,A.theta)),A.phi=Math.max(c.minPolarAngle,Math.min(c.maxPolarAngle,A.phi)),A.makeSafe(),c.enableDamping===!0?c.target.addScaledVector(M,c.dampingFactor):c.target.add(M);let dn=0;c.zoomToCursor&&_t||c.object.isOrthographicCamera||(Math.abs(w.radius)>0&&(c.dollyZoom&&(c.object.zoom=Math.max(Math.max(c.minZoom,.1),Math.min(Math.min(c.maxZoom,20),c.object.zoom*(1+w.radius*(c.enableDamping?c.dampingFactor:1)))),c.object.updateProjectionMatrix(),(c.object.zoom>=Math.min(c.maxZoom,20)||c.object.zoom<=Math.max(c.minZoom,.1))&&(w.radius=0)),A.radius*=1+w.radius*(c.enableDamping?c.dampingFactor:1)),Math.abs(C-1)>1e-5&&(c.dollyZoom&&(c.object.zoom=Math.max(Math.max(c.minZoom,.1),Math.min(Math.min(c.maxZoom,20),c.object.zoom*C)),c.object.updateProjectionMatrix(),(c.object.zoom>=Math.min(c.maxZoom,20)||c.object.zoom<=Math.max(c.minZoom,.1))&&(C=1)),A.radius*=C),c.autoPushTarget&&A.radius<c.minDistance&&(dn=c.minDistance-A.radius),c.autoPullTarget&&A.radius>c.maxDistance&&(dn=c.maxDistance-A.radius)),A.radius=si(A.radius),_i.setFromSpherical(A),_i.applyQuaternion(sn),mi.copy(c.target).add(_i),c.target.add(_i.normalize().multiplyScalar(-dn)),mi.clamp(c.clampMin,c.clampMax),c.target.clamp(c.clampMin,c.clampMax),c.object.lookAt(c.target);let hn=!1;c.enableDamping===!0&&Math.abs(w.theta)+Math.abs(w.phi)+Math.abs(w.radius)+M.length()>.001?(w.theta*=1-c.dampingFactor,w.phi*=1-c.dampingFactor,w.radius*=1-c.dampingFactor,M.multiplyScalar(1-c.dampingFactor),hn=!0):(w.set(0,0,0),M.set(0,0,0));let an=!1;if(c.zoomToCursor&&_t){let pn=null;if(c.object.isPerspectiveCamera){const Yi=A.radius;pn=A.radius*C,pn=si(pn);const nn=Yi-pn;c.object.position.addScaledVector(ht,nn),c.object.updateMatrixWorld()}else if(c.object.isOrthographicCamera){const Yi=new three_module.Pq0(ut.x,ut.y,0);Yi.unproject(c.object),c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom/C)),c.object.updateProjectionMatrix(),an=!0;const nn=new three_module.Pq0(ut.x,ut.y,0);nn.unproject(c.object),c.object.position.sub(nn).add(Yi),c.object.updateMatrixWorld(),pn=A.radius}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),c.zoomToCursor=!1;pn!==null&&(this.screenSpacePanning?c.target.set(0,0,-1).transformDirection(c.object.matrix).multiplyScalar(pn).add(c.object.position):(_ray.origin.copy(c.object.position),_ray.direction.set(0,0,-1).transformDirection(c.object.matrix),Math.abs(c.object.up.dot(_ray.direction))<TILT_LIMIT?o.lookAt(c.target):(_plane.setFromNormalAndCoplanarPoint(c.object.up,c.target),_ray.intersectPlane(_plane,c.target))))}else c.object.isOrthographicCamera&&(c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom/C)),c.object.updateProjectionMatrix(),an=!0);return C=1,_t=!1,!!(an||hn||jt.distanceToSquared(c.object.position)>_||8*(1-Gt.dot(c.object.quaternion))>_||li.distanceToSquared(c.target)>0)&&(c.dispatchEvent(_changeEvent),jt.copy(c.object.position),Gt.copy(c.object.quaternion),li.copy(c.target),an=!1,!0)}}(),this.stopDamping=function(){w.set(0,0,0),M.set(0,0,0)},this.dispose=function(){c.domElement.removeEventListener("contextmenu",Ln),c.domElement.removeEventListener("pointerdown",qt),c.domElement.removeEventListener("pointercancel",Ui),c.domElement.removeEventListener("wheel",Xi),c.domElement.removeEventListener("pointermove",Li),c.domElement.removeEventListener("pointerup",Ui),c._domElementKeyEvents!==null&&(c._domElementKeyEvents.removeEventListener("keydown",An),c._domElementKeyEvents=null)};const c=this,u={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let h=u.NONE;const _=1e-6,A=new three_module.YHV,w=new three_module.YHV(0,0,0);let C=1;const M=new three_module.Pq0,O=new three_module.I9Y,ne=new three_module.I9Y,ce=new three_module.I9Y,ue=new three_module.I9Y,ye=new three_module.I9Y,Oe=new three_module.I9Y,ke=new three_module.I9Y,Ve=new three_module.I9Y,tt=new three_module.I9Y,ht=new three_module.Pq0,ut=new three_module.I9Y;let _t=!1;const at=[],lt={};function pt(){return!c.enableDamping||c.zoomToCursor||c.object.isOrthographicCamera?Math.pow(.95,c.zoomSpeed):1}function xt(_i){w.theta-=_i}function Tt(_i){w.phi-=_i}this.rotateUp=Tt,this.rotateLeft=xt;const Pt=function(){const _i=new three_module.Pq0;return function(Gi,sn){_i.setFromMatrixColumn(sn,0),_i.multiplyScalar(-Gi),M.add(_i)}}(),Lt=function(){const _i=new three_module.Pq0;return function(Gi,sn){c.screenSpacePanning===!0?_i.setFromMatrixColumn(sn,1):(_i.setFromMatrixColumn(sn,0),_i.crossVectors(c.object.up,_i)),_i.multiplyScalar(Gi),M.add(_i)}}(),Bt=function(){const _i=new three_module.Pq0;return function(Gi,sn){const jt=c.domElement;if(c.object.isPerspectiveCamera){const Gt=c.object.position;_i.copy(Gt).sub(c.target);let li=_i.length();li*=Math.tan(c.object.fov/2*Math.PI/180),Pt(2*Gi*li/jt.clientHeight,c.object.matrix),Lt(2*sn*li/jt.clientHeight,c.object.matrix)}else c.object.isOrthographicCamera?(Pt(Gi*(c.object.right-c.object.left)/c.object.zoom/jt.clientWidth,c.object.matrix),Lt(sn*(c.object.top-c.object.bottom)/c.object.zoom/jt.clientHeight,c.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),c.enablePan=!1)}}();function Ut(_i,Gi=0){c.object.isPerspectiveCamera||c.object.isOrthographicCamera?(C/=_i,w.radius=Math.max(-c.maxZoomSpeed,Math.min(c.maxZoomSpeed,w.radius-Gi))):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),c.enableZoom=!1)}function kt(_i,Gi=0){c.object.isPerspectiveCamera||c.object.isOrthographicCamera?(C*=_i,w.radius=Math.max(-c.maxZoomSpeed,Math.min(c.maxZoomSpeed,w.radius+Gi))):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),c.enableZoom=!1)}function Vt(_i){if(!c.zoomToCursor)return;_t=!0;const Gi=c.domElement.getBoundingClientRect(),sn=_i.clientX-Gi.left,jt=_i.clientY-Gi.top,Gt=Gi.width,li=Gi.height;ut.x=sn/Gt*2-1,ut.y=-jt/li*2+1,ht.set(ut.x,ut.y,1).unproject(c.object).sub(c.object.position).normalize()}function si(_i){return Math.max(c.minDistance,Math.min(c.maxDistance,_i))}function Jt(_i){O.set(_i.clientX,_i.clientY)}function Wt(_i){ue.set(_i.clientX,_i.clientY)}function Zt(){if(at.length===1)O.set(at[0].pageX,at[0].pageY);else{const _i=.5*(at[0].pageX+at[1].pageX),Gi=.5*(at[0].pageY+at[1].pageY);O.set(_i,Gi)}}function ti(){if(at.length===1)ue.set(at[0].pageX,at[0].pageY);else{const _i=.5*(at[0].pageX+at[1].pageX),Gi=.5*(at[0].pageY+at[1].pageY);ue.set(_i,Gi)}}function ci(){const _i=at[0].pageX-at[1].pageX,Gi=at[0].pageY-at[1].pageY,sn=Math.sqrt(_i*_i+Gi*Gi);ke.set(0,sn)}function ri(_i){if(at.length==1)ne.set(_i.pageX,_i.pageY);else{const sn=Kn(_i),jt=.5*(_i.pageX+sn.x),Gt=.5*(_i.pageY+sn.y);ne.set(jt,Gt)}ce.subVectors(ne,O).multiplyScalar(c.rotateSpeed);const Gi=c.domElement;xt(2*Math.PI*ce.x/Gi.clientHeight),Tt(2*Math.PI*ce.y/Gi.clientHeight),O.copy(ne)}function Ct(_i){if(at.length===1)ye.set(_i.pageX,_i.pageY);else{const Gi=Kn(_i),sn=.5*(_i.pageX+Gi.x),jt=.5*(_i.pageY+Gi.y);ye.set(sn,jt)}Oe.subVectors(ye,ue).multiplyScalar(c.panSpeed),Bt(Oe.x,Oe.y),ue.copy(ye)}function Ht(_i){const Gi=Kn(_i),sn=_i.pageX-Gi.x,jt=_i.pageY-Gi.y,Gt=Math.sqrt(sn*sn+jt*jt);Ve.set(0,Gt),tt.set(0,Math.pow(Ve.y/ke.y,6*c.zoomSpeed)),Ut(tt.y),ke.copy(Ve)}function qt(_i){c.enabled!==!1&&(at.length===0&&(c.domElement.setPointerCapture(_i.pointerId),c.domElement.addEventListener("pointermove",Li),c.domElement.addEventListener("pointerup",Ui)),function(Gi){at.push(Gi)}(_i),_i.pointerType==="touch"?function(Gi){switch(Nn(Gi),at.length){case 1:switch(c.touches.ONE){case three_module.wtR.ROTATE:if(c.enableRotate===!1)return;Zt(),h=u.TOUCH_ROTATE;break;case three_module.wtR.PAN:if(c.enablePan===!1)return;ti(),h=u.TOUCH_PAN;break;default:h=u.NONE}break;case 2:switch(c.touches.TWO){case three_module.wtR.DOLLY_PAN:if(c.enableZoom===!1&&c.enablePan===!1)return;c.enableZoom&&ci(),c.enablePan&&ti(),h=u.TOUCH_DOLLY_PAN;break;case three_module.wtR.DOLLY_ROTATE:if(c.enableZoom===!1&&c.enableRotate===!1)return;c.enableZoom&&ci(),c.enableRotate&&Zt(),h=u.TOUCH_DOLLY_ROTATE;break;default:h=u.NONE}break;default:h=u.NONE}h!==u.NONE&&c.dispatchEvent(_startEvent)}(_i):function(Gi){let sn;switch(Gi.button){case 0:sn=c.mouseButtons.LEFT;break;case 1:sn=c.mouseButtons.MIDDLE;break;case 2:sn=c.mouseButtons.RIGHT;break;default:sn=-1}switch(sn){case three_module.kBv.DOLLY:if(c.enableZoom===!1)return;(function(jt){Vt(jt),ke.set(jt.clientX,jt.clientY)})(Gi),h=u.DOLLY;break;case three_module.kBv.ROTATE:if(Gi.ctrlKey||Gi.metaKey||Gi.shiftKey){if(c.enablePan===!1)return;Wt(Gi),h=u.PAN}else{if(c.enableRotate===!1)return;Jt(Gi),h=u.ROTATE}break;case three_module.kBv.PAN:if(Gi.ctrlKey||Gi.metaKey||Gi.shiftKey){if(c.enableRotate===!1)return;Jt(Gi),h=u.ROTATE}else{if(c.enablePan===!1)return;Wt(Gi),h=u.PAN}break;default:h=u.NONE}h!==u.NONE&&c.dispatchEvent(_startEvent)}(_i))}function Li(_i){c.enabled!==!1&&(_i.pointerType==="touch"?function(Gi){switch(Nn(Gi),h){case u.TOUCH_ROTATE:if(c.enableRotate===!1)return;ri(Gi),c.update();break;case u.TOUCH_PAN:if(c.enablePan===!1)return;Ct(Gi),c.update();break;case u.TOUCH_DOLLY_PAN:if(c.enableZoom===!1&&c.enablePan===!1)return;(function(sn){c.enableZoom&&Ht(sn),c.enablePan&&Ct(sn)})(Gi),c.update();break;case u.TOUCH_DOLLY_ROTATE:if(c.enableZoom===!1&&c.enableRotate===!1)return;(function(sn){c.enableZoom&&Ht(sn),c.enableRotate&&ri(sn)})(Gi),c.update();break;default:h=u.NONE}}(_i):_i.buttons?function(Gi){switch(h){case u.ROTATE:if(c.enableRotate===!1)return;(function(sn){ne.set(sn.clientX,sn.clientY),ce.subVectors(ne,O).multiplyScalar(c.rotateSpeed);const jt=c.domElement;xt(2*Math.PI*ce.x/jt.clientHeight),Tt(2*Math.PI*ce.y/jt.clientHeight),O.copy(ne),c.update()})(Gi);break;case u.DOLLY:if(c.enableZoom===!1)return;(function(sn){Ve.set(sn.clientX,sn.clientY),tt.subVectors(Ve,ke),tt.y>0?Ut(pt()):tt.y<0&&kt(pt()),ke.copy(Ve),c.update()})(Gi);break;case u.PAN:if(c.enablePan===!1)return;(function(sn){ye.set(sn.clientX,sn.clientY),Oe.subVectors(ye,ue).multiplyScalar(c.panSpeed),Bt(Oe.x,Oe.y),ue.copy(ye),c.update()})(Gi)}}(_i):Ui(_i))}function Ui(_i){(function(Gi){delete lt[Gi.pointerId];for(let sn=0;sn<at.length;sn++)if(at[sn].pointerId==Gi.pointerId)return void at.splice(sn,1)})(_i),at.length===0&&(c.domElement.releasePointerCapture(_i.pointerId),c.domElement.removeEventListener("pointermove",Li),c.domElement.removeEventListener("pointerup",Ui)),c.dispatchEvent(_endEvent),h=u.NONE}function Xi(_i){c.enabled!==!1&&c.enableZoom!==!1&&h===u.NONE&&(_i.preventDefault(),c.dispatchEvent(_startEvent),function(Gi){Vt(Gi);let sn=0;switch(Gi.deltaMode){case 2:sn+=1*Gi.deltaY;break;case 1:sn+=.4*Gi.deltaY;break;default:sn+=.01*Gi.deltaY}Gi.deltaY<0?c.zoomToCursor||c.object.isOrthographicCamera?kt(pt()):kt(1,sn*c.zoomSpeed):Gi.deltaY>0&&(c.zoomToCursor||c.object.isOrthographicCamera?Ut(pt()):Ut(1,-sn*c.zoomSpeed)),c.update()}(_i),c.dispatchEvent(_endEvent))}function An(_i){c.enabled!==!1&&c.enablePan!==!1&&function(Gi){let sn=!1;switch(Gi.code){case c.keys.UP:Gi.ctrlKey||Gi.metaKey||Gi.shiftKey?Tt(2*Math.PI*c.rotateSpeed/c.domElement.clientHeight):Bt(0,c.keyPanSpeed),sn=!0;break;case c.keys.BOTTOM:Gi.ctrlKey||Gi.metaKey||Gi.shiftKey?Tt(-2*Math.PI*c.rotateSpeed/c.domElement.clientHeight):Bt(0,-c.keyPanSpeed),sn=!0;break;case c.keys.LEFT:Gi.ctrlKey||Gi.metaKey||Gi.shiftKey?xt(2*Math.PI*c.rotateSpeed/c.domElement.clientHeight):Bt(c.keyPanSpeed,0),sn=!0;break;case c.keys.RIGHT:Gi.ctrlKey||Gi.metaKey||Gi.shiftKey?xt(-2*Math.PI*c.rotateSpeed/c.domElement.clientHeight):Bt(-c.keyPanSpeed,0),sn=!0}sn&&(Gi.preventDefault(),c.update())}(_i)}function Ln(_i){c.enabled!==!1&&_i.preventDefault()}function Nn(_i){let Gi=lt[_i.pointerId];Gi===void 0&&(Gi=new three_module.I9Y,lt[_i.pointerId]=Gi),Gi.set(_i.pageX,_i.pageY)}function Kn(_i){const Gi=_i.pointerId===at[0].pointerId?at[1]:at[0];return lt[Gi.pointerId]}this.zoomIn=function(_i){Ut(1,_i*c.zoomSpeed)},this.zoomOut=function(_i){kt(1,_i*c.zoomSpeed)},c.domElement.addEventListener("contextmenu",Ln),c.domElement.addEventListener("pointerdown",qt),c.domElement.addEventListener("pointercancel",Ui),c.domElement.addEventListener("wheel",Xi,{passive:!1}),this.update()}}var OrbitControls3_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let OrbitControls3=class extends OrbitControls{constructor(){super(...arguments),this.type="OrbitControls",this.enabled=!0,this.dollyZoom=!1,this.zoomToCursor=!1,this.enableDamping=!0,this.dampingFactor=.08,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableZoom=!0,this.zoomSpeed=.15,this.maxZoomSpeed=.2,this.enableRotate=!0,this.rotateSpeed=2,this.enablePan=!0,this.panSpeed=1,this._autoPushTarget=!1,this.autoPushTarget2=!1,this.autoPullTarget=!1,this.minDistance=.35,this.maxDistance=1e3,this.minZoom=.01,this.maxZoom=1e3,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1e4,this.maxAzimuthAngle=1e4,this.clampMin=new three_module.Pq0(-1e4,-1e4,-1e4),this.clampMax=new three_module.Pq0(1e4,1e4,1e4),this.screenSpacePanning=!0,this.keyPanSpeed=7,this.throttleUpdate=60}get autoPushTarget(){return this._autoPushTarget||this.autoPushTarget2}set autoPushTarget(d){this._autoPushTarget=d}zoomIn(d){super.zoomIn(d)}zoomOut(d){super.zoomOut(d)}dispatchEvent(d){super.dispatchEvent(d)}};OrbitControls3_decorate([serialize()],OrbitControls3.prototype,"type",void 0),OrbitControls3_decorate([uiToggle()],OrbitControls3.prototype,"enabled",void 0),OrbitControls3_decorate([uiToggle(),serialize()],OrbitControls3.prototype,"dollyZoom",void 0),OrbitControls3_decorate([uiToggle(),serialize()],OrbitControls3.prototype,"zoomToCursor",void 0),OrbitControls3_decorate([uiToggle(),serialize()],OrbitControls3.prototype,"enableDamping",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"dampingFactor",void 0),OrbitControls3_decorate([uiToggle(),serialize()],OrbitControls3.prototype,"autoRotate",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"autoRotateSpeed",void 0),OrbitControls3_decorate([uiToggle(),serialize()],OrbitControls3.prototype,"enableZoom",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"zoomSpeed",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"maxZoomSpeed",void 0),OrbitControls3_decorate([uiToggle(),serialize()],OrbitControls3.prototype,"enableRotate",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"rotateSpeed",void 0),OrbitControls3_decorate([uiToggle(),serialize()],OrbitControls3.prototype,"enablePan",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"panSpeed",void 0),OrbitControls3_decorate([uiInput(),serialize("autoPushTarget")],OrbitControls3.prototype,"_autoPushTarget",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"autoPullTarget",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"minDistance",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"maxDistance",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"minZoom",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"maxZoom",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"minPolarAngle",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"maxPolarAngle",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"minAzimuthAngle",void 0),OrbitControls3_decorate([uiInput(),serialize()],OrbitControls3.prototype,"maxAzimuthAngle",void 0),OrbitControls3_decorate([uiVector(),serialize()],OrbitControls3.prototype,"clampMin",void 0),OrbitControls3_decorate([uiVector(),serialize()],OrbitControls3.prototype,"clampMax",void 0),OrbitControls3_decorate([serialize()],OrbitControls3.prototype,"screenSpacePanning",void 0),OrbitControls3_decorate([serialize()],OrbitControls3.prototype,"keyPanSpeed",void 0),OrbitControls3=OrbitControls3_decorate([uiPanel("Orbit Controls")],OrbitControls3);var CameraController_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class CameraController extends three_module.Qev{get controls(){return this._controls}getControls(){return this._controls}get userData(){return this._camera.modelObject.userData}set userData(o){this._camera.modelObject.userData=o}get isActiveCamera(){return this._isActiveCamera}get target(){return this._target}set target(o){const l=this._target.sub(o).length()>0;this._target.copy(o),l&&this.targetUpdated()}get position(){return this._position}set position(o){const l=this._position.sub(o).length()>0;this._position.copy(o),l&&this.positionUpdated()}get name(){return this._camera.name}set name(o){this._camera.name=o}getCameraOptions(){return{...this._options,position:this._position.toArray(),target:this._target.toArray()}}setCameraOptions(o,l=!0){var c,u;const h={...o};!((c=h.position)===null||c===void 0)&&c.isVector3&&(h.position=[h.position.x,h.position.y,h.position.z]),!((u=h.target)===null||u===void 0)&&u.isVector3&&(h.target=[h.target.x,h.target.y,h.target.z]),Object.keys(h).forEach(_=>_!=="frustumSize"&&h[_]===void 0&&delete h[_]),Object.assign(this._options,h),this._refreshCameraOptions(!1),this.refreshCameraControls(!1),l&&this.setDirty({optionsUpdate:!0})}_refreshCameraOptions(o=!0){let l=this._camera.modelObject;if(this._options.type!==l.type){const u=this._options.type==="PerspectiveCamera"?new three_module.ubm:new three_module.qUd;u.name=this._camera.name,u.near=this._camera.modelObject.near,u.far=this._camera.modelObject.far,u.zoom=this._camera.modelObject.zoom,u.scale.copy(this._camera.modelObject.scale);const h=this._isActiveCamera;h&&this.deactivateMain(),this._camera=this._setCameraObject(u),l=this._camera.modelObject,h&&this.activateMain(),this._camera.modelObject.updateProjectionMatrix()}let c=this._options.aspect;if(c==="auto"&&(c=this._container.clientWidth/this._container.clientHeight,isFinite(c)||(c=1)),this._options.position&&(this.position.set(...this._options.position),delete this._options.position),this._options.target&&(this.target.set(...this._options.target),delete this._options.target),this.positionUpdated(!1),this._options.type==="PerspectiveCamera"&&(l.fov=this._options.fov,l.focus=this._options.focus,l.aspect=c),this._options.type==="OrthographicCamera"){const u=this._options.frustumSize;u!==void 0?(l.top=u/2,l.bottom=-u/2,l.left=c*u/2,l.right=-c*u/2):(l.top=this._options.top,l.bottom=this._options.bottom,l.left=this._options.left,l.right=this._options.right)}l.zoom=this._options.zoom,this._nearFarChanged(),o&&this.setDirty()}_setCameraObject(o){return this._camera&&this._camera.removeEventListener("objectUpdate",this._cameraObjectUpdate),this._camera=setupIModel(o),this._camera.addEventListener("objectUpdate",this._cameraObjectUpdate),this._camera}get interactionsEnabled(){return this._interactionsDisabledBy.size===0&&this._isActiveCamera&&this._options.controlsEnabled&&this._options.controlsMode!==""}set interactionsEnabled(o){this.setInteractions(o,"_default")}setInteractions(o,l){const c=this._interactionsDisabledBy.size;o?this._interactionsDisabledBy.delete(l):this._interactionsDisabledBy.add(l),c!==this._interactionsDisabledBy.size&&this.refreshCameraControls(!0)}_nearFarChanged(){this._camera&&(this._camera.modelObject.near=this.near,this._camera.modelObject.far=this.far,this._camera.modelObject.updateProjectionMatrix())}constructor(o,l,c){super(),this._controlsMode="",this._isActiveCamera=!1,this._cameraObjectUpdate=_=>{this.setDirty(_)},this._interactionsDisabledBy=new Set,this.autoLookAtTarget=!1,this.near=.01,this.far=50,this._options={type:"PerspectiveCamera",aspect:"auto",focus:10,fov:25,zoom:1,frustumSize:1,top:1,bottom:-1,left:-1,right:1,controlsMode:"orbit",controlsEnabled:!0},this._position=new three_module.Pq0(0,0,10),this._target=new three_module.Pq0(0,0,0),this._controlsCtors=new Map([["orbit",(_,A)=>{const w=new OrbitControls3(_,A.ownerDocument?A:A.documentElement);return w.screenSpacePanning=!0,w}]]),this._positionWorld=new three_module.Pq0,this._camUi=[{type:"vec3",label:"Position",property:[this,"position"],onChange:()=>this.positionUpdated(!0)},{type:"vec3",label:"Target",property:[this,"target"],onChange:()=>this.targetUpdated(!0)},{type:"slider",bounds:[1,180],label:"Field Of View",hidden:()=>!this._camera.modelObject.isPerspectiveCamera,property:[this._options,"fov"],onChange:()=>this.refreshCameraOptions(),limitedUi:!0},{type:"checkbox",label:"Auto Near far",getValue:()=>{var _;return(_=this._camera.userData.autoNearFar)===null||_===void 0||_},setValue:_=>this._camera.userData.autoNearFar=_,onChange:()=>this.setDirty()},{type:"checkbox",label:"Dolly FoV",getValue:()=>{var _;return(_=this._camera.userData.dollyFov)!==null&&_!==void 0&&_},setValue:_=>this._camera.userData.dollyFov=_,onChange:()=>this.setDirty()},{type:"input",label:()=>{var _;return(_=this._camera.userData.autoNearFar)===null||_===void 0||_?"Min Near":"Near"},getValue:()=>{var _;return(_=this._camera.userData.minNearPlane)!==null&&_!==void 0?_:.5},setValue:_=>this._camera.userData.minNearPlane=_,onChange:()=>this.setDirty()},{type:"input",label:()=>{var _;return(_=this._camera.userData.autoNearFar)===null||_===void 0||_?"Max Far":"Far"},getValue:()=>{var _;return(_=this._camera.userData.maxFarPlane)!==null&&_!==void 0?_:1e3},setValue:_=>this._camera.userData.maxFarPlane=_,onChange:()=>this.setDirty()},()=>({type:"dropdown",label:"Controls Mode",property:[this._options,"controlsMode"],children:["","orbit",...this._controlsCtors.keys()].map(_=>({label:_===""?"none":_,value:_})),onChange:()=>{this.refreshCameraOptions()}})],this.uiConfig={type:"folder",label:"Camera",limitedUi:!0,children:[...this._camUi,()=>{var _;return!((_=this._controls)===null||_===void 0)&&_.zoomIn?{type:"button",label:"Zoom in",value:()=>{var A;(A=this._controls)===null||A===void 0||A.zoomIn(1)}}:{}},()=>{var _;return!((_=this._controls)===null||_===void 0)&&_.zoomOut?{type:"button",label:"Zoom out",value:()=>{var A;(A=this._controls)===null||A===void 0||A.zoomOut(1)}}:{}},()=>{var _;return(_=this._controls)===null||_===void 0?void 0:_.uiConfig}]},this.assetType="model",this.uuid=three_module.cj9.generateUUID(),this.setDirty=this.setDirty.bind(this),this.targetUpdated=this.targetUpdated.bind(this),this._refreshCameraOptions=this._refreshCameraOptions.bind(this),this._container=c??document.body;const u={...l};this._camera=this._setCameraObject(o??(u.type==="OrthographicCamera"?new three_module.qUd(-1,1,1,-1):new three_module.ubm)),this._camera.modelObject.userData.iCamera=this;const h=o;o&&(h.isPerspectiveCamera?(u.fov=h.fov,u.focus=h.focus,u.aspect=h.aspect<=0||h.userData.autoAspect?"auto":h.aspect,u.zoom=h.zoom):h.isOrthographicCamera&&(u.left=h.left,u.right=h.right,u.top=h.top,u.bottom=h.bottom,u.zoom=h.zoom),this.near=h.near,this.far=h.far,this._position.copy(o.position),this.refreshTarget()),this.positionUpdated(!1),this.setCameraOptions(u)}refreshAspect(o=!0){this._options.aspect==="auto"&&this._refreshCameraOptions(o)}refreshTarget(o=4){var l;!((l=this._controls)===null||l===void 0)&&l.enabled&&this._controls.target?this._target.copy(this._controls.target):this.cameraObject.getWorldDirection(this._target).multiplyScalar(o).add(this.cameraObject.getWorldPosition(new three_module.Pq0))}setControlsCtor(o,l,c=!1){c||!this._controlsCtors.has(o)?this._controlsCtors.set(o,l):console.error(o+" already exists.")}removeControlsCtor(o){this._controlsCtors.delete(o)}_initCameraControls(){var o,l,c;const u=this._options.controlsMode;this._controls=(l=(o=this._controlsCtors.get(u))===null||o===void 0?void 0:o(this._camera.modelObject,this._container))!==null&&l!==void 0?l:void 0,this._controls||u===""||console.error("Unable to create controls with mode "+u+". Are you missing a plugin?"),(c=this._controls)===null||c===void 0||c.addEventListener("change",this.setDirty),this._controlsMode=this._controls?u:""}_disposeCameraControls(){var o,l;this._controlsMode,(o=this._controls)===null||o===void 0||o.removeEventListener("change",this.setDirty),(l=this._controls)===null||l===void 0||l.dispose(),this._controlsMode="",this._controls=void 0}refreshCameraControls(o=!0){var l,c;if(this._options.controlsEnabled){const u=this._options.controlsMode;this._controls?this._controlsMode===u&&this._camera.modelObject===this._controls.object||(this._disposeCameraControls(),this._initCameraControls()):this._initCameraControls(),this._controlsMode=u}if(this._controls){const u=this.interactionsEnabled;this._controls.enabled=u,u&&this._camera.modelObject.up.copy(three_module.B69.DEFAULT_UP)}o&&this.setDirty(),(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0)}setDirty(o){var l,c;this._position.copy(this._camera.modelObject.position),this._controls&&this._controls.enabled&&this._controls.target&&this._target.copy(this._controls.target),this._camera.modelObject.fov!==void 0&&(this._options.fov=this._camera.modelObject.fov),this._camera.modelObject.focus!==void 0&&(this._options.focus=this._camera.modelObject.focus),this._camera.modelObject.zoom!==void 0&&(this._options.zoom=this._camera.modelObject.zoom),(c=(l=this.cameraObject).updateProjectionMatrix)===null||c===void 0||c.call(l),this.cameraObject.getWorldPosition(this._positionWorld),this.dispatchEvent({...o,type:"update"}),(o==null?void 0:o.last)!==!1&&this._camUi.forEach(u=>{var h;return(h=u==null?void 0:u.uiRefresh)===null||h===void 0?void 0:h.call(u,"postFrame",!1,1)})}activateMain(o=!0){var l,c;this._isActiveCamera||(this._isActiveCamera=!0,this._camera.modelObject.userData.__lastScale=this._camera.modelObject.scale.clone(),this._camera.modelObject.scale.divide(this._camera.modelObject.getWorldScale(new three_module.Pq0)),o&&(this.refreshCameraControls(!1),this._refreshCameraOptions(!0)),(c=(l=this._camera).setDirty)===null||c===void 0||c.call(l,{change:"activateMain"}))}deactivateMain(o=!0){this._isActiveCamera&&(this._isActiveCamera=!1,this._camera.modelObject.userData.__lastScale&&(this._camera.modelObject.scale.copy(this._camera.modelObject.userData.__lastScale),delete this._camera.modelObject.userData.__lastScale),o&&this.refreshCameraControls(!0))}get cameraObject(){return this._camera.modelObject}get modelObject(){return this._camera.modelObject}dispose(){this._disposeCameraControls()}getFittingDistance(o){const l=o.getSize(new three_module.Pq0);let c=this.cameraObject,u=1;if(c.isPerspectiveCamera&&l.length()>1e-4){const h=isFinite(c.aspect)?c.aspect:1,_=Math.max(1,c.fov)*(Math.PI/180),A=2*Math.atan(Math.tan(_/2)*h),w=l.z/2+Math.abs(l.x/2/Math.tan(A/2)),C=l.z/2+Math.abs(l.y/2/Math.tan(_/2));u=Math.max(w,C)}return u}targetUpdated(o=!0){var l,c;const u=this.target;(c=(l=this._controls)===null||l===void 0?void 0:l.target)===null||c===void 0||c.set(u.x,u.y,u.z),this._controls&&this._controls.enabled&&this._controls.target?o&&this.setDirty():this._camera&&(this._camera.userData.autoLookAtTarget!==void 0&&(this.autoLookAtTarget=this._camera.userData.autoLookAtTarget),this.autoLookAtTarget&&this._camera.modelObject.lookAt(u),o&&this.setDirty())}positionUpdated(o=!0){const l=this.position;this._camera.modelObject.position.set(l.x,l.y,l.z),this.targetUpdated(o)}positionTargetUpdated(o=!0){this.positionUpdated(o)}copyFromCamera(o,l=4){o.getWorldPosition(this._position),o.getWorldDirection(this._target).multiplyScalar(l).add(this._position),this.positionUpdated(!1),this.setCameraOptions({fov:o.fov,focus:o.focus,zoom:o.zoom,type:o.type},!0)}updateShaderProperties(o){var l,c,u,h;return(c=(l=o.uniforms.cameraPositionWorld)===null||l===void 0?void 0:l.value)===null||c===void 0||c.copy(this._positionWorld),(h=(u=o.uniforms.cameraNearFar)===null||u===void 0?void 0:u.value)===null||h===void 0||h.set(this._camera.modelObject.near,this._camera.modelObject.far),o.uniforms.projection&&(o.uniforms.projection.value=this._camera.modelObject.projectionMatrix),o.defines.PERSPECTIVE_CAMERA=this._camera.modelObject.type==="PerspectiveCamera"?"1":"0",o.defines.ORTHOGRAPHIC_CAMERA=this._camera.modelObject.type==="OrthographicCamera"?"1":"0",this}toJSON(o){const l={};return copyObject3DUserData(l,this.userData),Object.assign({userData:l},serializeObject(this,!0,o))}fromJSON(o,l){return o.userData&&(copyObject3DUserData(this.userData,o.userData),delete(o={...o}).userData),o.camOptions&&(this.setCameraOptions(o.camOptions,!1),this.refreshCameraOptions(!1)),deserializeObject(o,this,!0,l),this.positionUpdated(!1),this.refreshCameraOptions(!1),this.setDirty({change:"deserialize"}),this}refreshCameraOptions(o=!0){this.setCameraOptions(this._options,o)}get visible(){return!0}set visible(o){console.error("Cannot set visible on camera",o)}}CameraController_decorate([serialize("camControls")],CameraController.prototype,"_controls",void 0),CameraController_decorate([x(CameraController.prototype._nearFarChanged)],CameraController.prototype,"near",void 0),CameraController_decorate([x(CameraController.prototype._nearFarChanged)],CameraController.prototype,"far",void 0),CameraController_decorate([serialize("camOptions")],CameraController.prototype,"_options",void 0),CameraController_decorate([serialize("position")],CameraController.prototype,"_position",void 0),CameraController_decorate([serialize("target")],CameraController.prototype,"_target",void 0);var RootScene_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class RootScene extends three_module.Z58{get activeCamera(){return this._activeCamera>=0?this._cameras[this._activeCamera]:this._dummyCam}set activeCamera(o){const l=this.activeCamera;if(o||(o=this.defaultCamera),l!==o){if(l&&(l.deactivateMain(),l.removeEventListener("update",this._activeCameraUpdate)),o){o.activateMain(),o.addEventListener("update",this._activeCameraUpdate);let c=this._cameras.indexOf(o);c<0&&(this._cameras.push(o),c=this._cameras.length-1),this._activeCamera=c}else this._activeCamera=-1;this.dispatchEvent({type:"activeCameraChange",lastCamera:l,camera:o}),this.setDirty()}}get renderCamera(){var o;return(o=this._renderCamera)!==null&&o!==void 0?o:this.activeCamera}set renderCamera(o){const l=this._renderCamera;this._renderCamera=o,this.dispatchEvent({type:"renderCameraChange",lastCamera:l,camera:o})}get modelObject(){return this}constructor(o){super(),this.isRootScene=!0,this.assetType="model",this._sceneBounds=new Box3B,this._modelBounds=new Box3B,this._sceneBoundingRadius=0,this._cameras=[],this._activeCamera=-1,this.envMapIntensity=1,this.fixedEnvMapDirection=!1,this.backgroundIntensity=1,this._dummyCam=new CameraController(new three_module.ubm,{controlsMode:"",controlsEnabled:!1}),this.deleteImportedViewerConfigOnLoad=!0,this.autoDisposeSceneMaps=!0,this.environment=null,this.textureSlots={},this.background=null,this.backgroundColor=null,this.setDirty=this.setDirty.bind(this),this.updateScene=this.updateScene.bind(this),this.refreshActiveCameraNearFar=this.refreshActiveCameraNearFar.bind(this),this._activeCameraUpdate=this._activeCameraUpdate.bind(this),this._optionsUpdate=this._optionsUpdate.bind(this),this._onSceneMaterialUpdate=this._onSceneMaterialUpdate.bind(this),this._onSceneUpdate=this._onSceneUpdate.bind(this),this.addEventListener("materialUpdate",this._onSceneMaterialUpdate),this.addEventListener("materialChanged",this._onSceneMaterialUpdate),this.addEventListener("objectUpdate",this._onSceneUpdate),this.defaultCamera=o,this.modelRoot=setupIModel(new three_module.YJl,void 0),this.modelRoot.userData.rootSceneModelRoot=!0,this.modelRoot.name="Scene",this.modelRoot.addEventListener("update",this.setDirty),this.addSceneObject(this.modelRoot,{addToRoot:!0,autoScale:!1}),this.addSceneObject(this.defaultCamera,{addToRoot:!0}),this.activeCamera=this.defaultCamera,this.boxHelper=new three_module.BND(this.getBounds())}addModel(o,l={}){return o.assetType!=="model"&&console.error("Invalid asset type for ",o,", adding anyway"),this.addSceneObject(o,l)}addWidget(o,l={}){o.assetType!=="widget"&&console.warn("Invalid asset type for ",o,", adding anyway"),this.add(o.modelObject)}_addModel(o,l={}){return this._addObject3D(o==null?void 0:o.modelObject,l)}addSceneObject(o,l){var c;if(!o)return o;const u=o.assetType;let h=!1;switch(u){case"model":h=o.modelObject.isCamera,h&&(l={...l,autoScale:!1}),this._addModel(o,l);break;case"material":break;case"texture":this.dispatchEvent({type:"textureAdded",texture:o});break;case"light":this._addLight(o,l);break;default:console.warn("WebGi RootScene: Unknown asset imported",o,u)}return this.dispatchEvent({type:"addSceneObject",object:o,options:l}),this.deleteImportedViewerConfigOnLoad&&(o.__importedViewerConfig||!((c=o.modelObject)===null||c===void 0)&&c.__importedViewerConfig)&&X(2e3).then(()=>{delete o.__importedViewerConfig,o.modelObject&&delete o.modelObject.__importedViewerConfig}),o}_addObject3D(o,{autoScale:l=!0,autoScaleRadius:c=2,addToRoot:u=!1}={}){const h=o;h?(l&&!h.userData.autoScaled&&autoScaleObject3D(h,h.userData.autoScaleRadius||c),h.traverse(_=>{_.isMesh&&!_.userData.__keepShadowDef&&(_.castShadow=!0,_.receiveShadow=!0,_.userData.__keepShadowDef=!0)}),u?this.modelObject.add(h):this.modelRoot.add(h),this.setDirty()):console.error("Invalid Model, cannot add.")}removeSceneModels(){this.modelRoot.clear(),this.modelRoot.children=[],this.setDirty({sceneUpdate:!0})}disposeSceneModels(){[...this.modelRoot.children].forEach(o=>{var l,c;((l=o.dispose)!==null&&l!==void 0?l:(c=o.modelObject)===null||c===void 0?void 0:c.removeFromParent)()}),this.setDirty({sceneUpdate:!0})}_onEnvironmentChange(){var o;((o=this.environment)===null||o===void 0?void 0:o.mapping)===three_module.UTZ&&(this.environment.mapping=three_module.wfO,this.environment.needsUpdate=!0),this.dispatchEvent({type:"environmentChanged",environment:this.environment}),this._onSceneUpdate({geometryChanged:!1})}_onBackgroundChange(){this.dispatchEvent({type:"backgroundChanged",background:this.background,backgroundColor:this.backgroundColor}),this._onSceneUpdate({geometryChanged:!1})}add(...o){return super.add(...o.map(l=>setupIModel(l))),this._onSceneUpdate(),this}setEnvironment(o){const l=this.environment;if(l===o)return;if(this.autoDisposeSceneMaps&&(l==null||l.dispose()),!o)return void(this.environment=null);if(!o.isTexture)return void console.error("Unknown Environment type",o);o.assetType!=="texture"&&console.warn("Environment asset not processed",o);const c=o.textureObject||o;this.environment=c}getEnvironment(){return this.environment}setBackground(o){let l;const c=this.background;if(c!==o){if(this.autoDisposeSceneMaps&&c instanceof three_module.gPd&&c.dispose(),!o||o.assetType==="texture"||o.isTexture||o.isColor||o==="environment")l=((o==null?void 0:o.assetType)==="texture"||o.isTexture)&&o.textureObject||o;else{if(typeof o!="string"&&typeof o!="number")return void console.error("Unknown Background type",o);l=new three_module.Q1f(o)}this.background=l}}setBackgroundColor(o){this.backgroundColor=o?new three_module.Q1f(o):null}getBackground(){return this.background}setDirty(o){return o!=null&&o.sceneUpdate||o!=null&&o.refreshScene?this._onSceneUpdate(o):this.dispatchEvent({type:"update"}),this}updateScene(o){return this._onSceneUpdate(o)}_activeCameraUpdate(o){o.optionsUpdate&&this._optionsUpdate(o),this.setDirty(),this.refreshActiveCameraNearFar(),this.dispatchEvent({...o,type:"activeCameraUpdate"})}_optionsUpdate(o){if(!this.activeCamera.userData.dollyFov)return;const l=new Box3B().expandByObject(this.modelRoot.modelObject,!1,!0),c=this.activeCamera.cameraObject,u=1.5*this.activeCamera.getFittingDistance(l),h=this.activeCamera.target,_=new three_module.Pq0().subVectors(h,c.position).normalize();this.activeCamera.position=_.multiplyScalar(-u).add(h)}_onSceneUpdate(o={}){var l,c,u,h;return o.sceneUpdate===!1&&o.refreshScene===!1||!((l=o.object)===null||l===void 0)&&l.isCamera?this.setDirty(o):(this.refreshActiveCameraNearFar(),this._sceneBounds=this.getBounds(!1,!0),(h=(u=(c=this.boxHelper)===null||c===void 0?void 0:c.box)===null||u===void 0?void 0:u.copy)===null||h===void 0||h.call(u,this._sceneBounds),this._modelBounds=this.getModelBounds(!1,!0),this._sceneBoundingRadius=this._modelBounds.getSize(new three_module.Pq0).length()/2,this.dispatchEvent({...o,type:"sceneUpdate",hierarchyChanged:["addedToParent","removedFromParent"].includes(o.change||"")}),this)}_onSceneMaterialUpdate(o){this.dispatchEvent({...o,type:"sceneMaterialUpdate"})}dispose(){var o;this.disposeSceneModels(),this.clear(),(o=this.environment)===null||o===void 0||o.dispose()}findObjectsByName(o,l){const c=[];return(l??this.modelObject).traverse(u=>{u.name===o&&c.push(u)}),c}addLight(o,l={}){this.addSceneObject(o,l)}_addLight(o,{addToRoot:l=!1}={}){var c;const u=o.lightObject;u&&((c=u.children)===null||c===void 0||c.length,l?this.add(u):this.modelRoot.add(u))}getBounds(o=!1,l=!0,c=!0,u){return new Box3B().expandByObject(this.modelObject,o,l,h=>{var _;return!(!c||h.assetType!=="widget")||(_=u==null?void 0:u(h))!==null&&_!==void 0&&_})}getModelBounds(o=!1,l=!0,c=!0,u){return this.modelRoot==null?new Box3B:new Box3B().expandByObject(this.modelRoot,o,l,h=>{var _;return!(!c||h.assetType!=="widget")||(_=u==null?void 0:u(h))!==null&&_!==void 0&&_})}refreshActiveCameraNearFar(){var o,l,c,u;const h=this.activeCamera;if(!h)return;if(h.cameraObject.userData.autoNearFar===!1)return h.near=(o=h.cameraObject.userData.minNearPlane)!==null&&o!==void 0?o:.5,void(h.far=(l=h.cameraObject.userData.maxFarPlane)!==null&&l!==void 0?l:1e3);const _=this.getBounds(!1),A=h.cameraObject.getWorldPosition(new three_module.Pq0).sub(_.getCenter(new three_module.Pq0)),w=1.5*_.getSize(new three_module.Pq0).length()/2,C=Math.max(.1,-A.clone().normalize().dot(h.cameraObject.getWorldDirection(new three_module.Pq0))),M=A.length(),O=Math.max(Math.max((c=h.cameraObject.userData.minNearPlane)!==null&&c!==void 0?c:.5,.001),C*(M-w)),ne=Math.min(Math.max(O+w,C*(M+w)),(u=h.cameraObject.userData.maxFarPlane)!==null&&u!==void 0?u:1e3);h.near=O,h.far=ne}updateShaderProperties(o){return o.uniforms.sceneBoundingRadius?o.uniforms.sceneBoundingRadius.value=this._sceneBoundingRadius:console.warn("BaseRenderer: no uniform: frameCount"),this}toJSON(o){return serializeObject(this,!0,o)}fromJSON(o,l){const c=o.environment;return c!==void 0&&(this.setEnvironment(deserializeObject(c,this.getEnvironment(),!1,l)),delete o.environment),deserializeObject(o,this,!0,l),o.environment=c,this}get minNearDistance(){var o;return console.error("minNearDistance is deprecated. Use camera.userData.minNearPlane instead"),(o=this.activeCamera.userData.minNearPlane)!==null&&o!==void 0?o:.5}set minNearDistance(o){console.error("minNearDistance is deprecated. Use camera.userData.minNearPlane instead"),this.activeCamera&&(this.activeCamera.userData.minNearPlane=o)}}RootScene_decorate([serialize()],RootScene.prototype,"defaultCamera",void 0),RootScene_decorate([ze(RootScene.prototype.setDirty),serialize()],RootScene.prototype,"envMapIntensity",void 0),RootScene_decorate([ze(RootScene.prototype.setDirty),serialize()],RootScene.prototype,"fixedEnvMapDirection",void 0),RootScene_decorate([ze(RootScene.prototype.setDirty),serialize()],RootScene.prototype,"backgroundIntensity",void 0),RootScene_decorate([serialize(),x(RootScene.prototype._onEnvironmentChange.name)],RootScene.prototype,"environment",void 0),RootScene_decorate([serialize()],RootScene.prototype,"textureSlots",void 0),RootScene_decorate([serialize(),x(RootScene.prototype._onBackgroundChange)],RootScene.prototype,"background",void 0),RootScene_decorate([serialize(),x(RootScene.prototype._onBackgroundChange)],RootScene.prototype,"backgroundColor",void 0);function shaderReplaceString(d,o,l,{replaceAll:c=!1,prepend:u=!1,append:h=!1}={}){if(!d.includes(o))return console.error(`${o} not found in shader`),d;let _=l;return u?_=l+o:h&&(_=o+l),c?d.replaceAll(o,_):d.replace(o,_)}class MaterialExtender{static ApplyMaterialExtensions(o,l,c,u){for(const h of c)this.ApplyMaterialExtension(o,l,h,u)}static ApplyMaterialExtension(o,l,c,u){var h,_;let A=(h=Ee(c.parsFragmentSnippet,u,o))!==null&&h!==void 0?h:"";A.length&&(l.fragmentShader=shaderReplaceString(l.fragmentShader,this.VoidMain,`
`+A+`
`,{prepend:!0})),A=(_=Ee(c.parsVertexSnippet,u,o))!==null&&_!==void 0?_:"",A.length&&(l.vertexShader=shaderReplaceString(l.vertexShader,this.VoidMain,`
`+A+`
`,{prepend:!0})),c.extraUniforms&&(l.uniforms=Object.assign(l.uniforms,c.extraUniforms)),c.extraDefines&&updateMaterialDefines(c.extraDefines,o),c.shaderExtender&&c.shaderExtender(l,o,u),o.lastShader=l}static CacheKeyForExtensions(o,l){let c="";for(const u of l)c+=this.CacheKeyForExtension(o,u);return c}static CacheKeyForExtension(o,l){let c="";return l.customCacheKey&&(c+=l.customCacheKey),l.computeCacheKey&&(c+=l.computeCacheKey(o)),l.extraDefines&&Object.values(l.extraDefines).forEach(u=>c+=u),c}static RegisterExtensions(o,l){const c=[];if(l)for(const u of l)u.isCompatible&&u.isCompatible(o)&&(c.push(u),u.uuid||(u.uuid=esm_browser_v4()),u.__setDirty||(u.__setDirty=()=>{u.updateVersion||(u.updateVersion=0),u.updateVersion++}),u.setDirty||(u.setDirty=u.__setDirty));o.materialExtensions=c,o.__ext_beforeRenderListen||(o.__ext_beforeRenderListen=!0,o.addEventListener("beforeRender",u=>materialBeforeRender(o,u))),o.__ext_afterRenderListen||(o.__ext_afterRenderListen=!0,o.addEventListener("afterRender",u=>materialAfterRender(o,u))),o.__ext_addToMeshListen||(o.__ext_addToMeshListen=!0,o.addEventListener("addToMesh",u=>{var h,_;if(o.materialExtensions)for(const A of o.materialExtensions)(h=A.onAddToMesh)===null||h===void 0||h.call(A,(_=u.mesh)!==null&&_!==void 0?_:u.object,o)})),o.__ext_removeFromMeshListen||(o.__ext_removeFromMeshListen=!0,o.addEventListener("removeFromMesh",u=>{var h,_;if(o.materialExtensions)for(const A of o.materialExtensions)(h=A.onRemoveFromMesh)===null||h===void 0||h.call(A,(_=u.mesh)!==null&&_!==void 0?_:u.object,o)})),o.__ext_materialUpdateListen||(o.__ext_materialUpdateListen=!0,o.addEventListener("materialUpdate",u=>{var h;if(o.materialExtensions)for(const _ of o.materialExtensions)(h=_.onMaterialUpdate)===null||h===void 0||h.call(_,o)}));for(const u of c)u.onRegister&&u.onRegister(o);return c}}function updateMaterialDefines(d,o){let l=!1;o.materialObject&&o.materialObject.defines===void 0&&(o.materialObject.defines={});const c=Object.entries(d);for(const[u,h]of c)h===void 0?o.materialObject.defines[u]!==void 0&&(delete o.materialObject.defines[u],l=!0):o.materialObject.defines[u]!==h&&(o.materialObject.defines[u]=h,l=!0);l&&(o.materialObject.needsUpdate=!0)}function materialBeforeRender(d,{object:o,renderer:l}){var c;if(d.materialExtensions)for(const u of d.materialExtensions){if((c=u.onObjectRender)===null||c===void 0||c.call(u,o,d,l),d.lastShader){const h=Ee(u.updaters)||[];for(const _ of h)_&&_.updateShaderProperties(d.lastShader)}u.updateVersion!==d.materialObject.userData["_"+u.uuid+"_version"]&&(d.materialObject.userData["_"+u.uuid+"_version"]=u.updateVersion,d.materialObject.needsUpdate=!0)}}function materialAfterRender(d,{object:o,renderer:l}){var c;if(d.materialExtensions)for(const u of d.materialExtensions)(c=u.onAfterRender)===null||c===void 0||c.call(u,o,d,l)}MaterialExtender.VoidMain="void main()";var ShaderPass2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class AShaderMaterial2 extends three_module.BKk{constructor(o,l=!1){var c;super(o),this.typeSlug="shaderMat",this.assetType="material",this.materialObject=this,this.materialExtensions=[],this.isRawShaderMaterial=!1,this.extraUniformsToUpload={},l&&(this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"),this.materialExtensions=MaterialExtender.RegisterExtensions(this,(c=o==null?void 0:o.customMaterialExtensions)!==null&&c!==void 0?c:[])}registerMaterialExtensions(o){this.materialExtensions=[...this.materialExtensions,...MaterialExtender.RegisterExtensions(this,o)]}unregisterMaterialExtensions(o){}onBeforeCompile(o,l){MaterialExtender.ApplyMaterialExtensions(this,o,this.materialExtensions,l),this.dispatchEvent({type:"beforeCompile",shader:o,renderer:l}),o.fragmentShader=o.fragmentShader.replaceAll("#glMarker","// "),super.onBeforeCompile(o,l)}customProgramCacheKey(){return super.customProgramCacheKey()+MaterialExtender.CacheKeyForExtensions(this,this.materialExtensions)}onBeforeRender(o,l,c,u,h){super.onBeforeRender(o,l,c,u,h),this.dispatchEvent({type:"beforeRender",renderer:o,scene:l,camera:c,geometry:u,object:h})}onAfterRender(o,l,c,u,h){super.onAfterRender(o,l,c,u,h),this.dispatchEvent({type:"afterRender",renderer:o,scene:l,camera:c,geometry:u,object:h})}setDirty(o){this.needsUpdate=!0,this.dispatchEvent({...o,type:"materialUpdate"})}}class ShaderMaterial2 extends AShaderMaterial2{constructor(){super(...arguments),this.typeSlug="shaderMat"}toJSON(o){throw new Error("Method not supported for this material.")}fromJSON(o,l){throw new Error("Method not supported for this material.")}copyProps(o){throw new Error("Method not supported for this material.")}}class ShaderMaterialEncodingSupport extends ShaderMaterial2{constructor(o,l){super(o),this.typeSlug="shaderMat",this.textures=[],this.setTextureIds(l)}setTextureIds(o){this.textures.map(l=>l.id).join(";")!==o.join(";")&&(this.textures=o.map(l=>({id:l,colorSpace:three_module.jf0})),this.setDirty())}_setUniformTexSize(o,l){var c,u,h,_;if(!l||!o)return;const A=(u=(c=l.image)===null||c===void 0?void 0:c.width)!==null&&u!==void 0?u:512,w=(_=(h=l.image)===null||h===void 0?void 0:h.height)!==null&&_!==void 0?_:512,C=o.value;C.isVector2||console.warn("uniform is not a Vector2"),C&&Math.abs(C.x-A)+Math.abs(C.y-w)>.1&&(C.x=A,C.y=w,this.uniformsNeedUpdate=!0)}onBeforeRender(o,l,c,u,h){var _,A;this._setUniformTexSize(this.uniforms.screenSize,(_=o.getRenderTarget())===null||_===void 0?void 0:_.texture);for(const w of this.textures){const C=w.id,M=(A=this.uniforms[C])===null||A===void 0?void 0:A.value;M&&(this._setUniformTexSize(this.uniforms[C+"Size"],M),M.colorSpace!==w.colorSpace&&(w.colorSpace=M.colorSpace,this.needsUpdate=!0))}super.onBeforeRender(o,l,c,u,h)}onBeforeCompile(o,l){o.fragmentShader=this.textures.map(c=>{var u,h;return`uniform sampler2D ${c.id}; 
`+getTexelDecoding((u=c.id)!==null&&u!==void 0?u:"input",(h=c.colorSpace)!==null&&h!==void 0?h:three_module.jf0)}).join(`
`)+o.fragmentShader,super.onBeforeCompile(o,l)}customProgramCacheKey(){return super.customProgramCacheKey()+this.textures.map(o=>o.id+o.colorSpace).join(";")}}function patchShaderEncodingSupport(d,...o){const l=d.fragmentShader;return new ShaderMaterialEncodingSupport({defines:Object.assign({},d.defines),uniforms:d.uniforms,vertexShader:d.vertexShader,fragmentShader:l},o)}class ShaderPass2 extends ShaderPass{constructor(o,...l){super(o.isMaterial?o:patchShaderEncodingSupport(o,...l),l.length<1?ShaderPass2.DEFAULT_TEX_ID:l[0]),this.onDirty=[],this.isShaderPass2=!0,this.enabled=!0,this.setDirty=this.setDirty.bind(this)}dispose(){var o,l,c,u;(l=(o=this.material)===null||o===void 0?void 0:o.dispose)===null||l===void 0||l.call(o),(u=(c=this.fsQuad)===null||c===void 0?void 0:c.dispose)===null||u===void 0||u.call(c),this.onDirty=[]}setDirty(){this.onDirty.forEach(o=>o())}updateShaderProperties(o){o&&(Array.isArray(o)||(o=[o]),o.forEach(l=>l==null?void 0:l.updateShaderProperties(this.material)))}render(o,l,c,u,h){this.enabled&&super.render(o,l||null,c,u,h)}}ShaderPass2.DEFAULT_TEX_ID="tDiffuse",ShaderPass2_decorate([uiToggle("Enabled"),serialize()],ShaderPass2.prototype,"enabled",void 0);class RenderPass extends Pass{constructor(o,l,c=null,u=null,h=null){super(),this.scene=o,this.camera=l,this.overrideMaterial=c,this.clearColor=u,this.clearAlpha=h,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new three_module.Q1f}render(o,l,c,u,h,_){if(!this.scene||!this.camera)return;const A=o.autoClear;let w,C;if(o.autoClear=!1,this.overrideMaterial!==null&&(C=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(o.getClearColor(this._oldClearColor),o.setClearColor(this.clearColor)),this.clearAlpha!==null&&(w=o.getClearAlpha(),o.setClearAlpha(this.clearAlpha)),this.clearDepth==1&&o.clearDepth(),o.setRenderTarget(this.renderToScreen?null:c),_){const M=o.getContext();M.framebufferRenderbuffer(M.FRAMEBUFFER,M.DEPTH_ATTACHMENT,M.RENDERBUFFER,_)}if(this.clear===!0&&o.clear(o.autoClearColor,o.autoClearDepth,o.autoClearStencil),o.render(this.scene,this.camera),_){const M=o.getContext();M.framebufferRenderbuffer(M.FRAMEBUFFER,M.DEPTH_ATTACHMENT,M.RENDERBUFFER,null)}this.clearColor!==null&&o.setClearColor(this._oldClearColor),this.clearAlpha!==null&&o.setClearAlpha(w),this.overrideMaterial!==null&&(this.scene.overrideMaterial=C),o.autoClear=A}}class GenericBlendTexturePass extends ShaderPass2{constructor(o,l="c = a + b;",c="",u,h=120){super({vertexShader:CopyShader.vertexShader,fragmentShader:fe`
                varying vec2 vUv;
                
                ${c}
                
                void blend(in vec4 a, in vec4 b, inout vec4 c){
                
                ${l}
                
                }
                void main() {
                    vec4 texel = vec4(0);
                    blend(tDiffuseTexelToLinear ( texture2D( tDiffuse, vUv ) ), tDiffuse2TexelToLinear ( texture2D( tDiffuse2, vUv ) ), texel);
                    texel = clamp(texel, vec4(0), vec4(MAX_INTENSITY));
                    gl_FragColor = texel;
                    #include <colorspace_fragment>
                }
            `,uniforms:{tDiffuse:{value:null},tDiffuse2:{value:u},...o},defines:{MAX_INTENSITY:h}},"tDiffuse","tDiffuse2"),this.clear=!1,this.needsSwap=!0}}var depthNormalVert=`#define DEPTH_NORMAL 
#if IS_GLSL3 > 0
out vec3 vViewPosition;
#else
varying vec3 vViewPosition;
#endif
#ifdef USE_ALPHAMAP
#define USE_UV 
#endif
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main(){
#include <uv_vertex>
#include <beginnormal_vertex>
#include <morphnormal_vertex>
#include <skinbase_vertex>
#include <skinnormal_vertex>
#include <defaultnormal_vertex>
#include <normal_vertex>
#include <begin_vertex>
#include <morphtarget_vertex>
#include <skinning_vertex>
#include <displacementmap_vertex>
#include <project_vertex>
#include <logdepthbuf_vertex>
#include <clipping_planes_vertex>
vViewPosition=-mvPosition.xyz;}`,depthNormalFrag=`#define DEPTH_NORMAL 
#if IS_GLSL3 > 0
in vec3 vViewPosition;
#else
varying vec3 vViewPosition;
#endif
#ifdef USE_ALPHAMAP
#define USE_UV 
#include <packing>
#endif
#if IS_GLSL3 > 0
#ifndef gl_FragColor 
layout(location=0)out vec4 A;layout(location=1)out vec4 B;
#endif
#endif
#include <uv_pars_fragment>
#include <normal_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
uniform vec2 cameraNearFar;uniform vec4 flags;vec2 pack16(float value){float f=clamp(value,0.,1.)*255.;float digitLow=fract(f);float digitHigh=floor(f)/255.;return vec2(digitHigh,digitLow);}vec2 packNormal(vec3 n){float p=sqrt(n.z*8.+8.);return vec2(n.xy/p+0.5);}float linstep(float edge0,float edge1,float value){return clamp((value-edge0)/(edge1-edge0),0.,1.);}float getSSCurvature(in vec3 normal){vec3 n=normalize(normal);vec3 dx=dFdx(n);vec3 dy=dFdy(n);vec3 xneg=n-dx;vec3 xpos=n+dx;vec3 yneg=n-dy;vec3 ypos=n+dy;float curvature=(cross(xneg,xpos).y-cross(yneg,ypos).x);return curvature;}void main(){
#glMarker mainStart
#include <clipping_planes_fragment>
vec4 diffuseColor=vec4(1.);
#include <map_fragment>
#ifdef USE_ALPHAMAP
float alphaMapValue=
#ifdef ALPHA_I_RGBA_PACKING
1.-unpackRGBAToDepth(texture2D(alphaMap,vAlphaMapUv));
#else
texture2D(alphaMap,vAlphaMapUv).g;
#endif
#if defined(INVERSE_ALPHAMAP) && INVERSE_ALPHAMAP >= 1
diffuseColor.a*=1.-alphaMapValue;
#else
diffuseColor.a*=alphaMapValue;
#endif
#endif
#include <alphatest_fragment>
#include <logdepthbuf_fragment>
#include <normal_fragment_begin>
#include <normal_fragment_maps>
#ifdef FORCED_LINEAR_DEPTH
float linearZ=float(FORCED_LINEAR_DEPTH);
#else
float linearZ=linstep(-cameraNearFar.x,-cameraNearFar.y,-vViewPosition.z);
#endif
vec2 packedZ=pack16(pow(max(0.,linearZ),0.5));vec2 packedNormal=packNormal(normal);
#if IS_GLSL3 > 0
#ifndef gl_FragColor 
A=vec4(packedZ.x,packedZ.y,packedNormal.x,packedNormal.y);B=flags;B.x=getSSCurvature(normal)*0.5+0.5;
#else
gl_FragColor=vec4(packedZ.x,packedZ.y,packedNormal.x,packedNormal.y);
#endif
#else
gl_FragColor=vec4(packedZ.x,packedZ.y,packedNormal.x,packedNormal.y);
#endif
}`;class DepthNormalMaterial extends ShaderMaterial2{constructor(o=!0){super({vertexShader:depthNormalVert,fragmentShader:depthNormalFrag,uniforms:three_module.LlO.merge([three_module.fCn.common,three_module.fCn.bumpmap,three_module.fCn.normalmap,three_module.fCn.displacementmap,{cameraNearFar:{value:new three_module.I9Y(.1,1e3)},flags:{value:new three_module.IUQ(255,255,255,255)}}]),defines:{IS_GLSL3:o?"1":"0"},glslVersion:o?three_module.Wdf:three_module.Wyr}),this.normalMapType=three_module.bI3,this.flatShading=!1,this._updaters=[]}onBeforeRender(o,l,c,u,h){var _,A,w,C,M,O,ne,ce,ue,ye,Oe,ke,Ve;super.onBeforeRender(o,l,c,u,h);let tt=h.material;Array.isArray(tt)&&(tt=tt[0]),this.uniforms.map.value=(_=tt==null?void 0:tt.map)!==null&&_!==void 0?_:null,this.uniforms.map.value&&o.materials.refreshTransformUniform(this.uniforms.map.value,this.uniforms.mapTransform),this.uniforms.alphaMap.value=(A=tt==null?void 0:tt.alphaMap)!==null&&A!==void 0?A:null,this.uniforms.alphaMap.value&&o.materials.refreshTransformUniform(this.uniforms.alphaMap.value,this.uniforms.alphaMapTransform),this.alphaTest=!tt||!tt.alphaTest||tt.alphaTest<1e-7?.001:tt.alphaTest,this.uniforms.alphaTest.value=this.alphaTest,this.uniforms.displacementMap.value=(w=tt==null?void 0:tt.displacementMap)!==null&&w!==void 0?w:null,this.uniforms.displacementMap.value&&o.materials.refreshTransformUniform(this.uniforms.displacementMap.value,this.uniforms.displacementMapTransform),this.uniforms.displacementScale.value=(C=tt==null?void 0:tt.displacementScale)!==null&&C!==void 0?C:1,this.uniforms.displacementBias.value=(M=tt==null?void 0:tt.displacementBias)!==null&&M!==void 0?M:0,this.uniforms.bumpMap.value=(O=tt==null?void 0:tt.bumpMap)!==null&&O!==void 0?O:null,this.uniforms.bumpMap.value&&o.materials.refreshTransformUniform(this.uniforms.bumpMap.value,this.uniforms.bumpMapTransform),this.uniforms.bumpScale.value=(ne=tt==null?void 0:tt.bumpScale)!==null&&ne!==void 0?ne:1,this.uniforms.normalMap.value=(ce=tt==null?void 0:tt.normalMap)!==null&&ce!==void 0?ce:null,this.uniforms.normalMap.value&&o.materials.refreshTransformUniform(this.uniforms.normalMap.value,this.uniforms.normalMapTransform),this.uniforms.normalScale.value&&this.uniforms.normalScale.value.copy((ue=tt==null?void 0:tt.normalScale)!==null&&ue!==void 0?ue:new three_module.I9Y(1,1)),this.normalMapType=(ye=tt==null?void 0:tt.normalMapType)!==null&&ye!==void 0?ye:three_module.bI3,this.flatShading=(Oe=tt==null?void 0:tt.flatShading)!==null&&Oe!==void 0&&Oe,this.uniforms.flags.value.set(255,255,255,255),this.uniforms.flags.value.z=(tt!=null&&tt.userData.matId?tt==null?void 0:tt.userData.matId:0)/255,this._updaters.forEach(ut=>{ut(h,this.uniforms.flags.value)}),this.uniforms.flags.value.y/=255,this.uniforms.flags.value.w/=255,this.uniformsNeedUpdate=!0;let ht=this.uniforms.alphaMap.value?1:void 0;ht!==this.defines.USE_ALPHAMAP&&(ht===void 0?(delete this.defines.USE_ALPHAMAP,delete this.defines.ALPHAMAP_UV):(this.defines.USE_ALPHAMAP=ht,this.defines.ALPHAMAP_UV="uv"),this.needsUpdate=!0),ht=this.uniforms.map.value?1:void 0,ht!==this.defines.USE_MAP&&(ht===void 0?(delete this.defines.USE_MAP,delete this.defines.MAP_UV):(this.defines.USE_MAP=ht,this.defines.MAP_UV="uv"),this.needsUpdate=!0),ht=this.uniforms.bumpMap.value?1:void 0,ht!==this.defines.USE_BUMPMAP&&(ht===void 0?(delete this.defines.USE_BUMPMAP,delete this.defines.BUMPMAP_UV):(this.defines.USE_BUMPMAP=ht,this.defines.BUMPMAP_UV="uv"),this.needsUpdate=!0),ht=this.uniforms.normalMap.value?1:void 0,ht!==this.defines.USE_NORMALMAP&&(ht===void 0?(delete this.defines.USE_NORMALMAP,delete this.defines.NORMALMAP_UV):(this.defines.USE_NORMALMAP=ht,this.defines.NORMALMAP_UV="uv"),this.needsUpdate=!0),ht=this.uniforms.displacementMap.value?1:void 0,ht!==this.defines.USE_DISPLACEMENTMAP&&(ht===void 0?(delete this.defines.USE_DISPLACEMENTMAP,delete this.defines.DISPLACEMENTMAP_UV):(this.defines.USE_DISPLACEMENTMAP=ht,this.defines.DISPLACEMENTMAP_UV="uv"),this.needsUpdate=!0),ht=tt.userData.ALPHA_I_RGBA_PACKING?1:void 0,ht!==this.defines.ALPHA_I_RGBA_PACKING&&(ht===void 0?delete this.defines.ALPHA_I_RGBA_PACKING:this.defines.ALPHA_I_RGBA_PACKING=ht,this.needsUpdate=!0),ht=(ke=tt.userData.forcedLinearDepth)!==null&&ke!==void 0?ke:void 0,ht!==this.defines.FORCED_LINEAR_DEPTH&&(ht===void 0?delete this.defines.FORCED_LINEAR_DEPTH:this.defines.FORCED_LINEAR_DEPTH=ht,this.needsUpdate=!0),this.side=(Ve=tt.side)!==null&&Ve!==void 0?Ve:three_module.$EB}addGBufferUpdater(o){this._updaters.push(o)}removeGBufferUpdater(o){const l=this._updaters.indexOf(o);l!==-1&&this._updaters.splice(l,1)}}var unpackGbuffer=`#ifndef UNPACK_GBUFFER_SNIPPET
#define UNPACK_GBUFFER_SNIPPET 
uniform sampler2D tNormalDepth;float unpack16(vec2 value){return value.x+value.y/255.;}vec3 unpackNormal(vec2 enc){vec2 fenc=enc*4.-2.;float f=dot(fenc,fenc);float g=sqrt(1.-f/4.);return vec3(fenc*g,1.-f/2.);}float unpackDepth(vec2 uncodedDepth){float x=unpack16(uncodedDepth.xy);return x*x;}float getDepth(vec2 uv){vec4 uncodedDepth=texture2D(tNormalDepth,uv);return unpackDepth(uncodedDepth.xy);}void getDepthNormal(const in vec2 uv,out float depth,out vec3 normal){vec4 uncodedDepth=texture2D(tNormalDepth,uv);depth=unpackDepth(uncodedDepth.xy);normal=unpackNormal(uncodedDepth.zw);}vec3 getViewNormal(const in vec2 uv){return unpackNormal(texture2D(tNormalDepth,uv).zw);}
#if defined(GBUFFER_HAS_FLAGS) && GBUFFER_HAS_FLAGS == 1
uniform sampler2D tGBufferFlags;
#endif
ivec4 getGBufferFlags(const in vec2 uv){
#if defined(GBUFFER_HAS_FLAGS) && GBUFFER_HAS_FLAGS == 1
return ivec4(texture2D(tGBufferFlags,uv)*255.);
#else
return ivec4(1);
#endif
}
#endif
`;class AViewerPlugin extends I{constructor(){super(...arguments),this._dirty=!1}get dirty(){return this.enabled&&this._dirty}set dirty(o){this._dirty=o}get viewer(){return this._viewer}async onAdded(o){this._viewer=o}async onDispose(o){}async onRemove(o){this._viewer!==o&&console.error("Wrong viewer"),this._viewer=void 0}toJSON(o){const l=serializeObject(this,!0,o);return l.type=this.constructor.PluginType,this.dispatchEvent({type:"serialize",data:l}),l}fromJSON(o,l){return o.type!==this.constructor.PluginType?null:(deserializeObject(o,this,!0,l),this.dispatchEvent({type:"deserialize",data:o,meta:l}),this)}_storeKey(o){return(o??"webgi")+"_"+(this.constructor.PluginType||this.constructor.name)}exportState(){var o,l,c,u;return(c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("AssetManager"))===null||l===void 0?void 0:l.exportPluginPreset(this))!==null&&c!==void 0?c:(u=this.toJSON)===null||u===void 0?void 0:u.call(this)}async importState(o){var l,c;const u=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("AssetManager");u?await u.importPluginPreset(o,this):(c=this.fromJSON)===null||c===void 0||c.call(this,o)}storeState(o,l,c){(l=l||(window?window.localStorage:void 0))?(c===void 0&&(c=this.exportState()),c&&l.setItem(this._storeKey(o),JSON.stringify(c))):console.warn("Unable to store state")}async loadState(o,l){if(!(l=l||(window?window.localStorage:void 0)))return void console.warn("Unable to load state");const c=l.getItem(this._storeKey(o));c&&await this.importState(JSON.parse(c))}}function makeFilter(d,o,l){return{...o,get dirty(){return o.dirty||!1},set dirty(c){S(o,"dirty",c,!0)},update(){var c,u,h;this.passObject.enabled&&((u=(c=this.passObject).updateShaderProperties)===null||u===void 0||u.call(c,Ee(l)),(h=o.update)===null||h===void 0||h.call(this))},onRegister(c){var u,h,_;this.passObject.materialExtension&&((h=(u=d.getPluginByType("AssetManager"))===null||u===void 0?void 0:u.materials)===null||h===void 0||h.registerMaterialExtension(this.passObject.materialExtension)),(_=o.onRegister)===null||_===void 0||_.call(this,c)},onUnregister(c){var u,h,_;this.passObject.materialExtension&&((h=(u=d.getPluginByType("AssetManager"))===null||u===void 0?void 0:u.materials)===null||h===void 0||h.unregisterMaterialExtension(this.passObject.materialExtension)),(_=o.onUnregister)===null||_===void 0||_.call(this,c)},dispose(){var c,u,h;(u=(c=this.passObject).dispose)===null||u===void 0||u.call(c),(h=o.dispose)===null||h===void 0||h.call(this)}}}var GenericFilterPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class GenericFilterPlugin extends AViewerPlugin{_update(o){var l;return((l=this._pass)===null||l===void 0?void 0:l.enabled)&&this.enabled||!1}get enabled(){var o,l,c;return(c=(l=(o=this._pass)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.enabled)!==null&&c!==void 0?c:this._enabledTemp}set enabled(o){var l;!((l=this._pass)===null||l===void 0)&&l.passObject&&(this._pass.passObject.enabled=o),this._enabledTemp=o}constructor(){super(),this._enabledTemp=!0}async onAdded(o){await super.onAdded(o);const l={enabled:!0,passId:this.passId,passObject:this.passCtor(o),after:this._afterFilters,before:this._beforeFilters,required:this._requiredFilters,set dirty(c){c&&o.setDirty()},get dirty(){return!1},update:()=>this._update(o)};this._pass=makeFilter(o,l),l.passObject.onDirty!==void 0&&l.passObject.onDirty.push(()=>l.dirty=!0),o.renderer.registerPass(this._pass),this.enabled=this._enabledTemp}async onRemove(o){var l,c;this._pass&&o.renderer.unregisterPass(this._pass),(c=(l=this._pass)===null||l===void 0?void 0:l.dispose)===null||c===void 0||c.call(l),this._pass=void 0,await super.onRemove(o)}get pass(){return this._pass}toJSON(o){var l;const c=super.toJSON(o);if(!c.type)return c;const u=this.pass;return u&&(c.pass=serializeObject((l=u==null?void 0:u.passObject)!==null&&l!==void 0?l:u,!1,o)),c}fromJSON(o,l){var c;if(!super.fromJSON(o,l))return null;if(o.pass){const u=this.pass;u&&deserializeObject(o.pass,(c=u==null?void 0:u.passObject)!==null&&c!==void 0?c:u,!1,l)}return this}}GenericFilterPlugin_decorate([serialize()],GenericFilterPlugin.prototype,"enabled",null);class GBufferRenderPass extends RenderPass{constructor(o,l,c=new three_module.Q1f(1,1,1),u=1){super(void 0,void 0,l,c,u),this.target=o,this._transparentMats=new Set,this._transmissiveMats=new Set}render(o,l,c,u,h){var _;const A=o.getRenderTarget(),w=o.getActiveCubeFace(),C=o.getActiveMipmapLevel();(_=this.scene)===null||_===void 0||_.traverse(({material:M})=>{M&&((M.transparent&&M.userData.renderToDepth||!M.transparent&&M.transmission===0&&M.userData.renderToDepth===!1)&&(this._transparentMats.add(M),M.transparent=!M.transparent),Math.abs(M.transmission||0)>0&&M.userData.renderToDepth&&(this._transmissiveMats.add([M,M.transmission]),M.transmission=0))}),setThreeRendererMode(o,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!1,transmissionRender:!1,mainRenderPass:!1},()=>super.render(o,l,this.target,u,h)),this._transparentMats.forEach(M=>M.transparent=!M.transparent),this._transparentMats.clear(),this._transmissiveMats.forEach(([M,O])=>M.transmission=O),this._transmissiveMats.clear(),o.setRenderTarget(A,w,C)}}class GBufferPlugin extends GenericFilterPlugin{get material(){return this._material}passCtor(o){var l,c,u;const h=((l=this._viewer)===null||l===void 0?void 0:l.renderer.isWebGL2)&&this.renderFlagsBuffer,_=o.renderer.createTarget({depthBuffer:!0,samples:((c=this._viewer)===null||c===void 0?void 0:c.useGBufferDepth)&&((u=this._viewer)===null||u===void 0?void 0:u.renderer.composerTarget.samples)||0,type:three_module.OUM,textureCount:h?2:1,depthTexture:this.renderDepthTexture,depthTextureType:this.depthTextureType});return Array.isArray(_.texture)?(_.texture[0].name="gbufferDepthNormal",_.texture[1].name="gbufferFlags",this._gbufferTextures=_.texture):(_.texture.name="gbufferDepthNormal",this._gbufferTextures.push(_.texture)),this._gbufferTarget=_,this._material=new DepthNormalMaterial(h),this._material.userData.isGBufferMaterial=!0,new GBufferRenderPass(_,this._material)}_update(o){if(!super._update(o))return!1;const l=this.pass.passObject;return l.scene=o.scene.modelObject,o.scene.renderCamera.updateShaderProperties(l.overrideMaterial),l.camera=o.scene.renderCamera.cameraObject,!0}constructor(o=!0,l=!1,c=three_module.bkx){super(),this.renderFlagsBuffer=o,this.renderDepthTexture=l,this.depthTextureType=c,this.passId="gbuffer",this._beforeFilters=["render"],this._afterFilters=[],this._requiredFilters=["render"],this._gbufferTextures=[]}getDepthNormal(){return this._gbufferTextures.length>0?this._gbufferTextures[0]:void 0}getFlagsTexture(){return this._gbufferTextures.length>1?this._gbufferTextures[1]:void 0}async onDispose(o){}async onRemove(o){return this._gbufferTarget&&(o.renderer.disposeTarget(this._gbufferTarget),this._gbufferTarget=void 0),super.onRemove(o)}getTarget(){return this._gbufferTarget}getDepthTexture(){var o;return(o=this._gbufferTarget)===null||o===void 0?void 0:o.depthTexture}getUnpackSnippet(){return unpackGbuffer}updateShaderProperties(o){var l,c,u;if(o.uniforms.tNormalDepth?o.uniforms.tNormalDepth.value=(l=this.getDepthNormal())!==null&&l!==void 0?l:void 0:(c=this._viewer)===null||c===void 0||c.console.warn("BaseRenderer: no uniform: tNormalDepth"),o.uniforms.tGBufferFlags){o.uniforms.tGBufferFlags.value=(u=this.getFlagsTexture())!==null&&u!==void 0?u:void 0;const h=o.uniforms.tGBufferFlags.value?1:0;h!==o.defines.GBUFFER_HAS_FLAGS&&(o.defines.GBUFFER_HAS_FLAGS=h,o.needsUpdate=!0)}return this}registerGBufferUpdater(o){this._material&&this._material.addGBufferUpdater(o)}}GBufferPlugin.PluginType="GBuffer";class RenderPass2 extends RenderPass{get transparentTarget(){return this._transparentTarget||(this._transparentTarget=this._viewer.renderer.getTempTarget({sizeMultiplier:1,samples:this._viewer.renderer.composerTarget.samples||0,colorSpace:three_module.jf0,type:this._viewer.renderer.rendererObject.extensions.has("EXT_color_buffer_half_float")?three_module.ix0:three_module.OUM,format:three_module.GWd,minFilter:three_module.k6q,magFilter:three_module.k6q,depthBuffer:!1})),this._transparentTarget}_releaseTransparentTarget(){this._transparentTarget&&this._viewer.renderer.releaseTempTarget(this._transparentTarget),this._transparentTarget=void 0}constructor(o,l=!0){super(),this.blurTransmissionTarget=!0,this.preserveTransparentTarget=!1,this._viewer=o,this._doTransmissionFix=l,this.clear=!0,this.clearColor=new three_module.Q1f(0,0,0),this.clearAlpha=0,this.clearDepth=!1,this._blendPass=new GenericBlendTexturePass({},"c = vec4(a.rgb * (1. - b.a) + b.rgb * b.a, 1.);",void 0,void 0,o.renderer.maxHDRIntensity)}render(o,l,c,u,h){var _;let A=!1;if(o.userData.mainRenderPass=!0,!this._doTransmissionFix)return super.render(o,l,c,u,h),this.needsSwap=A,void(o.userData.mainRenderPass=void 0);const w=o.userData;w||console.error("threejs is not patched?");const C=this._viewer.useGBufferDepth;let M;if(C){const ne=(_=this._viewer.getPlugin(GBufferPlugin))===null||_===void 0?void 0:_.getTarget();if(ne){const ce=o.properties.get(ne);M=ce.__webglDepthRenderbuffer||ce.__webglDepthbuffer}else console.warn("No Gbuffer present for depth prepass.")}let O=(ne=!1)=>{super.render(o,void 0,c,u,h,M)};if(this._viewer.useRgbm){if(this._viewer.useRgbm){if(A=!1,o.info&&!o.info.autoReset)throw"renderer.info.autoReset must be true";{const ne=o.autoClearDepth;o.autoClearDepth=!C,setThreeRendererMode(o,{shadowMapRender:!0,backgroundRender:!0,opaqueRender:!0,transparentRender:!1,transmissionRender:!1},O),o.autoClearDepth=ne}if(!C){const ne=o.properties.get(c);M=ne.__webglDepthRenderbuffer||ne.__webglDepthbuffer}O=()=>{super.render(o,void 0,this.transparentTarget,u,h,M)};{const ne=this.clear,ce=o.autoClearDepth;o.autoClearDepth=!1,this.clear=!0,setThreeRendererMode(o,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!1,transparentRender:!0,transmissionRender:!1},O),this.clear=ne,o.autoClearDepth=ce}(!o.info||o.info.render.calls>0)&&(this._blendPass.uniforms.tDiffuse2.value=this.transparentTarget.texture,this._blendPass.render(o,l,c,u,h),A=!0);{const ne=this.clear;this.clear=!1,w.transmissionRenderTarget=A?l:c,w.blurTransmissionTarget=this.blurTransmissionTarget&&w.transmissionRenderTarget.samples===0,setThreeRendererMode(o,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!1,transparentRender:!1,transmissionRender:!0},O),w.blurTransmissionTarget=void 0,w.transmissionRenderTarget=void 0,this.clear=ne}(!o.info||o.info.render.calls>0)&&(this._blendPass.uniforms.tDiffuse2.value=this.transparentTarget.texture,this._blendPass.render(o,l,c,u,h),A=!0)}}else{{const ne=this.clear,ce=o.autoClearDepth;o.autoClearDepth=!C,this.clear=!0,setThreeRendererMode(o,{shadowMapRender:!0,backgroundRender:!0,opaqueRender:!0,transparentRender:!0,transmissionRender:!1},O),this.clear=ne,o.autoClearDepth=ce}{this._viewer.renderer.blit(c.texture,l,{clear:!0});const ne=this.clear;this.clear=!1,w.transmissionRenderTarget=l,w.blurTransmissionTarget=this.blurTransmissionTarget,setThreeRendererMode(o,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!1,transparentRender:!1,transmissionRender:!0},O),w.blurTransmissionTarget=void 0,w.transmissionRenderTarget=void 0,this.clear=ne}A=!1}this.preserveTransparentTarget||this._releaseTransparentTarget(),this.needsSwap=A,o.userData.mainRenderPass=void 0}dispose(){this._releaseTransparentTarget(),super.dispose()}}function vRGBMToLinear(d,o){return d.multiplyScalar(d.w*o),d.w=1,d}function cRGBMToLinear(d,o){return vRGBMToLinear(d,o),new three_module.Q1f(d.x,d.y,d.z)}function vLinearToRGBM(d,o){const l=Math.max(d.x,Math.max(d.y,d.z));let c=Math.max(Math.min(l/o,1),0);return c=Math.ceil(255*c)/255,d.divideScalar(c*o),d.w=c,d}function cLinearToRGBM(d,o){return vLinearToRGBM(new three_module.IUQ(d.r,d.g,d.b,1),o)}const threeMaterialPropList={name:"",blending:three_module.NTi,side:three_module.hB5,vertexColors:!1,opacity:1,transparent:!1,blendSrc:three_module.ie2,blendDst:three_module.OuU,blendEquation:three_module.gO9,blendSrcAlpha:null,blendDstAlpha:null,blendEquationAlpha:null,depthFunc:three_module.xSv,depthTest:!0,depthWrite:!0,stencilWriteMask:255,stencilFunc:three_module.sKt,stencilRef:0,stencilFuncMask:255,stencilFail:three_module.VVr,stencilZFail:three_module.VVr,stencilZPass:three_module.VVr,stencilWrite:!1,clippingPlanes:null,clipIntersection:!1,clipShadows:!1,shadowSide:null,colorWrite:!0,precision:null,polygonOffset:!1,polygonOffsetFactor:0,polygonOffsetUnits:0,dithering:!1,alphaToCoverage:!1,premultipliedAlpha:!1,forceSinglePass:!1,visible:!0,toneMapped:!0,userData:{},alphaTest:0,alphaHash:!1},standardMaterialPropList={...threeMaterialPropList,color:"#ffffff",roughness:1,metalness:0,map:null,lightMap:null,lightMapIntensity:1,aoMap:null,aoMapIntensity:1,emissive:"#000000",emissiveIntensity:1,emissiveMap:null,bumpMap:null,bumpScale:1,normalMap:null,normalMapType:three_module.bI3,normalScale:new three_module.I9Y(1,1),displacementMap:null,displacementScale:1,displacementBias:0,roughnessMap:null,metalnessMap:null,alphaMap:null,envMap:null,envMapIntensity:1,wireframe:!1,wireframeLinewidth:1,wireframeLinecap:"round",wireframeLinejoin:"round",flatShading:!1,fog:!0},physicalMaterialPropList={...standardMaterialPropList,clearcoat:0,clearcoatMap:null,clearcoatRoughness:0,clearcoatRoughnessMap:null,clearcoatNormalScale:new three_module.I9Y(1,1),clearcoatNormalMap:null,reflectivity:.5,iridescence:0,iridescenceMap:null,iridescenceIOR:1.3,iridescenceThicknessRange:[100,400],iridescenceThicknessMap:null,sheen:0,sheenColor:new three_module.Q1f(0),sheenColorMap:null,sheenRoughness:1,sheenRoughnessMap:null,transmission:0,transmissionMap:null,thickness:0,thicknessMap:null,attenuationDistance:1/0,attenuationColor:new three_module.Q1f(1,1,1),specularIntensity:1,specularIntensityMap:null,specularColor:new three_module.Q1f(1,1,1),specularColorMap:null};class MeshStandardMaterial2 extends three_module.uSd{constructor(o){var l;super(o),this.typeSlug=MeshStandardMaterial2.TypeSlug,this.assetType="material",this.materialObject=this,this.isMeshStandardMaterial2=!0,this.extraUniformsToUpload={},this.setDirty=this.setDirty.bind(this),this.userData.setDirty=c=>{console.warn("userData.setDirty is deprecated. Use setDirty instead."),this.setDirty(c)},this.fog=!1,this.attenuationDistance=0,this.materialExtensions=MaterialExtender.RegisterExtensions(this,(l=o==null?void 0:o.customMaterialExtensions)!==null&&l!==void 0?l:[])}setDirty(o){var l,c;this.needsUpdate=!0,this.dispatchEvent({...o,type:"materialUpdate"}),(o==null?void 0:o.last)!==!1&&((c=(l=this._uiConfig)===null||l===void 0?void 0:l.uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0,1))}registerMaterialExtensions(o){this.materialExtensions=[...this.materialExtensions,...MaterialExtender.RegisterExtensions(this,o)]}unregisterMaterialExtensions(o){}get uiConfig(){return this._uiConfigChildren||(this._uiConfigChildren=[{type:"input",property:[this,"name"]},{type:"checkbox",property:[this,"wireframe"]},{type:"checkbox",property:[this,"vertexColors"]},{type:"color",property:[this,"color"],limitedUi:!0},{type:"image",property:[this,"map"]},makeSamplerUi(this,"map"),{type:"folder",label:"Rough/Metal",limitedUi:!0,children:[{type:"slider",bounds:[0,1],property:[this,"roughness"],limitedUi:!0},{type:"slider",bounds:[0,1],property:[this,"metalness"],limitedUi:!0},{type:"image",property:[this,"roughnessMap"]},makeSamplerUi(this,"roughnessMap"),{type:"image",property:[this,"metalnessMap"]},makeSamplerUi(this,"metalnessMap")]},{type:"folder",label:"Bump/Normal",limitedUi:!0,children:[{type:"slider",bounds:[-.1,.2],stepSize:.001,property:[this,"bumpScale"],hidden:()=>!this.bumpMap},{type:"image",property:[this,"bumpMap"]},makeSamplerUi(this,"bumpMap"),{type:"image",property:[this,"normalMap"]},{type:"vec2",property:[this,"normalScale"],hidden:()=>!this.normalMap},{type:"dropdown",hidden:()=>!this.normalMap,property:[this,"normalMapType"],children:[["TangentSpace",three_module.bI3],["ObjectSpace",three_module.vyJ]].map(o=>({label:o[0],value:o[1]}))},makeSamplerUi(this,"normalMap"),{type:"input",property:[this,"displacementScale"],hidden:()=>!this.displacementMap},{type:"image",property:[this,"displacementMap"]},makeSamplerUi(this,"displacementMap")]},{type:"folder",label:"Sheen",children:[{type:"slider",bounds:[0,1],property:[this,"sheen"]},{type:"color",hidden:()=>this.sheen<.001,property:[this,"sheenColor"]},{type:"image",property:[this,"sheenColorMap"]},makeSamplerUi(this,"sheenColorMap"),{type:"slider",bounds:[0,1],property:[this,"sheenRoughness"]},{type:"image",property:[this,"sheenRoughnessMap"]},makeSamplerUi(this,"sheenRoughnessMap")]},{type:"folder",label:"Clearcoat",children:[{type:"slider",bounds:[0,1],property:[this,"clearcoat"]},{type:"slider",bounds:[0,1],hidden:()=>this.clearcoat<.001,property:[this,"clearcoatRoughness"]},{type:"image",property:[this,"clearcoatMap"]},makeSamplerUi(this,"clearcoatMap"),{type:"slider",bounds:[0,1],property:[this,"clearcoatRoughness"]},{type:"image",property:[this,"clearcoatRoughnessMap"]},makeSamplerUi(this,"clearcoatRoughnessMap"),{type:"image",property:[this,"clearcoatNormalMap"]},{type:"vec2",property:[this,"clearcoatNormalScale"],hidden:()=>!this.clearcoatNormalMap},makeSamplerUi(this,"clearcoatNormalMap")]},{type:"folder",label:"Emission",children:[{type:"color",property:[this,"emissive"]},{type:"slider",bounds:[0,10],property:[this,"emissiveIntensity"]},{type:"image",property:[this,"emissiveMap"]},makeSamplerUi(this,"emissiveMap")]},{type:"folder",label:"Refraction",children:[{type:"slider",bounds:[0,4],property:[this,"ior"]},{type:"slider",bounds:[0,1],property:[this,"transmission"],limitedUi:!0},{type:"slider",bounds:[0,1],stepSize:.001,property:[this,"thickness"]},{type:"image",property:[this,"transmissionMap"]},makeSamplerUi(this,"transmissionMap"),{type:"image",property:[this,"thicknessMap"]},makeSamplerUi(this,"thicknessMap"),{type:"input",property:[this,"attenuationDistance"]},{type:"color",property:[this,"attenuationColor"]}]},{type:"folder",label:"Blending",children:[{type:"slider",bounds:[0,1],property:[this,"opacity"]},{type:"checkbox",property:[this,"transparent"],onChange:this.setDirty},{type:"dropdown",property:[this,"depthFunc"],children:[["Never",three_module.eHc],["Always",three_module.lGu],["Less",three_module.brA],["LessEqual",three_module.xSv],["Equal",three_module.U3G],["GreaterEqual",three_module.Gwm],["Greater",three_module.K52],["NotEqual",three_module.bw0]].map(o=>({label:o[0],value:o[1]}))},{type:"checkbox",property:[this,"depthTest"],onChange:this.setDirty},{type:"checkbox",property:[this,"depthWrite"],onChange:this.setDirty},{type:"checkbox",property:[this,"colorWrite"],onChange:this.setDirty},{type:"slider",bounds:[0,1],stepSize:.001,property:[this,"alphaTest"]},{type:"checkbox",property:[this,"alphaHash"]},{type:"checkbox",property:[this,"dithering"]},{type:"dropdown",label:"Blending",property:[this,"blending"],children:[["None",three_module.XIg],["Normal",three_module.NTi],["Additive",three_module.EZo],["Subtractive",three_module.Kwu],["Multiply",three_module.EdD]].map(o=>({label:o[0],value:o[1]}))},{type:"image",property:[this,"alphaMap"]},makeSamplerUi(this,"alphaMap"),{type:"checkbox",label:"Render to Depth",getValue:()=>this.userData.renderToDepth===!0,setValue:o=>{this.userData.renderToDepth=o||void 0,this.setDirty()}},{type:"checkbox",label:"Inverse AlphaMap",hidden:()=>!this.transparent,getValue:()=>this.userData.inverseAlphaMap===!0,setValue:o=>{this.userData.inverseAlphaMap=o||void 0,this.setDirty()}},{type:"checkbox",label:"Polygon Offset",property:[this,"polygonOffset"]},{type:"slider",label:"Polygon Offset Factor",bounds:[-10,10],property:[this,"polygonOffsetFactor"]},{type:"slider",label:"Polygon Offset Units",bounds:[-10,10],property:[this,"polygonOffsetUnits"]}]},{type:"folder",label:"AO/Lightmap",children:[{type:"slider",bounds:[0,2],property:[this,"aoMapIntensity"]},{type:"image",property:[this,"aoMap"]},makeSamplerUi(this,"aoMap"),{type:"slider",bounds:[0,2],property:[this,"lightMapIntensity"]},{type:"image",property:[this,"lightMap"]},makeSamplerUi(this,"lightMap")]},{type:"folder",label:"Iridescence",children:[{type:"slider",bounds:[0,3],label:"Intensity",property:[this,"iridescence"]},{type:"slider",bounds:[0,3],label:"IOR",property:[this,"iridescenceIOR"]},{type:"slider",bounds:[0,500],label:"Thickness0",property:[this.iridescenceThicknessRange,"0"],onChange:this.setDirty},{type:"slider",bounds:[0,500],label:"Thickness1",property:[this.iridescenceThicknessRange,"1"],onChange:this.setDirty},{type:"image",property:[this,"iridescenceMap"]},makeSamplerUi(this,"iridescenceMap"),{type:"image",property:[this,"iridescenceThicknessMap"]},makeSamplerUi(this,"iridescenceThicknessMap")]},{type:"folder",label:"Environment",children:[{type:"checkbox",label:"Override Environment",getValue:()=>this.userData.separateEnvMapIntensity===!0,setValue:o=>{this.userData.separateEnvMapIntensity=o,o||delete this.userData.separateEnvMapIntensity},onChange:this.setDirty},{type:"slider",bounds:[0,10],hidden:()=>!this.userData.separateEnvMapIntensity,label:"Environment Intensity",property:[this,"envMapIntensity"]},{type:"dropdown",hidden:()=>!this.userData.separateEnvMapIntensity&&!this.userData.envMapSlotKey,label:"Environment Map",children:["","environment1","environment2"].map(o=>({label:o||"default",value:o})),getValue:()=>this.userData.envMapSlotKey||"",setValue:o=>{this.userData.envMapSlotKey=o,o||delete this.userData.envMapSlotKey,this.setDirty()}}]},{type:"dropdown",label:"Side",property:[this,"side"],children:[["Front",three_module.hB5],["Back",three_module.hsX],["Double",three_module.$EB]].map(o=>({label:o[0],value:o[1]}))},{type:"checkbox",property:[this,"flatShading"]},{type:"input",label:"Mesh count",getValue:()=>{var o,l,c;return(c=(l=(o=this.userData)===null||o===void 0?void 0:o.__appliedMeshes)===null||l===void 0?void 0:l.size)!==null&&c!==void 0?c:0},setValue:o=>{},disabled:!0},{type:"button",label:`Download ${this.typeSlug}`,value:()=>{N(new Blob([JSON.stringify(serializeObject(this,!1),null,2)],{type:"application/json"}),`physical-material.${this.typeSlug}`)}}]),this._uiConfig||(this._uiConfig={type:"folder",label:"Physical Material",expanded:!0,children:this._uiConfigChildren,uuid:"MSM2_"+this.uuid,limitedUi:!0}),this._uiConfig.children=[...this._uiConfigChildren,...this.materialExtensions.map(o=>{var l;return(l=o.getUiConfig)===null||l===void 0?void 0:l.call(o,this)})].filter(o=>o),this._uiConfig}onBeforeCompile(o,l){const c=[["vec3 totalDiffuse = ","afterModulation"],["#include <aomap_fragment>","beforeModulation"],["#include <lights_physical_fragment>","beforeAccumulation"],["#include <clipping_planes_fragment>","mainStart"]],u=[["#include <uv_vertex>","mainStart"]];for(const h of u)o.vertexShader=shaderReplaceString(o.vertexShader,h[0],"#glMarker "+h[1]+`
`+h[0]);for(const h of c)o.fragmentShader=shaderReplaceString(o.fragmentShader,h[0],"#glMarker "+h[1]+`
`+h[0]);MaterialExtender.ApplyMaterialExtensions(this,o,this.materialExtensions,l),o.fragmentShader=o.fragmentShader.replaceAll("#glMarker","// "),o.vertexShader=o.vertexShader.replaceAll("#glMarker","// "),o.defines.INVERSE_ALPHAMAP=this.userData.inverseAlphaMap?1:0,super.onBeforeCompile(o,l)}customProgramCacheKey(){return super.customProgramCacheKey()+MaterialExtender.CacheKeyForExtensions(this,this.materialExtensions)+this.userData.inverseAlphaMap}onBeforeRender(o,l,c,u,h){super.onBeforeRender(o,l,c,u,h),this.envMapIntensity===void 0||this.userData.separateEnvMapIntensity||l.envMapIntensity===void 0||(this.userData.__envIntensity=this.envMapIntensity,this.envMapIntensity=l.envMapIntensity),this.envMap!==void 0&&l.fixedEnvMapDirection!==void 0&&(l.fixedEnvMapDirection?this.defines.FIX_ENV_DIRECTION||(this.defines.FIX_ENV_DIRECTION="1",this.needsUpdate=!0):this.defines.FIX_ENV_DIRECTION!==void 0&&(delete this.defines.FIX_ENV_DIRECTION,this.needsUpdate=!0)),this.dispatchEvent({type:"beforeRender",renderer:o,scene:l,camera:c,geometry:u,object:h});const _=this.userData.inverseAlphaMap?1:0;_!==this.defines.INVERSE_ALPHAMAP&&(this.defines.INVERSE_ALPHAMAP=_,this.needsUpdate=!0)}onAfterRender(o,l,c,u,h){super.onAfterRender(o,l,c,u,h),this.userData.__envIntensity!==void 0&&(this.envMapIntensity=this.userData.__envIntensity,delete this.userData.__envIntensity),this.dispatchEvent({type:"afterRender",renderer:o,scene:l,camera:c,geometry:u,object:h})}copyProps(o,l=!1,c=!0){if(!l&&!["MeshStandardMaterial",MeshStandardMaterial2.TYPE,"MeshPhysicalMaterial"].includes(o.type))return console.error("Material type is not supported:",o.type),this;const u={};xe(o,u,Array.from(Object.keys(physicalMaterialPropList)));const h=u.userData;delete u.userData;for(const _ of Object.keys(u))u[_]===void 0&&delete u[_];if(this.setValues(u),c)for(const _ of iMaterialIgnoredUserData)this.userData[_]!==void 0&&this.userData[_];return h&&copyMaterialUserData(this.userData,h),isFinite(this.attenuationDistance)||(this.attenuationDistance=0),this.setDirty(),this}toJSON(o){var l,c;const u=this.userData;this.userData={};const h=super.toJSON(o);this.userData=u,h.userData={},copyMaterialUserData(h.userData,u),h.userData.uuid=this.userData.uuid;const _=o||{textures:Object.fromEntries(((l=h.textures)===null||l===void 0?void 0:l.map(A=>[A.uuid,A]))||[]),images:Object.fromEntries(((c=h.images)===null||c===void 0?void 0:c.map(A=>[A.uuid,A]))||[])};h.userData=serializeObject(h.userData,!1,_),o||(Object.keys(_.textures).length>0&&(h.textures=Object.values(_.textures)),Object.keys(_.images).length>0&&(h.images=Object.values(_.images))),h.type=MeshStandardMaterial2.TYPE;for(const A of Object.keys(h))h[A]===void 0&&delete h[A];return h}fromJSON(o,l,c=!1){return this.copyProps(o,c)}clone(){return super.clone()}}MeshStandardMaterial2.TypeSlug="pmat",MeshStandardMaterial2.TYPE="MeshStandardMaterial2";const basicMaterialPropList={...threeMaterialPropList,color:"#ffffff",map:null,lightMap:null,lightMapIntensity:1,aoMap:null,aoMapIntensity:1,specularMap:null,alphaMap:null,envMap:null,combine:three_module.caT,reflectivity:1,refractionRatio:.98,wireframe:!1,wireframeLinewidth:1,wireframeLinecap:"round",wireframeLinejoin:"round",skinning:!1,fog:!0};class MeshBasicMaterial2 extends three_module.V9B{constructor(o){var l;super(o),this.typeSlug=MeshBasicMaterial2.TypeSlug,this.assetType="material",this.materialObject=this,this.isMeshBasicMaterial2=!0,this.extraUniformsToUpload={},!this.defines&&(this.defines={}),this.fog=!1,this.setDirty=this.setDirty.bind(this),this.userData.setDirty=c=>{console.warn("WebGi: userData.setDirty is deprecated. Use setDirty instead."),this.setDirty(c)},this.materialExtensions=MaterialExtender.RegisterExtensions(this,(l=o==null?void 0:o.customMaterialExtensions)!==null&&l!==void 0?l:[])}setDirty(o){var l,c;this.needsUpdate=!0,this.dispatchEvent({...o,type:"materialUpdate"}),(o==null?void 0:o.last)!==!1&&((c=(l=this._uiConfig)===null||l===void 0?void 0:l.uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0,1))}registerMaterialExtensions(o){this.materialExtensions=[...this.materialExtensions,...MaterialExtender.RegisterExtensions(this,o)]}unregisterMaterialExtensions(o){}get uiConfig(){return this._uiConfigChildren||(this._uiConfigChildren=[{type:"input",property:[this,"name"]},{type:"checkbox",property:[this,"wireframe"]},{type:"color",property:[this,"color"],limitedUi:!0},{type:"image",property:[this,"map"]},makeSamplerUi(this,"map"),{type:"folder",label:"Blending",children:[{type:"slider",bounds:[0,1],property:[this,"opacity"]},{type:"checkbox",property:[this,"transparent"],onChange:this.setDirty},{type:"checkbox",property:[this,"depthWrite"],onChange:this.setDirty},{type:"checkbox",property:[this,"colorWrite"],onChange:this.setDirty},{type:"slider",bounds:[0,1],property:[this,"alphaTest"]},{type:"checkbox",property:[this,"alphaHash"]},{type:"checkbox",property:[this,"dithering"]},{type:"dropdown",label:"Blending",property:[this,"blending"],children:[["None",three_module.XIg],["Normal",three_module.NTi],["Additive",three_module.EZo],["Subtractive",three_module.Kwu],["Multiply",three_module.EdD]].map(o=>({label:o[0],value:o[1]}))},{type:"image",property:[this,"alphaMap"]},makeSamplerUi(this,"alphaMap"),{type:"checkbox",label:"Render to Depth",getValue:()=>this.userData.renderToDepth===!0,setValue:o=>{this.userData.renderToDepth=o||void 0,this.setDirty()}}]},{type:"folder",label:"AO/Lightmap",children:[{type:"slider",bounds:[0,2],property:[this,"aoMapIntensity"]},{type:"image",property:[this,"aoMap"]},makeSamplerUi(this,"aoMap"),{type:"slider",bounds:[0,2],property:[this,"lightMapIntensity"]},{type:"image",property:[this,"lightMap"]},makeSamplerUi(this,"lightMap")]},{type:"dropdown",label:"Side",property:[this,"side"],children:[["Front",three_module.hB5],["Back",three_module.hsX],["Double",three_module.$EB]].map(o=>({label:o[0],value:o[1]}))},{type:"input",label:"Mesh count",getValue:()=>{var o,l,c;return(c=(l=(o=this.userData)===null||o===void 0?void 0:o.__appliedMeshes)===null||l===void 0?void 0:l.size)!==null&&c!==void 0?c:0},setValue:o=>{},disabled:!0},{type:"button",label:`Download ${this.typeSlug}`,value:()=>{N(new Blob([JSON.stringify(serializeObject(this,!1),null,2)],{type:"application/json"}),`unlit-material.${this.typeSlug}`)}}]),this._uiConfig||(this._uiConfig={type:"folder",label:"Unlit Material",expanded:!0,children:this._uiConfigChildren,uuid:"MBM2_"+this.uuid,limitedUi:!0}),this._uiConfig.children=[...this._uiConfigChildren,...this.materialExtensions.map(o=>{var l;return(l=o.getUiConfig)===null||l===void 0?void 0:l.call(o,this)})].filter(o=>o),this._uiConfig}onBeforeCompile(o,l){const c=[["vec3 outgoingLight = ","afterModulation"],["#include <aomap_fragment>","beforeModulation"],["ReflectedLight reflectedLight = ","beforeAccumulation"],["#include <clipping_planes_fragment>","mainStart"]],u=[["#include <uv_vertex>","mainStart"]];for(const h of u)o.vertexShader=shaderReplaceString(o.vertexShader,h[0],"#glMarker "+h[1]+`
`+h[0]);for(const h of c)o.fragmentShader=shaderReplaceString(o.fragmentShader,h[0],"#glMarker "+h[1]+`
`+h[0]);MaterialExtender.ApplyMaterialExtensions(this,o,this.materialExtensions,l),this.dispatchEvent({type:"beforeCompile",shader:o,renderer:l}),o.fragmentShader=o.fragmentShader.replaceAll("#glMarker","// "),o.vertexShader=o.vertexShader.replaceAll("#glMarker","// "),super.onBeforeCompile(o,l)}customProgramCacheKey(){return super.customProgramCacheKey()+MaterialExtender.CacheKeyForExtensions(this,this.materialExtensions)+this.userData.inverseAlphaMap}onBeforeRender(o,l,c,u,h){super.onBeforeRender(o,l,c,u,h),this.dispatchEvent({type:"beforeRender",renderer:o,scene:l,camera:c,geometry:u,object:h})}onAfterRender(o,l,c,u,h){super.onAfterRender(o,l,c,u,h),this.dispatchEvent({type:"afterRender",renderer:o,scene:l,camera:c,geometry:u,object:h})}copyProps(o,l=!1){if(!l&&!["MeshBasicMaterial",MeshBasicMaterial2.TYPE].includes(o.type))return console.error("Material type is not supported:",o.type),this;const c={};xe(o,c,Array.from(Object.keys(basicMaterialPropList)));const u=c.userData;delete c.userData;for(const h of Object.keys(c))c[h]===void 0&&delete c[h];return this.setValues(c),u&&copyMaterialUserData(this.userData,u),this.setDirty(),this}toJSON(o){var l,c;const u=this.userData;this.userData={};const h=super.toJSON(o);this.userData=u,h.userData={},copyMaterialUserData(h.userData,u),h.userData.uuid=this.userData.uuid;const _=o||{textures:Object.fromEntries(((l=h.textures)===null||l===void 0?void 0:l.map(A=>[A.uuid,A]))||[]),images:Object.fromEntries(((c=h.images)===null||c===void 0?void 0:c.map(A=>[A.uuid,A]))||[])};h.userData=serializeObject(h.userData,!1,_),o||(Object.keys(_.textures).length>0&&(h.textures=Object.values(_.textures)),Object.keys(_.images).length>0&&(h.images=Object.values(_.images))),h.type=MeshBasicMaterial2.TYPE;for(const A of Object.keys(h))h[A]===void 0&&delete h[A];return h}fromJSON(o,l,c=!1){return this.copyProps(o,c)}clone(){return super.clone()}}MeshBasicMaterial2.TypeSlug="bmat",MeshBasicMaterial2.TYPE="MeshBasicMaterial2";const standardMaterialTemplate={materialType:MeshStandardMaterial2.TYPE,name:"standard",color:"#ffffff"},basicMaterialTemplate={materialType:MeshBasicMaterial2.TYPE,name:"basic",color:"#ffffff"},typeTemplateNameMap={[MeshStandardMaterial2.TYPE]:standardMaterialTemplate.name,MeshStandardMaterial:standardMaterialTemplate.name,MeshPhysicalMaterial:standardMaterialTemplate.name,[MeshBasicMaterial2.TYPE]:basicMaterialTemplate.name,MeshBasicMaterial:basicMaterialTemplate.name};class AMaterialManager extends I{constructor(){super(),this._templates=[standardMaterialTemplate,basicMaterialTemplate],this._materials=[],this._disposeMaterial=o=>{const l=o.target;if(!l||l.assetType!=="material")return;this._refreshTextureRefs();const c=this._getMapsForMaterial(l),u=[];c.forEach(h=>{const _=h.userData.__appliedMaterials;_==null||_.delete(l),_&&h.userData.disposeOnIdle!==!1&&_.size===0&&u.push(h)}),u.forEach(h=>{h.dispose()})},this._materialExtensions=[],this.processModel=this.processModel.bind(this),this.processMaterial=this.processMaterial.bind(this)}findOrCreate(o,l){let c=this.findMaterial(o);return c||(c=this.generateFromTemplate(o,l)),c}generateFromTemplate(o,l){const c=this.findTemplate(o);if(c)return this._generateFromTemplate(c,l??{})}generateFromTemplateType(o,l){const c=this._templates.find(u=>u.materialType===o);if(c)return this._generateFromTemplate(c,l??{})}findTemplate(o){return this._templates.find(l=>l.name===o)}_refreshTextureRefs(o){(o||this.getAllMaterials()).forEach(l=>{this._getMapsForMaterial(l).forEach(c=>{let u=c.userData.__appliedMaterials;u||(c.userData.__appliedMaterials=u=new Set),c.addEventListener("update",()=>l.dispatchEvent({type:"textureUpdate",texture:c})),u.add(l)})})}_getMapsForMaterial(o){var l;const c=new Set;for(const u of Object.values(o))u&&u.isTexture&&c.add(u);for(const u of Object.values((l=o.userData)!==null&&l!==void 0?l:{}))u&&u.isTexture&&c.add(u);return c}registerMaterial(o){if(this._materials.includes(o))return;const l=this.findMaterial(o.uuid);l?console.warn("WebGi MaterialManager: Material UUID already exists",o,l):(o.addEventListener("dispose",this._disposeMaterial),this._materials.push(o),this._refreshTextureRefs([o]))}registerMaterialObject(o){const l=o.materialObject?o:Object.assign(o,{assetType:"material",materialObject:o});return this.registerMaterial(l),l}unregisterMaterial(o){this._materials=this._materials.filter(l=>l.uuid!==o.uuid),o.removeEventListener("dispose",this._disposeMaterial)}registerMaterialTemplate(o){o.templateUUID||(o.templateUUID=esm_browser_v4());const l=this._templates.find(c=>c.templateUUID===o.templateUUID);l?console.warn("WebGi Material Manager: MaterialTemplate already exists",o,l):this._templates.push(o)}unregisterMaterialTemplate(o){this._templates=this._templates.filter(l=>l.templateUUID!==o.templateUUID)}dispose(o=!0){const l=this._materials;this._materials=[];for(const c of l)o||!c.userData.runtimeMaterial?c.dispose():this._materials.push(c)}findMaterial(o){return o?this._materials.find(l=>l.uuid===o):void 0}findMaterialsByName(o,l=!1){return this._materials.filter(c=>typeof o!="string"||l?c.name.match(typeof o=="string"?"^"+o+"$":o)!==null:c.name===o)}getMaterialsOfType(o){return o?this._materials.filter(l=>l.typeSlug===o):[]}getAllMaterials(){return[...this._materials]}processModel(o,l){return S(o,"modelObject",this._processModel(o,l)),o}_processMaterial(o,l){var c,u;if(!o)return;if(!((c=o.materialObject)===null||c===void 0)&&c.isMaterial)return o;let h=o.mmMaterial;if(!h){const _=((u=o.userData)===null||u===void 0?void 0:u.uuid)||o.uuid;if(h=this.findMaterial(_),h)h.copyProps(o);else{const A=l.useSourceMaterial===!1||!o.isMaterial,w=l.materialTemplate||(A?"standard":typeTemplateNameMap[o.type]||"standard");h=this.generateFromTemplate(w,A?{}:o)}o.mmMaterial=h}return h}processMaterial(o,l){return o.materialObject||(o=this._processMaterial(o,{...l,register:!1})),l.register!==!1&&this.registerMaterial(o),o}registerMaterialExtension(o){this._materialExtensions.includes(o)||this._materialExtensions.push(o)}unregisterMaterialExtension(o){const l=this._materialExtensions.indexOf(o);l>=0&&this._materialExtensions.splice(l,1)}exportMaterial(o,l,c=!0,u=!1){const h=serializeObject(o,!1),_=JSON.stringify(h,null,c?0:2),A=(l||o.name||"physical_material")+"."+o.typeSlug,w=new File([_],A,{type:"application/json"});return u&&me(w),w}applyMaterial(o,l,c=!0){let u=this.findMaterialsByName(l,c);(!u||u.length<1)&&(u=[this.findMaterial(l)]);let h=!1;for(const _ of u)_&&(_.userData.__isVariation||_!==o&&this.copyMaterialProps(_,o)&&(h=!0));return h}copyMaterialProps(o,l){var c;let u=!1;const h=Object.getPrototypeOf(l).constructor.TYPE;if(Object.getPrototypeOf(o).constructor.TYPE===h){const _=o.name;o.copyProps(l),o.name=_,u=!0}else{const _=o["__"+h]||this.generateFromTemplateType(h);if(_){const A=o.name;_.copyProps(l),_.name=A;const w=o.userData.__appliedMeshes;for(const C of[...w??[]])(c=C==null?void 0:C.setMaterial)===null||c===void 0||c.call(C,_),C&&(u=!0);o["__"+h]=_}}return u}}class MaterialManager extends AMaterialManager{_generateFromTemplate(o,l){var c,u,h,_,A,w;let C;const M={...o};M.customMaterialExtensions=[...(c=M.customMaterialExtensions)!==null&&c!==void 0?c:[],...this._materialExtensions];const O=(l==null?void 0:l.metadata)&&(l==null?void 0:l.metadata.version)<=4.5;O&&(three_module.ppV.enabled=!1);let ne={};switch(o.materialType){case"MeshStandardMaterial2":case"standard":l&&xe(l,M,Array.from(Object.keys(physicalMaterialPropList))),(l==null?void 0:l.type)==="MeshBasicMaterial"&&(M.roughness=.9,M.metalness=0,!((u=M.userData)===null||u===void 0)&&u.uuid&&delete M.userData.uuid),ne=(h=M.userData)===null||h===void 0?void 0:h.uuid,ne&&delete M.userData.uuid,C=new MeshStandardMaterial2({customMaterialExtensions:M.customMaterialExtensions}).fromJSON(M,void 0,!0),ne&&(C.uuid=ne),C.userData.uuid=C.uuid,C.setDirty(),l!=null&&l.isMaterial&&l.userData!==void 0&&(l.userData.iMaterial=C);break;case"MeshBasicMaterial2":case"basic":case"unlit":l&&xe(l,M,Array.from(Object.keys(basicMaterialPropList))),ne=(_=M.userData)===null||_===void 0?void 0:_.uuid,ne&&delete M.userData.uuid,C=new MeshBasicMaterial2({customMaterialExtensions:M.customMaterialExtensions}).fromJSON(M,void 0,!0),ne&&(C.uuid=ne,M.userData.uuid=ne),C.userData.uuid=C.uuid,C.setDirty();break;case"shadow":throw"TODO: Not implemented shadow material";default:ne=null,l&&l.userData&&(ne=l.userData,delete l.userData),C=((A=o.generator)===null||A===void 0?void 0:A.call(o,M,l))||void 0,l&&ne&&(l.userData=ne),ne&&C&&(copyMaterialUserData(C.userData,ne),ne!=null&&ne.uuid&&(C.uuid=ne.uuid),ne=null),C&&(C.userData.uuid=C.uuid)}if(C){l.runtimeMaterial&&(C.userData.runtimeMaterial=!0);const ce=C;if(C.clone=()=>{ce.userData.cloneId||(ce.userData.cloneId="0"),ce.userData.cloneCount||(ce.userData.cloneCount=0),ce.userData.cloneCount+=1;const ue=this.generateFromTemplate(o.name);return ue&&(ue.copyProps(ce),ue.userData.cloneId=ue.userData.cloneId+"_"+ce.userData.cloneCount,ue.userData.cloneCount=0,ue.name=ue.name+"_"+ue.userData.cloneId,ue.userData.uuid=ue.uuid),ue==null?void 0:ue.materialObject},l){let ue=this.findMaterial(l==null?void 0:l.uuid);ue&&this.unregisterMaterial(ue),ue=this.findMaterial((w=l==null?void 0:l.materialObject)===null||w===void 0?void 0:w.uuid),ue&&this.unregisterMaterial(ue)}}return O&&(three_module.ppV.enabled=!0),C?this.registerMaterialObject(C):void 0}_processModel(o,l){if(!o.modelObject)return console.error("MaterialManager: No modelObject found for ",o),o;let c=o.material;if(!c&&o.geometry&&(this._defaultMaterial||(this._defaultMaterial=this.generateFromTemplate("standard")),c=this._defaultMaterial,o.material=c),c){let u=!0;Array.isArray(c)||(c=[c],u=!1);const h=[];for(const _ of c){const A=this._processMaterial(_,l);h.push(A==null?void 0:A.materialObject)}o.setMaterial&&(o.modelObject.material=null,o.setMaterial(u?h:h[0]))}if(l.recursive!==!1)for(let u=0;u<o.modelObject.children.length;u++)o.modelObject.children[u]=this._processModel(o.modelObject.children[u],l);return o}}class Importer{ctor(o){const l=this.cls&&new this.cls(o.loadingManager);return typeof this.onCtor=="function"?this.onCtor(l,o):l}constructor(o,l,c,u){this.cls=o,this.ext=l,this.root=c,this.onCtor=u}}class Object3DModel{get visible(){return this._modelObject.visible}set visible(o){this._modelObject.visible=o}get uuid(){return this._modelObject.uuid}get modelObject(){return this._modelObject}get name(){return this._modelObject.name}set name(o){this._modelObject.name=o}constructor(o,{pseudoCenter:l=!1,autoCenter:c=!1,autoScale:u=!1,autoScaleRadius:h=2,license:_=""}={}){if(this.assetType="model",this._modelObject=setupIModel(new three_module.B69),this.setDirty=this.setDirty.bind(this),this.updateBounds=this.updateBounds.bind(this),o||(o=this._modelObject),!l||o.userData.pseudoCentered||o.userData.isCentered)!c||o.userData.autoCentered||o.userData.isCentered||o.userData.pseudoCentered?l||c||(o.userData.isCentered=!0):autoCenterObject3D(o),this._modelObject=o;else{c&&console.error("cannot use pseudoCenter and autoCenter at the same time");const A=new Box3B().expandByObject(o,!0,!0).getCenter(new three_module.Pq0);this._modelObject.position.copy(A).negate(),this._modelObject.updateMatrix(),this._modelObject.add(o),this._modelObject.name=o.name+"-centered",this._modelObject.userData.pseudoCentered=!0,this._modelObject.userData.isCentered=!0,o.userData.iModel=this}u&&!this._modelObject.userData.autoScaled?autoScaleObject3D(this._modelObject,o.userData.autoScaleRadius||h):this._modelObject.userData.autoScaled=!0,this._modelObject.addEventListener("dispose",()=>{this.__disposed=!0}),this._modelObject.userData.iModel=this,this.license=_}get license(){return this._modelObject.userData.license}set license(o){this._modelObject.userData.license=o}addEventListener(o,l){this._modelObject.addEventListener(o,l)}dispatchEvent(o){this._modelObject.dispatchEvent(o)}hasEventListener(o,l){return this._modelObject.hasEventListener(o,l)}removeEventListener(o,l){this._modelObject.removeEventListener(o,l)}traverse(o){this._modelObject.traverse(o)}dispose(){const o=this._modelObject.dispose;o&&typeof o=="function"?o():(console.warn("WebGi Object3DModel: no dispose in modelObject"),this._modelObject.removeFromParent())}setDirty(o){var l,c,u,h;(c=(l=this._modelObject)===null||l===void 0?void 0:l.setDirty)===null||c===void 0||c.call(l,o),(h=(u=this._uiConfig)===null||u===void 0?void 0:u.uiRefresh)===null||h===void 0||h.call(u,"postFrame",!0)}setMaterial(o){var l,c;return this._modelObject.isMesh?((c=(l=this._modelObject).setMaterial)===null||c===void 0?void 0:c.call(l,o))||[]:(console.error("setMaterial only works on meshes"),[])}get material(){return this._modelObject.material}get geometry(){return this._modelObject.geometry}setGeometry(o,l=!1){var c,u;if(this._modelObject.isMesh)return(u=(c=this._modelObject).setGeometry)===null||u===void 0?void 0:u.call(c,o,l);console.error("setGeometry only works on meshes")}get userData(){return this._modelObject.userData}set userData(o){this._modelObject.userData=o}updateBounds(){console.warn("WebGi Object3DModel: updateBounds: NOT IMPLEMENTED, don't use"),this.setDirty()}get uiConfig(){return this._uiConfig||(this._uiConfig=makeObject3DUiConfig(this._modelObject,!1)),this._uiConfig}clone(){return new Object3DModel(this._modelObject.clone(),{pseudoCenter:!1,autoScale:!1,autoCenter:!1,license:this.license})}}function setupObject3dModel(d,o){return[d.modelObject,...d.modelObject.children].forEach(l=>{setupIModel(l,l!==d.modelObject?d:void 0,o)}),d}class ObjectProcessorMap{constructor(){this._processors=new Map}add(o,l){var c;this._processors.has(o)||this._processors.set(o,[]),(c=this._processors.get(o))===null||c===void 0||c.push(l)}remove(o,l){const c=this._processors.get(o),u=(c==null?void 0:c.indexOf(l))||(c==null?void 0:c.findIndex(h=>h.process&&h.process===l.process||h.processAsync&&h.processAsync===l.processAsync));!c||!u||u<0||c.splice(u,1)}get(o){var l;return(l=this._processors.get(o))!==null&&l!==void 0?l:[]}async process(o,l,c){var u,h,_,A;const w=this.get(o),C=l.assetType;for(const M of w)M.forAssetType===C&&(l=(h=(u=M.process)===null||u===void 0?void 0:u.call(M,l,c))!==null&&h!==void 0?h:l,l=(A=await((_=M.processAsync)===null||_===void 0?void 0:_.call(M,l,c)))!==null&&A!==void 0?A:l);return l}dispose(){this._processors.clear()}}class SimpleJSONLoader extends three_module.Y9S{load(o,l,c,u){return super.load(o,h=>{try{if(typeof h!="string")throw new Error("Invalid JSON");l==null||l(JSON.parse(h))}catch(_){u==null||u(_)}},c,u)}}class RGBELoader extends three_module.BRH{constructor(o){super(o),this.type=three_module.ix0}parse(o){const l=function(ue,ye){switch(ue){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(ye||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(ye||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(ye||""));default:throw new Error("THREE.RGBELoader: Memory Error: "+(ye||""))}},c=function(ue,ye,Oe){ye=ye||1024;let ke=ue.pos,Ve=-1,tt=0,ht="",ut=String.fromCharCode.apply(null,new Uint16Array(ue.subarray(ke,ke+128)));for(;0>(Ve=ut.indexOf(`
`))&&tt<ye&&ke<ue.byteLength;)ht+=ut,tt+=ut.length,ke+=128,ut+=String.fromCharCode.apply(null,new Uint16Array(ue.subarray(ke,ke+128)));return-1<Ve&&(Oe!==!1&&(ue.pos+=tt+Ve+1),ht+ut.slice(0,Ve))},u=function(ue,ye,Oe,ke){const Ve=ue[ye+3],tt=Math.pow(2,Ve-128)/255;Oe[ke+0]=ue[ye+0]*tt,Oe[ke+1]=ue[ye+1]*tt,Oe[ke+2]=ue[ye+2]*tt,Oe[ke+3]=1},h=function(ue,ye,Oe,ke){const Ve=ue[ye+3],tt=Math.pow(2,Ve-128)/255;Oe[ke+0]=three_module.GxU.toHalfFloat(Math.min(ue[ye+0]*tt,65504)),Oe[ke+1]=three_module.GxU.toHalfFloat(Math.min(ue[ye+1]*tt,65504)),Oe[ke+2]=three_module.GxU.toHalfFloat(Math.min(ue[ye+2]*tt,65504)),Oe[ke+3]=three_module.GxU.toHalfFloat(1)},_=new Uint8Array(o);_.pos=0;const A=function(ue){const ye=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,Oe=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,ke=/^\s*FORMAT=(\S+)\s*$/,Ve=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,tt={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let ht,ut;for((ue.pos>=ue.byteLength||!(ht=c(ue)))&&l(1,"no header found"),(ut=ht.match(/^#\?(\S+)/))||l(3,"bad initial token"),tt.valid|=1,tt.programtype=ut[1],tt.string+=ht+`
`;ht=c(ue),ht!==!1;)if(tt.string+=ht+`
`,ht.charAt(0)!=="#"){if((ut=ht.match(ye))&&(tt.gamma=parseFloat(ut[1])),(ut=ht.match(Oe))&&(tt.exposure=parseFloat(ut[1])),(ut=ht.match(ke))&&(tt.valid|=2,tt.format=ut[1]),(ut=ht.match(Ve))&&(tt.valid|=4,tt.height=parseInt(ut[1],10),tt.width=parseInt(ut[2],10)),2&tt.valid&&4&tt.valid)break}else tt.comments+=ht+`
`;return 2&tt.valid||l(3,"missing format specifier"),4&tt.valid||l(3,"missing image size specifier"),tt}(_),w=A.width,C=A.height,M=function(ue,ye,Oe){const ke=ye;if(ke<8||ke>32767||ue[0]!==2||ue[1]!==2||128&ue[2])return new Uint8Array(ue);ke!==(ue[2]<<8|ue[3])&&l(3,"wrong scanline width");const Ve=new Uint8Array(4*ye*Oe);Ve.length||l(4,"unable to allocate buffer space");let tt=0,ht=0;const ut=4*ke,_t=new Uint8Array(4),at=new Uint8Array(ut);let lt=Oe;for(;lt>0&&ht<ue.byteLength;){ht+4>ue.byteLength&&l(1),_t[0]=ue[ht++],_t[1]=ue[ht++],_t[2]=ue[ht++],_t[3]=ue[ht++],_t[0]==2&&_t[1]==2&&(_t[2]<<8|_t[3])==ke||l(3,"bad rgbe scanline format");let pt,xt=0;for(;xt<ut&&ht<ue.byteLength;){pt=ue[ht++];const Pt=pt>128;if(Pt&&(pt-=128),(pt===0||xt+pt>ut)&&l(3,"bad scanline data"),Pt){const Lt=ue[ht++];for(let Bt=0;Bt<pt;Bt++)at[xt++]=Lt}else at.set(ue.subarray(ht,ht+pt),xt),xt+=pt,ht+=pt}const Tt=ke;for(let Pt=0;Pt<Tt;Pt++){let Lt=0;Ve[tt]=at[Pt+Lt],Lt+=ke,Ve[tt+1]=at[Pt+Lt],Lt+=ke,Ve[tt+2]=at[Pt+Lt],Lt+=ke,Ve[tt+3]=at[Pt+Lt],tt+=4}lt--}return Ve}(_.subarray(_.pos),w,C);let O,ne,ce;switch(this.type){case three_module.RQf:ce=M.length/4;const ue=new Float32Array(4*ce);for(let Oe=0;Oe<ce;Oe++)u(M,4*Oe,ue,4*Oe);O=ue,ne=three_module.RQf;break;case three_module.ix0:ce=M.length/4;const ye=new Uint16Array(4*ce);for(let Oe=0;Oe<ce;Oe++)h(M,4*Oe,ye,4*Oe);O=ye,ne=three_module.ix0;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:w,height:C,data:O,header:A.string,gamma:A.gamma,exposure:A.exposure,type:ne}}setDataType(o){return this.type=o,this}load(o,l,c,u){return super.load(o,function(h,_){switch(h.type){case three_module.RQf:case three_module.ix0:h.colorSpace=three_module.Zr2,h.minFilter=three_module.k6q,h.magFilter=three_module.k6q,h.generateMipmaps=!1,h.flipY=!0}l&&l(h,_)},c,u)}}function addRGBELoader(d){return new Importer(class extends RGBELoader{constructor(o){super(o),this.setDataType(getTextureDataType(d.renderer.rendererObject))}},["hdr"],!1)}class GLTFLoader extends three_module.aHM{constructor(o){super(o),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(l){return new GLTFMaterialsClearcoatExtension(l)}),this.register(function(l){return new GLTFTextureBasisUExtension(l)}),this.register(function(l){return new GLTFTextureWebPExtension(l)}),this.register(function(l){return new GLTFTextureAVIFExtension(l)}),this.register(function(l){return new GLTFMaterialsSheenExtension(l)}),this.register(function(l){return new GLTFMaterialsTransmissionExtension(l)}),this.register(function(l){return new GLTFMaterialsVolumeExtension(l)}),this.register(function(l){return new GLTFMaterialsIorExtension(l)}),this.register(function(l){return new GLTFMaterialsEmissiveStrengthExtension(l)}),this.register(function(l){return new GLTFMaterialsSpecularExtension(l)}),this.register(function(l){return new GLTFMaterialsIridescenceExtension(l)}),this.register(function(l){return new GLTFMaterialsAnisotropyExtension(l)}),this.register(function(l){return new GLTFLightsExtension(l)}),this.register(function(l){return new GLTFMeshoptCompression(l)}),this.register(function(l){return new GLTFMeshGpuInstancing(l)})}load(o,l,c,u){const h=this;let _;_=this.resourcePath!==""?this.resourcePath:this.path!==""?this.path:three_module.r6x.extractUrlBase(o),this.manager.itemStart(o);const A=function(C){u?u(C):console.error(C),h.manager.itemError(o),h.manager.itemEnd(o)},w=new three_module.Y9S(this.manager);w.setPath(this.path),w.setResponseType("arraybuffer"),w.setRequestHeader(this.requestHeader),w.setWithCredentials(this.withCredentials),w.load(o,function(C){try{h.parse(C,_,function(M){l(M),h.manager.itemEnd(o)},A,o)}catch(M){A(M)}},c,A)}setDRACOLoader(o){return this.dracoLoader=o,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(o){return this.ktx2Loader=o,this}setMeshoptDecoder(o){return this.meshoptDecoder=o,this}register(o){return this.pluginCallbacks.indexOf(o)===-1&&this.pluginCallbacks.push(o),this}unregister(o){return this.pluginCallbacks.indexOf(o)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(o),1),this}parse(o,l,c,u,h){let _;const A={},w={},C=new TextDecoder;if(typeof o=="string")_=JSON.parse(o);else if(o instanceof ArrayBuffer)if(C.decode(new Uint8Array(o,0,4))===BINARY_EXTENSION_HEADER_MAGIC){try{A[EXTENSIONS.KHR_BINARY_GLTF]=new GLTFBinaryExtension(o)}catch(O){return void(u&&u(O))}_=JSON.parse(A[EXTENSIONS.KHR_BINARY_GLTF].content)}else _=JSON.parse(C.decode(o));else _=o;if(_.asset===void 0||_.asset.version[0]<2)return void(u&&u(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const M=new GLTFParser(_,{path:l||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});M.fileLoader.setRequestHeader(this.requestHeader);for(let O=0;O<this.pluginCallbacks.length;O++){const ne=this.pluginCallbacks[O](M);w[ne.name]=ne,A[ne.name]=!0}if(_.extensionsUsed)for(let O=0;O<_.extensionsUsed.length;++O){const ne=_.extensionsUsed[O],ce=_.extensionsRequired||[];switch(ne){case EXTENSIONS.KHR_MATERIALS_UNLIT:A[ne]=new GLTFMaterialsUnlitExtension;break;case EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:A[ne]=new GLTFDracoMeshCompressionExtension(_,this.dracoLoader);break;case EXTENSIONS.KHR_TEXTURE_TRANSFORM:A[ne]=new GLTFTextureTransformExtension;break;case EXTENSIONS.KHR_MESH_QUANTIZATION:A[ne]=new GLTFMeshQuantizationExtension;break;default:ce.indexOf(ne)>=0&&w[ne]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+ne+'".')}}M.setExtensions(A),M.setPlugins(w),M.parse(c,u)}parseAsync(o,l){const c=this;return new Promise(function(u,h){c.parse(o,l,u,h)})}}function GLTFRegistry(){let d={};return{get:function(o){return d[o]},add:function(o,l){d[o]=l},remove:function(o){delete d[o]},removeAll:function(){d={}}}}GLTFLoader.ObjectConstructors={DirectionalLight:three_module.ZyN,PointLight:three_module.HiM,SpotLight:three_module.nCl,MeshStandardMaterial:three_module._4j,MeshBasicMaterial:three_module.V9B,MeshPhysicalMaterial:three_module.uSd,LineBasicMaterial:three_module.mrM,PointsMaterial:three_module.BH$,PerspectiveCamera:three_module.ubm,OrthographicCamera:three_module.qUd};const EXTENSIONS={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class GLTFLightsExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const o=this.parser,l=this.parser.json.nodes||[];for(let c=0,u=l.length;c<u;c++){const h=l[c];h.extensions&&h.extensions[this.name]&&h.extensions[this.name].light!==void 0&&o._addNodeRef(this.cache,h.extensions[this.name].light)}}_loadLight(o){const l=this.parser,c="light:"+o;let u=l.cache.get(c);if(u)return u;const h=l.json,_=((h.extensions&&h.extensions[this.name]||{}).lights||[])[o];let A;const w=new three_module.Q1f(16777215);_.color!==void 0&&w.setRGB(_.color[0],_.color[1],_.color[2],three_module.Zr2);const C=_.range!==void 0?_.range:0;switch(_.type){case"directional":A=new GLTFLoader.ObjectConstructors.DirectionalLight(w),A.target.position.set(0,0,-1),A.add(A.target);break;case"point":A=new GLTFLoader.ObjectConstructors.PointLight(w),A.distance=C;break;case"spot":A=new GLTFLoader.ObjectConstructors.SpotLight(w),A.distance=C,_.spot=_.spot||{},_.spot.innerConeAngle=_.spot.innerConeAngle!==void 0?_.spot.innerConeAngle:0,_.spot.outerConeAngle=_.spot.outerConeAngle!==void 0?_.spot.outerConeAngle:Math.PI/4,A.angle=_.spot.outerConeAngle,A.penumbra=1-_.spot.innerConeAngle/_.spot.outerConeAngle,A.target.position.set(0,0,-1),A.add(A.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+_.type)}return A.position.set(0,0,0),A.decay=2,assignExtrasToUserData(A,_),_.intensity!==void 0&&(A.intensity=_.intensity),A.name=l.createUniqueName(_.name||"light_"+o),u=Promise.resolve(A),l.cache.add(c,u),u}getDependency(o,l){if(o==="light")return this._loadLight(l)}createNodeAttachment(o){const l=this,c=this.parser,u=c.json.nodes[o],h=(u.extensions&&u.extensions[this.name]||{}).light;return h===void 0?null:this._loadLight(h).then(function(_){return c._getNodeRef(l.cache,h,_)})}}class GLTFMaterialsUnlitExtension{constructor(){this.name=EXTENSIONS.KHR_MATERIALS_UNLIT}getMaterialType(){return GLTFLoader.ObjectConstructors.MeshBasicMaterial}extendParams(o,l,c){const u=[];o.color=new three_module.Q1f(1,1,1),o.opacity=1;const h=l.pbrMetallicRoughness;if(h){if(Array.isArray(h.baseColorFactor)){const _=h.baseColorFactor;o.color.setRGB(_[0],_[1],_[2],three_module.Zr2),o.opacity=_[3]}h.baseColorTexture!==void 0&&u.push(c.assignTexture(o,"map",h.baseColorTexture,three_module.er$))}return Promise.all(u)}}class GLTFMaterialsEmissiveStrengthExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name].emissiveStrength;return u!==void 0&&(l.emissiveIntensity=u),Promise.resolve()}}class GLTFMaterialsClearcoatExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_CLEARCOAT}getMaterialType(o){const l=this.parser.json.materials[o];return l.extensions&&l.extensions[this.name]?GLTFLoader.ObjectConstructors.MeshPhysicalMaterial:null}extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];if(_.clearcoatFactor!==void 0&&(l.clearcoat=_.clearcoatFactor),_.clearcoatTexture!==void 0&&h.push(c.assignTexture(l,"clearcoatMap",_.clearcoatTexture)),_.clearcoatRoughnessFactor!==void 0&&(l.clearcoatRoughness=_.clearcoatRoughnessFactor),_.clearcoatRoughnessTexture!==void 0&&h.push(c.assignTexture(l,"clearcoatRoughnessMap",_.clearcoatRoughnessTexture)),_.clearcoatNormalTexture!==void 0&&(h.push(c.assignTexture(l,"clearcoatNormalMap",_.clearcoatNormalTexture)),_.clearcoatNormalTexture.scale!==void 0)){const A=_.clearcoatNormalTexture.scale;l.clearcoatNormalScale=new three_module.I9Y(A,A)}return Promise.all(h)}}class GLTFMaterialsIridescenceExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_IRIDESCENCE}getMaterialType(o){const l=this.parser.json.materials[o];return l.extensions&&l.extensions[this.name]?GLTFLoader.ObjectConstructors.MeshPhysicalMaterial:null}extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];return _.iridescenceFactor!==void 0&&(l.iridescence=_.iridescenceFactor),_.iridescenceTexture!==void 0&&h.push(c.assignTexture(l,"iridescenceMap",_.iridescenceTexture)),_.iridescenceIor!==void 0&&(l.iridescenceIOR=_.iridescenceIor),l.iridescenceThicknessRange===void 0&&(l.iridescenceThicknessRange=[100,400]),_.iridescenceThicknessMinimum!==void 0&&(l.iridescenceThicknessRange[0]=_.iridescenceThicknessMinimum),_.iridescenceThicknessMaximum!==void 0&&(l.iridescenceThicknessRange[1]=_.iridescenceThicknessMaximum),_.iridescenceThicknessTexture!==void 0&&h.push(c.assignTexture(l,"iridescenceThicknessMap",_.iridescenceThicknessTexture)),Promise.all(h)}}class GLTFMaterialsSheenExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_SHEEN}getMaterialType(o){const l=this.parser.json.materials[o];return l.extensions&&l.extensions[this.name]?GLTFLoader.ObjectConstructors.MeshPhysicalMaterial:null}extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[];l.sheenColor=new three_module.Q1f(0,0,0),l.sheenRoughness=0,l.sheen=1;const _=u.extensions[this.name];if(_.sheenColorFactor!==void 0){const A=_.sheenColorFactor;l.sheenColor.setRGB(A[0],A[1],A[2],three_module.Zr2)}return _.sheenRoughnessFactor!==void 0&&(l.sheenRoughness=_.sheenRoughnessFactor),_.sheenColorTexture!==void 0&&h.push(c.assignTexture(l,"sheenColorMap",_.sheenColorTexture,three_module.er$)),_.sheenRoughnessTexture!==void 0&&h.push(c.assignTexture(l,"sheenRoughnessMap",_.sheenRoughnessTexture)),u.extras&&u.extras.sheenFactor!==void 0&&(l.sheen=u.extras.sheenFactor,delete u.extras.sheenFactor),Promise.all(h)}}class GLTFMaterialsTransmissionExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_TRANSMISSION}getMaterialType(o){const l=this.parser.json.materials[o];return l.extensions&&l.extensions[this.name]?GLTFLoader.ObjectConstructors.MeshPhysicalMaterial:null}extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];return _.transmissionFactor!==void 0&&(l.transmission=_.transmissionFactor),_.transmissionTexture!==void 0&&h.push(c.assignTexture(l,"transmissionMap",_.transmissionTexture)),Promise.all(h)}}class GLTFMaterialsVolumeExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_VOLUME}getMaterialType(o){const l=this.parser.json.materials[o];return l.extensions&&l.extensions[this.name]?GLTFLoader.ObjectConstructors.MeshPhysicalMaterial:null}extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];l.thickness=_.thicknessFactor!==void 0?_.thicknessFactor:0,_.thicknessTexture!==void 0&&h.push(c.assignTexture(l,"thicknessMap",_.thicknessTexture)),l.attenuationDistance=_.attenuationDistance||1/0;const A=_.attenuationColor||[1,1,1];return l.attenuationColor=new three_module.Q1f().setRGB(A[0],A[1],A[2],three_module.Zr2),Promise.all(h)}}class GLTFMaterialsIorExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_IOR}getMaterialType(o){const l=this.parser.json.materials[o];return l.extensions&&l.extensions[this.name]?GLTFLoader.ObjectConstructors.MeshPhysicalMaterial:null}extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name];return l.ior=u.ior!==void 0?u.ior:1.5,Promise.resolve()}}class GLTFMaterialsSpecularExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_SPECULAR}getMaterialType(o){const l=this.parser.json.materials[o];return l.extensions&&l.extensions[this.name]?GLTFLoader.ObjectConstructors.MeshPhysicalMaterial:null}extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];l.specularIntensity=_.specularFactor!==void 0?_.specularFactor:1,_.specularTexture!==void 0&&h.push(c.assignTexture(l,"specularIntensityMap",_.specularTexture));const A=_.specularColorFactor||[1,1,1];return l.specularColor=new three_module.Q1f().setRGB(A[0],A[1],A[2],three_module.Zr2),_.specularColorTexture!==void 0&&h.push(c.assignTexture(l,"specularColorMap",_.specularColorTexture,three_module.er$)),Promise.all(h)}}class GLTFMaterialsAnisotropyExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_MATERIALS_ANISOTROPY}getMaterialType(o){const l=this.parser.json.materials[o];return l.extensions&&l.extensions[this.name]?three_module.uSd:null}extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];return _.anisotropyStrength!==void 0&&(l.anisotropy=_.anisotropyStrength),_.anisotropyRotation!==void 0&&(l.anisotropyRotation=_.anisotropyRotation),_.anisotropyTexture!==void 0&&h.push(c.assignTexture(l,"anisotropyMap",_.anisotropyTexture)),Promise.all(h)}}class GLTFTextureBasisUExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.KHR_TEXTURE_BASISU}loadTexture(o){const l=this.parser,c=l.json,u=c.textures[o];if(!u.extensions||!u.extensions[this.name])return null;const h=u.extensions[this.name],_=l.options.ktx2Loader;if(!_){if(c.extensionsRequired&&c.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return l.loadTextureImage(o,h.source,_)}}class GLTFTextureWebPExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(o){const l=this.name,c=this.parser,u=c.json,h=u.textures[o];if(!h.extensions||!h.extensions[l])return null;const _=h.extensions[l],A=u.images[_.source];let w=c.textureLoader;if(A.uri){const C=c.options.manager.getHandler(A.uri);C!==null&&(w=C)}return this.detectSupport().then(function(C){if(C)return c.loadTextureImage(o,_.source,w);if(u.extensionsRequired&&u.extensionsRequired.indexOf(l)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return c.loadTexture(o)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(o){const l=new Image;l.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",l.onload=l.onerror=function(){o(l.height===1)}})),this.isSupported}}class GLTFTextureAVIFExtension{constructor(o){this.parser=o,this.name=EXTENSIONS.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(o){const l=this.name,c=this.parser,u=c.json,h=u.textures[o];if(!h.extensions||!h.extensions[l])return null;const _=h.extensions[l],A=u.images[_.source];let w=c.textureLoader;if(A.uri){const C=c.options.manager.getHandler(A.uri);C!==null&&(w=C)}return this.detectSupport().then(function(C){if(C)return c.loadTextureImage(o,_.source,w);if(u.extensionsRequired&&u.extensionsRequired.indexOf(l)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return c.loadTexture(o)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(o){const l=new Image;l.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",l.onload=l.onerror=function(){o(l.height===1)}})),this.isSupported}}class GLTFMeshoptCompression{constructor(o){this.name=EXTENSIONS.EXT_MESHOPT_COMPRESSION,this.parser=o}loadBufferView(o){const l=this.parser.json,c=l.bufferViews[o];if(c.extensions&&c.extensions[this.name]){const u=c.extensions[this.name],h=this.parser.getDependency("buffer",u.buffer),_=this.parser.options.meshoptDecoder;if(!_||!_.supported){if(l.extensionsRequired&&l.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return h.then(function(A){const w=u.byteOffset||0,C=u.byteLength||0,M=u.count,O=u.byteStride,ne=new Uint8Array(A,w,C);return _.decodeGltfBufferAsync?_.decodeGltfBufferAsync(M,O,ne,u.mode,u.filter).then(function(ce){return ce.buffer}):_.ready.then(function(){const ce=new ArrayBuffer(M*O);return _.decodeGltfBuffer(new Uint8Array(ce),M,O,ne,u.mode,u.filter),ce})})}return null}}class GLTFMeshGpuInstancing{constructor(o){this.name=EXTENSIONS.EXT_MESH_GPU_INSTANCING,this.parser=o}createNodeMesh(o){const l=this.parser.json,c=l.nodes[o];if(!c.extensions||!c.extensions[this.name]||c.mesh===void 0)return null;const u=l.meshes[c.mesh];for(const w of u.primitives)if(w.mode!==WEBGL_CONSTANTS.TRIANGLES&&w.mode!==WEBGL_CONSTANTS.TRIANGLE_STRIP&&w.mode!==WEBGL_CONSTANTS.TRIANGLE_FAN&&w.mode!==void 0)return null;const h=c.extensions[this.name].attributes,_=[],A={};for(const w in h)_.push(this.parser.getDependency("accessor",h[w]).then(C=>(A[w]=C,A[w])));return _.length<1?null:(_.push(this.parser.createNodeMesh(o)),Promise.all(_).then(w=>{const C=w.pop(),M=C.isGroup?C.children:[C],O=w[0].count,ne=[];for(const ce of M){const ue=new three_module.kn4,ye=new three_module.Pq0,Oe=new three_module.PTz,ke=new three_module.Pq0(1,1,1),Ve=new three_module.ZLX(ce.geometry,ce.material,O);for(let tt=0;tt<O;tt++)A.TRANSLATION&&ye.fromBufferAttribute(A.TRANSLATION,tt),A.ROTATION&&Oe.fromBufferAttribute(A.ROTATION,tt),A.SCALE&&ke.fromBufferAttribute(A.SCALE,tt),Ve.setMatrixAt(tt,ue.compose(ye,Oe,ke));Ve.sourceTrs=A;for(const tt in A)tt!=="TRANSLATION"&&tt!=="ROTATION"&&tt!=="SCALE"&&ce.geometry.setAttribute(tt,A[tt]);three_module.B69.prototype.copy.call(Ve,ce),this.parser.assignFinalMaterial(Ve),ne.push(Ve)}return C.isGroup?(C.clear(),C.add(...ne),C):ne[0]}))}}const BINARY_EXTENSION_HEADER_MAGIC="glTF",BINARY_EXTENSION_HEADER_LENGTH=12,BINARY_EXTENSION_CHUNK_TYPES={JSON:1313821514,BIN:5130562};class GLTFBinaryExtension{constructor(o){this.name=EXTENSIONS.KHR_BINARY_GLTF,this.content=null,this.body=null;const l=new DataView(o,0,BINARY_EXTENSION_HEADER_LENGTH),c=new TextDecoder;if(this.header={magic:c.decode(new Uint8Array(o.slice(0,4))),version:l.getUint32(4,!0),length:l.getUint32(8,!0)},this.header.magic!==BINARY_EXTENSION_HEADER_MAGIC)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const u=this.header.length-BINARY_EXTENSION_HEADER_LENGTH,h=new DataView(o,BINARY_EXTENSION_HEADER_LENGTH);let _=0;for(;_<u;){const A=h.getUint32(_,!0);_+=4;const w=h.getUint32(_,!0);if(_+=4,w===BINARY_EXTENSION_CHUNK_TYPES.JSON){const C=new Uint8Array(o,BINARY_EXTENSION_HEADER_LENGTH+_,A);this.content=c.decode(C)}else if(w===BINARY_EXTENSION_CHUNK_TYPES.BIN){const C=BINARY_EXTENSION_HEADER_LENGTH+_;this.body=o.slice(C,C+A)}_+=A}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class GLTFDracoMeshCompressionExtension{constructor(o,l){if(!l)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=EXTENSIONS.KHR_DRACO_MESH_COMPRESSION,this.json=o,this.dracoLoader=l,this.dracoLoader.preload()}decodePrimitive(o,l){const c=this.json,u=this.dracoLoader,h=o.extensions[this.name].bufferView,_=o.extensions[this.name].attributes,A={},w={},C={};for(const M in _){const O=ATTRIBUTES[M]||M.toLowerCase();A[O]=_[M]}for(const M in o.attributes){const O=ATTRIBUTES[M]||M.toLowerCase();if(_[M]!==void 0){const ne=c.accessors[o.attributes[M]],ce=WEBGL_COMPONENT_TYPES[ne.componentType];C[O]=ce.name,w[O]=ne.normalized===!0}}return l.getDependency("bufferView",h).then(function(M){return new Promise(function(O){u.decodeDracoFile(M,function(ne){for(const ce in ne.attributes){const ue=ne.attributes[ce],ye=w[ce];ye!==void 0&&(ue.normalized=ye)}O(ne)},A,C)})})}}class GLTFTextureTransformExtension{constructor(){this.name=EXTENSIONS.KHR_TEXTURE_TRANSFORM}extendTexture(o,l){return(l.texCoord!==void 0&&l.texCoord!==o.channel||l.offset!==void 0||l.rotation!==void 0||l.scale!==void 0)&&(o.__hasGLTFUuid||(o=o.clone()),l.texCoord!==void 0&&(o.channel=l.texCoord),l.offset!==void 0&&o.offset.fromArray(l.offset),l.rotation!==void 0&&(o.rotation=l.rotation),l.scale!==void 0&&o.repeat.fromArray(l.scale),o.needsUpdate=!0),o}}class GLTFMeshQuantizationExtension{constructor(){this.name=EXTENSIONS.KHR_MESH_QUANTIZATION}}class GLTFCubicSplineInterpolant extends three_module.lGw{constructor(o,l,c,u){super(o,l,c,u)}copySampleValue_(o){const l=this.resultBuffer,c=this.sampleValues,u=this.valueSize,h=o*u*3+u;for(let _=0;_!==u;_++)l[_]=c[h+_];return l}interpolate_(o,l,c,u){const h=this.resultBuffer,_=this.sampleValues,A=this.valueSize,w=2*A,C=3*A,M=u-l,O=(c-l)/M,ne=O*O,ce=ne*O,ue=o*C,ye=ue-C,Oe=-2*ce+3*ne,ke=ce-ne,Ve=1-Oe,tt=ke-ne+O;for(let ht=0;ht!==A;ht++){const ut=_[ye+ht+A],_t=_[ye+ht+w]*M,at=_[ue+ht+A],lt=_[ue+ht]*M;h[ht]=Ve*ut+tt*_t+Oe*at+ke*lt}return h}}const _q=new three_module.PTz;class GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant{interpolate_(o,l,c,u){const h=super.interpolate_(o,l,c,u);return _q.fromArray(h).normalize().toArray(h),h}}const WEBGL_CONSTANTS={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},WEBGL_COMPONENT_TYPES={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},WEBGL_FILTERS={9728:three_module.hxR,9729:three_module.k6q,9984:three_module.pHI,9985:three_module.kRr,9986:three_module.Cfg,9987:three_module.$_I},WEBGL_WRAPPINGS={33071:three_module.ghU,33648:three_module.kTW,10497:three_module.GJx},WEBGL_TYPE_SIZES={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTES={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},PATH_PROPERTIES={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},INTERPOLATION={CUBICSPLINE:void 0,LINEAR:three_module.PJ3,STEP:three_module.ljd},ALPHA_MODES={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function createDefaultMaterial(d){return d.DefaultMaterial===void 0&&(d.DefaultMaterial=new GLTFLoader.ObjectConstructors.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:three_module.hB5})),d.DefaultMaterial}function addUnknownExtensionsToUserData(d,o,l){for(const c in l.extensions)d[c]===void 0&&(o.userData.gltfExtensions=o.userData.gltfExtensions||{},o.userData.gltfExtensions[c]=l.extensions[c])}function assignExtrasToUserData(d,o){o.extras!==void 0&&(typeof o.extras=="object"?Object.assign(d.userData,o.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+o.extras))}function addMorphTargets(d,o,l){let c=!1,u=!1,h=!1;for(let C=0,M=o.length;C<M;C++){const O=o[C];if(O.POSITION!==void 0&&(c=!0),O.NORMAL!==void 0&&(u=!0),O.COLOR_0!==void 0&&(h=!0),c&&u&&h)break}if(!c&&!u&&!h)return Promise.resolve(d);const _=[],A=[],w=[];for(let C=0,M=o.length;C<M;C++){const O=o[C];if(c){const ne=O.POSITION!==void 0?l.getDependency("accessor",O.POSITION):d.attributes.position;_.push(ne)}if(u){const ne=O.NORMAL!==void 0?l.getDependency("accessor",O.NORMAL):d.attributes.normal;A.push(ne)}if(h){const ne=O.COLOR_0!==void 0?l.getDependency("accessor",O.COLOR_0):d.attributes.color;w.push(ne)}}return Promise.all([Promise.all(_),Promise.all(A),Promise.all(w)]).then(function(C){const M=C[0],O=C[1],ne=C[2];return c&&(d.morphAttributes.position=M),u&&(d.morphAttributes.normal=O),h&&(d.morphAttributes.color=ne),d.morphTargetsRelative=!0,d})}function updateMorphTargets(d,o){if(d.updateMorphTargets(),o.weights!==void 0)for(let l=0,c=o.weights.length;l<c;l++)d.morphTargetInfluences[l]=o.weights[l];if(o.extras&&Array.isArray(o.extras.targetNames)){const l=o.extras.targetNames;if(d.morphTargetInfluences.length===l.length){d.morphTargetDictionary={};for(let c=0,u=l.length;c<u;c++)d.morphTargetDictionary[l[c]]=c}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(d){let o;const l=d.extensions&&d.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION];if(o=l?"draco:"+l.bufferView+":"+l.indices+":"+createAttributesKey(l.attributes):d.indices+":"+createAttributesKey(d.attributes)+":"+d.mode,d.targets!==void 0)for(let c=0,u=d.targets.length;c<u;c++)o+=":"+createAttributesKey(d.targets[c]);return o}function createAttributesKey(d){let o="";const l=Object.keys(d).sort();for(let c=0,u=l.length;c<u;c++)o+=l[c]+":"+d[l[c]]+";";return o}function getNormalizedComponentScale(d){switch(d){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function getImageURIMimeType(d){return d.search(/\.jpe?g($|\?)/i)>0||d.search(/^data\:image\/jpeg/)===0?"image/jpeg":d.search(/\.webp($|\?)/i)>0||d.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const _identityMatrix=new three_module.kn4;class GLTFParser{constructor(o={},l={}){this.json=o,this.extensions={},this.plugins={},this.options=l,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let c=!1,u=!1,h=-1;typeof navigator<"u"&&(c=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,u=navigator.userAgent.indexOf("Firefox")>-1,h=u?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||c||u&&h<98?this.textureLoader=new three_module.Tap(this.options.manager):this.textureLoader=new three_module.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new three_module.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(o){this.extensions=o}setPlugins(o){this.plugins=o}parse(o,l){const c=this,u=this.json,h=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(_){return _._markDefs&&_._markDefs()}),Promise.all(this._invokeAll(function(_){return _.beforeRoot&&_.beforeRoot()})).then(function(){return Promise.all([c.getDependencies("scene"),c.getDependencies("animation"),c.getDependencies("camera")])}).then(function(_){const A={scene:_[0][u.scene||0],scenes:_[0],animations:_[1],cameras:_[2],asset:u.asset,parser:c,userData:{}};return addUnknownExtensionsToUserData(h,A,u),assignExtrasToUserData(A,u),Promise.all(c._invokeAll(function(w){return w.afterRoot&&w.afterRoot(A)})).then(function(){o(A)})}).catch(l)}_markDefs(){const o=this.json.nodes||[],l=this.json.skins||[],c=this.json.meshes||[];for(let u=0,h=l.length;u<h;u++){const _=l[u].joints;for(let A=0,w=_.length;A<w;A++)o[_[A]].isBone=!0}for(let u=0,h=o.length;u<h;u++){const _=o[u];_.mesh!==void 0&&(this._addNodeRef(this.meshCache,_.mesh),_.skin!==void 0&&(c[_.mesh].isSkinnedMesh=!0)),_.camera!==void 0&&this._addNodeRef(this.cameraCache,_.camera)}}_addNodeRef(o,l){l!==void 0&&(o.refs[l]===void 0&&(o.refs[l]=o.uses[l]=0),o.refs[l]++)}_getNodeRef(o,l,c){if(o.refs[l]<=1)return c;const u=c.clone(),h=(_,A)=>{const w=this.associations.get(_);w!=null&&this.associations.set(A,w);for(const[C,M]of _.children.entries())h(M,A.children[C])};return h(c,u),u.name+="_instance_"+o.uses[l]++,u}_invokeOne(o){const l=Object.values(this.plugins);l.push(this);for(let c=0;c<l.length;c++){const u=o(l[c]);if(u)return u}return null}_invokeAll(o){const l=Object.values(this.plugins);l.unshift(this);const c=[];for(let u=0;u<l.length;u++){const h=o(l[u]);h&&c.push(h)}return c}getDependency(o,l){const c=o+":"+l;let u=this.cache.get(c);if(!u){switch(o){case"scene":u=this.loadScene(l);break;case"node":u=this._invokeOne(function(h){return h.loadNode&&h.loadNode(l)});break;case"mesh":u=this._invokeOne(function(h){return h.loadMesh&&h.loadMesh(l)});break;case"accessor":u=this.loadAccessor(l);break;case"bufferView":u=this._invokeOne(function(h){return h.loadBufferView&&h.loadBufferView(l)});break;case"buffer":u=this.loadBuffer(l);break;case"material":u=this._invokeOne(function(h){return h.loadMaterial&&h.loadMaterial(l)});break;case"texture":u=this._invokeOne(function(h){return h.loadTexture&&h.loadTexture(l)});break;case"skin":u=this.loadSkin(l);break;case"animation":u=this._invokeOne(function(h){return h.loadAnimation&&h.loadAnimation(l)});break;case"camera":u=this.loadCamera(l);break;default:if(u=this._invokeOne(function(h){return h!=this&&h.getDependency&&h.getDependency(o,l)}),!u)throw new Error("Unknown type: "+o)}this.cache.add(c,u)}return u}getDependencies(o){let l=this.cache.get(o);if(!l){const c=this,u=this.json[o+(o==="mesh"?"es":"s")]||[];l=Promise.all(u.map(function(h,_){return c.getDependency(o,_)})),this.cache.add(o,l)}return l}loadBuffer(o){const l=this.json.buffers[o],c=this.fileLoader;if(l.type&&l.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+l.type+" buffer type is not supported.");if(l.uri===void 0&&o===0)return Promise.resolve(this.extensions[EXTENSIONS.KHR_BINARY_GLTF].body);const u=this.options;return new Promise(function(h,_){c.load(three_module.r6x.resolveURL(l.uri,u.path),h,void 0,function(){_(new Error('THREE.GLTFLoader: Failed to load buffer "'+l.uri+'".'))})})}loadBufferView(o){const l=this.json.bufferViews[o];return this.getDependency("buffer",l.buffer).then(function(c){const u=l.byteLength||0,h=l.byteOffset||0;return c.slice(h,h+u)})}loadAccessor(o){const l=this,c=this.json,u=this.json.accessors[o];if(u.bufferView===void 0&&u.sparse===void 0){const _=WEBGL_TYPE_SIZES[u.type],A=WEBGL_COMPONENT_TYPES[u.componentType],w=u.normalized===!0,C=new A(u.count*_);return Promise.resolve(new three_module.THS(C,_,w))}const h=[];return u.bufferView!==void 0?h.push(this.getDependency("bufferView",u.bufferView)):h.push(null),u.sparse!==void 0&&(h.push(this.getDependency("bufferView",u.sparse.indices.bufferView)),h.push(this.getDependency("bufferView",u.sparse.values.bufferView))),Promise.all(h).then(function(_){const A=_[0],w=WEBGL_TYPE_SIZES[u.type],C=WEBGL_COMPONENT_TYPES[u.componentType],M=C.BYTES_PER_ELEMENT,O=M*w,ne=u.byteOffset||0,ce=u.bufferView!==void 0?c.bufferViews[u.bufferView].byteStride:void 0,ue=u.normalized===!0;let ye,Oe;if(ce&&ce!==O){const ke=Math.floor(ne/ce),Ve="InterleavedBuffer:"+u.bufferView+":"+u.componentType+":"+ke+":"+u.count;let tt=l.cache.get(Ve);tt||(ye=new C(A,ke*ce,u.count*ce/M),tt=new three_module.eB$(ye,ce/M),l.cache.add(Ve,tt)),Oe=new three_module.eHs(tt,w,ne%ce/M,ue)}else ye=A===null?new C(u.count*w):new C(A,ne,u.count*w),Oe=new three_module.THS(ye,w,ue);if(u.sparse!==void 0){const ke=WEBGL_TYPE_SIZES.SCALAR,Ve=WEBGL_COMPONENT_TYPES[u.sparse.indices.componentType],tt=u.sparse.indices.byteOffset||0,ht=u.sparse.values.byteOffset||0,ut=new Ve(_[1],tt,u.sparse.count*ke),_t=new C(_[2],ht,u.sparse.count*w);A!==null&&(Oe=new three_module.THS(Oe.array.slice(),Oe.itemSize,Oe.normalized));for(let at=0,lt=ut.length;at<lt;at++){const pt=ut[at];if(Oe.setX(pt,_t[at*w]),w>=2&&Oe.setY(pt,_t[at*w+1]),w>=3&&Oe.setZ(pt,_t[at*w+2]),w>=4&&Oe.setW(pt,_t[at*w+3]),w>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return Oe})}loadTexture(o){const l=this.json,c=this.options;if(o<0||o>=l.textures.length)return console.warn("THREE.GLTFLoader: Invalid texture index:",o),null;const u=l.textures[o].source;if(u<0||u>=l.images.length)return console.warn("THREE.GLTFLoader: Invalid source index:",u),null;const h=l.images[u];let _=this.textureLoader;if(h.uri){const A=c.manager.getHandler(h.uri);A!==null&&(_=A)}return this.loadTextureImage(o,u,_)}loadTextureImage(o,l,c){const u=this,h=this.json,_=h.textures[o],A=h.images[l],w=(A.uri||A.bufferView)+":"+_.sampler;if(this.textureCache[w])return this.textureCache[w];const C=this.loadImageSource(l,c).then(function(M){M.name=_.name||A.name||"",M.name===""&&typeof A.uri=="string"&&A.uri.startsWith("data:image/")===!1&&(M.name=A.uri);const O=(h.samplers||{})[_.sampler]||{};return M.magFilter=WEBGL_FILTERS[O.magFilter]||three_module.k6q,M.minFilter=WEBGL_FILTERS[O.minFilter]||three_module.$_I,M.wrapS=WEBGL_WRAPPINGS[O.wrapS]||three_module.GJx,M.wrapT=WEBGL_WRAPPINGS[O.wrapT]||three_module.GJx,O.extras&&O.extras.uuid!==void 0&&(M.uuid=O.extras.uuid,M.__hasGLTFUuid=!0),u.associations.set(M,{textures:o}),M}).catch(function(){return null});return this.textureCache[w]=C,C}loadImageSource(o,l,c=!1,u=!1){const h=this,_=this.json,A=this.options;if(!u&&this.sourceCache[o]!==void 0)return this.sourceCache[o].then(ue=>ue.clone());const w=_.images[o],C=self.URL||self.webkitURL;w.uri===void 0&&w.extras&&w.extras.uri&&(w.uri=w.extras.uri);let M=w.uri||"",O=!1,ne=null;if(w.bufferView===void 0||c&&M){if(w.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+o+" is missing URI and bufferView")}else M=h.getDependency("bufferView",w.bufferView).then(function(ue){O=!0;const ye=new Blob([ue],{type:w.mimeType});return M=C.createObjectURL(ye),ne=ye,M});const ce=Promise.resolve(M).then(function(ue){return new Promise(function(ye,Oe){let ke=ye;l.isImageBitmapLoader===!0&&(ke=function(Ve){const tt=new three_module.gPd(Ve);tt.needsUpdate=!0,ye(tt)}),l.load(three_module.r6x.resolveURL(ue,A.path),ke,void 0,function(Ve){l.isImageBitmapLoader===!0?(l=new three_module.Tap(h.options.manager),ke=ye,l.setCrossOrigin(h.options.crossOrigin),l.setRequestHeader(h.options.requestHeader),l.load(three_module.r6x.resolveURL(ue,A.path),ke,void 0,Oe)):Oe(Ve)})})}).then(function(ue){if(O===!0&&C.revokeObjectURL(M),ue.userData.mimeType=w.mimeType||getImageURIMimeType(w.uri),ue.flipY=!1,w.extras){if(w.extras.flipY!==void 0){if(l.isImageBitmapLoader===!0&&typeof createImageBitmap!==void 0){let ye=ue;const Oe=w.extras.flipY&&!ye.flipY;createImageBitmap(ye.source.data,{imageOrientation:Oe?"flipY":"none"}).then(function(ke){ye._newTex&&(ye=ye._newTex),ye.source.data.close&&ye.source.data.close(),ye.source.data=ke,ye.source.needsUpdate=!0,ye.needsUpdate=!0})}ue.flipY=w.extras.flipY,ue.needsUpdate=!0,delete w.extras.flipY}w.extras.uuid!==void 0&&(ue.source.uuid=w.extras.uuid),w.extras.t_uuid!==void 0&&(ue.uuid=w.extras.t_uuid,ue.__hasGLTFUuid=!0)}return w.uri&&typeof w.uri=="string"&&O===!1&&!w.uri.startsWith("/")&&(ue.userData.rootPath=three_module.r6x.resolveURL(w.uri,A.path)),ne&&(ue.userData.__sourceBlob=ne),!c&&w.uri&&w.uri!==M&&h.loadImageSource(o,l,!0,!0).then(function(ye){ue.source.data&&ue.source.data.close&&ue.source.data.close(),ue.dispose(),ue.source=ye.source,ue.source.needsUpdate=!0,ue.needsUpdate=!0,ue.uuid=ye.uuid,ye.__hasGLTFUuid&&(ue.__hasGLTFUuid=!0),ue.flipY=ye.flipY,ue.userData=ye.userData,ue.setDirty&&ue.setDirty(),ye._newTex=ue}),ue}).catch(function(ue){throw console.error("THREE.GLTFLoader: Couldn't load texture",M),ue});return this.sourceCache[o]=ce,ce}assignTexture(o,l,c,u){const h=this;return this.getDependency("texture",c.index).then(function(_){if(!_)return null;if(c.texCoord!==void 0&&c.texCoord>0&&((_=_.clone()).channel=c.texCoord),h.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]){const A=c.extensions!==void 0?c.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]:void 0;if(A){const w=h.associations.get(_);_=h.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM].extendTexture(_,A),h.associations.set(_,w)}}return u!==void 0&&(_.colorSpace=u),o[l]=_,_})}assignFinalMaterial(o){const l=o.geometry;let c=o.material;const u=l.attributes.tangent===void 0,h=l.attributes.color!==void 0,_=l.attributes.normal===void 0;if(o.isPoints){const w="PointsMaterial:"+c.uuid;let C=this.cache.get(w);C||(C=new GLTFLoader.ObjectConstructors.PointsMaterial,three_module.imn.prototype.copy.call(C,c),C.color.copy(c.color),C.map=c.map,C.sizeAttenuation=!1,this.cache.add(w,C)),c=C}else if(o.isLine){const w="LineBasicMaterial:"+c.uuid;let C=this.cache.get(w);C||(C=new GLTFLoader.ObjectConstructors.LineBasicMaterial,three_module.imn.prototype.copy.call(C,c),C.color.copy(c.color),C.map=c.map,this.cache.add(w,C)),c=C}const A=!(!c.userData||!c.userData.gltfExtensions||!c.userData.gltfExtensions.WEBGI_material_extras);if((u||h||_)&&!A){let w="ClonedMaterial:"+c.uuid+":";u&&(w+="derivative-tangents:"),h&&(w+="vertex-colors:"),_&&(w+="flat-shading:");let C=this.cache.get(w);C||(C=c.clone(),h&&(C.vertexColors=!0),_&&(C.flatShading=!0),u&&(C.normalScale&&(C.normalScale.y*=-1),C.clearcoatNormalScale&&(C.clearcoatNormalScale.y*=-1)),this.cache.add(w,C),this.associations.set(C,this.associations.get(c))),c=C}o.material=c}getMaterialType(){return GLTFLoader.ObjectConstructors.MeshStandardMaterial}loadMaterial(o){const l=this,c=this.json,u=this.extensions,h=c.materials[o];let _;const A={},w=[];if((h.extensions||{})[EXTENSIONS.KHR_MATERIALS_UNLIT]){const M=u[EXTENSIONS.KHR_MATERIALS_UNLIT];_=M.getMaterialType(),w.push(M.extendParams(A,h,l))}else{const M=h.pbrMetallicRoughness||{};if(A.color=new three_module.Q1f(1,1,1),A.opacity=1,Array.isArray(M.baseColorFactor)){const O=M.baseColorFactor;A.color.setRGB(O[0],O[1],O[2],three_module.Zr2),A.opacity=O[3]}M.baseColorTexture!==void 0&&w.push(l.assignTexture(A,"map",M.baseColorTexture,three_module.er$)),A.metalness=M.metallicFactor!==void 0?M.metallicFactor:1,A.roughness=M.roughnessFactor!==void 0?M.roughnessFactor:1,M.metallicRoughnessTexture!==void 0&&(w.push(l.assignTexture(A,"metalnessMap",M.metallicRoughnessTexture)),w.push(l.assignTexture(A,"roughnessMap",M.metallicRoughnessTexture))),_=this._invokeOne(function(O){return O.getMaterialType&&O.getMaterialType(o)}),w.push(Promise.all(this._invokeAll(function(O){return O.extendMaterialParams&&O.extendMaterialParams(o,A)})))}h.doubleSided===!0&&(A.side=three_module.$EB);const C=h.alphaMode||ALPHA_MODES.OPAQUE;if(C===ALPHA_MODES.BLEND?(A.transparent=!0,A.depthWrite=!1):(A.transparent=!1,C===ALPHA_MODES.MASK&&(A.alphaTest=h.alphaCutoff!==void 0?h.alphaCutoff:.5)),h.normalTexture!==void 0&&_!==GLTFLoader.ObjectConstructors.MeshBasicMaterial&&(w.push(l.assignTexture(A,"normalMap",h.normalTexture)),A.normalScale=new three_module.I9Y(1,1),h.normalTexture.scale!==void 0)){const M=h.normalTexture.scale;A.normalScale.set(M,M)}if(h.occlusionTexture!==void 0&&_!==GLTFLoader.ObjectConstructors.MeshBasicMaterial&&(w.push(l.assignTexture(A,"aoMap",h.occlusionTexture)),h.occlusionTexture.strength!==void 0&&(A.aoMapIntensity=h.occlusionTexture.strength)),h.emissiveFactor!==void 0&&_!==GLTFLoader.ObjectConstructors.MeshBasicMaterial){const M=h.emissiveFactor;A.emissive=new three_module.Q1f().setRGB(M[0],M[1],M[2],three_module.Zr2)}return h.emissiveTexture!==void 0&&_!==GLTFLoader.ObjectConstructors.MeshBasicMaterial&&w.push(l.assignTexture(A,"emissiveMap",h.emissiveTexture,three_module.er$)),Promise.all(w).then(function(){const M=new _(A);return h.extras&&h.extras.uuid&&(M.uuid=h.extras.uuid),h.name&&(M.name=h.name),assignExtrasToUserData(M,h),l.associations.set(M,{materials:o}),h.extensions&&addUnknownExtensionsToUserData(u,M,h),M})}createUniqueName(o){const l=three_module.Nwf.sanitizeNodeName(o||"");return l in this.nodeNamesUsed?l+"_"+ ++this.nodeNamesUsed[l]:(this.nodeNamesUsed[l]=0,l)}loadGeometries(o){const l=this,c=this.extensions,u=this.primitiveCache;function h(A){return c[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(A,l).then(function(w){return addPrimitiveAttributes(w,A,l)})}const _=[];for(let A=0,w=o.length;A<w;A++){const C=o[A],M=createPrimitiveKey(C),O=u[M];if(O)_.push(O.promise);else{let ne;ne=C.extensions&&C.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION]?h(C):addPrimitiveAttributes(new three_module.LoY,C,l),u[M]={primitive:C,promise:ne},_.push(ne)}}return Promise.all(_)}loadMesh(o){const l=this,c=this.json,u=this.extensions,h=c.meshes[o],_=h.primitives,A=[];for(let w=0,C=_.length;w<C;w++){const M=_[w].material===void 0?createDefaultMaterial(this.cache):this.getDependency("material",_[w].material);A.push(M)}return A.push(l.loadGeometries(_)),Promise.all(A).then(function(w){const C=w.slice(0,w.length-1),M=w[w.length-1],O=[];for(let ce=0,ue=M.length;ce<ue;ce++){const ye=M[ce],Oe=_[ce];let ke;const Ve=C[ce];if(Oe.mode===WEBGL_CONSTANTS.TRIANGLES||Oe.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP||Oe.mode===WEBGL_CONSTANTS.TRIANGLE_FAN||Oe.mode===void 0)ke=h.isSkinnedMesh===!0?new three_module.I46(ye,Ve):new three_module.eaF(ye,Ve),ke.isSkinnedMesh===!0&&ke.normalizeSkinWeights(),Oe.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP?ke.geometry=toTrianglesDrawMode(ke.geometry,three_module.O49):Oe.mode===WEBGL_CONSTANTS.TRIANGLE_FAN&&(ke.geometry=toTrianglesDrawMode(ke.geometry,three_module.rYR));else if(Oe.mode===WEBGL_CONSTANTS.LINES)ke=new three_module.DXC(ye,Ve);else if(Oe.mode===WEBGL_CONSTANTS.LINE_STRIP)ke=new three_module.N1A(ye,Ve);else if(Oe.mode===WEBGL_CONSTANTS.LINE_LOOP)ke=new three_module.FCc(ye,Ve);else{if(Oe.mode!==WEBGL_CONSTANTS.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+Oe.mode);ke=new three_module.ONl(ye,Ve)}Object.keys(ke.geometry.morphAttributes).length>0&&updateMorphTargets(ke,h),ke.name=l.createUniqueName(h.name||"mesh_"+o),ke.geometry&&h.extras&&h.extras.isGeometryUserData?(assignExtrasToUserData(ke.geometry,h),Oe.extensions&&addUnknownExtensionsToUserData(u,ke.geometry,Oe)):(assignExtrasToUserData(ke,h),Oe.extensions&&addUnknownExtensionsToUserData(u,ke,Oe)),l.assignFinalMaterial(ke),O.push(ke)}h.extensions&&O.forEach(ce=>addUnknownExtensionsToUserData(u,ce,h));for(let ce=0,ue=O.length;ce<ue;ce++)l.associations.set(O[ce],{meshes:o,primitives:ce});if(O.length===1)return h.extensions&&addUnknownExtensionsToUserData(u,O[0],h),O[0];const ne=new three_module.YJl;h.extensions&&addUnknownExtensionsToUserData(u,ne,h),l.associations.set(ne,{meshes:o});for(let ce=0,ue=O.length;ce<ue;ce++)ne.add(O[ce]);return ne})}loadCamera(o){let l;const c=this.json.cameras[o],u=c[c.type];if(u)return c.type==="perspective"?l=new GLTFLoader.ObjectConstructors.PerspectiveCamera(three_module.cj9.radToDeg(u.yfov),u.aspectRatio||1,u.znear||1,u.zfar||2e6):c.type==="orthographic"&&(l=new GLTFLoader.ObjectConstructors.OrthographicCamera(-u.xmag,u.xmag,u.ymag,-u.ymag,u.znear,u.zfar)),c.name&&(l.name=this.createUniqueName(c.name)),assignExtrasToUserData(l,c),Promise.resolve(l);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(o){const l=this.json.skins[o],c=[];for(let u=0,h=l.joints.length;u<h;u++)c.push(this._loadNodeShallow(l.joints[u]));return l.inverseBindMatrices!==void 0?c.push(this.getDependency("accessor",l.inverseBindMatrices)):c.push(null),Promise.all(c).then(function(u){const h=u.pop(),_=u,A=[],w=[];for(let C=0,M=_.length;C<M;C++){const O=_[C];if(O){A.push(O);const ne=new three_module.kn4;h!==null&&ne.fromArray(h.array,16*C),w.push(ne)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',l.joints[C])}return new three_module.EAD(A,w)})}loadAnimation(o){const l=this.json,c=this,u=l.animations[o],h=u.name?u.name:"animation_"+o,_=[],A=[],w=[],C=[],M=[];for(let O=0,ne=u.channels.length;O<ne;O++){const ce=u.channels[O],ue=u.samplers[ce.sampler],ye=ce.target,Oe=ye.node,ke=u.parameters!==void 0?u.parameters[ue.input]:ue.input,Ve=u.parameters!==void 0?u.parameters[ue.output]:ue.output;ye.node!==void 0&&(_.push(this.getDependency("node",Oe)),A.push(this.getDependency("accessor",ke)),w.push(this.getDependency("accessor",Ve)),C.push(ue),M.push(ye))}return Promise.all([Promise.all(_),Promise.all(A),Promise.all(w),Promise.all(C),Promise.all(M)]).then(function(O){const ne=O[0],ce=O[1],ue=O[2],ye=O[3],Oe=O[4],ke=[];for(let Ve=0,tt=ne.length;Ve<tt;Ve++){const ht=ne[Ve],ut=ce[Ve],_t=ue[Ve],at=ye[Ve],lt=Oe[Ve];if(ht===void 0)continue;ht.updateMatrix&&ht.updateMatrix();const pt=c._createAnimationTracks(ht,ut,_t,at,lt);if(pt)for(let xt=0;xt<pt.length;xt++)ke.push(pt[xt])}return new three_module.tz3(h,void 0,ke)})}createNodeMesh(o){const l=this.json,c=this,u=l.nodes[o];return u.mesh===void 0?null:c.getDependency("mesh",u.mesh).then(function(h){const _=c._getNodeRef(c.meshCache,u.mesh,h);return u.weights!==void 0&&_.traverse(function(A){if(A.isMesh)for(let w=0,C=u.weights.length;w<C;w++)A.morphTargetInfluences[w]=u.weights[w]}),_})}loadNode(o){const l=this,c=this.json.nodes[o],u=l._loadNodeShallow(o),h=[],_=c.children||[];for(let w=0,C=_.length;w<C;w++)h.push(l.getDependency("node",_[w]));const A=c.skin===void 0?Promise.resolve(null):l.getDependency("skin",c.skin);return Promise.all([u,Promise.all(h),A]).then(function(w){const C=w[0],M=w[1],O=w[2];O!==null&&C.traverse(function(ne){ne.isSkinnedMesh&&ne.bind(O,_identityMatrix)});for(let ne=0,ce=M.length;ne<ce;ne++)C.add(M[ne]);return C})}_loadNodeShallow(o){const l=this.json,c=this.extensions,u=this;if(this.nodeCache[o]!==void 0)return this.nodeCache[o];const h=l.nodes[o],_=h.name?u.createUniqueName(h.name):"",A=[],w=u._invokeOne(function(C){return C.createNodeMesh&&C.createNodeMesh(o)});return w&&A.push(w),h.camera!==void 0&&A.push(u.getDependency("camera",h.camera).then(function(C){return u._getNodeRef(u.cameraCache,h.camera,C)})),u._invokeAll(function(C){return C.createNodeAttachment&&C.createNodeAttachment(o)}).forEach(function(C){A.push(C)}),this.nodeCache[o]=Promise.all(A).then(function(C){let M;if(M=h.isBone===!0?new three_module.$Kf:C.length>1?new three_module.YJl:C.length===1?C[0]:new three_module.B69,M!==C[0])for(let O=0,ne=C.length;O<ne;O++)M.add(C[O]);if(h.name&&(M.userData.name=h.name,M.name=_),assignExtrasToUserData(M,h),h.extensions&&addUnknownExtensionsToUserData(c,M,h),h.matrix!==void 0){const O=new three_module.kn4;O.fromArray(h.matrix),M.applyMatrix4(O)}else h.translation!==void 0&&M.position.fromArray(h.translation),h.rotation!==void 0&&M.quaternion.fromArray(h.rotation),h.scale!==void 0&&M.scale.fromArray(h.scale);return u.associations.has(M)||u.associations.set(M,{}),u.associations.get(M).nodes=o,M}),this.nodeCache[o]}loadScene(o){const l=this.extensions,c=this.json.scenes[o],u=this,h=new three_module.YJl;c.name&&(h.name=u.createUniqueName(c.name)),assignExtrasToUserData(h,c),c.extensions&&addUnknownExtensionsToUserData(l,h,c);const _=c.nodes||[],A=[];for(let w=0,C=_.length;w<C;w++)A.push(u.getDependency("node",_[w]));return Promise.all(A).then(function(w){for(let C=0,M=w.length;C<M;C++)h.add(w[C]);return u.associations=(C=>{const M=new Map;for(const[O,ne]of u.associations)(O instanceof three_module.imn||O instanceof three_module.gPd)&&M.set(O,ne);return C.traverse(O=>{const ne=u.associations.get(O);ne!=null&&M.set(O,ne)}),M})(h),h})}_createAnimationTracks(o,l,c,u,h){const _=[],A=o.name?o.name:o.uuid,w=[];let C;switch(PATH_PROPERTIES[h.path]===PATH_PROPERTIES.weights?o.traverse(function(ne){ne.morphTargetInfluences&&w.push(ne.name?ne.name:ne.uuid)}):w.push(A),PATH_PROPERTIES[h.path]){case PATH_PROPERTIES.weights:C=three_module.Hit;break;case PATH_PROPERTIES.rotation:C=three_module.MBL;break;case PATH_PROPERTIES.position:case PATH_PROPERTIES.scale:C=three_module.RiT;break;default:C=c.itemSize===1?three_module.Hit:three_module.RiT}const M=u.interpolation!==void 0?INTERPOLATION[u.interpolation]:three_module.PJ3,O=this._getArrayFromAccessor(c);for(let ne=0,ce=w.length;ne<ce;ne++){const ue=new C(w[ne]+"."+PATH_PROPERTIES[h.path],l.array,O,M);u.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(ue),_.push(ue)}return _}_getArrayFromAccessor(o){let l=o.array;if(o.normalized){const c=getNormalizedComponentScale(l.constructor),u=new Float32Array(l.length);for(let h=0,_=l.length;h<_;h++)u[h]=l[h]*c;l=u}return l}_createCubicSplineTrackInterpolant(o){o.createInterpolant=function(l){return new(this instanceof three_module.MBL?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant)(this.times,this.values,this.getValueSize()/3,l)},o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function computeBounds(d,o,l){const c=o.attributes,u=new three_module.NRn;if(c.POSITION===void 0)return;{const A=l.json.accessors[c.POSITION],w=A.min,C=A.max;if(w===void 0||C===void 0)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(u.set(new three_module.Pq0(w[0],w[1],w[2]),new three_module.Pq0(C[0],C[1],C[2])),A.normalized){const M=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[A.componentType]);u.min.multiplyScalar(M),u.max.multiplyScalar(M)}}const h=o.targets;if(h!==void 0){const A=new three_module.Pq0,w=new three_module.Pq0;for(let C=0,M=h.length;C<M;C++){const O=h[C];if(O.POSITION!==void 0){const ne=l.json.accessors[O.POSITION],ce=ne.min,ue=ne.max;if(ce!==void 0&&ue!==void 0){if(w.setX(Math.max(Math.abs(ce[0]),Math.abs(ue[0]))),w.setY(Math.max(Math.abs(ce[1]),Math.abs(ue[1]))),w.setZ(Math.max(Math.abs(ce[2]),Math.abs(ue[2]))),ne.normalized){const ye=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[ne.componentType]);w.multiplyScalar(ye)}A.max(w)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}u.expandByVector(A)}d.boundingBox=u;const _=new three_module.iyt;u.getCenter(_.center),_.radius=u.min.distanceTo(u.max)/2,d.boundingSphere=_}function addPrimitiveAttributes(d,o,l){const c=o.attributes,u=[];function h(_,A){return l.getDependency("accessor",_).then(function(w){d.setAttribute(A,w)})}for(const _ in c){const A=ATTRIBUTES[_]||_.toLowerCase();A in d.attributes||u.push(h(c[_],A))}if(o.indices!==void 0&&!d.index){const _=l.getDependency("accessor",o.indices).then(function(A){d.setIndex(A)});u.push(_)}return three_module.ppV.workingColorSpace!==three_module.Zr2&&"COLOR_0"in c&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${three_module.ppV.workingColorSpace}" not supported.`),assignExtrasToUserData(d,o),computeBounds(d,o,l),Promise.all(u).then(function(){return o.targets!==void 0?addMorphTargets(d,o.targets,l):d})}class GLTFLoader2 extends GLTFLoader{constructor(o){super(o),this.isGLTFLoader2=!0,this.preparsers=[],this.preparsers.push(glbEncryptionPreparser)}async preparse(o,l){for(const c of this.preparsers)o=await c.process(o,l);return o}parse(o,l,c,u,h){this.preparse.call(this,o,h||l).then(_=>{const A=three_module.gPd.DEFAULT_IMAGE;return three_module.gPd.DEFAULT_IMAGE||(three_module.gPd.DEFAULT_IMAGE=AssetImporter.WHITE_IMAGE_DATA),_?super.parse(_,l,w=>{three_module.gPd.DEFAULT_IMAGE=A,c&&c(w)},u):u&&u(new ErrorEvent("no data"))}).catch(_=>{console.error(_),u&&u(_??new ErrorEvent("unknown error"))})}transform(o,l){const c=o?o.scene||(o.scenes&&o.scenes.length>0?o.scenes[0]:void 0):void 0;return c&&o.animations.length>0&&(c.animations=o.animations),c==null||c.traverse(u=>{u.userData.gltfUUID&&(u.uuid=u.userData.gltfUUID,delete u.userData.gltfUUID)}),c}register(o){return super.register(o)}}const glbEncryptionPreparser={key:(d,o,l)=>d.key||window&&window.prompt&&window.prompt("GLTFEncryption: Please enter the password/key for the model: "+l)||"",async process(d,o){var l;if(typeof d=="string"||!new TextDecoder().decode(new Uint8Array(d,0,100)).includes("WebGiGLBWrapper"))return d;const c=new GLTFBinaryExtension(d),u=JSON.parse(c.content||"{}");let h=c.body||d;const _=(l=u.asset)===null||l===void 0?void 0:l.encryption;if(!_)return h;const A=_.type,w=_.version;if(A==="aesgcm"&&w===1){const C=await Ee(this.key,_,u,o)||"";try{h=(await Pe(new Uint8Array(h),C)).buffer}catch{throw new ErrorEvent("decryption error")}}return h}};class RGBEPNGLoader extends three_module.Y9S{constructor(o){super(o),this.type=three_module.ix0}async loadAsync(o,l){const c=await this.parseAsync(o,l,!1),u=new three_module.GYF(c.data,c.width,c.height,three_module.GWd,this.type);return u.needsUpdate=!0,u.flipY=!0,u.colorSpace=three_module.er$,u.minFilter=three_module.k6q,u.magFilter=three_module.k6q,u.source.data.complete=!0,u}async parseAsync(o,l,c=!1){let u=!1;if(!o.startsWith("data:")&&!o.startsWith("blob:")){this.responseType="blob";const A=await super.loadAsync(o,l);o=URL.createObjectURL(A),u=!0}const h=await He(o);u&&URL.revokeObjectURL(o);let _=Uint8Array;return this.type===three_module.ix0?_=Uint16Array:this.type===three_module.RQf&&(_=Uint32Array),{data:rgbeToHalfFloat(h.data,4,_,c),width:h.width,height:h.height}}setDataType(o){return this.type=o,this}}function rgbeToHalfFloat(d,o=3,l=Uint16Array,c=!1){let u;const h=d.byteLength>>2,_=new l(h*o);for(let A=0;A<h;A++)u=Math.pow(2,d[4*A+3]-136),c?(_[A*o]=Math.min(d[4*A]*u,65504),_[A*o+1]=Math.min(d[4*A+1]*u,65504),_[A*o+2]=Math.min(d[4*A+2]*u,65504)):(_[A*o]=three_module.GxU.toHalfFloat(Math.min(d[4*A]*u,65504)),_[A*o+1]=three_module.GxU.toHalfFloat(Math.min(d[4*A+1]*u,65504)),_[A*o+2]=three_module.GxU.toHalfFloat(Math.min(d[4*A+2]*u,65504))),o===4&&(_[A*o+3]=three_module.GxU.toHalfFloat(1));return _}class ObjectLoader2 extends three_module.XTe{constructor(o){super(o),this._imageLoader=new three_module.$NF(o)}static async LoadRootPathTextures(o,l,c,u=!0){var h;const _=[];for(const A of Array.isArray(o)?o:Object.values(o??{})){const w=(h=A==null?void 0:A.userData)===null||h===void 0?void 0:h.rootPath,C=u&&A.image&&l[A.image];if(!w)continue;const M=c.importPath(w,{processImported:!1}).then(O=>{const ne=O==null?void 0:O[0],ce=ne==null?void 0:ne.source;if(!ne||!ce)return null;const ue=new three_module.kLi(ce.data);return A.image&&(ue.uuid=A.image),A.image=ue.uuid,C||(l[ue.uuid]=ue),ne.dispose(),ue}).catch(O=>(console.error(O),delete A.userData.rootPath,null));C?A.rootPathPromise=M:_.push(M)}await Promise.allSettled(_)}parseTextures2(o,l,c){var u,h;for(const w of o){const C=(u=w==null?void 0:w.userData)===null||u===void 0?void 0:u.rootPath;if(C&&(!w.image||!l[w.image])){const M=new three_module.kLi(this._imageLoader.load(C,c));if(!M)continue;w.image&&(M.uuid=w.image),l[M.uuid]=M,w.image=M.uuid}w.userData=deserializeObject(w.userData,void 0,!1,{images:l})}const _=super.parseTextures(o,l),A={..._};for(const w of o)(h=w.rootPathPromise)===null||h===void 0||h.then(C=>{if(!C)return;const M=A[w.uuid];M.dispose(),M.source=C,M.source.needsUpdate=!0,M.needsUpdate=!0});return _}parseMaterials2(o,l,c){const u={};return o.forEach(h=>{if(!h)return;const _={...h},A=Object.keys(_);for(const C of A)if(C==="map"||C.endsWith("Map")){const M=_[C];typeof M=="string"&&(l[M]?_[C]=l[M]:(console.warn(`Texture ${M} not found`),delete _[C]))}_.userData&&(_.userData=deserializeObject(_.userData,void 0,!1,{textures:l}),_.userData.cloneId&&_.userData.uuid!==h.uuid&&(_.userData.uuid=h.uuid));const w=c.generateFromTemplateType(_.type,_);w&&(u[h.uuid]=w)}),u}}const viewerGLTFExtension="WEBGI_viewer",webgiLightExtrasExtension="WEBGI_light_extras",webgiObject3DExtrasExtension="WEBGI_object3d_extras",webgiMaterialExtrasExtension="WEBGI_material_extras",GLTFMaterialsBumpMapExtensionName="WEBGI_materials_bumpmap",GLTFMaterialsDisplacementMapExtensionName="WEBGI_materials_displacementmap",GLTFMaterialsAlphaMapExtensionName="WEBGI_materials_alphamap",GLTFMaterialsLightMapExtensionName="WEBGI_materials_lightmap",supportedEmbeddedFiles=["hdr","exr","webp","avif","ktx","hdrpng","svg","cube"];function addGLTFLoader(d){return new Importer(GLTFLoader2,["gltf","glb","data:model/gltf"],!0,(o,l)=>{if(!o)return o;const c=o,u=new ObjectLoader2(l.loadingManager);return c.register(gltfMaterialExtrasParser(u,d)),c.register(gltfObject3DExtrasParser()),c.register(gltfLightExtrasParser(u)),c.register(h=>new GLTFMaterialsBumpMapExtension(h)),c.register(h=>new GLTFMaterialsDisplacementMapExtension(h)),c.register(h=>new GLTFMaterialsLightMapExtension(h)),c.register(h=>new GLTFMaterialsAlphaMapExtension(h)),c.register(h=>{var _,A,w,C,M,O,ne,ce,ue;const ye=h.getDependency;h.getDependency=async(ut,_t)=>{const at=await ye.call(h,ut,_t);if(at&&at.userData){const lt=at.userData.gltfExtensions;delete at.userData.gltfExtensions,at.userData=deserializeObject(at.userData,{},!1,{}),at.userData.gltfExtensions=lt}return at};const Oe=esm_browser_v4()+".drc",ke=esm_browser_v4()+".ktx2",Ve=(w=(A=(_=h.json)===null||_===void 0?void 0:_.extensionsRequired)===null||A===void 0?void 0:A.includes)===null||w===void 0?void 0:w.call(A,"KHR_draco_mesh_compression");if(Ve){const ut=l.registerFile(Oe);ut&&c.setDRACOLoader(ut)}!((O=(M=(C=h.json)===null||C===void 0?void 0:C.extensionsUsed)===null||M===void 0?void 0:M.includes)===null||O===void 0)&&O.call(M,"EXT_meshopt_compression")&&(window.MeshoptDecoder?(c.setMeshoptDecoder(window.MeshoptDecoder),h.options.meshoptDecoder=window.MeshoptDecoder):console.error("Add GLTFMeshOptPlugin to viewer to enable EXT_meshopt_compression decode"));const tt=l.registerFile(ke),ht=supportedEmbeddedFiles.map(ut=>esm_browser_v4()+"."+ut);return ht.forEach(ut=>l.registerFile(ut)),!((ue=(ce=(ne=h.json)===null||ne===void 0?void 0:ne.extensionsUsed)===null||ce===void 0?void 0:ce.includes)===null||ue===void 0)&&ue.call(ce,"KHR_texture_basisu")&&tt&&(c.setKTX2Loader(tt),h.options.ktx2Loader=tt),{name:"GLTF2_HELPER_PLUGIN",afterRoot:async ut=>{Ve&&l.unregisterFile(Oe),tt&&l.unregisterFile(ke),ht.forEach(at=>l.unregisterFile(at));const _t=await importViewer(h,d,u);ut.scene&&(ut.scene.__importedViewerConfig=_t)}}}),c})}const gltfObject3DExtrasParser=d=>o=>({name:"__"+webgiObject3DExtrasExtension,afterRoot:async l=>{(l.scenes||(l.scene?[l.scene]:[])).forEach(c=>{c.traverse(u=>{var h,_;if(!u||!u.isObject3D)return;const A=(_=(h=u.userData)===null||h===void 0?void 0:h.gltfExtensions)===null||_===void 0?void 0:_[webgiObject3DExtrasExtension];if(!A)return void(u.isLight&&!u.isAmbientLight&&(u.castShadow=!0));const w=A.castShadow!==void 0||A.receiveShadow!==void 0;A.castShadow!==void 0&&(u.castShadow=A.castShadow),A.receiveShadow!==void 0&&(u.receiveShadow=A.receiveShadow),A.visible!==void 0&&(u.visible=A.visible),A.frustumCulled!==void 0&&(u.frustumCulled=A.frustumCulled),A.renderOrder!==void 0&&(u.renderOrder=A.renderOrder),A.layers!==void 0&&(u.layers.mask=A.layers),w&&(u.userData.__keepShadowDef=!0),delete u.userData.gltfExtensions[webgiObject3DExtrasExtension]})})}}),gltfMaterialExtrasParser=(d,o)=>l=>({name:"__"+webgiMaterialExtrasExtension,afterRoot:async c=>{var u,h,_;const A=c.scenes||(c.scene?[c.scene]:[]);for(const w of A){const C=(h=(u=w.userData)===null||u===void 0?void 0:u.gltfExtensions)===null||h===void 0?void 0:h[webgiMaterialExtrasExtension],M=C&&await((_=o.getPlugin(AssetManagerPlugin))===null||_===void 0?void 0:_.importConfigResources(C.resources||{}))||{};w.traverse(O=>{var ne,ce;const ue=O==null?void 0:O.material;if(!(ue!=null&&ue.isMaterial))return;const ye=(ce=(ne=ue.userData)===null||ne===void 0?void 0:ne.gltfExtensions)===null||ce===void 0?void 0:ce[webgiMaterialExtrasExtension];ye&&(ye.emissiveIntensity!==void 0&&(ue.emissiveIntensity=ye.emissiveIntensity),ye.fog!==void 0&&(ue.fog=ye.fog),ye.flatShading!==void 0&&(ue.flatShading=ye.flatShading),ye.blending!==void 0&&(ue.blending=ye.blending),ye.side!==void 0&&(ue.side=ye.side),ye.shadowSide!==void 0&&(ue.shadowSide=ye.shadowSide),ye.depthFunc!==void 0&&(ue.depthFunc=ye.depthFunc),ye.depthTest!==void 0&&(ue.depthTest=ye.depthTest),ye.depthWrite!==void 0&&(ue.depthWrite=ye.depthWrite),ye.colorWrite!==void 0&&(ue.colorWrite=ye.colorWrite),ye.vertexColors!==void 0&&(ue.vertexColors=ye.vertexColors),ye.alphaTest!==void 0&&(ue.alphaTest=ye.alphaTest),ye.alphaHash!==void 0&&(ue.alphaHash=ye.alphaHash),ye.envMapIntensity!==void 0&&(ue.envMapIntensity=ye.envMapIntensity),ye.wireframe!==void 0&&(ue.wireframe=ye.wireframe),ye.wireframeLinewidth!==void 0&&(ue.wireframeLinewidth=ye.wireframeLinewidth),ye.wireframeLinecap!==void 0&&(ue.wireframeLinecap=ye.wireframeLinecap),ye.wireframeLinejoin!==void 0&&(ue.wireframeLinejoin=ye.wireframeLinejoin),ye.rotation!==void 0&&(ue.rotation=ye.rotation),ye.polygonOffset!==void 0&&(ue.polygonOffset=ye.polygonOffset),ye.polygonOffsetFactor!==void 0&&(ue.polygonOffsetFactor=ye.polygonOffsetFactor),ye.polygonOffsetUnits!==void 0&&(ue.polygonOffsetUnits=ye.polygonOffsetUnits),ye.dithering!==void 0&&(ue.dithering=ye.dithering),ye.alphaToCoverage!==void 0&&(ue.alphaToCoverage=ye.alphaToCoverage),ye.premultipliedAlpha!==void 0&&(ue.premultipliedAlpha=ye.premultipliedAlpha),ye.toneMapped!==void 0&&(ue.toneMapped=ye.toneMapped),ye.normalScale!==void 0&&ue.normalScale!==void 0&&(Array.isArray(ye.normalScale)?ue.normalScale.fromArray(ye.normalScale):typeof ye.normalScale=="number"?ue.normalScale.set(ye.normalScale,ye.normalScale):o.console.warn("normalScale is not an array or number",ye.normalScale)),ye.reflectivity!==void 0&&(ue.reflectivity=ye.reflectivity),Object.entries(ye).forEach(([Oe,ke])=>{Oe.startsWith("_")||ke&&ke.resource&&typeof ke.resource=="string"&&(ue[Oe]=deserializeObject(ke,ue[Oe],!1,M))}),delete ue.userData.gltfExtensions[webgiMaterialExtrasExtension])}),C&&delete w.userData.gltfExtensions[webgiMaterialExtrasExtension]}}}),gltfLightExtrasParser=d=>o=>({name:"__"+webgiLightExtrasExtension,afterRoot:async l=>{(l.scenes||(l.scene?[l.scene]:[])).forEach(c=>{c.traverse(u=>{var h,_;if(!u.isLight)return;const A=(_=(h=u.userData)===null||h===void 0?void 0:h.gltfExtensions)===null||_===void 0?void 0:_[webgiLightExtrasExtension];A&&(!u.shadow&&A.shadow&&console.error("Light has no shadow, cannot import",u,A),A.shadow&&u.shadow&&(A.shadow.bias!==void 0&&(u.shadow.bias=A.shadow.bias),A.shadow.normalBias!==void 0&&(u.shadow.normalBias=A.shadow.normalBias),A.shadow.radius!==void 0&&(u.shadow.radius=A.shadow.radius),A.shadow.mapSize!==void 0&&u.shadow.mapSize.fromArray(A.shadow.mapSize),A.shadow.camera!==void 0&&(u.shadow.camera=d.parseObject(A.shadow.camera))),delete u.userData.gltfExtensions[webgiLightExtrasExtension])})})}});async function importViewer(d,o,l,c){var u,h,_;if(!c){const O=d.json.scenes||[];if(O.length!==1){for(const ne of O)await importViewer(d,o,l,ne);return}c=O[0]}const A=(u=c.extensions)===null||u===void 0?void 0:u[viewerGLTFExtension];if(!A)return;const w=[];Object.values(A.resources).forEach(O=>{Object.values(O).forEach(ne=>{ne.url&&(ne.url.type==="Uint16Array"&&ne.url.data&&w.push(ne.url),ne.url.type==="Uint8Array"&&ne.url.data&&w.push(ne.url))})});for(const O of w){const ne=O.data.image,ce=d.json.images[ne],ue=await d.getDependency("bufferView",ce.bufferView);if(ce.mimeType.startsWith("image/")&&O.type==="Uint16Array"&&O.encoding==="rgbe"){const ye=new Blob([ue]);let Oe=URL.createObjectURL(ye);(O.encodingVersion||1)<2&&(Oe="data:image/png;base64,"+btoa(await ye.text())),O.data=(await new RGBEPNGLoader().parseAsync(Oe,void 0,!0)).data,URL.revokeObjectURL(Oe),delete O.encoding,delete O.encodingVersion}else O.data=ue}const C={textures:{},materials:{}},M=A.resources;if(M.textures&&d.json.textures)for(const[O,ne]of[...Object.entries(M.textures)]){if(ne.uuid||!O)continue;delete M.textures[O];const ce=d.json.textures.findIndex(ue=>{var ye,Oe,ke,Ve,tt,ht,ut;return((ye=ue.extras)===null||ye===void 0?void 0:ye.uuid)===O||((Ve=(ke=(Oe=d.json.samplers)===null||Oe===void 0?void 0:Oe[ue.sampler])===null||ke===void 0?void 0:ke.extras)===null||Ve===void 0?void 0:Ve.uuid)===O||((ut=(ht=(tt=d.json.images)===null||tt===void 0?void 0:tt[ue.source])===null||ht===void 0?void 0:ht.extras)===null||ut===void 0?void 0:ut.t_uuid)===O});ce>=0&&(C.textures[O]=await d.getDependency("texture",ce))}if(M.materials&&d.json.materials)for(const[O,ne]of[...Object.entries(M.materials)]){if(ne.uuid||!O)continue;delete M.materials[O];const ce=d.json.materials.findIndex(ue=>{var ye;return((ye=ue.extras)===null||ye===void 0?void 0:ye.uuid)===O});ce>=0&&(C.materials[O]=await d.getDependency("material",ce),C.materials[O]=(_=(h=o.getPlugin(AssetManagerPlugin))===null||h===void 0?void 0:h.materials)===null||_===void 0?void 0:_.processMaterial(C.materials[O],{}))}return A.resources=await o.getPlugin(AssetManagerPlugin).importConfigResources(M||{},l,C),A}class GLTFMaterialsBumpMapExtension{constructor(o){this.parser=o,this.name=GLTFMaterialsBumpMapExtensionName}async extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];return _.bumpScale!==void 0&&(l.bumpScale=_.bumpScale),_.bumpTexture!==void 0&&h.push(c.assignTexture(l,"bumpMap",_.bumpTexture)),Promise.all(h)}}class GLTFMaterialsDisplacementMapExtension{constructor(o){this.parser=o,this.name=GLTFMaterialsDisplacementMapExtensionName}async extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];return _.displacementScale!==void 0&&(l.displacementScale=_.displacementScale),_.displacementBias!==void 0&&(l.displacementBias=_.displacementBias),_.displacementTexture!==void 0&&h.push(c.assignTexture(l,"displacementMap",_.displacementTexture)),Promise.all(h)}}class GLTFMaterialsLightMapExtension{constructor(o){this.parser=o,this.name=GLTFMaterialsLightMapExtensionName}async extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];return _.lightMapIntensity!==void 0&&(l.lightMapIntensity=_.lightMapIntensity),_.lightMapTexture!==void 0&&h.push(c.assignTexture(l,"lightMap",_.lightMapTexture)),Promise.all(h)}}class GLTFMaterialsAlphaMapExtension{constructor(o){this.parser=o,this.name=GLTFMaterialsAlphaMapExtensionName}async extendMaterialParams(o,l){const c=this.parser,u=c.json.materials[o];if(!u.extensions||!u.extensions[this.name])return Promise.resolve();const h=[],_=u.extensions[this.name];return _.alphaTexture!==void 0&&h.push(c.assignTexture(l,"alphaMap",_.alphaTexture)),Promise.all(h)}}var DRACOLoader2=__webpackgi_require__(957);function addDracoLoader(){return new Importer(DRACOLoader2.Z,["drc"],!0)}class DirectionalLight2 extends three_module.ZyN{get lightObject(){return this}get modelObject(){return this}constructor(o,l){super(),this.assetType="light",this.isDirectionalLight2=!0,this.color=new three_module.Q1f(o),this.intensity=l||1,this.target.position.set(0,0,-1),this.add(this.target)}copy(o,l){const c=this.target,u=o.userData;return o.userData={},super.copy(o,l),copyObject3DUserData(this.userData,u),c.position.copy(this.target.position),c.updateMatrixWorld(),this.target=c,this}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Directional Light",children:[{type:"checkbox",label:"Enabled",property:[this,"visible"]},{type:"color",label:"Color",property:[this,"color"]},{type:"slider",label:"Intensity",bounds:[0,40],property:[this,"intensity"]},{type:"vec3",label:"Rotation",property:[this,"rotation"]},{type:"vec3",label:"Position",property:[this,"position"]},{type:"checkbox",label:"Shadow Enabled",property:[this,"castShadow"]},{type:"vec2",label:"Shadow Map Size",property:[this==null?void 0:this.shadow,"mapSize"],onChange:()=>{var o,l;(o=this.shadow.map)===null||o===void 0||o.dispose(),(l=this.shadow.mapPass)===null||l===void 0||l.dispose(),this.shadow.map=null,this.shadow.mapPass=null}},{type:"slider",bounds:[-.001,.001],stepSize:2e-5,label:"Shadow Bias",property:[this==null?void 0:this.shadow,"bias"],onChange:this.setDirty},{type:"slider",bounds:[-.1,.1],stepSize:.005,label:"Shadow Normal Bias",property:[this==null?void 0:this.shadow,"normalBias"],onChange:this.setDirty},{type:"slider",bounds:[0,5],label:"Shadow radius",property:[this==null?void 0:this.shadow,"radius"],onChange:this.setDirty},{type:"slider",bounds:[.1,50],label:"Shadow frustum",getValue:()=>2*this.shadow.camera.right,setValue:o=>{this.shadow.camera.left=-o/2,this.shadow.camera.right=o/2,this.shadow.camera.top=o/2,this.shadow.camera.bottom=-o/2},onChange:this.setDirty}]}}toJSON(o){const{userData:l,children:c}=this;this.userData={},this.children=[];const u=super.toJSON(o);return u.userData=serializeObject(copyObject3DUserData({},l),!1),this.userData=l,this.children=c,u.type="DirectionalLight2",u.target=this.target.position.toArray(),Object.assign(u,serializeObject(this,!0,o))}fromJSON(o,l){if(o.type!=="DirectionalLight2")return null;const c=o.target,u=o.object;return o.target&&(this.target.position.fromArray(o.target),this.target.updateMatrixWorld(),delete o.target),o.object&&delete o.object,deserializeObject(o,this,!0,l),c&&(o.target=c),u&&(u.color!==void 0&&this.color.set(u.color),u.intensity!==void 0&&(this.intensity=u.intensity),o.object=u),this}}class SpotLight2 extends three_module.nCl{get lightObject(){return this}get modelObject(){return this}constructor(o,l,c,u,h,_){super(o,l,c,u,h,_),this.assetType="light",this.target.position.set(0,0,-1),this.add(this.target)}copy(o,l){const c=this.target,u=o.userData;return o.userData={},super.copy(o,l),copyObject3DUserData(this.userData,u),c.position.copy(this.target.position),c.updateMatrixWorld(),this.target=c,this}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Spot Light",children:[{type:"checkbox",label:"Enabled",property:[this,"visible"]},{type:"color",label:"Color",property:[this,"color"]},{type:"slider",label:"Intensity",bounds:[0,30],property:[this,"intensity"]},{type:"slider",bounds:[0,2],property:[this,"angle"]},{type:"slider",bounds:[0,.9999],property:[this,"penumbra"]},{type:"vec3",label:"Rotation",property:[this,"rotation"]},{type:"vec3",label:"Position",property:[this,"position"]},{type:"checkbox",label:"Shadow Enabled",property:[this,"castShadow"]},{type:"vec2",label:"Shadow Map Size",property:[this==null?void 0:this.shadow,"mapSize"],onChange:()=>{var o,l;(o=this.shadow.map)===null||o===void 0||o.dispose(),(l=this.shadow.mapPass)===null||l===void 0||l.dispose(),this.shadow.map=null,this.shadow.mapPass=null}},{type:"slider",bounds:[-.001,.001],stepSize:2e-5,label:"Shadow Bias",property:[this==null?void 0:this.shadow,"bias"],onChange:this.setDirty},{type:"slider",bounds:[0,5],label:"Shadow radius",property:[this==null?void 0:this.shadow,"radius"],onChange:this.setDirty}]}}toJSON(o){const{userData:l,children:c}=this;this.userData={},this.children=[];const u=super.toJSON(o);return u.userData=serializeObject(copyObject3DUserData({},l),!1),this.userData=l,this.children=c,u.type="SpotLight2",u.target=this.target.position.toArray(),Object.assign(u,serializeObject(this,!0,o))}fromJSON(o,l){return o.type!=="SpotLight2"?null:(o.target&&(this.target.position.fromArray(o.target),this.target.updateMatrixWorld()),o.object?(o.object.color!==void 0&&this.color.set(o.object.color),o.object.intensity!==void 0&&(this.intensity=o.object.intensity),o.object.distance!==void 0&&(this.distance=o.object.distance),o.object.angle!==void 0&&(this.angle=o.object.angle),o.object.decay!==void 0&&(this.decay=o.object.decay),o.object.penumbra!==void 0&&(this.penumbra=o.object.penumbra),deserializeObject(o,this,!0,l),this):this)}}class PointLight2 extends three_module.HiM{get lightObject(){return this}get modelObject(){return this}constructor(o,l,c,u){super(o,l,c,u),this.assetType="light"}copy(o,l){const c=o.userData;return o.userData={},super.copy(o,l),copyObject3DUserData(this.userData,c),this}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Point Light",children:[{type:"checkbox",label:"Enabled",property:[this,"visible"]},{type:"color",label:"Color",property:[this,"color"]},{type:"slider",label:"Intensity",bounds:[0,20],property:[this,"intensity"]},{type:"input",label:"Distance",property:[this,"distance"]},{type:"input",property:[this,"decay"]},{type:"vec3",label:"Position",property:[this,"position"]},{type:"checkbox",label:"Shadow Enabled",property:[this,"castShadow"]},{type:"vec2",label:"Shadow Map Size",property:[this==null?void 0:this.shadow,"mapSize"],onChange:()=>{var o,l;(o=this.shadow.map)===null||o===void 0||o.dispose(),(l=this.shadow.mapPass)===null||l===void 0||l.dispose(),this.shadow.map=null,this.shadow.mapPass=null}},{type:"slider",bounds:[-.001,.001],stepSize:2e-5,label:"Shadow Bias",property:[this==null?void 0:this.shadow,"bias"],onChange:this.setDirty},{type:"slider",bounds:[0,5],label:"Shadow radius",property:[this==null?void 0:this.shadow,"radius"],onChange:this.setDirty}]}}toJSON(o){const{userData:l}=this;this.userData={};const c=super.toJSON(o);return c.userData=serializeObject(copyObject3DUserData({},l),!1),this.userData=l,c.type="PointLight2",Object.assign(c,serializeObject(this,!0,o))}fromJSON(o,l){return o.type!=="PointLight2"?null:o.object?(o.object.color!==void 0&&this.color.set(o.object.color),o.object.intensity!==void 0&&(this.intensity=o.object.intensity),o.object.distance!==void 0&&(this.distance=o.object.distance),o.object.decay!==void 0&&(this.decay=o.object.decay),deserializeObject(o,this,!0,l),this):this}}class AmbientLight2 extends three_module.$p8{get lightObject(){return this}get modelObject(){return this}constructor(o,l){super(o,l),this.assetType="light"}copy(o,l){const c=o.userData;return o.userData={},super.copy(o,l),copyObject3DUserData(this.userData,c),this}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Ambient Light",children:[{type:"checkbox",label:"Enabled",property:[this,"visible"]},{type:"color",label:"Color",property:[this,"color"]},{type:"slider",label:"Intensity",bounds:[0,20],property:[this,"intensity"]}]}}toJSON(o){const{userData:l}=this;this.userData={};const c=super.toJSON(o);return c.userData=serializeObject(copyObject3DUserData({},l),!1),this.userData=l,c.type="AmbientLight2",Object.assign(c,serializeObject(this,!0,o))}fromJSON(o,l){return o.type!=="AmbientLight2"?null:o.object?(o.object.color!==void 0&&this.color.set(o.object.color),o.object.intensity!==void 0&&(this.intensity=o.object.intensity),deserializeObject(o,this,!0,l),this):this}}class LUTCubeLoader extends three_module.aHM{load(o,l,c,u){const h=new three_module.Y9S(this.manager);h.setPath(this.path),h.setResponseType("text"),h.load(o,_=>{try{l(this.parse(_))}catch(A){u?u(A):console.error(A),this.manager.itemError(o)}},c,u)}parse(o){o=o.replace(/^#.*?(\n|\r)/gm,"").replace(/^\s*?(\n|\r)/gm,"").trim();let l=null,c=null;const u=new three_module.Pq0(0,0,0),h=new three_module.Pq0(1,1,1),_=o.split(/[\n\r]+/g);let A=null,w=0;for(let O=0,ne=_.length;O<ne;O++){const ce=_[O].trim(),ue=ce.split(/\s/g);switch(ue[0]){case"TITLE":l=ce.substring(7,ce.length-1);break;case"LUT_3D_SIZE":const ye=ue[1];c=parseFloat(ye),A=new Uint8Array(c*c*c*4);break;case"DOMAIN_MIN":u.x=parseFloat(ue[1]),u.y=parseFloat(ue[2]),u.z=parseFloat(ue[3]);break;case"DOMAIN_MAX":h.x=parseFloat(ue[1]),h.y=parseFloat(ue[2]),h.z=parseFloat(ue[3]);break;default:const Oe=parseFloat(ue[0]),ke=parseFloat(ue[1]),Ve=parseFloat(ue[2]);if(Oe>1||Oe<0||ke>1||ke<0||Ve>1||Ve<0)throw new Error("LUTCubeLoader : Non normalized values not supported.");A[w+0]=255*Oe,A[w+1]=255*ke,A[w+2]=255*Ve,A[w+3]=255,w+=4}}const C=new three_module.GYF;C.image.data=A,C.image.width=c,C.image.height=c*c,C.type=three_module.OUM,C.magFilter=three_module.k6q,C.minFilter=three_module.k6q,C.wrapS=three_module.ghU,C.wrapT=three_module.ghU,C.generateMipmaps=!1,C.needsUpdate=!0;const M=new three_module.dYF;return M.image.data=A,M.image.width=c,M.image.height=c,M.image.depth=c,M.type=three_module.OUM,M.magFilter=three_module.k6q,M.minFilter=three_module.k6q,M.wrapS=three_module.ghU,M.wrapT=three_module.ghU,M.wrapR=three_module.ghU,M.generateMipmaps=!1,M.needsUpdate=!0,{title:l,size:c,domainMin:u,domainMax:h,texture:C,texture3D:M}}}var LUTCubeLoader2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let LUTCubeTextureWrapper=class{constructor({domainMax:d,domainMin:o,size:l,texture:c,texture3D:u,title:h}){this.userData={},this.type="LUTCubeTextureWrapper",this.assetType="lutTexture",this.domainMax=d,this.domainMin=o,this.size=l,this.texture=c,this.texture3D=u,this.title=h,this.uuid=three_module.cj9.generateUUID(),this.userData.__needsSourceBuffer=!0}fromJSON(d,o){return d.type!==this.type&&console.warn("WebGi LUTCubeLoader2: type mismatch while import",d,this),console.error("not supported"),this}toJSON(d){return serializeTextureInExtras(this,d,this.texture.name)}};LUTCubeTextureWrapper=LUTCubeLoader2_decorate([serializable("LUTCubeTextureWrapper")],LUTCubeTextureWrapper);class LUTCubeLoader2 extends LUTCubeLoader{parse(o){const l=super.parse(o);return new LUTCubeTextureWrapper(l)}}var ch2={},wk=function(d,o,l,c,u){var h=new Worker(ch2[o]||(ch2[o]=URL.createObjectURL(new Blob([d],{type:"text/javascript"}))));return h.onerror=function(_){return u(_.error,null)},h.onmessage=function(_){return u(null,_.data)},h.postMessage(l,c),h},u8=Uint8Array,u16=Uint16Array,u32=Uint32Array,fleb=new u8([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fdeb=new u8([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),clim=new u8([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),freb=function(d,o){for(var l=new u16(31),c=0;c<31;++c)l[c]=o+=1<<d[c-1];var u=new u32(l[30]);for(c=1;c<30;++c)for(var h=l[c];h<l[c+1];++h)u[h]=h-l[c]<<5|c;return[l,u]},_a=freb(fleb,2),fl=_a[0],revfl=_a[1];fl[28]=258,revfl[258]=28;for(var _b=freb(fdeb,0),fd=_b[0],revfd=_b[1],rev=new u16(32768),browser_i=0;browser_i<32768;++browser_i){var browser_x=(43690&browser_i)>>>1|(21845&browser_i)<<1;browser_x=(52428&browser_x)>>>2|(13107&browser_x)<<2,browser_x=(61680&browser_x)>>>4|(3855&browser_x)<<4,rev[browser_i]=((65280&browser_x)>>>8|(255&browser_x)<<8)>>>1}for(var hMap=function(o,l,c){for(var u=o.length,h=0,_=new u16(l);h<u;++h)++_[o[h]-1];var A,w=new u16(l);for(h=0;h<l;++h)w[h]=w[h-1]+_[h-1]<<1;if(c){A=new u16(1<<l);var C=15-l;for(h=0;h<u;++h)if(o[h])for(var M=h<<4|o[h],O=l-o[h],ne=w[o[h]-1]++<<O,ce=ne|(1<<O)-1;ne<=ce;++ne)A[rev[ne]>>>C]=M}else for(A=new u16(u),h=0;h<u;++h)o[h]&&(A[h]=rev[w[o[h]-1]++]>>>15-o[h]);return A},flt=new u8(288),browser_i=0;browser_i<144;++browser_i)flt[browser_i]=8;for(var browser_i=144;browser_i<256;++browser_i)flt[browser_i]=9;for(var browser_i=256;browser_i<280;++browser_i)flt[browser_i]=7;for(var browser_i=280;browser_i<288;++browser_i)flt[browser_i]=8;for(var fdt=new u8(32),browser_i=0;browser_i<32;++browser_i)fdt[browser_i]=5;var flm=hMap(flt,9,0),flrm=hMap(flt,9,1),fdm=hMap(fdt,5,0),fdrm=hMap(fdt,5,1),max=function(d){for(var o=d[0],l=1;l<d.length;++l)d[l]>o&&(o=d[l]);return o},bits=function(d,o,l){var c=o/8|0;return(d[c]|d[c+1]<<8)>>(7&o)&l},bits16=function(d,o){var l=o/8|0;return(d[l]|d[l+1]<<8|d[l+2]<<16)>>(7&o)},shft=function(d){return(d/8|0)+(7&d&&1)},slc=function(d,o,l){(o==null||o<0)&&(o=0),(l==null||l>d.length)&&(l=d.length);var c=new(d instanceof u16?u16:d instanceof u32?u32:u8)(l-o);return c.set(d.subarray(o,l)),c},inflt=function(d,o,l){var c=d.length;if(!c||l&&!l.l&&c<5)return o||new u8(0);var u=!o||l,h=!l||l.i;l||(l={}),o||(o=new u8(3*c));var _=function(Ht){var qt=o.length;if(Ht>qt){var Li=new u8(Math.max(2*qt,Ht));Li.set(o),o=Li}},A=l.f||0,w=l.p||0,C=l.b||0,M=l.l,O=l.d,ne=l.m,ce=l.n,ue=8*c;do{if(!M){l.f=A=bits(d,w,1);var ye=bits(d,w+1,3);if(w+=3,!ye){var Oe=d[(Tt=shft(w)+4)-4]|d[Tt-3]<<8,ke=Tt+Oe;if(ke>c){if(h)throw"unexpected EOF";break}u&&_(C+Oe),o.set(d.subarray(Tt,ke),C),l.b=C+=Oe,l.p=w=8*ke;continue}if(ye==1)M=flrm,O=fdrm,ne=9,ce=5;else{if(ye!=2)throw"invalid block type";var Ve=bits(d,w,31)+257,tt=bits(d,w+10,15)+4,ht=Ve+bits(d,w+5,31)+1;w+=14;for(var ut=new u8(ht),_t=new u8(19),at=0;at<tt;++at)_t[clim[at]]=bits(d,w+3*at,7);w+=3*tt;var lt=max(_t),pt=(1<<lt)-1,xt=hMap(_t,lt,1);for(at=0;at<ht;){var Tt,Pt=xt[bits(d,w,pt)];if(w+=15&Pt,(Tt=Pt>>>4)<16)ut[at++]=Tt;else{var Lt=0,Bt=0;for(Tt==16?(Bt=3+bits(d,w,3),w+=2,Lt=ut[at-1]):Tt==17?(Bt=3+bits(d,w,7),w+=3):Tt==18&&(Bt=11+bits(d,w,127),w+=7);Bt--;)ut[at++]=Lt}}var Ut=ut.subarray(0,Ve),kt=ut.subarray(Ve);ne=max(Ut),ce=max(kt),M=hMap(Ut,ne,1),O=hMap(kt,ce,1)}if(w>ue){if(h)throw"unexpected EOF";break}}u&&_(C+131072);for(var Vt=(1<<ne)-1,si=(1<<ce)-1,Jt=w;;Jt=w){var Wt=(Lt=M[bits16(d,w)&Vt])>>>4;if((w+=15&Lt)>ue){if(h)throw"unexpected EOF";break}if(!Lt)throw"invalid length/literal";if(Wt<256)o[C++]=Wt;else{if(Wt==256){Jt=w,M=null;break}var Zt=Wt-254;if(Wt>264){var ti=fleb[at=Wt-257];Zt=bits(d,w,(1<<ti)-1)+fl[at],w+=ti}var ci=O[bits16(d,w)&si],ri=ci>>>4;if(!ci)throw"invalid distance";if(w+=15&ci,kt=fd[ri],ri>3&&(ti=fdeb[ri],kt+=bits16(d,w)&(1<<ti)-1,w+=ti),w>ue){if(h)throw"unexpected EOF";break}u&&_(C+131072);for(var Ct=C+Zt;C<Ct;C+=4)o[C]=o[C-kt],o[C+1]=o[C+1-kt],o[C+2]=o[C+2-kt],o[C+3]=o[C+3-kt];C=Ct}}l.l=M,l.p=Jt,l.b=C,M&&(A=1,l.m=ne,l.d=O,l.n=ce)}while(!A);return C==o.length?o:slc(o,0,C)},wbits=function(d,o,l){l<<=7&o;var c=o/8|0;d[c]|=l,d[c+1]|=l>>>8},wbits16=function(d,o,l){l<<=7&o;var c=o/8|0;d[c]|=l,d[c+1]|=l>>>8,d[c+2]|=l>>>16},hTree=function(d,o){for(var l=[],c=0;c<d.length;++c)d[c]&&l.push({s:c,f:d[c]});var u=l.length,h=l.slice();if(!u)return[browser_et,0];if(u==1){var _=new u8(l[0].s+1);return _[l[0].s]=1,[_,1]}l.sort(function(ut,_t){return ut.f-_t.f}),l.push({s:-1,f:25001});var A=l[0],w=l[1],C=0,M=1,O=2;for(l[0]={s:-1,f:A.f+w.f,l:A,r:w};M!=u-1;)A=l[l[C].f<l[O].f?C++:O++],w=l[C!=M&&l[C].f<l[O].f?C++:O++],l[M++]={s:-1,f:A.f+w.f,l:A,r:w};var ne=h[0].s;for(c=1;c<u;++c)h[c].s>ne&&(ne=h[c].s);var ce=new u16(ne+1),ue=ln(l[M-1],ce,0);if(ue>o){c=0;var ye=0,Oe=ue-o,ke=1<<Oe;for(h.sort(function(ut,_t){return ce[_t.s]-ce[ut.s]||ut.f-_t.f});c<u;++c){var Ve=h[c].s;if(!(ce[Ve]>o))break;ye+=ke-(1<<ue-ce[Ve]),ce[Ve]=o}for(ye>>>=Oe;ye>0;){var tt=h[c].s;ce[tt]<o?ye-=1<<o-ce[tt]++-1:++c}for(;c>=0&&ye;--c){var ht=h[c].s;ce[ht]==o&&(--ce[ht],++ye)}ue=o}return[new u8(ce),ue]},ln=function(d,o,l){return d.s==-1?Math.max(ln(d.l,o,l+1),ln(d.r,o,l+1)):o[d.s]=l},lc=function(d){for(var o=d.length;o&&!d[--o];);for(var l=new u16(++o),c=0,u=d[0],h=1,_=function(w){l[c++]=w},A=1;A<=o;++A)if(d[A]==u&&A!=o)++h;else{if(!u&&h>2){for(;h>138;h-=138)_(32754);h>2&&(_(h>10?h-11<<5|28690:h-3<<5|12305),h=0)}else if(h>3){for(_(u),--h;h>6;h-=6)_(8304);h>2&&(_(h-3<<5|8208),h=0)}for(;h--;)_(u);h=1,u=d[A]}return[l.subarray(0,c),o]},clen=function(d,o){for(var l=0,c=0;c<o.length;++c)l+=d[c]*o[c];return l},wfblk=function(d,o,l){var c=l.length,u=shft(o+2);d[u]=255&c,d[u+1]=c>>>8,d[u+2]=255^d[u],d[u+3]=255^d[u+1];for(var h=0;h<c;++h)d[u+h+4]=l[h];return 8*(u+4+c)},wblk=function(d,o,l,c,u,h,_,A,w,C,M){wbits(o,M++,l),++u[256];for(var O=hTree(u,15),ne=O[0],ce=O[1],ue=hTree(h,15),ye=ue[0],Oe=ue[1],ke=lc(ne),Ve=ke[0],tt=ke[1],ht=lc(ye),ut=ht[0],_t=ht[1],at=new u16(19),lt=0;lt<Ve.length;++lt)at[31&Ve[lt]]++;for(lt=0;lt<ut.length;++lt)at[31&ut[lt]]++;for(var pt=hTree(at,7),xt=pt[0],Tt=pt[1],Pt=19;Pt>4&&!xt[clim[Pt-1]];--Pt);var Lt,Bt,Ut,kt,Vt=C+5<<3,si=clen(u,flt)+clen(h,fdt)+_,Jt=clen(u,ne)+clen(h,ye)+_+14+3*Pt+clen(at,xt)+(2*at[16]+3*at[17]+7*at[18]);if(Vt<=si&&Vt<=Jt)return wfblk(o,M,d.subarray(w,w+C));if(wbits(o,M,1+(Jt<si)),M+=2,Jt<si){Lt=hMap(ne,ce,0),Bt=ne,Ut=hMap(ye,Oe,0),kt=ye;var Wt=hMap(xt,Tt,0);for(wbits(o,M,tt-257),wbits(o,M+5,_t-1),wbits(o,M+10,Pt-4),M+=14,lt=0;lt<Pt;++lt)wbits(o,M+3*lt,xt[clim[lt]]);M+=3*Pt;for(var Zt=[Ve,ut],ti=0;ti<2;++ti){var ci=Zt[ti];for(lt=0;lt<ci.length;++lt){var ri=31&ci[lt];wbits(o,M,Wt[ri]),M+=xt[ri],ri>15&&(wbits(o,M,ci[lt]>>>5&127),M+=ci[lt]>>>12)}}}else Lt=flm,Bt=flt,Ut=fdm,kt=fdt;for(lt=0;lt<A;++lt)if(c[lt]>255){ri=c[lt]>>>18&31,wbits16(o,M,Lt[ri+257]),M+=Bt[ri+257],ri>7&&(wbits(o,M,c[lt]>>>23&31),M+=fleb[ri]);var Ct=31&c[lt];wbits16(o,M,Ut[Ct]),M+=kt[Ct],Ct>3&&(wbits16(o,M,c[lt]>>>5&8191),M+=fdeb[Ct])}else wbits16(o,M,Lt[c[lt]]),M+=Bt[c[lt]];return wbits16(o,M,Lt[256]),M+Bt[256]},deo=new u32([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),browser_et=new u8(0),dflt=function(d,o,l,c,u,h){var _=d.length,A=new u8(c+_+5*(1+Math.ceil(_/7e3))+u),w=A.subarray(c,A.length-u),C=0;if(!o||_<8)for(var M=0;M<=_;M+=65535){var O=M+65535;O<_?C=wfblk(w,C,d.subarray(M,O)):(w[M]=h,C=wfblk(w,C,d.subarray(M,_)))}else{for(var ne=deo[o-1],ce=ne>>>13,ue=8191&ne,ye=(1<<l)-1,Oe=new u16(32768),ke=new u16(ye+1),Ve=Math.ceil(l/3),tt=2*Ve,ht=function(Ln){return(d[Ln]^d[Ln+1]<<Ve^d[Ln+2]<<tt)&ye},ut=new u32(25e3),_t=new u16(288),at=new u16(32),lt=0,pt=0,xt=(M=0,0),Tt=0,Pt=0;M<_;++M){var Lt=ht(M),Bt=32767&M,Ut=ke[Lt];if(Oe[Bt]=Ut,ke[Lt]=Bt,Tt<=M){var kt=_-M;if((lt>7e3||xt>24576)&&kt>423){C=wblk(d,w,0,ut,_t,at,pt,xt,Pt,M-Pt,C),xt=lt=pt=0,Pt=M;for(var Vt=0;Vt<286;++Vt)_t[Vt]=0;for(Vt=0;Vt<30;++Vt)at[Vt]=0}var si=2,Jt=0,Wt=ue,Zt=Bt-Ut&32767;if(kt>2&&Lt==ht(M-Zt))for(var ti=Math.min(ce,kt)-1,ci=Math.min(32767,M),ri=Math.min(258,kt);Zt<=ci&&--Wt&&Bt!=Ut;){if(d[M+si]==d[M+si-Zt]){for(var Ct=0;Ct<ri&&d[M+Ct]==d[M+Ct-Zt];++Ct);if(Ct>si){if(si=Ct,Jt=Zt,Ct>ti)break;var Ht=Math.min(Zt,Ct-2),qt=0;for(Vt=0;Vt<Ht;++Vt){var Li=M-Zt+Vt+32768&32767,Ui=Li-Oe[Li]+32768&32767;Ui>qt&&(qt=Ui,Ut=Li)}}}Zt+=(Bt=Ut)-(Ut=Oe[Bt])+32768&32767}if(Jt){ut[xt++]=268435456|revfl[si]<<18|revfd[Jt];var Xi=31&revfl[si],An=31&revfd[Jt];pt+=fleb[Xi]+fdeb[An],++_t[257+Xi],++at[An],Tt=M+si,++lt}else ut[xt++]=d[M],++_t[d[M]]}}C=wblk(d,w,h,ut,_t,at,pt,xt,Pt,M-Pt,C),!h&&7&C&&(C=wfblk(w,C+1,browser_et))}return slc(A,0,c+shft(C)+u)},crct=function(){for(var d=new Int32Array(256),o=0;o<256;++o){for(var l=o,c=9;--c;)l=(1&l&&-306674912)^l>>>1;d[o]=l}return d}(),crc=function(){var d=-1;return{p:function(o){for(var l=d,c=0;c<o.length;++c)l=crct[255&l^o[c]]^l>>>8;d=l},d:function(){return~d}}},adler=function(){var d=1,o=0;return{p:function(l){for(var c=d,u=o,h=l.length,_=0;_!=h;){for(var A=Math.min(_+2655,h);_<A;++_)u+=c+=l[_];c=(65535&c)+15*(c>>16),u=(65535&u)+15*(u>>16)}d=c,o=u},d:function(){return(255&(d%=65521))<<24|d>>>8<<16|(255&(o%=65521))<<8|o>>>8}}},dopt=function(d,o,l,c,u){return dflt(d,o.level==null?6:o.level,o.mem==null?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(d.length)))):12+o.mem,l,c,!u)},mrg=function(d,o){var l={};for(var c in d)l[c]=d[c];for(var c in o)l[c]=o[c];return l},wcln=function(d,o,l){for(var c=d(),u=d.toString(),h=u.slice(u.indexOf("[")+1,u.lastIndexOf("]")).replace(/ /g,"").split(","),_=0;_<c.length;++_){var A=c[_],w=h[_];if(typeof A=="function"){o+=";"+w+"=";var C=A.toString();if(A.prototype)if(C.indexOf("[native code]")!=-1){var M=C.indexOf(" ",8)+1;o+=C.slice(M,C.indexOf("(",M))}else for(var O in o+=C,A.prototype)o+=";"+w+".prototype."+O+"="+A.prototype[O].toString();else o+=C}else l[w]=A}return[o,l]},ch=[],cbfs=function(d){var o=[];for(var l in d)(d[l]instanceof u8||d[l]instanceof u16||d[l]instanceof u32)&&o.push((d[l]=new d[l].constructor(d[l])).buffer);return o},wrkr=function(d,o,l,c){var u;if(!ch[l]){for(var h="",_={},A=d.length-1,w=0;w<A;++w)h=(u=wcln(d[w],h,_))[0],_=u[1];ch[l]=wcln(d[A],h,_)}var C=mrg({},ch[l][1]);return wk(ch[l][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+o.toString()+"}",l,C,cbfs(C),c)},bInflt=function(){return[u8,u16,u32,fleb,fdeb,clim,fl,fd,flrm,fdrm,rev,hMap,max,bits,bits16,shft,slc,inflt,inflateSync,pbf,gu8]},bDflt=function(){return[u8,u16,u32,fleb,fdeb,clim,revfl,revfd,flm,flt,fdm,fdt,rev,deo,browser_et,hMap,wbits,wbits16,hTree,ln,lc,clen,wfblk,wblk,shft,slc,dflt,dopt,deflateSync,pbf]},gze=function(){return[gzh,gzhl,wbytes,crc,crct]},guze=function(){return[gzs,gzl]},zle=function(){return[zlh,wbytes,adler]},zule=function(){return[zlv]},pbf=function(d){return postMessage(d,[d.buffer])},gu8=function(d){return d&&d.size&&new u8(d.size)},cbify=function(d,o,l,c,u,h){var _=wrkr(l,c,u,function(A,w){_.terminate(),h(A,w)});return _.postMessage([d,o],o.consume?[d.buffer]:[]),function(){_.terminate()}},astrm=function(d){return d.ondata=function(o,l){return postMessage([o,l],[o.buffer])},function(o){return d.push(o.data[0],o.data[1])}},astrmify=function(d,o,l,c,u){var h,_=wrkr(d,c,u,function(A,w){A?(_.terminate(),o.ondata.call(o,A)):(w[1]&&_.terminate(),o.ondata.call(o,A,w[0],w[1]))});_.postMessage(l),o.push=function(A,w){if(h)throw"stream finished";if(!o.ondata)throw"no stream handler";_.postMessage([A,h=w],[A.buffer])},o.terminate=function(){_.terminate()}},b2=function(d,o){return d[o]|d[o+1]<<8},b4=function(d,o){return(d[o]|d[o+1]<<8|d[o+2]<<16|d[o+3]<<24)>>>0},b8=function(d,o){return b4(d,o)+4294967296*b4(d,o+4)},wbytes=function(d,o,l){for(;l;++o)d[o]=l,l>>>=8},gzh=function(d,o){var l=o.filename;if(d[0]=31,d[1]=139,d[2]=8,d[8]=o.level<2?4:o.level==9?2:0,d[9]=3,o.mtime!=0&&wbytes(d,4,Math.floor(new Date(o.mtime||Date.now())/1e3)),l){d[3]=8;for(var c=0;c<=l.length;++c)d[c+10]=l.charCodeAt(c)}},gzs=function(d){if(d[0]!=31||d[1]!=139||d[2]!=8)throw"invalid gzip data";var o=d[3],l=10;4&o&&(l+=d[10]|2+(d[11]<<8));for(var c=(o>>3&1)+(o>>4&1);c>0;c-=!d[l++]);return l+(2&o)},gzl=function(d){var o=d.length;return(d[o-4]|d[o-3]<<8|d[o-2]<<16|d[o-1]<<24)>>>0},gzhl=function(d){return 10+(d.filename&&d.filename.length+1||0)},zlh=function(d,o){var l=o.level,c=l==0?0:l<6?1:l==9?3:2;d[0]=120,d[1]=c<<6|(c?32-2*c:1)},zlv=function(d){if((15&d[0])!=8||d[0]>>>4>7||(d[0]<<8|d[1])%31)throw"invalid zlib data";if(32&d[1])throw"invalid zlib data: preset dictionaries not supported"};function AsyncCmpStrm(d,o){return o||typeof d!="function"||(o=d,d={}),this.ondata=o,d}var Deflate=function(){function d(o,l){l||typeof o!="function"||(l=o,o={}),this.ondata=l,this.o=o||{}}return d.prototype.p=function(o,l){this.ondata(dopt(o,this.o,0,0,!l),l)},d.prototype.push=function(o,l){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";this.d=l,this.p(o,l||!1)},d}(),AsyncDeflate=function(){return function(d,o){astrmify([bDflt,function(){return[astrm,Deflate]}],this,AsyncCmpStrm.call(this,d,o),function(l){var c=new Deflate(l.data);onmessage=astrm(c)},6)}}();function deflate(d,o,l){if(l||(l=o,o={}),typeof l!="function")throw"no callback";return cbify(d,o,[bDflt],function(c){return pbf(deflateSync(c.data[0],c.data[1]))},0,l)}function deflateSync(d,o){return dopt(d,o||{},0,0)}var Inflate=function(){function d(o){this.s={},this.p=new u8(0),this.ondata=o}return d.prototype.e=function(o){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";var l=this.p.length,c=new u8(l+o.length);c.set(this.p),c.set(o,l),this.p=c},d.prototype.c=function(o){this.d=this.s.i=o||!1;var l=this.s.b,c=inflt(this.p,this.o,this.s);this.ondata(slc(c,l,this.s.b),this.d),this.o=slc(c,this.s.b-32768),this.s.b=this.o.length,this.p=slc(this.p,this.s.p/8|0),this.s.p&=7},d.prototype.push=function(o,l){this.e(o),this.c(l)},d}(),AsyncInflate=function(){return function(d){this.ondata=d,astrmify([bInflt,function(){return[astrm,Inflate]}],this,0,function(){var o=new Inflate;onmessage=astrm(o)},7)}}();function inflate(d,o,l){if(l||(l=o,o={}),typeof l!="function")throw"no callback";return cbify(d,o,[bInflt],function(c){return pbf(inflateSync(c.data[0],gu8(c.data[1])))},1,l)}function inflateSync(d,o){return inflt(d,o)}var Gzip=function(){function d(o,l){this.c=crc(),this.l=0,this.v=1,Deflate.call(this,o,l)}return d.prototype.push=function(o,l){Deflate.prototype.push.call(this,o,l)},d.prototype.p=function(o,l){this.c.p(o),this.l+=o.length;var c=dopt(o,this.o,this.v&&gzhl(this.o),l&&8,!l);this.v&&(gzh(c,this.o),this.v=0),l&&(wbytes(c,c.length-8,this.c.d()),wbytes(c,c.length-4,this.l)),this.ondata(c,l)},d}(),AsyncGzip=function(){return function(d,o){astrmify([bDflt,gze,function(){return[astrm,Deflate,Gzip]}],this,AsyncCmpStrm.call(this,d,o),function(l){var c=new Gzip(l.data);onmessage=astrm(c)},8)}}();function gzip(d,o,l){if(l||(l=o,o={}),typeof l!="function")throw"no callback";return cbify(d,o,[bDflt,gze,function(){return[gzipSync]}],function(c){return pbf(gzipSync(c.data[0],c.data[1]))},2,l)}function gzipSync(d,o){o||(o={});var l=crc(),c=d.length;l.p(d);var u=dopt(d,o,gzhl(o),8),h=u.length;return gzh(u,o),wbytes(u,h-8,l.d()),wbytes(u,h-4,c),u}var Gunzip=function(){function d(o){this.v=1,Inflate.call(this,o)}return d.prototype.push=function(o,l){if(Inflate.prototype.e.call(this,o),this.v){var c=this.p.length>3?gzs(this.p):4;if(c>=this.p.length&&!l)return;this.p=this.p.subarray(c),this.v=0}if(l){if(this.p.length<8)throw"invalid gzip stream";this.p=this.p.subarray(0,-8)}Inflate.prototype.c.call(this,l)},d}(),AsyncGunzip=function(){return function(d){this.ondata=d,astrmify([bInflt,guze,function(){return[astrm,Inflate,Gunzip]}],this,0,function(){var o=new Gunzip;onmessage=astrm(o)},9)}}();function gunzip(d,o,l){if(l||(l=o,o={}),typeof l!="function")throw"no callback";return cbify(d,o,[bInflt,guze,function(){return[gunzipSync]}],function(c){return pbf(gunzipSync(c.data[0]))},3,l)}function gunzipSync(d,o){return inflt(d.subarray(gzs(d),-8),o||new u8(gzl(d)))}var Zlib=function(){function d(o,l){this.c=adler(),this.v=1,Deflate.call(this,o,l)}return d.prototype.push=function(o,l){Deflate.prototype.push.call(this,o,l)},d.prototype.p=function(o,l){this.c.p(o);var c=dopt(o,this.o,this.v&&2,l&&4,!l);this.v&&(zlh(c,this.o),this.v=0),l&&wbytes(c,c.length-4,this.c.d()),this.ondata(c,l)},d}(),AsyncZlib=function(){return function(d,o){astrmify([bDflt,zle,function(){return[astrm,Deflate,Zlib]}],this,AsyncCmpStrm.call(this,d,o),function(l){var c=new Zlib(l.data);onmessage=astrm(c)},10)}}();function zlib(d,o,l){if(l||(l=o,o={}),typeof l!="function")throw"no callback";return cbify(d,o,[bDflt,zle,function(){return[zlibSync]}],function(c){return pbf(zlibSync(c.data[0],c.data[1]))},4,l)}function zlibSync(d,o){o||(o={});var l=adler();l.p(d);var c=dopt(d,o,2,4);return zlh(c,o),wbytes(c,c.length-4,l.d()),c}var Unzlib=function(){function d(o){this.v=1,Inflate.call(this,o)}return d.prototype.push=function(o,l){if(Inflate.prototype.e.call(this,o),this.v){if(this.p.length<2&&!l)return;this.p=this.p.subarray(2),this.v=0}if(l){if(this.p.length<4)throw"invalid zlib stream";this.p=this.p.subarray(0,-4)}Inflate.prototype.c.call(this,l)},d}(),AsyncUnzlib=function(){return function(d){this.ondata=d,astrmify([bInflt,zule,function(){return[astrm,Inflate,Unzlib]}],this,0,function(){var o=new Unzlib;onmessage=astrm(o)},11)}}();function unzlib(d,o,l){if(l||(l=o,o={}),typeof l!="function")throw"no callback";return cbify(d,o,[bInflt,zule,function(){return[unzlibSync]}],function(c){return pbf(unzlibSync(c.data[0],gu8(c.data[1])))},5,l)}function unzlibSync(d,o){return inflt((zlv(d),d.subarray(2,-4)),o)}var Decompress=function(){function d(o){this.G=Gunzip,this.I=Inflate,this.Z=Unzlib,this.ondata=o}return d.prototype.push=function(o,l){if(!this.ondata)throw"no stream handler";if(this.s)this.s.push(o,l);else{if(this.p&&this.p.length){var c=new u8(this.p.length+o.length);c.set(this.p),c.set(o,this.p.length)}else this.p=o;if(this.p.length>2){var u=this,h=function(){u.ondata.apply(u,arguments)};this.s=this.p[0]==31&&this.p[1]==139&&this.p[2]==8?new this.G(h):(15&this.p[0])!=8||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(h):new this.Z(h),this.s.push(this.p,l),this.p=null}}},d}(),AsyncDecompress=function(){function d(o){this.G=AsyncGunzip,this.I=AsyncInflate,this.Z=AsyncUnzlib,this.ondata=o}return d.prototype.push=function(o,l){Decompress.prototype.push.call(this,o,l)},d}();function decompress(d,o,l){if(l||(l=o,o={}),typeof l!="function")throw"no callback";return d[0]==31&&d[1]==139&&d[2]==8?gunzip(d,o,l):(15&d[0])!=8||d[0]>>4>7||(d[0]<<8|d[1])%31?inflate(d,o,l):unzlib(d,o,l)}function decompressSync(d,o){return d[0]==31&&d[1]==139&&d[2]==8?gunzipSync(d,o):(15&d[0])!=8||d[0]>>4>7||(d[0]<<8|d[1])%31?inflateSync(d,o):unzlibSync(d,o)}var fltn=function(d,o,l,c){for(var u in d){var h=d[u],_=o+u;h instanceof u8?l[_]=[h,c]:Array.isArray(h)?l[_]=[h[0],mrg(c,h[1])]:fltn(h,_+"/",l,c)}},browser_te=typeof TextEncoder<"u"&&new TextEncoder,td=typeof TextDecoder<"u"&&new TextDecoder,tds=0;try{td.decode(browser_et,{stream:!0}),tds=1}catch(d){}var dutf8=function(d){for(var o="",l=0;;){var c=d[l++],u=(c>127)+(c>223)+(c>239);if(l+u>d.length)return[o,slc(d,l-1)];u?u==3?(c=((15&c)<<18|(63&d[l++])<<12|(63&d[l++])<<6|63&d[l++])-65536,o+=String.fromCharCode(55296|c>>10,56320|1023&c)):o+=1&u?String.fromCharCode((31&c)<<6|63&d[l++]):String.fromCharCode((15&c)<<12|(63&d[l++])<<6|63&d[l++]):o+=String.fromCharCode(c)}},DecodeUTF8=function(){function d(o){this.ondata=o,tds?this.t=new TextDecoder:this.p=browser_et}return d.prototype.push=function(o,l){if(!this.ondata)throw"no callback";if(l=!!l,this.t){if(this.ondata(this.t.decode(o,{stream:!0}),l),l){if(this.t.decode().length)throw"invalid utf-8 data";this.t=null}}else{if(!this.p)throw"stream finished";var c=new u8(this.p.length+o.length);c.set(this.p),c.set(o,this.p.length);var u=dutf8(c),h=u[0],_=u[1];if(l){if(_.length)throw"invalid utf-8 data";this.p=null}else this.p=_;this.ondata(h,l)}},d}(),EncodeUTF8=function(){function d(o){this.ondata=o}return d.prototype.push=function(o,l){if(!this.ondata)throw"no callback";if(this.d)throw"stream finished";this.ondata(strToU8(o),this.d=l||!1)},d}();function strToU8(d,o){if(o){for(var l=new u8(d.length),c=0;c<d.length;++c)l[c]=d.charCodeAt(c);return l}if(browser_te)return browser_te.encode(d);var u=d.length,h=new u8(d.length+(d.length>>1)),_=0,A=function(M){h[_++]=M};for(c=0;c<u;++c){if(_+5>h.length){var w=new u8(_+8+(u-c<<1));w.set(h),h=w}var C=d.charCodeAt(c);C<128||o?A(C):C<2048?(A(192|C>>6),A(128|63&C)):C>55295&&C<57344?(A(240|(C=65536+(1047552&C)|1023&d.charCodeAt(++c))>>18),A(128|C>>12&63),A(128|C>>6&63),A(128|63&C)):(A(224|C>>12),A(128|C>>6&63),A(128|63&C))}return slc(h,0,_)}function strFromU8(d,o){if(o){for(var l="",c=0;c<d.length;c+=16384)l+=String.fromCharCode.apply(null,d.subarray(c,c+16384));return l}if(td)return td.decode(d);var u=dutf8(d),h=u[0];if(u[1].length)throw"invalid utf-8 data";return h}var dbf=function(d){return d==1?3:d<6?2:d==9?1:0},slzh=function(d,o){return o+30+b2(d,o+26)+b2(d,o+28)},zh=function(d,o,l){var c=b2(d,o+28),u=strFromU8(d.subarray(o+46,o+46+c),!(2048&b2(d,o+8))),h=o+46+c,_=b4(d,o+20),A=l&&_==4294967295?z64e(d,h):[_,b4(d,o+24),b4(d,o+42)],w=A[0],C=A[1],M=A[2];return[b2(d,o+10),w,C,u,h+b2(d,o+30)+b2(d,o+32),M]},z64e=function(d,o){for(;b2(d,o)!=1;o+=4+b2(d,o+2));return[b8(d,o+12),b8(d,o+4),b8(d,o+20)]},exfl=function(d){var o=0;if(d)for(var l in d){var c=d[l].length;if(c>65535)throw"extra field too long";o+=c+4}return o},wzh=function(d,o,l,c,u,h,_,A){var w=c.length,C=l.extra,M=A&&A.length,O=exfl(C);wbytes(d,o,_!=null?33639248:67324752),o+=4,_!=null&&(d[o++]=20,d[o++]=l.os),d[o]=20,o+=2,d[o++]=l.flag<<1|(h==null&&8),d[o++]=u&&8,d[o++]=255&l.compression,d[o++]=l.compression>>8;var ne=new Date(l.mtime==null?Date.now():l.mtime),ce=ne.getFullYear()-1980;if(ce<0||ce>119)throw"date not in range 1980-2099";if(wbytes(d,o,ce<<25|ne.getMonth()+1<<21|ne.getDate()<<16|ne.getHours()<<11|ne.getMinutes()<<5|ne.getSeconds()>>>1),o+=4,h!=null&&(wbytes(d,o,l.crc),wbytes(d,o+4,h),wbytes(d,o+8,l.size)),wbytes(d,o+12,w),wbytes(d,o+14,O),o+=16,_!=null&&(wbytes(d,o,M),wbytes(d,o+6,l.attrs),wbytes(d,o+10,_),o+=14),d.set(c,o),o+=w,O)for(var ue in C){var ye=C[ue],Oe=ye.length;wbytes(d,o,+ue),wbytes(d,o+2,Oe),d.set(ye,o+4),o+=4+Oe}return M&&(d.set(A,o),o+=M),o},wzf=function(d,o,l,c,u){wbytes(d,o,101010256),wbytes(d,o+8,l),wbytes(d,o+10,l),wbytes(d,o+12,c),wbytes(d,o+16,u)},ZipPassThrough=function(){function d(o){this.filename=o,this.c=crc(),this.size=0,this.compression=0}return d.prototype.process=function(o,l){this.ondata(null,o,l)},d.prototype.push=function(o,l){if(!this.ondata)throw"no callback - add to ZIP archive before pushing";this.c.p(o),this.size+=o.length,l&&(this.crc=this.c.d()),this.process(o,l||!1)},d}(),ZipDeflate=function(){function d(o,l){var c=this;l||(l={}),ZipPassThrough.call(this,o),this.d=new Deflate(l,function(u,h){c.ondata(null,u,h)}),this.compression=8,this.flag=dbf(l.level)}return d.prototype.process=function(o,l){try{this.d.push(o,l)}catch(c){this.ondata(c,null,l)}},d.prototype.push=function(o,l){ZipPassThrough.prototype.push.call(this,o,l)},d}(),AsyncZipDeflate=function(){function d(o,l){var c=this;l||(l={}),ZipPassThrough.call(this,o),this.d=new AsyncDeflate(l,function(u,h,_){c.ondata(u,h,_)}),this.compression=8,this.flag=dbf(l.level),this.terminate=this.d.terminate}return d.prototype.process=function(o,l){this.d.push(o,l)},d.prototype.push=function(o,l){ZipPassThrough.prototype.push.call(this,o,l)},d}(),Zip=function(){function d(o){this.ondata=o,this.u=[],this.d=1}return d.prototype.add=function(o){var l=this;if(2&this.d)throw"stream finished";var c=strToU8(o.filename),u=c.length,h=o.comment,_=h&&strToU8(h),A=u!=o.filename.length||_&&h.length!=_.length,w=u+exfl(o.extra)+30;if(u>65535)throw"filename too long";var C=new u8(w);wzh(C,0,o,c,A);var M=[C],O=function(){for(var Oe=0,ke=M;Oe<ke.length;Oe++){var Ve=ke[Oe];l.ondata(null,Ve,!1)}M=[]},ne=this.d;this.d=0;var ce=this.u.length,ue=mrg(o,{f:c,u:A,o:_,t:function(){o.terminate&&o.terminate()},r:function(){if(O(),ne){var Oe=l.u[ce+1];Oe?Oe.r():l.d=1}ne=1}}),ye=0;o.ondata=function(Oe,ke,Ve){if(Oe)l.ondata(Oe,ke,Ve),l.terminate();else if(ye+=ke.length,M.push(ke),Ve){var tt=new u8(16);wbytes(tt,0,134695760),wbytes(tt,4,o.crc),wbytes(tt,8,ye),wbytes(tt,12,o.size),M.push(tt),ue.c=ye,ue.b=w+ye+16,ue.crc=o.crc,ue.size=o.size,ne&&ue.r(),ne=1}else ne&&O()},this.u.push(ue)},d.prototype.end=function(){var o=this;if(2&this.d)throw 1&this.d?"stream finishing":"stream finished";this.d?this.e():this.u.push({r:function(){1&o.d&&(o.u.splice(-1,1),o.e())},t:function(){}}),this.d=3},d.prototype.e=function(){for(var o=0,l=0,c=0,u=0,h=this.u;u<h.length;u++)c+=46+(C=h[u]).f.length+exfl(C.extra)+(C.o?C.o.length:0);for(var _=new u8(c+22),A=0,w=this.u;A<w.length;A++){var C=w[A];wzh(_,o,C,C.f,C.u,C.c,l,C.o),o+=46+C.f.length+exfl(C.extra)+(C.o?C.o.length:0),l+=C.b}wzf(_,o,this.u.length,c,l),this.ondata(null,_,!0),this.d=2},d.prototype.terminate=function(){for(var o=0,l=this.u;o<l.length;o++)l[o].t();this.d=2},d}();function zip(d,o,l){if(l||(l=o,o={}),typeof l!="function")throw"no callback";var c={};fltn(d,"",c,o);var u=Object.keys(c),h=u.length,_=0,A=0,w=h,C=new Array(h),M=[],O=function(){for(var ye=0;ye<M.length;++ye)M[ye]()},ne=function(){var ye=new u8(A+22),Oe=_,ke=A-_;A=0;for(var Ve=0;Ve<w;++Ve){var tt=C[Ve];try{var ht=tt.c.length;wzh(ye,A,tt,tt.f,tt.u,ht);var ut=30+tt.f.length+exfl(tt.extra),_t=A+ut;ye.set(tt.c,_t),wzh(ye,_,tt,tt.f,tt.u,ht,A,tt.m),_+=16+ut+(tt.m?tt.m.length:0),A=_t+ht}catch(at){return l(at,null)}}wzf(ye,_,C.length,ke,Oe),l(null,ye)};h||ne();for(var ce=function(ye){var Oe=u[ye],ke=c[Oe],Ve=ke[0],tt=ke[1],ht=crc(),ut=Ve.length;ht.p(Ve);var _t=strToU8(Oe),at=_t.length,lt=tt.comment,pt=lt&&strToU8(lt),xt=pt&&pt.length,Tt=exfl(tt.extra),Pt=tt.level==0?0:8,Lt=function(Bt,Ut){if(Bt)O(),l(Bt,null);else{var kt=Ut.length;C[ye]=mrg(tt,{size:ut,crc:ht.d(),c:Ut,f:_t,m:pt,u:at!=Oe.length||pt&&lt.length!=xt,compression:Pt}),_+=30+at+Tt+kt,A+=76+2*(at+Tt)+(xt||0)+kt,--h||ne()}};if(at>65535&&Lt("filename too long",null),Pt)if(ut<16e4)try{Lt(null,deflateSync(Ve,tt))}catch(Bt){Lt(Bt,null)}else M.push(deflate(Ve,tt,Lt));else Lt(null,Ve)},ue=0;ue<w;++ue)ce(ue);return O}function zipSync(d,o){o||(o={});var l={},c=[];fltn(d,"",l,o);var u=0,h=0;for(var _ in l){var A=l[_],w=A[0],C=A[1],M=C.level==0?0:8,O=(at=strToU8(_)).length,ne=C.comment,ce=ne&&strToU8(ne),ue=ce&&ce.length,ye=exfl(C.extra);if(O>65535)throw"filename too long";var Oe=M?deflateSync(w,C):w,ke=Oe.length,Ve=crc();Ve.p(w),c.push(mrg(C,{size:w.length,crc:Ve.d(),c:Oe,f:at,m:ce,u:O!=_.length||ce&&ne.length!=ue,o:u,compression:M})),u+=30+O+ye+ke,h+=76+2*(O+ye)+(ue||0)+ke}for(var tt=new u8(h+22),ht=u,ut=h-u,_t=0;_t<c.length;++_t){var at=c[_t];wzh(tt,at.o,at,at.f,at.u,at.c.length);var lt=30+at.f.length+exfl(at.extra);tt.set(at.c,at.o+lt),wzh(tt,u,at,at.f,at.u,at.c.length,at.o,at.m),u+=16+lt+(at.m?at.m.length:0)}return wzf(tt,u,c.length,ut,ht),tt}var UnzipPassThrough=function(){function d(){}return d.prototype.push=function(o,l){this.ondata(null,o,l)},d.compression=0,d}(),UnzipInflate=function(){function d(){var o=this;this.i=new Inflate(function(l,c){o.ondata(null,l,c)})}return d.prototype.push=function(o,l){try{this.i.push(o,l)}catch(c){this.ondata(c,o,l)}},d.compression=8,d}(),AsyncUnzipInflate=function(){function d(o,l){var c=this;l<32e4?this.i=new Inflate(function(u,h){c.ondata(null,u,h)}):(this.i=new AsyncInflate(function(u,h,_){c.ondata(u,h,_)}),this.terminate=this.i.terminate)}return d.prototype.push=function(o,l){this.i.terminate&&(o=slc(o,0)),this.i.push(o,l)},d.compression=8,d}(),Unzip=function(){function d(o){this.onfile=o,this.k=[],this.o={0:UnzipPassThrough},this.p=browser_et}return d.prototype.push=function(o,l){var c=this;if(!this.onfile)throw"no callback";if(!this.p)throw"stream finished";if(this.c>0){var u=Math.min(this.c,o.length),h=o.subarray(0,u);if(this.c-=u,this.d?this.d.push(h,!this.c):this.k[0].push(h),(o=o.subarray(u)).length)return this.push(o,l)}else{var _=0,A=0,w=void 0,C=void 0;this.p.length?o.length?((C=new u8(this.p.length+o.length)).set(this.p),C.set(o,this.p.length)):C=this.p:C=o;for(var M=C.length,O=this.c,ne=O&&this.d,ce=function(){var Oe,ke=b4(C,A);if(ke==67324752){_=1,w=A,ue.d=null,ue.c=0;var Ve=b2(C,A+6),tt=b2(C,A+8),ht=2048&Ve,ut=8&Ve,_t=b2(C,A+26),at=b2(C,A+28);if(M>A+30+_t+at){var lt=[];ue.k.unshift(lt),_=2;var pt,xt=b4(C,A+18),Tt=b4(C,A+22),Pt=strFromU8(C.subarray(A+30,A+=30+_t),!ht);xt==4294967295?(Oe=ut?[-2]:z64e(C,A),xt=Oe[0],Tt=Oe[1]):ut&&(xt=-1),A+=at,ue.c=xt;var Lt={name:Pt,compression:tt,start:function(){if(!Lt.ondata)throw"no callback";if(xt){var Bt=c.o[tt];if(!Bt)throw"unknown compression type "+tt;(pt=xt<0?new Bt(Pt):new Bt(Pt,xt,Tt)).ondata=function(si,Jt,Wt){Lt.ondata(si,Jt,Wt)};for(var Ut=0,kt=lt;Ut<kt.length;Ut++){var Vt=kt[Ut];pt.push(Vt,!1)}c.k[0]==lt&&c.c?c.d=pt:pt.push(browser_et,!0)}else Lt.ondata(null,browser_et,!0)},terminate:function(){pt&&pt.terminate&&pt.terminate()}};xt>=0&&(Lt.size=xt,Lt.originalSize=Tt),ue.onfile(Lt)}return"break"}if(O){if(ke==134695760)return w=A+=12+(O==-2&&8),_=3,ue.c=0,"break";if(ke==33639248)return w=A-=4,_=3,ue.c=0,"break"}},ue=this;A<M-4&&ce()!=="break";++A);if(this.p=browser_et,O<0){var ye=_?C.subarray(0,w-12-(O==-2&&8)-(b4(C,w-16)==134695760&&4)):C.subarray(0,A);ne?ne.push(ye,!!_):this.k[+(_==2)].push(ye)}if(2&_)return this.push(C.subarray(A),l);this.p=C.subarray(A)}if(l){if(this.c)throw"invalid zip file";this.p=null}},d.prototype.register=function(o){this.o[o.compression]=o},d}();function unzip(d,o){if(typeof o!="function")throw"no callback";for(var l=[],c=function(){for(var ne=0;ne<l.length;++ne)l[ne]()},u={},h=d.length-22;b4(d,h)!=101010256;--h)if(!h||d.length-h>65558)return void o("invalid zip file",null);var _=b2(d,h+8);_||o(null,{});var A=_,w=b4(d,h+16),C=w==4294967295;if(C){if(h=b4(d,h-12),b4(d,h)!=101075792)return void o("invalid zip file",null);A=_=b4(d,h+32),w=b4(d,h+48)}for(var M=function(ne){var ce=zh(d,w,C),ue=ce[0],ye=ce[1],Oe=ce[2],ke=ce[3],Ve=ce[4],tt=ce[5],ht=slzh(d,tt);w=Ve;var ut=function(at,lt){at?(c(),o(at,null)):(u[ke]=lt,--_||o(null,u))};if(ue)if(ue==8){var _t=d.subarray(ht,ht+ye);if(ye<32e4)try{ut(null,inflateSync(_t,new u8(Oe)))}catch(at){ut(at,null)}else l.push(inflate(_t,{size:Oe},ut))}else ut("unknown compression type "+ue,null);else ut(null,slc(d,ht,ht+ye))},O=0;O<A;++O)M();return c}function unzipSync(d){for(var o={},l=d.length-22;b4(d,l)!=101010256;--l)if(!l||d.length-l>65558)throw"invalid zip file";var c=b2(d,l+8);if(!c)return{};var u=b4(d,l+16),h=u==4294967295;if(h){if(l=b4(d,l-12),b4(d,l)!=101075792)throw"invalid zip file";c=b4(d,l+32),u=b4(d,l+48)}for(var _=0;_<c;++_){var A=zh(d,u,h),w=A[0],C=A[1],M=A[2],O=A[3],ne=A[4],ce=A[5],ue=slzh(d,ce);if(u=ne,w){if(w!=8)throw"unknown compression type "+w;o[O]=inflateSync(d.subarray(ue,ue+C),new u8(M))}else o[O]=slc(d,ue,ue+C)}return o}class ZipLoader extends three_module.Y9S{load(o,l,c,u){return this.setResponseType("arraybuffer"),super.load(o,h=>{const _=unzipSync(new Uint8Array(h)),A=new Map(Object.entries(_).map(([w,C])=>[w,new File([C],w)]));l==null||l(A)},c,u)}}class SVGTextureLoader extends three_module.aHM{constructor(o){super(o)}load(o,l,c,u){const h=SVGTextureLoader.USE_CANVAS_TEXTURE?document.createElement("canvas"):void 0,_=SVGTextureLoader.USE_CANVAS_TEXTURE?new three_module.GOR(h):new three_module.gPd,A=new three_module.$NF(this.manager);return A.setCrossOrigin(this.crossOrigin),A.setPath(this.path),A.load(o,function(w){h?SVGTextureLoader.CopyImageToCanvas(h,w):_.image=w,_.needsUpdate=!0,l!==void 0&&l(_)},c,u),_}static CopyImageToCanvas(o,l){o.width=l.naturalWidth||l.width||512,o.height=l.naturalHeight||l.height||512;const c=o.getContext("2d");c?(c.clearRect(0,0,o.width,o.height),c.drawImage(l,0,0,o.width,o.height)):console.error("SVGTextureLoader: Failed to get canvas context.")}}SVGTextureLoader.USE_CANVAS_TEXTURE=rt("svg-load-disable-canvas")!=="true";class AssetImporter extends I{get cachedAssets(){return this._cachedAssets}get processors(){return this._processors}get loadingManager(){return this._loadingManager}constructor(o,l=!1){super(),this._processors=new ObjectProcessorMap,this._logger=console.log,this.Importers=[new Importer(SimpleJSONLoader,["json"],!1),new Importer(three_module.Y9S,["txt"],!1),new Importer(RGBEPNGLoader,["rgbe.png","hdr.png","hdrpng"],!1),new Importer(SVGTextureLoader,["svg","data:image/svg"],!1),new Importer(three_module.Tap,["webp","png","jpeg","jpg","data:image"],!1),new Importer(LUTCubeLoader2,["cube"],!1),new Importer(ZipLoader,["zip"],!0)],this._loaderCache=[],this._fileDatabase=new Map,this._cachedAssets=[],l||(this._logger=()=>{}),this._viewer=o,this._onLoad=this._onLoad.bind(this),this._onProgress=this._onProgress.bind(this),this._onError=this._onError.bind(this),this._onStart=this._onStart.bind(this),this._urlModifier=this._urlModifier.bind(this),this._loadingManager=new three_module.KPJ(this._onLoad,this._onProgress,this._onError),this._loadingManager.onStart=this._onStart,this._loadingManager.setURLModifier(this._urlModifier),this.Importers.push(addRGBELoader(o)),this.Importers.push(addGLTFLoader(o)),this.Importers.push(addDracoLoader())}_onLoad(){this.dispatchEvent({type:"onLoad"})}_onProgress(o,l,c){this.dispatchEvent({type:"onProgress",url:o,loaded:l,total:c})}_onError(o){this.dispatchEvent({type:"onError",url:o})}_onStart(o,l,c){this.dispatchEvent({type:"onStart",url:o,loaded:l,total:c})}_urlModifier(o){var l;let c=decodeURI(o);const u=(l=this._rootContext)===null||l===void 0?void 0:l.rootUrl;c.includes("://")||!u||c.startsWith(u)||(c=u+c),c=c.replace("./",""),c=c.replace(/^(\/\/)/,"/"),c=c.replace(/\?.*$/,"");const h=this._fileDatabase.get(c);return h?h.ext?(h.objectUrl||(h.objectUrl=URL.createObjectURL(h)+"#"+c),h.objectUrl):(console.error("Unable to determine file extension",h),o):o}_createLoader(o){const l=this._getImporter(o),c=l==null?void 0:l.ctor(this);return c&&(l==null||l.ext.forEach(u=>{const h=new RegExp(u.startsWith("data:")?"^"+u+"\\/":"\\."+u+"$","i");this._loadingManager.addHandler(h,c)})),c&&(this._loaderCache.push({loader:c,files:[]}),this.dispatchEvent({type:"loaderCreate",loader:c})),c}addEventListener(o,l){if(super.addEventListener(o,l),o==="loaderCreate")for(const c of this._loaderCache)this.dispatchEvent({type:"loaderCreate",loader:c.loader})}async importFiles(o,l={}){const c=new Map;let{allowedExtensions:u}=l;if(u&&u.length<1&&(u=void 0),o.size===0)return c;this.dispatchEvent({type:"importFiles",files:Object.keys(o),state:"start"});const h=[],_=[];if(o.forEach((A,w)=>{var C;this.registerFile(w,A);const M=A.ext;M&&((C=u==null?void 0:u.includes(M.toLowerCase()))===null||C===void 0||C)&&(this._isRootFileExtension(M)?h.push(w):_.push(w))}),h.length>0)for(const A of h){let w=await this._importFile(A,void 0,l);w&&(w=await this.processImported(w,l)),c.set(A,w)}else for(const A of _){let w=await this._importFile(A,void 0,l);w&&(w=await this.processImported(w,l)),c.set(A,w)}return this.dispatchEvent({type:"importFiles",files:Object.keys(o),state:"end"}),o.forEach((A,w)=>{this.unregisterFile(w)}),c}registerFile(o,l){var c,u,h;o=o.replace(/\?.*$/,"");const _=(c=l==null?void 0:l.ext)!==null&&c!==void 0?c:(h=ae((u=l==null?void 0:l.name)!==null&&u!==void 0?u:o.trim()))===null||h===void 0?void 0:h.toLowerCase();l&&(l.ext||(l.ext=_),this._fileDatabase.set(o,l));let A=this._getLoader(o);if(A||(A=this._createLoader(l??{name:o,ext:_})),A){for(const w of this._loaderCache)if(w.loader===A){w.files.push(o);break}}return A}unregisterFile(o){o=o.replace(/\?.*$/,"");const l=this._fileDatabase.get(o);l!=null&&l.objectUrl&&(URL.revokeObjectURL(l.objectUrl),l.objectUrl=void 0),l&&this._fileDatabase.delete(o)}_isRootFileExtension(o){return this.Importers.find(l=>l.root&&l.ext.includes(o.toLowerCase()))!=null}resolveURL(o){return this._loadingManager.resolveURL(o)}async _importFile(o,l,c={},u){var h,_;if(l!=null&&l.__imported)return l.__imported;let A;this.dispatchEvent({type:"importFile",path:o,state:"downloading",progress:0});try{this.registerFile(o,l);const w=this.resolveURL(o),C=o.replace(/\?.*$/,"").trim(),M=(h=c.fileHandler)!==null&&h!==void 0?h:await this._loadingManager.getHandler(C)||(l?await this._loadingManager.getHandler(l.name||l.ext||""):void 0);if(!M)throw new Error("AssetImporter: Unable to find loader for "+o);this._rootContext={path:o,url:w,rootUrl:three_module.r6x.extractUrlBase(o),baseUrl:three_module.r6x.extractUrlBase(w)},A=await M.loadAsync(o+(c.queryString?(o.includes("?")?"&":"?")+c.queryString:""),O=>{u&&u(O),this.dispatchEvent({type:"importFile",path:o,state:"downloading",loadedBytes:O.loaded||void 0,totalBytes:O.total||void 0,progress:O.total>0?O.loaded/O.total:1})}),M.transform&&(A=await M.transform(A,c)),this._rootContext=void 0,this.dispatchEvent({type:"importFile",path:o,state:"downloading",progress:1}),this.dispatchEvent({type:"importFile",path:o,state:"adding"}),l?this._logger("AssetImporter: loaded",o):this._logger("AssetImporter: downloaded",o),l&&this.unregisterFile(o)}catch(w){return console.error("AssetImporter: Unable to import file",o,l),console.error(w),console.error(w==null?void 0:w.stack),this.dispatchEvent({type:"importFile",path:o,state:"error",error:w}),l&&this.unregisterFile(o),[]}if(this.dispatchEvent({type:"importFile",path:o,state:"done"}),l&&A){l.__imported=A;let w=[];Array.isArray(A)?w=A:!((_=A.userData)===null||_===void 0)&&_.rootSceneModelRoot?w.push(...A.children):w.push(A),w.forEach(C=>{C.addEventListener&&C.addEventListener("dispose",()=>{l.__imported=void 0})})}if(A&&typeof A=="object"){A.__rootPath=o;const w=l||this._fileDatabase.get(o);w&&(A.__rootBlob=w)}return A}_getImporter(o,l=!1){return this.Importers.find(c=>{if(l&&!c.root)return!1;const u=c.ext.find(h=>{var _,A,w;return o.ext&&h===o.ext.toLowerCase()||((A=(_=o.name)===null||_===void 0?void 0:_.toLowerCase())===null||A===void 0?void 0:A.endsWith("."+h.toLowerCase()))||(h==null?void 0:h.startsWith("data:"))&&((w=o.name)===null||w===void 0?void 0:w.startsWith(h))});return!!u&&(o.ext=u,!0)})}_getLoader(o){var l;return(l=this._loadingManager.getHandler(o.trim()))!==null&&l!==void 0?l:void 0}async importAsset(o,l={},c){var u,h,_;if(!o)return[];if(!this._cachedAssets.includes(o)){if(Object.entries(o).length===1&&o.path){const M=this._cachedAssets.find(O=>O.path===o.path);M&&Object.assign(o,M)}const C=this._cachedAssets.findIndex(M=>M.path===o.path);C>=0&&this._cachedAssets.splice(C,1),this._cachedAssets.push(o)}let A;if(o!=null&&o.preImported&&(A=await o.preImported),!l.forceImport&&A){const C=await this.processImported(A,l);let M=!1;for(const O of C){if(!((u=O.userData)===null||u===void 0)&&u.rootSceneModelRoot&&[...O.children,...O.__processedChildren||[]].find(ne=>ne.__disposed)){M=!0;break}if(O.__disposed){M=!0;break}}if(!M||l.reimportDisposed===!1)return C}const w=l.pathOverride||o.path;if(o.preImported=this._importFile(w,typeof((h=o.file)===null||h===void 0?void 0:h.arrayBuffer)=="function"?o.file:void 0,l,c),A=await o.preImported,A&&(this.dispatchEvent({type:"processFileStart",path:w,result:A}),A=await this.processImported(A,l),this.dispatchEvent({type:"processFileEnd",path:w,result:A})),A){const C=[];Array.isArray(A)?C.push(...A):!((_=A.userData)===null||_===void 0)&&_.rootSceneModelRoot?C.push(...A.children):C.push(A),C.forEach(M=>{var O;return(O=M.addEventListener)===null||O===void 0?void 0:O.call(M,"dispose",()=>{o!=null&&o.preImported&&(o.preImported=void 0)})})}return A}async importSingle(o,l={}){var c;return typeof o=="string"?await this.importSinglePath(o,l):(c=await this.importAsset(o,l))===null||c===void 0?void 0:c[0]}async importSinglePath(o,l){var c;return(c=await this.importPath(o,l))===null||c===void 0?void 0:c[0]}async importPath(o,l={}){const c={...l};delete c.pathOverride,delete c.forceImport,delete c.reimportDisposed,delete c.fileHandler,delete c.importedFile;const u=JSON.stringify(c),h=this._cachedAssets.find(A=>A.path===o&&A._options===u);let _;return _=h||{path:o},_._options=u,l.importedFile&&(_.file=l.importedFile),await this.importAsset(_,l)}async processImportedSingle(o,l={}){return(await this.processImported(o,l))[0]}async processImported(o,l={}){var c,u,h,_,A,w,C,M;let O=o;if(!O)return[];if(l.processImported===!1)return[O];if(Array.isArray(O)){const ue=[];for(const ye of O)ue.push(...await this.processImported(ye,l));return ue}if(!((c=O.userData)===null||c===void 0)&&c.rootSceneModelRoot){if(l._rootSceneImported=!0,O.__processedChildren&&!l.forceImporterReprocess)return O.__processedChildren;if(!(O.children.length<1))return O.animations&&(O.children[0].animations||(O.children[0].animations=[]),O.children[0].animations.push(...O.animations)),O.__importedViewerConfig&&(O.children[0].__importedViewerConfig=O.__importedViewerConfig),O.userData.__importData&&(O.children[0].userData.__importData=O.userData.__importData),O.__processedChildren=await this.processImported([...O.children],l),O.__processedChildren;if(((u=O.animations)===null||u===void 0?void 0:u.length)>0&&console.error("AssetImporter: animations in empty scene not supported yet. animations will be ignored",O.animations),!O.__importedViewerConfig)return[];O=O.__importedViewerConfig}if(!((h=O.userData)===null||h===void 0)&&h.iModel&&(O=O.userData.iModel),!((_=O.userData)===null||_===void 0)&&_.iMaterial&&(O=O.userData.iMaterial),O.assetImporterProcessed&&!l.forceImporterReprocess)return[O];const ne=O.__rootPath,ce=O.__rootBlob;if(!O.assetType){if(O.isBufferGeometry&&(O=new three_module.eaF(O,new three_module._4j)),O.isObject3D)if(O.isLight)O=upgradeThreejsLight(O);else{const ue=[];O.traverse(ye=>{ye!==O&&ye.isLight&&ue.push(ye)});for(const ye of ue)upgradeThreejsLight(ye);O=new Object3DModel(O,l)}O.isTexture&&(O.assetType="texture",l._testDataTextureComplete&&(O.isDataTexture&&(!((A=O.image)===null||A===void 0)&&A.data)&&(O.image.complete=!0),!((w=O.image)===null||w===void 0)&&w.complete&&(O.needsUpdate=!0)),l.generateMipmaps!==void 0&&(O.generateMipmaps=l.generateMipmaps),O.generateMipmaps||O.isRenderTargetTexture||(O.minFilter=O.minFilter===three_module.$_I?three_module.k6q:O.minFilter,O.magFilter=O.magFilter===three_module.$_I?three_module.k6q:O.magFilter)),O.isMaterial&&(O.assetType="material")}if(O.assetType!=null)return O.userData&&(O.userData.rootPath||!ne||ne.startsWith("blob:")||ne.startsWith("/")||(O.userData.rootPath=ne),ce&&(O.userData.__sourceBlob=ce,O.userData.__needsSourceBuffer&&(O.userData.__sourceBuffer=await ce.arrayBuffer(),delete O.userData.__needsSourceBuffer))),O=await this._processors.process(O.assetType,O,{}),O.assetImporterProcessed=!0,[O];if(O instanceof Map)return[...(await this.importFiles(O,l)).values()].flat();if(O.type&&O.type!=="ViewerApp"&&O.type!=="ThreeViewer"){const ue=this._viewer.getPluginByType(O.type);if(ue){let ye=O._importedResources||{};return O.resources&&(ye=await((C=this._viewer.getManager())===null||C===void 0?void 0:C.importConfigResources(O.resources)),delete O.resources,O._importedResources=ye),typeof ue.fromJSON=="function"&&(await Promise.resolve(ue.fromJSON(O,ye)),O.assetImporterProcessed=!1),[]}}return O.plugins||O.type==="ViewerApp"||O.type==="ThreeViewer"?(O.resources=await((M=this._viewer.getManager())===null||M===void 0?void 0:M.importConfigResources(O.resources)),await this._viewer.getManager().importViewerConfig(O),O.assetImporterProcessed=!1,[]):(console.warn("WebGi AssetImporter: unknown/null asset type: ",O,O.plugins),[O])}dispose(){var o;this.clearCache(),(o=this._processors)===null||o===void 0||o.dispose()}clearLoaderCache(){this._loaderCache.forEach(o=>{o.loader.dispose&&o.loader.dispose()}),this._loaderCache=[]}clearCache(){this.clearLoaderCache(),this._cachedAssets=[]}}function getTextureDataType(d){if(!d)return three_module.OUM;const o=d.extensions.has("EXT_color_buffer_half_float")||d.capabilities.isWebGL2&&d.extensions.has("EXT_color_buffer_float"),l=d.capabilities.isWebGL2||d.extensions.has("OES_texture_float")||d.extensions.has("WEBGL_color_buffer_float");return o?three_module.ix0:l?three_module.RQf:three_module.OUM}function upgradeThreejsLight(d){var o,l;if(!d.isLight||d.assetType==="light")return d;if(d.uiConfig)return console.warn("ui config already exists, not supported",d),d;let c;if(d.children.length,d.isDirectionalLight&&(c=new DirectionalLight2),d.isAmbientLight&&(c=new AmbientLight2),d.isSpotLight&&(c=new SpotLight2),d.isPointLight&&(c=new PointLight2),c){(l=(o=c.lightObject).copy)===null||l===void 0||l.call(o,d);const u=d.parent;u!=null&&u.isObject3D&&(u.remove(d),d.dispose(),d.userData.iModel=c,u.add(c.lightObject),c.uuid=d.uuid),setupIModel(c.lightObject,u)}else console.warn("unknown light type: ",d);return c}AssetImporter.WHITE_IMAGE_DATA=new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1);class ThreeMaterialLoader extends three_module.jut{constructor(o){super(o)}async loadAsync(o,l){var c,u;const h=new three_module.Y9S(this.manager);h.setPath(this.path),h.setRequestHeader(this.requestHeader),h.setWithCredentials(this.withCredentials);const _=await h.loadAsync(o,l);try{const A=JSON.parse(_);if(this.importer){const w={};let C=(c=A.images)!==null&&c!==void 0?c:[];Array.isArray(C)||(C=Object.values(C));for(const M of C){if(!M.url||!M.uuid)continue;const O=(u=await this.importer.importPath(M.url,{processImported:!1}))===null||u===void 0?void 0:u[0],ne=O==null?void 0:O.source;if(!O||!ne)continue;const ce=new three_module.kLi(ne.data);ce.uuid=M.uuid,w[ce.uuid]=ce,O.dispose()}return await ObjectLoader2.LoadRootPathTextures(A.textures,w,this.importer),this.parse(A,w)}return this.parse(A)}catch(A){throw console.error(A),this.manager.itemError(o),A}}parse(o,l){var c,u;let h;const _={p:new Promise(M=>{h=M})};if(o.images||o.textures){const M=new ObjectLoader2(this.manager);let O={};const ne=Oe=>{h(),_.p=void 0,Object.values(O).forEach(ke=>{var Ve;ke.isTexture&&(!((Ve=ke.image)===null||Ve===void 0)&&Ve.complete)&&(ke.needsUpdate=!0)})};let ce=o.images||[];Array.isArray(ce)||(ce=Object.values(ce));const ue=l||M.parseImages(ce,ne);let ye=o.textures;Array.isArray(ye)||(ye=Object.values(ye)),O=M.parseTextures2(ye,ue,ne),this.setTextures(O)}this.materials||console.warn("A Material Manager is not set to import three materials, trying standard materials");const A={...o};if(Object.entries(A).forEach(([M,O])=>{O&&typeof O=="string"&&this.textures[O]&&(A[M]=this.textures[O])}),o.vertexColors!==void 0&&(typeof o.vertexColors=="number"?A.vertexColors=o.vertexColors>0:A.vertexColors=o.vertexColors),o.normalScale!==void 0){const M=o.normalScale;Array.isArray(M)===!1&&(A.normalScale=[M,M])}let w=o.type;w!=="MeshPhysicalMaterial"&&w!=="MeshStandardMaterial"&&w!=="PhysicalMaterial"||(w=MeshStandardMaterial2.TYPE),A.userData=deserializeObject(A.userData,void 0,!1,this);const C=(u=(c=this.materials)===null||c===void 0?void 0:c.generateFromTemplateType(w,A))!==null&&u!==void 0?u:super.parse(o);return this.setTextures({}),C.userData.imageLoadAwaiter=_,C}}class AssetManagerPlugin extends I{constructor(o,l,{simpleCache:c=!1,storage:u}={}){if(super(),this._sceneUpdated=this._sceneUpdated.bind(this),this.addAsset=this.addAsset.bind(this),this.addProcessedAssets=this.addProcessedAssets.bind(this),this.addImported=this.addImported.bind(this),(c||u)&&(c&&(three_module.l2R.enabled=!0),u&&window.Cache&&typeof window.Cache=="function"&&u instanceof window.Cache)){const h={...three_module.l2R};three_module.l2R.get=(_,A,w)=>A?_.startsWith("data:")||_.startsWith("blob")||_.startsWith("chrome-extension")?Promise.resolve(void 0):u.match(_).then(C=>{if(C)switch(A){case"arraybuffer":return C.arrayBuffer();case"blob":return C.blob();case"document":return C.text().then(M=>new DOMParser().parseFromString(M,w??"text/html"));case"json":return C.json();default:if(w===void 0)return C.text();{const M=/charset="?([^;"\s]*)"?/i.exec(w),O=M&&M[1]?M[1].toLowerCase():void 0,ne=new TextDecoder(O);return C.arrayBuffer().then(ce=>ne.decode(ce))}}}):h.get(_),three_module.l2R.add=async(_,A,w)=>{if(!w)return h.add(_,A);_.startsWith("data:")||_.startsWith("blob")||_.startsWith("chrome-extension")||(await u.match(_)&&await u.delete(_),await u.put(_,new Response(A,{status:200})))},three_module.l2R.remove=(_,A)=>{if(!A)return h.remove(_);u.delete(_)}}this.storage=u,this._importer=o,this._materials=l}async addAsset(o,l={}){if(!this._importer||!this._viewer)return[];const c=await this._importer.importAsset(o,l);return c?(this.addProcessedAssets(c,l),c):(console.warn("WebGi AssetManager: Unable to import",o,c),[])}async addFromPath(o,l={}){if(!this._importer||!this._viewer)return[];const c=await this._importer.importPath(o,l);return c?(this.addProcessedAssets(c,l),c):(o&&!o.split("?")[0].endsWith(".vjson")&&console.warn("WebGi AssetManager: Unable to import",o,c),[])}addProcessedAssets(o,l){return o.map(c=>{var u;return(u=this._viewer)===null||u===void 0?void 0:u.scene.addSceneObject(c,{...l,allImported:o})})}async addAssetSingle(o,l={}){var c;return o?(c=await(typeof o=="string"?this.addFromPath:this.addAsset).call(this,o,l))===null||c===void 0?void 0:c[0]:void 0}async addImported(o,l={}){var c;return(c=this._importer)===null||c===void 0?void 0:c.processImported(o,l).then(u=>(this.addProcessedAssets(u,l),u))}async addImportedSingle(o,l={}){return this.addImported(o,l).then(c=>c==null?void 0:c[0])}_sceneUpdated(o){var l;if(o.type==="addSceneObject"){const c=o.object;c.assetType==="material"&&((l=this._materials)===null||l===void 0||l.processMaterial(c,{}))}else console.error("Unexpected")}onAdded(o){this._viewer=o,this._materials||(this._materials=new MaterialManager,this._viewer.scene.addEventListener("addSceneObject",this._sceneUpdated)),this._importer||(this._importer=new AssetImporter(o,!!o.getPluginByType("debug")),this._importer.processors.add("model",{forAssetType:"model",process:(c,u)=>(setupObject3dModel(c,h=>{var _;return(_=this._materials)===null||_===void 0?void 0:_.processModel(h,{recursive:!1})}),c)}),this._importer.processors.add("model",{forAssetType:"model",process:this._materials.processModel}),this._importer.processors.add("material",{forAssetType:"material",process:(c,u)=>{var h;return!((h=this.materials)===null||h===void 0)&&h.findMaterial(c.uuid)&&(console.warn("WebGi AssetManager: Material with same UUID already exists, creating new UUID"),c.uuid=three_module.cj9.generateUUID(),c.userData.uuid&&(c.userData.uuid=c.uuid)),this._materials.processMaterial(c,u)}})),this._importer.Importers.push(new Importer(ThreeMaterialLoader,[MeshStandardMaterial2.TypeSlug],!1,c=>(c&&(c.materials=this._materials),c&&(c.importer=this._importer),c)));const l=this.importViewerConfig.bind(this);this._importer.Importers.push(new Importer(class extends SimpleJSONLoader{async loadAsync(c,u){return l(await super.loadAsync(c,u))}},[AssetManagerPlugin.ViewerTypeSlug],!0))}onRemove(o){var l,c;o===this._viewer&&((l=this._importer)===null||l===void 0||l.dispose(),this._importer=void 0,this._viewer.scene.removeEventListener("addSceneObject",this._sceneUpdated),(c=this._materials)===null||c===void 0||c.dispose(),this._materials=void 0)}get importer(){return this._importer}get exporter(){var o,l;return(l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("AssetExporterPlugin"))===null||l===void 0?void 0:l.exporter}get materials(){return this._materials}exportViewerConfig(o=!0,l){if(!this._viewer)return{};const c={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},extras:{},...l},u=this._viewer.toJSON(c);return o||Object.values(c).forEach(h=>{h&&Object.values(h).forEach(_=>{_.url&&(_.url.data instanceof ArrayBuffer||Array.isArray(_.url.data))&&(_.url.type==="Uint16Array"?(_.url.data instanceof Uint16Array||(_.url.data=new Uint16Array(_.url.data)),_.url.data="data:application/octet-stream;base64,"+ie(_.url.data.buffer)):_.url.type==="Uint8Array"?(_.url.data instanceof Uint8Array||(_.url.data=new Uint8Array(_.url.data)),_.url.data="data:application/octet-stream;base64,"+ie(_.url.data.buffer)):_.url.data instanceof ArrayBuffer?_.url.data="data:application/octet-stream;base64,"+ie(_.url.data.buffer):console.warn("Unsupported buffer type",_.url.type))})}),u.resources=c,u}exportPluginPresets(o){var l;const c={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},extras:{}};return{plugins:(l=this._viewer)===null||l===void 0?void 0:l.serializePlugins(c,o),resources:c}}exportPluginPreset(o){if(!o.toJSON)return;const l={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},extras:{}},c=o.toJSON(l);return c.resources=l,c}async importPluginPreset(o,l){var c;const u=o.type;if(!(l=l||((c=this._viewer)===null||c===void 0?void 0:c.getPluginByType(u))))return void console.warn(`WebGi: No plugin found for type ${u} to import preset`);if(!l.fromJSON)return void console.warn(`WebGi: Plugin ${u} does not support importing presets`);const h=o.resources||{};o.resources&&delete o.resources;const _=await this.importConfigResources(h);return await l.fromJSON(o,_),_&&(o.resources=_),l}async importViewerConfig(o,l){if(!this._viewer||!this._importer)return void console.warn("WebGi: No viewer or importer");const c=await this.importConfigResources(o.resources||{},l);this.applyViewerConfig(o,c)}applyViewerConfig(o,l){var c;if(this._viewer&&this._importer)if((l=l||o.resources).__isLoadedResources){this._viewer.fromJSON(o,l);for(const u of Object.values(l.materials))u.__useCount?delete u.__useCount:(c=this._materials)===null||c===void 0||c.unregisterMaterial(u);for(const u of Object.values(l.textures))u.__useCount&&delete u.__useCount}else console.error("Cannot load viewer config: resources not loaded",o);else console.warn("WebGi: No viewer or importer")}async importConfigResources(o,l,c){var u,h,_;if(!this._importer)throw"Importer not initialized yet.";if(o.__isLoadedResources)return o;const A={};Object.values(o).forEach(C=>{C&&Object.values(C).forEach(M=>{if(!M||!M.url||typeof M.url.data!="string")return;const O=M.url.data.match(/^data:.*;base64,(.*)$/);O!=null&&O[1]?M.url.data=re(O==null?void 0:O[1]):(M.url.type!=="Uint8Array"&&console.error("Unsupported buffer type string for ",M.url.type,"use base64"),M.url.data=new TextEncoder().encode(M.url.data).buffer)})}),l=l??new ObjectLoader2(this._importer.loadingManager),A.animations=o.animations?l.parseAnimations(o.animations):{},c&&c.animations&&(A.animations={...A.animations,...c.animations}),A.shapes=o.shapes?l.parseShapes(o.shapes):{},c&&c.shapes&&(A.shapes={...A.shapes,...c.shapes}),A.geometries=o.geometries?l.parseGeometries(o.geometries,A.shapes):{},c&&c.geometries&&(A.geometries={...A.geometries,...c.geometries}),A.images=o.images?await l.parseImagesAsync(Object.values(o.images)):{},c&&c.images&&(A.images={...A.images,...c.images}),await ObjectLoader2.LoadRootPathTextures(o.textures,A.images,this._importer),A.textures=o.textures?l.parseTextures2(Object.values(o.textures),A.images,()=>{Object.values(A.textures).forEach(C=>{var M;C.isTexture&&(!((M=C.image)===null||M===void 0)&&M.complete)&&(C.needsUpdate=!0)})}):{};for(const C of Object.entries(A.textures))C[1]=(u=await this._importer.processImported(C[1],{}))===null||u===void 0?void 0:u[0],C[1]?A.textures[C[0]]=C[1]:delete A.textures[C[0]];c&&c.textures&&(A.textures={...A.textures,...c.textures});const w=o.materials?Object.values(o.materials):[];for(const C of w)Object.entries(C).forEach(([M,O])=>{O&&O.resource&&O.uuid&&O.resource==="textures"&&(C[M]=O.uuid)});if(A.materials=l.parseMaterials2(w,A.textures,this._materials),c&&c.materials&&(A.materials={...A.materials,...c.materials}),o.object&&(A.object=l.parseObject(o.object,A.geometries,A.materials,A.textures,A.animations),o.skeletons&&(A.skeletons=l.parseSkeletons(o.skeletons,A.object),l.bindSkeletons(A.object,A.skeletons))),o.extras){A.extras=o.extras;for(const C of Object.values(o.extras))if(C.uuid&&C.url)if(typeof C.url=="string"){const M=await((h=this._importer)===null||h===void 0?void 0:h.importPath(C.url));(M==null?void 0:M.length)>0&&(A.extras[C.uuid]=M[0])}else if(C.url.data){const M=new File([se(C.url.type,C.url.data)],C.url.path),O=await((_=this._importer)===null||_===void 0?void 0:_.importAsset({path:M.name,file:M}));(O==null?void 0:O.length)>0&&(A.extras[C.uuid]=O[0])}else console.warn("WebGi: invalid URL type while loading extra resource")}return c&&c.extras&&(A.extras={...A.extras,...c.extras}),A.__isLoadedResources=!0,A}}AssetManagerPlugin.PluginType="AssetManager",AssetManagerPlugin.ViewerTypeSlug="vjson";const VIEWER_VERSION="0.11.0";class Dropzone{get inputEl(){return this._inputEl}get el(){return this._el}constructor(o,l,c){this._el=o,this._inputEl=l,this._listeners={drop:[],dropstart:[],droperror:[]},this._onDragover=this._onDragover.bind(this),this._onDrop=this._onDrop.bind(this),this._onSelect=this._onSelect.bind(this),o==null||o.addEventListener("dragover",this._onDragover,!1),o==null||o.addEventListener("drop",this._onDrop,!1),l==null||l.addEventListener("change",this._onSelect),c&&Object.entries(c).forEach(([u,h])=>h&&this.on(u,h))}on(o,l){return this._listeners[o].push(l),this}_emit(o,l){return this._listeners[o].forEach(c=>c(l)),this}destroy(){const o=this._el,l=this._inputEl;o==null||o.removeEventListener("dragover",this._onDragover),o==null||o.removeEventListener("drop",this._onDrop),l==null||l.removeEventListener("change",this._onSelect)}_onDrop(o){var l,c;o.stopPropagation(),o.preventDefault(),this._emit("dropstart");const u=Array.from(((l=o.dataTransfer)===null||l===void 0?void 0:l.files)||[]),h=Array.from(((c=o.dataTransfer)===null||c===void 0?void 0:c.items)||[]);if(u.length!==0||h.length!==0)if(h.length>0){const _=h.map(A=>A.webkitGetAsEntry());this._loadNextEntry(new Map,_)}else this._emit("drop",{files:new Map(u.map(_=>(_.filePath=_.name,[_.filePath,_])))});else this._fail("Required drag-and-drop APIs are not supported in this browser.")}_onDragover(o){o.stopPropagation(),o.preventDefault(),o.dataTransfer&&(o.dataTransfer.dropEffect="copy")}_onSelect(o){var l;if(!this._inputEl)return void console.warn("Invalid Dropzone event ",o);this._emit("dropstart");const c=[].slice.call((l=this._inputEl.files)!==null&&l!==void 0?l:new FileList),u=new Map;c.forEach(h=>{h.filePath=h.webkitRelativePath||h.name,u.set(h.filePath,h)}),this._emit("drop",{files:u})}_loadNextEntry(o,l){const c=l.pop();if(c)if(c.isFile)c.file(u=>{u.filePath=c.fullPath,o.set(c.fullPath,u),this._loadNextEntry(o,l)},()=>console.error("Could not load file: %s",c.fullPath));else if(c.isDirectory){const u=c.createReader(),h=_=>{_.length?(l=l.concat(_),u.readEntries(h)):this._loadNextEntry(o,l)};u.readEntries(h)}else console.warn("Unknown asset type: "+c.fullPath),this._loadNextEntry(o,l);else this._emit("drop",{files:o})}_fail(o){this._emit("droperror",{message:o})}}class DropzonePlugin extends I{constructor(o){super(),this._domElement=o,this._allowedExtensions=void 0,this.importerParams={autoScale:!0,autoScaleRadius:2,pseudoCenter:!1,autoCenter:!0,autoImport:!0,autoAdd:!0,centerOffset:new three_module.Pq0(.5,.5,3)},this.dependencies=[AssetManagerPlugin],this.uiConfig={type:"folder",label:"Drop Options",expanded:!0,children:[{label:"Auto Center",type:"checkbox",property:[this.importerParams,"autoCenter"],limitedUi:!0},{label:"Auto Scale",type:"checkbox",property:[this.importerParams,"autoScale"],limitedUi:!0},{label:"Auto scale radius",type:"slider",bounds:[.5,100],property:[this.importerParams,"autoScaleRadius"]},{label:"Select local file",type:"button",value:()=>this.promptForFile()}]}}onAdded(o){this._inputEl=document.createElement("input"),this._viewer=o,this._inputEl.type="file",this._dropzone=new Dropzone(this._domElement||o.canvas,this._inputEl,{drop:this._onFileDrop.bind(this)})}async _onFileDrop({files:o}){var l,c,u,h,_,A;if(!o)return;const w=this._viewer;if(!w)return;if(this._allowedExtensions!==void 0)for(const O of o.keys())this._allowedExtensions.includes((c=(l=O.split(".").pop())===null||l===void 0?void 0:l.toLowerCase())!==null&&c!==void 0?c:"")||o.delete(O);if(o.size<1)return;const C=w.getPlugin(AssetManagerPlugin),M={type:"drop",files:o};if(this.importerParams.autoImport){const O={allowedExtensions:this.allowedExtensions,...this.importerParams};if(M.imported=await((u=C.importer)===null||u===void 0?void 0:u.importFiles(o,O)),this.importerParams.autoAdd){const ne=(A=[...(_=(h=M.imported)===null||h===void 0?void 0:h.values())!==null&&_!==void 0?_:[]].flat(2).filter(ce=>!!ce))!==null&&A!==void 0?A:[];if(M.assets=C.addProcessedAssets(ne,{...this.importerParams}),!O._rootSceneImported)for(const ce of M.assets)ce.modelObject&&ce.modelObject.dispatchEvent({type:"select",value:ce.modelObject})}}this.dispatchEvent(M)}promptForFile(){var o;(o=this._inputEl)===null||o===void 0||o.click()}onRemove(o){var l;(l=this._dropzone)===null||l===void 0||l.destroy(),this._dropzone=void 0,this._viewer=void 0}get allowedExtensions(){return this._allowedExtensions}set allowedExtensions(o){this._allowedExtensions=o,this._inputEl&&(this._inputEl.accept=o?o.map(l=>"."+l).join(", "):"")}}function legacySeparateMapSamplerUVFix(d,o){const l=(d.version?d.version:"0.0.0").split(".").map(u=>parseInt(u));if(d.type!=="ViewerApp"||l[0]!==0||!(l[1]<7||l[1]===7&&l[2].toString()[0]<"6"))return;const c=new Set;o.forEach(u=>u.traverse(h=>{h.material&&c.add(h.material)})),c.forEach(u=>{const h=u.map;if(!h)return;const _=h.repeat,A=h.offset,w=h.center,C=h.rotation;["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","lightMap","metalnessMap","normalMap","roughnessMap","transmissionMap"].forEach(M=>{const O=u[M];O&&(O.repeat.copy(_),O.offset.copy(A),O.center.copy(w),O.rotation=C,O.needsUpdate=!0)}),u.needsUpdate=!0})}DropzonePlugin.PluginType="Dropzone";var ViewerApp_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};function getPluginType(d){return Object.getPrototypeOf(d).constructor.PluginType}class ViewerApp extends I{get useRgbm(){return this._useRgbm}get screenShader(){return this._screenShader}get useGBufferDepth(){return this._useGBufferDepth}get isAntialiased(){return this._isAntialiased}constructor({isAntialiased:o=!1,useRgbm:l=!0,useGBufferDepth:c=!1,screenShader:u="",maxHDRIntensity:h,..._}){var A;super(),this.console=console,this._state=ViewerState.None,this.plugins={},this._needsResize=!1,this.resizeObserver=window.ResizeObserver?new window.ResizeObserver(ce=>this.resize()):void 0,this._lastSize=new three_module.I9Y,this._onContextRestore=ce=>{this.enabled=!0,this._canvas.width=this._lastSize.width,this._canvas.height=this._lastSize.height,this.resize(),this.scene.setDirty({sceneUpdate:!0,frameFade:!1})},this._onContextLost=ce=>{this._lastSize.set(this._canvas.width,this._canvas.height),this._canvas.width=2,this._canvas.height=2,this.resize(),this.enabled=!1},this.resize=()=>{this._needsResize=!0,this.setDirty()},this._needsReset=!0,this.enabled=!0,this.renderEnabled=!0,this._isRenderingFrame=!1,this.maxFramePerLoop=1,this.rendersPerFrame=1,this._rawBackground=null,this._sceneEnvironmentChanged=()=>{this._rawBackground===envMapBackground&&this.scene.setBackground(this.scene.getEnvironment())},this._addSceneObject=ce=>{var ue,ye;if(!ce||!ce.object||ce.options&&ce.options.importConfig===!1)return;const Oe=ce.object.__importedViewerConfig||((ue=ce.object.modelObject)===null||ue===void 0?void 0:ue.__importedViewerConfig);if(!Oe)return;const ke=this.getManager();legacySeparateMapSamplerUVFix(Oe,!((ye=ce.options)===null||ye===void 0)&&ye.allImported?ce.options.allImported:[ce.object]),ke?ke.applyViewerConfig(Oe,Oe.resources):this.fromJSON(Oe,Oe.resources)},this.serializePluginsIgnored=[],this.alert=async ce=>alert(ce),this.confirm=async ce=>confirm(ce),this.prompt=async(ce,ue,ye=!0)=>prompt(ce,ue),this._useRgbm=l,this._useGBufferDepth=c,this._screenShader=u,this._canvas=_.canvas||j();let w=_.container;if(w&&!_.canvas&&w.appendChild(this._canvas),w||(w=(A=this._canvas.parentElement)!==null&&A!==void 0?A:void 0),!w)throw new Error("No container.");this._container=w,this._animationLoop=this._animationLoop.bind(this),this.setDirty=this.setDirty.bind(this),this._setActiveCameraView=this._setActiveCameraView.bind(this),window.webGiViewers||(window.webGiViewers=[]),window.webGiViewers.push(this),checkVersion();const C=new CameraController(void 0,void 0,this._canvas);C.autoLookAtTarget=!0,this.addEventListener("postFrame",()=>{var ce,ue;const ye=O.scene.activeCamera;if(ye&&ye.interactionsEnabled){const Oe=(ce=this.getPluginByType("Progressive"))===null||ce===void 0?void 0:ce.postFrameConvergedRecordingDelta();if(Oe!==void 0&&Oe===0)return;(ue=ye.controls)===null||ue===void 0||ue.update()}}),this.scene=new RootScene(C),this.scene.addEventListener("environmentChanged",this._sceneEnvironmentChanged),this.scene.addEventListener("addSceneObject",this._addSceneObject),this.scene.addEventListener("setView",this._setActiveCameraView),this.scene.addEventListener("activateMain",this._setActiveCameraView),this._renderer=new BaseRenderer({canvas:this._canvas,animationLoop:this._animationLoop,targetOptions:{samples:o?4:0,colorSpace:l?RGBM16ColorSpace_:three_module.jf0,type:l?three_module.OUM:three_module.ix0,depthBuffer:!c,generateMipmaps:!!o,minFilter:o?three_module.NZq:three_module.k6q},maxHDRIntensity:h||(l?16:80)}),this._isAntialiased=o&&this._renderer.isWebGL2;let M=!0;this._renderer.rendererObject.userData||(M=!1,this._renderer.rendererObject.userData={}),this._renderer.rendererObject.userData.renderTransmissionPass=!M;const O=this;this.renderFilter={passId:"render",passObject:new RenderPass2(this,M),update(){const ce=this.passObject;ce.scene=O.scene.modelObject,ce.camera=O.scene.renderCamera.cameraObject}};const ne={passId:"screen",after:["render"],required:["render"],passObject:buildScreenShader(u)};[this.renderFilter,ne].forEach(ce=>this._renderer.registerPass(ce)),this._renderer.pipeline=["render","screen"],this.scene.addEventListener("textureUpdate",ce=>this.setDirty(this.scene,ce)),this.scene.addEventListener("sceneMaterialUpdate",ce=>this.setDirty(this.scene,ce)),this.scene.addEventListener("sceneUpdate",ce=>{this.setDirty(this.scene,ce),ce.geometryChanged!==!1&&this.renderer.resetShadows()}),this.scene.addEventListener("update",ce=>this.setDirty(this.scene,ce)),this._renderer.addEventListener("update",ce=>this.setDirty(this._renderer,ce)),this.resizeObserver&&this.resizeObserver.observe(this._canvas),window&&window.addEventListener("resize",this.resize),this._canvas.addEventListener("webglcontextrestored",this._onContextRestore,!1),this._canvas.addEventListener("webglcontextlost",this._onContextLost,!1),this.renderer.addEventListener("resize",()=>{this.scene.activeCamera.refreshAspect()}),this.scene.setBackgroundColor("#ffffff"),_.assetManager&&this.addPluginSync(new AssetManagerPlugin(void 0,void 0,typeof _.assetManager=="boolean"?{}:_.assetManager)),_.dropzone&&this.addPluginSync(new DropzonePlugin),this.console.log("WebGi Viewer instance initialized, version: ",ViewerApp.VERSION)}setDirty(o,l){this._needsReset=!0,o=o??this,this.dispatchEvent({...l??{},type:"update",source:o})}get renderer(){return this._renderer}dispose(){var o;for(const l of[...Object.values(this.plugins)])this.removePlugin(l,!0);this.scene.dispose(),this.renderer.dispose(),this._canvas.removeEventListener("webglcontextrestored",this._onContextRestore,!1),this._canvas.removeEventListener("webglcontextlost",this._onContextLost,!1),(o=window.webGiViewers)===null||o===void 0||o.splice(window.webGiViewers.indexOf(this),1),this.resizeObserver?this.resizeObserver.unobserve(this._canvas):window.removeEventListener("resize",this.resize),this.dispatchEvent({type:"dispose"})}_renderEnabledChanged(){this.dispatchEvent({type:this.renderEnabled?"renderEnabled":"renderDisabled"})}_animationLoop({time:o,deltaTime:l,xrFrame:c}){var u,h;if(this.enabled&&this.renderEnabled)if(this._isRenderingFrame)this.console.warn("animation loop: frame skip");else{this._isRenderingFrame=!0;for(let _=0;_<this.maxFramePerLoop;_++){if(this._needsReset&&(this._renderer.reset(),this._needsReset=!1),this._needsResize){const C=[this._canvas.clientWidth,this._canvas.clientHeight];if(c){const M=(h=(u=this._renderer.rendererObject.xr.getCamera())===null||u===void 0?void 0:u.cameras[0])===null||h===void 0?void 0:h.viewport;M?(M.x===0&&M.y===0||this.console.warn("x and y must be 0?"),C[0]=M.width,C[1]=M.height,this.console.log("resize for xr",C)):this._needsResize=!1}this._needsResize&&(this._renderer.setSize(...C),this._needsResize=!1)}this.dispatchEvent({type:"preFrame",target:this,time:o,deltaTime:l,xrFrame:c});const A=Object.values(this.plugins).filter(C=>C.dirty);A.length>0&&this.setDirty(A),this._needsReset&&(this._renderer.reset(),this._needsReset=!1),this._renderer.updateDirty();const w=this._renderer.dirty;if(w)for(let C=0;C<this.rendersPerFrame;C++){this.dispatchEvent({type:"preRender",target:this});try{this.scene.renderCamera=this.scene.activeCamera,this._renderer.render(this._renderer.defaultRenderToScreen)}catch(M){this.console.error(M),this.enabled=!1}this.dispatchEvent({type:"postRender",target:this})}if(this.dispatchEvent({type:"postFrame",target:this}),!w)break}this._isRenderingFrame=!1}}get state(){return this._state}get container(){return this._canvas.parentElement!==this._container&&this.console.error("ViewerApp: Canvas is not in the container, this might cause issues with some plugins."),this._container}get canvas(){return this._canvas}get canvasTexture(){if(!this._canvas)throw new Error("Canvas not found");return this._canvasTexture||(this._canvasTexture=new three_module.GOR(this._canvas),this._canvasTexture.flipY=!1,this._canvasTexture.needsUpdate=!0),this._canvasTexture}getPlugin(o){return typeof o=="string"?this.getPluginByType(o):this.plugins[o.PluginType]}getPluginByType(o){return this.plugins[o]}async getOrAddPlugin(o,...l){return this.getPlugin(o)||this.addPlugin(o,...l)}getOrAddPluginSync(o,...l){return this.getPlugin(o)||this.addPluginSync(o,...l)}async addPlugin(o,...l){let c;if(o.prototype){const h=this.getPlugin(o);if(h)return console.error(`Plugin of type ${getPluginType(h)} already exists, no new plugin created`,h),h;c=new o(...l)}else c=o;const u=getPluginType(c);if(!u)return this.console.error("PluginType is not defined for",c),c;for(const h of c.dependencies||[])await this.getOrAddPlugin(h);return this.plugins[u]&&(this.console.error(`Plugin of type ${u} already exists, old plugin will be removed and disposed`,this.plugins[u],c),await this.removePlugin(this.plugins[u],!0)),this.plugins[u]=c,await c.onAdded(this),this.dispatchEvent({type:"addPlugin",target:this,plugin:c}),this.setDirty(c),c}addPluginSync(o,...l){let c;if(o.prototype){const h=this.getPlugin(o);if(h)return console.error(`Plugin of type ${getPluginType(h)} already exists, no new plugin created`,h),h;c=new o(...l)}else c=o;const u=getPluginType(c);if(!u)return this.console.error("PluginType is not defined for",c),c;for(const h of c.dependencies||[])this.getOrAddPluginSync(h);return this.plugins[u]&&(this.console.error(`Plugin of type ${u} already exists, old plugin will be removed and disposed`,this.plugins[u],c),this.removePluginSync(this.plugins[u],!0)),this.plugins[u]=c,c.onAdded(this),this.dispatchEvent({type:"addPlugin",target:this,plugin:c}),this.setDirty(c),c}async addPlugins(o){for(const l of o)await this.addPlugin(l)}async addPluginsSync(o){for(const l of o)this.addPluginSync(l)}async removePlugin(o,l=!0){const c=getPluginType(o);this.plugins[c]&&(await o.onRemove(this),delete this.plugins[c],l&&o.onDispose&&await o.onDispose(this),this.setDirty(o))}removePluginSync(o,l=!0){const c=getPluginType(o);this.plugins[c]&&(o.onRemove(this),delete this.plugins[c],l&&o.onDispose&&o.onDispose(this),this.setDirty(o))}createCamera(o){var l;const c=(l=o.userData.iCamera)!==null&&l!==void 0?l:new CameraController(o,{controlsMode:"",aspect:"auto"},this._canvas);return o.userData.autoLookAtTarget===void 0?(c.autoLookAtTarget=!1,o.userData.autoLookAtTarget=!1):c.autoLookAtTarget=o.userData.autoLookAtTarget,c}setSize(o){this._canvas.style.width=o!=null&&o.width?o.width+"px":"100%",this._canvas.style.height=o!=null&&o.height?o.height+"px":"100%",this.resize()}async doOnce(o,l){return new Promise(c=>{const u=async(...h)=>{this.removeEventListener(o,u),c(await(l==null?void 0:l(...h)))};this.addEventListener(o,u)})}setBackgroundColor(o){return console.warn("viewer.setBackground is deprecated, use viewer.scene.setBackgroundColor instead."),this.setBackgroundColor(o)}setBackground(o){if(console.warn("viewer.setBackground is deprecated, use viewer.scene.setBackground instead."),this._rawBackground=o,o==null||typeof o!="string"&&typeof o!="number"&&!o.isColor)!o&&this.useRgbm&&this.console.error("Transparent background not supported with HDR RGBM rendering mode");else if(o===envMapBackground)return this.scene.setBackground("environment");!o||o!=null&&o.isTexture?(this.scene.setBackground(o),o||this.scene.setBackgroundColor(o)):this.scene.setBackgroundColor(o)}getBackground(o=!1){var l;if(console.warn("viewer.getBackground is deprecated, use viewer.scene.background instead."),o)return this._rawBackground;let c=(l=this._rawBackground)!==null&&l!==void 0?l:this.scene.getBackground();return c?(c!=null&&c.isVector4&&(c=cRGBMToLinear(c,7).getHexString()),c!=null&&c.isColor?c.getHexString():this._rawBackground===envMapBackground?this.scene.getEnvironment():c):null}getManager(){return this.getPluginByType("AssetManager")||this.addPluginSync(AssetManagerPlugin)}resetCamera({rootObject:o,centerOffset:l=new three_module.Pq0(1,1,1),targetOffset:c=new three_module.Pq0(0,0,0),...u}={}){if(this.scene.activeCamera){this.scene.matrixWorldNeedsUpdate=!0,this.scene.updateMatrixWorld(!0);const h=o?new Box3B().expandByObject(o,!0,!0):this.scene.getBounds(!0),_=h.getCenter(new three_module.Pq0),A=.5*h.getSize(new three_module.Pq0).length();_.add(c.clone().multiplyScalar(A)),this.scene.activeCamera.position=new three_module.Pq0(_.x+l.x*A,_.y+l.y*A,_.z+l.z*A),this.scene.activeCamera.target=_,this.setDirty()}}async fitToView(o,l=1.5,c,u){var h,_;const A=this.getPluginByType("CameraViews");A?await(A==null?void 0:A.animateToFitObject(o,l,c,u,{min:((_=(h=this.scene.activeCamera.getControls())===null||h===void 0?void 0:h.minDistance)!==null&&_!==void 0?_:.5)+.5,max:1e3})):this.console.error("CameraViews plugin is required for fitToView to work")}async createObject3D(o,l=!1){var c;return(c=this.getManager())===null||c===void 0?void 0:c.addImportedSingle(o||new three_module.B69,{autoScale:!1,pseudoCenter:!1,addToRoot:l})}createPhysicalMaterial(o){return this.createMaterial("standard",o)}createMaterial(o,l){var c,u,h,_;if(l!=null&&l.isMaterial){const A=(u=(c=this.getManager())===null||c===void 0?void 0:c.materials)===null||u===void 0?void 0:u.findMaterial(l.uuid);if(A)return A}return(_=(h=this.getManager())===null||h===void 0?void 0:h.materials)===null||_===void 0?void 0:_.generateFromTemplate(o,l)}serializePlugins(o,l){return Object.entries(this.plugins).map(c=>{if((!l||l.includes(c[1].constructor.PluginType))&&!this.serializePluginsIgnored.includes(c[1].constructor.PluginType))return c[1].serializeWithViewer!==!1&&typeof c[1].toJSON=="function"?c[1].toJSON(o):void 0}).filter(c=>!!c)}deserializePlugins(o,l){return o.forEach(c=>{if(!c.type)return void this.console.warn("Invalid plugin to import ",c);if(this.serializePluginsIgnored.includes(c.type))return;const u=this.getPluginByType(c.type);u&&u.fromJSON&&u.fromJSON(c,l)}),this}traverseSceneObjects(o){this.scene.modelRoot.modelObject.traverse(o)}toJSON(o,l){const c=Object.assign({version:ViewerApp.VERSION,type:"ViewerApp",metadata:{generator:"WebGiViewerApp",version:1},plugins:this.serializePlugins(o,l)},serializeObject(this,!0,o));return c.backgroundIntensity=this.scene.backgroundIntensity,c.useLegacyLights=this.renderer.useLegacyLights,c.background=c.scene.background||c.scene.backgroundColor,c.background==="environment"&&(c.background="envMapBackground"),c}fromJSON(o,l){var c,u,h,_,A;const w={...o};return w.backgroundIntensity!==void 0&&((c=w.scene)===null||c===void 0?void 0:c.backgroundIntensity)===void 0&&(this.console.warn("old file format, backgroundIntensity moved to RootScene"),this.scene.backgroundIntensity=w.backgroundIntensity,delete w.backgroundIntensity),w.useLegacyLights!==void 0&&((u=w.renderManager)===null||u===void 0?void 0:u.useLegacyLights)===void 0&&(this.console.warn("old file format, useLegacyLights moved to BaseRenderer"),this.renderer.useLegacyLights=w.useLegacyLights,delete w.useLegacyLights),w.background!==void 0&&((h=w.scene)===null||h===void 0?void 0:h.background)===void 0&&(this.console.warn("old file format, background moved to RootScene"),w.background==="envMapBackground"?w.background="environment":typeof w.background=="number"?w.background=new three_module.Q1f().setHex(w.background,three_module.Zr2):typeof w.background=="string"?w.background=new three_module.Q1f().setStyle(w.background,three_module.Zr2):!((_=w.background)===null||_===void 0)&&_.isColor&&(w.background=new three_module.Q1f(w.background)),!((A=w.background)===null||A===void 0)&&A.isColor?(this.scene.backgroundColor=w.background,this.scene.background=null):w.background?(this.scene.backgroundColor=new three_module.Q1f("#ffffff"),w.scene.background=w.background):(this.scene.backgroundColor=null,this.scene.background=null),delete w.background),deserializeObject(w,this,!0,l),Array.isArray(w.plugins)&&this.deserializePlugins(w.plugins,l),this}get renderManager(){return this._renderer}get assetManager(){return this.getManager()}async load(o,l){if(o)return await this.assetManager.addAssetSingle(o,l)}async setEnvironmentMap(o,{setBackground:l=!1,...c}={}){return this.scene.environment=o&&!o.isTexture?await this.assetManager.importer.importSingle(o,c)||null:o||null,l?this.setBackgroundMap(this.scene.environment):this.scene.environment}async setBackgroundMap(o,{setEnvironment:l=!1,...c}={}){return this.scene.background=o&&!o.isTexture?await this.assetManager.importer.importSingle(o,c)||null:o||null,l?this.setEnvironmentMap(this.scene.background):this.scene.background}_setActiveCameraView(o={}){if(o.type==="setView"){if(!o.camera)return void this.console.warn("Cannot find camera",o);this.scene.activeCamera.copyFromCamera(o.camera)}else o.type==="activateMain"&&(this.scene.activeCamera=o.camera?this.createCamera(o.camera):void 0)}}async function checkVersion(){var d;const o=window.location.href,l="https://dev-sandbox.pixotronics.com/webgi/";if(!o.startsWith(l)||rt("noUpdate")!==null)return!0;const c=(d=o.match(/\/webgi\/([0-9.a-zA-Z-]+)/))===null||d===void 0?void 0:d[1],u=(await(await fetch(l+"version.txt")).text()).split(`
`)[0];if(c&&c!==u){if(confirm(`New version ${u} is available, do you want to open?`)){const h=window.location.href.replace(c,u);return window.location.href=h,!1}window.location.href.includes("noUpdate")||(window.location.href+=(window.location.href.includes("?")?"&":"?")+"noUpdate")}return!0}ViewerApp.VERSION=VIEWER_VERSION,ViewerApp_decorate([serialize("renderManager")],ViewerApp.prototype,"_renderer",void 0),ViewerApp_decorate([serialize()],ViewerApp.prototype,"scene",void 0),ViewerApp_decorate([x(ViewerApp.prototype._renderEnabledChanged)],ViewerApp.prototype,"renderEnabled",void 0);const envMapBackground="envMapBackground";function buildScreenShader(d){return d!=null&&d.isShaderPass2?d:new ShaderPass2({...CopyShader,fragmentShader:`
                       varying vec2 vUv;
                       
                       ${Array.isArray(d)?d[0]:(d==null?void 0:d.pars)||""}
                       
                       void main() {

                            gl_FragColor = tDiffuseTexelToLinear (texture2D(tDiffuse, vUv));
                            
                            ${Array.isArray(d)?d[1]:typeof d=="string"?d:(d==null?void 0:d.main)||""}
                            
                        }`,uniforms:{tDiffuse:{value:null}}},"tDiffuse")}var tonemapping=`int getToneMapBit(in int number){
#ifdef WebGL2Context
return(number/2)%2;
#else
return int(mod(floor(float(number)/2.),2.));
#endif
}vec3 TonemappingSaturation(vec3 rgb){const vec3 W=vec3(0.2125,0.7154,0.0721);vec3 intensity=vec3(dot(rgb,W));return mix(intensity,rgb,toneMappingSaturation);}vec3 TonemappingContrast(vec3 color){return(color-vec3(0.5))*toneMappingContrast+vec3(0.5);}vec4 ToneMapping(in vec4 color){vec4 outColor=opacity*color;
#if USE_DEPTH_TONEMAP > 0
bool doTonemap=getToneMapBit(getGBufferFlags(vUv).a)>0;float depth=getDepth(vUv);vec4 transparentCol=tTransparentTexelToLinear(texture2D(tTransparent,vUv));
#if TONEMAP_BACKGROUND < 1 || TRANSPARENT_BACKGROUND > 0
bool isBackground=depth>0.99&&transparentCol.a<0.001;if(isBackground)doTonemap=false;
#endif
if(doTonemap){
#endif
#if defined( TONE_MAPPING )
outColor.rgb=toneMapping(outColor.rgb);outColor.rgb=TonemappingContrast(outColor.rgb);outColor.rgb=TonemappingSaturation(outColor.rgb);
#endif
#if USE_DEPTH_TONEMAP > 0
}
#if TRANSPARENT_BACKGROUND > 0
if(isBackground)outColor.a=0.;if(depth>0.99&&transparentCol.a>=0.001)outColor.a=transparentCol.a;
#endif
if(depth<0.00001)outColor.a=0.;
#if defined(DEBUG_DEPTH) && DEBUG_DEPTH > 0
outColor.rgb=vec3(sRGBToLinear(vec4((1.-depth))).x);
#endif
#endif
return outColor;}`;class CombinedPostPass extends ShaderPass2{constructor(o){super({vertexShader:CopyShader.vertexShader,uniforms:{tDiffuse:{value:null},tNormalDepth:{value:null},tGBufferFlags:{value:null},tTransparent:{value:null}},defines:{},fragmentShader:`
                varying vec2 vUv;
                ${o[0]}
                void main() {
                    gl_FragColor = tDiffuseTexelToLinear (texture2D(tDiffuse, vUv));
                    #glMarker
                    ${o[1]}
                    
                    gl_FragColor.rgb *= gl_FragColor.a; // premultiply alpha
                }
                `},"tDiffuse","tTransparent"),this.uiConfig=void 0,this.material.transparent=!1,this.material.side=three_module.hB5}render(o,l,c,u,h){super.render(o,l,c,u,h),this._lastReadBuffer=c,this.needsSwap=!0}reRender(o,l,c,u){this._lastReadBuffer&&this.render(o,l,this._lastReadBuffer,c,u)}dispose(){this._lastReadBuffer=void 0,super.dispose()}}class CombinedPostPlugin extends GenericFilterPlugin{get renderToScreen(){return this._renderToScreen}constructor(o=!0,l=!0){super(),this.depthTonemap=o,this.passId="combinedPost",this.dependencies=[GBufferPlugin],this.toJSON=void 0,this._beforeFilters=[],this._afterFilters=["render","screen"],this._requiredFilters=["render"],this._renderToScreen=!0,this._postFrame=()=>{var c,u;this._needsReRender&&this._renderToScreen&&this._viewer&&this.pass&&(this._needsReRender=!1,(u=(c=this.pass).update)===null||u===void 0||u.call(c),this.pass.passObject.reRender(this._viewer.renderer.rendererObject,null))},this._needsReRender=!1,this._setDirty=this._setDirty.bind(this),this._renderToScreen=l}async onAdded(o){var l,c;return!((c=(l=this._viewer)===null||l===void 0?void 0:l.screenShader)===null||c===void 0)&&c.isShaderPass2&&(this._renderToScreen=!1),this._renderToScreen&&S(o.renderer.passes.find(u=>u.passId==="screen"),"enabled",!1,!0,!0),o.addEventListener("postFrame",this._postFrame),super.onAdded(o)}async onRemove(o){return this._renderToScreen&&S(o.renderer.passes.find(l=>l.passId==="screen"),"enabled",!0,!0,!0),super.onRemove(o)}passCtor(o){var l,c;const u=o.screenShader,h=["",""];this._renderToScreen&&!u.isShaderPass2&&(h[0]=Array.isArray(u)?u[0]:(u==null?void 0:u.pars)||"",h[1]=Array.isArray(u)?u[1]:typeof u=="string"?u:(u==null?void 0:u.main)||"");const _=new CombinedPostPass(h);return S((c=(l=_.uiConfig)===null||l===void 0?void 0:l.children)===null||c===void 0?void 0:c.find(A=>(A==null?void 0:A.label)==="Enabled"),"hidden",!0,!0),_}_update(o){var l,c,u;return!!super._update(o)&&(this._pass.passObject.updateShaderProperties((l=this._viewer)===null||l===void 0?void 0:l.getPlugin(GBufferPlugin)),this._pass.passObject.material.uniforms.tTransparent.value=((u=(c=this._viewer)===null||c===void 0?void 0:c.renderFilter.passObject.transparentTarget)===null||u===void 0?void 0:u.texture)||null,!0)}_setDirty(){this.pass&&(this.pass.dirty=!0)}get uiConfig(){var o,l,c;return(c=(l=(o=this.pass)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.uiConfig)!==null&&c!==void 0?c:{}}addExtension(o){this.pass.passObject.material.registerMaterialExtensions([o])}reRender(){this._renderToScreen?this._needsReRender=!0:this._setDirty()}}CombinedPostPlugin.PluginType="CombinedPostPlugin";var GenericExtensionPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class GenericExtensionPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.dependencies=[CombinedPostPlugin]}get uiConfig(){var o;return(o=this._extension)===null||o===void 0?void 0:o.uiConfig}get config(){return this._extension}disposeExtension(){}async onAdded(o){var l;await super.onAdded(o),this._extension=this.generateExtension(o),(l=o.getPlugin(CombinedPostPlugin))===null||l===void 0||l.addExtension(this._extension)}async onRemove(o){this.disposeExtension(),this._extension=void 0,await super.onRemove(o)}}function updateBit(d,o,l){return d&~(1<<o)|(l?1:0)<<o}function clearBit(d,o){return d&~(1<<o)}GenericExtensionPlugin_decorate([serialize("extension")],GenericExtensionPlugin.prototype,"_extension",void 0),GenericExtensionPlugin_decorate([serialize()],GenericExtensionPlugin.prototype,"enabled",void 0);var TonemapPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const Uncharted2Tonemapping=three_module.g7M;let TonemapExtension=class{constructor(d,o=!0){this.depthTonemap=o,this.toneMapping=three_module.FV,this.tonemapBackground=!0,this.clipBackground=!1,this.exposure=1,this.saturation=1,this.contrast=1,this.renderDepth=!1,this.enabled=!0,this._rendererState={},this.extraUniforms={opacity:{value:1},toneMappingContrast:{value:1},toneMappingSaturation:{value:1}},this.parsFragmentSnippet=(l,c)=>this.enabled?fe`
            ${this.depthTonemap?unpackGbuffer:""}
            #define USE_DEPTH_TONEMAP ${this.depthTonemap?"1":"0"}
            uniform float opacity;
            uniform float toneMappingContrast;
            uniform float toneMappingSaturation;
            ${tonemapping}
        `:"",this._combinedPostPlugin=d.getPlugin(CombinedPostPlugin),this._setDirty=this._setDirty.bind(this),this.depthTonemap=o}shaderExtender(d,o,l){this.enabled&&(d.fragmentShader=shaderReplaceString(d.fragmentShader,"#glMarker",`
gl_FragColor = ToneMapping(gl_FragColor);
`,{prepend:!0}))}onObjectRender(d,o,l){if(!this.enabled)return;const{toneMapping:c,toneMappingExposure:u,outputColorSpace:h}=l;this._rendererState.toneMapping=c,this._rendererState.toneMappingExposure=u,this._rendererState.outputColorSpace=h;let _=this.tonemapBackground?"1":"0";o.materialObject.defines.TONEMAP_BACKGROUND!==_&&(o.materialObject.defines.TONEMAP_BACKGROUND=_,o.materialObject.needsUpdate=!0),_=this.clipBackground?"1":"0",o.materialObject.defines.TRANSPARENT_BACKGROUND!==_&&(o.materialObject.defines.TRANSPARENT_BACKGROUND=_,o.materialObject.needsUpdate=!0),_=this.renderDepth?"1":"0",o.materialObject.defines.DEBUG_DEPTH!==_&&(o.materialObject.defines.DEBUG_DEPTH=_,o.materialObject.needsUpdate=!0),l.toneMapping=this.toneMapping,l.toneMappingExposure=this.exposure,l.outputColorSpace=three_module.er$,o.materialObject.toneMapped=!0,o.materialObject.needsUpdate=!0,this.extraUniforms.toneMappingContrast.value=this.contrast,this.extraUniforms.toneMappingSaturation.value=this.saturation}onAfterRender(d,o,l){l.toneMapping=this._rendererState.toneMapping,l.toneMappingExposure=this._rendererState.toneMappingExposure,l.outputColorSpace=this._rendererState.outputColorSpace}getUiConfig(){return this.uiConfig}computeCacheKey(d){return this.enabled?"1":"0"}isCompatible(d){return!0}_setDirty(){this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){var d;(d=this.__setDirty)===null||d===void 0||d.call(this),this._setDirty()}};TonemapExtension.PluginType="Tonemap",TonemapPlugin_decorate([uiDropdown("Mode",[["Linear",three_module.kyO],["Reinhard",three_module.Mjd],["Cineon",three_module.nNL],["ACESFilmic",three_module.FV],["Uncharted2",Uncharted2Tonemapping]].map(d=>({label:d[0],value:d[1]})),{limitedUi:!0}),x(TonemapExtension.prototype._setDirty),serialize()],TonemapExtension.prototype,"toneMapping",void 0),TonemapPlugin_decorate([x(TonemapExtension.prototype._setDirty),uiToggle("Tonemap Background",{limitedUi:!0}),serialize()],TonemapExtension.prototype,"tonemapBackground",void 0),TonemapPlugin_decorate([x(TonemapExtension.prototype._setDirty),uiToggle("Clip Background"),serialize()],TonemapExtension.prototype,"clipBackground",void 0),TonemapPlugin_decorate([x(TonemapExtension.prototype._setDirty),uiSlider("Exposure",[0,2*Math.PI],.01,{limitedUi:!0}),serialize()],TonemapExtension.prototype,"exposure",void 0),TonemapPlugin_decorate([x(TonemapExtension.prototype._setDirty),uiSlider("Saturation",[0,2],.01,{limitedUi:!0}),serialize()],TonemapExtension.prototype,"saturation",void 0),TonemapPlugin_decorate([x(TonemapExtension.prototype._setDirty),uiSlider("Contrast",[0,2],.01,{limitedUi:!0}),serialize()],TonemapExtension.prototype,"contrast",void 0),TonemapPlugin_decorate([x(TonemapExtension.prototype._setDirty),uiToggle("Render Depth")],TonemapExtension.prototype,"renderDepth",void 0),TonemapExtension=TonemapPlugin_decorate([uiFolder("Tonemapping")],TonemapExtension);class TonemapPlugin extends GenericExtensionPlugin{constructor(o=!0){super(),this.depthTonemap=o,this.depthTonemap=o,this.updateGBuffer=this.updateGBuffer.bind(this)}fromJSON(o,l){return o.pass&&((o={...o}).extension={...o.pass},delete o.extension.enabled,delete o.pass),super.fromJSON(o,l)}async onAdded(o){var l;await super.onAdded(o),(l=o.getPlugin(GBufferPlugin))===null||l===void 0||l.registerGBufferUpdater(this.updateGBuffer)}generateExtension(o){return new TonemapExtension(o,this.depthTonemap)}get exposure(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.exposure)!==null&&l!==void 0?l:1}set exposure(o){this._extension&&(this._extension.exposure=o,this._extension.setDirty())}get saturation(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.saturation)!==null&&l!==void 0?l:1}set saturation(o){this._extension&&(this._extension.saturation=o,this._extension.setDirty())}get contrast(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.contrast)!==null&&l!==void 0?l:1}set contrast(o){this._extension&&(this._extension.contrast=o,this._extension.setDirty())}get toneMapping(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.toneMapping)!==null&&l!==void 0?l:three_module.kyO}set toneMapping(o){this._extension&&(this._extension.toneMapping=o,this._extension.setDirty())}updateGBuffer(o,l){var c,u;if(o instanceof three_module.eaF&&(!((c=o.material)===null||c===void 0)&&c.userData)){const h=((u=o.material)===null||u===void 0?void 0:u.userData.postTonemap)===!1?0:1;l.w=updateBit(l.w,1,h)}}}TonemapPlugin.PluginType="Tonemap",three_module.vxI.tonemapping_pars_fragment=three_module.vxI.tonemapping_pars_fragment.replace("vec3 CustomToneMapping( vec3 color ) { return color; }",`

// source: http://filmicworlds.com/blog/filmic-tonemapping-operators/
#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )
vec3 Uncharted2ToneMapping( vec3 color ) {

	// John Hable's filmic operator from Uncharted 2 video game
	color *= toneMappingExposure;
	return saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( 1.0 ) ) );

}

vec3 CustomToneMapping( vec3 color ) { return Uncharted2ToneMapping( color ); }

`);var chromaticAberration="vec4 chromaticAberration(){vec2 distFromCenter=vUv-0.5;vec2 aberrated=aberrationIntensity*pow(abs(distFromCenter),vec2(2.));vec4 color=tDiffuseTexelToLinear(texture2D(tDiffuse,vUv));vec4 outColor=vec4(tDiffuseTexelToLinear(texture2D(tDiffuse,vUv+aberrated)).r,color.g,tDiffuseTexelToLinear(texture2D(tDiffuse,vUv-aberrated)).b,color.a);return outColor;}",ChromaticAberrationPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let ChromaticAberrationExtension=class{constructor(d){this.enabled=!1,this.aberrationIntensity=.01,this.extraUniforms={aberrationIntensity:{value:1}},this.parsFragmentSnippet=(o,l)=>this.enabled?fe`
            uniform float aberrationIntensity;
            ${chromaticAberration}
        `:"",this._combinedPostPlugin=d.getPlugin(CombinedPostPlugin),this._setDirty=this._setDirty.bind(this)}shaderExtender(d,o,l){this.enabled&&(d.fragmentShader=shaderReplaceString(d.fragmentShader,"#glMarker",` 
            gl_FragColor = chromaticAberration();
            #glMarker
        `))}onObjectRender(d,o,l){this.enabled&&(this.extraUniforms.aberrationIntensity.value=this.aberrationIntensity)}getUiConfig(){return this.uiConfig}computeCacheKey(d){return this.enabled?"1":"0"}isCompatible(d){return!0}_setDirty(){this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){var d;(d=this.__setDirty)===null||d===void 0||d.call(this),this._setDirty()}};ChromaticAberrationExtension.PluginType="ChromaticAberration",ChromaticAberrationPlugin_decorate([x(ChromaticAberrationExtension.prototype._setDirty),uiToggle("Enable"),serialize()],ChromaticAberrationExtension.prototype,"enabled",void 0),ChromaticAberrationPlugin_decorate([x(ChromaticAberrationExtension.prototype._setDirty),uiSlider("Intensity",[0,.1],.001,{limitedUi:!0}),serialize()],ChromaticAberrationExtension.prototype,"aberrationIntensity",void 0),ChromaticAberrationExtension=ChromaticAberrationPlugin_decorate([uiFolder("ChromaticAberration")],ChromaticAberrationExtension);class ChromaticAberrationPlugin extends GenericExtensionPlugin{constructor(){super()}generateExtension(o){return new ChromaticAberrationExtension(o)}get intensity(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.aberrationIntensity)!==null&&l!==void 0?l:1}set intensity(o){this._extension&&(this._extension.aberrationIntensity=o,this._extension.setDirty())}}ChromaticAberrationPlugin.PluginType="ChromaticAberration";class MultiFilterPlugin extends AViewerPlugin{get passes(){if(!this._passes)throw"Plugin not yet added to the viewer";return this._passes}get pipeline(){return this._pipeline}set pipeline(o){this._pipeline=o}constructor(){super(),this._pipeline=[]}async onAdded(o){await super.onAdded(o);const l=this.createPasses(o);this._passes=Object.fromEntries(l.map(c=>(c.passId||(console.warn("no id found for pass",c),c.passId=esm_browser_v4()),o.renderer.registerPass(c,!0),[c.passId,c])))}async onRemove(o){var l;if(this._passes){for(const c of[...Object.values(this._passes)]){const u=c;o.renderer.unregisterPass(u),(l=u==null?void 0:u.dispose)===null||l===void 0||l.call(u)}this._passes=void 0}await super.onRemove(o)}toJSON(o){var l;const c=super.toJSON(o);if(!c.type)return c;const u=Object.entries(this.passes);c.passes={};for(const[h,_]of u)c.passes[h]=serializeObject((l=_==null?void 0:_.passObject)!==null&&l!==void 0?l:_,!1,o);return c}fromJSON(o,l){var c;if(!super.fromJSON(o,l))return null;if(o.passes){const u=Object.entries(this.passes);for(const[h,_]of u)deserializeObject(o.passes[h],(c=_==null?void 0:_.passObject)!==null&&c!==void 0?c:_,!1,l)}return this}}var ssaoBilateral=`uniform vec2 tDiffuseSize;uniform vec2 bilDirection;varying vec2 vUv;uniform bool smoothEnabled;uniform float edgeSharpness;vec4 bilaterialAO(){vec4 color=clamp((texture2D(tDiffuse,vUv.xy)).B_SRC_ACCESSOR,0.,5.);if(!smoothEnabled)return color;float depth;vec3 normal;getDepthNormal(vUv.xy,depth,normal);float gaussianWeights[4];gaussianWeights[0]=0.153170;gaussianWeights[1]=0.144893;gaussianWeights[2]=0.122649;gaussianWeights[3]=0.092902;float Z=gaussianWeights[0]+0.03;vec4 final_colour=Z*color;vec2 nuv;vec4 cc;float dp;vec3 nor;vec2 direction=bilDirection/tDiffuseSize.xy;
#pragma unroll_loop_start
for(int i=0;i<6;i++){direction*=-1.;nuv=vUv+2.*direction*float(UNROLLED_LOOP_INDEX/2+1);getDepthNormal(nuv,dp,nor);if(dp<0.999){float normalCloseness=dot(normal,nor);normalCloseness*=normalCloseness;float normalError=(1.-normalCloseness)*8.;float normalWeight=max((1.-normalError*edgeSharpness),0.00);float depthWeight=max(0.,1.-edgeSharpness*4000.*abs(depth-dp));float kernelWeight=gaussianWeights[UNROLLED_LOOP_INDEX/2]+0.03;float bilateralWeight=kernelWeight*depthWeight*normalWeight;Z+=bilateralWeight;cc=clamp((texture2D(tDiffuse,nuv)).B_SRC_ACCESSOR,0.,5.);final_colour+=bilateralWeight*cc;}}
#pragma unroll_loop_end
final_colour/=Z;return final_colour;}void main(){vec4 ao=clamp(bilaterialAO(),vec4(0.),vec4(1.));gl_FragColor=ao;}`,BilateralFilterPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class BilateralFilterPass extends ShaderPass2{constructor(o,l,c="rgba"){super({vertexShader:CopyShader.vertexShader,fragmentShader:l+ssaoBilateral,uniforms:{bilDirection:{value:new three_module.I9Y(1,0)},tNormalDepth:{value:null},tDiffuse:{value:o.texture},tDiffuseSize:{value:new three_module.I9Y}},defines:{B_SRC_ACCESSOR:c}},"tDiffuse"),this.smoothEnabled=!0,this.edgeSharpness=.1,this._target=o,this.clear=!1,this.needsSwap=!1}render(o,l,c,u,h){var _,A,w,C;this.enabled&&(this.uniforms.bilDirection.value.set(1,0),this.uniforms.tDiffuse.value=this._target.texture,this.uniforms.tDiffuseSize.value.set(((_=this.uniforms.tDiffuse.value)===null||_===void 0?void 0:_.image.width)||0,((A=this.uniforms.tDiffuse.value)===null||A===void 0?void 0:A.image.height)||0),super.render(o,l,this._target,u,h),this.uniforms.bilDirection.value.set(0,1),this.uniforms.tDiffuse.value=l.texture,this.uniforms.tDiffuseSize.value.set(((w=this.uniforms.tDiffuse.value)===null||w===void 0?void 0:w.image.width)||0,((C=this.uniforms.tDiffuse.value)===null||C===void 0?void 0:C.image.height)||0),super.render(o,this._target,l,u,h))}}BilateralFilterPass_decorate([serialize(),uniform()],BilateralFilterPass.prototype,"smoothEnabled",void 0),BilateralFilterPass_decorate([serialize(),uniform()],BilateralFilterPass.prototype,"edgeSharpness",void 0);var defaultVertex="varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}",randomHelpers=`#ifndef BASIC_RANDOM_HELPERS
#define BASIC_RANDOM_HELPERS 
uniform float frameCount;float random(float n){return fract(sin(n)*43758.5453123);}float random2(vec2 n,float x){n+=x;return fract(sin(dot(n.xy,vec2(12.9898,78.233)))*43758.5453);}float random3(vec3 v){v=fract(v*443.8975);v+=dot(v,v.yzx+19.19);return fract((v.x+v.y)*v.z);}float interleavedGradientNoise(const in vec2 fragCoord,const in float seed){vec3 magic=vec3(0.06711056,0.00583715,52.9829189);return fract(magic.z*fract(dot(fragCoord.xy+seed*vec2(2.083,4.867),magic.xy)));}vec3 hash3(vec2 p){vec3 q=vec3(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)),dot(p,vec2(419.2,371.9)));return fract(sin(q)*43758.5453);}
#endif
`,ssao=`#include <common>
#include <packing>
varying vec2 vUv;uniform vec2 cameraNearFar;uniform mat4 projection;uniform sampler2D tLastThis;uniform vec4 saoData;uniform vec4 saoBiasEpsilon;uniform vec2 screenSize;const float INV_NUM_SAMPLES=1./float(NUM_SAMPLES);int getSelectionBit(in int number){
#ifdef WebGL2Context
return(number/8)%2;
#else
return int(mod(floor(float(number)/4.),2.));
#endif
}float getViewZFromNDCZ(const in float depth){
#if PERSPECTIVE_CAMERA == 1
return perspectiveDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);
#else
return orthographicDepthToViewZ(depth,cameraNearFar.x,cameraNearFar.y);
#endif
}vec3 packFloatToRGB(const in float x){const vec3 code=vec3(1.,255.,65025.);vec3 pack=vec3(code*x);pack.gb=fract(pack.gb);pack.rg-=pack.gb*(1./256.);return pack;}vec3 getViewPositionFromViewZ(const in vec2 uv,const in float viewDepth){vec2 uv_=2.*uv-1.;float xe=-(uv_.x+projection[2][0])*viewDepth/projection[0][0];float ye=-(uv_.y+projection[2][1])*viewDepth/projection[1][1];return vec3(xe,ye,viewDepth);}float decodeDepth(const in vec2 uv){vec4 uncodedDepth;
#if DEPTH_PACKING_MODE == 2
uncodedDepth=texture2D(tNormalDepth,uv);
#else
uncodedDepth=texture2D(tDepth,uv);
#endif
#if DEPTH_PACKING_MODE == 0
return uncodedDepth.x;
#elif DEPTH_PACKING_MODE == 1
#if LINEAR_DEPTH == 1
return pow2(unpackRGBAToDepth(uncodedDepth));
#else
return unpackRGBAToDepth(uncodedDepth);
#endif
#else
return pow2(unpack16(uncodedDepth.xy));
#endif
}vec3 getPositionFromOffset(const in vec2 uvOffset){float d=decodeDepth(uvOffset);
#if LINEAR_DEPTH == 0
float centerViewZ=getViewZFromNDCZ(d);return getViewPositionFromViewZ(uvOffset,centerViewZ);
#else
d=mix(-cameraNearFar.x,-cameraNearFar.y,d);return getViewPositionFromViewZ(uvOffset,d);
#endif
}float getCavityAO(){float cutoff=-0.65;float curvature=float(getGBufferFlags(vUv).r)/255.;curvature=2.*curvature-1.;curvature=curvature*4.;float smoothCurvature=smoothstep(0.,1.,curvature-cutoff);smoothCurvature+=saoData.x;smoothCurvature=clamp(smoothCurvature,0.,1.);return 1.-smoothCurvature;}float getOcclusion(const in vec2 uv,const in int id,const in float randomAngle,const in float occlusionSphereRadius,const in vec3 centerPosition,const in vec3 centerNormal){float screenSpaceRadius=(float(id)+mod(randomAngle,1.)+0.5)*INV_NUM_SAMPLES;float angle=screenSpaceRadius*(float(NUM_SPIRAL_TURNS)*6.28318)+randomAngle;screenSpaceRadius=(screenSpaceRadius*occlusionSphereRadius);vec2 uvOffset=uv+floor(screenSpaceRadius*vec2(cos(angle),sin(angle)))/screenSize;
#if CHECK_GBUFFER_FLAG == 1
if(getSelectionBit(getGBufferFlags(uvOffset.xy).a)<1)return 0.;
#endif
vec3 samplePosition=getPositionFromOffset(uvOffset);vec3 direction=samplePosition-centerPosition;float d2=dot(direction,direction)/(saoBiasEpsilon.w*saoBiasEpsilon.w);float ao=max((dot(centerNormal,direction)/saoBiasEpsilon.w-saoBiasEpsilon.x)/(saoBiasEpsilon.z*d2+saoBiasEpsilon.y),0.);return ao;}void main(){float centerDepth;vec3 centerNormal;getDepthNormal(vUv,centerDepth,centerNormal);
#if LINEAR_DEPTH == 0
float centerViewZ=getViewZFromNDCZ(centerDepth);
#else
float centerViewZ=mix(-cameraNearFar.x,-cameraNearFar.y,centerDepth);
#endif
vec3 centerPosition=getViewPositionFromViewZ(vUv,centerViewZ);float occlusionSphereScreenRadius=0.09*saoData.z*saoBiasEpsilon.w/(-centerPosition.z);float randomAngle=6.2*random3(vec3(vUv,frameCount*0.1));float sum=0.;sum+=getOcclusion(vUv,0,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#if NUM_SAMPLES > 1
sum+=getOcclusion(vUv,1,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 2
sum+=getOcclusion(vUv,2,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 3
sum+=getOcclusion(vUv,3,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 4
sum+=getOcclusion(vUv,4,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 5
sum+=getOcclusion(vUv,5,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 6
sum+=getOcclusion(vUv,6,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 7
sum+=getOcclusion(vUv,7,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 8
sum+=getOcclusion(vUv,8,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 9
sum+=getOcclusion(vUv,9,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
#if NUM_SAMPLES > 10
sum+=getOcclusion(vUv,10,randomAngle,occlusionSphereScreenRadius,centerPosition,centerNormal);
#endif
float aoValue=sum*saoData.y*INV_NUM_SAMPLES;float cavityAO=getCavityAO();aoValue=saoData.w>0.?max(aoValue,cavityAO):aoValue;aoValue=clamp(1.-max(aoValue,0.),0.,1.);gl_FragColor.gba=packFloatToRGB(centerDepth);gl_FragColor.r=(vec4(aoValue)).r;}`,ssaoPatch=`#ifndef USE_TRANSMISSION
#if defined(SSAO_ENABLED) && SSAO_ENABLED > 0
float ambientOcclusion=tSSAOMapTexelToLinear(texture2D(tSSAOMap,viewToScreen(vViewPosition.xyz).xy)).r;reflectedLight.indirectDiffuse*=ambientOcclusion;
#if defined( USE_ENVMAP )
float dotNV=saturate(dot(geometryNormal,geometryViewDir));reflectedLight.indirectSpecular*=computeSpecularOcclusion(dotNV,ambientOcclusion,material.roughness);
#endif
#else
#include <aomap_fragment>
#endif
#endif
`,simpleCameraHelpers=`#ifndef SIMPLE_CAMERA_HELPERS
#define SIMPLE_CAMERA_HELPERS 
#ifndef USE_TRANSMISSION
uniform mat4 projectionMatrix;
#endif
vec3 viewToScreen(const in vec3 pos){vec4 projected=projectionMatrix*vec4(pos,1.);return vec3(0.5+0.5*projected.xy/projected.w,projected.w);}
#endif
`,SSAOPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class SSAOPass extends ShaderPass2{constructor(o,l,c){super({defines:{LINEAR_DEPTH:1,NUM_SAMPLES:11,NUM_SPIRAL_TURNS:3,DEPTH_NORMAL_TEXTURE:1,DEPTH_PACKING_MODE:2,PERSPECTIVE_CAMERA:1,CHECK_GBUFFER_FLAG:0},uniforms:{tLastThis:{value:null},tNormalDepth:{value:null},tGBufferFlags:{value:null},screenSize:{value:new three_module.I9Y(512,512)},saoData:{value:new three_module.IUQ},frameCount:{value:0},cameraNearFar:{value:new three_module.I9Y(.1,1e3)},projection:{value:new three_module.kn4},saoBiasEpsilon:{value:new three_module.IUQ(1,1,1,1)},sceneBoundingRadius:{value:0}},vertexShader:defaultVertex,fragmentShader:`

${randomHelpers}

${c}

${ssao}

            `},"tDiffuse"),this.parameters={intensity:.25,occlusionWorldRadius:1,bias:.001,falloff:1.3,useSmallScaleAO:!1,intensitySmallAO:.2,autoRadius:!1,projScale:1},this._smoothEnabled=!0,this.materialExtension={shaderExtender:(u,h,_)=>{u.defines.SSAO_ENABLED&&(u.fragmentShader=shaderReplaceString(u.fragmentShader,"#include <aomap_fragment>",ssaoPatch))},onObjectRender:(u,h,_)=>{var A,w;this.materialExtension.extraUniforms.tSSAOMap.value=(A=this._target)===null||A===void 0?void 0:A.texture;const C=h.materialObject;let M=this.enabled&&_.userData.screenSpaceRendering!==!1&&!(!((w=h.userData)===null||w===void 0)&&w.ssaoDisabled)?1:0;C.defines.SSAO_ENABLED!==M&&(C.defines.SSAO_ENABLED=M,C.needsUpdate=!0),M=this._target.texture,this.materialExtension.extraUniforms.tSSAOMap.value!==M&&(this.materialExtension.extraUniforms.tSSAOMap.value=M,C.needsUpdate=!0)},parsFragmentSnippet:u=>{var h,_;return fe`
             uniform sampler2D tSSAOMap;
             ${getTexelDecoding("tSSAOMap",(_=(h=this._target)===null||h===void 0?void 0:h.texture)===null||_===void 0?void 0:_.colorSpace)}
            ${simpleCameraHelpers}
        `},extraUniforms:{tSSAOMap:{value:null}},computeCacheKey:u=>{var h,_;return this.enabled?"1":"0"+((_=(h=this._target)===null||h===void 0?void 0:h.texture)===null||_===void 0?void 0:_.colorSpace)},isCompatible:u=>{var h;return!(!((h=u.materialObject.userData)===null||h===void 0)&&h.ssaoDisabled)&&u.isMeshStandardMaterial2}},this._renderer=o,this._target=l,this.needsSwap=!1,this.clear=!0,this.bilateralPass=new BilateralFilterPass(this._target,c,"rrrr")}get smoothEnabled(){return this._smoothEnabled}set smoothEnabled(o){this._smoothEnabled=o,this.bilateralPass.enabled=o,this.bilateralPass.uniforms.smoothEnabled.value=o}render(o,l,c,u,h){this.enabled&&(this._updateParameters(),this._renderer.blit(this._target.texture,l,{}),this.uniforms.tLastThis.value=l.texture,super.render(o,this._target,c,u,h),this._smoothEnabled&&this.bilateralPass.render(o,l,c,u,h))}_updateParameters(){const o=this.material.uniforms.saoData.value;o.x=this.parameters.intensitySmallAO,o.y=this.parameters.intensity,o.z=this.parameters.occlusionWorldRadius,o.w=this.parameters.useSmallScaleAO,o.z*=this.parameters.projScale;const l=this.material.uniforms.saoBiasEpsilon.value;if(l.x=this.parameters.bias,l.y=.001,l.z=this.parameters.falloff,this.parameters.autoRadius){const c=this.material.uniforms.sceneBoundingRadius.value;l.w=c}else l.w=1}}SSAOPass_decorate([serialize()],SSAOPass.prototype,"bilateralPass",void 0),SSAOPass_decorate([serialize()],SSAOPass.prototype,"parameters",void 0);class SSAOPlugin extends MultiFilterPlugin{get aoTarget(){return this._aoTarget}constructor(){super(),this.dependencies=[AssetManagerPlugin,GBufferPlugin],this.setDirty=this.setDirty.bind(this),this.updateGBuffer=this.updateGBuffer.bind(this)}async onAdded(o){var l;return o.getPluginByType("Ground")&&console.error("GroundPlugin must be added after SSAOPlugin"),(l=o.getPlugin(GBufferPlugin))===null||l===void 0||l.registerGBufferUpdater(this.updateGBuffer),super.onAdded(o)}updateGBuffer(o,l){var c;if(o instanceof three_module.eaF&&(!((c=o.material)===null||c===void 0)&&c.userData)){const u=o.material.userData.ssaoCastDisabled||o.material.userData.pluginsDisabled,h=u?0:1;l.w=updateBit(l.w,3,h),u&&this.passes.ssao.passObject&&this.passes.ssao.passObject.material.defines.CHECK_GBUFFER_FLAG!==1&&(this.passes.ssao.passObject.material.defines.CHECK_GBUFFER_FLAG=1,this.passes.ssao.passObject.material.needsUpdate=!0)}}createPasses(o){var l,c;return this._aoTarget=o.renderer.createTarget({sizeMultiplier:1}),[makeFilter(o,{passId:"ssao",after:["gbuffer"],before:["render"],required:["render","gbuffer"],passObject:new SSAOPass(o.renderer,this._aoTarget,(c=(l=o.getPlugin(GBufferPlugin))===null||l===void 0?void 0:l.getUnpackSnippet())!==null&&c!==void 0?c:""),update(){var u;const h=Math.max(1,(u=(o==null?void 0:o.scene.activeCamera.modelObject).fov)!==null&&u!==void 0?u:1),_=((o==null?void 0:o.canvas.height)||1)/(2*Math.tan(.5*h*three_module.cj9.DEG2RAD));this.passObject.parameters.projScale=_,this.passObject.bilateralPass.updateShaderProperties([o.getPlugin(GBufferPlugin)])}},()=>[o.getPlugin(GBufferPlugin),o.scene.activeCamera,o.renderer,o.scene])]}async onRemove(o){return o.renderer.disposeTarget(this._aoTarget),super.onRemove(o)}setDirty(){var o;(o=this._viewer)===null||o===void 0||o.setDirty()}get enabled(){var o,l;return((l=(o=this.passes.ssao)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.enabled)||!1}set enabled(o){var l;!((l=this.passes.ssao)===null||l===void 0)&&l.passObject&&(this.passes.ssao.passObject.enabled=o)}get uiConfig(){var o;if(this._uiConfig)return this._uiConfig;const l=this,c=l.passes.ssao.passObject;return this._uiConfig={type:"folder",label:"SS Ambient Occlusion",children:[{type:"checkbox",label:"Enabled",property:[c,"enabled"],onChange:l.setDirty},{type:"checkbox",label:"Enable Cavity",property:[c.parameters,"useSmallScaleAO"],onChange:l.setDirty},{type:"slider",label:"Cavity Brightness",bounds:[0,.5],stepSize:.01,property:[c.parameters,"intensitySmallAO"],onChange:l.setDirty},{type:"slider",label:"Intensity",bounds:[0,5],property:[c.parameters,"intensity"],onChange:l.setDirty},{type:"slider",label:"Radius",bounds:[.1,20],property:[c.parameters,"occlusionWorldRadius"],onChange:l.setDirty},{type:"slider",label:"Bias",bounds:[1e-5,.01],property:[c.parameters,"bias"],onChange:l.setDirty},{type:"slider",label:"Falloff",bounds:[.01,3],property:[c.parameters,"falloff"],onChange:l.setDirty},{type:"slider",label:"Num samples",stepSize:1,bounds:[1,11],property:[(o=c.material)===null||o===void 0?void 0:o.defines,"NUM_SAMPLES"],onChange:[()=>c.material.needsUpdate=!0,l.setDirty]},{type:"checkbox",property:[c.bilateralPass,"smoothEnabled"],onChange:l.setDirty},{type:"checkbox",property:[c.parameters,"autoRadius"],onChange:l.setDirty},{type:"vec4",property:[c.bilateralPass,"edgeSharpness"],onChange:l.setDirty}]}}}SSAOPlugin.PluginType="SSAO";var hdrBloom=`uniform float intensity;uniform float opacity;uniform vec2 tDiffuseSize;varying vec2 vUv;uniform float weight;
#if PASS_STEP == 0
uniform vec4 prefilter;vec4 Prefilter(vec4 c){if(getDepth(vUv)>0.999){return vec4(0.);}float brightness=max(c.r,max(c.g,c.b));float soft=brightness+prefilter.x*(prefilter.y-1.);soft=clamp(soft,0.,prefilter.z);soft=soft*soft*prefilter.w;float contribution=max(soft,brightness-prefilter.x);contribution/=max(brightness,0.001);return vec4(c.rgb*contribution,c.a);}
#endif
vec4 Sample(vec2 uv){return min(vec4(MAX_INTENSITY,MAX_INTENSITY,MAX_INTENSITY,1.),tDiffuseTexelToLinear(texture2D(tDiffuse,uv)));}vec4 SampleBox(vec2 uv,float delta){vec4 o=vec2(-delta,delta).xxyy/tDiffuseSize.xyxy;vec4 s=Sample(uv+o.xy)+Sample(uv+o.zy)+Sample(uv+o.xw)+Sample(uv+o.zw);return s*0.25;}int getBloomBit(in int number){
#ifdef WebGL2Context
return(number/4)%2;
#else
return int(mod(floor(float(number)/4.),2.));
#endif
}void main(){
#if PASS_STEP == 0 
int doBloom=getBloomBit(getGBufferFlags(vUv).a);gl_FragColor=float(doBloom)*weight*Prefilter(SampleBox(vUv,1.));gl_FragColor.a=1.;
#elif PASS_STEP == 1 
gl_FragColor=weight*(SampleBox(vUv,1.));gl_FragColor.a=1.;
#elif PASS_STEP == 2 
gl_FragColor=(SampleBox(vUv,0.5));gl_FragColor.a=1.;
#elif PASS_STEP == 3 
vec4 texel=tSourceTexelToLinear(texture2D(tSource,vUv));vec4 bloom=intensity*SampleBox(vUv,0.5).rgba;float brightness=max(bloom.r,max(bloom.g,bloom.b));texel.rgb+=bloom.rgb;texel.a=min(1.,texel.a+brightness);gl_FragColor=texel;
#elif PASS_STEP == 4 
vec4 texel=vec4(0.);texel.rgb+=intensity*SampleBox(vUv,0.5).rgb;texel.a=1.;gl_FragColor=texel;
#endif
#include <colorspace_fragment>
}`,BloomPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let BloomPass=class extends ShaderPass2{constructor(d=16){super({vertexShader:CopyShader.vertexShader,defines:{PASS_STEP:1,MAX_INTENSITY:Math.min(d,16)},uniforms:{tSource:{value:null},tDiffuse:{value:null},opacity:{value:1},tDiffuseSize:{value:new three_module.I9Y},weight:{value:1},tNormalDepth:{value:null},tGBufferFlags:{value:null}},fragmentShader:unpackGbuffer+`
`+hdrBloom},"tDiffuse","tSource"),this.uiConfig=void 0,this.prefilter=new three_module.IUQ(2,.5,0,0),this.threshold=2,this.softThreshold=.5,this.intensity=.2,this.bloomIterations=4,this.radius=.6,this.power=1,this.bloomDebug=!1,this._weights=[],this._updateWeights=this._updateWeights.bind(this),this._thresholdsUpdated=this._thresholdsUpdated.bind(this),this._updateWeights(),this._thresholdsUpdated(),this.clear=!0,this.userData={setDirty:()=>{this.setDirty()}}}_thresholdsUpdated(){this.prefilter.x=this.threshold,this.prefilter.y=this.softThreshold,this.prefilter.z=2*this.prefilter.x*this.prefilter.y,this.prefilter.w=.125/(this.uniforms.prefilter.value.z+1e-5)}render(d,o,l,c,u){const h=d.baseRenderer;this.material.defines.PASS_STEP=0,this.clear=!0;const _=l;let A=.5,w=_.width*A,C=_.height*A;const M=[];let O=h.getTempTarget({sizeMultiplier:1,type:three_module.ix0});M.push(O);let ne=_;this.material.needsUpdate=!0,this.material.uniforms.weight.value=this._weights[0],super.render(d,O,ne,c,u),ne=O;let ce=1;for(;ce<this.bloomIterations&&(w/=2,C/=2,A/=2,!(C<2||w<2));ce++){O=h.getTempTarget({sizeMultiplier:A,type:three_module.ix0}),M.push(O),this.material.defines.PASS_STEP=1;let ye=this._weights[ce];ye=this._weights[ce-1]!==0?this._weights[ce]/this._weights[ce-1]:this._weights[ce],this.material.uniforms.weight.value=ye,this.material.needsUpdate=!0,super.render(d,O,ne,c,u),ne=O}this.clear=!1;const ue=d.autoClear;for(d.autoClear=!1,ce-=2;ce>=0;ce--)O=M[ce],M[ce]=void 0,this.material.defines.PASS_STEP=2,this.material.transparent=!0,this.material.blending=three_module.EZo,this.material.needsUpdate=!0,d.autoClear=!1,super.render(d,O,ne,c,u),this.material.blending=three_module.XIg,h.releaseTempTarget(ne),ne=O;this.clear=!0,d.autoClear=ue,d.autoClear=!0,this.bloomDebug?(this.material.defines.PASS_STEP=4,this.material.needsUpdate=!0,super.render(d,o,ne,c,u)):(this.uniforms.tSource.value=_.texture,this.material.defines.PASS_STEP=3,this.material.needsUpdate=!0,super.render(d,o,ne,c,u),this.uniforms.tSource.value=null),h.releaseTempTarget(ne)}_updateWeights(){if(!this._weights)return;const d=Math.max(Math.min(this.radius,1),0),o=1/(this.bloomIterations-1);for(let l=0;l<this.bloomIterations;l++){let c=l*o+.1,u=1.2-c;c=Math.pow(c,this.power),u=Math.pow(u,this.power),this._weights[l]=u*(1-d)+c*d}this.setDirty()}};function addBloomData(d){const o=d==null?void 0:d.userData;return!!o&&(o[BloomPlugin.PluginType]||(o[BloomPlugin.PluginType]={}),o[BloomPlugin.PluginType].enable=!0,d.isMaterial&&(d.needsUpdate=!0),!0)}BloomPass_decorate([uniform()],BloomPass.prototype,"prefilter",void 0),BloomPass_decorate([uiSlider("Threshold",[0,2]),x(BloomPass.prototype._thresholdsUpdated),serialize()],BloomPass.prototype,"threshold",void 0),BloomPass_decorate([uiSlider("Soft Threshold",[0,1]),x(BloomPass.prototype._thresholdsUpdated),serialize()],BloomPass.prototype,"softThreshold",void 0),BloomPass_decorate([uiSlider("Intensity",[0,3]),serialize(),uniform()],BloomPass.prototype,"intensity",void 0),BloomPass_decorate([uiSlider("Iterations",[0,7],1),x(BloomPass.prototype._updateWeights),serialize()],BloomPass.prototype,"bloomIterations",void 0),BloomPass_decorate([uiSlider("Radius",[0,1],.01),x(BloomPass.prototype._updateWeights),serialize()],BloomPass.prototype,"radius",void 0),BloomPass_decorate([uiSlider("Power",[.2,10],.01),x(BloomPass.prototype._updateWeights),serialize()],BloomPass.prototype,"power",void 0),BloomPass_decorate([uiToggle("Debug")],BloomPass.prototype,"bloomDebug",void 0),BloomPass=BloomPass_decorate([uiFolder("Bloom")],BloomPass);class BloomPlugin extends GenericFilterPlugin{constructor(){super(...arguments),this.passId="bloom",this._beforeFilters=["combinedPost","screen"],this._afterFilters=["render","progressive"],this._requiredFilters=["render"],this.materialExtension={uuid:esm_browser_v4(),getUiConfig:o=>{if(o.__uiConfigs||(o.__uiConfigs={}),o.__uiConfigs[this.materialExtension.uuid])return o.__uiConfigs[this.materialExtension.uuid];const l=this._getUiConfig(o);return o.__uiConfigs[this.materialExtension.uuid]=l,l},isCompatible:o=>!0}}setDirty(){this.pass.dirty=!0}_getUiConfig(o){const l={type:"folder",label:"Bloom",children:[{type:"checkbox",label:"Enabled",get value(){var c,u;return(u=(c=o.materialObject.userData[BloomPlugin.PluginType])===null||c===void 0?void 0:c.enable)===null||u===void 0||u},set value(c){var u;const h=o.materialObject.userData[BloomPlugin.PluginType];c!==(h==null?void 0:h.enable)&&(h||addBloomData(o.materialObject),o.materialObject.userData[BloomPlugin.PluginType].enable=c,(u=l.uiRefresh)===null||u===void 0||u.call(l,"postFrame",!0))},onChange:this.setDirty}]};return l}passCtor(o){const l=new BloomPass(o.renderer.maxHDRIntensity);return this.updateGBuffer=this.updateGBuffer.bind(this),this.setDirty=this.setDirty.bind(this),l}async onAdded(o){var l,c;await super.onAdded(o),(l=o.getPlugin(GBufferPlugin))===null||l===void 0||l.registerGBufferUpdater(this.updateGBuffer);const u=o.getPlugin(AssetManagerPlugin);(c=u==null?void 0:u.materials)===null||c===void 0||c.registerMaterialExtension(this.materialExtension)}updateGBuffer(o,l){var c,u,h,_;if(o instanceof three_module.eaF&&(!((c=o.material)===null||c===void 0)&&c.userData)){const A=((h=(u=o.material)===null||u===void 0?void 0:u.userData[BloomPlugin.PluginType])===null||h===void 0?void 0:h.enable)===!1||!((_=o.material)===null||_===void 0)&&_.userData.pluginsDisabled?0:1;l.w=updateBit(l.w,2,A)}}_update(o){var l,c;return(l=o.getPlugin(GBufferPlugin))===null||l===void 0||l.updateShaderProperties((c=this.pass)===null||c===void 0?void 0:c.passObject.material),super._update(o)}get uiConfig(){var o;return(o=this.pass)===null||o===void 0?void 0:o.passObject.uiConfig}}BloomPlugin.PluginType="Bloom";var combineDepthOfField=`#include <common>
#include <packing>
varying vec2 vUv;uniform vec2 cocTextureSize;uniform vec2 nearFarBlurScale;uniform vec2 cameraNearFar;uniform vec2 focalDepthRange;uniform vec2 crossCenter;uniform float crossRadius;uniform float crossAlpha;uniform vec3 crossColor;float smoothBoundary(float d,float smooothFactor){smooothFactor*=0.5;float value=smoothstep(-smooothFactor,smooothFactor,d);return value;}float circle(vec2 p,float r){return min((length(p)-r),-(length(p)-r-0.01));}float computeCoc(){float depth=getDepth(vUv);if(depth>1.-0.01)return max(nearFarBlurScale.x,nearFarBlurScale.y);depth=mix(cameraNearFar.x,cameraNearFar.y,depth);float coc=(depth-focalDepthRange.x)/focalDepthRange.y;coc=clamp(coc,-1.,1.);return(coc>0.?coc*nearFarBlurScale.y:coc*nearFarBlurScale.x);}void main(){vec4 blur=blurTextureTexelToLinear(texture2D(blurTexture,vUv));float scale=0.5;blur+=blurTextureTexelToLinear(texture2D(blurTexture,vUv+scale*vec2(1.,1.)/cocTextureSize));blur+=blurTextureTexelToLinear(texture2D(blurTexture,vUv+scale*vec2(-1.,1.)/cocTextureSize));blur+=blurTextureTexelToLinear(texture2D(blurTexture,vUv+scale*vec2(-1.,-1.)/cocTextureSize));blur+=blurTextureTexelToLinear(texture2D(blurTexture,vUv+scale*vec2(1.,-1.)/cocTextureSize));blur/=5.;vec2 uvNearest=(floor(vUv*cocTextureSize)+0.5)/cocTextureSize;float coc=abs(min(2.*cocTextureTexelToLinear(texture2D(cocTexture,uvNearest)).a-1.,computeCoc()));float cocLower=0.005;float cocHigher=0.3;vec4 outColor=vec4(mix(colorTextureTexelToLinear(texture2D(colorTexture,vUv)).rgb,blur.rgb,smoothstep(cocLower,cocHigher,coc)),1.);vec2 d=vUv-crossCenter;if(length(d)>crossRadius+0.05){float dist=circle(d,crossRadius);gl_FragColor=outColor;}else{d.x*=cocTextureSize.x/cocTextureSize.y;float dist=circle(d,crossRadius);dist=smoothBoundary(dist,2.*fwidth(dist));vec4 color=outColor;vec3 dofCircleColor=mix(crossColor,color.rgb,1.-crossAlpha);gl_FragColor=vec4(mix(color.rgb,dofCircleColor,dist),color.a);}
#include <colorspace_fragment>
}`,computeCoCDoF=`#include <common>
#include <packing>
varying vec2 vUv;uniform vec2 nearFarBlurScale;uniform vec2 cameraNearFar;uniform vec2 focalDepthRange;float computeCoc(){float depth=getDepth(vUv);if(depth==1.)return max(nearFarBlurScale.x,nearFarBlurScale.y);depth=mix(cameraNearFar.x,cameraNearFar.y,depth);float coc=(depth-focalDepthRange.x)/focalDepthRange.y;coc=clamp(coc,-1.,1.);return(coc>0.?coc*nearFarBlurScale.y:coc*nearFarBlurScale.x);}void main(){gl_FragColor=vec4(colorTextureTexelToLinear(texture2D(colorTexture,vUv)).rgb,0.5*computeCoc()+0.5);
#include <colorspace_fragment>
}`,expandCoCDoF=`#include <common>
varying vec2 vUv;uniform vec2 colorTextureSize;uniform vec2 direction;uniform vec2 nearFarBlurScale;const float MAXIMUM_BLUR_SIZE=4.;float expandNear(const in vec2 offset,const in bool isBackground){float coc=0.;vec2 sampleOffsets=MAXIMUM_BLUR_SIZE*offset/5.;float coc0=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv)).a-1.;float coc1=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-5.*sampleOffsets)).a-1.;float coc2=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-4.*sampleOffsets)).a-1.;float coc3=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-3.*sampleOffsets)).a-1.;float coc4=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-2.*sampleOffsets)).a-1.;float coc5=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv-1.*sampleOffsets)).a-1.;float coc6=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+1.*sampleOffsets)).a-1.;float coc7=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+2.*sampleOffsets)).a-1.;float coc8=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+3.*sampleOffsets)).a-1.;float coc9=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+4.*sampleOffsets)).a-1.;float coc10=2.*colorTextureTexelToLinear(texture2D(colorTexture,vUv+5.*sampleOffsets)).a-1.;if(isBackground){coc=abs(coc0)*0.095474+(abs(coc1)+abs(coc10))*0.084264+(abs(coc2)+abs(coc9))*0.088139+(abs(coc3)+abs(coc8))*0.091276+(abs(coc4)+abs(coc7))*0.093585+(abs(coc5)+abs(coc6))*0.094998;}else{coc=min(coc0,0.);coc=min(coc1*0.3,coc);coc=min(coc2*0.5,coc);coc=min(coc3*0.75,coc);coc=min(coc4*0.8,coc);coc=min(coc5*0.95,coc);coc=min(coc6*0.95,coc);coc=min(coc7*0.8,coc);coc=min(coc8*0.75,coc);coc=min(coc9*0.5,coc);coc=min(coc10*0.3,coc);if(abs(coc0)>abs(coc))coc=coc0;}return coc;}void main(){vec2 offset=2.*direction/colorTextureSize;bool isBackground=getDepth(vUv)>1.-0.001;float coc=expandNear(offset,isBackground);gl_FragColor=vec4(colorTextureTexelToLinear(texture2D(colorTexture,vUv)).rgb,0.5*coc+0.5);
#include <colorspace_fragment>
}`,boxBlurDoF=`#include <common>
varying vec2 vUv;uniform vec2 colorTextureSize;uniform vec2 direction;const float MAXIMUM_BLUR_SIZE=16.;const float SIGMA=5.;const int NUM_SAMPLES=4;float normpdf(in float x,in float sigma){return 0.39894*exp(-0.5*x*x/(sigma*sigma))/sigma;}vec3 weightedBlur(){float cocIn=2.*cocTextureTexelToLinear(texture2D(cocTexture,vUv)).a-1.;float kernelRadius=MAXIMUM_BLUR_SIZE*cocIn;vec2 invSize=1./colorTextureSize;cocIn*=cocIn*cocIn;float centerSpaceWeight=normpdf(0.,SIGMA)*abs(cocIn);float weightSum=centerSpaceWeight;vec3 centerSample=colorTextureTexelToLinear(texture2D(colorTexture,vUv)).rgb;vec3 diffuseSum=centerSample*weightSum;vec2 delta=invSize*kernelRadius/float(NUM_SAMPLES);for(int i=1;i<=NUM_SAMPLES;i++){float spaceWeight=normpdf(float(i),SIGMA);vec2 texcoord=direction*delta*float(i);vec4 rightSample=colorTextureTexelToLinear(texture2D(colorTexture,vUv+texcoord));vec4 leftSample=colorTextureTexelToLinear(texture2D(colorTexture,vUv-texcoord));float leftCocWeight=abs(2.*cocTextureTexelToLinear(texture2D(cocTexture,vUv-texcoord)).a-1.);float rightCocWeight=abs(2.*cocTextureTexelToLinear(texture2D(cocTexture,vUv+texcoord)).a-1.);leftCocWeight*=leftCocWeight*leftCocWeight;rightCocWeight*=rightCocWeight*rightCocWeight;diffuseSum+=((leftSample.rgb*leftCocWeight)+(rightSample.rgb*rightCocWeight))*spaceWeight;weightSum+=(spaceWeight*(leftCocWeight+rightCocWeight));}return diffuseSum/weightSum;}void main(){gl_FragColor=vec4(weightedBlur(),1.);
#include <colorspace_fragment>
}`,poissonBlurDoF=`#include <common>
varying vec2 vUv;uniform vec2 colorTextureSize;uniform float blurRadius;vec4 CircularBlur(){vec4 color=colorTextureTexelToLinear(texture2D(colorTexture,vUv));
#ifdef DOF_MODE
float blurDist=blurRadius*(2.*color.a-1.);
#else
float blurDist=blurRadius*color.a;
#endif
float rnd=PI2*random3(vec3(vUv,frameCount*0.1));float costheta=cos(rnd);float sintheta=sin(rnd);vec4 rotationMatrix=vec4(costheta,-sintheta,sintheta,costheta);vec3 colorSum=vec3(0.);float weightSum=0.001;vec2 ofs;vec4 sampleColor;setPds();
#pragma unroll_loop_start
for(int i=0;i<16;i++){ofs=poisson_disk_samples[UNROLLED_LOOP_INDEX];ofs=vec2(dot(ofs,rotationMatrix.xy),dot(ofs,rotationMatrix.zw));sampleColor=colorTextureTexelToLinear(texture2D(colorTexture,vUv+blurDist*ofs/colorTextureSize.xy));
#ifdef DOF_MODE
sampleColor.a=abs(sampleColor.a*2.-1.);sampleColor.a*=sampleColor.a*sampleColor.a;
#endif
colorSum+=sampleColor.rgb*sampleColor.a;weightSum+=sampleColor.a;}
#pragma unroll_loop_end
colorSum/=weightSum;return vec4(min(vec3(72.),max(vec3(0.),colorSum)),1.);}void main(){gl_FragColor=CircularBlur();
#include <colorspace_fragment>
}`,poissonDiskSamples="vec2 poisson_disk_samples[16];void setPds(){poisson_disk_samples[0]=vec2(-0.399691779231,0.728591545584);poisson_disk_samples[1]=vec2(-0.48622557676,-0.84016533712);poisson_disk_samples[2]=vec2(0.770309468987,-0.24906070432);poisson_disk_samples[3]=vec2(0.556596796154,0.820359876432);poisson_disk_samples[4]=vec2(-0.933902004071,0.0600539051593);poisson_disk_samples[5]=vec2(0.330144964342,0.207477293384);poisson_disk_samples[6]=vec2(0.289013230975,-0.686749271417);poisson_disk_samples[7]=vec2(-0.0832470893559,-0.187351643125);poisson_disk_samples[8]=vec2(-0.296314525615,0.254474834305);poisson_disk_samples[9]=vec2(-0.850977666059,0.484642744689);poisson_disk_samples[10]=vec2(0.829287915319,0.2345063545);poisson_disk_samples[11]=vec2(-0.773042143899,-0.543741521254);poisson_disk_samples[12]=vec2(0.0561133030864,0.928419742597);poisson_disk_samples[13]=vec2(-0.205799249508,-0.562072714492);poisson_disk_samples[14]=vec2(-0.526991665882,-0.193690188118);poisson_disk_samples[15]=vec2(-0.051789270667,-0.935374050821);}",DepthOfFieldPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const combineDofShader={uniforms:{colorTexture:{value:null},tNormalDepth:{value:null},blurTexture:{value:null},cocTexture:{value:null},cocTextureSize:{value:new three_module.I9Y},cameraNearFar:{value:new three_module.I9Y}},vertexShader:defaultVertex,fragmentShader:unpackGbuffer+`
`+combineDepthOfField};patchShaderEncodingSupport({uniforms:{cocTexture:{value:null},colorTexture:{value:null},colorTextureSize:{value:new three_module.I9Y},direction:{value:new three_module.I9Y}},vertexShader:defaultVertex,fragmentShader:boxBlurDoF},"colorTexture","cocTexture");const dofBlurMaterialPoisson=patchShaderEncodingSupport({uniforms:{colorTexture:{value:null},colorTextureSize:{value:new three_module.I9Y},direction:{value:new three_module.I9Y},frameCount:{value:0},blurRadius:{value:16}},vertexShader:defaultVertex,fragmentShader:randomHelpers+`
`+poissonDiskSamples+`
`+poissonBlurDoF,defines:{DOF_MODE:1}},"colorTexture");class DepthOfFieldPass extends ShaderPass2{constructor(){super(combineDofShader,"colorTexture","cocTexture","blurTexture"),this.dofBlurMaterial=dofBlurMaterialPoisson,this.nearFarBlurScale=new three_module.I9Y(.25,.25),this.focalDepthRange=new three_module.I9Y(.5,1.5),this.crossCenter=new three_module.I9Y(.5,.5),this.crossRadius=.04,this.crossAlpha=1,this.crossColor=new three_module.Q1f(16750848),this.uiConfig={type:"folder",label:"Depth of Field",children:[{type:"checkbox",label:"Enabled",limitedUi:!0,property:[this,"enabled"]},{type:"slider",label:"Depth Range",bounds:[.5,3],property:[this.focalDepthRange,"y"]},{type:"slider",label:"Near Blur scale",bounds:[0,1],property:[this.nearFarBlurScale,"x"]},{type:"slider",label:"Far Blur scale",bounds:[0,1],property:[this.nearFarBlurScale,"y"]}]},this.material.extensions.derivatives=!0,this.computeCocMaterial=patchShaderEncodingSupport({uniforms:{colorTexture:{value:null},tNormalDepth:this.uniforms.tNormalDepth,cameraNearFar:this.uniforms.cameraNearFar,nearFarBlurScale:this.uniforms.nearFarBlurScale,focalDepthRange:this.uniforms.focalDepthRange},vertexShader:defaultVertex,fragmentShader:unpackGbuffer+`
`+computeCoCDoF},"colorTexture"),this.expandCocMaterial=patchShaderEncodingSupport({uniforms:{colorTexture:{value:null},colorTextureSize:{value:new three_module.I9Y},direction:{value:new three_module.I9Y},tNormalDepth:this.uniforms.tNormalDepth,nearFarBlurScale:this.uniforms.nearFarBlurScale},vertexShader:defaultVertex,fragmentShader:unpackGbuffer+`
`+expandCoCDoF},"colorTexture")}render(o,l,c,u,h){if(!this.enabled)return;const _=o.baseRenderer,A={minFilter:three_module.hxR,magFilter:three_module.hxR,type:three_module.ix0,colorSpace:three_module.Zr2,sizeMultiplier:.5,format:three_module.GWd,depthBuffer:!1,generateMipmaps:!1},w=_.getTempTarget(A),C=_.getTempTarget(A);if(this.computeCocMaterial.uniforms.colorTexture.value=c.texture,_.blit(void 0,w,{material:this.computeCocMaterial}),this.expandCocMaterial.uniforms.colorTexture.value=w.texture,this.expandCocMaterial.uniforms.direction.value.set(1,0),_.blit(void 0,C,{material:this.expandCocMaterial}),this.expandCocMaterial.uniforms.colorTexture.value=C.texture,this.expandCocMaterial.uniforms.direction.value.set(0,1),_.blit(void 0,w,{material:this.expandCocMaterial}),this.dofBlurMaterial.uniforms.frameCount)this.dofBlurMaterial.uniforms.colorTexture.value=w.texture,_.blit(void 0,C,{material:this.dofBlurMaterial});else{const M=_.getTempTarget(A);this.dofBlurMaterial.uniforms.cocTexture.value=w.texture,this.dofBlurMaterial.uniforms.colorTexture.value=w.texture,this.dofBlurMaterial.uniforms.direction.value.set(1,0),_.blit(void 0,M,{material:this.dofBlurMaterial}),this.dofBlurMaterial.uniforms.colorTexture.value=M.texture,this.dofBlurMaterial.uniforms.direction.value.set(0,1),_.blit(void 0,C,{material:this.dofBlurMaterial}),_.releaseTempTarget(M)}this.material.uniforms.blurTexture.value=C.texture,this.material.uniforms.cocTexture.value=w.texture,super.render(o,l,c,u,h),_.releaseTempTarget(w),_.releaseTempTarget(C)}}DepthOfFieldPass_decorate([serialize(),uniform()],DepthOfFieldPass.prototype,"nearFarBlurScale",void 0),DepthOfFieldPass_decorate([serialize(),uniform()],DepthOfFieldPass.prototype,"focalDepthRange",void 0),DepthOfFieldPass_decorate([uniform()],DepthOfFieldPass.prototype,"crossCenter",void 0),DepthOfFieldPass_decorate([uniform()],DepthOfFieldPass.prototype,"crossRadius",void 0),DepthOfFieldPass_decorate([uniform()],DepthOfFieldPass.prototype,"crossAlpha",void 0),DepthOfFieldPass_decorate([uniform()],DepthOfFieldPass.prototype,"crossColor",void 0);class AddBlendPass extends ShaderPass2{constructor(o,l=120){super({vertexShader:CopyShader.vertexShader,fragmentShader:fe`
                uniform vec4 weight;
                uniform vec4 weight2;
                varying vec2 vUv;
                void main() {
                    vec4 texel = clamp(weight * tDiffuseTexelToLinear ( texture2D( tDiffuse, vUv ) ) + weight2 * tDiffuse2TexelToLinear ( texture2D( tDiffuse2, vUv ) ), vec4(0), vec4(MAX_INTENSITY));
                    gl_FragColor = texel;
                    #include <colorspace_fragment>
                }
            `,uniforms:{tDiffuse:{value:null},tDiffuse2:{value:o},weight:{value:new three_module.IUQ(1,1,1,1)},weight2:{value:new three_module.IUQ(1,1,1,1)}},defines:{MAX_INTENSITY:l}},"tDiffuse","tDiffuse2"),this.clear=!1,this.needsSwap=!0}set weights2(o){this.uniforms.weight2.value.copy(o)}get weights2(){return this.uniforms.weight2.value}set weights1(o){this.uniforms.weight.value.copy(o)}get weights1(){return this.uniforms.weight.value}set blendTexture(o){this.uniforms.tDiffuse2.value=o}}var ProgressivePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const offsets=[{x:0,y:0},{x:-.5,y:0},{x:-.375,y:-.25},{x:-.1875,y:-.125},{x:-.125,y:-.375},{x:.0625,y:-.0625},{x:.125,y:-.3125},{x:.375,y:-.4375},{x:.3125,y:-.1875},{x:.25,y:.0625},{x:.4375,y:.25},{x:.1875,y:.3125},{x:0,y:.4375},{x:-.0625,y:.1875},{x:-.25,y:.375},{x:-.4375,y:.5},{x:-.3125,y:.125}];class ProgressivePlugin extends MultiFilterPlugin{constructor(o=2*offsets.length){super(),this._lastFrames=new Map,this.enabled=!0,this.jitter=!0,this._hasSetOffset=!1,this.trackedJitterCameras=new Set,this._addSceneObject=l=>{const c=l.object;(c.modelObject||c.lightObject)&&(c.modelObject||c.lightObject).traverse(u=>{var h;!((h=u==null?void 0:u.shadow)===null||h===void 0)&&h.camera&&u.shadow.mapSize&&this.trackedJitterCameras.add([u.shadow.camera,u.shadow.mapSize])})},this._jitterCamera=l=>{var c;const u=l.target;if(this.jitter&&u.renderer.frameCount>1){const h=(A,w)=>{const C={...offsets[u.renderer.frameCount%offsets.length]};A.setViewOffset(w.width,w.height,C.x,C.y,w.width,w.height)},_=u.scene.activeCamera.cameraObject;h(_,{width:u.canvas.clientWidth*u.renderer.displayCanvasScaling,height:u.canvas.clientHeight*u.renderer.displayCanvasScaling}),this.trackedJitterCameras.forEach(A=>h(...A)),this._hasSetOffset=!0,(c=this._viewer)===null||c===void 0||c.renderer.resetShadows()}},this._resetCameraJitter=l=>{const c=l.target;this._hasSetOffset&&(c.scene.activeCamera.cameraObject.clearViewOffset(),this._hasSetOffset=!1)},this.uiConfig=generateUiFolder("Progressive",this),this.maxFrameCount=o}async onAdded(o){return await super.onAdded(o)}async onRemove(o){o.removeEventListener("preRender",this._jitterCamera),o.removeEventListener("postRender",this._resetCameraJitter),o.scene.removeEventListener("addSceneObject",this._addSceneObject),this._lastFrames.forEach(l=>o.renderer.disposeTarget(l)),this._lastFrames.clear(),await super.onRemove(o)}get lastFrame(){var o;return this._lastFrames.get((o=this._viewer)===null||o===void 0?void 0:o.scene.renderCamera.cameraObject.uuid)}getLastFrame(o){return o?this._lastFrames.get(o.cameraObject.uuid):this.lastFrame}createPasses(o){o.addEventListener("preRender",this._jitterCamera),o.addEventListener("postRender",this._resetCameraJitter),o.scene.addEventListener("addSceneObject",this._addSceneObject);const l=this;return[makeFilter(o,{passId:"progressive",get dirty(){var u;return l.jitter&&(((u=l._viewer)===null||u===void 0?void 0:u.renderer.frameCount)||0)<l.maxFrameCount},after:["render"],before:["combinedPost","screen"],required:["render"],passObject:new class extends AddBlendPass{render(u,h,_,A,w){if(l.lastFrame){if(o.renderer.frameCount<1)return this.needsSwap=!1,void((_==null?void 0:_.texture)&&o.renderer.blit(_.texture,l.lastFrame,{}));this.needsSwap=!0,super.render(u,h,_,A,w),o.renderer.blit(h.texture,l.lastFrame,{})}else o.console.error("lastFrame render target undefined")}}(void 0,o.renderer.maxHDRIntensity||120),update(){if(!l.lastFrame&&o.scene.renderCamera&&l._lastFrames.set(o.scene.renderCamera.cameraObject.uuid,o.renderer.composerTarget.clone(!0)),!l.lastFrame)return void console.error("lastFrame render target undefined");let u=1/(Math.max(o.renderer.frameCount,0)+1);this.passObject.weights1.set(u,u,u,u),u=1-u,this.passObject.weights2.set(u,u,u,u),this.passObject.blendTexture=l.lastFrame.texture,this.passObject.material.uniformsNeedUpdate=!0}})]}isConverged(o=!1){var l;return(((l=this._viewer)===null||l===void 0?void 0:l.renderer.frameCount)||0)>=this.maxFrameCount-1+(o?1:0)}updateShaderProperties(o){var l,c;return o.uniforms.tLastFrame&&(o.uniforms.tLastFrame.value=(c=(l=this.lastFrame)===null||l===void 0?void 0:l.texture)!==null&&c!==void 0?c:void 0),this}postFrameConvergedRecordingDelta(o="CanvasRecorder"){const l=this._viewer.getPluginByType(o);return l&&l.isRecording()&&l.convergeMode?this.isConverged(!0)?1/l.videoFrameRate:0:-1}}ProgressivePlugin.PluginType="Progressive",ProgressivePlugin_decorate([serialize(),uiInput("Frame count")],ProgressivePlugin.prototype,"maxFrameCount",void 0),ProgressivePlugin_decorate([serialize(),uiToggle("Jitter")],ProgressivePlugin.prototype,"jitter",void 0);class FrameFadePlugin extends GenericFilterPlugin{async startTransition(o){this._viewer&&this._pass&&!this.isDisabled()&&(this._target||(this._target=this._viewer.renderer.getTempTarget({sizeMultiplier:1,minFilter:three_module.k6q,magFilter:three_module.k6q,colorSpace:this._viewer.renderer.composerTarget.texture.colorSpace})),this._fadeTimeState<500&&(this._toSaveFrame=!0),this._fadeTimeState=Math.max(o,this._fadeTimeState),this._fadeTime=this._fadeTimeState,this.setDirty(),await X(o))}stopTransition(){this._fadeTimeState=0}constructor(){super(),this.passId="frameFade",this._fadeTime=0,this._fadeTimeState=0,this._toSaveFrame=!1,this._beforeFilters=["progressive","taa"],this._afterFilters=["render"],this._requiredFilters=["render","progressive"],this.dependencies=[ProgressivePlugin],this.isEditor=!1,this.fadeOnActiveCameraChange=!0,this.fadeOnMaterialUpdate=!0,this.fadeOnSceneUpdate=!0,this.pointerEnabled=!0,this._fadeCam=o=>o.frameFade!==!1&&!this.isEditor&&this.fadeOnActiveCameraChange&&this.startTransition(o.fadeDuration||1e3),this._fadeMat=o=>{o.frameFade!==!1&&!this.isEditor&&this.fadeOnMaterialUpdate&&this.startTransition(o.fadeDuration||200)},this._fadeScene=o=>{o.frameFade!==!1&&!this.isEditor&&this.fadeOnSceneUpdate&&this.startTransition(o.fadeDuration||500)},this._onPointerMove=o=>{var l;const c=(l=this._viewer)===null||l===void 0?void 0:l.canvas;if(!c)return void(this.pointerEnabled=!1);if(!o.buttons||o.target!==c)return void(this.pointerEnabled=!0);const u=c.getBoundingClientRect(),h=(o.clientX-u.left)/u.width,_=(o.clientY-u.top)/u.height;this.pointerEnabled=h<0||h>1||_<0||_>1},this._disabledBy=[],this.startTransition=this.startTransition.bind(this),this.stopTransition=this.stopTransition.bind(this),this._fadeCam=this._fadeCam.bind(this),this._fadeMat=this._fadeMat.bind(this)}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("activeCameraChange",this._fadeCam),o.scene.addEventListener("activeCameraUpdate",this.stopTransition),o.scene.addEventListener("sceneMaterialUpdate",this._fadeMat),o.scene.addEventListener("sceneUpdate",this._fadeScene),window.addEventListener("pointermove",this._onPointerMove)}async onRemove(o){return o.scene.removeEventListener("activeCameraChange",this._fadeCam),o.scene.removeEventListener("activeCameraUpdate",this.stopTransition),o.scene.removeEventListener("sceneMaterialUpdate",this._fadeMat),o.scene.removeEventListener("sceneUpdate",this._fadeScene),window.removeEventListener("pointermove",this._onPointerMove),super.onRemove(o)}passCtor(o){const l=this,c=o.getPlugin(ProgressivePlugin),u=new class extends AddBlendPass{constructor(){super(...arguments),this._lastTime=0,this._saveNextFrame=!1,this.uiConfig=generateUiFolder("Frame Fade",this)}render(h,_,A,w,C){this.needsSwap=!1;const M=l._target;if(!M||!l.pointerEnabled||!this.enabled||!l.dirty||l._fadeTimeState<.001||o.scene.renderCamera!==o.scene.activeCamera)return;l._toSaveFrame&&(this._saveNextFrame=!0,l._toSaveFrame=!1),this._saveNextFrame&&c.lastFrame&&(o.renderer.blit(c.lastFrame.texture,M),this._lastTime=0,this._saveNextFrame=!1),this.blendTexture=M==null?void 0:M.texture;const O=l._fadeTimeState/l._fadeTime;this.weights2.setScalar(O),this.weights2.w=1,this.weights1.setScalar(1-O),this.weights1.w=1,super.render(h,_,A,w,C),this.needsSwap=!0;const ne=g();this._lastTime<10&&(this._lastTime=ne-10);const ce=ne-this._lastTime;this._lastTime=ne,l._fadeTimeState-=ce}}(void 0,o.renderer.maxHDRIntensity);return u.enabled=!0,u}setDirty(){var o;this.enabled&&((o=this._viewer)===null||o===void 0||o.setDirty())}get dirty(){return this.enabled&&this._fadeTimeState>0}set dirty(o){console.warn("FrameFadePlugin.dirty is readonly")}_update(o){return!!super._update(o)&&(this.isDisabled()&&this.stopTransition(),this._fadeTimeState<1&&(this._toSaveFrame=!1,this._target&&this._viewer&&(this._viewer.renderer.releaseTempTarget(this._target),this._target=void 0)),!0)}get uiConfig(){var o,l;return(l=(o=this.pass)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.uiConfig}disable(o){this._disabledBy.includes(o)||this._disabledBy.push(o)}enable(o){const l=this._disabledBy.indexOf(o);l>=0&&this._disabledBy.splice(l,1)}isDisabled(){return!this.pointerEnabled||this._disabledBy.length>0||!this.enabled}}FrameFadePlugin.PluginType="FrameFade";var DepthOfFieldPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class DepthOfFieldPlugin extends GenericFilterPlugin{passCtor(o){return new DepthOfFieldPass}constructor(o=!0,l=!1){super(),this.passId="depthOfField",this._beforeFilters=["progressive","tonemap","screen"],this._afterFilters=["render"],this._requiredFilters=["render"],this.dependencies=[GBufferPlugin],this.enableEdit=!1,this._focalPointHit=new three_module.Pq0(0,0,0),this.crossFadeTime=200,this._focalPointHitTime=0,this._tempVec=new three_module.Pq0,this.enabled=o,this.enableEdit=l,this._onObjectHit=this._onObjectHit.bind(this),this.setDirty=this.setDirty.bind(this)}setFocalPoint(o,l=!0,c=!1){var u,h;this._focalPointHit.copy(o),l&&((h=(u=this._viewer)===null||u===void 0?void 0:u.getPlugin(FrameFadePlugin))===null||h===void 0||h.startTransition(this._frameFadeTime)),c&&(this._focalPointHitTime=g()),this.setDirty()}getFocalPoint(){return this._focalPointHit}get depthRange(){var o,l;return(l=(o=this.pass)===null||o===void 0?void 0:o.passObject.focalDepthRange.y)!==null&&l!==void 0?l:0}set depthRange(o){this.pass&&(this.pass.passObject.focalDepthRange.y=o),this.setDirty()}get nearBlurScale(){var o,l;return(l=(o=this.pass)===null||o===void 0?void 0:o.passObject.nearFarBlurScale.x)!==null&&l!==void 0?l:0}set nearBlurScale(o){this.pass&&(this.pass.passObject.nearFarBlurScale.x=o),this.setDirty()}get farBlurScale(){var o,l;return(l=(o=this.pass)===null||o===void 0?void 0:o.passObject.nearFarBlurScale.y)!==null&&l!==void 0?l:0}set farBlurScale(o){this.pass&&(this.pass.passObject.nearFarBlurScale.y=o),this.setDirty()}get _frameFadeTime(){return 2.5*this.crossFadeTime}_onObjectHit(o){var l,c;this._pass&&o.intersects.intersect&&this.enabled&&this.enableEdit&&(this._focalPointHit.copy(o.intersects.intersect.point),this._focalPointHitTime=o.time,o.intersects.selectedObject=null,(c=(l=this._viewer)===null||l===void 0?void 0:l.getPlugin(FrameFadePlugin))===null||c===void 0||c.startTransition(this._frameFadeTime),this.setDirty())}async onAdded(o){var l;await super.onAdded(o),(l=o.getPluginByType("Picking"))===null||l===void 0||l.addEventListener("hitObject",this._onObjectHit)}async onRemove(o){var l;return(l=o.getPluginByType("Picking"))===null||l===void 0||l.removeEventListener("hitObject",this._onObjectHit),super.onRemove(o)}setDirty(){var o;(o=this._viewer)===null||o===void 0||o.setDirty()}_update(o){var l,c;if(!super._update(o))return!1;const u=(l=this.pass)===null||l===void 0?void 0:l.passObject;if(!u)return!1;const h=o.getPlugin(GBufferPlugin);h==null||h.updateShaderProperties(u.material),u.dofBlurMaterial.uniforms.frameCount&&((c=o.renderer)===null||c===void 0||c.updateShaderProperties(u.dofBlurMaterial));const _=o.scene.renderCamera;if(!_)return!1;_.cameraObject.updateMatrixWorld(!0),_.updateShaderProperties(u.material),_.cameraObject.getWorldPosition(this._tempVec),this._tempVec.subVectors(this._focalPointHit,this._tempVec),u.focalDepthRange.x=this._tempVec.length(),u.focalDepthRange.x*=_.cameraObject.getWorldDirection(new three_module.Pq0).dot(this._tempVec.normalize());let A=(g()-this._focalPointHitTime)/this.crossFadeTime;if(A=1-Math.min(1,Math.max(0,A)),Math.abs(A-u.crossAlpha)>.01&&(u.crossAlpha=A,this.setDirty()),A>0){const w=this._tempVec.copy(this._focalPointHit).project(_.cameraObject).addScalar(1).divideScalar(2);u.crossCenter.set(w.x,w.y),u.computeCocMaterial.uniformsNeedUpdate=!0,u.expandCocMaterial.uniformsNeedUpdate=!0}return!0}get uiConfig(){var o,l,c,u,h;if(this._uiConfig)return this._uiConfig;const _=(l=(o=this._pass)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.uiConfig;return _?((u=(c=_.children)===null||c===void 0?void 0:c.map(A=>Ee(A)))===null||u===void 0||u.flat(2).forEach(A=>A&&(A.onChange=this.setDirty)),(h=_.children)===null||h===void 0||h.push({type:"checkbox",label:"Enable Edit",limitedUi:!0,property:[this,"enableEdit"]}),this._uiConfig=_,_):{}}}DepthOfFieldPlugin.PluginType="DepthOfField",DepthOfFieldPlugin_decorate([serialize()],DepthOfFieldPlugin.prototype,"enableEdit",void 0),DepthOfFieldPlugin_decorate([serialize("focalPoint")],DepthOfFieldPlugin.prototype,"_focalPointHit",void 0),DepthOfFieldPlugin_decorate([serialize()],DepthOfFieldPlugin.prototype,"crossFadeTime",void 0);var voronoise=`#ifndef VORONOISE_HELPER
#define VORONOISE_HELPER 
float voronoise(in vec2 p,float u,float v){float k=1.+63.*pow(max(0.,1.-v),6.);vec2 i=floor(p);vec2 f=fract(p);vec2 a=vec2(0.,0.);for(int y=-2;y<=2;y++)for(int x=-2;x<=2;x++){vec2 g=vec2(x,y);vec3 o=hash3(i+g)*vec3(u,u,1.);vec2 d=g-f+o.xy;float w=pow(max(0.,1.-smoothstep(0.,1.414,length(d))),k);a+=vec2(o.z*w,w);}return a.x/a.y;}vec3 voronoise3(vec2 p,float u,float v){return vec3(voronoise(p,u,v),voronoise(p+vec2(0.435,0.23),u,v),voronoise(p-vec2(0.83,0.45),u,v));}vec3 voronoiseNormal(vec2 p,float u,float v){return vec3(voronoise(p,u,v),voronoise(p+vec2(0.435,0.23),u,v),1.);}
#endif
`,thinFilmLayer="vec3 incident=normalize(vViewPosition.xyz);float hWeight=1.-dot(normal,incident);vec3 noiseV=voronoise3(vUv.xy*thinColorNoiseParams.xy*60.,thinColorNoiseParams.z,thinColorNoiseParams.w);float hWeight2=1.-dot(normalize(noiseV),incident);vec3 film=hsv2rgb(vec3(fract(hWeight+thinBaseLayerFactors.x),thinBaseLayerFactors.y,thinBaseLayerFactors.z))*thinBaseLayerFactors.a;vec3 film2=hsv2rgb(vec3(fract(hWeight2+thinNoiseLayerFactors.x),thinNoiseLayerFactors.y,thinNoiseLayerFactors.z))*thinNoiseLayerFactors.a;film=(film+film2)/(thinBaseLayerFactors.a+thinNoiseLayerFactors.a);diffuseColor.rgb=mix(diffuseColor.rgb,film,thinFilmFactor);",hsvHelpers=`#ifndef HSV_HELPERS
#define HSV_HELPERS 
vec3 hsv2rgb(vec3 c){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(c.xxx+K.xyz)*6.-K.www);return c.z*mix(K.xxx,clamp(p-K.xxx,0.,1.),c.y);}vec3 rgb2hsv(vec3 c){vec4 K=vec4(0.,-1./3.,2./3.,-1.);vec4 p=c.g<c.b?vec4(c.bg,K.wz):vec4(c.gb,K.xy);vec4 q=c.r<p.x?vec4(p.xyw,c.r):vec4(c.r,p.yzx);float d=q.x-min(q.w,q.y);float e=1.0e-10;return vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x);}
#endif 
`,ThinFilmLayerPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let ThinFilmLayerPlugin=class extends AViewerPlugin{addThinFilmLayer(d){return addThinFilmLayer(d.materialObject)}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFMaterialsThinFilmLayerExtensionImport(o))}constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin],this._defines={},this._uniforms={thinBaseLayerFactors:{value:new three_module.IUQ},thinNoiseLayerFactors:{value:new three_module.IUQ},thinColorNoiseParams:{value:new three_module.IUQ},thinFilmFactor:{value:.8}},this.materialExtension={parsFragmentSnippet:(d,o)=>{var l;return this.enabled&&(!((l=o==null?void 0:o.materialObject.userData._thinFilmLayer)===null||l===void 0)&&l.hasThinFilm)?randomHelpers+`
`+voronoise+`
`+hsvHelpers+`
uniform vec4 thinBaseLayerFactors;
uniform vec4 thinNoiseLayerFactors;
uniform vec4 thinColorNoiseParams;
uniform float thinFilmFactor;
        `:""},shaderExtender:(d,o,l)=>{var c;if(!this.enabled||!(!((c=o.materialObject.userData._thinFilmLayer)===null||c===void 0)&&c.hasThinFilm))return;const u="#glMarker beforeAccumulation";d.fragmentShader=d.fragmentShader.replace(u,thinFilmLayer+u),d.defines.USE_UV=""},onObjectRender:(d,o)=>{var l;const c=(l=o.materialObject.userData)===null||l===void 0?void 0:l._thinFilmLayer;if(!(c!=null&&c.hasThinFilm))return;this._uniforms.thinBaseLayerFactors.value.fromArray(c.baseLayerFactors),this._uniforms.thinNoiseLayerFactors.value.fromArray(c.noiseLayerFactors),this._uniforms.thinColorNoiseParams.value.fromArray(c.colorNoiseParams),this._uniforms.thinFilmFactor.value=c.filmFactor;const u=this.enabled?1:0;o.materialObject.defines.THIN_FILM_LAYER_ENABLED!==u&&(o.materialObject.defines.THIN_FILM_LAYER_ENABLED=u,o.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:d=>{var o,l;return(this.enabled?"1":"0")+(!((l=(o=d.materialObject.userData)===null||o===void 0?void 0:o._thinFilmLayer)===null||l===void 0)&&l.hasThinFilm?"1":"0")},isCompatible:d=>d.isMeshStandardMaterial2||d.isDiamondMaterial,updaters:()=>[],getUiConfig:d=>{const o=this._viewer,l={type:"folder",label:"ThinFilmLayer",children:[{type:"checkbox",label:"Enabled",get value(){var c;return((c=d.materialObject.userData._thinFilmLayer)===null||c===void 0?void 0:c.hasThinFilm)||!1},set value(c){var u,h;c!==((u=d.materialObject.userData._thinFilmLayer)===null||u===void 0?void 0:u.hasThinFilm)&&(c?addThinFilmLayer(d.materialObject)||o.alert("Cannot add thin film."):d.materialObject.userData._thinFilmLayer&&(d.materialObject.userData._thinFilmLayer.hasThinFilm=!1,d.materialObject.needsUpdate=!0),(h=l.uiRefresh)===null||h===void 0||h.call(l,"postFrame",!0))},onChange:this.setDirty},()=>({type:"slider",bounds:[0,1],label:"Intensity",hidden:()=>{var c;return!(!((c=d.materialObject.userData._thinFilmLayer)===null||c===void 0)&&c.hasThinFilm)},property:[d.materialObject.userData._thinFilmLayer,"filmFactor"],onChange:this.setDirty}),()=>({type:"vec4",label:"Base Layer",bounds:[0,1],hidden:()=>{var c;return!(!((c=d.materialObject.userData._thinFilmLayer)===null||c===void 0)&&c.hasThinFilm)},property:[d.materialObject.userData._thinFilmLayer,"baseLayerFactors"],onChange:this.setDirty}),()=>({type:"vec4",label:"Noise Layer",bounds:[0,1],hidden:()=>{var c;return!(!((c=d.materialObject.userData._thinFilmLayer)===null||c===void 0)&&c.hasThinFilm)},property:[d.materialObject.userData._thinFilmLayer,"noiseLayerFactors"],onChange:this.setDirty}),()=>({type:"vec4",label:"Noise Params",bounds:[0,1],hidden:()=>{var c;return!(!((c=d.materialObject.userData._thinFilmLayer)===null||c===void 0)&&c.hasThinFilm)},property:[d.materialObject.userData._thinFilmLayer,"colorNoiseParams"],onChange:this.setDirty})]};return l}},this.setDirty=()=>{var d;(d=this._viewer)===null||d===void 0||d.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(d){var o,l,c,u,h;await super.onAdded(d);const _=d.getPlugin(AssetManagerPlugin);(o=_==null?void 0:_.materials)===null||o===void 0||o.registerMaterialExtension(this.materialExtension),(l=_==null?void 0:_.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=_==null?void 0:_.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(glTFMaterialsThinFilmLayerExtensionExport)}async onRemove(d){var o,l,c,u;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(d)}};function addThinFilmLayer(d){const o=d==null?void 0:d.userData;if(!o)return!1;o._thinFilmLayer||(o._thinFilmLayer={});const l=o._thinFilmLayer;return l.hasThinFilm=!0,l.baseLayerFactors===void 0&&(l.baseLayerFactors=[.3,.6,1,.9]),l.noiseLayerFactors===void 0&&(l.noiseLayerFactors=[.7,.5,.9,.7]),l.colorNoiseParams===void 0&&(l.colorNoiseParams=[.5,.5,.5,.7]),l.filmFactor===void 0&&(l.filmFactor=.3),d.isMaterial&&(d.needsUpdate=!0),!0}ThinFilmLayerPlugin.PluginType="ThinFilmLayerPlugin",ThinFilmLayerPlugin.THIN_FILM_LAYER_GLTF_EXTENSION="WEBGI_materials_thin_film_layer",ThinFilmLayerPlugin_decorate([uiToggle("Enabled",d=>({onChange:d.setDirty})),serialize()],ThinFilmLayerPlugin.prototype,"enabled",void 0),ThinFilmLayerPlugin=ThinFilmLayerPlugin_decorate([uiFolder("ThinFilmLayer Materials")],ThinFilmLayerPlugin);class GLTFMaterialsThinFilmLayerExtensionImport{constructor(o){this.parser=o,this.name=ThinFilmLayerPlugin.THIN_FILM_LAYER_GLTF_EXTENSION}async extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name];return l.userData||(l.userData={}),addThinFilmLayer(l),l.userData._thinFilmLayer=deserializeObject(u,l.userData._thinFilmLayer,!1,{}),Promise.resolve()}}const glTFMaterialsThinFilmLayerExtensionExport=d=>({writeMaterial:(o,l)=>{if(!o.isMeshStandardMaterial||!o.userData._thinFilmLayer||!o.userData._thinFilmLayer.hasThinFilm)return;l.extensions=l.extensions||{};const c=serializeObject(o.userData._thinFilmLayer,!1);l.extensions[ThinFilmLayerPlugin.THIN_FILM_LAYER_GLTF_EXTENSION]=c,d.extensionsUsed[ThinFilmLayerPlugin.THIN_FILM_LAYER_GLTF_EXTENSION]=!0}});function match(d,o){const l=typeof d=="string"?d:d.path;return l===(typeof o=="string"?o:o.path)&&l||typeof d!="string"&&typeof o!="string"&&d.id&&d.id===o.id}class PresetGroup{async apply(o,l,c){var u,h,_,A;if(!l)return void(this.selected=void 0);let w=this.presets.find(C=>match(C,l));return w||(this.presets.push(l),w=l),this.selected=w,typeof w!="string"?(h=(u=o.getManager())===null||u===void 0?void 0:u.importer)===null||h===void 0?void 0:h.importAsset(w,c):(A=(_=o.getManager())===null||_===void 0?void 0:_.importer)===null||A===void 0?void 0:A.importPath(w,c)}addPresets(o){this.presets.push(...o.filter(l=>{const c=this.presets.find(u=>match(u,l));return!c||(typeof c=="string"?(this.presets=this.presets.filter(u=>u!==c),!0):(typeof l=="string"||Object.assign(c,l),!1))}))}clear(){this.selected=void 0}constructor(o){this.presets=[],this.name="",this.selected=void 0,o&&(this.name=o)}}class BackgroundPresetGroup extends PresetGroup{constructor(){super(...arguments),this.name="Background"}async apply(o,l){const c=await super.apply(o,l),u=c==null?void 0:c[0];return u&&(u.colorSpace=three_module.er$,o.scene.background=u,o.scene.backgroundColor=new three_module.Q1f(1,1,1)),u}}class EnvironmentPresetGroup extends PresetGroup{constructor(){super(...arguments),this.name="Environment"}async apply(o,l){const c=await super.apply(o,l),u=c==null?void 0:c[0];return u&&(o.scene.environment=u),u}}class GemEnvironmentPresetGroup extends PresetGroup{constructor(o="envMap"){super(),this.key=o,this.name="GemEnvironment",this.name+=o.split("Map")[1]}async apply(o,l){const c=await super.apply(o,l),u=c==null?void 0:c[0];return S(o.getPluginByType("Diamond"),this.key,u),u}}class PluginPresetGroup extends PresetGroup{async apply(o,l){var c,u;const h=await super.apply(o,l,{processImported:!1});return h?(u=(c=o.getManager())===null||c===void 0?void 0:c.importer)===null||u===void 0?void 0:u.processImported(h):void 0}}class ModelStagePresetGroup extends PresetGroup{constructor(){super(...arguments),this.name="ModelStage"}async apply(o,l){var c;const u=typeof l=="string"?l:l.path;let h=!1;try{h=new URL(u.includes("://")?u:"https://example.com/"+u).pathname.endsWith(".json")}catch{h=u.endsWith(".json")}if(h)return super.apply(o,l);{const _=o.getPluginByType("ModelStagePlugin");return _==null?void 0:_.setModel((c=l.file)!==null&&c!==void 0?c:u)}}}class MaterialLibPresetGroupPresetGroup extends PluginPresetGroup{constructor(){super(...arguments),this.name="MaterialLibraries"}async apply(o,l){const c=await super.apply(o,l);return c&&await o.alert("Material Library successfully imported."),c}}class VJSONPresetGroup extends PresetGroup{constructor(){super(...arguments),this.name="VJSON",this.usePresetCamera=!1,this.usePresetLoadingPlugin=!1,this.usePresetInteractionPlugin=!1,this.usePresetParallaxMappingPlugin=!1,this.usePresetRendererUiPlugin=!1,this.usePresetCameraViewPlugin=!1,this.usePresetMaterialConfiguratorPlugin=!1,this.usePresetSwitchNodePlugin=!1}async apply(o,l){const c=o.scene.activeCamera.toJSON(),u=o.serializePluginsIgnored;o.serializePluginsIgnored=[...u,this.usePresetLoadingPlugin?null:"LoadingScreenPlugin",this.usePresetInteractionPlugin?null:"InteractionPromptPlugin",this.usePresetParallaxMappingPlugin?null:"ReliefParallaxMapping",this.usePresetRendererUiPlugin?null:"RendererParamsUiPlugin",this.usePresetCameraViewPlugin?null:"CameraViews",this.usePresetMaterialConfiguratorPlugin?null:"MaterialConfiguratorPlugin",this.usePresetSwitchNodePlugin?null:"SwitchNodePlugin","FrameFade","GLTFAnimationPlugin","ModelStagePlugin","AssetExporterPlugin"].filter(_=>_);const h=await super.apply(o,l);return o.serializePluginsIgnored=u,this.usePresetCamera||o.scene.activeCamera.fromJSON(c),h}}class PresetLibraryPlugin extends AViewerPlugin{constructor(){super(...arguments),this.toJSON=null,this.enabled=!0,this.presetGroups=[],this.uiConfig={type:"folder",label:"Presets",expanded:!0,limitedUi:!0,children:[()=>this.presetGroups.map(o=>({type:"dropdown",label:o.name,limitedUi:!0,children:[{value:"",label:"none"},...o.presets.map(l=>{var c;return{label:((c=tPresetToString(l))===null||c===void 0?void 0:c.split("/").pop())||"",value:tPresetToString(l)}})],getValue:()=>tPresetToString(o.selected)||"",setValue:l=>{o.apply(this._viewer,o.presets.find(c=>tPresetToString(c)===l))}})),{type:"button",label:"Download Selection",limitedUi:!0,value:()=>{const o=this.exportPresets();me(new File([JSON.stringify(o,null,2)],"preset.template.json",{type:"application/json"}))}},{type:"button",label:"Export Preset Groups",limitedUi:!1,value:()=>{const o=this.exportPresetGroups();me(new File([JSON.stringify(o,null,2)],"presetGroups.json",{type:"application/json"}))}}]}}async onAdded(o){var l,c;await super.onAdded(o),this.presetGroups.push(new BackgroundPresetGroup),this.presetGroups.push(new EnvironmentPresetGroup),this.presetGroups.push(new GemEnvironmentPresetGroup),this.presetGroups.push(new GemEnvironmentPresetGroup("envMap2")),this.presetGroups.push(new GemEnvironmentPresetGroup("envMap3")),this.presetGroups.push(new PluginPresetGroup("Ground")),this.presetGroups.push(new PluginPresetGroup("CameraViews")),this.presetGroups.push(new PluginPresetGroup("MaterialConfiguration")),this.presetGroups.push(new ModelStagePresetGroup),this.presetGroups.push(new MaterialLibPresetGroupPresetGroup),this.presetGroups.push(new VJSONPresetGroup),(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0)}exportPresets(){const o=Object.fromEntries(this.presetGroups.map(l=>[l.name,l.selected?cleanAsset(l.selected):void 0]).filter(([,l])=>l));return o.type=PresetLibraryPlugin.PluginType,o}async fromJSON(o,l){var c,u;if(!super.fromJSON(o,l))return null;const h={...o};if(delete h.type,h.VJSON&&this._viewer){const A=this.presetGroups.find(C=>C.name==="VJSON"),w=A==null?void 0:A.presets;A&&w&&await A.apply(this._viewer,h.VJSON),delete h.VJSON}const _=[];for(const[A,w]of Object.entries(h)){const C=this.presetGroups.find(ne=>ne.name===A),M=C==null?void 0:C.presets;if(!C||!M)continue;const O=w;_.push(C.apply(this._viewer,O))}return await Promise.all(_),(u=(c=this.uiConfig).uiRefresh)===null||u===void 0||u.call(c,"postFrame",!0),this}async loadPresetGroups(o){typeof o=="string"&&o.startsWith("http")&&(o=await fetch(o).then(async l=>l.json()));for(const[l,c]of Object.entries(o)){const u=this.presetGroups.find(h=>h.name===l);u==null||u.addPresets(c)}}exportPresetGroups(){return Object.fromEntries(this.presetGroups.map(o=>[o.name,o.presets.map(cleanAsset)]).filter(([,o])=>o.length>0))}clear(){this.presetGroups.forEach(o=>{o.clear()})}}function tPresetToString(d){return d&&typeof d!="string"?d.path||d.id:d}PresetLibraryPlugin.PluginType="PresetLibraryPlugin";const cleanAsset=d=>(d.preImported&&delete(d={...d}).preImported,d);var grain="vec4 grain(in vec4 color){float x=(vUv.x+4.)*(vUv.y+4.)*(10.);vec4 grain=vec4(mod((mod(x,13.)+1.)*(mod(x,123.)+1.),0.01)-0.005)*grainIntensity;vec4 outColor=color;if(grainMultiply){grain=1.-grain;outColor.rgb=color.rgb*vec3(grain);}else{outColor.rgb=color.rgb+vec3(grain);}return outColor;}",FilmicGrainPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let FilmicGrainExtension=class{constructor(d){this.enabled=!1,this.grainMultiply=!1,this.grainIntensity=10,this.extraUniforms={grainIntensity:{value:1},grainMultiply:{value:1}},this.parsFragmentSnippet=(o,l)=>this.enabled?fe`
            uniform float grainIntensity;
            uniform bool grainMultiply;
            ${grain}
        `:"",this._combinedPostPlugin=d.getPlugin(CombinedPostPlugin),this._setDirty=this._setDirty.bind(this)}shaderExtender(d,o,l){this.enabled&&(d.fragmentShader=shaderReplaceString(d.fragmentShader,"#glMarker",` 
            gl_FragColor = grain(gl_FragColor);
            #glMarker
        `))}onObjectRender(d,o,l){this.enabled&&(this.extraUniforms.grainIntensity.value=this.grainIntensity,this.extraUniforms.grainMultiply.value=this.grainMultiply)}getUiConfig(){return this.uiConfig}computeCacheKey(d){return this.enabled?"1":"0"}isCompatible(d){return!0}_setDirty(){this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){var d;(d=this.__setDirty)===null||d===void 0||d.call(this),this._setDirty()}};FilmicGrainPlugin_decorate([x(FilmicGrainExtension.prototype._setDirty),uiToggle("Enable"),serialize()],FilmicGrainExtension.prototype,"enabled",void 0),FilmicGrainPlugin_decorate([x(FilmicGrainExtension.prototype._setDirty),uiToggle("Multiply"),serialize()],FilmicGrainExtension.prototype,"grainMultiply",void 0),FilmicGrainPlugin_decorate([x(FilmicGrainExtension.prototype._setDirty),uiSlider("Intensity",[0,20],.01,{limitedUi:!0}),serialize()],FilmicGrainExtension.prototype,"grainIntensity",void 0),FilmicGrainExtension=FilmicGrainPlugin_decorate([uiFolder("FilmicGrain")],FilmicGrainExtension);class FilmicGrainPlugin extends GenericExtensionPlugin{constructor(){super()}generateExtension(o){return new FilmicGrainExtension(o)}get intensity(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.grainIntensity)!==null&&l!==void 0?l:1}set intensity(o){this._extension&&(this._extension.grainIntensity=o,this._extension.setDirty())}get multiply(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.grainMultiply)!==null&&l!==void 0&&l}set multiply(o){this._extension&&(this._extension.grainMultiply=o,this._extension.setDirty())}}FilmicGrainPlugin.PluginType="FilmicGrain";class ObjectPicker extends I{get scene(){return this._scene}set scene(o){var l;(l=this._scene)===null||l===void 0||l.removeEventListener("activeCameraChange",this._activeCameraChange),this._scene=o,this._scene.addEventListener("activeCameraChange",this._activeCameraChange)}constructor(o,l,c,u){super(),this.hoverEnabled=!1,this._mouseDownPos=new three_module.I9Y,this._scene=o,this._camera=c??this._scene.activeCamera,this.domElement=l,this._time=this.time,this._mouseDownTime=0,this._mouseUpTime=1,this.selectionCondition=u??(h=>h.userData.userSelectable!==!1&&h.userData.bboxVisible!==!1&&h.material!=null&&h.material.type!=="ShadowMaterial"),this.raycaster=new three_module.tBo,this.mouse=new three_module.I9Y,this._selected=[],this._hovering=[],this.cursorStyles={default:"grab",down:"grabbing"},this._activeCameraChange=this._activeCameraChange.bind(this),this._scene.addEventListener("activeCameraChange",this._activeCameraChange),this.domElement.style.touchAction="none",this.domElement.style.cursor=this.cursorStyles.default,this.domElement.addEventListener("pointermove",h=>this.onPointerMove(h)),this.domElement.addEventListener("pointerleave",h=>this.onPointerLeave(h)),this.domElement.addEventListener("pointerout",h=>this.onPointerLeave(h)),this.domElement.addEventListener("pointercancel",h=>this.onPointerCancel(h)),this.domElement.addEventListener("pointerenter",h=>this.onPointerEnter(h)),this.domElement.addEventListener("pointerdown",h=>this.onPointerDown(h)),this.domElement.addEventListener("pointerup",h=>this.onPointerUp(h))}_activeCameraChange(){this.camera=this._scene.activeCamera}get camera(){return this._camera}set camera(o){this._camera=o}get selectedObject(){return this._selected.length>0?this._selected[0]:null}set selectedObject(o){this._selected.length===1&&this._selected[0]===o||(this._selected=o?Array.isArray(o)?[...o]:[o]:[],this.dispatchEvent({type:"selectedObjectChanged",object:this.selectedObject}))}get hoverObject(){return this._hovering.length>0?this._hovering[0]:null}set hoverObject(o){this._hovering=o?Array.isArray(o)?[...o]:[o]:[],this.dispatchEvent({type:"hoverObjectChanged",object:this.hoverObject})}get time(){return this._time=g(),this._time}get isMouseDown(){return this.mouseDownDeltaTime<0}get mouseDownDeltaTime(){return this._mouseUpTime-this._mouseDownTime}onPointerMove(o){var l,c;o.isPrimary!==!1&&(this.updateMouseFromEvent(o),this.hoverEnabled&&(this.hoverObject=(c=(l=this.checkIntersection())===null||l===void 0?void 0:l.intersects[0].object)!==null&&c!==void 0?c:null))}onPointerLeave(o){o.isPrimary!==!1&&(this.domElement.style.cursor=this.cursorStyles.default,(this.hoverEnabled||this.hoverObject)&&(this.hoverObject=null))}onPointerEnter(o){}onPointerCancel(o){}updateMouseFromEvent(o){const l=this.domElement.getBoundingClientRect();this.mouse.x=(o.clientX-l.x)/l.width*2-1,this.mouse.y=-(o.clientY-l.y)/l.height*2+1}onPointerDown(o){o.isPrimary!==!1&&(this.domElement.style.cursor=this.cursorStyles.down,this._mouseDownTime=this.time,this._mouseDownPos.copy(this.mouse))}onDoubleClick(o){console.log("double click")}onPointerUp(o){if(o.isPrimary===!1)return;this.domElement.style.cursor=this.cursorStyles.default,this._mouseUpTime=this.time;const l=this.mouseDownDeltaTime,c=this._mouseDownPos.distanceTo(this.mouse);l<ObjectPicker.PointerClickMaxTime&&c<ObjectPicker.PointerClickMaxDistance&&this.onPointerClick(o)}onPointerClick(o){if(o.isPrimary===!1)return;this.updateMouseFromEvent(o);const l=this.checkIntersection();l&&this.dispatchEvent({type:"hitObject",time:this._mouseUpTime,intersects:l}),this.selectedObject=(l==null?void 0:l.selectedObject)||null}addPasses(){}checkIntersection(){var o;const l=(o=this._camera)===null||o===void 0?void 0:o.cameraObject;if(!l)return null;this.raycaster.setFromCamera(this.mouse,l);let c=this.raycaster.intersectObject(this._scene.modelRoot.modelObject,!0);const u=[];c=c.filter(C=>!u.includes(C.object.id)&&(u.push(C.object.id),!0));let _,A=null;const w=[];for(const C of c){for(A=C.object,_=C;!(A==null||A.visible&&this.selectionCondition(A));)A=A.parent;A!=null&&w.push(C)}if(c=w,c.length>0){if(A=c[0].object,_=c[0],this._firstHit&&A.id!==this._firstHit.id)A=_.object;else for(let C=0;C<c.length;C++)if(this.selectedObject&&this.selectedObject.id===c[C].object.id){const M=C+1;if(!(M<c.length))return null;_=c[M],A=_.object}this._firstHit=c[0].object}return A&&_&&A?{selectedObject:A,intersect:_,intersects:c,mouse:this.mouse.toArray()}:null}isHovering(){return this.hoverObject!=null}isSelected(){return this.selectedObject!=null}}ObjectPicker.PointerClickMaxTime=200,ObjectPicker.PointerClickMaxDistance=.1;const LineSegmentsGeometry_box=new three_module.NRn,LineSegmentsGeometry_vector=new three_module.Pq0;class LineSegmentsGeometry extends three_module.CmU{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry",this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new three_module.qtW([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new three_module.qtW([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix4(o){const l=this.attributes.instanceStart,c=this.attributes.instanceEnd;return l!==void 0&&(l.applyMatrix4(o),c.applyMatrix4(o),l.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(o){let l;o instanceof Float32Array?l=o:Array.isArray(o)&&(l=new Float32Array(o));const c=new three_module.LuO(l,6,1);return this.setAttribute("instanceStart",new three_module.eHs(c,3,0)),this.setAttribute("instanceEnd",new three_module.eHs(c,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(o){let l;o instanceof Float32Array?l=o:Array.isArray(o)&&(l=new Float32Array(o));const c=new three_module.LuO(l,6,1);return this.setAttribute("instanceColorStart",new three_module.eHs(c,3,0)),this.setAttribute("instanceColorEnd",new three_module.eHs(c,3,3)),this}fromWireframeGeometry(o){return this.setPositions(o.attributes.position.array),this}fromEdgesGeometry(o){return this.setPositions(o.attributes.position.array),this}fromMesh(o){return this.fromWireframeGeometry(new three_module.XJ7(o.geometry)),this}fromLineSegments(o){const l=o.geometry;return this.setPositions(l.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new three_module.NRn);const o=this.attributes.instanceStart,l=this.attributes.instanceEnd;o!==void 0&&l!==void 0&&(this.boundingBox.setFromBufferAttribute(o),LineSegmentsGeometry_box.setFromBufferAttribute(l),this.boundingBox.union(LineSegmentsGeometry_box))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new three_module.iyt),this.boundingBox===null&&this.computeBoundingBox();const o=this.attributes.instanceStart,l=this.attributes.instanceEnd;if(o!==void 0&&l!==void 0){const c=this.boundingSphere.center;this.boundingBox.getCenter(c);let u=0;for(let h=0,_=o.count;h<_;h++)LineSegmentsGeometry_vector.fromBufferAttribute(o,h),u=Math.max(u,c.distanceToSquared(LineSegmentsGeometry_vector)),LineSegmentsGeometry_vector.fromBufferAttribute(l,h),u=Math.max(u,c.distanceToSquared(LineSegmentsGeometry_vector));this.boundingSphere.radius=Math.sqrt(u),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(o){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(o)}}class WireframeGeometry2 extends LineSegmentsGeometry{constructor(o){super(),this.isWireframeGeometry2=!0,this.type="WireframeGeometry2",this.fromWireframeGeometry(new three_module.XJ7(o))}}three_module.fCn.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new three_module.I9Y(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},three_module.zkh.line={uniforms:three_module.LlO.merge([three_module.fCn.common,three_module.fCn.fog,three_module.fCn.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>
		#include <clipping_planes_pars_vertex>

		uniform float linewidth;
		uniform vec2 resolution;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
				vUv = uv;

			#endif

			float aspect = resolution.x / resolution.y;

			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			#ifdef WORLD_UNITS

				worldStart = start.xyz;
				worldEnd = end.xyz;

			#else

				vUv = uv;

			#endif

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec3 ndcStart = clipStart.xyz / clipStart.w;
			vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

			// direction
			vec2 dir = ndcEnd.xy - ndcStart.xy;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			dir = normalize( dir );

			#ifdef WORLD_UNITS

				// get the offset direction as perpendicular to the view vector
				vec3 worldDir = normalize( end.xyz - start.xyz );
				vec3 offset;
				if ( position.y < 0.5 ) {

					offset = normalize( cross( start.xyz, worldDir ) );

				} else {

					offset = normalize( cross( end.xyz, worldDir ) );

				}

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

				// don't extend the line if we're rendering dashes because we
				// won't be rendering the endcaps
				#ifndef USE_DASH

					// extend the line bounds to encompass  endcaps
					start.xyz += - worldDir * linewidth * 0.5;
					end.xyz += worldDir * linewidth * 0.5;

					// shift the position of the quad so it hugs the forward edge of the line
					offset.xy -= dir * forwardOffset;
					offset.z += 0.5;

				#endif

				// endcaps
				if ( position.y > 1.0 || position.y < 0.0 ) {

					offset.xy += dir * 2.0 * forwardOffset;

				}

				// adjust for linewidth
				offset *= linewidth * 0.5;

				// set the world position
				worldPos = ( position.y < 0.5 ) ? start : end;
				worldPos.xyz += offset;

				// project the worldpos
				vec4 clip = projectionMatrix * worldPos;

				// shift the depth of the projected points so the line
				// segments overlap neatly
				vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
				clip.z = clipPose.z * clip.w;

			#else

				vec2 offset = vec2( dir.y, - dir.x );
				// undo aspect ratio adjustment
				dir.x /= aspect;
				offset.x /= aspect;

				// sign flip
				if ( position.x < 0.0 ) offset *= - 1.0;

				// endcaps
				if ( position.y < 0.0 ) {

					offset += - dir;

				} else if ( position.y > 1.0 ) {

					offset += dir;

				}

				// adjust for linewidth
				offset *= linewidth;

				// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
				offset /= resolution.y;

				// select end
				vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

				// back to clip space
				offset *= clip.w;

				clip.xy += offset;

			#endif

			gl_Position = clip;

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

			#include <logdepthbuf_vertex>
			#include <clipping_planes_vertex>
			#include <fog_vertex>

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform float linewidth;

		#ifdef USE_DASH

			uniform float dashOffset;
			uniform float dashSize;
			uniform float gapSize;

		#endif

		varying float vLineDistance;

		#ifdef WORLD_UNITS

			varying vec4 worldPos;
			varying vec3 worldStart;
			varying vec3 worldEnd;

			#ifdef USE_DASH

				varying vec2 vUv;

			#endif

		#else

			varying vec2 vUv;

		#endif

		#include <common>
		#include <color_pars_fragment>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>
		#include <clipping_planes_pars_fragment>

		vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

			float mua;
			float mub;

			vec3 p13 = p1 - p3;
			vec3 p43 = p4 - p3;

			vec3 p21 = p2 - p1;

			float d1343 = dot( p13, p43 );
			float d4321 = dot( p43, p21 );
			float d1321 = dot( p13, p21 );
			float d4343 = dot( p43, p43 );
			float d2121 = dot( p21, p21 );

			float denom = d2121 * d4343 - d4321 * d4321;

			float numer = d1343 * d4321 - d1321 * d4343;

			mua = numer / denom;
			mua = clamp( mua, 0.0, 1.0 );
			mub = ( d1343 + d4321 * ( mua ) ) / d4343;
			mub = clamp( mub, 0.0, 1.0 );

			return vec2( mua, mub );

		}

		void main() {

			#include <clipping_planes_fragment>

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			float alpha = opacity;

			#ifdef WORLD_UNITS

				// Find the closest points on the view ray and the line segment
				vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
				vec3 lineDir = worldEnd - worldStart;
				vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

				vec3 p1 = worldStart + lineDir * params.x;
				vec3 p2 = rayEnd * params.y;
				vec3 delta = p1 - p2;
				float len = length( delta );
				float norm = len / linewidth;

				#ifndef USE_DASH

					#ifdef USE_ALPHA_TO_COVERAGE

						float dnorm = fwidth( norm );
						alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

					#else

						if ( norm > 0.5 ) {

							discard;

						}

					#endif

				#endif

			#else

				#ifdef USE_ALPHA_TO_COVERAGE

					// artifacts appear on some hardware if a derivative is taken within a conditional
					float a = vUv.x;
					float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
					float len2 = a * a + b * b;
					float dlen = fwidth( len2 );

					if ( abs( vUv.y ) > 1.0 ) {

						alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

					}

				#else

					if ( abs( vUv.y ) > 1.0 ) {

						float a = vUv.x;
						float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
						float len2 = a * a + b * b;

						if ( len2 > 1.0 ) discard;

					}

				#endif

			#endif

			vec4 diffuseColor = vec4( diffuse, alpha );

			#include <logdepthbuf_fragment>
			#include <color_fragment>

			gl_FragColor = vec4( diffuseColor.rgb, alpha );

			#include <tonemapping_fragment>
			#include <colorspace_fragment>
			#include <fog_fragment>
			#include <premultiplied_alpha_fragment>

		}
		`};class LineMaterial extends three_module.BKk{constructor(o){super({type:"LineMaterial",uniforms:three_module.LlO.clone(three_module.zkh.line.uniforms),vertexShader:three_module.zkh.line.vertexShader,fragmentShader:three_module.zkh.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(o)}get color(){return this.uniforms.diffuse.value}set color(o){this.uniforms.diffuse.value=o}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(o){o===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(o){this.uniforms.linewidth&&(this.uniforms.linewidth.value=o)}get dashed(){return"USE_DASH"in this.defines}set dashed(o){o===!0!==this.dashed&&(this.needsUpdate=!0),o===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(o){this.uniforms.dashScale.value=o}get dashSize(){return this.uniforms.dashSize.value}set dashSize(o){this.uniforms.dashSize.value=o}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(o){this.uniforms.dashOffset.value=o}get gapSize(){return this.uniforms.gapSize.value}set gapSize(o){this.uniforms.gapSize.value=o}get opacity(){return this.uniforms.opacity.value}set opacity(o){this.uniforms&&(this.uniforms.opacity.value=o)}get resolution(){return this.uniforms.resolution.value}set resolution(o){this.uniforms.resolution.value.copy(o)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(o){this.defines&&(o===!0!==this.alphaToCoverage&&(this.needsUpdate=!0),o===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1))}}const _start=new three_module.Pq0,_end=new three_module.Pq0;class Wireframe extends three_module.eaF{constructor(o=new LineSegmentsGeometry,l=new LineMaterial({color:16777215*Math.random()})){super(o,l),this.isWireframe=!0,this.type="Wireframe"}computeLineDistances(){const o=this.geometry,l=o.attributes.instanceStart,c=o.attributes.instanceEnd,u=new Float32Array(2*l.count);for(let _=0,A=0,w=l.count;_<w;_++,A+=2)_start.fromBufferAttribute(l,_),_end.fromBufferAttribute(c,_),u[A]=A===0?0:u[A-1],u[A+1]=u[A]+_start.distanceTo(_end);const h=new three_module.LuO(u,2,1);return o.setAttribute("instanceDistanceStart",new three_module.eHs(h,1,0)),o.setAttribute("instanceDistanceEnd",new three_module.eHs(h,1,1)),this}}class SelectionWidget extends three_module.YJl{_updater(){const o=this._object;if(o){const l=new Box3B().expandByObject(o,!1);l.getCenter(this.position);const c=l.getBoundingSphere(new three_module.iyt).radius;this.scale.setScalar(c*this.boundingScaleMultiplier),this.setVisible(!0)}else this.setVisible(!1)}constructor(){super(),this.assetType="widget",this.modelObject=this,this._object=null,this.boundingScaleMultiplier=1,this.position.set(0,0,0),this.visible=!1,this.renderOrder=1,this.userData.bboxVisible=!1,this._updater=this._updater.bind(this)}_initGeometry(o){if(this._geometry)return;const l=new WireframeGeometry2(o);this._geometry=l;const c=new LineMaterial({color:"#ff2222",transparent:!0,opacity:.9,linewidth:5,resolution:new three_module.I9Y(1024,1024),dashed:!1,toneMapped:!1}),u=new Wireframe(l,c);u.computeLineDistances(),u.scale.set(1,1,1),u.visible=!0,this.add(u)}setVisible(o){var l;o!==this.visible&&(this.visible=o,(l=this.setDirty)===null||l===void 0||l.call(this,{sceneUpdate:!1}))}attach(o){return this.detach(),o?(this._object=o,this._object.addEventListener("objectUpdate",this._updater),this._updater(),this):this}detach(){var o;return this._object?((o=this._object)===null||o===void 0||o.removeEventListener("objectUpdate",this._updater),this._object=null,this._updater(),this):this}get object(){return this._object}}class BoxSelectionWidget extends SelectionWidget{constructor(){super(),this.boundingScaleMultiplier=1/1.7,this._initGeometry(new three_module.iNn(2,2,2,1,1,1))}_updater(){super._updater();const o=this.object;o&&(new Box3B().expandByObject(o,!1).getSize(this.scale).multiplyScalar(this.boundingScaleMultiplier).clampScalar(.1,100),this.setVisible(!0))}}var PickingPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class PickingPlugin extends AViewerPlugin{get widgetEnabled(){return this._enableWidget}get picker(){return this._picker}setDirty(){var o;(o=this._viewer)===null||o===void 0||o.setDirty()}constructor(o=BoxSelectionWidget,l=!1,c=!0,u=!1){super(),this.enabled=!0,this._enableWidget=!0,this.autoFocus=!1,this._onObjectHit=h=>{this._viewer&&(this.enabled?this.dispatchEvent(h):h.intersects.selectedObject=null)},this._uiConfigChildren=[{label:"Enabled",type:"checkbox",property:[this,"enabled"]},{label:"AutoFocus",type:"checkbox",property:[this,"autoFocus"],onChange:()=>{const h=this.getSelectedObject();this.autoFocus&&h&&this.setSelectedObject(h,!0)}}],o&&(this._widget=new o),l&&console.error("PickingPlugin - controls removed. Use the new TransformControlsPlugin"),this._pickUi=c,this.autoFocus=u}getSelectedObject(){var o;if(this.enabled)return((o=this._picker)===null||o===void 0?void 0:o.selectedObject)||void 0}setSelectedObject(o,l=!1){if(!this.enabled||!this._picker)return;const c=this.autoFocus;this.autoFocus=!1,this._picker.selectedObject=o||null,this.autoFocus=c,(c||l)&&this.focusObject(o)}async onAdded(o){await super.onAdded(o),this._picker=new ObjectPicker(o.scene,o.canvas,void 0,l=>{var c,u;if(!l.material)return!1;let h=l,_=!1;for(;h;){if(!h.visible||(((c=h.userData.iModel)!==null&&c!==void 0?c:h).assetType==="model"&&(_=!0),((u=h.userData.iModel)!==null&&u!==void 0?u:h).assetType==="widget")||h.userData.userSelectable===!1||h.userData.bboxVisible===!1)return!1;h=h.parent}return _}),this._widget&&o.scene.addWidget(this._widget),this._picker.addEventListener("selectedObjectChanged",l=>{var c,u;this.dispatchEvent(l);const h=((c=this._picker)===null||c===void 0?void 0:c.selectedObject)||void 0;if(this._pickUi){const A=h==null?void 0:h.uiConfig,w=this.uiConfig;w.children=[...this._uiConfigChildren],A&&w.children.push(A),(u=w.uiRefresh)===null||u===void 0||u.call(w)}const _=this._widget;_&&this._enableWidget&&(h?_.attach(h):_.detach()),o.setDirty(),this.autoFocus&&this.focusObject(h)}),this._picker.addEventListener("hoverObjectChanged",this.dispatchEvent),this._picker.addEventListener("hitObject",this._onObjectHit),o.scene.addEventListener("select",l=>{l.value===void 0?console.warn("WebGi: e.value must be set for picking, can be null to unselect"):l.value.isObject3D&&this.setSelectedObject(l.value,this.autoFocus||l.focusCamera)}),o.scene.addEventListener("addSceneObject",async l=>{var c,u,h;const _=l.object,A=this.getSelectedObject();if(A&&(_==null?void 0:_.assetType)==="material"&&typeof(A==null?void 0:A.setMaterial)=="function"&&(!((c=A==null?void 0:A.modelObject)===null||c===void 0)&&c.isMesh)&&await o.confirm("Applying material: Apply material to the selected object?")){const w=A.material;if(Array.isArray(w))console.warn("WebGi: Dropping on material array not yet fully supported."),A.setMaterial(_);else{let C=Array.from((u=w==null?void 0:w.userData.__appliedMeshes)!==null&&u!==void 0?u:[]);(C.length>1?!await o.confirm("Applying material: Apply to all objects using this material?"):C.length<1)&&(C=[A]);for(const M of C)M&&((h=M.setMaterial)===null||h===void 0||h.call(M,_))}}}),o.scene.addEventListener("sceneUpdate",l=>{if(!l.hierarchyChanged)return;const c=this.getSelectedObject();let u=!1;c==null||c.traverseAncestors(h=>{h===o.scene.modelObject&&(u=!0)}),u||this.setSelectedObject(void 0)})}async focusObject(o){var l,c,u,h;const _=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("CameraViews");await(_==null?void 0:_.animateToFitObject(o,1.25,1e3,"easeOut",{min:((h=(u=(c=this._viewer)===null||c===void 0?void 0:c.scene.activeCamera.getControls())===null||u===void 0?void 0:u.minDistance)!==null&&h!==void 0?h:.5)+.5,max:50}))}enableWidget(o){var l,c,u;if(this._enableWidget=o,o){const h=((l=this._picker)===null||l===void 0?void 0:l.selectedObject)||void 0;h&&((c=this._widget)===null||c===void 0||c.attach(h))}else(u=this._widget)===null||u===void 0||u.detach()}get uiConfig(){return this._pickUi?this._uiConfig?this._uiConfig:this._uiConfig={type:"panel",label:"Picker",expanded:!0,children:[...this._uiConfigChildren]}:{}}get widget(){return this._widget}}PickingPlugin.PluginType="Picking",PickingPlugin_decorate([serialize()],PickingPlugin.prototype,"enabled",void 0),PickingPlugin_decorate([serialize()],PickingPlugin.prototype,"autoFocus",void 0);var customBumpMat=`#if defined(CUSTOM_BUMP_MAP_ENABLED) && CUSTOM_BUMP_MAP_ENABLED > 0
#if CUSTOM_BUMP_MAP_BICUBIC > 0  
vec4 cubic_cb(float v){vec4 n=vec4(1.,2.,3.,4.)-v;vec4 s=n*n*n;float x=s.x;float y=s.y-4.*s.x;float z=s.z-4.*s.y+6.*s.x;float w=6.-x-y-z;return vec4(x,y,z,w)*(1./6.);}vec4 textureBicubic_cb(sampler2D sampler,vec2 texCoords){vec2 texSize=vec2(textureSize(sampler,0));vec2 invTexSize=1./texSize;texCoords=texCoords*texSize-0.5;vec2 fxy=fract(texCoords);texCoords-=fxy;vec4 xcubic=cubic_cb(fxy.x);vec4 ycubic=cubic_cb(fxy.y);vec4 c=texCoords.xxyy+vec2(-0.5,+1.5).xyxy;vec4 s=vec4(xcubic.xz+xcubic.yw,ycubic.xz+ycubic.yw);vec4 offset=c+vec4(xcubic.yw,ycubic.yw)/s;offset*=invTexSize.xxyy;vec4 sample0=texture(sampler,offset.xz);vec4 sample1=texture(sampler,offset.yz);vec4 sample2=texture(sampler,offset.xw);vec4 sample3=texture(sampler,offset.yw);float sx=s.x/(s.x+s.y);float sy=s.z/(s.z+s.w);return mix(mix(sample3,sample2,sx),mix(sample1,sample0,sx),sy);}
#endif
varying vec2 vCustomBumpUv;uniform sampler2D customBumpMap;uniform float customBumpScale;vec2 dHdxy_fwd_cb(){vec2 dSTdx=dFdx(vCustomBumpUv);vec2 dSTdy=dFdy(vCustomBumpUv);
#if CUSTOM_BUMP_MAP_BICUBIC > 0
float Hll=customBumpScale*textureBicubic_cb(customBumpMap,vCustomBumpUv).x;float dBx=customBumpScale*textureBicubic_cb(customBumpMap,vCustomBumpUv+dSTdx).x-Hll;float dBy=customBumpScale*textureBicubic_cb(customBumpMap,vCustomBumpUv+dSTdy).x-Hll;
#else
float Hll=customBumpScale*texture2D(customBumpMap,vCustomBumpUv).x;float dBx=customBumpScale*texture2D(customBumpMap,vCustomBumpUv+dSTdx).x-Hll;float dBy=customBumpScale*texture2D(customBumpMap,vCustomBumpUv+dSTdy).x-Hll;
#endif
return vec2(dBx,dBy);}
#ifndef USE_BUMPMAP
vec3 perturbNormalArb(vec3 surf_pos,vec3 surf_norm,vec2 dHdxy,float faceDirection){vec3 vSigmaX=dFdx(surf_pos.xyz);vec3 vSigmaY=dFdy(surf_pos.xyz);vec3 vN=surf_norm;vec3 R1=cross(vSigmaY,vN);vec3 R2=cross(vN,vSigmaX);float fDet=dot(vSigmaX,R1)*faceDirection;vec3 vGrad=sign(fDet)*(dHdxy.x*R1+dHdxy.y*R2);return normalize(abs(fDet)*surf_norm-vGrad);}
#endif
#endif
`,CustomBumpMapPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let CustomBumpMapPlugin=class extends AViewerPlugin{enableCustomBump(d,o,l){var c,u;const h=(c=d.materialObject)===null||c===void 0?void 0:c.userData;if(!h)return!1;if(h._hasCustomBump===void 0){const _=h.__appliedMeshes;let A=!0;if(_)for(const{geometry:w}of _)!w||w.attributes.position&&w.attributes.normal&&w.attributes.uv||(A=!1);if(!A)return!1}return h._hasCustomBump=!0,h._customBumpScale=(u=l??h._customBumpScale)!==null&&u!==void 0?u:.001,h._customBumpMap=o??h._customBumpMap,d.materialObject.needsUpdate=!0,!0}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFMaterialsCustomBumpMapExtensionImport(o))}constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin],this.bicubicFiltering=!0,this._defines={CUSTOM_BUMP_MAP_DEBUG:!1,CUSTOM_BUMP_MAP_BICUBIC:!0},this._uniforms={customBumpUvTransform:{value:new three_module.dwI},customBumpScale:{value:.001},customBumpMap:{value:null}},this.materialExtension={parsFragmentSnippet:(d,o)=>this.enabled&&(o!=null&&o.materialObject.userData._hasCustomBump)?customBumpMat:"",shaderExtender:(d,o,l)=>{var c;this.enabled&&o.materialObject.userData._hasCustomBump&&(!((c=o.materialObject.userData)===null||c===void 0)&&c._customBumpMap)&&(d.fragmentShader=shaderReplaceString(d.fragmentShader,"#glMarker beforeAccumulation",`
#if defined(CUSTOM_BUMP_MAP_ENABLED) && CUSTOM_BUMP_MAP_ENABLED > 0
    normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd_cb(), faceDirection );
#endif
                `,{prepend:!0}),d.vertexShader=shaderReplaceString(d.vertexShader,"#include <uv_pars_vertex>",`
#if defined(CUSTOM_BUMP_MAP_ENABLED) && CUSTOM_BUMP_MAP_ENABLED > 0
                varying vec2 vCustomBumpUv;
                uniform mat3 customBumpUvTransform;
#endif
                `,{prepend:!0}),d.vertexShader=shaderReplaceString(d.vertexShader,"#include <uv_vertex>",`
#if defined(CUSTOM_BUMP_MAP_ENABLED) && CUSTOM_BUMP_MAP_ENABLED > 0
                vCustomBumpUv = ( customBumpUvTransform * vec3( uv, 1 ) ).xy;
#endif
                `,{prepend:!0}),d.defines.USE_UV="")},onObjectRender:(d,o)=>{var l;const c=o.materialObject.userData;if(!(c!=null&&c._hasCustomBump))return;const u=d;if(!u.isMesh||!u.geometry)return;const h=!((l=c._customBumpMap)===null||l===void 0)&&l.isTexture?c._customBumpMap:null;this._uniforms.customBumpMap.value=h,this._uniforms.customBumpScale.value=h?c._customBumpScale:0,h&&(h.updateMatrix(),this._uniforms.customBumpUvTransform.value.copy(h.matrix));let _=this.enabled&&h?1:0;o.materialObject.defines.CUSTOM_BUMP_MAP_ENABLED!==_&&(o.materialObject.defines.CUSTOM_BUMP_MAP_ENABLED=_,o.materialObject.needsUpdate=!0),_=+this._defines.CUSTOM_BUMP_MAP_DEBUG,o.materialObject.defines.CUSTOM_BUMP_MAP_DEBUG!==_&&(o.materialObject.defines.CUSTOM_BUMP_MAP_DEBUG=_,o.materialObject.needsUpdate=!0),_=+this._defines.CUSTOM_BUMP_MAP_BICUBIC,o.materialObject.defines.CUSTOM_BUMP_MAP_BICUBIC!==_&&(o.materialObject.defines.CUSTOM_BUMP_MAP_BICUBIC=_,o.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:d=>{var o,l,c;return(this.enabled?"1":"0")+(!((o=d.materialObject.userData)===null||o===void 0)&&o._hasCustomBump?"1":"0")+((c=(l=d.materialObject.userData)===null||l===void 0?void 0:l._customBumpMap)===null||c===void 0?void 0:c.uuid)},isCompatible:d=>d.isMeshStandardMaterial2,updaters:()=>[],getUiConfig:d=>{const o=this._viewer,l=this.enableCustomBump,c={type:"folder",label:"CustomBumpMap",children:[{type:"checkbox",label:"Enabled",get value(){return d.materialObject.userData._hasCustomBump||!1},set value(u){var h;u!==d.materialObject.userData._hasCustomBump&&(u?l(d)||o.alert("One or more geometries cannot be made anisotropic."):(d.materialObject.userData._hasCustomBump=!1,d.materialObject.needsUpdate=!0),(h=c.uiRefresh)===null||h===void 0||h.call(c,"postFrame",!0))},onChange:this.setDirty},{type:"slider",label:"Bump Scale",bounds:[-1,1],hidden:()=>!d.materialObject.userData._hasCustomBump,property:[d.materialObject.userData,"_customBumpScale"],onChange:this.setDirty},{type:"image",label:"Bump Map",hidden:()=>!d.materialObject.userData._hasCustomBump,property:[d.materialObject.userData,"_customBumpMap"],onChange:()=>{d.materialObject.needsUpdate=!0,this.setDirty()}},makeSamplerUi(d.materialObject.userData,"_customBumpMap")]};return c}},this.setDirty=()=>{var d,o,l;(o=(d=this.materialExtension).setDirty)===null||o===void 0||o.call(d),(l=this._viewer)===null||l===void 0||l.setDirty()},this.enableCustomBumpSelected=()=>{var d,o,l;const c=(l=(o=(d=this._viewer)===null||d===void 0?void 0:d.getPlugin(PickingPlugin))===null||o===void 0?void 0:o.getSelectedObject())===null||l===void 0?void 0:l.material;return(c==null?void 0:c.assetType)==="material"&&this.enableCustomBump(c)},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(d){var o,l,c,u,h;await super.onAdded(d);const _=d.getPlugin(AssetManagerPlugin);(o=_==null?void 0:_.materials)===null||o===void 0||o.registerMaterialExtension(this.materialExtension),(l=_==null?void 0:_.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=_==null?void 0:_.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(glTFMaterialsCustomBumpMapExtensionExport)}async onRemove(d){var o,l,c,u,h,_,A,w,C,M,O,ne;(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.removeEventListener("loaderCreate",this._loaderCreate);const ce=(w=(A=(_=(h=d.getPlugin(AssetManagerPlugin))===null||h===void 0?void 0:h.exporter)===null||_===void 0?void 0:_.getExporter("gltf","glb"))===null||A===void 0?void 0:A.extensions)===null||w===void 0?void 0:w.indexOf(glTFMaterialsCustomBumpMapExtensionExport);return ce!==void 0&&ce!==-1&&((ne=(O=(M=(C=d.getPlugin(AssetManagerPlugin))===null||C===void 0?void 0:C.exporter)===null||M===void 0?void 0:M.getExporter("gltf","glb"))===null||O===void 0?void 0:O.extensions)===null||ne===void 0||ne.splice(ce,1)),super.onRemove(d)}};CustomBumpMapPlugin.PluginType="CustomBumpMapPlugin",CustomBumpMapPlugin.CUSTOM_BUMP_MAP_GLTF_EXTENSION="WEBGI_materials_custom_bump_map",CustomBumpMapPlugin_decorate([uiToggle("Enabled",d=>({onChange:d.setDirty})),serialize()],CustomBumpMapPlugin.prototype,"enabled",void 0),CustomBumpMapPlugin_decorate([uiToggle("Bicubic",d=>({onChange:d.setDirty})),matDefine("CUSTOM_BUMP_MAP_BICUBIC",void 0,!0,CustomBumpMapPlugin.prototype.setDirty),serialize()],CustomBumpMapPlugin.prototype,"bicubicFiltering",void 0),CustomBumpMapPlugin_decorate([uiButton("Enable CustomBumpMap",d=>({hidden:()=>{var o;return!(!((o=d._viewer)===null||o===void 0)&&o.getPlugin(PickingPlugin))}}))],CustomBumpMapPlugin.prototype,"enableCustomBumpSelected",void 0),CustomBumpMapPlugin=CustomBumpMapPlugin_decorate([uiFolder("CustomBumpMap Materials")],CustomBumpMapPlugin);class GLTFMaterialsCustomBumpMapExtensionImport{constructor(o){this.parser=o,this.name=CustomBumpMapPlugin.CUSTOM_BUMP_MAP_GLTF_EXTENSION}async extendMaterialParams(o,l){var c;const u=this.parser,h=u.json.materials[o];if(!h.extensions||!h.extensions[this.name])return Promise.resolve();const _=[],A=h.extensions[this.name];l.userData||(l.userData={}),l.userData._hasCustomBump=!0,l.userData._customBumpScale=(c=A.customBumpScale)!==null&&c!==void 0?c:0;const w=A.customBumpMap;return w&&_.push(u.assignTexture(l.userData,"_customBumpMap",w).then(C=>{C.colorSpace=three_module.er$})),Promise.all(_)}}const glTFMaterialsCustomBumpMapExtensionExport=d=>({writeMaterial:(o,l)=>{if(!o.isMeshStandardMaterial||!o.userData._hasCustomBump||(o.userData._customBumpScale||0)<.001)return;l.extensions=l.extensions||{};const c={};if(c.customBumpScale=o.userData._customBumpScale||1,d.checkEmptyMap(o.userData._customBumpMap)){const u={index:d.processTexture(o.userData._customBumpMap)};d.applyTextureTransform(u,o.userData._customBumpMap),c.customBumpMap=u}l.extensions[CustomBumpMapPlugin.CUSTOM_BUMP_MAP_GLTF_EXTENSION]=c,d.extensionsUsed[CustomBumpMapPlugin.CUSTOM_BUMP_MAP_GLTF_EXTENSION]=!0}});var GLTFAnimationPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},GLTFAnimationPlugin_1;let GLTFAnimationPlugin=GLTFAnimationPlugin_1=class extends AViewerPlugin{get animationState(){return this._animationState}get animationTime(){return this._animationTime}get animationDuration(){return this._animationDuration}setTime(d){this._animationTime=Math.max(0,Math.min(d,this._animationDuration))}_wheel({deltaY:d}){this.enabled&&Math.abs(d)>.001&&(this._scrollAnimationState=-1*Math.sign(d))}_drag(d){this.enabled&&this._viewer&&(this.dragAxis==="x"?this._dragAnimationState=d.delta.x*this._viewer.canvas.width/4:this._dragAnimationState=d.delta.y*this._viewer.canvas.height/4)}_postFrame(){var d,o;if(!this._viewer)return;const l=this._viewer,c=this.animateOnScroll,u=this.animateOnDrag;if(!this.enabled||this.animations.length<1||this._animationState!=="playing"&&!c&&!u)return this._lastFrameTime=0,void(this._fadeDisabled&&((d=this._viewer.getPluginByType("FrameFade"))===null||d===void 0||d.enable(GLTFAnimationPlugin_1.PluginType),this._fadeDisabled=!1));if(this._animationTime<1e-4&&this.dispatchEvent({type:"checkpointBegin"}),this.autoIncrementTime){const A=g()/1e3;this._lastFrameTime<1&&(this._lastFrameTime=A-1/30);let w=A-this._lastFrameTime;if(w*=this.animationSpeed,this._lastFrameTime=A,c&&u?w*=et(this._scrollAnimationState,this._dragAnimationState):c?w*=this._scrollAnimationState:u&&(w*=this._dragAnimationState),Math.abs(w)<1e-4)return;const C=(o=this._viewer.getPluginByType("Progressive"))===null||o===void 0?void 0:o.postFrameConvergedRecordingDelta();if(C&&C>0&&(w=C),C===0)return;const M=Math.abs(this.timeScale);this._animationTime+=w*(M>0?M:1)}const h=this._animationTime-this._lastAnimationTime;this._lastAnimationTime=this._animationTime;const _=this.timeScale<0?(isFinite(this._animationDuration)?this._animationDuration:0)-this._animationTime:this._animationTime;if(this.animations.map(A=>{A.mixer.setTime(_)}),!(Math.abs(h)<1e-5)){if(Math.abs(this._scrollAnimationState)<.001?this._scrollAnimationState=0:this._scrollAnimationState*=1-this.scrollAnimationDamping,Math.abs(this._dragAnimationState)<.001?this._dragAnimationState=0:this._dragAnimationState*=1-this.dragAnimationDamping,this.dispatchEvent({type:"animationStep",delta:h,time:_}),l.scene.activeCamera.cameraObject.userData.__animatingCamera&&l.scene.activeCamera.setDirty(),l.scene.refreshActiveCameraNearFar(),l.renderer.resetShadows(),l.setDirty(),!this._fadeDisabled){const A=this._viewer.getPluginByType("FrameFade");A&&(A.disable(GLTFAnimationPlugin_1.PluginType),this._fadeDisabled=!0)}this._animationTime>=this._animationDuration&&this.dispatchEvent({type:"checkpointEnd"})}}constructor(){super(),this.enabled=!0,this._lastAnimationTime=0,this.autoIncrementTime=!0,this.animations=[],this.loopAnimations=!0,this.loopRepetitions=1/0,this.timeScale=1,this.animationSpeed=1,this.animateOnScroll=!1,this._scrollAnimationState=0,this.scrollAnimationDamping=.1,this.animateOnDrag=!1,this.dragAxis="y",this.autoplayOnLoad=!1,this.syncMaxDuration=!1,this._dragAnimationState=0,this.dragAnimationDamping=.3,this.dependencies=[AssetManagerPlugin],this._pointerDragHelper=new Z,this._lastFrameTime=0,this._fadeDisabled=!1,this._objectAdded=d=>{const o=d.object;if(o.assetType!=="model"||!o.modelObject||!this._viewer)return;let l=!1;o.modelObject.traverse(c=>{var u;const h=c.animations;if(h.length<1)return;const _=Math.max(...h.map(C=>C.duration));((u=o.modelObject.userData.gltfAnim_SyncMaxDuration)!==null&&u!==void 0?u:this.syncMaxDuration)&&(h.forEach(C=>C.duration=_),o.modelObject.userData.gltfAnim_SyncMaxDuration=!0);const A=new three_module.Iw4(this._viewer.scene.modelRoot.modelObject),w=h.map(C=>A.clipAction(C).setLoop(this.loopAnimations?three_module.aMy:three_module.G3T,this.loopRepetitions));w.forEach(C=>C.clampWhenFinished=!0),this.animations.push({mixer:A,clips:h,actions:w,duration:_}),l=!0}),l&&(this._onPropertyChange(!this.autoplayOnLoad),this.autoplayOnLoad&&this.playAnimation())},this._animationTime=0,this._animationDuration=0,this._animationState="none",this.uiConfig=void 0,this._lastAnimId="",this.timelineMarkers=[],this._postFrame=this._postFrame.bind(this),this._wheel=this._wheel.bind(this),this.playClips=this.playClips.bind(this),this.playClip=this.playClip.bind(this),this.playAnimation=this.playAnimation.bind(this),this.playPauseAnimation=this.playPauseAnimation.bind(this),this.pauseAnimation=this.pauseAnimation.bind(this),this.stopAnimation=this.stopAnimation.bind(this),this.resetAnimation=this.resetAnimation.bind(this),this._onPropertyChange=this._onPropertyChange.bind(this),this._loaderCreate=this._loaderCreate.bind(this),this._pointerDragHelper.addEventListener("drag",this._drag.bind(this))}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFTimelineMarkersExtensionImport(o,this))}async onAdded(d){var o,l,c,u,h,_;(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),d.scene.addEventListener("addSceneObject",this._objectAdded),(_=(h=(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.exporter)===null||u===void 0?void 0:u.getExporter("gltf","glb"))===null||h===void 0?void 0:h.extensions)===null||_===void 0||_.push(glTFTimelineMarkersExtensionExport),d.addEventListener("postFrame",this._postFrame),window.addEventListener("wheel",this._wheel),this._pointerDragHelper.element=d.canvas;let A=-1;return Object.defineProperty(d.scene.modelRoot,"currentTimelineMarker",{get:()=>A,set:w=>d.scene.modelRoot.dispatchEvent({type:"animationTimelineMarker",marker:this.timelineMarkers[A=w]})}),d.scene.modelRoot.addEventListener("animationTimelineMarker",({marker:w})=>{var C;if(!this._viewer)return;if(!w)return this._viewer.scene.activeCamera=(C=this._viewer)===null||C===void 0?void 0:C.scene.defaultCamera,void this._viewer.setDirty();const M=w.camera;M&&(M.userData.__animatingCamera=!0,this._viewer.scene.activeCamera=this._viewer.createCamera(M))}),super.onAdded(d)}async onRemove(d){for(var o,l;this.animations.length;)this.animations.pop();return d.scene.removeEventListener("addSceneObject",this._objectAdded),(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),d.removeEventListener("postFrame",this._postFrame),window.removeEventListener("wheel",this._wheel),this._pointerDragHelper.element=void 0,super.onRemove(d)}_onPropertyChange(d=!0){this._animationDuration=Math.max(...this.animations.map(({duration:o})=>o))*(this.loopAnimations?this.loopRepetitions:1),this._animationState==="playing"&&d&&this.playAnimation()}onStateChange(){var d,o;(o=(d=this.uiConfig)===null||d===void 0?void 0:d.children)===null||o===void 0||o.map(l=>l&&Ee(l)).flat(2).forEach(l=>{var c;return(c=l==null?void 0:l.uiRefresh)===null||c===void 0?void 0:c.call(l)})}playPauseAnimation(){this._animationState==="playing"?this.pauseAnimation():this.playAnimation()}async playClip(d,o=!1){return this.playClips([d],o)}async playClips(d,o=!1){const l=[];return this.animations.forEach(({actions:c})=>{c.forEach(u=>{d.includes(u.getClip().name)&&l.push(u)})}),this.playAnimation(o,l)}async playAnimation(d=!1,o){var l;if(!this.enabled)return;let c=!1;this._animationState==="playing"&&(this.stopAnimation(!1),c=!0);let u=0;const h=!o;o||(o=[],this.animations.forEach(({mixer:A,actions:w,clips:C})=>{o.push(...w)})),c?this.resetAnimation():this.animationState!=="paused"&&(o.forEach(A=>{A.reset()}),this._animationTime=0);const _=esm_browser_v4();this._lastAnimId=_;for(const A of o)A.setLoop(this.loopAnimations?three_module.aMy:three_module.G3T,this.loopRepetitions),A.play(),u=Math.max(u,A.getClip().duration/Math.abs(A.timeScale));if(this._animationState="playing",(l=this._viewer)===null||l===void 0||l.setDirty(),h){if(!isFinite(this._animationDuration))return;await new Promise((A,w)=>{const C=()=>{this.removeEventListener("checkpointEnd",C),A()};this.addEventListener("checkpointEnd",C)})}else{const A=this.loopAnimations?this.loopRepetitions:1;if(u*=A,!isFinite(u))return;await new Promise((w,C)=>{const M=O=>{O.time>=u&&(this.removeEventListener("animationStep",M),w())};this.addEventListener("animationStep",M)})}_===this._lastAnimId&&this.stopAnimation(d)}pauseAnimation(){var d;this._animationState==="playing"?(this._animationState="paused",(d=this._viewer)===null||d===void 0||d.setDirty()):console.warn("pauseAnimation called when animation was not playing.")}resumeAnimation(){var d;this._animationState==="paused"?(this._animationState="playing",(d=this._viewer)===null||d===void 0||d.setDirty()):console.warn("resumeAnimation called when animation was not paused.")}stopAnimation(d=!1){var o,l;this._animationState="stopped",d?this.resetAnimation():(o=this._viewer)===null||o===void 0||o.setDirty(),this._lastAnimId="",this._viewer&&this._fadeDisabled&&((l=this._viewer.getPluginByType("FrameFade"))===null||l===void 0||l.enable(GLTFAnimationPlugin_1.PluginType),this._fadeDisabled=!1)}resetAnimation(){var d;this._animationState==="stopped"||this._animationState==="none"?(this.animations.forEach(({mixer:o,actions:l,clips:c})=>{o.stopAllAction(),o.setTime(0)}),this._animationTime=0,(d=this._viewer)===null||d===void 0||d.setDirty()):this.stopAnimation(!0)}};GLTFAnimationPlugin.PluginType="GLTFAnimation",GLTFAnimationPlugin.AnimationMarkersExtension="WEBGI_animation_markers",GLTFAnimationPlugin_decorate([serialize()],GLTFAnimationPlugin.prototype,"autoIncrementTime",void 0),GLTFAnimationPlugin_decorate([uiMonitor()],GLTFAnimationPlugin.prototype,"animationState",null),GLTFAnimationPlugin_decorate([uiMonitor()],GLTFAnimationPlugin.prototype,"animationTime",null),GLTFAnimationPlugin_decorate([uiMonitor()],GLTFAnimationPlugin.prototype,"animationDuration",null),GLTFAnimationPlugin_decorate([ze(GLTFAnimationPlugin.prototype._onPropertyChange),uiToggle("Loop",{limitedUi:!0}),serialize()],GLTFAnimationPlugin.prototype,"loopAnimations",void 0),GLTFAnimationPlugin_decorate([ze(GLTFAnimationPlugin.prototype._onPropertyChange),serialize()],GLTFAnimationPlugin.prototype,"loopRepetitions",void 0),GLTFAnimationPlugin_decorate([uiSlider("Timescale",[-2,2],.01),serialize()],GLTFAnimationPlugin.prototype,"timeScale",void 0),GLTFAnimationPlugin_decorate([uiSlider("Speed",[.1,4],.1,{limitedUi:!0}),serialize()],GLTFAnimationPlugin.prototype,"animationSpeed",void 0),GLTFAnimationPlugin_decorate([uiToggle(),serialize()],GLTFAnimationPlugin.prototype,"animateOnScroll",void 0),GLTFAnimationPlugin_decorate([uiToggle(),serialize()],GLTFAnimationPlugin.prototype,"animateOnDrag",void 0),GLTFAnimationPlugin_decorate([uiDropdown("Drag Axis",[{label:"x"},{label:"y"}]),serialize()],GLTFAnimationPlugin.prototype,"dragAxis",void 0),GLTFAnimationPlugin_decorate([uiToggle(),serialize()],GLTFAnimationPlugin.prototype,"autoplayOnLoad",void 0),GLTFAnimationPlugin_decorate([uiToggle("syncMaxDuration(dev)"),serialize()],GLTFAnimationPlugin.prototype,"syncMaxDuration",void 0),GLTFAnimationPlugin_decorate([x(GLTFAnimationPlugin.prototype.onStateChange)],GLTFAnimationPlugin.prototype,"_animationState",void 0),GLTFAnimationPlugin_decorate([uiButton("Play/Pause",d=>({label:()=>d.animationState==="playing"?"Pause":"Play",limitedUi:!0}))],GLTFAnimationPlugin.prototype,"playPauseAnimation",null),GLTFAnimationPlugin_decorate([uiButton("Stop",{limitedUi:!0})],GLTFAnimationPlugin.prototype,"stopAnimation",null),GLTFAnimationPlugin_decorate([uiButton("Reset",{limitedUi:!0})],GLTFAnimationPlugin.prototype,"resetAnimation",null),GLTFAnimationPlugin=GLTFAnimationPlugin_1=GLTFAnimationPlugin_decorate([uiFolder("GLTF Animations")],GLTFAnimationPlugin);class GLTFTimelineMarkersExtensionImport{constructor(o,l){this.parser=o,this.name=GLTFAnimationPlugin.AnimationMarkersExtension,this.plugin=l}async afterRoot(o){var l;let c=[];for(const ne of this.parser.json.scenes||[]){if(!ne.extensions)continue;const ce=ne.extensions[this.name];for(const ue of(ce==null?void 0:ce.markers)||[]){const ye=ue.camera!==void 0?await this.parser.getDependency("camera",ue.camera):void 0;ue.time===void 0&&(ue.time=ue.frame/30,console.error("Update timeline markers plugin for correct times.")),c.push({name:ue.name,frame:ue.frame,time:ue.time,camera:ye})}}if(c.length<1)return;c=c.sort((ne,ce)=>ne.frame-ce.frame);const u=(l=o.scene)!==null&&l!==void 0?l:o.scenes[0];if(!u)return;u.userData.__markers=c;const h=this.plugin.timelineMarkers,_=c.map(ne=>ne.time);let A=h.length;const w=c.map(ne=>A++),C=Math.max(..._)+.01;h.push(...c);const M=new three_module.Hit(".currentTimelineMarker",_,w,three_module.ljd),O=new three_module.tz3("animationTimelineMarker",C,[M]);O.__gltfExport=!1,o.animations.push(O)}}const glTFTimelineMarkersExtensionExport=d=>({afterParse(o){const l=d.json.scenes[d.json.scene||0];l.extensions=l.extensions||{};const c={markers:[]},u=[];if((Array.isArray(o)?o:[o]).forEach(h=>h.traverse(_=>{_.userData.__markers&&u.push(..._.userData.__markers)})),u.sort((h,_)=>h.frame-_.frame),!(u.length<1)){for(const h of u){const _=h.camera;if(_){const A=d.nodeMap.get(_);if(A===void 0){console.warn("Camera not found in gltf export",_,d.nodeMap);continue}const w=d.json.nodes[A].camera;h.camera=w,c.markers.push(h)}}l.extensions[GLTFAnimationPlugin.AnimationMarkersExtension]=c,d.extensionsUsed[GLTFAnimationPlugin.AnimationMarkersExtension]=!0}}});var giPatch=`#if defined(SSRTAO_ENABLED) && SSRTAO_ENABLED > 0
vec4 ssgi=tSSGIMapTexelToLinear(texture2D(tSSGIMap,viewToScreen(vViewPosition.xyz).xy));float ambientOcclusion=1.-ssgi.a;ambientOcclusion=max(0.,ambientOcclusion);ambientOcclusion=pow(ambientOcclusion,ssaoPower);ambientOcclusion=min(1.,ambientOcclusion);reflectedLight.indirectDiffuse*=ambientOcclusion;
#if defined(SSGI_ENABLED) && SSGI_ENABLED > 0
vec3 ssgiColor=ssgi.rgb*ssgiIntensity;reflectedLight.indirectDiffuse+=ssgiColor*(material.diffuseColor.rgb);
#endif
#if defined( USE_ENVMAP )
float dotNV=saturate(dot(geometryNormal,geometryViewDir));float specularOcclusion=saturate(pow(dotNV+ambientOcclusion,exp2(-16.*material.roughness-1.))-1.+ambientOcclusion);reflectedLight.indirectSpecular*=specularOcclusion;
#if defined(SSGI_ENABLED) && SSGI_ENABLED > 0
#if !defined(SSR_ENABLED) || SSR_ENABLED < 1
reflectedLight.indirectSpecular+=ssgiColor*material.specularColor;
#endif
#endif
#endif
#endif
`,cameraHelpers=`#ifndef BASIC_CAMERA_HELPERS
#define BASIC_CAMERA_HELPERS 
uniform vec2 cameraNearFar;uniform vec3 cameraPositionWorld;uniform mat4 projection;
#ifndef THREE_PACKING_INCLUDED
#define THREE_PACKING_INCLUDED 
#include <packing>
#endif
float linstep(float edge0,float edge1,float value){return clamp((value-edge0)/(edge1-edge0),0.,1.);}float depthToViewZ(const in float depth){return(depth>0.999)?-cameraNearFar.y*1000.:-mix(cameraNearFar.x,cameraNearFar.y,depth);}float viewZToDepth(const in float viewZ){return linstep(-cameraNearFar.x,-cameraNearFar.y,viewZ);}vec4 viewToScreen3(const in vec3 pos){vec4 projected=projection*vec4(pos,1.);projected.z=pos.z;projected.w=1./projected.w;projected.xyz*=projected.w;projected.xy=0.5+0.5*projected.xy;return projected;}vec3 screenToView(const in vec2 uv,const in float viewZ){vec2 uv_=2.*uv-1.;float xe=-(uv_.x+projection[2][0])*viewZ/projection[0][0];float ye=-(uv_.y+projection[2][1])*viewZ/projection[1][1];return vec3(xe,ye,viewZ);}
#endif
`,samplePointHelpers=`#define PI  3.141592653589793
mat3 GetTangentBasis(vec3 TangentZ){vec3 up=vec3(0.,0.,1.);vec3 TangentX=normalize(cross(dot(TangentZ,up)<0.8?up:vec3(1.,0.,0.),TangentZ));vec3 TangentY=cross(TangentZ,TangentX);return mat3(TangentX,TangentY,TangentZ);}vec4 CosineSampleHemisphere(vec2 E){float Phi=2.*PI*E.x;float CosTheta=sqrt(E.y);float SinTheta=sqrt(1.-CosTheta*CosTheta);vec3 H;H.x=SinTheta*cos(Phi);H.y=SinTheta*sin(Phi);H.z=CosTheta;float PDF=CosTheta*(1./PI);return vec4(H,PDF);}vec4 UniformSampleHemisphere(vec2 E){float Phi=2.*PI*E.x;float CosTheta=E.y;float SinTheta=sqrt(1.-CosTheta*CosTheta);vec3 H;H.x=SinTheta*cos(Phi);H.y=SinTheta*sin(Phi);H.z=CosTheta;float PDF=1./(2.*PI);return vec4(H,PDF);}vec2 UniformSampleDiskConcentric(vec2 E){vec2 p=2.*E-1.;float Radius;float Phi;if(abs(p.x)>abs(p.y)){Radius=p.x;Phi=(PI/4.)*(p.y/p.x);}else{Radius=p.y;Phi=(PI/2.)-(PI/4.)*(p.x/p.y);}return vec2(Radius*cos(Phi),Radius*sin(Phi));}vec2 UniformSampleDiskConcentricApprox(vec2 E){vec2 sf=E*sqrt(2.)-sqrt(0.5);vec2 sq=sf*sf;float root=sqrt(2.*max(sq.x,sq.y)-min(sq.x,sq.y));if(sq.x>sq.y){sf.x=sf.x>0.?root:-root;}else{sf.y=sf.y>0.?root:-root;}return sf;}`,ssrt=`#ifndef SSRT_PARS_SNIP
#define SSRT_PARS_SNIP 
#define pow2(a)a*a
float getDepth2(const in vec2 uv,const in float lod){float viewDepth=getDepth(uv);return depthToViewZ(viewDepth);}
#define LOD_DEPTH  1.0
#define LOD_COLOR  5.0
void _traceRay(in vec4 ray_origin,in vec4 ray_dir,in float tolerance,inout vec3 state,in int loopMax,in float iStepCount){vec4 sample_uv;float d,hit;float dLod=0.;
#pragma unroll_loop_start
for(int i=0;i<8;i++){if(UNROLLED_LOOP_INDEX<loopMax){sample_uv=ray_origin+ray_dir*state.y;d=getDepth2(sample_uv.xy,dLod);d=sample_uv.z/sample_uv.w-d;if(abs(d+tolerance)<tolerance){hit=clamp(state.x/(state.x-d),0.,1.)-1.;hit=(state.y+hit*iStepCount);state.z=min(state.z,hit);}state.x=d;state.y+=1.*iStepCount;}}
#pragma unroll_loop_end
}vec3 traceRay(in vec3 ray_origin_view,in vec3 ray_dir_view,in float tolerance,inout vec3 state,in int _STEP_COUNT){vec4 sample_uv;vec4 ray_origin=viewToScreen3(ray_origin_view);vec3 ray_end_view=ray_origin_view+ray_dir_view;vec4 ray_dir=viewToScreen3(ray_end_view);vec2 clamp_end=clamp(ray_dir.xy,vec2(0.),vec2(1.));vec2 correction=abs(ray_dir.xy-clamp_end);correction=(step(0.01,correction)*correction/(abs(clamp_end-ray_origin.xy)+0.01))+1.;correction.x=1./min(max(correction.y,correction.x),10.);ray_dir=ray_dir-ray_origin;ray_dir.xyw*=correction.x;float iStepCount=1./float(_STEP_COUNT);tolerance*=0.125;_traceRay(ray_origin,ray_dir,tolerance,state,_STEP_COUNT,iStepCount);if(_STEP_COUNT>8&&state.z>0.98)_traceRay(ray_origin,ray_dir,tolerance,state,_STEP_COUNT-8,iStepCount);if(_STEP_COUNT>15&&state.z>0.98)_traceRay(ray_origin,ray_dir,tolerance,state,_STEP_COUNT-16,iStepCount);if(_STEP_COUNT>23&&state.z>0.98)_traceRay(ray_origin,ray_dir,tolerance,state,_STEP_COUNT-16,iStepCount);sample_uv=ray_origin+ray_dir*state.z;sample_uv.z/=sample_uv.w;state.z=state.z<0.999?state.z:9999999.;return sample_uv.xyz;}
#endif
`,basicHelpers=`#ifndef BASIC_HELPERS
#define BASIC_HELPERS 
float saturate2(float v,float mx){return max(0.,min(mx,v));}vec3 saturate2(vec3 v){return max(vec3(0.),min(vec3(1.),v));}
#endif
`,ssrtao=`varying vec2 vUv;uniform float frameCount2;uniform float intensity;uniform float objectRadius;uniform float rayCount;uniform float power;uniform float bias;uniform float falloff;uniform float tolerance;uniform bool autoRadius;uniform vec2 screenSize;vec3 ComputeUniformL(vec3 N,vec2 E){vec3 L;L.xy=E;L.z=interleavedGradientNoise(gl_FragCoord.xy,frameCount2*5.);L=L*2.-1.;return L;}vec2 GetRandomE(float seed){vec2 rand_e;rand_e.x=random3(vec3(gl_FragCoord.xy,frameCount2+seed));rand_e.y=random3(vec3(gl_FragCoord.yx,rand_e.x+(frameCount2)*7.));return rand_e;}vec4 calculateGI(in float seed,in vec3 screenPos,in vec3 normal,in float radiusFactor){vec3 viewPos=screenToView(screenPos.xy,screenPos.z);normal=normalize(normal);vec2 E=GetRandomE(seed);vec3 L=ComputeUniformL(normal,E);L=normalize(L);L*=sign(dot(L,normal));float cameraDist=length(cameraPositionWorld);float rayLen=autoRadius?length(viewPos-screenToView(screenPos.xy+objectRadius/10.,screenPos.z)):mix((cameraNearFar.y)+viewPos.z,-viewPos.z-cameraNearFar.x,L.z*0.5+0.5)*objectRadius;rayLen*=radiusFactor;float r=interleavedGradientNoise(gl_FragCoord.xy,frameCount2*14.+seed)+0.05;rayLen=max(rayLen,0.001);vec3 state=vec3(1.,(r+0.5)/float(RTAO_STEP_COUNT),2.);viewPos+=normal*max(-0.01*viewPos.z,0.001);vec3 screenHitP=traceRay(viewPos,L*rayLen,tolerance*rayLen,state,RTAO_STEP_COUNT);vec3 viewHitP=screenToView(screenHitP.xy,screenHitP.z);vec3 LRes=viewHitP-viewPos;if(state.z>1.)LRes=vec3(9999999.);float dist=length(LRes)*falloff;float EPS=0.01;float zBias=(viewPos.z)*bias;float ao=(max(dot(normal,L)+zBias,0.))/(dist*dist+EPS);
#if defined(SSGI_ENABLED) && SSGI_ENABLED > 0
vec3 hitColor=tLastFrameTexelToLinear(texture2D(tLastFrame,screenHitP.xy)).rgb;vec3 hitNormal=getViewNormal(screenHitP.xy);float giWeight=1.;giWeight=saturate2(giWeight/(dist+EPS),1.);giWeight*=saturate2((dot(normal,L)),1.);giWeight*=saturate2((dot(hitNormal,-L)),1.);return vec4(hitColor*giWeight,ao);
#endif
return vec4(0,0,0,ao);}float normpdf(in float x,in float sigma){return exp(-0.5*x*x/(sigma*sigma));}vec4 getLastThis(sampler2D tex,float depth,vec3 normal){vec2 direction=vec2(1,1);vec4 color=clamp(tLastThisTexelToLinear(texture2D(tex,vUv.xy)),0.,5.);return color;}void main(){float depth;vec3 normal;getDepthNormal(vUv,depth,normal);if(depth>0.99){discard;gl_FragColor=getLastThis(tLastThis,depth,normal);return;}float viewZ=depthToViewZ(depth);vec3 screenPos=vec3(vUv.x,vUv.y,viewZ);vec4 gi=vec4(0.);gi+=calculateGI(8.,screenPos,normal,1.);if(rayCount>1.5)gi=max(gi,calculateGI(2.,screenPos,normal,0.4));if(rayCount>2.5)gi=max(gi,calculateGI(3.,screenPos,normal,1.5));if(rayCount>3.5)gi=max(gi,calculateGI(1.,screenPos,normal,0.6));if(rayCount>4.5)gi=max(gi,calculateGI(3.,screenPos,normal,1.));gi.a=min(1.,gi.a);gi.a=max(0.,gi.a);gi.rgb=min(vec3(3.),gi.rgb);gi.rgb=max(vec3(0.),gi.rgb);if(frameCount2<3.){gl_FragColor=gi;return;}gl_FragColor=(texture2D(tLastThis,vUv));gl_FragColor=((gi+(gl_FragColor)*frameCount2)/(frameCount2+1.));}`,SSRTAOPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class SSRTAOPass extends ShaderPass2{get ssgiEnabled(){return parseInt(this.material.defines.SSGI_ENABLED)>.5}set ssgiEnabled(o){o=o&&this._giActivated,this.material.defines.SSGI_ENABLED=o?1:0,this.material.needsUpdate=!0}constructor(o,l,c,u=!1){super({vertexShader:defaultVertex,fragmentShader:`

${basicHelpers}
${cameraHelpers}
${randomHelpers}
${samplePointHelpers}
${c}

${ssrt}

${ssrtao}

            `,uniforms:{tLastThis:{value:null},tDiffuse:{value:null},tNormalDepth:{value:null},tLastFrame:{value:null},opacity:{value:1},intensity:{value:2.14},rayCount:{value:.1},objectRadius:{value:1},autoRadius:{value:!u},power:{value:1.1},bias:{value:.015},falloff:{value:.7},tolerance:{value:1.5},frameCount:{value:0},frameCount2:{value:0},projection:{value:new three_module.kn4},screenSize:{value:new three_module.I9Y},cameraPositionWorld:{value:new three_module.Pq0},cameraNearFar:{value:new three_module.I9Y(.1,1e3)}},defines:{PERSPECTIVE_CAMERA:1,SSGI_ENABLED:u?1:0}},"tDiffuse","tLastFrame","tLastThis"),this.materialExtension={shaderExtender:(h,_,A)=>{var w;if(!h.defines.SSRTAO_ENABLED)return;this.materialExtension.extraUniforms.tSSGIMap.value=(w=this._target)===null||w===void 0?void 0:w.texture;const C=_.materialObject;let M=this.material.defines.SSGI_ENABLED;C.defines.SSGI_ENABLED!==M&&(C.defines.SSGI_ENABLED=M,C.needsUpdate=!0),M=this._target.texture,this.materialExtension.extraUniforms.tSSGIMap.value!==M&&(this.materialExtension.extraUniforms.tSSGIMap.value=M,C.needsUpdate=!0);const O="vec3 totalDiffuse =",ne=`
            
            ${giPatch}
            
            // reflectedLight.directDiffuse = vec3(0.);
            // reflectedLight.indirectDiffuse = vec3(0.);
            // reflectedLight.directSpecular = vec3(0.);
            // reflectedLight.indirectSpecular = vec3(0.);
            
            `;h.fragmentShader=h.fragmentShader.replace(O,`
${ne}
${O}`),h.fragmentShader=h.fragmentShader.replace("#include <aomap_fragment>",""),h.defines.USE_UV=""},onObjectRender:(h,_,A)=>{var w,C,M;const O=_.materialObject,ne=!O.transparent&&O.transmission<.001,ce=this.enabled&&ne&&(this.renderWithCamera||this._renderer.frameCount>1)&&A.userData.screenSpaceRendering!==!1&&!(!((w=O.userData)===null||w===void 0)&&w.ssrtaoDisabled)&&!(!((C=O.userData)===null||C===void 0)&&C.ssaoDisabled)&&!(!((M=O.userData)===null||M===void 0)&&M.pluginsDisabled)?1:0;O.defines.SSRTAO_ENABLED!==ce&&(O.defines.SSRTAO_ENABLED=ce,O.needsUpdate=!0)},parsFragmentSnippet:h=>{var _;return fe`
            uniform float ssaoPower;
            uniform float ssgiIntensity;
            uniform sampler2D tSSGIMap;
            ${getTexelDecoding("tSSGIMap",(_=this._target)===null||_===void 0?void 0:_.texture.colorSpace)}

            ${simpleCameraHelpers}

        `},extraUniforms:{tSSGIMap:{value:null},ssaoPower:this.material.uniforms.power,ssgiIntensity:this.material.uniforms.intensity},computeCacheKey:h=>{var _,A,w,C;return this.enabled?"1":"0"+((A=(_=this._target)===null||_===void 0?void 0:_.texture)===null||A===void 0?void 0:A.colorSpace)+((C=(w=this._target)===null||w===void 0?void 0:w.texture)===null||C===void 0?void 0:C.uuid)+this.material.defines.SSGI_ENABLED},isCompatible:h=>{var _;return!(!((_=h.materialObject.userData)===null||_===void 0)&&_.ssaoDisabled)&&h.isMeshStandardMaterial2}},this.intensity=2,this.power=1.1,this.autoRadius=!0,this.objectRadius=2,this.tolerance=1,this.bias=.15,this.falloff=.7,this.rayCount=2,this.stepCount=4,this.smoothEnabled=!0,this.renderWithCamera=!0,this.uiConfig={type:"folder",label:"SS Global illumination (Dev)",children:[...generateUiConfig(this),{type:"checkbox",label:"GI Enabled",hidden:()=>!this._giActivated,property:[this,"ssgiEnabled"]}]},this._renderer=o,this._target=l,this.needsSwap=!0,this._giActivated=u,this.ssgiEnabled=u,this.bilateralPass=new BilateralFilterPass(this._target,c,"rgba")}render(o,l,c,u,h){this.needsSwap=!1,!this.renderWithCamera&&this._renderer.frameCount<2||(this._renderer.blit(this._target.texture,l),this.uniforms.tLastThis.value=l.texture,super.render(o,this._target,c,u,h),this.smoothEnabled&&this.bilateralPass.render(o,l,c,u,h))}}SSRTAOPass_decorate([serialize()],SSRTAOPass.prototype,"bilateralPass",void 0),SSRTAOPass_decorate([uiSlider("Intensity",[0,4]),serialize(),uniform()],SSRTAOPass.prototype,"intensity",void 0),SSRTAOPass_decorate([uiSlider("Power",[0,3]),serialize(),uniform()],SSRTAOPass.prototype,"power",void 0),SSRTAOPass_decorate([uiToggle("Auto radius"),serialize(),uniform()],SSRTAOPass.prototype,"autoRadius",void 0),SSRTAOPass_decorate([uiSlider("Object Radius",[.01,10]),serialize(),uniform()],SSRTAOPass.prototype,"objectRadius",void 0),SSRTAOPass_decorate([uiSlider("Tolerance",[.1,5]),serialize(),uniform()],SSRTAOPass.prototype,"tolerance",void 0),SSRTAOPass_decorate([uiSlider("Bias",[-.3,.3]),serialize(),uniform()],SSRTAOPass.prototype,"bias",void 0),SSRTAOPass_decorate([uiSlider("Falloff",[1e-4,4]),serialize(),uniform()],SSRTAOPass.prototype,"falloff",void 0),SSRTAOPass_decorate([uiSlider("Ray Count",[1,5],1),serialize(),uniform()],SSRTAOPass.prototype,"rayCount",void 0),SSRTAOPass_decorate([uiSlider("Step count",[1,16],1),serialize(),matDefine("RTAO_STEP_COUNT")],SSRTAOPass.prototype,"stepCount",void 0),SSRTAOPass_decorate([uiToggle("Smooth Enabled"),serialize()],SSRTAOPass.prototype,"smoothEnabled",void 0),SSRTAOPass_decorate([uiToggle("Render with Camera")],SSRTAOPass.prototype,"renderWithCamera",void 0);class SSGIPlugin extends MultiFilterPlugin{get rtgiTarget(){return this._rtgiTarget}constructor(o=!0){super(),this.dependencies=[AssetManagerPlugin,GBufferPlugin,ProgressivePlugin],this._initEnabled=!1,this.setDirty=this.setDirty.bind(this),this._initEnabled=o}async onAdded(o){var l,c;await super.onAdded(o),this.enabled=this._initEnabled,(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0)}get enabled(){var o,l;return((l=(o=this.passes.ssrtgi)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.enabled)||!1}set enabled(o){var l;!((l=this.passes.ssrtgi)===null||l===void 0)&&l.passObject&&(this.passes.ssrtgi.passObject.enabled=o)}createPasses(o){var l,c,u;return this._rtgiTarget=o.renderer.createTarget({sizeMultiplier:1}),(l=this._viewer)===null||l===void 0||l.getPluginByType("debug"),[makeFilter(o,{passId:"ssrtgi",after:["gbuffer"],before:["render"],required:["render","gbuffer","progressive"],passObject:new SSRTAOPass(o.renderer,this._rtgiTarget,(u=(c=o.getPlugin(GBufferPlugin))===null||c===void 0?void 0:c.getUnpackSnippet())!==null&&u!==void 0?u:"",!0),update:()=>{var h;const _=this.enabled;if(_){const A=(h=this._viewer)===null||h===void 0?void 0:h.getPluginByType("SSAO");A!=null&&A.enabled&&(A.enabled=!1)}_&&this.passes.ssrtgi.passObject.bilateralPass.updateShaderProperties([o.getPlugin(GBufferPlugin)])}},()=>[o.getPlugin(GBufferPlugin),o.getPlugin(ProgressivePlugin),o.scene.activeCamera,o.renderer])]}async onRemove(o){return o.renderer.disposeTarget(this._rtgiTarget),super.onRemove(o)}setDirty(){var o;(o=this._viewer)===null||o===void 0||o.setDirty()}get uiConfig(){var o,l,c,u,h;const _=(c=(l=(o=this.passes.ssrtgi)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.uiConfig)!==null&&c!==void 0?c:{};return(h=(u=_.children)===null||u===void 0?void 0:u.map(A=>Ee(A)))===null||h===void 0||h.flat(2).forEach(A=>A&&(A.onChange=this.setDirty)),_}}SSGIPlugin.PluginType="SSGI";var NormalRenderPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let NormalRenderPass=class extends RenderPass{constructor(d,o,l){super(d,o,l??new NormalMaterial,new three_module.Q1f(0,0,0),1),this.enabled=!0,this._firstCall=!0}render(d,o,l,c,u){this.enabled&&super.render(d,o,l,c,u)}};NormalRenderPass=NormalRenderPass_decorate([uiFolder("High Precision Normal Buffer")],NormalRenderPass);class NormalMaterial extends three_module.qBx{constructor(){super()}onBeforeRender(o,l,c,u,h){var _,A,w;let C=h.material;Array.isArray(C)&&(C=C[0]),this.normalMap=(_=C==null?void 0:C.normalMap)!==null&&_!==void 0?_:null,this.bumpMap=(A=C==null?void 0:C.bumpMap)!==null&&A!==void 0?A:null,this.bumpScale=C==null?void 0:C.bumpScale,C!=null&&C.normalScale&&this.normalScale.copy(C==null?void 0:C.normalScale),this.needsUpdate=!0,this.side=(w=C.side)!==null&&w!==void 0?w:three_module.$EB}}class NormalBufferPlugin extends GenericFilterPlugin{passCtor(o){this._normalTarget=o.renderer.createTarget({depthBuffer:!0,type:three_module.ix0,minFilter:three_module.hxR,magFilter:three_module.hxR,generateMipmaps:!1}),this._normalTarget.texture.name="normalBuffer",this._normalTarget.texture.generateMipmaps=!1;const l=this._normalTarget,c=new Set,u=new Set;return new class extends NormalRenderPass{render(h,_,A,w,C){const M=h.getRenderTarget(),O=h.getActiveCubeFace(),ne=h.getActiveMipmapLevel();this.scene&&(this.scene.traverse(({material:ce})=>{ce&&((ce.transparent&&ce.userData.renderToDepth||!ce.transparent&&ce.transmission===0&&ce.userData.renderToDepth===!1)&&(c.add(ce),ce.transparent=!ce.transparent),Math.abs(ce.transmission||0)>0&&ce.userData.renderToDepth&&(u.add([ce,ce.transmission]),ce.transmission=0))}),setThreeRendererMode(h,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!1,transmissionRender:!1,mainRenderPass:!1},()=>super.render(h,_,l,w,C)),c.forEach(ce=>ce.transparent=!ce.transparent),c.clear(),u.forEach(([ce,ue])=>ce.transmission=ue),u.clear(),h.setRenderTarget(M,O,ne))}}}_update(o){if(!super._update(o))return!1;const l=this.pass.passObject;return l.scene=o.scene.modelObject,l.camera=o.scene.activeCamera.cameraObject,!0}constructor(o=!0){super(),this.passId="normalBuffer",this._beforeFilters=["render"],this._afterFilters=[],this._requiredFilters=["render"],this.enabled=o}getNormalBuffer(){return this._normalTarget}async onDispose(o){}async onRemove(o){var l,c;return o.renderer.disposeTarget((c=(l=this._normalTarget)===null||l===void 0?void 0:l.dispose)===null||c===void 0?void 0:c.call(l)),super.onRemove(o)}updateShaderProperties(o){var l,c;return o.uniforms.tNormalBuffer?o.uniforms.tNormalBuffer.value=this.enabled&&(c=(l=this.getNormalBuffer())===null||l===void 0?void 0:l.texture)!==null&&c!==void 0?c:null:console.warn("BaseRenderer: no uniform: tNormalBuffer"),this}get uiConfig(){var o;return(o=this.pass)===null||o===void 0?void 0:o.passObject.uiConfig}}NormalBufferPlugin.PluginType="NormalBufferPlugin";class e{static _xfnv1a(o){let l=2166136261;for(let c=0;c<o.length;c++)l=Math.imul(l^o.charCodeAt(c),16777619);return()=>(l+=l<<13,l^=l>>>7,l+=l<<3,l^=l>>>17,(l+=l<<5)>>>0)}}class t extends e{constructor(o){super(),Object.defineProperty(this,"a",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.a=t._xfnv1a(o)()}next(){let o=this.a+=1831565813;return o=Math.imul(o^o>>>15,1|o),o^=o+Math.imul(o^o>>>7,61|o),((o^o>>>14)>>>0)/4294967296}}class es_i extends e{constructor(o){super(),Object.defineProperty(this,"a",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"b",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"c",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"d",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const l=es_i._xfnv1a(o);this.a=l(),this.b=l(),this.c=l(),this.d=l()}next(){this.a>>>=0,this.b>>>=0,this.c>>>=0,this.d>>>=0;let o=this.a+this.b|0;return this.a=this.b^this.b>>>9,this.b=this.c+(this.c<<3)|0,this.c=this.c<<21|this.c>>>11,this.d=this.d+1|0,o=o+this.d|0,this.c=this.c+o|0,(o>>>0)/4294967296}}class r extends e{constructor(o){super(),Object.defineProperty(this,"a",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"b",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"c",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"d",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const l=r._xfnv1a(o);this.a=l(),this.b=l(),this.c=l(),this.d=l()}next(){const o=this.b<<9;let l=5*this.b;return l=9*(l<<7|l>>>25),this.c^=this.a,this.d^=this.b,this.b^=this.c,this.a^=this.d,this.c^=o,this.d=this.d<<11|this.d>>>21,(l>>>0)/4294967296}}var s;(function(d){d.sfc32="sfc32",d.mulberry32="mulberry32",d.xoshiro128ss="xoshiro128ss"})(s||(s={}));class a{constructor(o,l=s.sfc32){Object.defineProperty(this,"str",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"prng",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.str=o,this.prng=l,this.generator=this._initializeGenerator()}next(){return this.generator.next()}_initializeGenerator(){if((l=>l===null)(o=this.str)||(l=>l===void 0)(o))return this.wrap();var o;switch(this.prng){case"sfc32":return new es_i(this.str);case"mulberry32":return new t(this.str);case"xoshiro128ss":return new r(this.str);default:return this.wrap()}}wrap(){return{next:()=>Math.random()}}}var RandomizedDirectionalLight_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class RandomizedDirectionalLight extends DirectionalLight2{constructor(o,l,c,u){super(o,l),this._shadowParams={enabled:!0,radius:2,width:1024,height:1024,bias:-.001,normalBias:0,near:1.5,far:4,frustumSize:4},this._randomParams={focus:1,spread:.01,distanceScale:50,minDistanceScale:new three_module.Pq0(10,10,10),normalDirection:new three_module.Pq0(.01,.98,.01).normalize(),direction:new three_module.Pq0(-.9,.5,-1)},this.isRandomizedDirectionalLight=!0,this.shadowParams=c??{},this.randomParams=u??{},this.updateShadowParams=this.updateShadowParams.bind(this)}get shadowParams(){return this._shadowParams}set shadowParams(o){Object.keys(o).forEach(l=>o[l]===void 0&&delete o[l]),this._shadowParams={...this._shadowParams,...o},this.updateShadowParams()}get randomParams(){return this._randomParams}set randomParams(o){Object.keys(o).forEach(l=>o[l]===void 0&&delete o[l]),Object.assign(this._randomParams,o)}updateShadowParams(){this.castShadow=this._shadowParams.enabled,this.shadow.mapSize.x=this._shadowParams.width,this.shadow.mapSize.y=this._shadowParams.height,this.shadow.bias=this._shadowParams.bias,this.shadow.normalBias=this._shadowParams.normalBias,this.refreshShadowCamNearFar(),this.shadow.radius=this._shadowParams.radius,this.shadow.camera.right=this._shadowParams.frustumSize/2,this.shadow.camera.left=-this._shadowParams.frustumSize/2,this.shadow.camera.top=this._shadowParams.frustumSize/2,this.shadow.camera.bottom=-this._shadowParams.frustumSize/2,this.shadow.camera.updateProjectionMatrix(),this.matrixWorldNeedsUpdate=!0}randomizePosition(o,l=null,c=null){const u=new a(o.toString()),h=new three_module.I9Y(u.next()*Math.PI*2,Math.asin(2*u.next()-1));let _=new three_module.Pq0(Math.cos(h.x)*Math.cos(h.y),Math.sin(h.y),Math.sin(h.x)*Math.cos(h.y));const A=new three_module.I9Y;for(let w=0;w<5;w++){A.set(u.next(),u.next()),_=getSample(A,this._randomParams.normalDirection,.4),u.next()<Math.sqrt(l??this._randomParams.focus)&&(A.set(u.next(),u.next()),_=getSample(A,this._randomParams.direction,Math.pow((c??this._randomParams.spread)/2,2)));const C=_.dot(this._randomParams.normalDirection);if(C>0&&C<.4)break}_.normalize(),_.multiplyScalar(this._randomParams.distanceScale),this.position.set(0,0,0),this.target.position.copy(_.normalize().negate()),this.target.updateMatrixWorld(),this.refreshShadowCamNearFar(),this.updateMatrixWorld()}refreshShadowCamNearFar(){const o=new three_module.Pq0().subVectors(this.target.position,this.shadow.camera.position).length();this.shadow.camera.near=o-this._shadowParams.near*this._shadowParams.frustumSize/2,this.shadow.camera.far=o+this._shadowParams.far*this._shadowParams.frustumSize/2}dispose(){}get uiConfig(){if(this._uiConfig)return this._uiConfig}fromJSON(o,l){return super.fromJSON(o,l)?(this.updateShadowParams(),this):null}}function getSample(d,o,l){o=o.clone().normalize();const c=new three_module.Pq0(0,-o.z,o.y).normalize(),u=new three_module.Pq0().crossVectors(o,c).normalize(),h=d;h.x=2*h.x*Math.PI,h.y=1-h.y*l;const _=Math.sqrt(1-h.y*h.y);return c.multiplyScalar(Math.cos(h.x)*_).add(u.multiplyScalar(Math.sin(h.x)*_)).add(o.multiplyScalar(h.y))}RandomizedDirectionalLight_decorate([serialize("shadowParams")],RandomizedDirectionalLight.prototype,"_shadowParams",void 0),RandomizedDirectionalLight_decorate([serialize("randomParams")],RandomizedDirectionalLight.prototype,"_randomParams",void 0);var RandomizedDirectionalLightPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class RandomizedDirectionalLightPlugin extends AViewerPlugin{get cameraHelper(){return this._cameraHelper}constructor(o=!0){super(),this.enabled=!0,this.light=new RandomizedDirectionalLight("#cceeff",1),this.lightLayers=1,this._preRender=()=>{var l,c,u;if(!this.enabled)return void(this.light.layers.mask=0);const h=(c=(l=this._viewer)===null||l===void 0?void 0:l.renderer.frameCount)!==null&&c!==void 0?c:0;this.light.randomizePosition(h<5?0:h),this.light.layers.mask=this.lightLayers,this.light.updateShadowParams(),(u=this._cameraHelper)===null||u===void 0||u.update()},this._setDirty=this._setDirty.bind(this),this.enabled=o}async onAdded(o){await super.onAdded(o),this._cameraHelper=new three_module.WTh(this.light.shadow.camera),this._cameraHelper.visible=!1,this._cameraHelper.userData.bboxVisible=!1,o.scene.add(this._cameraHelper),o.scene.addLight(this.light,{addToRoot:!0}),o.addEventListener("preRender",this._preRender)}async onRemove(o){return o.removeEventListener("preRender",this._preRender),this.light.removeFromParent(),super.onRemove(o)}_setDirty(o=!1){var l,c;o?(l=this._viewer)===null||l===void 0||l.scene.setDirty():(c=this._viewer)===null||c===void 0||c.setDirty()}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Progressive Shadow",children:[{type:"checkbox",label:"Enabled",property:[this,"enabled"],onChange:this._setDirty},{type:"folder",label:"Directional Light",children:[{type:"checkbox",label:"Visible",property:[this.light,"visible"],onChange:this._setDirty},{type:"slider",label:"Intensity",bounds:[0,50],property:[this.light,"intensity"],onChange:this._setDirty},{type:"color",label:"Color",property:[this.light,"color"],onChange:this._setDirty},{type:"checkbox",label:"Shadow Enabled",property:[this.light.shadowParams,"enabled"],onChange:[this.light.updateShadowParams,this._setDirty]},{type:"slider",bounds:[0,1],property:[this.light.randomParams,"focus"],onChange:this._setDirty},{type:"slider",bounds:[0,1],property:[this.light.randomParams,"spread"],onChange:this._setDirty},{type:"slider",bounds:[.01,60],property:[this.light.randomParams,"distanceScale"],onChange:this._setDirty},{type:"vec3",bounds:[-5,5],property:[this.light.randomParams,"direction"],onChange:this._setDirty},{type:"slider",bounds:[.01,10],property:[this.light.shadowParams,"radius"],onChange:[this.light.updateShadowParams,this._setDirty]},{type:"slider",bounds:[.01,30],property:[this.light.shadowParams,"frustumSize"],onChange:[this.light.updateShadowParams,this._setDirty]},{type:"slider",bounds:[-.01,.01],property:[this.light.shadowParams,"bias"],onChange:[this.light.updateShadowParams,this._setDirty]},{type:"slider",bounds:[-.05,.05],property:[this.light.shadowParams,"normalBias"],onChange:[this.light.updateShadowParams,this._setDirty]}]}]}}}RandomizedDirectionalLightPlugin.PluginType="RandomizedDirectionalLight",RandomizedDirectionalLightPlugin_decorate([serialize()],RandomizedDirectionalLightPlugin.prototype,"enabled",void 0),RandomizedDirectionalLightPlugin_decorate([serialize("rdLight")],RandomizedDirectionalLightPlugin.prototype,"light",void 0),RandomizedDirectionalLightPlugin_decorate([serialize()],RandomizedDirectionalLightPlugin.prototype,"lightLayers",void 0);var ssrPatch=`#if defined(SSR_ENABLED) && SSR_ENABLED > 0
vec3 screenPos=viewToScreen(geometryPosition);vec4 ssrColor=vec4(0,0,0,0);float alphaModifier=1.-clamp(material.roughness*.3,0.,1.);alphaModifier*=ssrIntensity;
#if defined(SSR_MASK_FRONT_RAYS) && SSR_MASK_FRONT_RAYS > 0
alphaModifier*=clamp(-4.*dot(geometryViewDir,normal)+(4.+ssrMaskFrontFactor),0.,1.);
#endif
#ifdef USE_TRANSMISSION
alphaModifier*=1.-transmission;
#endif
float vignette=1.;if(true){float fadeStrength=0.1;float dist=max(0.,min(min(1.-screenPos.x,1.-screenPos.y),min(screenPos.x,screenPos.y)));float fade=dist*dist/(fadeStrength+0.001);fade=clamp(fade,0.,1.);fade=pow(fade,0.3);vignette=fade;}alphaModifier*=vignette;vec3 specularColor=EnvironmentBRDF(geometryNormal,geometryViewDir,material.specularColor.rgb,material.specularF90,material.roughness);if(length(specularColor.rgb)*alphaModifier>0.01&&roughnessFactor<0.9){
#if defined(SSR_INLINE) && SSR_INLINE > 0
ssrColor=calculateSSR(8.,vec3(screenPos.xy,geometryPosition.z),geometryNormal,1.,material.roughness);
#else
ssrColor=tSSRMapTexelToLinear(texture2D(tSSRMap,screenPos.xy));
#endif 
}ssrColor.rgb*=ssrBoost;ssrColor.a*=alphaModifier;ssrColor.a=min(ssrColor.a,1.);
#if defined(SSR_NON_PHYSICAL) && SSR_NON_PHYSICAL > 0
diffuseColor.a=max(ssrColor.a,diffuseColor.a*diffuseColor.a);reflectedLight.indirectSpecular=mix(reflectedLight.indirectSpecular,saturate(diffuseColor.rgb*ssrColor.rgb),1.);reflectedLight.indirectDiffuse=diffuseColor.rgb*(1.-ssrColor.a);reflectedLight.directDiffuse=vec3(0.);reflectedLight.directSpecular=vec3(0.);
#else
reflectedLight.indirectSpecular=mix(reflectedLight.indirectSpecular,saturate(specularColor.rgb*ssrColor.rgb),ssrColor.a);
#endif
#endif
`,ssreflection=`uniform float objectRadius;uniform float radius;uniform float tolerance;uniform bool autoRadius;
#ifndef D_sceneBoundingRadius
#define D_sceneBoundingRadius 
uniform float sceneBoundingRadius;
#endif
vec3 ComputeReflectionL(vec3 N,vec2 E,vec3 V,float rough){float rough4=rough*rough*rough*rough;float phi=2.*PI*E.x;float cos_theta=pow(max(E.y,0.000001),rough4/(2.-rough4));float sin_theta=sqrt(max(0.,1.-cos_theta*cos_theta));vec3 half_vec=vec3(sin_theta*cos(phi),sin_theta*sin(phi),cos_theta);vec3 tangentX=normalize(cross(abs(N.z)<0.999?vec3(0.,0.,1.):vec3(1.,0.,0.),N));vec3 tangentY=cross(N,tangentX);half_vec=half_vec.x*tangentX+half_vec.y*tangentY+half_vec.z*N;vec3 ray_dir=(2.*dot(V,half_vec))*half_vec-V;return ray_dir;}vec2 GetRandomE(float seed){vec2 rand_e;rand_e.x=interleavedGradientNoise(gl_FragCoord.xy,frameCount*117.);rand_e.y=fract(rand_e.x*38.65435);rand_e.y=mix(rand_e.y,1.,0.7);return rand_e;}vec4 calculateSSR(in float seed,in vec3 screenPos,in vec3 normal,in float radiusFactor,in float roughness){vec3 viewPos=screenToView(screenPos.xy,screenPos.z);normal=normalize(normal);vec2 E=GetRandomE(seed);vec3 L=ComputeReflectionL(normal,E,-normalize(viewPos),roughness);L=normalize(L);float cameraDist=length(cameraPositionWorld);float rayLen=objectRadius*sceneBoundingRadius;rayLen=autoRadius?min(max(mix(max(0.,(cameraDist+rayLen)+viewPos.z),max(0.,-viewPos.z-max(0.,cameraDist-rayLen)),L.z*0.5+0.5),rayLen*0.1),rayLen*5.):rayLen;rayLen*=radiusFactor;float r=interleavedGradientNoise(gl_FragCoord.xy,frameCount+seed);rayLen=max(rayLen,0.001);int steps=SSR_STEP_COUNT/(frameCount<float(SSR_LOW_QUALITY_FRAMES)?2:1);vec3 state=vec3(0.,(r+0.5)/float(steps),2.);viewPos+=normal*max(-0.0001*viewPos.z,0.001);vec3 screenHitP=traceRay(viewPos,L*rayLen,tolerance*rayLen,state,steps);if(state.z<0.9999){vec3 hitColor=(tLastFrameTexelToLinear(texture2D(tLastFrame,screenHitP.xy))).rgb;float ssrWeight=1.;return vec4(hitColor*ssrWeight,1.);}return vec4(0.);}`,ssreflectionMain=`uniform sampler2D tLastThis;void main(){vec4 texel=tDiffuseTexelToLinear(texture2D(tDiffuse,vUv));vec4 lastAO=tLastThisTexelToLinear(texture2D(tLastThis,vUv));float depth;vec3 normal;getDepthNormal(vUv,depth,normal);if(depth>=0.999){discard;}float viewZ=depthToViewZ(depth);vec3 screenPos=vec3(vUv.x,vUv.y,viewZ);vec3 viewPos=screenToView(screenPos.xy,screenPos.z);viewPos.z=viewZ/viewPos.z;vec4 ao=vec4(0.);ao+=calculateSSR(8.,screenPos,normal,1.,0.1);ao.rgb=min(vec3(3.),ao.rgb);ao.rgb=max(vec3(0.),ao.rgb);if(frameCount<1.){gl_FragColor=ao;return;}if(ao.a<0.01){gl_FragColor.rgb=lastAO.rgb;gl_FragColor.a=(((lastAO.a)*frameCount)/(frameCount+1.));}else{gl_FragColor=((ao+(lastAO)*frameCount)/(frameCount+1.));}
#include <colorspace_fragment>
}`,SSRPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let SSRPass=class extends ShaderPass2{constructor(d,o,l,c=!0){super({vertexShader:defaultVertex,fragmentShader:`

varying vec2 vUv;

${basicHelpers}
${cameraHelpers}
${randomHelpers}
${samplePointHelpers}
${l}

${ssrt}

${ssreflection}

${ssreflectionMain}


            `,uniforms:{tLastThis:{value:null},tDiffuse:{value:null},tNormalDepth:{value:null},tLastFrame:{value:null},opacity:{value:1},intensity:{value:0},boost:{value:new three_module.Pq0(0,0,0)},objectRadius:{value:0},autoRadius:{value:!1},power:{value:0},maskFrontFactor:{value:-.1},tolerance:{value:0},frameCount:{value:0},projection:{value:new three_module.kn4},cameraPositionWorld:{value:new three_module.Pq0},cameraNearFar:{value:new three_module.I9Y(.1,1e3)},sceneBoundingRadius:{value:0}},defines:{PERSPECTIVE_CAMERA:1,SSR_STEP_COUNT:16,SSR_LOW_QUALITY_FRAMES:2,SSR_MASK_FRONT_RAYS:!0,SSR_INLINE:c?"1":"0",SSR_NON_PHYSICAL:"0"}},"tDiffuse","tLastThis","tLastFrame"),this.uiConfig=void 0,this.materialExtension={shaderExtender:(u,h,_)=>{var A,w,C,M,O;let ne=!this.enabled||_.userData.screenSpaceRendering===!1||!((A=h.materialObject.userData)===null||A===void 0)&&A.pluginsDisabled||!((w=h.materialObject.userData)===null||w===void 0)&&w.ssreflDisabled?0:1;if(h.materialObject.defines.SSR_ENABLED!==ne&&(h.materialObject.defines.SSR_ENABLED=ne,h.materialObject.needsUpdate=!0),!u.defines.SSR_ENABLED)return;ne=this.material.defines.SSR_STEP_COUNT,h.materialObject.defines.SSR_STEP_COUNT!==ne&&(h.materialObject.defines.SSR_STEP_COUNT=ne,h.materialObject.needsUpdate=!0),ne=this.material.defines.SSR_LOW_QUALITY_FRAMES,h.materialObject.defines.SSR_LOW_QUALITY_FRAMES!==ne&&(h.materialObject.defines.SSR_LOW_QUALITY_FRAMES=ne,h.materialObject.needsUpdate=!0),ne=this.material.defines.PERSPECTIVE_CAMERA,h.materialObject.defines.PERSPECTIVE_CAMERA!==ne&&(h.materialObject.defines.PERSPECTIVE_CAMERA=ne,h.materialObject.needsUpdate=!0),ne=this.material.defines.SSR_INLINE,h.materialObject.defines.SSR_INLINE!==ne&&(h.materialObject.defines.SSR_INLINE=ne,h.materialObject.needsUpdate=!0),ne=this.material.defines.SSR_MASK_FRONT_RAYS?1:0,h.materialObject.defines.SSR_MASK_FRONT_RAYS!==ne&&(h.materialObject.defines.SSR_MASK_FRONT_RAYS=ne,h.materialObject.needsUpdate=!0),ne=!((C=h.materialObject.userData)===null||C===void 0)&&C.ssreflNonPhysical?"1":"0",h.materialObject.defines.SSR_NON_PHYSICAL!==ne&&(h.materialObject.defines.SSR_NON_PHYSICAL=ne,h.materialObject.needsUpdate=!0),ne=(O=(M=this._target)===null||M===void 0?void 0:M.texture)!==null&&O!==void 0?O:null,this.materialExtension.extraUniforms.tSSRMap.value!==ne&&(this.materialExtension.extraUniforms.tSSRMap.value=ne,h.materialObject.needsUpdate=!0);const ce="#glMarker beforeModulation",ue=`
            
            ${ssrPatch}
            
            // reflectedLight.directDiffuse = vec3(0.);
            // reflectedLight.indirectDiffuse = vec3(0.);
            // reflectedLight.directSpecular = vec3(0.);
            // reflectedLight.indirectSpecular = vec3(0.);
            
            `;u.fragmentShader=u.fragmentShader.replace(ce,`
${ue}
${ce}`)},onObjectRender:(u,h,_)=>{var A,w;const C=!this.enabled||_.userData.screenSpaceRendering===!1||!((A=h.materialObject.userData)===null||A===void 0)&&A.pluginsDisabled||!((w=h.materialObject.userData)===null||w===void 0)&&w.ssreflDisabled?0:1;h.materialObject.defines.SSR_ENABLED!==C&&(h.materialObject.defines.SSR_ENABLED=C,h.materialObject.needsUpdate=!0)},parsFragmentSnippet:(u,h)=>{var _,A,w,C;return!this.enabled||u.userData.screenSpaceRendering===!1||!((_=h==null?void 0:h.materialObject.userData)===null||_===void 0)&&_.ssreflDisabled||!((A=h==null?void 0:h.materialObject.userData)===null||A===void 0)&&A.pluginsDisabled?"":`
uniform float ssrPower;
uniform float ssrIntensity;
uniform float ssrMaskFrontFactor;
uniform vec3 ssrBoost;
uniform sampler2D tSSRMap;
uniform sampler2D tLastFrame;
`+getTexelDecoding("tSSRMap",(w=this._target)===null||w===void 0?void 0:w.texture.colorSpace)+getTexelDecoding("tLastFrame",(C=this.materialExtension.extraUniforms.tLastFrame.value)===null||C===void 0?void 0:C.colorSpace)+(this._inline?`
#if 1
// #if SSR_INLINE
    ${basicHelpers}
    
    #define THREE_PACKING_INCLUDED
    ${cameraHelpers}
    
    ${randomHelpers}
    ${samplePointHelpers}
    ${unpackGbuffer}
    
    ${ssrt}
    
    ${ssreflection}
// #endif // SSR_INLINE
#endif
`:"")+`
${simpleCameraHelpers}
        `},extraUniforms:{tSSRMap:{value:null},ssrPower:this.material.uniforms.power,ssrIntensity:this.material.uniforms.intensity,ssrMaskFrontFactor:this.material.uniforms.maskFrontFactor,ssrBoost:this.material.uniforms.boost,tNormalDepth:this.material.uniforms.tNormalDepth,tLastFrame:this.material.uniforms.tLastFrame,objectRadius:this.material.uniforms.objectRadius,autoRadius:this.material.uniforms.autoRadius,tolerance:this.material.uniforms.tolerance,frameCount:this.material.uniforms.frameCount,projection:this.material.uniforms.projection,cameraPositionWorld:this.material.uniforms.cameraPositionWorld,cameraNearFar:this.material.uniforms.cameraNearFar,sceneBoundingRadius:this.material.uniforms.sceneBoundingRadius},computeCacheKey:u=>{var h,_,A;return this.enabled?"1":"0"+((_=(h=this._target)===null||h===void 0?void 0:h.texture)===null||_===void 0?void 0:_.colorSpace)+(this.enabled&&!(!((A=u.materialObject.userData)===null||A===void 0)&&A.ssreflDisabled)?1:0)+Object.values(this.material.defines).map(w=>w+"").join(",")},isCompatible:u=>{var h;return!(!((h=u.materialObject.userData)===null||h===void 0)&&h.ssreflDisabled)&&u.isMeshStandardMaterial2}},this.intensity=1,this.boost=new three_module.Pq0(1,1,1),this.objectRadius=1,this.autoRadius=!0,this.power=1.1,this.tolerance=.5,this.stepCount=16,this.lowQualityFrames=0,this.maskFrontRays=!0,this.maskFrontFactor=-.2,this._renderer=d,this._target=o,this.needsSwap=!1,this._inline=c}render(d,o,l,c,u){if(this._inline)this.needsSwap=!1;else{if(!this._target)throw"Target must be set when inline = false";this._renderer.blit(this._target.texture,o,{}),this.uniforms.tLastThis.value=o.texture,super.render(d,this._target,l,c,u),this.needsSwap=!1}}};SSRPass_decorate([uiSlider("Intensity",[0,4]),serialize(),uniform()],SSRPass.prototype,"intensity",void 0),SSRPass_decorate([uiVector("Boost"),serialize(),uniform()],SSRPass.prototype,"boost",void 0),SSRPass_decorate([uiSlider("Object Radius",[.01,2]),serialize(),uniform()],SSRPass.prototype,"objectRadius",void 0),SSRPass_decorate([uiToggle("Auto radius"),serialize(),uniform()],SSRPass.prototype,"autoRadius",void 0),SSRPass_decorate([uiSlider("Power",[0,3]),serialize(),uniform()],SSRPass.prototype,"power",void 0),SSRPass_decorate([uiSlider("Tolerance",[.1,5]),serialize(),uniform()],SSRPass.prototype,"tolerance",void 0),SSRPass_decorate([uiSlider("Step count",[1,32],1),serialize(),matDefine("SSR_STEP_COUNT")],SSRPass.prototype,"stepCount",void 0),SSRPass_decorate([uiSlider("Low Quality Frames",[0,4],1),serialize(),matDefine("SSR_LOW_QUALITY_FRAMES")],SSRPass.prototype,"lowQualityFrames",void 0),SSRPass_decorate([uiToggle("Ignore front rays"),serialize(),matDefine("SSR_MASK_FRONT_RAYS")],SSRPass.prototype,"maskFrontRays",void 0),SSRPass_decorate([uiSlider("Mask front rays factor",[-1,1],.01,d=>({hidden:()=>!d.maskFrontRays})),serialize(),uniform()],SSRPass.prototype,"maskFrontFactor",void 0),SSRPass=SSRPass_decorate([uiFolder("Screen Space Reflections")],SSRPass);class SSRPlugin extends MultiFilterPlugin{get ssrTarget(){return this._ssrTarget}constructor(){super(),this.dependencies=[AssetManagerPlugin,GBufferPlugin,ProgressivePlugin],this.inlineSSR=!0,this.setDirty=this.setDirty.bind(this)}get enabled(){var o,l;return((l=(o=this.passes.ssr)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.enabled)||!1}set enabled(o){var l;!((l=this.passes.ssr)===null||l===void 0)&&l.passObject&&(this.passes.ssr.passObject.enabled=o)}async onAdded(o){var l,c;o.getPluginByType("Ground")&&console.error("GroundPlugin must be added after SSRPlugin"),await super.onAdded(o),(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0)}createPasses(o){var l,c;return this._ssrTarget=this.inlineSSR?void 0:o.renderer.createTarget({sizeMultiplier:1}),[makeFilter(o,{passId:"ssr",after:["gbuffer"],before:["render"],required:["render","gbuffer","progressive"],passObject:new SSRPass(o.renderer,this._ssrTarget,(c=(l=o.getPlugin(GBufferPlugin))===null||l===void 0?void 0:l.getUnpackSnippet())!==null&&c!==void 0?c:"",this.inlineSSR)},()=>[o.getPlugin(GBufferPlugin),o.getPlugin(ProgressivePlugin),o.scene.activeCamera,o.renderer,o.scene])]}async onRemove(o){return this._ssrTarget&&o.renderer.disposeTarget(this._ssrTarget),super.onRemove(o)}setDirty(){var o;(o=this._viewer)===null||o===void 0||o.setDirty()}get uiConfig(){var o,l,c,u,h;const _=(c=(l=(o=this.passes.ssr)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.uiConfig)!==null&&c!==void 0?c:{};return(h=(u=_.children)===null||u===void 0?void 0:u.map(A=>Ee(A)))===null||h===void 0||h.flat(2).forEach(A=>A&&(A.onChange=this.setDirty)),_}}SSRPlugin.PluginType="SSReflection";var anisotropyBsdf=`uniform float anisotropyFactor;uniform float anisotropyNoise;
#if ANISOTROPY_TEX_MODE == 0
uniform float anisotropyDirection;
#else
uniform sampler2D anisotropyDirectionMap;varying vec2 vAnisotropy2MapUv;
#endif
const float MIN_ROUGHNESS=0.05;vec3 indirectAnisotropyBentNormal(const in vec3 normal,const in vec3 viewDir,const in float roughness,const in vec3 anisotropicT,const in vec3 anisotropicB){vec3 aDirection=anisotropyFactor>=0.?anisotropicB:anisotropicT;vec3 aTangent=cross(aDirection,viewDir);vec3 aNormal=cross(aTangent,aDirection);float bendFactor=abs(anisotropyFactor)*saturate(5.*max(roughness,MIN_ROUGHNESS));return normalize(mix(normal,aNormal,bendFactor));}vec3 BRDF_GGX_Anisotropy(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,const in vec3 f0,const in float f90,const in float roughness,const in vec3 anisotropicT,const in vec3 anisotropicB){float alpha=pow2(roughness);vec3 halfDir=normalize(lightDir+viewDir);float dotNL=saturate(dot(normal,lightDir));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotVH=saturate(dot(viewDir,halfDir));float dotTV=dot(anisotropicT,viewDir);float dotBV=dot(anisotropicB,viewDir);float dotTL=dot(anisotropicT,lightDir);float dotBL=dot(anisotropicB,lightDir);float dotTH=dot(anisotropicT,halfDir);float dotBH=dot(anisotropicB,halfDir);float aspect=sqrt(1.-min(1.-MIN_ROUGHNESS,abs(anisotropyFactor)*0.9));if(anisotropyFactor>0.)aspect=1./aspect;float at=roughness*aspect;float ab=roughness/aspect;vec3 F=F_Schlick(f0,f90,dotVH);float V=V_GGX_SmithCorrelated_Anisotropic(at,ab,dotTV,dotBV,dotTL,dotBL,dotNV,dotNL);float D=D_GGX_Anisotropic(at,ab,dotTH,dotBH,dotNH);return F*(V*D);}`,anisotropyTBN=`float rnd=(random2(vUv.xy,frameCount)-0.5)*anisotropyNoise*material.roughness;
#if ANISOTROPY_TEX_MODE < 2
#if ANISOTROPY_TEX_MODE == 0 
float rot=saturate(anisotropyDirection);
#else 
float rot=(anisotropyDirectionMapTexelToLinear(texture2D(anisotropyDirectionMap,vAnisotropy2MapUv)).r);
#endif
rot=rot*2.*PI+rnd;vec2 rot2=vec2(sin(rot),cos(rot));
#else 
vec2 rot2=(anisotropyDirectionMapTexelToLinear(texture2D(anisotropyDirectionMap,vAnisotropy2MapUv)).rg*2.-1.)+vec2(rnd,rnd);rot2=normalize(rot2);const float anisoSpecMultiplier=0.25;float matSpecAniso=(length(material.specularColor.rgb))*2.*PI;rot2=mix(rot2,vec2(sin(matSpecAniso),cos(matSpecAniso)),anisoSpecMultiplier);rot2=normalize(rot2);
#endif
vec3 anisotropicT=(tbn[0]*rot2.x+tbn[1]*rot2.y);anisotropicT=normalize(anisotropicT-normal*dot(anisotropicT,normal));vec3 anisotropicB=normalize(cross(normal,anisotropicT));`,AnisotropyPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let AnisotropyPlugin=class extends AViewerPlugin{makeAnisotropic(d){var o;const l=(o=d.materialObject)===null||o===void 0?void 0:o.userData;if(!l)return!1;if(l._isAnisotropic===void 0){const c=l.__appliedMeshes;let u=!0;if(c)for(const{geometry:h}of c)!h||h.index&&h.attributes.position&&h.attributes.normal&&h.attributes.uv||(u=!1),u&&!h.attributes.tangent&&h.computeTangents();if(!u)return!1}return l._isAnisotropic=!0,l._anisotropyFactor===void 0&&(l._anisotropyFactor=1),l._anisotropyNoise===void 0&&(l._anisotropyNoise=0),l._anisotropyDirectionMode===void 0&&(l._anisotropyDirectionMode="DIRECTION"),d.materialObject.needsUpdate=!0,!0}tryComputeTangents(d,o){if(d.geometry&&!d.geometry.attributes.tangent){let l=!0;d.geometry.index&&d.geometry.attributes.position&&d.geometry.attributes.normal&&d.geometry.attributes.uv||(l=!1),l?d.geometry.computeTangents():o.map(c=>{var u;!((u=c==null?void 0:c.userData)===null||u===void 0)&&u._isAnisotropic&&(c.userData._isAnisotropic=!1)})}}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFMaterialsAnisotropyExtensionImport(o))}constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin],this._defines={ANISOTROPY_DEBUG:!1},this._uniforms={anisotropyFactor:{value:1},anisotropyNoise:{value:1},anisotropyDirection:{value:1},anisotropyDirectionMap:{value:null},anisotropy2MapUvTransform:{value:new three_module.dwI},frameCount:{value:0}},this.materialExtension={shaderExtender:(d,o,l)=>{var c;if(!this.enabled||!o.materialObject.userData._isAnisotropic)return;const u=(c=o.materialObject.userData)===null||c===void 0?void 0:c._anisotropyDirectionMap,h=fe`
                //#if ANISOTROPY_ENABLED
                ${randomHelpers}
            `+(u?getTexelDecoding("anisotropyDirectionMap",u.colorSpace):"")+`
`;d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <common>",h,{append:!0}),d.fragmentShader=d.fragmentShader.replace("#include <lights_fragment_begin>",three_module.vxI.lights_fragment_begin),d.fragmentShader=shaderReplaceString(shaderReplaceString(d.fragmentShader,"IncidentLight directLight;",anisotropyTBN,{prepend:!0}),"RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight )","RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight, anisotropicT, anisotropicB )",{replaceAll:!0});let _=shaderReplaceString(three_module.vxI.lights_physical_pars_fragment,"void RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {","void RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight, const in vec3 anisotropicT, const in vec3 anisotropicB ) {");_=shaderReplaceString(_,"vec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {",anisotropyBsdf+`
`,{prepend:!0}),_=shaderReplaceString(_,"BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material )","BRDF_GGX_Anisotropy( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularF90, material.roughness, anisotropicT, anisotropicB )"),d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <lights_physical_pars_fragment>",_),d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <normal_fragment_begin>",three_module.vxI.normal_fragment_begin),d.fragmentShader=shaderReplaceString(d.fragmentShader,"#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )","#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) || defined( USE_TANGENT )");let A=fe`
                #if defined( USE_ENVMAP )
                vec3 anisotropyBentNormal = indirectAnisotropyBentNormal(geometryNormal, geometryViewDir, material.roughness, anisotropicT, anisotropicB);
                #endif
            `+three_module.vxI.lights_fragment_maps;A=shaderReplaceString(A,"getIBLIrradiance( geometryNormal )","getIBLIrradiance( anisotropyBentNormal )"),A=shaderReplaceString(A,"getIBLRadiance( geometryViewDir, geometryNormal, material.roughness )","getIBLRadiance( geometryViewDir, anisotropyBentNormal, material.roughness )"),d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <lights_fragment_maps>",A),d.vertexShader=shaderReplaceString(d.vertexShader,"#include <uv_pars_vertex>",`
#if defined(ANISOTROPY_ENABLED) && ANISOTROPY_ENABLED > 0
    varying vec2 vAnisotropy2MapUv;
    uniform mat3 anisotropy2MapUvTransform;
#endif
                `,{prepend:!0}),d.vertexShader=shaderReplaceString(d.vertexShader,"#include <uv_vertex>",`
#if defined(ANISOTROPY_ENABLED) && ANISOTROPY_ENABLED > 0
    vAnisotropy2MapUv = ( anisotropy2MapUvTransform * vec3( uv, 1 ) ).xy;
#endif
                `,{prepend:!0}),d.defines.USE_ANISOTROPY_BRDF="",d.defines.USE_UV="",d.vertexTangents=!0},onObjectRender:(d,o)=>{var l;const c=o.materialObject.userData;if(!(c!=null&&c._isAnisotropic))return;const u=d;if(!u.isMesh||!u.geometry)return;u.geometry.attributes.tangent?u.geometry.userData.__forceUseTangent=!0:console.error("WebGi AnisotropyPlugin - No tangents on the geometry, cannot use anisotropy. Make sure the tangents are computed before rendering the model. The model will render as black.",u),this._uniforms.anisotropyFactor.value=c._anisotropyFactor,this._uniforms.anisotropyNoise.value=c._anisotropyNoise,this._uniforms.anisotropyDirection.value=c._anisotropyDirection;const h=!((l=c._anisotropyDirectionMap)===null||l===void 0)&&l.isTexture?c._anisotropyDirectionMap:null;this._uniforms.anisotropyDirectionMap.value=h,h&&(h.updateMatrix(),this._uniforms.anisotropy2MapUvTransform.value.copy(h.matrix));let _=this.enabled?1:0;o.materialObject.defines.ANISOTROPY_ENABLED!==_&&(o.materialObject.defines.ANISOTROPY_ENABLED=_,o.materialObject.needsUpdate=!0),_=+this._defines.ANISOTROPY_DEBUG,o.materialObject.defines.ANISOTROPY_DEBUG!==_&&(o.materialObject.defines.ANISOTROPY_DEBUG=_,o.materialObject.needsUpdate=!0),_=c._anisotropyDirectionMode,this._uniforms.anisotropyDirectionMap.value||(_="CONSTANT"),_=_==="DIRECTION"?2:_==="ROTATION"?1:0,o.materialObject.defines.ANISOTROPY_TEX_MODE!==_&&(o.materialObject.defines.ANISOTROPY_TEX_MODE=_,o.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:d=>{var o,l,c;return(this.enabled?"1":"0")+(!((o=d.materialObject.userData)===null||o===void 0)&&o._isAnisotropic?"1":"0")+((c=(l=d.materialObject.userData)===null||l===void 0?void 0:l._anisotropyDirectionMap)===null||c===void 0?void 0:c.uuid)},isCompatible:d=>d.isMeshStandardMaterial2,updaters:()=>{var d;return[(d=this._viewer)===null||d===void 0?void 0:d.renderer]},getUiConfig:d=>{const o=this._viewer,l=this.makeAnisotropic,c={type:"folder",label:"Anisotropy",children:[{type:"checkbox",label:"Enabled",get value(){return d.materialObject.userData._isAnisotropic||!1},set value(u){var h;u!==d.materialObject.userData._isAnisotropic&&(u?l(d)||o.alert("One or more geometries cannot be made anisotropic."):(d.materialObject.userData._isAnisotropic=!1,d.materialObject.needsUpdate=!0),(h=c.uiRefresh)===null||h===void 0||h.call(c,"postFrame",!0))},onChange:this.setDirty},{type:"slider",label:"Factor",bounds:[-2,2],hidden:()=>!d.materialObject.userData._isAnisotropic,property:[d.materialObject.userData,"_anisotropyFactor"],onChange:this.setDirty},{type:"slider",label:"Noise",bounds:[0,2],hidden:()=>!d.materialObject.userData._isAnisotropic,property:[d.materialObject.userData,"_anisotropyNoise"],onChange:this.setDirty},{type:"image",label:"Texture",hidden:()=>!d.materialObject.userData._isAnisotropic,property:[d.materialObject.userData,"_anisotropyDirectionMap"],onChange:()=>{d.materialObject.needsUpdate=!0,this.setDirty()}},makeSamplerUi(d.materialObject.userData,"_anisotropyDirectionMap","Sampler",()=>!d.materialObject.userData._isAnisotropic||d.materialObject.userData._anisotropyDirectionMode==="CONSTANT",()=>d.setDirty&&d.setDirty()),{type:"dropdown",label:"Mode",hidden:()=>!d.materialObject.userData._isAnisotropic,property:[d.materialObject.userData,"_anisotropyDirectionMode"],children:["CONSTANT","ROTATION","DIRECTION"].map(u=>({label:u})),onChange:()=>{d.materialObject.needsUpdate=!0,this.setDirty()}}]};return c},onMaterialUpdate:d=>{var o,l;!((o=d.userData)===null||o===void 0)&&o._isAnisotropic&&((l=d.userData.__appliedMeshes)===null||l===void 0||l.forEach(c=>this.tryComputeTangents(c,[d])))},onRegister:d=>{var o,l;!((o=d.userData)===null||o===void 0)&&o._isAnisotropic&&((l=d.userData.__appliedMeshes)===null||l===void 0||l.forEach(c=>this.tryComputeTangents(c,[d])))},onAddToMesh:d=>{const o=d,l=Array.isArray(o.material)?o.material:[o.material];l.find(c=>{var u;return(u=c==null?void 0:c.userData)===null||u===void 0?void 0:u._isAnisotropic})&&this.tryComputeTangents(o,l)}},this.setDirty=()=>{var d,o,l;(o=(d=this.materialExtension).setDirty)===null||o===void 0||o.call(d),(l=this._viewer)===null||l===void 0||l.setDirty()},this.makeSelectedAnisotropic=()=>{var d,o,l;const c=(l=(o=(d=this._viewer)===null||d===void 0?void 0:d.getPlugin(PickingPlugin))===null||o===void 0?void 0:o.getSelectedObject())===null||l===void 0?void 0:l.material;return(c==null?void 0:c.assetType)==="material"&&this.makeAnisotropic(c)},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(d){var o,l,c,u,h;await super.onAdded(d);const _=d.getPlugin(AssetManagerPlugin);(o=_==null?void 0:_.materials)===null||o===void 0||o.registerMaterialExtension(this.materialExtension),(l=_==null?void 0:_.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=_==null?void 0:_.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(glTFMaterialsAnisotropyExtensionExport)}async onRemove(d){var o,l,c,u;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(d)}};AnisotropyPlugin.PluginType="AnisotropyPlugin",AnisotropyPlugin.ANISOTROPY_GLTF_EXTENSION="WEBGI_materials_anisotropy",AnisotropyPlugin_decorate([uiToggle("Enabled",d=>({onChange:d.setDirty})),serialize()],AnisotropyPlugin.prototype,"enabled",void 0),AnisotropyPlugin_decorate([uiButton("Make Anisotropy",d=>({hidden:()=>{var o;return!(!((o=d._viewer)===null||o===void 0)&&o.getPlugin(PickingPlugin))}}))],AnisotropyPlugin.prototype,"makeSelectedAnisotropic",void 0),AnisotropyPlugin=AnisotropyPlugin_decorate([uiFolder("Anisotropy Materials")],AnisotropyPlugin);class GLTFMaterialsAnisotropyExtensionImport{constructor(o){this.parser=o,this.name=AnisotropyPlugin.ANISOTROPY_GLTF_EXTENSION}async extendMaterialParams(o,l){var c,u,h;const _=this.parser,A=_.json.materials[o];if(!A.extensions||!A.extensions[this.name])return Promise.resolve();const w=[],C=A.extensions[this.name];l.userData||(l.userData={}),l.userData._isAnisotropic=!0,l.userData._anisotropyFactor=(c=C.anisotropyFactor)!==null&&c!==void 0?c:0,l.userData._anisotropyNoise=(h=(u=C.anisotropyNoiseFactor)!==null&&u!==void 0?u:C.anisotropyNoise)!==null&&h!==void 0?h:0;let{anisotropyDirectionMode:M,anisotropyDirection:O}=C;return M||(M=C.anisotropyTextureMode),O||(O=C.anisotropyRotation),l.userData._anisotropyDirectionMode=M&&typeof(O==null?void 0:O.index)=="number"?M:"CONSTANT",M==="ROTATION"||M==="DIRECTION"?w.push(_.assignTexture(l.userData,"_anisotropyDirectionMap",O).then(ne=>{ne.colorSpace=three_module.er$})):l.userData._anisotropyDirection=O??0,Promise.all(w)}afterRoot(o){var l;return(l=o.scene)===null||l===void 0||l.traverse(c=>{var u,h;if(!(!((h=(u=c.material)===null||u===void 0?void 0:u.userData)===null||h===void 0)&&h._isAnisotropic))return;const _=c.geometry;_.attributes.tangent||(_.computeTangents(),_.attributes.tangent.needsUpdate=!0)}),null}}const glTFMaterialsAnisotropyExtensionExport=d=>({writeMaterial:(o,l)=>{if(!o.isMeshStandardMaterial||!o.userData._isAnisotropic||(o.userData._anisotropyFactor||0)<.001)return;l.extensions=l.extensions||{};const c={};if(c.anisotropyFactor=o.userData._anisotropyFactor||1,c.anisotropyNoiseFactor=o.userData._anisotropyNoise||0,c.anisotropyDirectionMode=o.userData._anisotropyDirectionMode||"CONSTANT",d.checkEmptyMap(o.userData._anisotropyDirectionMap)&&c.anisotropyDirectionMode!=="CONSTANT"){const u={index:d.processTexture(o.userData._anisotropyDirectionMap)};d.applyTextureTransform(u,o.userData._anisotropyDirectionMap),c.anisotropyDirection=u}else c.anisotropyDirectionMode="CONSTANT",c.anisotropyDirection=o.userData._anisotropyDirection||0;l.extensions[AnisotropyPlugin.ANISOTROPY_GLTF_EXTENSION]=c,d.extensionsUsed[AnisotropyPlugin.ANISOTROPY_GLTF_EXTENSION]=!0}});var FragmentClippingExtensionPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},FragmentClippingExtensionPlugin_1;let FragmentClippingExtensionPlugin=FragmentClippingExtensionPlugin_1=class extends AViewerPlugin{static AddFragmentClipping(d,o,l,c,u){var h,_,A;const w=(h=d.materialObject)===null||h===void 0?void 0:h.userData;if(!w)return!1;w._fragmentClippingExt||(w._fragmentClippingExt={});const C=w._fragmentClippingExt;return C.clipEnabled=!0,C.clipPosition===void 0&&(C.clipPosition=(_=o==null?void 0:o.toArray())!==null&&_!==void 0?_:[0,0,0,0]),C.clipParams===void 0&&(C.clipParams=(A=l==null?void 0:l.toArray())!==null&&A!==void 0?A:[1,0,0,0]),C.clipMode===void 0&&(C.clipMode=c??FragmentClippingMode.Circle),C.clipInvert===void 0&&(C.clipInvert=u!=null&&u),d.materialObject.isMaterial&&(d.needsUpdate=!0),!0}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFMaterialsFragmentClippingExtensionImport(o))}constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin,GBufferPlugin],this._plane=new three_module.Zcv,this._viewNormalMatrix=new three_module.dwI,this._defines={FRAG_CLIPPING_DEBUG:!1},this._uniforms={fragClippingPosition:{value:new three_module.IUQ},fragClippingParams:{value:new three_module.IUQ},fragClippingCamAspect:{value:1}},this.materialExtension={parsFragmentSnippet:(d,o)=>{var l;return this.enabled&&(!((l=o==null?void 0:o.materialObject.userData._fragmentClippingExt)===null||l===void 0)&&l.clipEnabled)?simpleCameraHelpers+fe`
uniform vec4 fragClippingPosition;
uniform vec4 fragClippingParams;
uniform float fragClippingCamAspect;
#if FRAG_CLIPPING_MODE == ${FragmentClippingMode.Circle}
float fragClippingCircle(){
    vec2 pos = viewToScreen(vViewPosition.xyz).xy;
    float radius = fragClippingParams.x;
    vec2 center = fragClippingPosition.xy;
    pos.y /= fragClippingCamAspect;
    center.y /= fragClippingCamAspect;
    return length(pos - center) - radius;
}
#elif FRAG_CLIPPING_MODE == ${FragmentClippingMode.Ellipse}
float fragClippingEllipse(){
    vec2 pos = viewToScreen(vViewPosition.xyz).xy;
    vec2 radius = fragClippingParams.xy;
    vec2 center = fragClippingPosition.xy;
    pos.y /= fragClippingCamAspect;
    center.y /= fragClippingCamAspect;
    return length((pos - center) / radius) - 1.0;
}
#elif FRAG_CLIPPING_MODE == ${FragmentClippingMode.Rectangle}
float fragClippingRectangle(){
    vec2 pos = viewToScreen(vViewPosition.xyz).xy;
    vec2 radius = fragClippingParams.xy;
    vec2 center = fragClippingPosition.xy;
    pos.y /= fragClippingCamAspect;
    center.y /= fragClippingCamAspect;
    vec2 d = abs(pos - center) - radius;
    return min(max(d.x,d.y),0.0) + length(max(d,0.0));
}
#elif FRAG_CLIPPING_MODE == ${FragmentClippingMode.Plane}
float fragClippingPlane(){
    vec3 pos = vViewPosition.xyz;
    vec3 normal = fragClippingParams.xyz;
    float d = dot(pos, normal) - fragClippingParams.w;
    return d;
}
#elif FRAG_CLIPPING_MODE == ${FragmentClippingMode.Sphere}
float fragClippingSphere(){
    vec3 pos = vViewPosition.xyz;
    vec3 center = fragClippingPosition.xyz;
    float radius = fragClippingParams.x;
    pos.y /= fragClippingCamAspect;
    center.y /= fragClippingCamAspect;
    return length(pos - center) - radius;
}
#endif
        `:""},shaderExtender:(d,o,l)=>{var c;this.enabled&&(!((c=o.materialObject.userData._fragmentClippingExt)===null||c===void 0)&&c.clipEnabled)&&(d.fragmentShader=shaderReplaceString(d.fragmentShader,"#glMarker mainStart",fe`
    float fragClippingDist = 0.0;
    #if FRAG_CLIPPING_MODE == ${FragmentClippingMode.Circle}
    fragClippingDist = fragClippingCircle();
    #elif FRAG_CLIPPING_MODE == ${FragmentClippingMode.Ellipse}
    fragClippingDist = fragClippingEllipse();
    #elif FRAG_CLIPPING_MODE == ${FragmentClippingMode.Rectangle}
    fragClippingDist = fragClippingRectangle();
    #elif FRAG_CLIPPING_MODE == ${FragmentClippingMode.Plane}
    fragClippingDist = fragClippingPlane();
    #elif FRAG_CLIPPING_MODE == ${FragmentClippingMode.Sphere}
    fragClippingDist = fragClippingSphere();
    #endif
    #if FRAG_CLIPPING_DEBUG
    gl_FragColor = vec4(max(fragClippingDist, 0.0), 0.0, 0.0, 1.0); 
//    gl_FragColor = vec4(vViewPosition.xyz, 1.0);
    #include <colorspace_fragment>
    return;
    #endif
    
    #if FRAG_CLIPPING_INVERSE == 1
    if (fragClippingDist > 0.0) discard;
    #else
    if (fragClippingDist < 0.0) discard;
    #endif
            `,{append:!0}))},onObjectRender:(d,o)=>{var l,c,u,h,_,A;let w=(l=o.materialObject.userData)===null||l===void 0?void 0:l._fragmentClippingExt;if(o.materialObject.userData.isGBufferMaterial&&d&&(w=(u=(c=d.material)===null||c===void 0?void 0:c.userData)===null||u===void 0?void 0:u._fragmentClippingExt),!(w!=null&&w.clipEnabled))return;if(this._uniforms.fragClippingPosition.value.fromArray(w.clipPosition),w.clipMode===FragmentClippingMode.Plane){const M=(h=this._viewer)===null||h===void 0?void 0:h.scene.activeCamera.cameraObject.matrixWorldInverse;this._plane.normal.set(w.clipParams[0],w.clipParams[1],w.clipParams[2]),this._plane.constant=w.clipParams[3],this._viewNormalMatrix.getNormalMatrix(M),this._plane.applyMatrix4(M,this._viewNormalMatrix),this._uniforms.fragClippingParams.value.set(this._plane.normal.x,this._plane.normal.y,this._plane.normal.z,this._plane.constant)}else this._uniforms.fragClippingParams.value.fromArray(w.clipParams);((_=this._viewer)===null||_===void 0?void 0:_.scene.activeCamera.cameraObject)instanceof three_module.ubm?this._uniforms.fragClippingCamAspect.value=(A=this._viewer)===null||A===void 0?void 0:A.scene.activeCamera.cameraObject.aspect:this._uniforms.fragClippingCamAspect.value=1;let C=this.enabled?1:0;C=+this._defines.FRAG_CLIPPING_DEBUG,o.materialObject.defines.FRAG_CLIPPING_DEBUG!==C&&(o.materialObject.defines.FRAG_CLIPPING_DEBUG=C,o.materialObject.needsUpdate=!0),C=+w.clipMode,o.materialObject.defines.FRAG_CLIPPING_MODE!==C&&(o.materialObject.defines.FRAG_CLIPPING_MODE=C,o.materialObject.needsUpdate=!0),C=+w.clipInvert,o.materialObject.defines.FRAG_CLIPPING_INVERSE!==C&&(o.materialObject.defines.FRAG_CLIPPING_INVERSE=C,o.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:d=>{var o,l;return(this.enabled?"1":"0")+(!((l=(o=d.materialObject.userData)===null||o===void 0?void 0:o._fragmentClippingExt)===null||l===void 0)&&l.clipEnabled?"1":"0")},isCompatible:d=>d.isMeshStandardMaterial2||d.userData.isGBufferMaterial,updaters:()=>[],getUiConfig:d=>{const o=this._viewer,l={type:"folder",label:"FragmentClipping",children:[{type:"checkbox",label:"Enabled",getValue:()=>{var c;return((c=d.materialObject.userData._fragmentClippingExt)===null||c===void 0?void 0:c.clipEnabled)||!1},setValue:c=>{var u,h;c!==((u=d.materialObject.userData._fragmentClippingExt)===null||u===void 0?void 0:u.clipEnabled)&&(c?FragmentClippingExtensionPlugin_1.AddFragmentClipping(d.materialObject)||o.alert("Cannot add fragment clipping extension."):d.materialObject.userData._fragmentClippingExt&&(d.materialObject.userData._fragmentClippingExt.clipEnabled=!1,d.materialObject.needsUpdate=!0),(h=l.uiRefresh)===null||h===void 0||h.call(l,"postFrame",!0))},onChange:this.setDirty},()=>({type:"dropdown",label:"Mode",children:Object.entries(FragmentClippingMode).map(c=>({label:c[0],value:c[1]})),hidden:()=>{var c;return!(!((c=d.materialObject.userData._fragmentClippingExt)===null||c===void 0)&&c.clipEnabled)},property:[d.materialObject.userData._fragmentClippingExt,"clipMode"],onChange:this.setDirty}),()=>({type:"vec4",label:"Position",hidden:()=>{var c;return!(!((c=d.materialObject.userData._fragmentClippingExt)===null||c===void 0)&&c.clipEnabled)},property:[d.materialObject.userData._fragmentClippingExt,"clipPosition"],onChange:this.setDirty}),()=>({type:"vec4",label:"Params",hidden:()=>{var c;return!(!((c=d.materialObject.userData._fragmentClippingExt)===null||c===void 0)&&c.clipEnabled)},property:[d.materialObject.userData._fragmentClippingExt,"clipParams"],onChange:this.setDirty}),()=>({type:"toggle",label:"Invert",hidden:()=>{var c;return!(!((c=d.materialObject.userData._fragmentClippingExt)===null||c===void 0)&&c.clipEnabled)},property:[d.materialObject.userData._fragmentClippingExt,"clipInvert"],onChange:this.setDirty})]};return l}},this.setDirty=()=>{var d,o,l;(o=(d=this.materialExtension).setDirty)===null||o===void 0||o.call(d),(l=this._viewer)===null||l===void 0||l.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(d){var o,l,c,u,h,_,A;await super.onAdded(d);const w=d.getPlugin(AssetManagerPlugin);(o=w==null?void 0:w.materials)===null||o===void 0||o.registerMaterialExtension(this.materialExtension),(l=w==null?void 0:w.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=w==null?void 0:w.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(glTFMaterialsFragmentClippingExtensionExport),(A=(_=d.getPlugin(GBufferPlugin))===null||_===void 0?void 0:_.material)===null||A===void 0||A.registerMaterialExtensions([this.materialExtension])}async onRemove(d){var o,l,c,u;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(d)}};var FragmentClippingMode;FragmentClippingExtensionPlugin.PluginType="FragmentClippingExtensionPlugin1",FragmentClippingExtensionPlugin.FRAGMENT_CLIPPING_EXTENSION_GLTF_EXTENSION="WEBGI_materials_fragment_clipping_extension",FragmentClippingExtensionPlugin_decorate([uiToggle("Enabled",d=>({onChange:d.setDirty})),serialize()],FragmentClippingExtensionPlugin.prototype,"enabled",void 0),FragmentClippingExtensionPlugin=FragmentClippingExtensionPlugin_1=FragmentClippingExtensionPlugin_decorate([uiFolder("FragmentClipping Materials")],FragmentClippingExtensionPlugin),function(d){d[d.Circle=0]="Circle",d[d.Ellipse=1]="Ellipse",d[d.Rectangle=2]="Rectangle",d[d.Plane=3]="Plane",d[d.Sphere=4]="Sphere"}(FragmentClippingMode||(FragmentClippingMode={}));class GLTFMaterialsFragmentClippingExtensionImport{constructor(o){this.parser=o,this.name=FragmentClippingExtensionPlugin.FRAGMENT_CLIPPING_EXTENSION_GLTF_EXTENSION}async extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name];return l.userData||(l.userData={}),FragmentClippingExtensionPlugin.AddFragmentClipping(l),l.userData._fragmentClippingExt=deserializeObject(u,l.userData._fragmentClippingExt,!1,{}),Promise.resolve()}}const glTFMaterialsFragmentClippingExtensionExport=d=>({writeMaterial:(o,l)=>{if(!o.isMeshStandardMaterial||!o.userData._fragmentClippingExt||!o.userData._fragmentClippingExt.clipEnabled)return;l.extensions=l.extensions||{};const c=serializeObject(o.userData._fragmentClippingExt,!1);l.extensions[FragmentClippingExtensionPlugin.FRAGMENT_CLIPPING_EXTENSION_GLTF_EXTENSION]=c,d.extensionsUsed[FragmentClippingExtensionPlugin.FRAGMENT_CLIPPING_EXTENSION_GLTF_EXTENSION]=!0}});var hdriGroundProj=`#ifdef HDRi_GROUND_PROJ
float intersectPlane1(const in vec3 r0,const in vec3 rd,const in vec3 n,const in vec3 p0){float t=dot(p0-r0,n)/(dot(n,rd)+1e-6);return t<0.?1000.:t;}float intersectSphere1(in vec3 ro,in vec3 rd,in vec3 sph,in float rad){vec3 oc=ro-sph;float b=dot(oc,rd);float c=dot(oc,oc)-rad*rad;float t=b*b-c;return t<0.?t:-b+sqrt(t);}
#define PI_HALF  1.5707963267948966
uniform float worldRadius;uniform float tripodHeight;uniform vec3 originPosition;vec3 hdriProject(){vec3 p=normalize(vWorldDirection);vec3 camPos=cameraPosition;camPos.y-=tripodHeight;float t=intersectSphere1(camPos,p,originPosition,worldRadius);if(t>0.){float t2=intersectPlane1(camPos,p,vec3(0,-1,0),originPosition+vec3(0.,-tripodHeight,0.));p=(camPos+min(t,t2)*p)/worldRadius;}else p=vec3(0.,1.,0.);return p;}
#endif
`,HDRiGroundPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let HDRiGroundPlugin=class extends AViewerPlugin{constructor(d=!1){super(),this.enabled=!1,this.worldRadius=100,this.tripodHeight=10,this.originPosition=new three_module.Pq0(0,0,0),this._paramsChanged=this._paramsChanged.bind(this),this.enabled=d,this.addEventListener("deserialize",this._paramsChanged)}_paramsChanged(){var d,o,l,c;if(!this._viewer)return;const u=this._viewer.scene.background;if(this.enabled&&u!==this._viewer.scene.environment&&u!=="environment")if(u&&u.isDataTexture)u.mapping=three_module.wfO;else if(confirm("Background must be same as environment, do you want to change it?")){const A=this._viewer.getPluginByType("SimpleBackgroundEnvUiPlugin1");A?(A.envmapBg=!0,(o=(d=A.uiConfig).uiRefresh)===null||o===void 0||o.call(d,"postFrame",!0)):this._viewer.scene.setBackground("environment")}else this.enabled=!1;const h=(l=this._viewer.renderer.rendererObject.background.getBoxMesh2())===null||l===void 0?void 0:l.material,_=(c=h==null?void 0:h.uniforms)!==null&&c!==void 0?c:three_module.zkh.backgroundCube.uniforms;_.tripodHeight||(_.tripodHeight={value:1}),_.worldRadius||(_.worldRadius={value:1}),_.originPosition||(_.originPosition={value:new three_module.Pq0}),_.tripodHeight.value=this.tripodHeight,_.worldRadius.value=this.worldRadius,_.originPosition.value.copy(this.originPosition),h&&(!this.enabled&&h.defines.HDRi_GROUND_PROJ?delete h.defines.HDRi_GROUND_PROJ:this.enabled&&(h.defines.HDRi_GROUND_PROJ="1"),h.needsUpdate=!0),this._viewer.setDirty()}async onAdded(d){var o,l,c;await super.onAdded(d),!((c=(l=(o=this._viewer)===null||o===void 0?void 0:o.renderer)===null||l===void 0?void 0:l.rendererObject)===null||c===void 0)&&c.background.getBoxMesh()&&d.console.error("HDRi Ground Plugin must be added before setting any cube or env map"),three_module.zkh.backgroundCube.fragmentShader.includes("#ifdef HDRi_GROUND_PROJ")||(three_module.zkh.backgroundCube.fragmentShader=shaderReplaceString(three_module.zkh.backgroundCube.fragmentShader,"void main() {",hdriGroundProj,{prepend:!0}),three_module.zkh.backgroundCube.fragmentShader=shaderReplaceString(three_module.zkh.backgroundCube.fragmentShader,"vec3 vReflect = vWorldDirection;",`
vec3 vReflect = 
#ifdef HDRi_GROUND_PROJ
hdriProject()
#else
vWorldDirection
#endif
;
`)),d.scene.addEventListener("environmentChanged",this._paramsChanged)}};HDRiGroundPlugin.PluginType="HDRiGroundPlugin",HDRiGroundPlugin_decorate([serialize(),x(HDRiGroundPlugin.prototype._paramsChanged),uiToggle("Enabled")],HDRiGroundPlugin.prototype,"enabled",void 0),HDRiGroundPlugin_decorate([serialize(),x(HDRiGroundPlugin.prototype._paramsChanged),uiSlider("World Radius",[1,1e3],.01)],HDRiGroundPlugin.prototype,"worldRadius",void 0),HDRiGroundPlugin_decorate([serialize(),x(HDRiGroundPlugin.prototype._paramsChanged),uiSlider("Tripod height",[0,50],.01)],HDRiGroundPlugin.prototype,"tripodHeight",void 0),HDRiGroundPlugin_decorate([serialize(),x(HDRiGroundPlugin.prototype._paramsChanged),uiVector("Origin Position",void 0,.001,d=>({onChange:d._paramsChanged}))],HDRiGroundPlugin.prototype,"originPosition",void 0),HDRiGroundPlugin=HDRiGroundPlugin_decorate([uiFolder("HDRi Ground")],HDRiGroundPlugin);var SSContactShadows_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},SSContactShadows_1;let SSContactShadows=SSContactShadows_1=class extends AViewerPlugin{constructor(d=!0){super(),this.enabled=!0,this.radius=.015,this.intensity=1,this.tolerance=1.5,this._defines={},this.onlySSCSDebug=!1,this.stepCount=2,this.dependencies=[GBufferPlugin,AssetManagerPlugin],this.materialExtension={shaderExtender:(o,l,c)=>{if(!o.defines.SSCS_ENABLED)return;const u=fe`
                #ifndef D_sceneBoundingRadius
                #define D_sceneBoundingRadius
                uniform float sceneBoundingRadius;
                #endif
                float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, vec3 lightDirection ) {
                    vec3 ray_origin_view = -vViewPosition;
                    float rnd = interleavedGradientNoise(gl_FragCoord.xy, frameCount+34.);
                    float cameraDist = length(cameraPositionWorld);
//                    float radius = mix((cameraNearFar.y) + ray_origin_view.z, -ray_origin_view.z - cameraNearFar.x, rnd * 0.5 + 0.5)*sscsRadius;
                    float radius = mix((cameraDist + sceneBoundingRadius) + ray_origin_view.z, -ray_origin_view.z - max(0.0, cameraDist - sceneBoundingRadius), rnd * 0.5 + 0.5)*sscsRadius;
                    vec3 state = vec3(1.,(rnd+0.5)/float(SSCS_STEP_COUNT),2.);
                    traceRay(ray_origin_view, normalize(lightDirection) * radius, sscsTolerance * radius * 2., state, SSCS_STEP_COUNT);
                    state.z = state.z > 0.99 ? 1. : max(0.,min(state.z * state.z * (1.-sscsIntensity), 1.));
                    
                #if defined(SSCS_DEBUG) && SSCS_DEBUG > 0
                    return state.z;
                #endif
            `,h=`
#if SSCS_ENABLED

    uniform float sscsIntensity;
    uniform float sscsRadius;
    uniform float sscsTolerance;

    ${basicHelpers}
    
    #define THREE_PACKING_INCLUDED
    ${cameraHelpers}
    
    ${unpackGbuffer}
    ${randomHelpers}
    
    ${ssrt}

#endif
            
            `+three_module.vxI.shadowmap_pars_fragment.replace("float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {",`${u}
`).replace("return shadow;","return min(shadow, state.z);");o.fragmentShader=o.fragmentShader.replace("#include <shadowmap_pars_fragment>",h),o.fragmentShader=o.fragmentShader.replace("#include <lights_fragment_begin>",three_module.vxI.lights_fragment_begin),o.fragmentShader=shaderReplaceString(o.fragmentShader,"directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ], directLight.direction ) : 1.0;"),o.fragmentShader=shaderReplaceString(o.fragmentShader,"directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;","directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ], directLight.direction ) : 1.0;")},onObjectRender:(o,l,c)=>{var u,h;const _=l.materialObject;let A=!this.enabled||c.userData.screenSpaceRendering===!1||!((u=_.userData)===null||u===void 0)&&u.sscsDisabled||!((h=_.userData)===null||h===void 0)&&h.pluginsDisabled?0:1;_.defines.SSCS_ENABLED!==A&&(_.defines.SSCS_ENABLED=A,_.needsUpdate=!0),A=this._defines.SSCS_STEP_COUNT,_.defines.SSCS_STEP_COUNT!==A&&(_.defines.SSCS_STEP_COUNT=A,_.needsUpdate=!0),A=+this._defines.SSCS_DEBUG,_.defines.SSCS_DEBUG!==A&&(_.defines.SSCS_DEBUG=A,_.needsUpdate=!0)},parsFragmentSnippet:()=>`
`,extraUniforms:{...SSContactShadows_1._uniforms},computeCacheKey:o=>this.enabled?"1":"0",isCompatible:o=>o.isMeshStandardMaterial2,updaters:()=>{var o,l,c,u,h;return[(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(GBufferPlugin),(l=this._viewer)===null||l===void 0?void 0:l.getPlugin(ProgressivePlugin),(c=this._viewer)===null||c===void 0?void 0:c.scene.renderCamera,(u=this._viewer)===null||u===void 0?void 0:u.renderer,(h=this._viewer)===null||h===void 0?void 0:h.scene]}},this.enabled=d,this.userData={setDirty:()=>{var o;(o=this._viewer)===null||o===void 0||o.setDirty()}}}async onAdded(d){var o,l;await super.onAdded(d),(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.registerMaterialExtension(this.materialExtension)}async onRemove(d){var o,l;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),super.onRemove(d)}};SSContactShadows.PluginType="SSContactShadows",SSContactShadows._uniforms={tNormalDepth:{value:null},frameCount:{value:0},projection:{value:new three_module.kn4},cameraPositionWorld:{value:new three_module.Pq0},cameraNearFar:{value:new three_module.I9Y(.1,1e3)},sceneBoundingRadius:{value:0}},SSContactShadows_decorate([uiToggle("Enabled"),serialize()],SSContactShadows.prototype,"enabled",void 0),SSContactShadows_decorate([uniform({uniforms:SSContactShadows._uniforms,propKey:"sscsRadius"}),uiSlider("Radius",[1e-4,.1],1e-4),serialize()],SSContactShadows.prototype,"radius",void 0),SSContactShadows_decorate([uniform({uniforms:SSContactShadows._uniforms,propKey:"sscsIntensity"}),uiSlider("Intensity",[1e-4,1],1e-4),serialize()],SSContactShadows.prototype,"intensity",void 0),SSContactShadows_decorate([uniform({uniforms:SSContactShadows._uniforms,propKey:"sscsTolerance"}),uiSlider("Tolerance",[.1,5]),serialize()],SSContactShadows.prototype,"tolerance",void 0),SSContactShadows_decorate([matDefine("SSCS_DEBUG",void 0,!0),uiToggle("Debug only SSCS"),serialize()],SSContactShadows.prototype,"onlySSCSDebug",void 0),SSContactShadows_decorate([matDefine("SSCS_STEP_COUNT",void 0,!0),uiSlider("Step count",[1,8],1),serialize()],SSContactShadows.prototype,"stepCount",void 0),SSContactShadows=SSContactShadows_1=SSContactShadows_decorate([uiFolder("Screen Space Contact Shadows")],SSContactShadows);var cubeNormalVert=`varying vec3 vNormal;varying vec3 vecPosition;uniform mat4 offsetMatrixInv;uniform vec3 offsetCenter;
#include <morphtarget_pars_vertex>
void main(){vNormal=normalize((offsetMatrixInv*vec4(normal,0.)).xyz);
#include <begin_vertex>
transformed-=offsetCenter;
#include <morphtarget_vertex>
vec4 offsetPos=offsetMatrixInv*vec4(transformed,1.);vecPosition=(modelMatrix*offsetPos).xyz;gl_Position=projectionMatrix*modelViewMatrix*offsetPos;}`,cubeNormalFrag="varying vec3 vNormal;varying vec3 vecPosition;uniform float radius;void main(){vec3 color=normalize(vNormal);color=color*0.5+0.5;gl_FragColor=vec4(color.x,color.y,color.z,length(vecPosition)/radius);}";class CubeNormalsCaptureHelper{constructor(o){this._normalsCache={},this._renderer=o,this._scene=new three_module.Z58,this._mesh=new three_module.eaF,this._mesh.frustumCulled=!1,this._scene.add(this._mesh),this._mesh.position.set(0,0,0),this._mesh.material=new NormalCaptureMaterial}dispose(){var o;(o=this._mesh.geometry)===null||o===void 0||o.dispose(),this._mesh.material.dispose(),this.disposeAllTargets()}disposeTarget(o){o.split(";").forEach(l=>{var c;return(c=this._normalsCache[l])===null||c===void 0?void 0:c.dispose()})}disposeAllTargets(){Object.values(this._normalsCache).forEach(o=>o.dispose()),this._normalsCache={}}hasCapturedNormalMap(o){return!!o.userData._normalsCaptureMap}_getPrecisionType(o){return o==="low"?three_module.OUM:o==="medium"?three_module.ix0:o==="high"?three_module.RQf:three_module.ix0}captureNormalMap(o,l,c=512,u="medium",h){if(!o)throw"No geometry";if(this.hasCapturedNormalMap(o))return!1;const _=l==null?void 0:l.split(";").find(C=>this._normalsCache[C]);if(_){const C=this._normalsCache[_];return l==null||l.split(";").forEach(M=>M!==_&&(this._normalsCache[M]=C)),C.width!==c&&console.warn("last cacheKey normalMapRes mismatch, check model",c),o.userData._normalsCaptureMap=C,!1}const A=this._renderer.createTargetCustom({width:c,height:c},{minFilter:three_module.hxR,magFilter:three_module.hxR,generateMipmaps:!1,type:this._getPrecisionType(u)},three_module.o6l);if(A.attachedGeometries=[],A.autoDispose=CubeNormalsCaptureHelper.AutoDisposeTargets,!A)throw"Unable to create render target";const w=()=>{var C;const M=new three_module.F1T(1e-4,100,A);this._scene.add(M);const O=o.userData.normalsCaptureOffsets;O.center!==void 0&&this._mesh.material.uniforms.offsetCenter.value.fromArray(O.center),O.offsetMatrixInv!==void 0&&this._mesh.material.uniforms.offsetMatrixInv.value.fromArray(O.offsetMatrixInv),O.radius!==void 0&&(this._mesh.material.uniforms.radius.value=O.radius),this._mesh.geometry=o,h!=null&&h.morphTargetInfluences&&(!((C=o.morphAttributes)===null||C===void 0)&&C.position)&&(this._mesh.morphTargetInfluences=h.morphTargetInfluences,this._mesh.morphTargetDictionary=h.morphTargetDictionary);const ne=this._renderer.rendererObject.getClearColor(new three_module.Q1f),ce=this._renderer.rendererObject.getClearAlpha();this._renderer.rendererObject.setClearColor(new three_module.Q1f(0,0,0),1),M.update(this._renderer.rendererObject,this._scene),this._renderer.rendererObject.setClearColor(ne,ce),this._mesh.morphTargetInfluences=void 0,this._mesh.morphTargetDictionary=void 0,this._scene.remove(M),this._mesh.geometry=void 0,o.userData._normalsCaptureMap=A};return w(),this._renderer.addEventListener("contextRestored",w),A.attachedGeometries.push(o),o.addEventListener("dispose",()=>{var C,M;A.attachedGeometries=(M=(C=A.attachedGeometries)===null||C===void 0?void 0:C.filter(O=>O!==o))!==null&&M!==void 0?M:[],delete o.userData._normalsCaptureMap,this._renderer.removeEventListener("contextRestored",w),A.autoDispose&&!A.attachedGeometries.length&&A.dispose()}),l==null||l.split(";").forEach(C=>this._normalsCache[C]=A),A.addEventListener("dispose",()=>{var C;l==null||l.split(";").forEach(M=>delete this._normalsCache[M]),this._renderer.removeEventListener("contextRestored",w),(C=A.attachedGeometries)===null||C===void 0||C.forEach(M=>delete M.userData._normalsCaptureMap)}),!0}removeNormalMap(o){o.userData._normalsCaptureMap&&(o.userData._normalsCaptureMap.dispose(),delete o.userData._normalsCaptureMap)}}CubeNormalsCaptureHelper.AutoDisposeTargets=!0;class NormalCaptureMaterial extends three_module.BKk{constructor(){super({vertexShader:cubeNormalVert,fragmentShader:cubeNormalFrag,side:three_module.$EB,clipping:!1,uniforms:{radius:{value:1},offsetMatrixInv:{value:new three_module.kn4().identity()},offsetCenter:{value:new three_module.Pq0}}})}}var diamond_frag=`varying vec3 vWorldNormal;varying vec3 vWorldPosition;varying vec3 vViewPosition;varying vec3 vNormal;varying vec2 vUv;uniform float radius;uniform vec3 centerOffset;
#ifdef USE_INSTANCING
varying mat4 vModelInstanceOffsetMatrix;varying mat4 vModelInstanceOffsetMatrixInv;
#define MODEL_OFFSET_MATRIX  vModelInstanceOffsetMatrix
#define INV_MODEL_OFFSET_MATRIX  vModelInstanceOffsetMatrixInv
#else
uniform mat4 modelOffsetMatrixInv;uniform mat4 modelOffsetMatrix;
#define MODEL_OFFSET_MATRIX  modelOffsetMatrix
#define INV_MODEL_OFFSET_MATRIX  modelOffsetMatrixInv
#endif
#ifdef USE_MORPHTARGETS
varying vec3 vCenterOffset;
#define CENTER_OFFSET  (centerOffset + vCenterOffset)
#else
#define CENTER_OFFSET  (centerOffset) 
#endif
uniform mat4 projectionMatrix;uniform samplerCube tCubeMapNormals;
#if ENV_MAP_TYPE == 0
uniform samplerCube envMap;
#elif ENV_MAP_TYPE == 1
uniform sampler2D envMap;
#endif
uniform float envMapIntensity;uniform float transmission;uniform vec2 transmissionSamplerSize;uniform sampler2D transmissionSamplerMap;uniform float refractiveIndex;uniform float rIndexDelta;uniform float squashFactor;uniform float geometryFactor;uniform vec3 color;uniform vec3 colorCorrection;uniform vec3 boostFactors;uniform float gammaFactor;uniform float absorptionFactor;uniform float envMapRotation;uniform vec4 envMapRotationQuat;uniform float reflectivity;vec3 BRDF_Specular_GGX_Environment(const in vec3 viewDir,const in vec3 normal,const in vec3 specularColor,const in float roughness){float dotNV=abs(dot(normal,viewDir));const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec2 cartesianToPolar(vec3 n){vec2 uv;uv.x=atan(n.z,n.x)/(PI*2.)+0.5;uv.y=asin(n.y)/PI+0.5;return uv;}vec4 sampleEnvMap(vec3 direction){
#if !defined(USE_ENVMAP)
return vec4(direction,1);
#else
float cs=cos(envMapRotation);float sn=sin(envMapRotation);float temp=cs*direction.x+sn*direction.z;direction.z=-sn*direction.x+cs*direction.z;direction.x=temp;direction.x*=-1.;direction.y*=-1.;direction.z*=-1.;vec3 t=2.*cross(envMapRotationQuat.xyz,direction);direction+=envMapRotationQuat.w*t+cross(envMapRotationQuat.xyz,t);
#if ENV_MAP_TYPE == 0
return(textureCube(envMap,direction));
#elif ENV_MAP_TYPE == 1
return(texture2D(envMap,cartesianToPolar(direction)));
#endif
return vec4(1,0,1,1);
#endif
}vec4 SampleSpecularReflection(vec3 direction){
#if defined(FIX_ENV_DIRECTION)
direction=(viewMatrix*vec4(direction,0.)).xyz;
#endif
return envMapIntensity*(sampleEnvMap(direction));}vec4 SampleSpecularContribution(vec3 direction){
#if DIA_ORIENT_ENVMAP < 1
direction=mat3(MODEL_OFFSET_MATRIX)*direction;
#endif
#if defined(FIX_ENV_DIRECTION)
direction=(viewMatrix*vec4(direction,0.)).xyz;
#endif
direction=normalize(direction);direction.x*=-1.;direction.z*=-1.;return envMapIntensity*(sampleEnvMap(direction));}vec4 SampleSpecularContributionRef(vec3 origin,int i){vec4 ndcPos=projectionMatrix*viewMatrix*vec4(origin,1.);vec2 refractionCoords=ndcPos.xy/ndcPos.w;refractionCoords+=1.;refractionCoords/=2.;return transmissionSamplerMapTexelToLinear(texture2D(transmissionSamplerMap,refractionCoords));}vec3 intersectSphere(vec3 origin,vec3 direction){origin-=CENTER_OFFSET;direction.y/=squashFactor;float A=dot(direction,direction);float B=2.*dot(origin,direction);float C=dot(origin,origin)-radius*radius;float disc=B*B-4.*A*C;if(disc>0.){disc=sqrt(disc);float t1=(-B+disc)*geometryFactor/A;float t2=(-B-disc)*geometryFactor/A;float t=(t1>t2)?t1:t2;direction.y*=squashFactor;return vec3(origin+CENTER_OFFSET+direction*t);}return vec3(0.);}vec3 linePlaneIntersect(in vec3 pointOnLine,in vec3 lineDirection,in vec3 pointOnPlane,in vec3 planeNormal){return lineDirection*(dot(planeNormal,pointOnPlane-pointOnLine)/dot(planeNormal,lineDirection))+pointOnLine;}vec4 getNormalDistance(vec3 d){return textureCube(tCubeMapNormals,d);}vec3 getSurfaceNormal(vec4 surfaceInfos){vec3 surfaceNormal=surfaceInfos.rgb;surfaceNormal=surfaceNormal*2.-1.;return-normalize(surfaceNormal);}vec3 intersect(vec3 rayOrigin,vec3 rayDirection){vec3 sphereHitPoint=intersectSphere(rayOrigin,rayDirection);vec3 direction1=normalize(sphereHitPoint-CENTER_OFFSET);vec4 normalDistanceData1=getNormalDistance(direction1);float distance1=normalDistanceData1.a*radius;vec3 pointOnPlane1=CENTER_OFFSET+direction1*distance1;vec3 planeNormal1=getSurfaceNormal(normalDistanceData1);vec3 hitPoint1=linePlaneIntersect(rayOrigin,rayDirection,pointOnPlane1,planeNormal1);vec3 direction2=normalize(hitPoint1-CENTER_OFFSET);vec4 normalDistanceData2=getNormalDistance(direction2);float distance2=normalDistanceData2.a*radius;vec3 pointOnPlane2=CENTER_OFFSET+direction2*distance2;vec3 hitPoint=hitPoint1;vec3 planeNormal2=getSurfaceNormal(normalDistanceData2);hitPoint=linePlaneIntersect(rayOrigin,rayDirection,pointOnPlane2,planeNormal2);return hitPoint;}vec3 debugBounces(int count){vec3 color=vec3(1.,1.,1.);if(count==1)color=vec3(0.,1.,0.);else if(count==2)color=vec3(0.,0.,1.);else if(count==3)color=vec3(1.,1.,0.);else if(count==4)color=vec3(0.,1.,1.);else color=vec3(0.,1.,0.);if(count==0)color=vec3(1.,0.,0.);return color;}vec3 getRefractionColor(vec3 origin,vec3 direction,vec3 normal){vec3 outColor=vec3(0.);const float n1=1.;const float epsilon=1e-4;float f0=(2.4-n1)/(2.4+n1);f0*=f0;vec3 attenuationFactor=vec3(1.);vec3 newDirection=refract(direction,normal,n1/refractiveIndex);vec3 brdfRefracted=BRDF_Specular_GGX_Environment(newDirection,-normal,vec3(f0),0.);attenuationFactor*=(vec3(1.)-brdfRefracted);int count=0;mat4 invModelOffsetMatrix=INV_MODEL_OFFSET_MATRIX;newDirection=normalize((invModelOffsetMatrix*vec4(newDirection,0.)).xyz);origin=(invModelOffsetMatrix*vec4(origin,1.)).xyz;for(int i=0;i<RAY_BOUNCES;i++){vec3 intersectedPos=intersect(origin,newDirection);vec3 dist=intersectedPos-origin;vec3 d=normalize(intersectedPos-CENTER_OFFSET);vec3 mappedNormal=getNormalDistance(d).rgb;mappedNormal=2.*mappedNormal-1.;mappedNormal=-normalize(mappedNormal);float r=length(dist)/radius*absorptionFactor;attenuationFactor*=exp(-r*(1.-color));origin=intersectedPos;vec3 origin2=(MODEL_OFFSET_MATRIX*vec4(intersectedPos,1)).xyz;vec3 oldDir=newDirection;newDirection=refract(newDirection,mappedNormal,refractiveIndex/n1);if(dot(newDirection,newDirection)<epsilon){newDirection=reflect(oldDir,mappedNormal);if(i==RAY_BOUNCES-1){vec3 brdfReflected=BRDF_Specular_GGX_Environment(-oldDir,mappedNormal,vec3(f0),0.);vec3 d1=mat3(MODEL_OFFSET_MATRIX)*oldDir;d1=normalize(d1);float cosT=1.-dot(direction,d1);outColor+=((transmission>0.&&cosT<transmission)?SampleSpecularContributionRef(origin2+0.5*d1*cosT,i).rgb:SampleSpecularContribution(oldDir).rgb)*attenuationFactor*colorCorrection*boostFactors*(vec3(1.)-min(vec3(1.),brdfReflected));}}else{vec3 brdfRefracted=vec3(1.)-min(vec3(1.),BRDF_Specular_GGX_Environment(newDirection,-mappedNormal,vec3(f0),0.));vec3 d1=normalize(mat3(MODEL_OFFSET_MATRIX)*newDirection);float cosT=1.-dot(direction,d1);if(transmission>0.&&cosT<transmission){outColor+=SampleSpecularContributionRef(origin2+0.5*d1*cosT,i).rgb*brdfRefracted*attenuationFactor*colorCorrection*boostFactors;}else{vec3 dir0=newDirection;vec3 dir1=refract(oldDir,mappedNormal,(refractiveIndex+rIndexDelta)/n1);vec3 dir2=refract(oldDir,mappedNormal,(refractiveIndex-rIndexDelta)/n1);outColor+=vec3(SampleSpecularContribution(dir1).r,SampleSpecularContribution(dir0).g,SampleSpecularContribution(dir2).b)*brdfRefracted*attenuationFactor*colorCorrection*boostFactors;}newDirection=reflect(oldDir,mappedNormal);vec3 brdfReflected=BRDF_Specular_GGX_Environment(newDirection,mappedNormal,vec3(f0),0.);attenuationFactor*=brdfReflected*boostFactors;count++;}}return outColor;}void main(){vec3 normalizedNormal=normalize(vWorldNormal);vec3 viewVector=normalize(vWorldPosition-cameraPosition);const float n1=1.;const float epsilon=1e-4;float f0=(2.4-n1)/(2.4+n1);f0*=f0;vec3 attenuationFactor=vec3(1.);vec3 reflectedDirection=reflect(viewVector,normalizedNormal);vec3 brdfReflected=BRDF_Specular_GGX_Environment(reflectedDirection,normalizedNormal,vec3(f0),0.);vec3 reflectionColor=SampleSpecularReflection(reflectedDirection).rgb*brdfReflected*reflectivity*2.;vec3 refractionColor=getRefractionColor(vWorldPosition,viewVector,normalizedNormal);vec3 normal=normalize(vNormal);vec3 diffuseColor=vec3(1.);
#glMarker beforeAccumulation
gl_FragColor=vec4((refractionColor.rgb+reflectionColor.rgb)*diffuseColor,1.);gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(gammaFactor));gl_FragColor.rgb=max(gl_FragColor.rgb,0.);
#include <colorspace_fragment>
}`,diamond_vert=`#ifndef USE_ENVMAP
#define USE_ENVMAP  
#endif
varying vec3 vWorldPosition;varying vec3 vWorldNormal;varying vec3 vViewPosition;varying vec3 vNormal;varying vec2 vUv;
#ifdef USE_INSTANCING
uniform mat4 inverseModelMatrix;uniform mat4 modelOffsetMatrix;varying mat4 vModelInstanceOffsetMatrix;varying mat4 vModelInstanceOffsetMatrixInv;
#endif
#include <morphtarget_pars_vertex>
#ifdef USE_MORPHTARGETS
varying vec3 vCenterOffset;
#ifndef USE_INSTANCING
uniform mat4 modelOffsetMatrixInv;
#endif
#endif
void main(){
#ifdef USE_INSTANCING
vWorldNormal=(modelMatrix*instanceMatrix*vec4(normal,0.)).xyz;
#else
vWorldNormal=(modelMatrix*vec4(normal,0.)).xyz;
#endif
#include <beginnormal_vertex>
#include <defaultnormal_vertex>
#include <normal_vertex>
#include <begin_vertex>
#ifdef USE_MORPHTARGETS
vCenterOffset=transformed;
#include <morphtarget_vertex>
vCenterOffset=transformed-vCenterOffset;
#ifndef USE_INSTANCING
vCenterOffset=(modelOffsetMatrixInv*modelMatrix*vec4(vCenterOffset,1.)).xyz;
#endif
#endif
#include <project_vertex>
vViewPosition=-mvPosition.xyz;vUv=uv;
#include <worldpos_vertex>
vWorldPosition=worldPosition.xyz;
#ifdef USE_INSTANCING
vModelInstanceOffsetMatrix=modelMatrix*instanceMatrix*inverseModelMatrix*modelOffsetMatrix;vModelInstanceOffsetMatrixInv=inverse(vModelInstanceOffsetMatrix);
#ifdef USE_MORPHTARGETS
vCenterOffset=(vModelInstanceOffsetMatrixInv*modelMatrix*vec4(vCenterOffset,1.)).xyz;
#endif
#endif
}`,pca=__webpackgi_require__(391);function computeOffsetMatrix(d){const o=new three_module.Pq0(0,0,0),l=new three_module.Pq0(0,0,0),c=new three_module.Pq0(0,0,0),u=new three_module.Pq0(0,0,0),h=d.getAttribute("position"),_=d.index;if(_)for(let ne=Math.max(0,d.drawRange.start),ce=Math.min(_.count,d.drawRange.start+d.drawRange.count)-1;ne<ce/3;ne+=3){const ue=_.getX(ne),ye=_.getX(ne+1),Oe=_.getX(ne+2);l.set(h.getX(ue),h.getY(ue),h.getZ(ue)),c.set(h.getX(ye),h.getY(ye),h.getZ(ye)),u.set(h.getX(Oe),h.getY(Oe),h.getZ(Oe)),c.sub(l),u.sub(l),u.cross(c),u.normalize(),o.add(u)}else for(let ne=0;ne<h.count;ne+=3)l.set(h.getX(ne),h.getY(ne),h.getZ(ne)),c.set(h.getX(ne+1),h.getY(ne+1),h.getZ(ne+1)),u.set(h.getX(ne+2),h.getY(ne+2),h.getZ(ne+2)),c.sub(l),u.sub(l),u.cross(c),u.normalize(),o.add(u);o.normalize();let A=!1,w=0;for(;!A;){const ne=w/3,ce=_?_.getX(ne):ne,ue=_?_.getX(ne+1):ne+1;l.set(h.getX(ce),h.getY(ce),h.getZ(ce)),c.set(h.getX(ue),h.getY(ue),h.getZ(ue)),l.sub(c),l.normalize();const ye=o.dot(l);Math.abs(ye-1)>.001&&l.length()>.5&&(A=!0),w+=3}c.crossVectors(l,o),c.normalize(),l.crossVectors(o,c),l.normalize();const C=new three_module.kn4;C.elements[0]=l.x,C.elements[1]=l.y,C.elements[2]=l.z,C.elements[3]=0,C.elements[4]=o.x,C.elements[5]=o.y,C.elements[6]=o.z,C.elements[7]=0,C.elements[8]=c.x,C.elements[9]=c.y,C.elements[10]=c.z,C.elements[11]=0,C.elements[12]=0,C.elements[13]=0,C.elements[14]=0,C.elements[15]=1,d.computeBoundingSphere();const M=d.boundingSphere.radius,O=new three_module.kn4().makeScale(M,M,M);return C.multiply(O),C}function SignedTetrahedronVolume(d,o,l){const c=new three_module.Pq0().copy(d),u=new three_module.Pq0().copy(o),h=new three_module.Pq0().copy(l);return c.dot(u.cross(h))/6}function TriangleArea(d,o,l){const c=new three_module.Pq0().copy(d),u=new three_module.Pq0().copy(o),h=new three_module.Pq0().copy(l);return u.sub(c),h.sub(c),h.cross(u),.5*h.length()}function computeCenterAndCOM(d,o){const l=new three_module.Pq0;for(let O=0;O<d.length;O+=3)l.x+=d[O],l.y+=d[O+1],l.z+=d[O+2];l.multiplyScalar(1/(d.length/3));const c=new three_module.Pq0,u=new three_module.Pq0,h=new three_module.Pq0,_=new three_module.Pq0,A=new three_module.Pq0;let w=0,C=0,M=o.length;M%3!=0&&(M-=M%3);for(let O=0;O<M;O+=3){c.set(o[O][0],o[O][1],o[O][2]),u.set(o[O+1][0],o[O+1][1],o[O+1][2]),h.set(o[O+2][0],o[O+2][1],o[O+2][2]),A.copy(c).add(u).add(h);const ne=TriangleArea(c,u,h);A.multiplyScalar(ne/3),_.add(A),w+=ne,C+=SignedTetrahedronVolume(c,u,h)}return _.multiplyScalar(1/w),{center:l,com:_,volume:C,area:w}}function computeEigenVectors(d){const o=d.getAttribute("position"),l=d.getAttribute("normal");if(o.count/3>1500)return console.warn("DiamondPlugin:: Too many faces. Mirror/Topology issues will not be fixed",o.count/3),computeOffsetMatrix(d);const c=new three_module.Pq0(0,0,0),u=new three_module.Pq0(0,0,0),h=new three_module.Pq0(0,0,0),_=d.index,A=[];if(_)for(let ke=Math.max(0,d.drawRange.start),Ve=Math.min(_.count,d.drawRange.start+d.drawRange.count)-1;ke<Ve;ke+=3){const tt=_.getX(ke),ht=_.getX(ke+1),ut=_.getX(ke+2);c.set(o.getX(tt),o.getY(tt),o.getZ(tt)),u.set(o.getX(ht),o.getY(ht),o.getZ(ht)),h.set(o.getX(ut),o.getY(ut),o.getZ(ut)),A.push(c.toArray(),u.toArray(),h.toArray())}else for(let ke=0;ke<o.count;ke++)c.set(o.getX(ke),o.getY(ke),o.getZ(ke)),A.push(c.toArray());const w=computeCenterAndCOM(o.array,A);if(w.volume<0){console.warn("DiamondPlugin:: Negative Volume, Fixing Normals");for(let ke=0;ke<l.count;ke++)l.setX(ke,-l.getX(ke)),l.setY(ke,-l.getY(ke)),l.setZ(ke,-l.getZ(ke));l.needsUpdate=!0}const C=[];for(let ke=0;ke<o.array.length;ke+=3)C.push([o.array[ke],o.array[ke+1],o.array[ke+2]]);const M=console.log;console.log=()=>{};const O=(0,pca.getEigenVectors)(C);console.log=M;const ne=new three_module.kn4;ne.elements[0]=O[0].vector[0],ne.elements[1]=O[0].vector[1],ne.elements[2]=O[0].vector[2],ne.elements[3]=0,ne.elements[4]=O[1].vector[0],ne.elements[5]=O[1].vector[1],ne.elements[6]=O[1].vector[2],ne.elements[7]=0,ne.elements[8]=O[2].vector[0],ne.elements[9]=O[2].vector[1],ne.elements[10]=O[2].vector[2],ne.elements[11]=0,ne.elements[12]=0,ne.elements[13]=0,ne.elements[14]=0,ne.elements[15]=1;const ce=new three_module.Pq0;ce.copy(w.com).sub(w.center),ce.normalize();const ue=new three_module.Pq0(O[2].vector[0],O[2].vector[1],O[2].vector[2]);ce.dot(ue)<0&&(ne.elements[4]=-O[1].vector[0],ne.elements[5]=-O[1].vector[1],ne.elements[6]=-O[1].vector[2],ne.elements[8]=-O[2].vector[0],ne.elements[9]=-O[2].vector[1],ne.elements[10]=-O[2].vector[2]),d.computeBoundingSphere();const ye=d.boundingSphere.radius,Oe=new three_module.kn4().makeScale(ye,ye,ye);return ne.multiply(Oe),ne}const diamondMaterialPropList={...threeMaterialPropList,color:new three_module.Q1f(1,1,1),envMapIntensity:1,envMapRotation:0,dispersion:.012,squashFactor:.98,geometryFactor:.5,gammaFactor:1,absorptionFactor:1,reflectivity:.5,refractiveIndex:2.4,boostFactors:new three_module.Pq0(.892,.892,.98595025),wireframe:!1,envMapRotationOffset:0,wireframeLinewidth:0,skinning:!1,transmission:0,morphTargets:!1,morphNormals:!1,rayBounces:1,diamondOrientedEnvMap:0,envMapIndex:0};var diamondMaterial_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class DiamondMaterial extends three_module.BKk{get mmMaterial(){return this}get materialObject(){return this}onBeforeRender(o,l,c,u,h){var _,A;super.onBeforeRender(o,l,c,u,h),this.envMapIntensity===void 0||this.userData.separateEnvMapIntensity||l.envMapIntensity===void 0||(this.userData.__envIntensity=this.envMapIntensity,this.envMapIntensity=l.envMapIntensity),this.envMap!==void 0&&l.fixedEnvMapDirection!==void 0&&(l.fixedEnvMapDirection?this.defines.FIX_ENV_DIRECTION||(this.defines.FIX_ENV_DIRECTION="1",this.needsUpdate=!0):this.defines.FIX_ENV_DIRECTION!==void 0&&(delete this.defines.FIX_ENV_DIRECTION,this.needsUpdate=!0)),this.uniforms.envMapRotation.value=(((_=this.envMap)===null||_===void 0?void 0:_.rotation)||0)+this.envMapRotationOffset,this.uniforms.envMapRotationQuat.value.setFromEuler(new three_module.O9p(this.envMapRotationOffsetX,this.envMapRotationOffsetY,this.envMapRotationOffsetZ)),this.extraUniformsToUpload.inverseModelMatrix.value.copy(h.matrixWorld).invert();const w=u.userData.normalsCaptureOffsets;w&&(this.extraUniformsToUpload.centerOffset.value.fromArray(w.centerOffset),this.extraUniformsToUpload.modelOffsetMatrix.value.fromArray(w.offsetMatrix).premultiply(h.matrixWorld),this.extraUniformsToUpload.modelOffsetMatrixInv.value.copy(this.extraUniformsToUpload.modelOffsetMatrix.value).invert(),this.extraUniformsToUpload.radius.value=w.radius);const C=(A=u.userData._normalsCaptureMap)===null||A===void 0?void 0:A.texture;this.normalsCaptureMap!==C&&(this.normalsCaptureMap=C),this.dispatchEvent({type:"beforeRender",renderer:o,scene:l,camera:c,geometry:u,object:h})}onAfterRender(o,l,c,u,h){super.onAfterRender(o,l,c,u,h),this.userData.__envIntensity!==void 0&&(this.envMapIntensity=this.userData.__envIntensity,delete this.userData.__envIntensity),this.dispatchEvent({type:"afterRender",renderer:o,scene:l,camera:c,geometry:u,object:h})}constructor(o){var l;super({side:three_module.$EB,defines:{DIA_ORIENT_ENVMAP:0,RAY_BOUNCES:5,ENV_MAP_TYPE:0,PI:3.1428},vertexShader:diamond_vert,fragmentShader:diamond_frag,uniforms:{envMap:{value:(o==null?void 0:o.envMap)||null},envMapRotation:{value:0},envMapRotationQuat:{value:new three_module.PTz},transmission:{value:0},transmissionSamplerMap:{value:null},transmissionSamplerSize:{value:new three_module.I9Y},normalOffset:{value:0},distanceOffset:{value:0},colorCorrection:{value:new three_module.Pq0(1,1,1)}}}),this.typeSlug=DiamondMaterial.TypeSlug,this.assetType="material",this.__envMap=[],this.isDiamondMaterial=!0,this.color=new three_module.Q1f(1,1,1),this.envMapIntensity=1,this.envMapRotationOffset=0,this.envMapRotationOffsetX=0,this.envMapRotationOffsetY=0,this.envMapRotationOffsetZ=0,this.dispersion=.012,this.absorptionFactor=1,this.refractiveIndex=2.4,this.squashFactor=.98,this.geometryFactor=.5,this.gammaFactor=1,this.boostFactors=new three_module.Pq0(.892,.892,.98595025),this.transmission=0,this.reflectivity=.5,this.rayBounces=5,this.diamondOrientedEnvMap=0,this.normalsCaptureMap=null,this.extraUniformsToUpload={inverseModelMatrix:{value:new three_module.kn4().identity()},radius:{value:1},centerOffset:{value:new three_module.Pq0(0,0,0)},modelOffsetMatrix:{value:new three_module.kn4().identity()},modelOffsetMatrixInv:{value:new three_module.kn4().identity()}},this.envMapIndex=0,this.setDirty=this.setDirty.bind(this),this.userData.setDirty=c=>{console.warn("WebGi DiamondMaterial: userData.setDirty is deprecated. Use setDirty instead."),this.setDirty(c)},this.userData.separateEnvMapIntensity=!0,o&&this.setValues(o),this.materialExtensions=MaterialExtender.RegisterExtensions(this,(l=o==null?void 0:o.customMaterialExtensions)!==null&&l!==void 0?l:[])}registerMaterialExtensions(o){this.materialExtensions=[...this.materialExtensions,...MaterialExtender.RegisterExtensions(this,o)]}unregisterMaterialExtensions(o){}onBeforeCompile(o,l){MaterialExtender.ApplyMaterialExtensions(this,o,this.materialExtensions,l),this.dispatchEvent({type:"beforeCompile",shader:o,renderer:l}),o.fragmentShader=o.fragmentShader.replaceAll("#glMarker","// "),o.vertexShader=o.vertexShader.replaceAll("#glMarker","// "),super.onBeforeCompile(o,l)}customProgramCacheKey(){return super.customProgramCacheKey()+MaterialExtender.CacheKeyForExtensions(this,this.materialExtensions)}setDirty(o){var l,c;this.needsUpdate=!0,this.dispatchEvent({...o,type:"materialUpdate",frameFade:o==null?void 0:o.last}),(o==null?void 0:o.last)!==!1&&((c=(l=this._uiConfig)===null||l===void 0?void 0:l.uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0,1))}set envMaps(o){this.__envMap=o,this.refreshEnvUniform()}refreshEnvUniform(){var o;this.uniforms.envMap.value=this.envMap,this.defines.ENV_MAP_TYPE=!((o=this.uniforms.envMap.value)===null||o===void 0)&&o.isCubeTexture?0:1,this.needsUpdate=!0}get envMap(){var o,l;return(l=(o=this.__envMap[this.envMapIndex])!==null&&o!==void 0?o:this.__envMap[0])!==null&&l!==void 0?l:null}set envMap(o){console.error("Setting separate envmap for individual diamond material not supported yet.")}clone(){return super.clone()}toJSON(o){const l={metadata:{version:4.6,type:"DiamondMaterial",generator:"DiamondMaterial.toJSON"}};return l.name=this.name,l.uuid=this.uuid,l.color=this.color.getHex(),l.envMapIntensity=this.envMapIntensity,l.envMapIndex=this.envMapIndex,l.envMapRotationOffset=this.envMapRotationOffset,l.dispersion=this.dispersion,l.squashFactor=this.squashFactor,l.geometryFactor=this.geometryFactor,l.gammaFactor=this.gammaFactor,l.absorptionFactor=this.absorptionFactor,l.reflectivity=this.reflectivity,l.refractiveIndex=this.refractiveIndex,l.rayBounces=this.rayBounces,l.diamondOrientedEnvMap=this.diamondOrientedEnvMap,l.boostFactors={x:this.boostFactors.x,y:this.boostFactors.y,z:this.boostFactors.z,isVector3:!0},l.transmission=this.transmission,l.isDiamondMaterialParameters=!0,l.type=DiamondMaterial.TYPE,l.userData={},copyMaterialUserData(l.userData,this.userData),l.userData.uuid=this.userData.uuid,l}get uiConfig(){const o=this;return this._uiConfigChildren||(this._uiConfigChildren=[{type:"input",property:[this,"name"]},{type:"checkbox",property:[this,"wireframe"]},{type:"dropdown",label:"Environment",property:[this,"envMapIndex"],children:[0,1,2].map(l=>({label:"env"+(l+1),value:l}))},...generateUiConfig(this),{type:"input",label:"Mesh count",get value(){var l,c,u;return(u=(c=(l=o.userData)===null||l===void 0?void 0:l.__appliedMeshes)===null||c===void 0?void 0:c.size)!==null&&u!==void 0?u:0},set value(l){},disabled:!0},{type:"input",label:"uuid",get value(){return o.uuid},set value(l){},disabled:!0},{type:"checkbox",label:"Render to Depth",hidden:()=>this.transmission===0,get value(){return o.userData.renderToDepth===!0},set value(l){o.userData.renderToDepth=l||void 0}},{type:"button",label:"Download .dmat",value:()=>{N(new Blob([JSON.stringify(o.toJSON(),null,2)],{type:"application/json"}),"diamond-material.dmat")}}]),this._uiConfig||(this._uiConfig={type:"folder",label:"Diamond Material",expanded:!0,children:this._uiConfigChildren,limitedUi:!0}),this._uiConfig.children=[...this._uiConfigChildren,...this.materialExtensions.map(l=>{var c;return(c=l.getUiConfig)===null||c===void 0?void 0:c.call(l,this)})].filter(l=>l),this._uiConfig}copyProps(o){if(!o.isDiamondMaterialParameters&&!o.isDiamondMaterial&&!o.isDiamond&&o.type!==DiamondMaterial.TYPE)return console.warn("WebGi DiamondMaterial: Material type is not supported",o),this;const l={};xe(o,l,Array.from(Object.keys(diamondMaterialPropList)));const c=l.userData;return delete l.userData,this.setValues(l),copyMaterialUserData(this.userData,c),this.setDirty(),this}fromJSON(o,l){return this.copyProps(o)}}DiamondMaterial.TypeSlug="dmat",DiamondMaterial.TYPE="DiamondMaterial",diamondMaterial_decorate([uiColor("Color",{limitedUi:!0}),uniform()],DiamondMaterial.prototype,"color",void 0),diamondMaterial_decorate([uiSlider("Env Intensity",[0,5],.01,{limitedUi:!0}),uniform()],DiamondMaterial.prototype,"envMapIntensity",void 0),diamondMaterial_decorate([uiSlider("Env Rotation Offset",[-Math.PI,Math.PI],.01),ze(DiamondMaterial.prototype.setDirty)],DiamondMaterial.prototype,"envMapRotationOffset",void 0),diamondMaterial_decorate([uiSlider("Env Rotation Offset X",[-Math.PI,Math.PI],.01),ze(DiamondMaterial.prototype.setDirty)],DiamondMaterial.prototype,"envMapRotationOffsetX",void 0),diamondMaterial_decorate([uiSlider("Env Rotation Offset Y",[-Math.PI,Math.PI],.01),ze(DiamondMaterial.prototype.setDirty)],DiamondMaterial.prototype,"envMapRotationOffsetY",void 0),diamondMaterial_decorate([uiSlider("Env Rotation Offset Z",[-Math.PI,Math.PI],.01),ze(DiamondMaterial.prototype.setDirty)],DiamondMaterial.prototype,"envMapRotationOffsetZ",void 0),diamondMaterial_decorate([uiSlider("Dispersion",[0,.1],1e-4,{limitedUi:!0}),uniform({propKey:"rIndexDelta"})],DiamondMaterial.prototype,"dispersion",void 0),diamondMaterial_decorate([uiSlider("Absorption",[0,15],.01,{limitedUi:!0}),uniform()],DiamondMaterial.prototype,"absorptionFactor",void 0),diamondMaterial_decorate([uiSlider("Refractive Index",[0,4],.01,{limitedUi:!0}),uniform()],DiamondMaterial.prototype,"refractiveIndex",void 0),diamondMaterial_decorate([uniform()],DiamondMaterial.prototype,"squashFactor",void 0),diamondMaterial_decorate([uniform()],DiamondMaterial.prototype,"geometryFactor",void 0),diamondMaterial_decorate([uiSlider("Gamma",[.1,4],.01,{limitedUi:!0}),uniform()],DiamondMaterial.prototype,"gammaFactor",void 0),diamondMaterial_decorate([uiVector("RGB Boost",void 0,void 0,{limitedUi:!0}),uniform()],DiamondMaterial.prototype,"boostFactors",void 0),diamondMaterial_decorate([uiSlider("Transmission",[0,1],.01,{limitedUi:!0}),uniform()],DiamondMaterial.prototype,"transmission",void 0),diamondMaterial_decorate([uiSlider("Reflectivity",[0,2],.01,{limitedUi:!0}),uniform()],DiamondMaterial.prototype,"reflectivity",void 0),diamondMaterial_decorate([matDefine("RAY_BOUNCES",void 0,!0),uiSlider("Ray Bounces",[1,16],1)],DiamondMaterial.prototype,"rayBounces",void 0),diamondMaterial_decorate([matDefine("DIA_ORIENT_ENVMAP",void 0,!0),uiSlider("Diamond Oriented Lighting",[0,1],1)],DiamondMaterial.prototype,"diamondOrientedEnvMap",void 0),diamondMaterial_decorate([uniform({propKey:"tCubeMapNormals"})],DiamondMaterial.prototype,"normalsCaptureMap",void 0),diamondMaterial_decorate([x(DiamondMaterial.prototype.refreshEnvUniform)],DiamondMaterial.prototype,"envMapIndex",void 0);const algorithms={ES256:{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}},ES384:{name:"ECDSA",namedCurve:"P-384",hash:{name:"SHA-384"}},ES512:{name:"ECDSA",namedCurve:"P-521",hash:{name:"SHA-512"}},HS256:{name:"HMAC",hash:{name:"SHA-256"}},HS384:{name:"HMAC",hash:{name:"SHA-384"}},HS512:{name:"HMAC",hash:{name:"SHA-512"}},RS256:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},RS384:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-384"}},RS512:{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-512"}}};function decode(d){return JSON.parse(atob(d.split(".")[1]))}async function verify(d,o,l){const c=algorithms[l.algorithm||"RS512"],u=await crypto.subtle.importKey("jwk",o,c,!0,["verify"]),h=d.split("."),_=new Uint8Array(atob(h[2].replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"")).split("").map(w=>w.charCodeAt(0))),A=new Uint8Array((h[0]+"."+h[1]).split("").map(w=>w.charCodeAt(0)));return await crypto.subtle.verify(c,u,_,A)}const jwt={decode,verify};class LicenseVerification{constructor(o,l){this.PRODUCT_ID="IJewel3D_WebGi_V0",this.KEY_TYPE_ID="online-v1",this.TOKEN_FILE="0.txt",this.PUBLIC_KEY_FILE="1.json",this.KEY_SERVER="https://license.ijewel3d.com",this.KEY_SERVER_VERIFY="/api/v1/verify",this.KEY_SERVER_CERTS="/api/v1/certs/"+this.KEY_TYPE_ID,this.id="",this.idHash="",this.appVersion="",this.appName="",this._storage={getItem:async c=>localStorage.getItem(c),setItem:async(c,u)=>(localStorage.setItem(c,u),u)},this.silent=!0,this.appVersion=l,this.appName=o}_getOriginId(){const o=getCurrentDomain(window);if(!(o!=null&&o[0]))throw new Error("Failed to get origin");return o[0]}_getStorage(){return this._storage}async init(){var o,l;if(this.id=this.id||this._getOriginId(),!this.id)throw new Error("Failed to get machine id");this.idHash=await hash(this.id);const c=this._getStorage(),u=this.idHash+this.TOKEN_FILE;let h=(o=await c.getItem(u))!==null&&o!==void 0?o:await c.setItem(u,"");const _=this.idHash+this.PUBLIC_KEY_FILE,A=(l=await c.getItem(_))!==null&&l!==void 0?l:null;let w=await this.getPublicKey().catch(()=>null);return!w&&A&&(w=JSON.parse(A)),w!==A&&await c.setItem(_,JSON.stringify(w)),w||this._throw(new Error("Failed to get public key")),{token:h,publicKey:w}}async verify(o,l){var c;try{let u,h=(l=l??await this.init()).token;h&&!await jwt.verify(h,l.publicKey,{algorithm:"RS512",throwError:!1})&&(h=""),h&&(u=jwt.decode(h),((c=u.payload)===null||c===void 0?void 0:c.key)!==o&&(h="")),h&&h.length||(h=await this.setLicenseKey(o)),u=h?jwt.decode(h):void 0;let _=!1;return _=_||h&&await jwt.verify(h,l.publicKey,{algorithm:"RS512",throwError:!1}),_=_||!!u&&await this.verifyData(u),_}catch(u){return this.silent||console.error(u),!1}}async writeToken(o){const l=this.idHash+this.TOKEN_FILE;await this._getStorage().setItem(l,o)}async verifyData(o){var l,c,u;return((l=o.payload)===null||l===void 0?void 0:l.sub)===this.id&&((c=o.payload)===null||c===void 0?void 0:c.app)===this.appName+"_"+this.appVersion&&((u=o.payload)===null||u===void 0?void 0:u.pid)===this.PRODUCT_ID}async _getPublicKeyFromServer(){return fetch(this.KEY_SERVER+this.KEY_SERVER_CERTS).then(o=>o.json()).catch(o=>({status:o==null?void 0:o.status,error:o}))}async _validateKeyFromServer(o){return await fetch(this.KEY_SERVER+this.KEY_SERVER_VERIFY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:o,id:this.id,app:{name:this.appName,version:this.appVersion},pid:this.PRODUCT_ID})}).then(l=>l.json()).catch(l=>({status:l==null?void 0:l.status,error:l}))}_throw(o){if(!this.silent)throw o;return null}async setLicenseKey(o){const l=await this._validateKeyFromServer(o);if(l.error)return this._throw((l.status?l.status+": ":"")+ +l.error);const c=l.token;return c?(await this.writeToken(c),c):this._throw(new Error("Invalid license key, no token"))}async getPublicKey(){const o=await this._getPublicKeyFromServer();return o.error?this._throw(o.error):o.jwk||this._throw(new Error("Invalid public key"))}}async function hash(d){const o=new TextEncoder().encode(d),l=await crypto.subtle.digest("SHA-256",o);return Array.from(new Uint8Array(l)).map(c=>c.toString(16).padStart(2,"0")).join("")}function getCurrentDomain(d){let o,l,c,u,h,_;const A=function(ue,ye,Oe){if(ue.length!=ye)return!1;for(let ke=0;ke<ye;ke++)for(let Ve=0;Ve<Oe.length;Ve+=2)if(ke==Oe[Ve]&&ue.charCodeAt(ke)!=Oe[Ve+1])return!1;return!0},w=function(ue,ye,Oe){return A(ye,Oe,ue)},C=function(ue,ye,Oe){return w(ye,ue,Oe)};for(let ue in d)if(A(ue,8,[7,116,5,101,3,117,0,100])){o=ue;break}for(let ue in d)if(A(ue,6,[5,116,0,112])){h=ue;break}for(let ue in d[o])if(C(ue,[5,110,0,100],6)){l=ue;break}for(let ue in d[o])if(C(ue,[7,110,0,108],8)){c=ue;break}for(let ue in d[o])if(C(ue,[7,114,0,114],8)){_=ue;break}if(!("~">l)){for(let ue in d[o][c])if(w([7,101,0,104],ue,8)){u=ue;break}}if(!o||!d[o])return;const M=d[h]!==d,O=d[o][l],ne=!!d[o][c]&&d[o][c][u],ce=M&&_?d[o][_]:O||ne;return ce?[ce,O||ne]:void 0}var injectStylesIntoStyleTag=__webpackgi_require__(186),injectStylesIntoStyleTag_default=__webpackgi_require__.n(injectStylesIntoStyleTag),styleDomAPI=__webpackgi_require__(155),styleDomAPI_default=__webpackgi_require__.n(styleDomAPI),setAttributesWithoutAttributes=__webpackgi_require__(626),setAttributesWithoutAttributes_default=__webpackgi_require__.n(setAttributesWithoutAttributes),insertStyleElement=__webpackgi_require__(990),insertStyleElement_default=__webpackgi_require__.n(insertStyleElement),styleTagTransform=__webpackgi_require__(827),styleTagTransform_default=__webpackgi_require__.n(styleTagTransform),loadingScreen=__webpackgi_require__(646),exported={};loadingScreen.A&&loadingScreen.A.locals&&(exported.locals=loadingScreen.A.locals);var refs=0,update,options={};options.styleTagTransform=styleTagTransform_default(),options.setAttributes=setAttributesWithoutAttributes_default(),options.insert=function(d,o){(o.target||document.head).appendChild(d)},options.domAPI=styleDomAPI_default(),options.insertStyleElement=insertStyleElement_default(),exported.use=function(d){return options.options=d||{},refs++||(update=injectStylesIntoStyleTag_default()(loadingScreen.A,options)),exported},exported.unuse=function(){refs>0&&!--refs&&(update(),update=null)};var styles_loadingScreen=exported,spinner1=__webpackgi_require__(611),spinner1_exported={};spinner1.A&&spinner1.A.locals&&(spinner1_exported.locals=spinner1.A.locals);var spinner1_refs=0,spinner1_update,spinner1_options={};spinner1_options.styleTagTransform=styleTagTransform_default(),spinner1_options.setAttributes=setAttributesWithoutAttributes_default(),spinner1_options.insert=function(d,o){(o.target||document.head).appendChild(d)},spinner1_options.domAPI=styleDomAPI_default(),spinner1_options.insertStyleElement=insertStyleElement_default(),spinner1_exported.use=function(d){return spinner1_options.options=d||{},spinner1_refs++||(spinner1_update=injectStylesIntoStyleTag_default()(spinner1.A,spinner1_options)),spinner1_exported},spinner1_exported.unuse=function(){spinner1_refs>0&&!--spinner1_refs&&(spinner1_update(),spinner1_update=null)};var loaders_spinner1=spinner1_exported,AAssetManagerProcessStatePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class AAssetManagerProcessStatePlugin extends AViewerPlugin{_onEnabledChange(){this.enabled||(this._mainDiv.style.display="none")}constructor(o,l){super(),this.container=l,this.enabled=!0,this.dependencies=[AssetManagerPlugin],this.processState=new Map,this._mainDiv=ee({id:"assetManager"+o,addToBody:!1,innerHTML:""}),this._contentDiv=ee({id:"assetManager"+o+"Content",addToBody:!1,innerHTML:""}),this.enabled||(this._mainDiv.style.display="none"),this._mainDiv.appendChild(this._contentDiv)}async onAdded(o){var l,c,u,h,_,A,w,C,M,O,ne,ce,ue;await super.onAdded(o),((l=this.container)!==null&&l!==void 0?l:o.container).appendChild(this._mainDiv),this._updateMainDiv(this.processState),(u=(c=o.getManager())===null||c===void 0?void 0:c.importer)===null||u===void 0||u.addEventListener("importFile",ye=>{ye.state!=="done"?this.processState.set(ye.path,{state:ye.state,progress:ye.progress?100*ye.progress:void 0}):this.processState.delete(ye.path),this._updateMainDiv(this.processState)}),(_=(h=o.getManager())===null||h===void 0?void 0:h.importer)===null||_===void 0||_.addEventListener("processFileStart",ye=>{this.processState.set(ye.path,{state:"processing",progress:void 0}),this._updateMainDiv(this.processState)}),(w=(A=o.getManager())===null||A===void 0?void 0:A.importer)===null||w===void 0||w.addEventListener("processFileEnd",ye=>{this.processState.delete(ye.path),this._updateMainDiv(this.processState)}),(M=(C=o.getManager())===null||C===void 0?void 0:C.exporter)===null||M===void 0||M.addEventListener("exportFile",ye=>{ye.state!=="done"?this.processState.set(ye.obj.name,{state:ye.state,progress:ye.progress?100*ye.progress:void 0}):this.processState.delete(ye.obj.name),this._updateMainDiv(this.processState)}),(O=o.getPluginByType("FileTransferPlugin"))===null||O===void 0||O.addEventListener("transferFile",ye=>{ye.state!=="done"?this.processState.set(ye.path,{state:ye.state,progress:ye.progress?100*ye.progress:void 0}):this.processState.delete(ye.path),this._updateMainDiv(this.processState)}),(ne=o.getPluginByType("MaterialConfiguratorPlugin"))===null||ne===void 0||ne.addEventListener("progress",ye=>{ye.state!=="done"?this.processState.set("MatpreviewGeneration",{state:ye.state,progress:0}):this.processState.delete("MatpreviewGeneration"),this._updateMainDiv(this.processState)}),(ce=o.getPluginByType("SwitchNodePlugin"))===null||ce===void 0||ce.addEventListener("progress",ye=>{ye.state!=="done"?this.processState.set("SwitchNodeGeneration",{state:ye.state,progress:0}):this.processState.delete("SwitchNodeGeneration"),this._updateMainDiv(this.processState)}),(ue=o.getPluginByType("ThemePlugin"))===null||ue===void 0||ue.addEventListener("progress",ye=>{ye.state!=="done"?this.processState.set("ThemeInit",{state:ye.state,progress:0}):this.processState.delete("ThemeInit"),this._updateMainDiv(this.processState)})}async onRemove(o){var l;return this._mainDiv.remove(),(l=this._contentDiv)===null||l===void 0||l.remove(),this.processState.clear(),super.onRemove(o)}}AAssetManagerProcessStatePlugin_decorate([uiToggle("Enabled"),x(AAssetManagerProcessStatePlugin.prototype._onEnabledChange),serialize()],AAssetManagerProcessStatePlugin.prototype,"enabled",void 0);var LoadingScreenPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},LoadingScreenPlugin_1;let LoadingScreenPlugin=LoadingScreenPlugin_1=class extends AAssetManagerProcessStatePlugin{refresh(){this._updateMainDiv(this._isPreviewing?this._previewState:this.processState,!1)}togglePreview(){this.maximize(),this._isPreviewing=!this._isPreviewing,this.refresh(),this._isPreviewing?this.show():this.hideWithDelay()}constructor(d){super("LoadingScreen",d),this.styles=styles_loadingScreen,this.spinners=[{styles:loaders_spinner1,html:'<span class="loader"></span>'}],this.loader=0,this.loadingTextHeader="Loading Files",this.errorTextHeader="Error Loading Files",this.showFileNames=!0,this.showProcessStates=!0,this.showProgress=!0,this.hideOnOnlyErrors=!0,this.hideOnFilesLoad=!0,this.hideOnSceneObjectLoad=!1,this.minimizeOnSceneObjectLoad=!0,this.showOnFilesLoading=!0,this.showOnSceneEmpty=!0,this.hideDelay=500,this.backgroundOpacity=.5,this.backgroundBlur=24,this.background="#ffffff",this.textColor="#222222",this.logoImage=LoadingScreenPlugin_1.LS_DEFAULT_LOGO,this._isPreviewing=!1,this._previewState=new Map([["file.glb",{state:"downloading",progress:50}],["1_metal_whitegold_polished_0db3fb834b.pmat",{state:"adding"}]]),this.loadingElement=ee({classList:["loadingScreenLoadingElement"],addToBody:!1}),this.filesElement=ee({classList:["loadingScreenFilesElement"],addToBody:!1}),this.logoElement=ee({classList:["loadingScreenLogoElement"],addToBody:!1}),this._isHidden=!1,this._temp=document.createElement("template"),this.isEditor=!1,this._sceneUpdate=o=>{if(!this._viewer||!o.hierarchyChanged)return;const l=this._viewer.scene.modelRoot.children;l.length===0&&this.showOnSceneEmpty&&!this.isEditor&&this.show(),l.length>0?this.hideOnSceneObjectLoad?this.hideWithDelay():this.minimizeOnSceneObjectLoad&&this._viewer.scene.environment&&X(this.hideDelay+300).then(()=>this.minimize()):this.minimizeOnSceneObjectLoad&&this.maximize()},this._mainDiv.prepend(this.loadingElement),this._mainDiv.prepend(this.logoElement),this._mainDiv.appendChild(this.filesElement)}get visible(){return!this._isHidden}async hide(){this._isHidden=!0,this._mainDiv.style.opacity="0",await X(502),this._isHidden&&(this._mainDiv.style.display="none",this._showMainDiv())}async hideWithDelay(){if(this._isHidden=!0,await X(this.hideDelay),this._isHidden)return this.hide()}show(){this._isHidden&&(this._isHidden=!1,this._showMainDiv(),this._mainDiv.style.display="flex")}_showMainDiv(){this._mainDiv.style.opacity="1"}minimize(){this._mainDiv.classList.add("minimizedLoadingScreen"),this.showFileNames||(this.loadingElement.style.display="block")}maximize(){this._mainDiv.classList.remove("minimizedLoadingScreen"),this.loadingElement.style.display=""}_setHTML(d,o){this._temp.innerHTML=o,this._temp.innerHTML.trim()==d.innerHTML.trim()||(d.innerHTML=o)}_updateMainDiv(d,o=!0){if(!this._viewer||!this._contentDiv)return;if(!this.enabled)return void(this._mainDiv.style.display="none");if(this.showFileNames){let c="";d.forEach((u,h)=>{let _=(h||"").split("/").pop();if(_&&_.length>16){const A=_.split(".").pop();_=A===_?_.slice(0,16):_.slice(0,-A.length-1).slice(0,16)+"..."+A}c+=(this.showProcessStates?`<span class="loadingScreenProcessState">${u.state}</span>: `:"")+_+(this.showProgress&&u.progress?" - "+u.progress.toFixed(0)+"%":"")+"<br>"}),this._setHTML(this.filesElement,c)}else this._setHTML(this.filesElement,"");const l=[...d.values()].filter(c=>c.state==="error");l.length>0&&l.length===d.size&&!this.hideOnOnlyErrors?this._setHTML(this._contentDiv,this.errorTextHeader):this._setHTML(this._contentDiv,this.loadingTextHeader),this._setHTML(this.loadingElement,this.spinners[this.loader].html),this._mainDiv.style.setProperty("--b-opacity",this.backgroundOpacity.toString()),this._mainDiv.style.setProperty("--b-background",this.background),this._mainDiv.style.backdropFilter=`blur(${this.backgroundBlur}px)`,this._mainDiv.style.color=this.textColor,this._setHTML(this.logoElement,this.logoImage?`<img class="loadingScreenLogoImage" src="${this.logoImage}"/>`:""),o&&(this.hideOnFilesLoad&&(d.size===0||l.length===d.size&&this.hideOnOnlyErrors)?this.hideDelay?this.hideWithDelay():this.hide():d.size>0&&this.showOnFilesLoading&&(this._viewer.scene.modelRoot.children.length>0&&this.minimizeOnSceneObjectLoad&&this._viewer.scene.environment?this.minimize():this.maximize(),this.show()))}async onAdded(d){var o;this.styles.use({target:(o=this.container)!==null&&o!==void 0?o:d.container}),this.spinners.forEach(l=>{var c;l.styles.use({target:(c=this.container)!==null&&c!==void 0?c:d.container})}),d.scene.addEventListener("sceneUpdate",this._sceneUpdate),await super.onAdded(d)}async onRemove(d){d.scene.removeEventListener("sceneUpdate",this._sceneUpdate),await super.onRemove(d)}};LoadingScreenPlugin.PluginType="LoadingScreenPlugin",LoadingScreenPlugin.LS_DEFAULT_LOGO="https://static.webgi.xyz/logo.svg",LoadingScreenPlugin_decorate([uiDropdown("Loader",["Spinner 1"].map((d,o)=>({value:o,label:d}))),serialize()],LoadingScreenPlugin.prototype,"loader",void 0),LoadingScreenPlugin_decorate([uiInput("Loading text header"),x(LoadingScreenPlugin.prototype.refresh),serialize()],LoadingScreenPlugin.prototype,"loadingTextHeader",void 0),LoadingScreenPlugin_decorate([uiInput("Error text header"),serialize()],LoadingScreenPlugin.prototype,"errorTextHeader",void 0),LoadingScreenPlugin_decorate([uiToggle("Show file names"),serialize(),x(LoadingScreenPlugin.prototype.refresh)],LoadingScreenPlugin.prototype,"showFileNames",void 0),LoadingScreenPlugin_decorate([uiToggle("Show process states"),serialize(),x(LoadingScreenPlugin.prototype.refresh)],LoadingScreenPlugin.prototype,"showProcessStates",void 0),LoadingScreenPlugin_decorate([uiToggle("Show progress"),serialize(),x(LoadingScreenPlugin.prototype.refresh)],LoadingScreenPlugin.prototype,"showProgress",void 0),LoadingScreenPlugin_decorate([uiToggle("Hide on only errors"),serialize()],LoadingScreenPlugin.prototype,"hideOnOnlyErrors",void 0),LoadingScreenPlugin_decorate([uiToggle("Hide on files load"),serialize()],LoadingScreenPlugin.prototype,"hideOnFilesLoad",void 0),LoadingScreenPlugin_decorate([uiToggle("Hide on scene object load"),serialize()],LoadingScreenPlugin.prototype,"hideOnSceneObjectLoad",void 0),LoadingScreenPlugin_decorate([uiToggle("Minimize on scene object load"),serialize()],LoadingScreenPlugin.prototype,"minimizeOnSceneObjectLoad",void 0),LoadingScreenPlugin_decorate([uiToggle("Show when files start loading"),serialize()],LoadingScreenPlugin.prototype,"showOnFilesLoading",void 0),LoadingScreenPlugin_decorate([uiToggle("Show when scene empty"),serialize()],LoadingScreenPlugin.prototype,"showOnSceneEmpty",void 0),LoadingScreenPlugin_decorate([uiInput("Hide delay (ms)"),serialize()],LoadingScreenPlugin.prototype,"hideDelay",void 0),LoadingScreenPlugin_decorate([uiSlider("Background Opacity",[0,1]),x(LoadingScreenPlugin.prototype.refresh),serialize()],LoadingScreenPlugin.prototype,"backgroundOpacity",void 0),LoadingScreenPlugin_decorate([uiSlider("Background Blur",[0,100]),x(LoadingScreenPlugin.prototype.refresh),serialize()],LoadingScreenPlugin.prototype,"backgroundBlur",void 0),LoadingScreenPlugin_decorate([uiInput("Background Color"),x(LoadingScreenPlugin.prototype.refresh),serialize()],LoadingScreenPlugin.prototype,"background",void 0),LoadingScreenPlugin_decorate([uiInput("Text Color"),x(LoadingScreenPlugin.prototype.refresh),serialize()],LoadingScreenPlugin.prototype,"textColor",void 0),LoadingScreenPlugin_decorate([uiInput("Logo Image"),x(LoadingScreenPlugin.prototype.refresh),serialize()],LoadingScreenPlugin.prototype,"logoImage",void 0),LoadingScreenPlugin_decorate([uiButton("Toggle preview")],LoadingScreenPlugin.prototype,"togglePreview",null),LoadingScreenPlugin_decorate([uiButton("Minimize")],LoadingScreenPlugin.prototype,"minimize",null),LoadingScreenPlugin_decorate([uiButton("Maximize")],LoadingScreenPlugin.prototype,"maximize",null),LoadingScreenPlugin=LoadingScreenPlugin_1=LoadingScreenPlugin_decorate([uiFolder("Loading Screen")],LoadingScreenPlugin);const APP_NAME="iJewel3dSDK_WebGi",APP_VERSION=ViewerApp.VERSION,logoSvgUrl="https://playground.ijewel3d.com/logo_black.svg",console1={error:d=>setTimeout(()=>console.error(new Error(d)),612)};class BaseIJewel3DKeyPlugin extends AViewerPlugin{setKey(o){this._checking||this._checkPromise||(this._checking=Date.now(),this._checkPromise=this._check(o),this._checkPromise.then(()=>this._checkPromise=void 0))}async _check(o){await new LicenseVerification(APP_NAME,APP_VERSION).verify(o)||(console1.error(this._errMessage),this._logoContainer=this._createContainerLogo())}_createContainerLogo(){const o=document.createElement("div");o.innerHTML=logoSvg,o.style.position="absolute",o.style.padding="1rem",o.style.left="0",o.style.bottom="0",o.style.width="100%",o.style.height="auto",o.style.display="flex",o.style.alignItems="center",o.style.backgroundColor="rgba(0, 0, 0, 0)",o.style.zIndex="9999",o.style.pointerEvents="none";const l=o.children[0];l.style.width="calc(min(20%, 150px))",l.style.height="auto",l.onclick=()=>{window.open("https://ijewel3d.com/","_top")},this._logoContainer=o;const c=document.getElementById("webgi-logo");return c&&c.remove(),o}constructor(){super(),this._errMessage=`iJewel3D ${APP_NAME} ${APP_VERSION}. FOR EVALUATION PURPOSES ONLY. For more information visit: https://ijewel3d.com/`,this._checking=0,this._licenseInUse=!1,this._autoKey=!0,setInterval(()=>{var o;if(this._checkPromise&&Date.now()-this._checking>15e3&&(console1.error(this._errMessage),this._logoContainer=this._createContainerLogo(),typeof this._checkPromise.cancel=="function"&&this._checkPromise.cancel(),this._checkPromise=void 0),this._logoContainer&&!this._logoContainer.parentElement&&this._viewer&&this._licenseInUse){this._lContainer.appendChild(this._logoContainer);const l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(LoadingScreenPlugin);l&&(l.logoImage=logoSvgUrl,LoadingScreenPlugin.LS_DEFAULT_LOGO=logoSvgUrl)}},5e3)}get _lContainer(){var o;const l=(o=this._viewer)===null||o===void 0?void 0:o.container;if(!l)return document.body;const c=window.getComputedStyle(l).position;return c!=="absolute"&&c!=="relative"&&c!=="fixed"?document.body:l}use(){var o;if(!this._licenseInUse&&(this._licenseInUse=!0,!this._checking))if(this._autoKey)this.setKey("auto");else{console1.error(this._errMessage),this._logoContainer=this._createContainerLogo(),this._lContainer.appendChild(this._logoContainer);const l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(LoadingScreenPlugin);l&&(LoadingScreenPlugin.LS_DEFAULT_LOGO=logoSvgUrl,l.logoImage=logoSvgUrl)}}unuse(){}async onAdded(o){await super.onAdded(o)}}const logoSvg=`
<!--Notice - iJewel3D License Required to remove attribution. Check the details at https://developer.ijewel3d.com/ -->
<svg width="320" height="150" viewBox="0 0 320 150" fill="none" xmlns="http://www.w3.org/2000/svg">
<g filter="url(#filter0_d_2013_189)">
<path d="M63.0313 37.6615C63.0313 37.0497 62.8369 36.5115 62.4485 36.0465C62.0601 35.5815 61.5625 35.2879 60.9555 35.1411L71.2491 30.8711V79.1495C71.2491 82.3555 70.4357 85.2195 68.7971 87.7275C67.1705 90.2355 64.7063 91.5315 61.4047 91.6175C57.6903 91.3975 55.0441 89.5015 53.4295 85.9275C52.7983 84.4475 52.4707 82.9315 52.4707 81.3655H53.2961C53.2961 82.8455 53.5873 84.2395 54.1701 85.5495C54.8013 86.6875 55.7967 87.4335 57.1319 87.7635C58.4793 88.0935 59.6809 87.9715 60.7613 87.3835C61.5139 86.9075 62.0359 86.1115 62.3635 84.9995C62.6791 83.8855 62.8735 82.7715 62.9219 81.6455C62.9827 80.5335 63.0069 79.7375 63.0069 79.2595L63.0313 37.6615Z" fill="white"/>
<path d="M49.4 38.5287C49.4 37.9169 49.2056 37.3785 48.8172 36.9137C48.4288 36.4487 47.9312 36.1551 47.3242 36.0083L57.6178 31.7383V65.5675L49.4 69.8375V38.5287Z" fill="white"/>
<path d="M106.949 51.1695H82.6592C82.5742 54.4355 83.3026 57.6775 84.8442 60.8955C86.3736 64.1135 88.9228 66.1455 92.4672 66.9895C96.8372 67.5515 100.77 66.4635 104.254 63.7215C104.861 63.1595 105.419 62.5475 105.917 61.8755C105.977 61.7895 106.05 61.7395 106.172 61.7035C106.281 61.6795 106.39 61.7035 106.499 61.7895C106.584 61.8495 106.633 61.9235 106.669 62.0335C106.694 62.1435 106.669 62.2535 106.584 62.3635C106.062 63.0375 105.492 63.6735 104.885 64.2855C101.595 67.9675 97.4562 70.1695 92.4794 70.8915C86.8834 71.0875 82.5014 69.1175 79.2968 64.9695C76.1044 60.8355 74.3928 56.2455 74.1744 51.2295C74.0044 47.2171 74.8178 43.4487 76.6264 39.9495C78.4228 36.4503 81.239 33.9055 85.0506 32.3149C88.1824 31.1403 91.3748 30.7977 94.64 31.2627C99.2284 32.2415 102.567 34.8231 104.642 39.0075C106.257 42.5923 107.034 46.3117 106.949 50.2147V51.1695ZM82.6592 50.3369H98.3544C98.3788 50.2759 98.3908 50.2391 98.3908 50.2147C99.6896 46.7521 100.382 43.3875 100.467 40.0841C100.333 36.0711 98.318 33.4405 94.4458 32.2171C89.8818 31.3239 86.495 32.9267 84.2736 37.0253C82.9748 40.6225 82.4286 44.3663 82.6592 48.2449V50.3369Z" fill="white"/>
<path d="M168.843 32.9737C169.013 32.4965 168.965 32.0561 168.721 31.6523C168.467 31.2485 168.091 31.0283 167.557 31.0039H172.581C171.223 31.1139 170.275 31.7991 169.717 33.0593L155.429 70.4619L155.637 71.0119H146.799L138.411 48.9647L130.193 70.4619L130.401 71.0119H121.564L107.155 33.1817C106.597 31.8969 105.638 31.1751 104.254 31.0039H117.206C116.708 31.0649 116.332 31.2853 116.065 31.6889C115.798 32.0927 115.749 32.5455 115.919 33.0471L129.781 69.2879L137.963 47.8269L132.403 33.1817C131.845 31.8969 130.885 31.1751 129.501 31.0039H142.417C142.029 31.0649 141.713 31.2363 141.459 31.5299C141.203 31.8235 141.083 32.1539 141.083 32.5087C141.083 32.8635 141.107 32.8513 141.167 33.0471L142.417 36.2281L142.829 37.4027L155.029 69.2879L168.843 32.9737Z" fill="white"/>
<path d="M202.55 51.1695H178.262C178.176 54.4355 178.904 57.6775 180.434 60.8955C181.976 64.1135 184.512 66.1455 188.058 66.9895C192.428 67.5515 196.36 66.4635 199.844 63.7215C200.45 63.1595 201.01 62.5475 201.506 61.8755C201.556 61.7895 201.64 61.7395 201.762 61.7035C201.872 61.6795 201.98 61.7035 202.09 61.7895C202.174 61.8495 202.224 61.9235 202.26 62.0335C202.284 62.1435 202.26 62.2535 202.174 62.3635C201.652 63.0375 201.082 63.6735 200.476 64.2855C197.186 67.9675 193.046 70.1695 188.07 70.8915C182.474 71.0875 178.092 69.1175 174.888 64.9695C171.694 60.8355 169.984 56.2455 169.764 51.2295C169.594 47.2171 170.42 43.4487 172.216 39.9495C174.014 36.4503 176.83 33.9055 180.64 32.3149C183.772 31.1403 186.964 30.7977 190.23 31.2627C194.818 32.2415 198.156 34.8231 200.232 39.0075C201.858 42.5923 202.636 46.3117 202.55 50.2147V51.1695ZM178.262 50.3369H193.956C193.982 50.2759 193.994 50.2391 193.994 50.2147C195.292 46.7521 195.984 43.3875 196.068 40.0841C195.936 36.0711 193.92 33.4405 190.048 32.2171C185.484 31.3239 182.086 32.9267 179.876 37.0253C178.578 40.6225 178.03 44.3663 178.262 48.2449V50.3369Z" fill="white"/>
<path d="M214.3 68.798C214.3 69.386 214.494 69.886 214.884 70.302C215.272 70.718 215.758 70.964 216.34 71.012H204.006C204.59 70.952 205.076 70.73 205.464 70.328C205.852 69.924 206.046 69.434 206.046 68.846V17.4478C206.046 16.8606 205.852 16.3588 205.464 15.9184C205.076 15.4902 204.59 15.2332 204.006 15.1476L214.3 11V68.798Z" fill="white"/>
<path d="M60.2022 15.5255L57.1676 13.2007C57.1554 13.1885 57.1432 13.1885 57.1312 13.1763C57.119 13.1641 57.0946 13.1641 57.0826 13.1641H49.1196C49.0954 13.1641 49.0832 13.1641 49.071 13.1763C49.059 13.1885 49.0468 13.1885 49.0346 13.2007L46 15.5255H60.2022Z" fill="white"/>
<path d="M46.0977 16.0044L52.9925 22.1586H53.0047C53.0167 22.1708 53.0289 22.1708 53.0411 22.183C53.0531 22.183 53.0775 22.1952 53.0897 22.1952C53.1017 22.1952 53.1261 22.1954 53.1381 22.183C53.1503 22.183 53.1625 22.1708 53.1745 22.1586H53.1867L60.0815 15.9922H46.0977V16.0044Z" fill="white"/>
<path d="M237.681 55.6091C237.293 55.6091 237.183 55.4611 237.183 55.1691C237.183 54.7531 237.377 54.4211 237.681 54.4211C237.985 54.4211 238.785 54.6431 239.817 54.6431C241.613 54.6431 242.937 53.2111 242.937 50.8739C242.937 48.5369 242.719 48.3901 240.947 48.3901C239.173 48.3901 238.785 49.4791 238.215 50.9227C238.021 51.3631 237.827 51.4971 237.523 51.4971C237.219 51.4971 236.589 51.1551 236.589 50.5067C236.589 49.2465 238.457 47.7539 241.019 47.7539C243.581 47.7539 245.267 48.5003 245.267 51.1311C245.267 53.7611 242.937 54.7531 241.213 54.8991V54.9971C242.719 55.2671 244.479 56.3311 244.479 58.4711C244.479 62.0191 241.601 63.4511 238.627 63.4511C235.653 63.4511 234.027 61.7391 234.027 60.6251C234.027 59.5111 234.621 59.3651 235.157 59.3651C235.691 59.3651 235.679 59.6091 235.799 60.0631C236.297 61.8971 237.099 62.8151 238.725 62.8151C240.351 62.8151 242.027 61.5791 242.027 58.1771C242.027 54.7771 241.553 55.4011 239.611 55.4011C238.689 55.4011 237.997 55.6091 237.681 55.6091Z" fill="white"/>
<path d="M259.105 45.918L259.203 45.9914L255.513 61.1146C255.317 61.8366 255.293 62.3746 255.707 62.3746C256.325 62.3746 257.333 60.7586 257.745 59.9386L258.219 60.2826C257.455 62.0186 256.229 63.5006 254.601 63.5006C252.975 63.5006 253.255 62.5086 253.667 60.8946C253.885 60.0986 254.105 59.2786 254.287 58.4706H254.237C252.915 60.9066 250.997 63.5006 248.387 63.5006C245.777 63.5006 246.201 61.9826 246.201 60.4786C246.201 57.7246 248.521 51.7786 253.825 51.7786C259.129 51.7786 255.305 52.0226 255.695 52.2686L256.727 47.9002C256.895 47.1782 256.871 47.0314 256.313 46.9826L254.991 46.8356L255.087 46.4198L259.105 45.918ZM249.491 62.3506C251.603 62.3506 254.261 57.7866 254.979 55.0086C255.123 54.3606 255.391 53.5166 255.525 52.9286C255.257 52.7566 254.663 52.5126 253.971 52.5126C250.377 52.5126 248.387 58.2146 248.387 60.6726C248.387 61.8106 248.775 62.3366 249.491 62.3506Z" fill="white"/>
<path d="M257.663 71.0129H235.571C226.649 71.0129 219.389 63.6969 219.389 54.7029C219.389 45.7109 226.649 38.3945 235.571 38.3945H257.663C266.585 38.3945 273.843 45.7109 273.843 54.7029C273.843 63.6969 266.585 71.0129 257.663 71.0129ZM235.571 39.3855C227.183 39.3855 220.361 46.2615 220.361 54.7149C220.361 63.1709 227.183 70.0469 235.571 70.0469H257.663C266.051 70.0469 272.871 63.1709 272.871 54.7149C272.871 46.2615 266.051 39.3855 257.663 39.3855H235.571Z" fill="white"/>
</g>
<g filter="url(#filter1_d_2013_189)">
<path d="M17.656 134.564H15.892C13.54 131.344 12 126.584 12 121.768C12 117.148 13.484 112.332 15.892 109H17.656C15.5 112.024 13.988 116.728 13.988 121.768C13.988 126.696 15.444 131.484 17.656 134.564Z" fill="white"/>
<path d="M32.1018 130.169H20.0898V110.121H32.0738V111.969H22.1059V119.193H31.1498V121.013H22.1059V128.321H32.1018V130.169Z" fill="white"/>
<path d="M41.7111 130.169L34.0391 110.121H36.1951L41.5431 124.065C41.9631 125.157 42.3551 126.249 42.8031 127.649C43.2231 126.193 43.7271 124.793 44.0351 124.037L49.3551 110.121H51.4271L43.8111 130.169H41.7111Z" fill="white"/>
<path d="M51.5889 130.169H49.5449L56.9089 110.121H59.4009L66.8489 130.169H64.7489L62.7889 124.849H53.5489L51.5889 130.169ZM57.8889 112.949L54.1649 123.085H62.1449L58.3929 112.949C58.3089 112.669 58.1689 112.333 58.1409 112.137C58.1129 112.305 58.0009 112.669 57.8889 112.949Z" fill="white"/>
<path d="M71.6527 110.121V128.321H80.8647V130.169H69.6367V110.121H71.6527Z" fill="white"/>
<path d="M82.8945 123.197V110.121H84.9105V123.113C84.9105 126.641 86.8425 128.545 90.3425 128.545C93.7585 128.545 95.6905 126.585 95.6905 123.113V110.121H97.7065V123.197C97.7065 127.733 94.9065 130.505 90.3425 130.505C85.6945 130.505 82.8945 127.761 82.8945 123.197Z" fill="white"/>
<path d="M101.601 130.169H99.5566L106.921 110.121H109.413L116.861 130.169H114.761L112.801 124.849H103.561L101.601 130.169ZM107.901 112.949L104.177 123.085H112.157L108.405 112.949C108.321 112.669 108.181 112.333 108.153 112.137C108.125 112.305 108.013 112.669 107.901 112.949Z" fill="white"/>
<path d="M115.715 111.969V110.121H130.079V111.969H123.891V130.169H121.875V111.969H115.715Z" fill="white"/>
<path d="M134.872 110.121V130.169H132.855V110.121H134.872Z" fill="white"/>
<path d="M157.609 120.146C157.609 126.222 153.662 130.506 148.062 130.506C142.434 130.506 138.514 126.222 138.514 120.146C138.514 114.07 142.462 109.758 148.062 109.758C153.69 109.758 157.609 114.042 157.609 120.146ZM155.537 120.146C155.537 115.134 152.486 111.718 148.062 111.718C143.638 111.718 140.614 115.134 140.614 120.146C140.614 125.158 143.638 128.574 148.062 128.574C152.486 128.574 155.537 125.13 155.537 120.146Z" fill="white"/>
<path d="M163.28 130.169H161.264V110.121H163.308L174.34 126.809V110.121H176.328V130.169H174.34L163.28 113.481V130.169Z" fill="white"/>
<path d="M194.508 130.169L186.836 110.121H188.992L194.34 124.065C194.76 125.157 195.152 126.249 195.6 127.649C196.02 126.193 196.524 124.793 196.832 124.037L202.152 110.121H204.224L196.608 130.169H194.508Z" fill="white"/>
<path d="M218.94 130.169H206.928V110.121H218.912V111.969H208.944V119.193H217.988V121.013H208.944V128.321H218.94V130.169Z" fill="white"/>
<path d="M225.051 130.169H223.035V110.121H230.511C234.571 110.121 237.035 112.361 237.035 115.917C237.035 118.801 235.523 120.817 232.947 121.517L237.231 130.169H234.991L230.903 121.853H225.051V130.169ZM225.051 111.941V120.033H230.567C233.339 120.033 234.963 118.521 234.963 115.973C234.963 113.369 233.255 111.941 230.511 111.941H225.051Z" fill="white"/>
<path d="M239.74 115.33C239.74 111.97 242.428 109.758 246.46 109.758C250.072 109.758 252.452 111.774 252.76 115.134H250.716C250.492 112.866 248.952 111.578 246.432 111.578C243.604 111.578 241.756 113.034 241.756 115.302C241.756 117.066 242.792 118.186 244.892 118.718L248.336 119.558C251.472 120.314 253.096 122.106 253.096 124.822C253.096 128.294 250.408 130.506 246.264 130.506C242.372 130.506 239.74 128.462 239.488 125.186H241.56C241.672 127.286 243.52 128.658 246.264 128.658C249.204 128.658 251.08 127.23 251.08 124.934C251.08 123.142 250.072 121.966 247.916 121.462L244.528 120.622C241.392 119.866 239.74 118.074 239.74 115.33Z" fill="white"/>
<path d="M258.739 110.121V130.169H256.723V110.121H258.739Z" fill="white"/>
<path d="M281.477 120.146C281.477 126.222 277.529 130.506 271.929 130.506C266.301 130.506 262.381 126.222 262.381 120.146C262.381 114.07 266.329 109.758 271.929 109.758C277.557 109.758 281.477 114.042 281.477 120.146ZM279.405 120.146C279.405 115.134 276.353 111.718 271.929 111.718C267.505 111.718 264.481 115.134 264.481 120.146C264.481 125.158 267.505 128.574 271.929 128.574C276.353 128.574 279.405 125.13 279.405 120.146Z" fill="white"/>
<path d="M287.149 130.169H285.133V110.121H287.177L298.209 126.809V110.121H300.197V130.169H298.209L287.149 113.481V130.169Z" fill="white"/>
<path d="M304.42 134.564H302.656C304.868 131.484 306.352 126.696 306.352 121.768C306.352 116.728 304.812 112.024 302.656 109H304.42C306.856 112.332 308.312 117.148 308.312 121.768C308.312 126.584 306.772 131.344 304.42 134.564Z" fill="white"/>
</g>
<defs>
<filter id="filter0_d_2013_189" x="35" y="4" width="249.842" height="102.617" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="5.5"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0.123486 0 0 0 0 0.123486 0 0 0 0 0.123486 0 0 0 0.45 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2013_189"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2013_189" result="shape"/>
</filter>
<filter id="filter1_d_2013_189" x="1" y="102" width="318.312" height="47.5625" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="5.5"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0.123486 0 0 0 0 0.123486 0 0 0 0 0.123486 0 0 0 0.45 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2013_189"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2013_189" result="shape"/>
</filter>
</defs>
</svg>
`;var diamondPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class DiamondPlugin extends BaseIJewel3DKeyPlugin{get envMapRotation(){var o,l;return(l=(o=this.envMap)===null||o===void 0?void 0:o.rotation)!==null&&l!==void 0?l:0}set envMapRotation(o){var l;const c=[this.envMap,this.envMap2,this.envMap3];for(const u of c)u&&(u.rotation=o,(l=this._viewer)===null||l===void 0||l.scene.setDirty())}refreshEnvMaps(){var o,l,c;if(!this._viewer)return;const u=this.getEnvMaps(),h=((l=(o=this._viewer.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0?void 0:l.getMaterialsOfType(DiamondMaterial.TypeSlug))||[];for(const _ of h)_&&(_.envMaps=u);(c=this._viewer)===null||c===void 0||c.scene.setDirty()}constructor(){super(),this.offsetCache={},this.enabled=!0,this.envMap=null,this.envMap2=null,this.envMap3=null,this.forceSceneEnvMap=!1,this.getEnvMaps=()=>{var o;if(!this.forceSceneEnvMap&&this.envMap)return[this.envMap,this.envMap2,this.envMap3];const l=((o=this._viewer)===null||o===void 0?void 0:o.scene.environment)||null;return[l,l,l]},this._modelProcessor={forAssetType:"model",processAsync:async(o,l)=>{const c=[];return o.modelObject.traverse(u=>{var h,_,A,w;const C=(_=(h=u.userData)===null||h===void 0?void 0:h.gltfExtensions)===null||_===void 0?void 0:_[DiamondPlugin.DIAMOND_GLTF_EXTENSION];C&&u.geometry&&(this.prepareDiamondMesh(u,C),delete u.userData.gltfExtensions[DiamondPlugin.DIAMOND_GLTF_EXTENSION]),u.material&&!c.includes(u.material)&&(!((w=(A=u.material.userData)===null||A===void 0?void 0:A.gltfExtensions)===null||w===void 0)&&w[DiamondPlugin.DIAMOND_GLTF_EXTENSION])&&(u.material.materialObject||console.warn("WebGi DiamondPlugin: material not processed",u.material),c.push(u.material))}),c.forEach(u=>{const h=u.userData.gltfExtensions[DiamondPlugin.DIAMOND_GLTF_EXTENSION];h&&this._convertToDiamondMaterial(u,h)}),o}},this.uiConfig={type:"folder",label:"Diamonds",children:[{type:"checkbox",label:"Use Scene Environment",property:[this,"forceSceneEnvironment"],limitedUi:!0},{type:"image",label:"Environment",hidden:()=>this.forceSceneEnvMap,property:[this,"envMap"],limitedUi:!0},{type:"slider",bounds:[0,2*Math.PI],hidden:()=>this.forceSceneEnvMap,label:"Env Rotation",property:[this,"envMapRotation"],limitedUi:!0},{type:"image",label:"Environment 2",hidden:()=>this.forceSceneEnvMap,property:[this,"envMap2"]},{type:"image",label:"Environment 3",hidden:()=>this.forceSceneEnvMap,property:[this,"envMap3"]},{type:"button",label:"Make Diamond",hidden:()=>{var o,l,c;const u=(c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject())===null||c===void 0?void 0:c.material;return!!Array.isArray(u)||(u==null?void 0:u.typeSlug)!==MeshStandardMaterial2.TypeSlug},value:async()=>{var o,l,c,u,h,_;const A=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();if(!(A!=null&&A.material))return;const w=await((c=this._viewer)===null||c===void 0?void 0:c.prompt("Cache key: Enter optional cache key unique to the diamond shape.","",!1)),C=(await((u=this._viewer)===null||u===void 0?void 0:u.prompt("Cache size: Enter size of the cache [64-1024]","512",!1))||"512").toLowerCase(),M=C.endsWith("high")?"high":C.endsWith("low")?"low":"medium";let O=parseInt(C);isFinite(O)||(O=512),O<64&&(O=64),((h=A.material.userData)===null||h===void 0?void 0:h.__appliedMeshes.size)>1&&await((_=this._viewer)===null||_===void 0?void 0:_.confirm("Convert all: Apply diamond material to all the meshes with the same material?"))?this.makeDiamond(A.material,{cacheKey:w||void 0,normalMapRes:O,normalMapPrecision:M},{}):this.makeDiamondMesh(A,{cacheKey:w||void 0,normalMapRes:O,normalMapPrecision:M},{}),this.refreshUi()},limitedUi:!0},{type:"button",label:"Make Standard",hidden:()=>{var o,l,c;const u=(c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject())===null||c===void 0?void 0:c.material;return!!Array.isArray(u)||(u==null?void 0:u.typeSlug)!==DiamondMaterial.TypeSlug},value:async()=>{var o,l,c,u,h,_,A,w;const C=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject(),M=C==null?void 0:C.material;if(!M)return;const O=M.userData.__baseMaterial;let ne=(h=(u=(c=this._viewer)===null||c===void 0?void 0:c.getManager())===null||u===void 0?void 0:u.materials)===null||h===void 0?void 0:h.findMaterial(O);if(ne&&!ne.isDiamondMaterial||(ne=(_=this._viewer)===null||_===void 0?void 0:_.createPhysicalMaterial({color:M.color})),ne){const ce=M.userData.__appliedMeshes.size>1&&await((A=this._viewer)===null||A===void 0?void 0:A.confirm("Convert all with this material?"))?Array.from(M.userData.__appliedMeshes):[C];for(const ue of ce)(w=ue==null?void 0:ue.setMaterial)===null||w===void 0||w.call(ue,ne),this.unprepareDiamondMesh(ue)}this.refreshUi()},limitedUi:!0},{type:"button",label:"Auto Instance Diamonds (dev)",hidden:()=>{var o,l,c,u;const h=(c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject())===null||c===void 0?void 0:c.material;return!!Array.isArray(h)||(h==null?void 0:h.typeSlug)!==DiamondMaterial.TypeSlug||((u=h.userData.__appliedMeshes)===null||u===void 0?void 0:u.size)<2},value:async()=>{var o,l;const c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();if(!c)return;const u=c.material;u&&!Array.isArray(u)&&autoGPUInstanceMeshes(u)}},{type:"button",label:"Clear Cache",value:()=>{this.disposeAllCacheMaps()}}]},this.refreshEnvMaps=this.refreshEnvMaps.bind(this),this.refreshUi=this.refreshUi.bind(this)}refreshUi(){var o,l,c;(o=this._viewer)===null||o===void 0||o.setDirty(),(c=(l=this.uiConfig)===null||l===void 0?void 0:l.uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0)}async onAdded(o){var l,c,u,h,_,A,w;this._normalCapture=new CubeNormalsCaptureHelper(o.renderer),this.offsetCache={},o.scene.addEventListener("materialChanged",ne=>{var ce,ue,ye,Oe,ke;if(!((ce=ne.material)===null||ce===void 0)&&ce.isDiamondMaterial){const Ve=ne.material,tt=ne.mesh||ne.object;if(tt.geometry&&!(!((ue=this._normalCapture)===null||ue===void 0)&&ue.hasCapturedNormalMap(tt.geometry))){const ut=(ke=(Oe=(ye=Ve==null?void 0:Ve.userData)===null||ye===void 0?void 0:ye.gltfExtensions)===null||Oe===void 0?void 0:Oe[DiamondPlugin.DIAMOND_GLTF_EXTENSION])!==null&&ke!==void 0?ke:{};ut.cacheKey===void 0&&!tt.userData._diamondCacheKey&&(Ve!=null&&Ve.name)&&(ut.cacheKey=Ve.name),this.prepareDiamondMesh(tt,ut)}const ht=this.getEnvMaps();Ve.envMaps=ht}}),o.scene.addEventListener("environmentChanged",this.refreshEnvMaps);const C=o.getPlugin(AssetManagerPlugin);(l=C==null?void 0:C.importer)===null||l===void 0||l.processors.add("model",this._modelProcessor),(c=o.getPlugin(PickingPlugin))===null||c===void 0||c.addEventListener("selectedObjectChanged",this.refreshUi);const M=this.getEnvMaps,O=new Importer(class extends SimpleJSONLoader{async loadAsync(ne,ce){var ue;const ye=await super.loadAsync(ne,ce);return ye.type===DiamondMaterial.TYPE||ye.isDiamondMaterialParameters?(ye.envMap=M(),(ue=C==null?void 0:C.materials)===null||ue===void 0?void 0:ue.generateFromTemplate("diamond",ye)):(console.error("Invalid material type for Diamond Material.",ye),null)}},[DiamondMaterial.TypeSlug],!1);return(u=C==null?void 0:C.importer)===null||u===void 0||u.Importers.push(O),(A=(_=(h=C==null?void 0:C.exporter)===null||h===void 0?void 0:h.getExporter("gltf","glb"))===null||_===void 0?void 0:_.extensions)===null||A===void 0||A.push(diamondMaterialGLTFExportExtension),(w=C==null?void 0:C.materials)===null||w===void 0||w.registerMaterialTemplate({name:"diamond",materialType:DiamondMaterial.TYPE,isDiamondMaterialParameters:!0,generator:(ne,ce)=>{const ue=!(ce!=null&&ce.metadata||!ce.isDiamondMaterialParameters)||(ce==null?void 0:ce.metadata)&&(ce==null?void 0:ce.metadata.version)<=4.5,ye=ce==null?void 0:ce.color;ue&&typeof ce.color=="number"&&(ce.color=new three_module.Q1f().setHex(ce.color,three_module.Zr2).getHex());const Oe=new DiamondMaterial(ne);return Oe.envMaps=this.getEnvMaps(),!ce||ce.isMeshStandardMaterial||ce.isMeshPhysicalMaterial||Oe.copyProps(ce),ce.color=ye,Oe}}),super.onAdded(o)}async onRemove(o){var l,c,u,h;return(l=this._normalCapture)===null||l===void 0||l.dispose(),this._normalCapture=void 0,this.offsetCache={},(u=(c=o.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.processors.remove("model",this._modelProcessor),(h=o.getPlugin(PickingPlugin))===null||h===void 0||h.removeEventListener("selectedObjectChanged",this.refreshUi),super.onRemove(o)}unprepareDiamondMesh(o){var l;o.userData&&(delete o.userData._diamondCacheKey,delete o.userData._diamondNormalMapRes,delete o.userData._diamondNormalMapPrecision,o.geometry&&(this._removeOffsets(o.geometry),(l=this._normalCapture)===null||l===void 0||l.removeNormalMap(o.geometry)))}prepareDiamondMesh(o,{cacheKey:l,normalMapRes:c,normalMapPrecision:u}){var h,_,A;this.use(),o.userData._diamondCacheKey=l??o.userData._diamondCacheKey,o.userData._diamondNormalMapRes=c??o.userData._diamondNormalMapRes,o.userData._diamondNormalMapPrecision=u??o.userData._diamondNormalMapPrecision,l=l&&l.length>0?l.includes(";"+o.geometry.uuid)?l:l+";"+o.geometry.uuid:o.geometry.uuid,this._computeOffsets(o.geometry,o.geometry.uuid);const w=(_=(h=this._normalCapture)===null||h===void 0?void 0:h.captureNormalMap(o.geometry,l,c,u,o))!==null&&_!==void 0?_:[void 0,!1],C=(A=this._viewer)===null||A===void 0?void 0:A.getPluginByType("debug");C&&w&&(C.counters.normalsCapture||(C.counters.normalsCapture=0),C.counters.normalsCapture++,console.log("DEBUG: new normal map captured",C.counters.normalsCapture,l),C.addTexture("normal"+C.counters.normalsCapture,()=>{var M,O;return(O=(M=o.geometry)===null||M===void 0?void 0:M.userData._normalsCaptureMap)===null||O===void 0?void 0:O.texture},[40,110*C.counters.normalsCapture-100,200,100],void 0,void 0,"postRender",!0))}makeDiamond(o,l,c){var u,h;Array.from((u=o==null?void 0:o.userData.__appliedMeshes)!==null&&u!==void 0?u:[]).forEach(_=>{_!=null&&_.isMesh&&_.geometry&&this.prepareDiamondMesh(_,l)}),this._convertToDiamondMaterial(o,c),(h=this._viewer)===null||h===void 0||h.setDirty()}makeDiamondMesh(o,l,c){if(!o.modelObject.isMesh||!o.geometry||!o.setMaterial)return;this.prepareDiamondMesh(o.modelObject,l);const u=Array.isArray(o.material)?o.material[0]:o.material,h=this._convertToDiamondMaterial(u,c,!1);o.setMaterial(h)}_convertToDiamondMaterial(o,l={isDiamond:!0},c=!0){var u,h,_,A,w,C,M,O;let ne={...l??{}};ne.isDiamond||ne.isDiamondMaterialParameters?Array.isArray(ne.boostFactors)&&(ne.boostFactors=new three_module.Pq0().fromArray(ne.boostFactors)):ne={isDiamondMaterialParameters:!0},ne.color=(h=(u=ne.color)!==null&&u!==void 0?u:o==null?void 0:o.color)!==null&&h!==void 0?h:new three_module.Q1f(1,1,1),ne.name=(A=(_=ne.name)!==null&&_!==void 0?_:o==null?void 0:o.name)!==null&&A!==void 0?A:"diamond";const ce=(M=(C=(w=this._viewer)===null||w===void 0?void 0:w.getManager())===null||C===void 0?void 0:C.materials)===null||M===void 0?void 0:M.generateFromTemplate("diamond",ne);if(ce&&o&&!o.isDiamondMaterial&&(ce.userData.__baseMaterial=o.uuid),c){const ue=ye=>{var Oe;return(Oe=ye.setMaterial)!==null&&Oe!==void 0?Oe:ke=>{ye.material=ke.materialObject}};Array.from((O=o==null?void 0:o.userData.__appliedMeshes)!==null&&O!==void 0?O:[]).forEach(ye=>{ue(ye)(ce),this.prepareDiamondMesh(ye,l)})}return ce}_computeOffsets(o,l,c=!1){var u;if(o.userData.normalsCaptureOffsets){if(rt("recomputeOffsets")===null)return o.userData.normalsCaptureOffsets;console.warn("WebGi DiamondPlugin: recomputeOffsets",o.userData.normalsCaptureOffsets)}let h;!((u=o.morphAttributes)===null||u===void 0)&&u.position&&(h=o.morphAttributes,o.morphAttributes={}),o.computeBoundingBox();const _=o.boundingBox.getCenter(new three_module.Pq0).toArray(),A=computeEigenVectors(o).toArray(),w=new three_module.kn4().fromArray(A).invert(),C=new three_module.Pq0().fromArray(_).applyMatrix4(w).toArray(),M={center:_,offsetMatrix:A,offsetMatrixInv:w.toArray(),radius:1,centerOffset:C};return o.userData.normalsCaptureOffsets=M,h&&(o.morphAttributes=h,o.computeBoundingBox()),rt("recomputeOffsets")!==null&&console.warn("WebGi DiamondPlugin: recomputeOffsets",M),M}_removeOffsets(o){delete o.userData.normalsCaptureOffsets}getAllCacheMaps(){var o;const l=new Set;return(o=this._viewer)===null||o===void 0||o.scene.modelObject.traverse(c=>{c.geometry&&c.geometry.userData._normalsCaptureMap&&l.add(c.geometry.userData._normalsCaptureMap)}),[...l]}disposeCacheMap(o){var l;(l=this._normalCapture)===null||l===void 0||l.disposeTarget(o)}disposeAllCacheMaps(){var o;(o=this._normalCapture)===null||o===void 0||o.disposeAllTargets()}}DiamondPlugin.PluginType="Diamond",DiamondPlugin.DIAMOND_GLTF_EXTENSION="WEBGI_materials_diamond",diamondPlugin_decorate([x(DiamondPlugin.prototype.refreshEnvMaps),serialize()],DiamondPlugin.prototype,"envMap",void 0),diamondPlugin_decorate([x(DiamondPlugin.prototype.refreshEnvMaps),serialize()],DiamondPlugin.prototype,"envMap2",void 0),diamondPlugin_decorate([x(DiamondPlugin.prototype.refreshEnvMaps),serialize()],DiamondPlugin.prototype,"envMap3",void 0),diamondPlugin_decorate([x(DiamondPlugin.prototype.refreshEnvMaps),serialize()],DiamondPlugin.prototype,"forceSceneEnvMap",void 0);const diamondMaterialGLTFExportExtension=d=>({writeMaterial:(o,l)=>{o.isDiamondMaterial&&(l.extensions=l.extensions||{},l.extensions[DiamondPlugin.DIAMOND_GLTF_EXTENSION]=o.toJSON(),d.extensionsUsed[DiamondPlugin.DIAMOND_GLTF_EXTENSION]=!0)},writeMesh:(o,l)=>{var c,u;if(!(o!=null&&o.material.isDiamondMaterial))return;l.extensions=l.extensions||{};const h={};(u=(c=o.userData)===null||c===void 0?void 0:c.gltfExtensions)===null||u===void 0||delete u[DiamondPlugin.DIAMOND_GLTF_EXTENSION],o.userData._diamondNormalMapRes&&(h.normalMapRes=o.userData._diamondNormalMapRes),o.userData._diamondNormalMapPrecision&&(h.normalMapPrecision=o.userData._diamondNormalMapPrecision),o.userData._diamondCacheKey&&(h.cacheKey=o.userData._diamondCacheKey),l.extensions[DiamondPlugin.DIAMOND_GLTF_EXTENSION]=h,d.extensionsUsed[DiamondPlugin.DIAMOND_GLTF_EXTENSION]=!0}});var __assign=function(){return __assign=Object.assign||function(d){for(var o,l=1,c=arguments.length;l<c;l++)for(var u in o=arguments[l])Object.prototype.hasOwnProperty.call(o,u)&&(d[u]=o[u]);return d},__assign.apply(this,arguments)};function __rest(d,o){var l={};for(var c in d)Object.prototype.hasOwnProperty.call(d,c)&&o.indexOf(c)<0&&(l[c]=d[c]);if(d!=null&&typeof Object.getOwnPropertySymbols=="function"){var u=0;for(c=Object.getOwnPropertySymbols(d);u<c.length;u++)o.indexOf(c[u])<0&&Object.prototype.propertyIsEnumerable.call(d,c[u])&&(l[c[u]]=d[c[u]])}return l}function __spreadArray(d,o,l){if(l||arguments.length===2)for(var c,u=0,h=o.length;u<h;u++)!c&&u in o||(c||(c=Array.prototype.slice.call(o,0,u)),c[u]=o[u]);return d.concat(c||Array.prototype.slice.call(o))}typeof SuppressedError=="function"&&SuppressedError;var invariant=function(){},clamp=function(d,o,l){return Math.min(Math.max(l,d),o)},safeMin=.001,minDuration=.01,maxDuration=10,minDamping=.05,maxDamping=1;function findSpring(d){var o,l,c=d.duration,u=c===void 0?800:c,h=d.bounce,_=h===void 0?.25:h,A=d.velocity,w=A===void 0?0:A,C=d.mass,M=C===void 0?1:C,O=1-_;O=clamp(minDamping,maxDamping,O),u=clamp(minDuration,maxDuration,u/1e3),O<1?(o=function(ue){var ye=ue*O,Oe=ye*u,ke=ye-w,Ve=calcAngularFreq(ue,O),tt=Math.exp(-Oe);return safeMin-ke/Ve*tt},l=function(ue){var ye=ue*O*u,Oe=ye*w+w,ke=Math.pow(O,2)*Math.pow(ue,2)*u,Ve=Math.exp(-ye),tt=calcAngularFreq(Math.pow(ue,2),O);return(-o(ue)+safeMin>0?-1:1)*((Oe-ke)*Ve)/tt}):(o=function(ue){return Math.exp(-ue*u)*((ue-w)*u+1)-safeMin},l=function(ue){return Math.exp(-ue*u)*(u*u*(w-ue))});var ne=approximateRoot(o,l,5/u);if(u*=1e3,isNaN(ne))return{stiffness:100,damping:10,duration:u};var ce=Math.pow(ne,2)*M;return{stiffness:ce,damping:2*O*Math.sqrt(M*ce),duration:u}}var rootIterations=12;function approximateRoot(d,o,l){for(var c=l,u=1;u<rootIterations;u++)c-=d(c)/o(c);return c}function calcAngularFreq(d,o){return d*Math.sqrt(1-o*o)}var durationKeys=["duration","bounce"],physicsKeys=["stiffness","damping","mass"];function isSpringType(d,o){return o.some(function(l){return d[l]!==void 0})}function getSpringOptions(d){var o=__assign({velocity:0,stiffness:100,damping:10,mass:1,isResolvedFromDuration:!1},d);if(!isSpringType(d,physicsKeys)&&isSpringType(d,durationKeys)){var l=findSpring(d);(o=__assign(__assign(__assign({},o),l),{velocity:0,mass:1})).isResolvedFromDuration=!0}return o}function spring(d){var o=d.from,l=o===void 0?0:o,c=d.to,u=c===void 0?1:c,h=d.restSpeed,_=h===void 0?2:h,A=d.restDelta,w=__rest(d,["from","to","restSpeed","restDelta"]),C={done:!1,value:l},M=getSpringOptions(w),O=M.stiffness,ne=M.damping,ce=M.mass,ue=M.velocity,ye=M.duration,Oe=M.isResolvedFromDuration,ke=zero,Ve=zero;function tt(){var ht=ue?-ue/1e3:0,ut=u-l,_t=ne/(2*Math.sqrt(O*ce)),at=Math.sqrt(O/ce)/1e3;if(A!=null||(A=Math.abs(u-l)<=1?.01:.4),_t<1){var lt=calcAngularFreq(at,_t);ke=function(xt){var Tt=Math.exp(-_t*at*xt);return u-Tt*((ht+_t*at*ut)/lt*Math.sin(lt*xt)+ut*Math.cos(lt*xt))},Ve=function(xt){var Tt=Math.exp(-_t*at*xt);return _t*at*Tt*(Math.sin(lt*xt)*(ht+_t*at*ut)/lt+ut*Math.cos(lt*xt))-Tt*(Math.cos(lt*xt)*(ht+_t*at*ut)-lt*ut*Math.sin(lt*xt))}}else if(_t===1)ke=function(xt){return u-Math.exp(-at*xt)*(ut+(ht+at*ut)*xt)};else{var pt=at*Math.sqrt(_t*_t-1);ke=function(xt){var Tt=Math.exp(-_t*at*xt),Pt=Math.min(pt*xt,300);return u-Tt*((ht+_t*at*ut)*Math.sinh(Pt)+pt*ut*Math.cosh(Pt))/pt}}}return tt(),{next:function(ht){var ut=ke(ht);if(Oe)C.done=ht>=ye;else{var _t=1e3*Ve(ht),at=Math.abs(_t)<=_,lt=Math.abs(u-ut)<=A;C.done=at&&lt}return C.value=C.done?u:ut,C},flipTarget:function(){var ht;ue=-ue,l=(ht=[u,l])[0],u=ht[1],tt()}}}spring.needsInterpolation=function(d,o){return typeof d=="string"||typeof o=="string"};var zero=function(d){return 0},progress=function(d,o,l){var c=o-d;return c===0?1:(l-d)/c},mix=function(d,o,l){return-l*d+l*o+d},utils_clamp=function(d,o){return function(l){return Math.max(Math.min(l,o),d)}},sanitize=function(d){return d%1?Number(d.toFixed(5)):d},floatRegex=/(-)?([\d]*\.?[\d])+/g,colorRegex=/(#[0-9a-f]{6}|#[0-9a-f]{3}|#(?:[0-9a-f]{2}){2,4}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2,3}\s*\/*\s*[\d\.]+%?\))/gi,singleColorRegex=/^(#[0-9a-f]{3}|#(?:[0-9a-f]{2}){2,4}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2,3}\s*\/*\s*[\d\.]+%?\))$/i;function isString(d){return typeof d=="string"}var number={test:function(d){return typeof d=="number"},parse:parseFloat,transform:function(d){return d}},alpha=__assign(__assign({},number),{transform:utils_clamp(0,1)});__assign(__assign({},number),{default:1});var isColorString=function(d,o){return function(l){return!!(isString(l)&&singleColorRegex.test(l)&&l.startsWith(d)||o&&Object.prototype.hasOwnProperty.call(l,o))}},splitColor=function(d,o,l){return function(c){var u;if(!isString(c))return c;var h=c.match(floatRegex),_=h[0],A=h[1],w=h[2],C=h[3];return(u={})[d]=parseFloat(_),u[o]=parseFloat(A),u[l]=parseFloat(w),u.alpha=C!==void 0?parseFloat(C):1,u}},clampRgbUnit=utils_clamp(0,255),rgbUnit=__assign(__assign({},number),{transform:function(d){return Math.round(clampRgbUnit(d))}}),rgba={test:isColorString("rgb","red"),parse:splitColor("red","green","blue"),transform:function(d){var o=d.red,l=d.green,c=d.blue,u=d.alpha,h=u===void 0?1:u;return"rgba("+rgbUnit.transform(o)+", "+rgbUnit.transform(l)+", "+rgbUnit.transform(c)+", "+sanitize(alpha.transform(h))+")"}};function parseHex(d){var o="",l="",c="",u="";return d.length>5?(o=d.substr(1,2),l=d.substr(3,2),c=d.substr(5,2),u=d.substr(7,2)):(o=d.substr(1,1),l=d.substr(2,1),c=d.substr(3,1),u=d.substr(4,1),o+=o,l+=l,c+=c,u+=u),{red:parseInt(o,16),green:parseInt(l,16),blue:parseInt(c,16),alpha:u?parseInt(u,16)/255:1}}var hex={test:isColorString("#"),parse:parseHex,transform:rgba.transform},createUnitType=function(d){return{test:function(o){return isString(o)&&o.endsWith(d)&&o.split(" ").length===1},parse:parseFloat,transform:function(o){return""+o+d}}},percent=createUnitType("%");__assign(__assign({},percent),{parse:function(d){return percent.parse(d)/100},transform:function(d){return percent.transform(100*d)}});var hsla={test:isColorString("hsl","hue"),parse:splitColor("hue","saturation","lightness"),transform:function(d){var o=d.hue,l=d.saturation,c=d.lightness,u=d.alpha,h=u===void 0?1:u;return"hsla("+Math.round(o)+", "+percent.transform(sanitize(l))+", "+percent.transform(sanitize(c))+", "+sanitize(alpha.transform(h))+")"}},mixLinearColor=function(d,o,l){var c=d*d,u=o*o;return Math.sqrt(Math.max(0,l*(u-c)+c))},colorTypes=[hex,rgba,hsla],getColorType=function(d){return colorTypes.find(function(o){return o.test(d)})},mixColor=function(d,o){var l=getColorType(d),c=getColorType(o);if(invariant(l.transform===c.transform),!l||!c||l.transform!==c.transform)return function(w){return""+(w>0?o:d)};var u=l.parse(d),h=c.parse(o),_=__assign({},u),A=l===hsla?mix:mixLinearColor;return function(w){for(var C in _)C!=="alpha"&&(_[C]=A(u[C],h[C],w));return _.alpha=mix(u.alpha,h.alpha,w),l.transform(_)}},color={test:function(d){return rgba.test(d)||hex.test(d)||hsla.test(d)},parse:function(d){return rgba.test(d)?rgba.parse(d):hsla.test(d)?hsla.parse(d):hex.parse(d)},transform:function(d){return isString(d)?d:d.hasOwnProperty("red")?rgba.transform(d):hsla.transform(d)}},colorToken="${c}",numberToken="${n}";function test(d){var o,l,c,u;return isNaN(d)&&isString(d)&&((l=(o=d.match(floatRegex))===null||o===void 0?void 0:o.length)!==null&&l!==void 0?l:0)+((u=(c=d.match(colorRegex))===null||c===void 0?void 0:c.length)!==null&&u!==void 0?u:0)>0}function analyse(d){typeof d=="number"&&(d=""+d);var o=[],l=0,c=d.match(colorRegex);c&&(l=c.length,d=d.replace(colorRegex,colorToken),o.push.apply(o,c.map(color.parse)));var u=d.match(floatRegex);return u&&(d=d.replace(floatRegex,numberToken),o.push.apply(o,u.map(number.parse))),{values:o,numColors:l,tokenised:d}}function parse(d){return analyse(d).values}function createTransformer(d){var o=analyse(d),l=o.values,c=o.numColors,u=o.tokenised,h=l.length;return function(_){for(var A=u,w=0;w<h;w++)A=A.replace(w<c?colorToken:numberToken,w<c?color.transform(_[w]):sanitize(_[w]));return A}}var convertNumbersToZero=function(d){return typeof d=="number"?0:d};function getAnimatableNone(d){var o=parse(d);return createTransformer(d)(o.map(convertNumbersToZero))}var complex={test,parse,createTransformer,getAnimatableNone},zeroPoint={x:0,y:0,z:0},isNum=function(d){return typeof d=="number"},combineFunctions=function(d,o){return function(l){return o(d(l))}},pipe=function(){for(var d=[],o=0;o<arguments.length;o++)d[o]=arguments[o];return d.reduce(combineFunctions)};function getMixer(d,o){return isNum(d)?function(l){return mix(d,o,l)}:color.test(d)?mixColor(d,o):mixComplex(d,o)}var mixArray=function(d,o){var l=__spreadArray([],d),c=l.length,u=d.map(function(h,_){return getMixer(h,o[_])});return function(h){for(var _=0;_<c;_++)l[_]=u[_](h);return l}},mixObject=function(d,o){var l=__assign(__assign({},d),o),c={};for(var u in l)d[u]!==void 0&&o[u]!==void 0&&(c[u]=getMixer(d[u],o[u]));return function(h){for(var _ in c)l[_]=c[_](h);return l}};function mix_complex_analyse(d){for(var o=complex.parse(d),l=o.length,c=0,u=0,h=0,_=0;_<l;_++)c||typeof o[_]=="number"?c++:o[_].hue!==void 0?h++:u++;return{parsed:o,numNumbers:c,numRGB:u,numHSL:h}}var mixComplex=function(d,o){var l=complex.createTransformer(o),c=mix_complex_analyse(d),u=mix_complex_analyse(o);return c.numHSL===u.numHSL&&c.numRGB===u.numRGB&&c.numNumbers>=u.numNumbers?pipe(mixArray(c.parsed,u.parsed),l):function(h){return""+(h>0?o:d)}},mixNumber=function(d,o){return function(l){return mix(d,o,l)}};function detectMixerFactory(d){return typeof d=="number"?mixNumber:typeof d=="string"?color.test(d)?mixColor:mixComplex:Array.isArray(d)?mixArray:typeof d=="object"?mixObject:void 0}function createMixers(d,o,l){for(var c=[],u=l||detectMixerFactory(d[0]),h=d.length-1,_=0;_<h;_++){var A=u(d[_],d[_+1]);if(o){var w=Array.isArray(o)?o[_]:o;A=pipe(w,A)}c.push(A)}return c}function fastInterpolate(d,o){var l=d[0],c=d[1],u=o[0];return function(h){return u(progress(l,c,h))}}function slowInterpolate(d,o){var l=d.length,c=l-1;return function(u){var h=0,_=!1;if(u<=d[0]?_=!0:u>=d[c]&&(h=c-1,_=!0),!_){for(var A=1;A<l&&!(d[A]>u||A===c);A++);h=A-1}var w=progress(d[h],d[h+1],u);return o[h](w)}}function interpolate(d,o,l){var c=l===void 0?{}:l,u=c.clamp,h=u===void 0||u,_=c.ease,A=c.mixer,w=d.length;invariant(w===o.length),invariant(!_||!Array.isArray(_)||_.length===w-1),d[0]>d[w-1]&&(d=[].concat(d),o=[].concat(o),d.reverse(),o.reverse());var C=createMixers(o,_,A),M=w===2?fastInterpolate(d,C):slowInterpolate(d,C);return h?function(O){return M(clamp(d[0],d[w-1],O))}:M}var reverseEasing=function(d){return function(o){return 1-d(1-o)}},mirrorEasing=function(d){return function(o){return o<=.5?d(2*o)/2:(2-d(2*(1-o)))/2}},createExpoIn=function(d){return function(o){return Math.pow(o,d)}},createBackIn=function(d){return function(o){return o*o*((d+1)*o-d)}},createAnticipate=function(d){var o=createBackIn(d);return function(l){return(l*=2)<1?.5*o(l):.5*(2-Math.pow(2,-10*(l-1)))}},DEFAULT_OVERSHOOT_STRENGTH=1.525,BOUNCE_FIRST_THRESHOLD=4/11,BOUNCE_SECOND_THRESHOLD=8/11,BOUNCE_THIRD_THRESHOLD=.9,linear=function(d){return d},easeIn=createExpoIn(2),easeOut=reverseEasing(easeIn),easeInOut=mirrorEasing(easeIn),circIn=function(d){return 1-Math.sin(Math.acos(d))},circOut=reverseEasing(circIn),circInOut=mirrorEasing(circOut),backIn=createBackIn(DEFAULT_OVERSHOOT_STRENGTH),backOut=reverseEasing(backIn),backInOut=mirrorEasing(backIn),anticipate=createAnticipate(DEFAULT_OVERSHOOT_STRENGTH),ca=4356/361,cb=35442/1805,cc=16061/1805,bounceOut=function(d){if(d===1||d===0)return d;var o=d*d;return d<BOUNCE_FIRST_THRESHOLD?7.5625*o:d<BOUNCE_SECOND_THRESHOLD?9.075*o-9.9*d+3.4:d<BOUNCE_THIRD_THRESHOLD?ca*o-cb*d+cc:10.8*d*d-20.52*d+10.72},bounceIn=reverseEasing(bounceOut),bounceInOut=function(d){return d<.5?.5*(1-bounceOut(1-2*d)):.5*bounceOut(2*d-1)+.5};function defaultEasing(d,o){return d.map(function(){return o||easeInOut}).splice(0,d.length-1)}function defaultOffset(d){var o=d.length;return d.map(function(l,c){return c!==0?c/(o-1):0})}function convertOffsetToTimes(d,o){return d.map(function(l){return l*o})}function keyframes(d){var o=d.from,l=o===void 0?0:o,c=d.to,u=c===void 0?1:c,h=d.ease,_=d.offset,A=d.duration,w=A===void 0?300:A,C={done:!1,value:l},M=Array.isArray(u)?u:[l,u],O=convertOffsetToTimes(_&&_.length===M.length?_:defaultOffset(M),w);function ne(){return interpolate(O,M,{ease:Array.isArray(h)?h:defaultEasing(M,h)})}var ce=ne();return{next:function(ue){return C.value=ce(ue),C.done=ue>=w,C},flipTarget:function(){M.reverse(),ce=ne()}}}function decay(d){var o=d.velocity,l=o===void 0?0:o,c=d.from,u=c===void 0?0:c,h=d.power,_=h===void 0?.8:h,A=d.timeConstant,w=A===void 0?350:A,C=d.restDelta,M=C===void 0?.5:C,O=d.modifyTarget,ne={done:!1,value:u},ce=_*l,ue=u+ce,ye=O===void 0?ue:O(ue);return ye!==ue&&(ce=ye-u),{next:function(Oe){var ke=-ce*Math.exp(-Oe/w);return ne.done=!(ke>M||ke<-M),ne.value=ne.done?ye:ye+ke,ne},flipTarget:function(){}}}var types={keyframes,spring,decay};function detectAnimationFromOptions(d){if(Array.isArray(d.to))return keyframes;if(types[d.type])return types[d.type];var o=new Set(Object.keys(d));return o.has("ease")||o.has("duration")&&!o.has("dampingRatio")?keyframes:o.has("dampingRatio")||o.has("stiffness")||o.has("mass")||o.has("damping")||o.has("restSpeed")||o.has("restDelta")?spring:keyframes}var defaultTimestep=1/60*1e3,getCurrentTime=typeof performance<"u"?function(){return performance.now()}:function(){return Date.now()},onNextFrame=typeof window<"u"?function(d){return window.requestAnimationFrame(d)}:function(d){return setTimeout(function(){return d(getCurrentTime())},defaultTimestep)};function createRenderStep(d){var o=[],l=[],c=0,u=!1,h=new WeakSet,_={schedule:function(A,w,C){w===void 0&&(w=!1),C===void 0&&(C=!1);var M=C&&u,O=M?o:l;return w&&h.add(A),O.indexOf(A)===-1&&(O.push(A),M&&u&&(c=o.length)),A},cancel:function(A){var w=l.indexOf(A);w!==-1&&l.splice(w,1),h.delete(A)},process:function(A){var w;if(u=!0,o=(w=[l,o])[0],(l=w[1]).length=0,c=o.length)for(var C=0;C<c;C++){var M=o[C];M(A),h.has(M)&&(_.schedule(M),d())}u=!1}};return _}var maxElapsed=40,useDefaultElapsed=!0,runNextFrame=!1,isProcessing=!1,es_frame={delta:0,timestamp:0},stepsOrder=["read","update","preRender","render","postRender"],steps=stepsOrder.reduce(function(d,o){return d[o]=createRenderStep(function(){return runNextFrame=!0}),d},{}),sync=stepsOrder.reduce(function(d,o){var l=steps[o];return d[o]=function(c,u,h){return u===void 0&&(u=!1),h===void 0&&(h=!1),runNextFrame||startLoop(),l.schedule(c,u,h)},d},{}),cancelSync=stepsOrder.reduce(function(d,o){return d[o]=steps[o].cancel,d},{});stepsOrder.reduce(function(d,o){return d[o]=function(){return steps[o].process(es_frame)},d},{});var processStep=function(d){return steps[d].process(es_frame)},processFrame=function(d){runNextFrame=!1,es_frame.delta=useDefaultElapsed?defaultTimestep:Math.max(Math.min(d-es_frame.timestamp,maxElapsed),1),es_frame.timestamp=d,isProcessing=!0,stepsOrder.forEach(processStep),isProcessing=!1,runNextFrame&&(useDefaultElapsed=!1,onNextFrame(processFrame))},startLoop=function(){runNextFrame=!0,useDefaultElapsed=!0,isProcessing||onNextFrame(processFrame)},getFrameData=function(){return es_frame},es=sync;function loopElapsed(d,o,l){return l===void 0&&(l=0),d-o-l}function reverseElapsed(d,o,l,c){return l===void 0&&(l=0),c===void 0&&(c=!0),c?loopElapsed(o+-d,o,l):o-(d-o)+l}function hasRepeatDelayElapsed(d,o,l,c){return c?d>=o+l:d<=-l}var framesync=function(d){var o=function(l){var c=l.delta;return d(c)};return{start:function(){return es.update(o,!0)},stop:function(){return cancelSync.update(o)}}};function animate(d){var o,l,c,u,h,_=d.from,A=d.autoplay,w=A===void 0||A,C=d.driver,M=C===void 0?framesync:C,O=d.elapsed,ne=O===void 0?0:O,ce=d.repeat,ue=ce===void 0?0:ce,ye=d.repeatType,Oe=ye===void 0?"loop":ye,ke=d.repeatDelay,Ve=ke===void 0?0:ke,tt=d.onPlay,ht=d.onStop,ut=d.onComplete,_t=d.onRepeat,at=d.onUpdate,lt=__rest(d,["from","autoplay","driver","elapsed","repeat","repeatType","repeatDelay","onPlay","onStop","onComplete","onRepeat","onUpdate"]),pt=lt.to,xt=0,Tt=lt.duration,Pt=!1,Lt=!0,Bt=detectAnimationFromOptions(lt);!((l=(o=Bt).needsInterpolation)===null||l===void 0)&&l.call(o,_,pt)&&(h=interpolate([0,100],[_,pt],{clamp:!1}),_=0,pt=100);var Ut=Bt(__assign(__assign({},lt),{from:_,to:pt}));return w&&(tt==null||tt(),(c=M(function(kt){if(Lt||(kt=-kt),ne+=kt,!Pt){var Vt=Ut.next(Math.max(0,ne));u=Vt.value,h&&(u=h(u)),Pt=Lt?Vt.done:ne<=0}at==null||at(u),Pt&&(xt===0&&(Tt!=null||(Tt=ne)),xt<ue?hasRepeatDelayElapsed(ne,Tt,Ve,Lt)&&(xt++,Oe==="reverse"?ne=reverseElapsed(ne,Tt,Ve,Lt=xt%2==0):(ne=loopElapsed(ne,Tt,Ve),Oe==="mirror"&&Ut.flipTarget()),Pt=!1,_t&&_t()):(c.stop(),ut&&ut()))})).start()),{stop:function(){ht==null||ht(),c.stop()}}}const easeInOutSine=d=>-(Math.cos(Math.PI*d)-1)/2,EasingFunctions$1={linear,easeIn,easeOut,easeInOut,circIn,circOut,circInOut,backIn,backOut,backInOut,anticipate,bounceOut,bounceIn,bounceInOut,easeInOutSine};function makeSetterFor(d,o,l){const c=d[o],u=()=>{l==null||l()};return c&&c.isColor?h=>{c.set(h),u()}:c&&typeof c.copy=="function"?h=>{c.copy(h),u()}:h=>{d[o]=h,u()}}function isAnimatableType(d){return typeof d!="boolean"}async function animateTarget(d,o,l,c,u=!1){o in d||console.error("invalid key",o,d);const h=makeSetterFor(d,o),_=u||l.from===void 0?d[o]:l.from,A=w=>{var C;h(w),(C=l.onUpdate)===null||C===void 0||C.call(l,w)};if(isAnimatableType(_))return typeof l.to=="function"&&(l={...l,to:l.to(_,d)}),animateAsync({...l,from:_,onUpdate:A},c);{const{duration:w}=l;return X(w??0).then(()=>A(l.to))}}async function animateAsync(d,o){const l=d.onComplete,c=d.onStop,u=d.onEnd;return d={...d},new Promise((h,_)=>{d.onComplete=()=>{try{l==null||l()}catch(w){return u==null||u(),void _(w)}u==null||u(),h()},d.onStop=()=>{try{c==null||c()}catch(w){return u==null||u(),void _(w)}u==null||u(),h()};const A=animate(d);o&&o.push(A)})}var InteractionPromptPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},InteractionPromptPlugin_1;let InteractionPromptPlugin=InteractionPromptPlugin_1=class extends AViewerPlugin{constructor(d=!0){super(),this.animationRunning=!1,this.animationDuration=2e3,this.animationDistance=80,this.animationPauseDuration=6e3,this.rotationDistance=.3,this.yOffset=0,this.autoStart=!0,this.autoStartDelay=3e4,this.autoStop=!0,this.autoStartOnObjectLoad=!0,this.autoStartOnObjectLoadDelay=3e3,this.currentTime=0,this.lastActionTime=1/0,this._xDamper=new k(50),this.pointerIcon=`<svg xmlns="http://www.w3.org/2000/svg" style="transform: translate(-50%, -25%);" width="25" height="36">
    <defs>
        <path id="A" d="M.001.232h24.997V36H.001z"></path>
    </defs>
    <g transform="translate(-11 -4)" fill="none" fill-rule="evenodd">
        <path fill-opacity="0" fill="#fff" d="M0 0h44v44H0z"></path>
        <g transform="translate(11 3)">
            <path d="M8.733 11.165c.04-1.108.766-2.027 1.743-2.307a2.54 2.54 0 0 1 .628-.089c.16 0 .314.017.463.044 1.088.2 1.9 1.092 1.9 2.16v8.88h1.26c2.943-1.39 5-4.45 5-8.025a9.01 9.01 0 0 0-1.9-5.56l-.43-.5c-.765-.838-1.683-1.522-2.712-2-1.057-.49-2.226-.77-3.46-.77s-2.4.278-3.46.77c-1.03.478-1.947 1.162-2.71 2l-.43.5a9.01 9.01 0 0 0-1.9 5.56 9.04 9.04 0 0 0 .094 1.305c.03.21.088.41.13.617l.136.624c.083.286.196.56.305.832l.124.333a8.78 8.78 0 0 0 .509.953l.065.122a8.69 8.69 0 0 0 3.521 3.191l1.11.537v-9.178z" fill-opacity=".5" fill="#e4e4e4"></path>
            <path d="M22.94 26.218l-2.76 7.74c-.172.485-.676.8-1.253.8H12.24c-1.606 0-3.092-.68-3.98-1.82-1.592-2.048-3.647-3.822-6.11-5.27-.095-.055-.15-.137-.152-.23-.004-.1.046-.196.193-.297.56-.393 1.234-.6 1.926-.6a3.43 3.43 0 0 1 .691.069l4.922.994V10.972c0-.663.615-1.203 1.37-1.203s1.373.54 1.373 1.203v9.882h2.953c.273 0 .533.073.757.21l6.257 3.874c.027.017.045.042.07.06.41.296.586.77.426 1.22M4.1 16.614c-.024-.04-.042-.083-.065-.122a8.69 8.69 0 0 1-.509-.953c-.048-.107-.08-.223-.124-.333l-.305-.832c-.058-.202-.09-.416-.136-.624l-.13-.617a9.03 9.03 0 0 1-.094-1.305c0-2.107.714-4.04 1.9-5.56l.43-.5c.764-.84 1.682-1.523 2.71-2 1.058-.49 2.226-.77 3.46-.77s2.402.28 3.46.77c1.03.477 1.947 1.16 2.712 2l.428.5a9 9 0 0 1 1.901 5.559c0 3.577-2.056 6.636-5 8.026h-1.26v-8.882c0-1.067-.822-1.96-1.9-2.16-.15-.028-.304-.044-.463-.044-.22 0-.427.037-.628.09-.977.28-1.703 1.198-1.743 2.306v9.178l-1.11-.537C6.18 19.098 4.96 18 4.1 16.614M22.97 24.09l-6.256-3.874c-.102-.063-.218-.098-.33-.144 2.683-1.8 4.354-4.855 4.354-8.243 0-.486-.037-.964-.104-1.43a9.97 9.97 0 0 0-1.57-4.128l-.295-.408-.066-.092a10.05 10.05 0 0 0-.949-1.078c-.342-.334-.708-.643-1.094-.922-1.155-.834-2.492-1.412-3.94-1.65l-.732-.088-.748-.03a9.29 9.29 0 0 0-1.482.119c-1.447.238-2.786.816-3.94 1.65a9.33 9.33 0 0 0-.813.686 9.59 9.59 0 0 0-.845.877l-.385.437-.36.5-.288.468-.418.778-.04.09c-.593 1.28-.93 2.71-.93 4.222 0 3.832 2.182 7.342 5.56 8.938l1.437.68v4.946L5 25.64a4.44 4.44 0 0 0-.888-.086c-.017 0-.034.003-.05.003-.252.004-.503.033-.75.08a5.08 5.08 0 0 0-.237.056c-.193.046-.382.107-.568.18-.075.03-.15.057-.225.1-.25.114-.494.244-.723.405a1.31 1.31 0 0 0-.566 1.122 1.28 1.28 0 0 0 .645 1.051C4 29.925 5.96 31.614 7.473 33.563a5.06 5.06 0 0 0 .434.491c1.086 1.082 2.656 1.713 4.326 1.715h6.697c.748-.001 1.43-.333 1.858-.872.142-.18.256-.38.336-.602l2.757-7.74c.094-.26.13-.53.112-.794s-.088-.52-.203-.76a2.19 2.19 0 0 0-.821-.91" fill-opacity=".6" fill="#000"></path>
            <path d="M22.444 24.94l-6.257-3.874a1.45 1.45 0 0 0-.757-.211h-2.953v-9.88c0-.663-.616-1.203-1.373-1.203s-1.37.54-1.37 1.203v16.643l-4.922-.994a3.44 3.44 0 0 0-.692-.069 3.35 3.35 0 0 0-1.925.598c-.147.102-.198.198-.194.298.004.094.058.176.153.23 2.462 1.448 4.517 3.22 6.11 5.27.887 1.14 2.373 1.82 3.98 1.82h6.686c.577 0 1.08-.326 1.253-.8l2.76-7.74c.16-.448-.017-.923-.426-1.22-.025-.02-.043-.043-.07-.06z" fill="#fff"></path>
            <g transform="translate(0 .769)">
                <mask id="B" fill="#fff">
                    <use xlink:href="#A"></use>
                </mask>
                <path d="M23.993 24.992a1.96 1.96 0 0 1-.111.794l-2.758 7.74c-.08.22-.194.423-.336.602-.427.54-1.11.87-1.857.872h-6.698c-1.67-.002-3.24-.633-4.326-1.715-.154-.154-.3-.318-.434-.49C5.96 30.846 4 29.157 1.646 27.773c-.385-.225-.626-.618-.645-1.05a1.31 1.31 0 0 1 .566-1.122 4.56 4.56 0 0 1 .723-.405l.225-.1a4.3 4.3 0 0 1 .568-.18l.237-.056c.248-.046.5-.075.75-.08.018 0 .034-.003.05-.003.303-.001.597.027.89.086l3.722.752V20.68l-1.436-.68c-3.377-1.596-5.56-5.106-5.56-8.938 0-1.51.336-2.94.93-4.222.015-.03.025-.06.04-.09.127-.267.268-.525.418-.778.093-.16.186-.316.288-.468.063-.095.133-.186.2-.277L3.773 5c.118-.155.26-.29.385-.437.266-.3.544-.604.845-.877a9.33 9.33 0 0 1 .813-.686C6.97 2.167 8.31 1.59 9.757 1.35a9.27 9.27 0 0 1 1.481-.119 8.82 8.82 0 0 1 .748.031c.247.02.49.05.733.088 1.448.238 2.786.816 3.94 1.65.387.28.752.588 1.094.922a9.94 9.94 0 0 1 .949 1.078l.066.092c.102.133.203.268.295.408a9.97 9.97 0 0 1 1.571 4.128c.066.467.103.945.103 1.43 0 3.388-1.67 6.453-4.353 8.243.11.046.227.08.33.144l6.256 3.874c.37.23.645.55.82.9.115.24.185.498.203.76m.697-1.195c-.265-.55-.677-1.007-1.194-1.326l-5.323-3.297c2.255-2.037 3.564-4.97 3.564-8.114 0-2.19-.637-4.304-1.84-6.114-.126-.188-.26-.37-.4-.552-.645-.848-1.402-1.6-2.252-2.204C15.472.91 13.393.232 11.238.232A10.21 10.21 0 0 0 5.23 2.19c-.848.614-1.606 1.356-2.253 2.205-.136.18-.272.363-.398.55C1.374 6.756.737 8.87.737 11.06c0 4.218 2.407 8.08 6.133 9.842l.863.41v3.092l-2.525-.51c-.356-.07-.717-.106-1.076-.106a5.45 5.45 0 0 0-3.14.996c-.653.46-1.022 1.202-.99 1.983a2.28 2.28 0 0 0 1.138 1.872c2.24 1.318 4.106 2.923 5.543 4.772 1.26 1.62 3.333 2.59 5.55 2.592h6.698c1.42-.001 2.68-.86 3.134-2.138l2.76-7.74c.272-.757.224-1.584-.134-2.325" fill-opacity=".05" fill="#000" mask="url(#B)"></path>
            </g>
        </g>
    </g>
</svg>`,this._activeCameraUpdate=o=>{this.isDisabled()||(o.change==="deserialize"&&this.animationRunning?(this.stopAnimation({reset:!1}),this.startAnimation()):this.lastActionTime=g())},this._addSceneObject=()=>{this.autoStartOnObjectLoad&&(this.lastActionTime=g()-this.autoStartDelay+this.autoStartOnObjectLoadDelay)},this.onlyOnOrbitControls=!0,this._orbitWarning=!1,this.startAnimation=()=>{var o;if(this._viewer&&this.cursorEl&&!this.isDisabled())return((o=this._viewer.scene.activeCamera.controls)===null||o===void 0?void 0:o.type)!=="OrbitControls"&&this.onlyOnOrbitControls?(this._orbitWarning||console.warn("WebGi InteractionPromptPlugin requires OrbitControls, to run anyway, set onlyOnOrbitControls to false"),void(this._orbitWarning=!0)):void(this._viewer.scene.modelRoot.children.length!==0&&(this.currentSphericalPosition=new three_module.YHV().setFromVector3(new three_module.Pq0().subVectors(this._viewer.scene.activeCamera.position,this._viewer.scene.activeCamera.target)),this.cursorEl.style.opacity="1",this.currentTime=0,this.animationRunning=!0,this._viewer.scene.activeCamera.setInteractions(!1,InteractionPromptPlugin_1.PluginType)))},this.stopAnimation=({reset:o=!0}={})=>{if(this._viewer&&this.cursorEl)return this.animationRunning=!1,this.cursorEl.style.opacity="0",this.currentSphericalPosition&&o&&(this._viewer.scene.activeCamera.position.setFromSpherical(this.currentSphericalPosition).add(this._viewer.scene.activeCamera.target),this._viewer.scene.activeCamera.positionUpdated(),this.currentSphericalPosition=void 0),this._viewer.scene.activeCamera.setInteractions(!0,InteractionPromptPlugin_1.PluginType),this._viewer.doOnce("postFrame")},this._pointerDown=()=>{this.isDisabled()||(this.autoStop&&this.stopAnimation({reset:!1}),this.lastActionTime=g())},this._x=0,this._preFrame=async o=>{if(!this._viewer||!this.cursorEl||(this.isDisabled()&&this.animationRunning&&this.stopAnimation(),this.isDisabled())||(!this.animationRunning&&this.autoStart&&this.lastActionTime+this.autoStartDelay<g()&&this.startAnimation(),!this.animationRunning))return;if(this.currentTime<=this.animationDuration){this.cursorEl.style.opacity="1";const h=this.currentTime/this.animationDuration;this._x=Math.sin(2*Math.PI*h),(h<.25||h>.75)&&(this._x*=this._x*Math.sign(this._x))}else this.cursorEl.style.opacity="0",this._x=0;if(this.currentTime<=this.animationDuration+50){const h=this.currentSphericalPosition.clone();h.theta+=this._x*this.rotationDistance,this._viewer.scene.activeCamera.position.setFromSpherical(h).add(this._viewer.scene.activeCamera.target),this._viewer.scene.activeCamera.positionUpdated()}const l=this._viewer.container.getBoundingClientRect(),c=l.width/2+-this._x*Math.min(this.animationDistance,l.width/4),u=l.height/2+this.yOffset*l.height/2;this.cursorEl.style.transform=`translate(${Math.floor(c)}px, ${Math.floor(u)}px)`,this.currentTime+=o.deltaTime,this.currentTime>this.animationDuration+this.animationPauseDuration&&(this.currentTime=0)},this._disabledBy=new Set,this.disable=o=>{this._disabledBy.size,this._disabledBy.add(o)},this.enable=o=>{this._disabledBy.size,this._disabledBy.delete(o)},this.isDisabled=()=>this._disabledBy.size>0||!this.enabled,this.enabled=d}async onAdded(d){await super.onAdded(d);{Object.hasOwn(d.plugins,"InteractionPointerPlugin")&&delete d.plugins.InteractionPointerPlugin;const o=this;Object.defineProperty(d.plugins,"InteractionPointerPlugin",{get(){return console.warn("WebGi InteractionPromptPlugin: PluginType renamed from InteractionPointerPlugin to InteractionPromptPlugin. Please update your code/vjson."),o},configurable:!0})}this.lastActionTime=1/0,d.addEventListener("preFrame",this._preFrame),d.container.addEventListener("pointerdown",this._pointerDown,!0),d.container.addEventListener("wheel",this._pointerDown,!0),d.scene.addEventListener("addSceneObject",this._addSceneObject),d.scene.addEventListener("activeCameraUpdate",this._activeCameraUpdate),this._initializeCursor()}async onRemove(d){return this.stopAnimation(),d.removeEventListener("preFrame",this._preFrame),d.container.removeEventListener("pointerdown",this._pointerDown,!0),d.container.removeEventListener("wheel",this._pointerDown,!0),d.scene.removeEventListener("addSceneObject",this._addSceneObject),d.scene.removeEventListener("activeCameraUpdate",this._activeCameraUpdate),this.cursorEl&&this.cursorEl.remove(),super.onRemove(d)}_initializeCursor(){this.cursorEl=document.createElement("div"),this.cursorEl.style.position="absolute",this.cursorEl.style.top="0",this.cursorEl.style.left="0",this.cursorEl.style.width="10px",this.cursorEl.style.height="10px",this.cursorEl.style.opacity="0",this.cursorEl.innerHTML=this.pointerIcon,this._viewer.container.appendChild(this.cursorEl)}};InteractionPromptPlugin.PluginType="InteractionPromptPlugin",InteractionPromptPlugin_decorate([serialize(),uiToggle()],InteractionPromptPlugin.prototype,"enabled",void 0),InteractionPromptPlugin_decorate([serialize(),uiInput()],InteractionPromptPlugin.prototype,"animationDuration",void 0),InteractionPromptPlugin_decorate([serialize(),uiInput()],InteractionPromptPlugin.prototype,"animationDistance",void 0),InteractionPromptPlugin_decorate([serialize(),uiInput()],InteractionPromptPlugin.prototype,"animationPauseDuration",void 0),InteractionPromptPlugin_decorate([serialize(),uiInput()],InteractionPromptPlugin.prototype,"rotationDistance",void 0),InteractionPromptPlugin_decorate([serialize(),uiInput()],InteractionPromptPlugin.prototype,"yOffset",void 0),InteractionPromptPlugin_decorate([serialize(),uiToggle()],InteractionPromptPlugin.prototype,"autoStart",void 0),InteractionPromptPlugin_decorate([serialize(),uiInput()],InteractionPromptPlugin.prototype,"autoStartDelay",void 0),InteractionPromptPlugin_decorate([serialize(),uiToggle()],InteractionPromptPlugin.prototype,"autoStop",void 0),InteractionPromptPlugin_decorate([serialize(),uiToggle()],InteractionPromptPlugin.prototype,"autoStartOnObjectLoad",void 0),InteractionPromptPlugin_decorate([serialize(),uiToggle()],InteractionPromptPlugin.prototype,"autoStartOnObjectLoadDelay",void 0),InteractionPromptPlugin_decorate([uiMonitor()],InteractionPromptPlugin.prototype,"currentTime",void 0),InteractionPromptPlugin_decorate([uiMonitor()],InteractionPromptPlugin.prototype,"lastActionTime",void 0),InteractionPromptPlugin_decorate([serialize()],InteractionPromptPlugin.prototype,"onlyOnOrbitControls",void 0),InteractionPromptPlugin_decorate([uiButton()],InteractionPromptPlugin.prototype,"startAnimation",void 0),InteractionPromptPlugin_decorate([uiButton()],InteractionPromptPlugin.prototype,"stopAnimation",void 0),InteractionPromptPlugin=InteractionPromptPlugin_1=InteractionPromptPlugin_decorate([uiFolder("Interaction Prompt")],InteractionPromptPlugin);var CameraViewPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let viewId=1,CameraView=class{constructor(d,o,l,c,u=1){this.position=new three_module.Pq0,this.target=new three_module.Pq0,this.quaternion=new three_module.PTz,this.up=new three_module.Pq0,this.duration=1,this.name="Camera View",this.focusView=()=>{},this.deleteView=()=>{},this.updateView=()=>{},this.uiConfig=generateUiFolder(this.name,this),d&&(this.position=d),o&&(this.target=o),l&&(this.up=l),c&&(this.quaternion=c),u!==void 0&&u!==0&&(this.duration=u),this.name="#view"+viewId++}_nameChanged(){var d,o;this.uiConfig&&(this.uiConfig.label=this.name,(o=(d=this.uiConfig).uiRefresh)===null||o===void 0||o.call(d))}};CameraViewPlugin_decorate([serialize(),uiVector()],CameraView.prototype,"position",void 0),CameraViewPlugin_decorate([serialize(),uiVector()],CameraView.prototype,"target",void 0),CameraViewPlugin_decorate([serialize(),uiVector()],CameraView.prototype,"quaternion",void 0),CameraViewPlugin_decorate([serialize(),uiVector()],CameraView.prototype,"up",void 0),CameraViewPlugin_decorate([serialize(),uiInput()],CameraView.prototype,"duration",void 0),CameraViewPlugin_decorate([serialize(),uiInput()],CameraView.prototype,"name",void 0),CameraViewPlugin_decorate([uiButton()],CameraView.prototype,"focusView",void 0),CameraViewPlugin_decorate([uiButton()],CameraView.prototype,"deleteView",void 0),CameraViewPlugin_decorate([uiButton()],CameraView.prototype,"updateView",void 0),CameraView=CameraViewPlugin_decorate([serializable("CameraView")],CameraView);class CameraViewPlugin extends AViewerPlugin{get animationLooping(){return this._animationLooping}get animating(){return this._animating}constructor(){super(),this.enabled=!0,this._cameraViews=[],this.viewLooping=!1,this.viewPauseTime=200,this.animEase="easeInOutSine",this.animDuration=1e3,this.rotationOffset=.25,this.interpolateMode="spherical",this.splineCurve="chordal",this.animateOnScroll=!1,this.seekOnScroll=!1,this._animating=!1,this.dependencies=[],this._scrollAnimationState=0,this.scrollAnimationDamping=.1,this._updaters=[],this._lastFrameTime=0,this._fadeDisabled=!1,this._viewQueue=[],this._animationLooping=!1,this._infiniteLooping=!0,this._driver=o=>({start:()=>this._updaters.push({u:o,time:0}),stop:()=>this._updaters.splice(this._updaters.findIndex(l=>l.u===o),1)}),this.focusNext=(o=!0)=>{if(this._animating||this._cameraViews.length<2)return;let l=this._cameraViews.findIndex(c=>c===this._currentView);l<0&&(l=-1),l+=1,o?l%=this._cameraViews.length:l=Math.min(l,this._cameraViews.length-1),this.focusView(this._cameraViews[l])},this.focusPrevious=(o=!0)=>{if(this._animating||this._cameraViews.length<2||!this._currentView)return;let l=this._cameraViews.findIndex(c=>c===this._currentView);l<0&&(l=0),l-=1,l=o?(l+this._cameraViews.length)%this._cameraViews.length:Math.max(l,0),this.focusView(this._cameraViews[l])},this._popAnimations=[],this.uiConfig={type:"folder",label:"Camera Views",children:[()=>[...this._cameraViews.map(o=>o.uiConfig)],...generateUiConfig(this)]},this.addCurrentView=this.addCurrentView.bind(this),this.animateAllViews=this.animateAllViews.bind(this),this.recordAllViews=this.recordAllViews.bind(this),this.resetToFirstView=this.resetToFirstView.bind(this),this._wheel=this._wheel.bind(this),this._pointerMove=this._pointerMove.bind(this),this._postFrame=this._postFrame.bind(this)}get camViews(){return this._cameraViews}_wheel(o){this.enabled&&(this.seekOnScroll&&!this._animating||Math.abs(o.deltaY)>.001&&(this._scrollAnimationState=-1*Math.sign(o.deltaY)))}_pointerMove(o){var l;if(this.enabled&&!this._animating&&this.seekOnScroll){const c=(l=this._viewer)===null||l===void 0?void 0:l.scene.activeCamera;if(!c)return;const u=new three_module.YHV,h=c.position,_=c.target,A=new three_module.PTz().setFromUnitVectors(c.cameraObject.up,new three_module.Pq0(0,1,0)),w=A.clone().invert(),C=h.clone().sub(_);C.applyQuaternion(A),u.setFromVector3(C),u.theta+=this.rotationOffset*o.movementX/this._viewer.canvas.clientWidth,u.phi+=this.rotationOffset*o.movementY/this._viewer.canvas.clientHeight,u.makeSafe(),C.setFromSpherical(u),C.applyQuaternion(w),h.copy(_).add(C),c.positionUpdated(!1),c.targetUpdated()}}async onAdded(o){await super.onAdded(o),o.addEventListener("preFrame",l=>{this.seekOnScroll||this._animating?this._viewer.scene.activeCamera.setInteractions(!1,CameraViewPlugin.PluginType):this._viewer.scene.activeCamera.setInteractions(!0,CameraViewPlugin.PluginType)}),o.addEventListener("postFrame",this._postFrame),window.addEventListener("wheel",this._wheel),window.addEventListener("pointermove",this._pointerMove)}_postFrame(){var o,l;if(!this._viewer)return;if(!this.enabled||!this._animating)return this._lastFrameTime=0,void(this._fadeDisabled&&((o=this._viewer.getPluginByType("FrameFade"))===null||o===void 0||o.enable(CameraViewPlugin.PluginType),this._fadeDisabled=!1));const c=g()/1e3;this._lastFrameTime<1&&(this._lastFrameTime=c-1/60);let u=c-this._lastFrameTime;this._lastFrameTime=c,u*=this.animateOnScroll?this._scrollAnimationState:1;const h=(l=this._viewer.getPluginByType("Progressive"))===null||l===void 0?void 0:l.postFrameConvergedRecordingDelta();if(h&&h>0&&(u=h),h!==0&&(u*=1e3,!(u<=0||(this._updaters.forEach(_=>{let A=u;_.time+A<0&&(A=-_.time),_.time+=A,Math.abs(A)>.001&&_.u(A)}),this._scrollAnimationState<.001?this._scrollAnimationState=0:this._scrollAnimationState*=1-this.scrollAnimationDamping,this._fadeDisabled)))){const _=this._viewer.getPluginByType("FrameFade");_&&(_.disable(CameraViewPlugin.PluginType),this._fadeDisabled=!0)}}async onRemove(o){return o.removeEventListener("postFrame",this._postFrame),window.removeEventListener("wheel",this._wheel),window.removeEventListener("pointermove",this._pointerMove),super.onRemove(o)}async _animationLoop(){if(!this._animationLooping){for(this._animationLooping=!0;(this.viewLooping||!this._infiniteLooping)&&this.enabled&&!(this._cameraViews.length<1);){if(this._viewQueue.length===0){if(!this._infiniteLooping)break;this._viewQueue.push(...this._cameraViews)}await this.animateToView(this._viewQueue.shift()),await X(2+this.viewPauseTime)}this._animationLooping=!1}}async animateAllViews(){if(this.enabled&&!(this.viewLooping||this._cameraViews.length<2)){for(;this._viewQueue.length>0;)this._viewQueue.pop();this._viewQueue.push(...this._cameraViews),this._viewQueue.push(this._viewQueue.shift()),this._infiniteLooping=!1,await this._animationLoop(),this._infiniteLooping=!0}}async resetToFirstView(o=100){this.enabled&&(this._currentView=void 0,await this.animateToView(this._cameraViews[0],o),await X(2))}async recordAllViews(o,l=!0){var c;if(!this.enabled)return;const u=(c=this._viewer)===null||c===void 0?void 0:c.getPluginByType("CanvasRecorder");if(!u||!u.enabled||this._cameraViews.length<1)return;if(u.isRecording())return void console.error("CanvasRecorderPlugin is already recording");let h=!1;return this.viewLooping&&(h=!0,this.viewLooping=!1),await this.resetToFirstView(),new Promise((_,A)=>{const w=()=>{u.removeEventListener("start",C),u.removeEventListener("stop",w),u.removeEventListener("error",M)},C=async()=>{var O;w(),o==null||o(),await this.animateAllViews();const ne=await u.stopRecording();if(h&&(this.viewLooping=!0),l){const ce=await((O=this._viewer)===null||O===void 0?void 0:O.prompt("Canvas Recorder: Save file as","recording.mp4"));ce!==null&&ne&&await this._downloadBlob(ne,ce||"recording.mp4")}_(ne)},M=async()=>{w(),A()};u.addEventListener("start",C),u.addEventListener("stop",w),u.addEventListener("error",M),u.startRecording()||console.error("cannot start recording")})}async addCurrentView(){if(!this.enabled)return;const o=this.getCurrentCameraView();this.addView(o)}addView(o){var l,c;this._cameraViews.push(o),(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l),this.dispatchEvent({type:"viewAdd",view:o})}getCurrentCameraView(o,l=!0,c){var u,h,_;if(o||(o=(u=this._viewer)===null||u===void 0?void 0:u.scene.activeCamera),!o)return new CameraView;const A=new three_module.Pq0;o.cameraObject.updateWorldMatrix(!0,!1);const w=o.cameraObject.matrixWorld;A.x=w.elements[4],A.y=w.elements[5],A.z=w.elements[6],A.normalize();const C=o.target.clone(),M=o.position.clone(),O=o.cameraObject.parent;O&&(l?M.applyMatrix4(O.matrixWorld):A.transformDirection(O.matrixWorld.clone().invert()));const ne=l?o.cameraObject.getWorldQuaternion(new three_module.PTz):o.cameraObject.quaternion.clone();return c?(c.position.copy(M),c.target.copy(C),c.up.copy(A),c.quaternion.copy(ne)):((c=new CameraView(M,C,A,ne,1)).focusView=async()=>c&&this.focusView(c),c.deleteView=()=>c&&this.deleteView(c),c.updateView=()=>this.getCurrentCameraView(o,l,c)),(_=(h=c.uiConfig).uiRefresh)===null||_===void 0||_.call(h,"postFrame",!0),c}setCurrentCameraView(o){var l;const c=(l=this._viewer)===null||l===void 0?void 0:l.scene.activeCamera;c&&(c.position.copy(o.position),c.target.copy(o.target),c.cameraObject.quaternion.copy(o.quaternion),c.positionUpdated())}async focusView(o){return this.animateToView(o)}deleteView(o){var l,c;const u=this._cameraViews.indexOf(o);u>=0&&this._cameraViews.splice(u,1),(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l),this.dispatchEvent({type:"viewDelete",view:o})}async stopAllAnimations(){for(this.viewLooping=!1,this._popAnimations.forEach(o=>{var l;return(l=o==null?void 0:o.stop)===null||l===void 0?void 0:l.call(o)}),this._popAnimations=[];this._animating||this._animationLooping;)await X(100)}async animateToView(o,l,c,u=!1){var h,_,A;const w=(h=this._viewer)===null||h===void 0?void 0:h.scene.activeCamera;if(!w)return;if(this._animating){this._popAnimations.forEach(ke=>(ke==null?void 0:ke.stop)&&ke.stop()),this._popAnimations=[];let Oe=0;for(;this._animating&&(await X(100),!(Oe++>20)););if(this._animating)return void console.warn("Unable to stop all animations, maybe because of viewLooping?")}const C=(_=this._viewer)===null||_===void 0?void 0:_.getPlugin(InteractionPromptPlugin);C&&C.animationRunning&&await C.stopAnimation({reset:!0}),this._currentView=o,this._animating=!0,this.dispatchEvent({type:"startViewChange",view:o}),l===void 0&&(l=this.animDuration),l=Math.max(10,l);const M=typeof c=="function"?c:EasingFunctions$1[c||this.animEase],O=this._driver,ne=[];this._popAnimations=[];const ce=this._popAnimations,ue=this.camViews.indexOf(o);let ye=this.interpolateMode;if(ue<0&&ye==="spline"&&(console.warn("CameraViewPlugin - Cannot animate along a spline with external camera view, fallback to spherical"),ye="spherical"),ye==="spherical")ne.push(animateCameraToViewSpherical(w,o,l*o.duration,M,O,ce));else if(ye==="linear"){ne.push(animateAsync({from:w.position.clone(),to:o.position.clone(),duration:l*o.duration,ease:M,driver:O,onUpdate:Ve=>w.position=Ve,onComplete:()=>w.position=o.position,onStop:()=>{throw new Error("Animation stopped")}},ce)),ne.push(animateAsync({from:w.target.clone(),to:o.target.clone(),duration:l*o.duration,ease:M,driver:O,onUpdate:Ve=>{w.target=Ve,w.targetUpdated()},onComplete:()=>{w.target=o.target,w.targetUpdated()}},ce));const Oe=w.cameraObject.quaternion.clone(),ke=new three_module.PTz;ne.push(animateAsync({from:0,to:1,duration:l*o.duration,ease:M,driver:O,onUpdate:Ve=>{ke.copy(Oe).slerp(o.quaternion,Ve),w.cameraObject.quaternion.copy(ke),w.cameraObject.updateProjectionMatrix()},onComplete:()=>{w.cameraObject.quaternion.copy(o.quaternion),w.cameraObject.updateProjectionMatrix()}},ce))}else if(ye==="spline"){const Oe=this.camViews.map(tt=>tt.position.clone()),ke=new three_module.B6O(Oe,!0,this.splineCurve,.75),Ve=tt=>{const ht=new three_module.Pq0,ut=1/Oe.length,_t=((ue===0?Oe.length:ue)-1)*ut;return ke.getPointAt(_t+tt*ut,ht),ht};ne.push(animateAsync({from:0,to:1,duration:l*o.duration,ease:M,driver:O,onUpdate:tt=>w.position=Ve(tt),onComplete:()=>w.position=Ve(1),onStop:()=>{throw new Error("Animation stopped")}},ce)),ne.push(animateAsync({from:w.target.clone(),to:o.target.clone(),duration:l*o.duration,ease:M,driver:O,onUpdate:tt=>{w.target=tt,w.targetUpdated()},onComplete:()=>{w.target=o.target,w.targetUpdated()}},ce))}await Promise.allSettled(ne).catch(Oe=>{if(u)throw Oe}),(A=this._viewer)===null||A===void 0||A.setDirty(),this._animating=!1,this.dispatchEvent({type:"viewChange",view:o}),await X(10)}fromJSON(o,l){var c,u;return this._cameraViews.forEach(h=>this.deleteView(h)),super.fromJSON(o,l)?(this._cameraViews.forEach(h=>h.focusView=async()=>this.focusView(h)),this._cameraViews.forEach(h=>h.deleteView=()=>this.deleteView(h)),this._cameraViews.forEach(h=>h.updateView=()=>this.getCurrentCameraView(void 0,void 0,h)),(u=(c=this.uiConfig).uiRefresh)===null||u===void 0||u.call(c),this):null}async animateToObject(o,l=4,c,u,h={min:.5,max:5}){if(!this._viewer)return;const _=new Box3B().expandByObject(o||this._viewer.scene.modelRoot.modelObject,!1,!0),A=_.getCenter(new three_module.Pq0),w=_.getSize(new three_module.Pq0).length()/2;await this.animateToTarget(Math.min(h.max,Math.max(h.min,w*l)),A,c,u)}async animateToFitObject(o,l=1.5,c=1e3,u,h={min:.5,max:50}){if(!this._viewer)return;const _=new Box3B().expandByObject(o||this._viewer.scene.modelRoot.modelObject,!1,!0),A=_.getCenter(new three_module.Pq0),w=this._viewer.scene.activeCamera.getFittingDistance(_);await this.animateToTarget(Math.min(h.max,Math.max(h.min,w*l)),A,c,u)}async animateToTarget(o,l,c,u){const h=this.getCurrentCameraView();h.target.copy(l);const _=new three_module.Pq0().subVectors(h.target,h.position).normalize();h.position.copy(_.multiplyScalar(-o).add(h.target)),await this.animateToView(h,c,u)}async _downloadBlob(o,l){var c,u;const h=(c=this._viewer)===null||c===void 0?void 0:c.getPluginByType("FileTransferPlugin");h?await h.exportFile(o,l):(u=this._viewer)===null||u===void 0||u.console.error("FileTransferPlugin required to export/download file")}}function sphericalFromObject(d,o){const l=d.position.clone();l.sub(o);const c=new three_module.YHV().setFromVector3(l);return c.makeSafe(),c}async function animateCameraToViewSpherical(d,o,l,c,u,h,_){const A=d.target.clone(),w=new three_module.Pq0,C=new three_module.Pq0,M=d.cameraObject.parent,O=d.cameraObject.up.clone(),ne=sphericalFromObject({position:d.cameraObject.getWorldPosition(new three_module.Pq0),up:M?O.transformDirection(M.matrixWorld):O},A),ce=sphericalFromObject(o,o.target),ue=new three_module.YHV;function ye(){d.position.copy(M?M.worldToLocal(C):C),d.target.copy(w),d.positionUpdated()}return animateAsync({from:0,to:1,duration:l,ease:c,driver:u,..._,onUpdate:Oe=>{ue.phi=lerpAngle(ne.phi,ce.phi,Oe),ue.theta=lerpAngle(ne.theta,ce.theta,Oe),ue.radius=three_module.cj9.lerp(ne.radius,ce.radius,Oe),w.copy(A).lerp(o.target,Oe),C.setFromSpherical(ue),C.add(w),ye()},onComplete:()=>{C.copy(o.position),w.copy(o.target),ye()},onStop:()=>{throw new Error("Animation Stopped")}},h)}function lerpAngle(d,o,l){const c=o-d;return c>=Math.PI?d+(c-2*Math.PI)*l:c<=-Math.PI?d+(c+2*Math.PI)*l:d+c*l}function lerpAngle2(d,o,l){const c=(1-l)*Math.cos(d)+l*Math.cos(o),u=(1-l)*Math.sin(d)+l*Math.sin(o);return Math.atan2(u,c)}CameraViewPlugin.PluginType="CameraViews",CameraViewPlugin_decorate([serialize("cameraViews")],CameraViewPlugin.prototype,"_cameraViews",void 0),CameraViewPlugin_decorate([x(CameraViewPlugin.prototype._animationLoop),serialize(),uiToggle("Loop All Views",{limitedUi:!0})],CameraViewPlugin.prototype,"viewLooping",void 0),CameraViewPlugin_decorate([serialize(),uiInput("View Pause Time")],CameraViewPlugin.prototype,"viewPauseTime",void 0),CameraViewPlugin_decorate([serialize(),uiDropdown("Ease",Object.keys(EasingFunctions$1).map(d=>({label:d})))],CameraViewPlugin.prototype,"animEase",void 0),CameraViewPlugin_decorate([serialize(),uiSlider("Duration",[10,1e4],10,{limitedUi:!0})],CameraViewPlugin.prototype,"animDuration",void 0),CameraViewPlugin_decorate([serialize(),uiSlider("RotationOffset",[.2,.75],.01)],CameraViewPlugin.prototype,"rotationOffset",void 0),CameraViewPlugin_decorate([serialize(),uiDropdown("Interpolation",["spherical","linear","spline (dev)"].map(d=>({label:d,value:d.split(" ")[0]})))],CameraViewPlugin.prototype,"interpolateMode",void 0),CameraViewPlugin_decorate([serialize(),uiDropdown("Spline Curve",["centripetal","chordal","catmullrom"].map(d=>({label:d})),d=>({hidden:()=>d.interpolateMode!=="spline",onChange:()=>{var o,l;return(l=(o=d.uiConfig)===null||o===void 0?void 0:o.uiRefresh)===null||l===void 0?void 0:l.call(o)}}))],CameraViewPlugin.prototype,"splineCurve",void 0),CameraViewPlugin_decorate([uiToggle(),serialize()],CameraViewPlugin.prototype,"seekOnScroll",void 0),CameraViewPlugin_decorate([uiButton("Animate All Views",{limitedUi:!0})],CameraViewPlugin.prototype,"animateAllViews",null),CameraViewPlugin_decorate([uiButton("Record All Views")],CameraViewPlugin.prototype,"recordAllViews",null),CameraViewPlugin_decorate([uiButton("Add Current View")],CameraViewPlugin.prototype,"addCurrentView",null),CameraViewPlugin_decorate([uiButton("Focus Next")],CameraViewPlugin.prototype,"focusNext",void 0),CameraViewPlugin_decorate([uiButton("Focus Previous")],CameraViewPlugin.prototype,"focusPrevious",void 0);const tempVec=new three_module.Pq0;function slerp(d,o,l){let c=d.dot(o);c=Math.min(Math.max(c,-1),1);const u=Math.acos(c)*l;return tempVec.copy(d).multiplyScalar(c).sub(o).negate().normalize(),d.multiplyScalar(Math.cos(u)).add(tempVec.multiplyScalar(Math.sin(u)))}var vignette="vec4 Vignette(in vec4 color){vec2 uv=vUv*(1.-vUv);float vig=uv.x*uv.y*16.;vig=pow(abs(vig),power);return vec4(mix(color.rgb,vec3(bgcolor),1.-vig),color.a);}",VignettePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let VignetteExtension=class{constructor(d){this.enabled=!1,this.power=.5,this.bgcolor=new three_module.Q1f(0),this.extraUniforms={power:{value:.5},bgcolor:{value:new three_module.Q1f}},this.parsFragmentSnippet=(o,l)=>this.enabled?fe`
            uniform float power;
            uniform vec3 bgcolor;
            ${vignette}
        `:"",this._combinedPostPlugin=d.getPlugin(CombinedPostPlugin),this._setDirty=this._setDirty.bind(this)}shaderExtender(d,o,l){this.enabled&&(d.fragmentShader=shaderReplaceString(d.fragmentShader,"#glMarker",` 
            gl_FragColor = Vignette(gl_FragColor);
            #glMarker
        `))}onObjectRender(d,o,l){this.enabled&&(this.extraUniforms.power.value=this.power,this.extraUniforms.bgcolor.value.copy(this.bgcolor))}getUiConfig(){return this.uiConfig}computeCacheKey(d){return this.enabled?"1":"0"}isCompatible(d){return!0}_setDirty(){this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){var d;(d=this.__setDirty)===null||d===void 0||d.call(this),this._setDirty()}};VignetteExtension.PluginType="Vignette",VignettePlugin_decorate([x(VignetteExtension.prototype._setDirty),uiToggle("Enable"),serialize()],VignetteExtension.prototype,"enabled",void 0),VignettePlugin_decorate([x(VignetteExtension.prototype._setDirty),uiSlider("Power",[.1,4],.01,{limitedUi:!0}),serialize()],VignetteExtension.prototype,"power",void 0),VignettePlugin_decorate([x(VignetteExtension.prototype._setDirty),uiColor("Color"),serialize()],VignetteExtension.prototype,"bgcolor",void 0),VignetteExtension=VignettePlugin_decorate([uiFolder("Vignette")],VignetteExtension);class VignettePlugin extends GenericExtensionPlugin{constructor(){super()}generateExtension(o){return new VignetteExtension(o)}get power(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.power)!==null&&l!==void 0?l:1}set power(o){this._extension&&(this._extension.power=o,this._extension.setDirty())}get color(){var o,l;return(l=(o=this._extension)===null||o===void 0?void 0:o.bgcolor)!==null&&l!==void 0?l:new three_module.Q1f}set color(o){this._extension&&(this._extension.bgcolor.set(o),this._extension.setDirty())}}VignettePlugin.PluginType="Vignette";var ssVelocityVert=`#ifdef USE_ALPHAMAP
#define USE_UV 
#endif
#include <uv_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec3 vWorldPosition;varying vec3 vWorldPositionPrevious;uniform mat4 modelMatrixPrevious;void main(){
#include <uv_vertex>
#include <skinbase_vertex>
#include <begin_vertex>
#include <morphtarget_vertex>
#include <skinning_vertex>
#include <displacementmap_vertex>
vec4 mvPosition=vec4(transformed,1.);
#ifdef USE_INSTANCING
mvPosition=instanceMatrix*mvPosition;
#endif
vWorldPosition=(modelMatrix*mvPosition).xyz;vWorldPositionPrevious=(modelMatrixPrevious*mvPosition).xyz;mvPosition=modelViewMatrix*mvPosition;gl_Position=projectionMatrix*mvPosition;
#include <logdepthbuf_vertex>
#include <clipping_planes_vertex>
}`,ssVelocityFrag="varying vec3 vWorldPosition;varying vec3 vWorldPositionPrevious;uniform mat4 currentProjectionViewMatrix;uniform mat4 lastProjectionViewMatrix;vec2 computeScreenSpaceVelocity2(){vec4 currentPositionClip=currentProjectionViewMatrix*vec4(vWorldPosition,1.);vec4 prevPositionClip=lastProjectionViewMatrix*vec4(vWorldPositionPrevious,1.);vec2 currentPositionNDC=currentPositionClip.xy/currentPositionClip.w;vec2 prevPositionNDC=prevPositionClip.xy/prevPositionClip.w;if(prevPositionNDC.x>=1.||prevPositionNDC.x<=-1.||prevPositionNDC.x>=1.||prevPositionNDC.y<=-1.){return vec2(0.);}return 0.5*(currentPositionNDC-prevPositionNDC);}void main(){vec2 velocity=clamp(computeScreenSpaceVelocity2(),-1.,1.);velocity=sign(velocity)*pow(abs(velocity),vec2(1./4.));velocity=velocity*0.5+0.5;gl_FragColor=vec4(velocity.x,velocity.y,1.,1.);}",SSVelocityPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let SSVelocityPass=class extends RenderPass{constructor(d,o,l){super(d,o,l??new SSVelocityMaterial,new three_module.Q1f(.5,.5,.5),1),this.enabled=!0,this._firstCall=!0}render(d,o,l,c,u){if(!this.enabled||!this.camera)return;const h=this.overrideMaterial;h.uniforms.currentProjectionViewMatrix.value.copy(this.camera.projectionMatrix).multiply(this.camera.matrixWorldInverse),this._firstCall&&(h.uniforms.lastProjectionViewMatrix.value.copy(h.uniforms.currentProjectionViewMatrix.value),this._firstCall=!1),super.render(d,o,l,c,u),h.uniforms.lastProjectionViewMatrix.value.copy(h.uniforms.currentProjectionViewMatrix.value)}};SSVelocityPass_decorate([uiToggle("Enabled")],SSVelocityPass.prototype,"enabled",void 0),SSVelocityPass=SSVelocityPass_decorate([uiFolder("Velocity Buffer (TAA)")],SSVelocityPass);class SSVelocityMaterial extends three_module.BKk{constructor(){super({vertexShader:ssVelocityVert,fragmentShader:ssVelocityFrag,uniforms:{cameraNearFar:{value:new three_module.I9Y(.1,1e3)},alphaMap:{value:null},alphaTest:{value:null},alphaMapTransform:{value:new three_module.dwI},currentProjectionViewMatrix:{value:new three_module.kn4},lastProjectionViewMatrix:{value:new three_module.kn4}}}),this.extraUniformsToUpload={modelMatrixPrevious:{value:new three_module.kn4().identity()}},this._previousWorldMatrices={}}onBeforeRender(o,l,c,u,h){var _,A;const w=this._previousWorldMatrices[h.uuid];this.extraUniformsToUpload.modelMatrixPrevious.value.copy(w??h.matrixWorld),w?w.copy(h.matrixWorld):this._previousWorldMatrices[h.uuid]=h.matrixWorld.clone();let C=h.material;Array.isArray(C)&&(C=C[0]),this.uniforms.alphaMap.value=(_=C==null?void 0:C.alphaMap)!==null&&_!==void 0?_:null,this.uniforms.alphaTest.value=!C||!C.alphaTest||C.alphaTest<1e-7?.001:C.alphaTest;let M=this.uniforms.alphaMap.value?1:void 0;M!==this.defines.USE_ALPHAMAP&&(M===void 0?delete this.defines.USE_ALPHAMAP:this.defines.USE_ALPHAMAP=M,this.needsUpdate=!0),M=C.userData.ALPHA_I_RGBA_PACKING?1:void 0,M!==this.defines.ALPHA_I_RGBA_PACKING&&(M===void 0?delete this.defines.ALPHA_I_RGBA_PACKING:this.defines.ALPHA_I_RGBA_PACKING=M,this.needsUpdate=!0),this.side=(A=C.side)!==null&&A!==void 0?A:three_module.$EB}}class VelocityBufferPlugin extends GenericFilterPlugin{passCtor(o){const l=o.renderer.createTarget({depthBuffer:!0,type:three_module.OUM});l.texture.name="velocityBuffer",this._velocityBuffers.push(l),o.getPluginByType("debug");const c=new Set,u=new Set;return new class extends SSVelocityPass{render(h,_,A,w,C){var M;if(o.renderer.frameCount>0)return;const O=h.getRenderTarget(),ne=h.getActiveCubeFace(),ce=h.getActiveMipmapLevel();(M=this.scene)===null||M===void 0||M.traverse(({material:ue})=>{var ye,Oe;if(!ue)return;const ke=ue.userData.renderToDepth&&!ue.userData.pluginsDisabled&&!(!((ye=ue.userData[VelocityBufferPlugin.PluginType])===null||ye===void 0)&&ye.disabled),Ve=ue.userData.renderToDepth===!1||ue.userData.pluginsDisabled||((Oe=ue.userData[VelocityBufferPlugin.PluginType])===null||Oe===void 0?void 0:Oe.disabled);(ue.transparent&&ke||!ue.transparent&&!ue.transmission&&Ve)&&(c.add(ue),ue.transparent=!ue.transparent),Math.abs(ue.transmission||0)>0&&ke&&(u.add([ue,ue.transmission]),ue.transmission=0)}),setThreeRendererMode(h,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!1,transmissionRender:!1,mainRenderPass:!1},()=>super.render(h,_,l,w,C)),c.forEach(ue=>ue.transparent=!ue.transparent),c.clear(),u.forEach(([ue,ye])=>ue.transmission=ye),u.clear(),h.setRenderTarget(O,ne,ce)}}}_update(o){if(!super._update(o)||o.renderer.frameCount>0)return!1;const l=this.pass.passObject;return l.scene=o.scene.modelObject,o.scene.renderCamera.updateShaderProperties(l.overrideMaterial),l.camera=o.scene.renderCamera.cameraObject,!0}constructor(o=!0){super(),this.passId="velocityBuffer",this._beforeFilters=["render"],this._afterFilters=[],this._requiredFilters=["render"],this._velocityBuffers=[],this.enabled=o}getVelocityBuffer(){return this._velocityBuffers.length>0?this._velocityBuffers[0]:void 0}async onDispose(o){}async onRemove(o){return this._velocityBuffers.forEach(l=>{var c;return o.renderer.disposeTarget((c=l==null?void 0:l.dispose)===null||c===void 0?void 0:c.call(l))}),super.onRemove(o)}updateShaderProperties(o){var l,c;return o.uniforms.tVelocity?o.uniforms.tVelocity.value=this.enabled&&(c=(l=this.getVelocityBuffer())===null||l===void 0?void 0:l.texture)!==null&&c!==void 0?c:null:console.warn("BaseRenderer: no uniform: tVelocity"),this}get uiConfig(){var o;return(o=this.pass)===null||o===void 0?void 0:o.passObject.uiConfig}}VelocityBufferPlugin.PluginType="VelocityBuffer";var lut=`#if (USE_LUT == 1 || USE_LUT1 == 1 || USE_LUT2 == 1)
uniform float lutSize;uniform float lutSize1;uniform float lutSize2;uniform float intensity;
#if USE_3DTEXTURE == 1
precision highp sampler3D;
#if USE_LUT == 1
uniform sampler3D lut3d;
#endif
#if USE_LUT1 == 1
uniform sampler3D lut3d1;
#endif
#if USE_LUT2 == 1
uniform sampler3D lut3d2;
#endif
#else
#if USE_LUT == 1
uniform sampler2D lut2d;
#endif
#if USE_LUT1 == 1
uniform sampler2D lut2d1;
#endif
#if USE_LUT2 == 1
uniform sampler2D lut2d2;
#endif
vec3 lutLookup(sampler2D tex,float size,vec3 rgb){float sliceHeight=1./size;float yPixelHeight=1./(size*size);float slice=rgb.b*size;float interp=fract(slice);float slice0=slice-interp;float centeredInterp=interp-0.5;float slice1=slice0+sign(centeredInterp);float greenOffset=clamp(rgb.g*sliceHeight,yPixelHeight*0.5,sliceHeight-yPixelHeight*0.5);vec2 uv0=vec2(rgb.r,slice0*sliceHeight+greenOffset);vec2 uv1=vec2(rgb.r,slice1*sliceHeight+greenOffset);vec3 sample0=texture2D(tex,uv0).rgb;vec3 sample1=texture2D(tex,uv1).rgb;return mix(sample0,sample1,abs(centeredInterp));}
#endif
int getLUTBit(in int number){
#ifdef WebGL2Context
return number%2;
#else
return int(mod(float(number),2.));
#endif
}int getLUTIndex(in int number){
#ifdef WebGL2Context
return number%8;
#else
return int(mod(float(number),8.));
#endif
}vec3 getUVW(in float lutSize,in vec4 color){float pixelWidth=1./lutSize;float halfPixelWidth=0.5/lutSize;vec3 uvw=vec3(halfPixelWidth)+color.rgb*(1.-pixelWidth);return uvw;}vec4 colorLookUp(in vec4 color){vec4 outColor;float lutFac=float(getLUTBit(getGBufferFlags(vUv).a));float lutIndex=float(getLUTIndex(getGBufferFlags(vUv).g));
#if USE_3DTEXTURE == 1
if(lutIndex==0.){
#if USE_LUT == 1
outColor=vec4(texture(lut3d,getUVW(lutSize,color)).rgb,color.a);
#endif
}else if(lutIndex==1.){
#if USE_LUT1 == 1
outColor=vec4(texture(lut3d1,getUVW(lutSize1,color)).rgb,color.a);
#endif
}else if(lutIndex==2.){
#if USE_LUT2 == 1
outColor=vec4(texture(lut3d2,getUVW(lutSize2,color)).rgb,color.a);
#endif
}else{
#if USE_LUT == 1
outColor=vec4(texture(lut3d,getUVW(lutSize,color)).rgb,color.a);
#endif
}
#else
if(lutIndex==0.){outColor=vec4(lutLookup(lut2d,lutSize,getUVW(lutSize,color)),color.a);}else if(lutIndex==1.){
#if USE_LUT1 == 1
outColor=vec4(lutLookup(lut2d1,lutSize,getUVW(lutSize1,color)),color.a);
#endif
}else if(lutIndex==2.){
#if USE_LUT2 == 1
outColor=vec4(lutLookup(lut2d2,lutSize,getUVW(lutSize2,color)),color.a);
#endif
}else{outColor=vec4(lutLookup(lut2d,lutSize,getUVW(lutSize,color)),color.a);}
#endif
outColor=mix(color,outColor,lutFac);return vec4(mix(color,outColor,intensity));}
#endif
`,LUTPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let LUTExtension=class{constructor(d){this.enabled=!1,this.lutBackground=!0,this.intensity=1,this.lutMap=void 0,this.lutMap1=void 0,this.lutMap2=void 0,this.extraUniforms={intensity:{value:1},lutSize:{value:1},lutSize1:{value:1},lutSize2:{value:1},lut3d:{value:null},lut3d1:{value:null},lut3d2:{value:null},lut2d:{value:null},lut2d1:{value:null},lut2d2:{value:null}},this.extraDefines={USE_LUT:0,USE_LUT1:0,USE_LUT2:0,USE_3DTEXTURE:0,LUT_BACKGROUND:0},this.parsFragmentSnippet=(o,l)=>this.enabled?lut:"",this._viewer=d,this._combinedPostPlugin=d.getPlugin(CombinedPostPlugin),this._setDirty=this._setDirty.bind(this),this.setDirty=this.setDirty.bind(this)}_updateParams(){if(!this.enabled)return;const d=this._viewer.renderer.rendererObject.capabilities.isWebGL2?1:0;let o=d?this.extraUniforms.lut3d:this.extraUniforms.lut2d;this._updateLUTMap(this.lutMap,o,this.extraUniforms.lutSize,d),this.extraDefines.USE_LUT=this.lutMap?1:0,o=d?this.extraUniforms.lut3d1:this.extraUniforms.lut2d1,this._updateLUTMap(this.lutMap1,o,this.extraUniforms.lutSize1,d),this.extraDefines.USE_LUT1=this.lutMap1?1:0,o=d?this.extraUniforms.lut3d2:this.extraUniforms.lut2d2,this._updateLUTMap(this.lutMap2,o,this.extraUniforms.lutSize2,d),this.extraDefines.USE_LUT2=this.lutMap2?1:0,this.extraUniforms.intensity.value=this.intensity,this.extraDefines.LUT_BACKGROUND=this.lutBackground?1:0,this.extraDefines.USE_3DTEXTURE=d,this._setDirty()}_updateLUTMap(d,o,l,c){if(d){let u=1;c==1?(o.value=d.texture3D,u=d.texture3D.image.width):d.texture&&(o.value=d.texture,u=d.texture.image.width),o.value.needsUpdate=!0,l.value=u}}shaderExtender(d,o,l){this.enabled&&(d.fragmentShader=shaderReplaceString(d.fragmentShader,"#glMarker",` 
            #if USE_LUT == 1
                bool isBackground = getDepth(vUv)>0.9999;
                #if LUT_BACKGROUND == 1
                    gl_FragColor = colorLookUp(gl_FragColor);
                #else
                    gl_FragColor = isBackground ? gl_FragColor : colorLookUp(gl_FragColor);
                #endif
            #endif
            #glMarker
        `))}computeCacheKey(d){return this.enabled?"1":"0"}isCompatible(d){return!0}_setDirty(){var d;(d=this.__setDirty)===null||d===void 0||d.call(this),this._combinedPostPlugin&&(this._combinedPostPlugin.pass.dirty=!0)}setDirty(){this._setDirty()}};function addLUTData(d){const o=d==null?void 0:d.userData;if(!o)return!1;o[LUTPlugin.PluginType]||(o[LUTPlugin.PluginType]={});const l=o[LUTPlugin.PluginType];return l.enable=!0,l.index===void 0&&(l.index=0),d.isMaterial&&(d.needsUpdate=!0),!0}LUTPlugin_decorate([serialize(),x(LUTExtension.prototype._updateParams),uiToggle("Enable")],LUTExtension.prototype,"enabled",void 0),LUTPlugin_decorate([serialize(),x(LUTExtension.prototype._updateParams),uiToggle("LUT Background")],LUTExtension.prototype,"lutBackground",void 0),LUTPlugin_decorate([serialize(),x(LUTExtension.prototype._updateParams),uiSlider("Intensity")],LUTExtension.prototype,"intensity",void 0),LUTPlugin_decorate([x(LUTExtension.prototype._updateParams),uiImage("LUT"),serialize()],LUTExtension.prototype,"lutMap",void 0),LUTPlugin_decorate([x(LUTExtension.prototype._updateParams),uiImage("LUT1"),serialize()],LUTExtension.prototype,"lutMap1",void 0),LUTPlugin_decorate([x(LUTExtension.prototype._updateParams),uiImage("LUT2"),serialize()],LUTExtension.prototype,"lutMap2",void 0),LUTExtension=LUTPlugin_decorate([uiFolder("LUT")],LUTExtension);class LUTPlugin extends GenericExtensionPlugin{_getUiConfig(o){var l,c;const u={type:"folder",label:"LUT",children:[{type:"checkbox",label:"Enabled",get value(){var h,_;return(_=(h=o.materialObject.userData[LUTPlugin.PluginType])===null||h===void 0?void 0:h.enable)===null||_===void 0||_},set value(h){var _;const A=o.materialObject.userData[LUTPlugin.PluginType];h!==(A==null?void 0:A.enable)&&(A||addLUTData(o.materialObject),o.materialObject.userData[LUTPlugin.PluginType].enable=h,(_=u.uiRefresh)===null||_===void 0||_.call(u,"postFrame",!0))},onChange:(l=this._extension)===null||l===void 0?void 0:l.setDirty},{type:"dropdown",children:[["LUT 0",0],["LUT 1",1],["LUT 2",2]].map(h=>({label:h[0],value:h[1]})),label:"index",hidden:()=>{const h=o.materialObject.userData[LUTPlugin.PluginType];return!!h&&!h.enable},get value(){var h,_;return(_=(h=o.materialObject.userData[LUTPlugin.PluginType])===null||h===void 0?void 0:h.index)!==null&&_!==void 0?_:0},set value(h){var _;o.materialObject.userData[LUTPlugin.PluginType]||addLUTData(o.materialObject),o.materialObject.userData[LUTPlugin.PluginType].index=h,(_=u.uiRefresh)===null||_===void 0||_.call(u,"postFrame",!0)},onChange:(c=this._extension)===null||c===void 0?void 0:c.setDirty}]};return u}constructor(){super(),this.materialExtension={uuid:esm_browser_v4(),getUiConfig:o=>{if(o.__uiConfigs||(o.__uiConfigs={}),o.__uiConfigs[this.materialExtension.uuid])return o.__uiConfigs[this.materialExtension.uuid];const l=this._getUiConfig(o);return o.__uiConfigs[this.materialExtension.uuid]=l,l},computeCacheKey:o=>{var l;return(this.enabled?"1":"0")+(!((l=o.materialObject.userData[LUTPlugin.PluginType])===null||l===void 0)&&l.enable?"1":"0")},isCompatible:o=>!0},this.updateGBuffer=this.updateGBuffer.bind(this)}async onAdded(o){var l,c;await super.onAdded(o),(l=o.getPlugin(GBufferPlugin))===null||l===void 0||l.registerGBufferUpdater(this.updateGBuffer);const u=o.getPlugin(AssetManagerPlugin);(c=u==null?void 0:u.materials)===null||c===void 0||c.registerMaterialExtension(this.materialExtension)}generateExtension(o){return new LUTExtension(o)}updateGBuffer(o,l){var c,u;if(o instanceof three_module.eaF&&(!((c=o.material)===null||c===void 0)&&c.userData)){const h=(u=o.material)===null||u===void 0?void 0:u.userData[LUTPlugin.PluginType];if(h){const _=h.enable===!1?0:1;l.w=updateBit(l.w,0,_);for(let w=0;w<3;w++)l.y=clearBit(l.y,w);let A=h.enable?h.index:0;A=Math.min(A,7),l.y=l.y|A}else l.w=updateBit(l.w,0,1)}}}LUTPlugin.PluginType="LUTPlugin1";class GyroInputDevice{constructor(o){this._zee=new three_module.Pq0(0,0,1),this._euler=new three_module.O9p,this._q0=new three_module.PTz,this._q1=new three_module.PTz(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._q2=new three_module.PTz,this._initQuaternionDest=new three_module.PTz,this.onScreenOrientationChangeEvent=()=>{this.screenOrientation=screen.orientation},this.onDeviceOrientationChangeEvent=l=>{this.deviceOrientation=l},this._isConnected=!1,this._viewer=o}getOffsetFromCenter(o=!0){if(!this.deviceOrientation)return new three_module.I9Y;this.getQuaternion(o,this._q2);const l=new three_module.Pq0(0,0,1);return l.applyQuaternion(this._q2),new three_module.I9Y(l.x,l.y)}getQuaternion(o,l){if(l||(l=new three_module.PTz),!this.deviceOrientation)return l.identity();const c=this.deviceOrientation,u=c.alpha!==null?three_module.cj9.degToRad(c.alpha):0,h=c.beta!==null?three_module.cj9.degToRad(c.beta):0,_=c.gamma!==null?three_module.cj9.degToRad(c.gamma):0,A=this.screenOrientation?three_module.cj9.degToRad(this.screenOrientation.angle):0;return this._toQuaternion(l,u,h,_,A,o),l}_toQuaternion(o,l,c,u,h,_){this._euler.set(c,l,-u,"YXZ"),o.setFromEuler(this._euler),o.multiply(this._q1);const A=document.getElementById("debug");return A&&(A.textContent=h+""),o.multiply(this._q0.setFromAxisAngle(this._zee,-h)),this._initQuaternionDest.__init||(this._initQuaternionDest.copy(o).invert(),this._initQuaternionDest.__init=!0),_&&o.premultiply(this._initQuaternionDest),o}static IsCompatible(){return window.DeviceOrientationEvent!==void 0&&"ontouchstart"in window}addPermissionMessage(){this.permissionMessage=document.createElement("div"),this.permissionMessage.innerHTML="Tap on the screen to allow gyroscope",this.permissionMessage.style.visibility="visible",this.permissionMessage.style.width="100%",this.permissionMessage.style.height="40px",this.permissionMessage.style.color="black",this.permissionMessage.style.position="absolute",this.permissionMessage.style.textAlign="center",this.permissionMessage.style.fontSize="12px",this.permissionMessage.style.bottom="20%",this._viewer.container.appendChild(this.permissionMessage)}connect(){var o;if(!this._isConnected)return this._isConnected=!0,this.onScreenOrientationChangeEvent(),!!window.DeviceOrientationEvent&&(this.askPermission(),(o=this._viewer)===null||o===void 0||o.renderer.rendererObject.domElement.addEventListener("click",this.askPermission.bind(this)),window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),!0)}askPermission(){this.onScreenOrientationChangeEvent(),typeof DeviceMotionEvent.requestPermission=="function"&&(this.addPermissionMessage(),DeviceOrientationEvent.requestPermission().then(o=>{o=="granted"&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this._viewer.container.removeChild(this.permissionMessage))}).catch(o=>{console.error("DeviceOrientationControls2: Unable to use DeviceOrientation API:",o)}))}disconnect(){this._isConnected&&(this._isConnected=!1,window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this._initQuaternionDest=new three_module.PTz)}}class MouseInputDevice{constructor(){this._mousePos=new three_module.I9Y(0,0),this._isConnected=!1}getOffsetFromCenter(){return new three_module.I9Y(this._mousePos.x/window.innerWidth*2-1,-(this._mousePos.y/window.innerHeight*2-1))}connect(){this._isConnected||(this._isConnected=!0,window.addEventListener("mousemove",this._onMouseMove.bind(this)))}disconnect(){this._isConnected&&(this._isConnected=!1,window.removeEventListener("mousemove",this._onMouseMove.bind(this)))}_onMouseMove(o){this._mousePos.set(o.clientX,o.clientY)}}var ParallaxCameraControllerPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},ParallaxCameraControllerPlugin_1;let ParallaxCameraControllerPlugin=ParallaxCameraControllerPlugin_1=class extends AViewerPlugin{constructor(){super(),this.enabled=!1,this.enableEdit=!1,this.invert=!1,this.sensitivity=.5,this.focalPointHit=new three_module.Pq0(0,0,0),this.damping=.5,this.cameraView="",this._target=new three_module.Pq0,this._center=new three_module.Pq0,this._pointerDown=!1,this._focalDistance=100,this._updateProjectionMatrix=()=>{var d,o;if(!this.enabled)return void((o=(d=this._object)._updateProjectionMatrixParallax)===null||o===void 0||o.call(d));const l=this._object,c=l.near;let u=c*Math.tan(.5*three_module.cj9.DEG2RAD*l.fov)/l.zoom,h=2*u,_=l.aspect*h,A=-.5*_;if(l.view!==null&&l.view.enabled){const C=l.view.fullWidth,M=l.view.fullHeight;A+=l.view.offsetX*_/C,u-=l.view.offsetY*h/M,_*=l.view.width/C,h*=l.view.height/M}A-=this._offX*c/this._focalDistance,u-=this._offY*c/this._focalDistance;const w=l.filmOffset;w!==0&&(A+=c*w/l.getFilmWidth()),l.projectionMatrix.makePerspective(A,A+_,u,u-h,c,l.far),l.projectionMatrixInverse.copy(l.projectionMatrix).invert()},this._preFrame=d=>{this.update(d.deltaTime)},this._offX=0,this._offY=0,this._xDamper=new k,this._yDamper=new k,this._onEnabledChange=this._onEnabledChange.bind(this),this._onDampingChange=this._onDampingChange.bind(this),this._onObjectHit=this._onObjectHit.bind(this),this._onActiveCameraChange=this._onActiveCameraChange.bind(this)}async onAdded(d){var o,l,c;await super.onAdded(d),GyroInputDevice.IsCompatible()?this._input=new GyroInputDevice(d):this._input=new MouseInputDevice,d.scene.addEventListener("activeCameraChange",this._onActiveCameraChange),this.addIndicator(),d.addEventListener("preFrame",this._preFrame),(o=this._viewer)===null||o===void 0||o.container.addEventListener("pointerdown",this.onPointerDown.bind(this)),(l=this._viewer)===null||l===void 0||l.container.addEventListener("pointerup",this.onPointerUp.bind(this)),(c=d.getPluginByType("Picking"))===null||c===void 0||c.addEventListener("hitObject",this._onObjectHit),this._onEnabledChange()}_onActiveCameraChange(){var d,o,l,c;this._object&&(!((d=this._object)===null||d===void 0)&&d._updateProjectionMatrixParallax)&&(this._object.updateProjectionMatrix=this._object._updateProjectionMatrixParallax,delete this._object._updateProjectionMatrixParallax),this._focalDistance=.01,this._object=(o=this._viewer)===null||o===void 0?void 0:o.scene.activeCamera.cameraObject,!((l=this._object)===null||l===void 0)&&l.isOrthographicCamera?(c=this._viewer)===null||c===void 0||c.console.warn("ParallaxCameraControllerPlugin: Orthographic camera is not supported"):this.enabled&&(this._object._updateProjectionMatrixParallax=this._object.updateProjectionMatrix,this._object.updateProjectionMatrix=this._updateProjectionMatrix)}addIndicator(){var d;this._viewer&&(this._indicator&&this._indicator.remove(),this._indicator=document.createElement("div"),this._indicator.style.width="40px",this._indicator.style.height="40px",this._indicator.style.borderRadius="100%",this._indicator.style.border="4px solid #ff4444",this._indicator.style.transform="translate(-50%, -50%)",this._indicator.style.position="absolute",this._indicator.style.top="0",this._indicator.style.left="0",this._indicator.style.zIndex="10000",this._indicator.style.opacity="0",this._indicator.style.transition="opacity 0.5s",this._indicator.style.pointerEvents="none",(d=this._viewer)===null||d===void 0||d.container.appendChild(this._indicator))}onPointerDown(d){this.enabled&&this._viewer&&(this._pointerDown=!0,this.enableEdit&&this._indicator&&(this._indicator.style.top=d.clientY-this._viewer.container.offsetTop+"px",this._indicator.style.left=d.clientX-this._viewer.container.offsetLeft+"px"))}onPointerUp(){this._pointerDown=!1}update(d){if(!this.enabled||this._pointerDown||!this._input||!this._object||!this._viewer)return;this._viewer.scene.activeCamera.setInteractions(!1,ParallaxCameraControllerPlugin_1.PluginType),this._updateFocalDistance();const o=this._object.matrixWorld.elements,l=new three_module.Pq0(o[0],o[1],o[2]),c=new three_module.Pq0(o[4],o[5],o[6]);this._object.position.copy(this._center),this._viewer.scene.activeCamera.positionUpdated();let u=this.sensitivity;this.invert&&(u*=-1),this._offX=this._xDamper.update(this._offX,this._input.getOffsetFromCenter().x*u,d,1),this._offY=this._yDamper.update(this._offY,this._input.getOffsetFromCenter().y*u,d,1);const h=this._object;h.position.add(c.multiplyScalar(this._offY)).add(l.multiplyScalar(this._offX)),h.updateProjectionMatrix(),h.updateMatrixWorld(),this._dirty=!0}_onObjectHit(d){var o,l;d.intersects.intersect&&this.enableEdit&&(this.focalPointHit.copy(d.intersects.intersect.point),d.intersects.selectedObject=null,(l=(o=this.uiConfig)===null||o===void 0?void 0:o.uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0),this._indicator&&(this._indicator.style.display="block",this._indicator.style.opacity="1",setTimeout(()=>{var c,u;this._indicator.style.opacity="0",setTimeout(()=>this._indicator.style.display="none",600),(u=(c=this.uiConfig)===null||c===void 0?void 0:c.uiRefresh)===null||u===void 0||u.call(c,"postFrame",!0)},200)))}_updateFocalDistance(){if(!this._object)return;const d=this._object,o=new three_module.Pq0;d.getWorldDirection(o),o.normalize(),this._focalDistance=this.focalPointHit.clone().sub(d.position).dot(o)}_onEnabledChange(){var d,o,l;if(this._viewer){if(this.enabled){if((d=this._input)===null||d===void 0||d.connect(),this._onActiveCameraChange(),!this._object)return;this._viewer.scene.activeCamera.setInteractions(!1,ParallaxCameraControllerPlugin_1.PluginType);const c=this._viewer.getPluginByType("CameraViews"),u=c==null?void 0:c.camViews.find(h=>h.name===this.cameraView);c&&u&&c.setCurrentCameraView(u),this._updateFocalDistance(),this._center.copy(this._object.position),this._object.lookAt(this._viewer.scene.activeCamera.target)}else if(this._object){this._onActiveCameraChange(),this._viewer.scene.activeCamera.setInteractions(!0,ParallaxCameraControllerPlugin_1.PluginType),this._object.position.copy(this._center),this._object.lookAt(this._viewer.scene.activeCamera.target);const c=this._object;c.updateProjectionMatrix(),c.updateMatrixWorld()}(l=(o=this.uiConfig)===null||o===void 0?void 0:o.uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0)}}_onDampingChange(){this._xDamper&&this._yDamper&&(this._xDamper.setDecayTime(100*this.damping),this._yDamper.setDecayTime(100*this.damping))}dispose(){var d;(d=this._input)===null||d===void 0||d.disconnect()}};ParallaxCameraControllerPlugin.PluginType="ParallaxCameraControllerPlugin",ParallaxCameraControllerPlugin_decorate([x(ParallaxCameraControllerPlugin.prototype._onEnabledChange),serialize(),uiToggle("Enabled")],ParallaxCameraControllerPlugin.prototype,"enabled",void 0),ParallaxCameraControllerPlugin_decorate([serialize(),uiToggle("enableEdit")],ParallaxCameraControllerPlugin.prototype,"enableEdit",void 0),ParallaxCameraControllerPlugin_decorate([serialize(),uiToggle("Invert")],ParallaxCameraControllerPlugin.prototype,"invert",void 0),ParallaxCameraControllerPlugin_decorate([serialize(),uiSlider("Sensitivity",[.1,2],.01)],ParallaxCameraControllerPlugin.prototype,"sensitivity",void 0),ParallaxCameraControllerPlugin_decorate([serialize("focalPoint"),uiVector("Focal Point Hit",void 0,.001)],ParallaxCameraControllerPlugin.prototype,"focalPointHit",void 0),ParallaxCameraControllerPlugin_decorate([x(ParallaxCameraControllerPlugin.prototype._onDampingChange),serialize(),uiSlider("Damping",[0,1],.001)],ParallaxCameraControllerPlugin.prototype,"damping",void 0),ParallaxCameraControllerPlugin_decorate([serialize(),uiInput("Camera View")],ParallaxCameraControllerPlugin.prototype,"cameraView",void 0),ParallaxCameraControllerPlugin=ParallaxCameraControllerPlugin_1=ParallaxCameraControllerPlugin_decorate([uiFolder("Parallax Camera Controller")],ParallaxCameraControllerPlugin);var voronoi=`#ifndef VORONOI_HELPER
#define VORONOI_HELPER 
float voronoi_distance(vec2 a,vec2 b,float metric){return distance(a,b);}float voronoi_f1_2d(in vec2 coord,in float randomness,in float flakeClamp,in float flakeRadius,inout vec3 outColor){vec2 cellPosition=floor(coord);vec2 localPosition=coord-cellPosition;float minDistance=8.;vec2 targetOffset,targetPosition;for(int j=-1;j<=1;j++){for(int i=-1;i<=1;i++){vec2 cellOffset=vec2(i,j);vec2 pointPosition=cellOffset+hash3(cellPosition+cellOffset).xy*randomness;float distanceToPoint=voronoi_distance(pointPosition,localPosition,1.);if(distanceToPoint<minDistance){targetOffset=cellOffset;minDistance=distanceToPoint;targetPosition=pointPosition;}}}float outDistance=minDistance;float dist=step(flakeRadius,outDistance);outColor=hash3(cellPosition+hash3(cellPosition+targetOffset).xy*randomness+targetOffset);vec3 outColor1=minDistance<flakeRadius?outColor:vec3(0.5,0.5,1.);outDistance=mix(dist,minDistance,flakeClamp);outColor=mix(outColor1,outColor,flakeClamp);return outDistance;}
#endif
`,noiseBumpMatPars="uniform vec2 noiseBumpParams;uniform float noiseBumpScale;uniform float noiseBumpFlakeScale;uniform float noiseFlakeClamp;uniform float noiseFlakeRadius;uniform bool useColorFlakes;uniform vec4 flakeParams;uniform vec3 flakeFallOffParams;vec3 perturbNormalArb_nb(vec3 surf_pos,vec3 surf_norm,vec2 dHdxy,float faceDirection){vec3 vSigmaX=dFdx(surf_pos.xyz);vec3 vSigmaY=dFdy(surf_pos.xyz);vec3 vN=surf_norm;vec3 R1=cross(vSigmaY,vN);vec3 R2=cross(vN,vSigmaX);float fDet=dot(vSigmaX,R1)*faceDirection;vec3 vGrad=sign(fDet)*(dHdxy.x*R1+dHdxy.y*R2);return normalize(abs(fDet)*surf_norm-vGrad);}",noiseBumpMat=`vec3 outColor,outColor1,outColor2,outColor3,outColor4,outColor5;float distFac=length(vViewPosition.xyz);float level=1.;vec2 uvMod=noiseBumpFlakeScale*noiseBumpParams.xy*vUv*level;float voronoiDist=clamp(voronoi_f1_2d(uvMod,1.,noiseFlakeClamp,noiseFlakeRadius,outColor),0.,1.);vec3 oldNormal=normal;normal=perturbNormalArb_nb(-vViewPosition,normal,(2.*outColor.xy-1.)*noiseBumpScale,faceDirection);float oldRoughnessFactor=roughnessFactor;float oldMetalnessFactor=metalnessFactor;roughnessFactor=mix(roughnessFactor,flakeParams.x,1.-voronoiDist);metalnessFactor=mix(metalnessFactor,flakeParams.y,1.-voronoiDist);
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
vec3 sparkleRadiance=getIBLRadiance(normalize(vViewPosition),normal,roughnessFactor);float sparkleIntensity=length(sparkleRadiance);float sparkleIntensityMultiplier=sparkleIntensity>1.3?flakeParams.z:1.;vec3 oldDiffuseColor=diffuseColor.rgb;vec2 cellPosition_=floor(uvMod);vec3 colorRGB=useColorFlakes?hash3(cellPosition_):vec3(1.);float fallOff_=mix(1.,1./(1.+flakeFallOffParams.y*distFac+flakeFallOffParams.z*distFac*distFac),flakeFallOffParams.x);diffuseColor.rgb*=mix(vec3(1.),sparkleIntensityMultiplier*colorRGB*fallOff_,vec3(1.-voronoiDist));if(sparkleIntensity<flakeParams.w){float mixFactor=1.;roughnessFactor=mix(roughnessFactor,oldRoughnessFactor,mixFactor);metalnessFactor=mix(metalnessFactor,oldMetalnessFactor,mixFactor);normal=normalize(mix(normal,oldNormal,mixFactor));diffuseColor.rgb=mix(diffuseColor.rgb,oldDiffuseColor,mixFactor);}
#endif
`,NoiseBumpMaterialPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let NoiseBumpMaterialPlugin=class extends AViewerPlugin{addNoiseBumpMaterial(d){return addNoiseBumpMaterial(d.materialObject)}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFMaterialsNoiseBumpMaterialExtensionImport(o))}constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin],this._uniforms={noiseBumpParams:{value:new three_module.I9Y},noiseBumpScale:{value:.05},noiseBumpFlakeScale:{value:1e3},noiseFlakeClamp:{value:1},noiseFlakeRadius:{value:.5},flakeParams:{value:new three_module.IUQ(0,1,3,0)},flakeFallOffParams:{value:new three_module.Pq0(0,1,0)},useColorFlakes:{value:!1}},this.materialExtension={parsFragmentSnippet:(d,o)=>{var l;return this.enabled&&(!((l=o==null?void 0:o.materialObject.userData._noiseBumpMat)===null||l===void 0)&&l.hasBump)?randomHelpers+`
`+voronoi+`
`+noiseBumpMatPars+`
`:""},shaderExtender:(d,o,l)=>{var c;if(!this.enabled||!(!((c=o.materialObject.userData._noiseBumpMat)===null||c===void 0)&&c.hasBump))return;const u="#glMarker beforeAccumulation",h=noiseBumpMat;d.fragmentShader=d.fragmentShader.replace(u,h+`
`+u),d.defines.USE_UV="",d.extensionDerivatives=!0},onObjectRender:(d,o)=>{var l;const c=(l=o.materialObject.userData)===null||l===void 0?void 0:l._noiseBumpMat;if(!(c!=null&&c.hasBump))return;this._uniforms.noiseBumpParams.value.fromArray(c.bumpNoiseParams),this._uniforms.noiseBumpScale.value=c.bumpScale,this._uniforms.noiseBumpFlakeScale.value=c.flakeScale,this._uniforms.noiseFlakeClamp.value=c.flakeClamp,this._uniforms.noiseFlakeRadius.value=c.flakeRadius,c.flakeParams&&this._uniforms.flakeParams.value.copy(c.flakeParams),c.flakeFallOffParams&&this._uniforms.flakeFallOffParams.value.copy(c.flakeFallOffParams),this._uniforms.useColorFlakes.value=c.useColorFlakes;const u=this.enabled?1:0;o.materialObject.defines.NOISE_BUMP_MATERIAL_ENABLED!==u&&(o.materialObject.defines.NOISE_BUMP_MATERIAL_ENABLED=u,o.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:d=>{var o,l;return(this.enabled?"1":"0")+(!((l=(o=d.materialObject.userData)===null||o===void 0?void 0:o._noiseBumpMat)===null||l===void 0)&&l.hasBump?"1":"0")},isCompatible:d=>d.isMeshStandardMaterial2,updaters:()=>[],getUiConfig:d=>{const o=this._viewer,l={type:"folder",label:"SparkleBump (NoiseBump)",children:[{type:"checkbox",label:"Enabled",get value(){var c;return((c=d.materialObject.userData._noiseBumpMat)===null||c===void 0?void 0:c.hasBump)||!1},set value(c){var u,h;c!==((u=d.materialObject.userData._noiseBumpMat)===null||u===void 0?void 0:u.hasBump)&&(c?addNoiseBumpMaterial(d.materialObject)||o.alert("Cannot add noise bump."):d.materialObject.userData._noiseBumpMat&&(d.materialObject.userData._noiseBumpMat.hasBump=!1,d.materialObject.needsUpdate=!0),(h=l.uiRefresh)===null||h===void 0||h.call(l,"postFrame",!0))},onChange:this.setDirty},()=>({type:"vec4",label:"Bump Noise Params",bounds:[0,1],hidden:()=>{var c;return!(!((c=d.materialObject.userData._noiseBumpMat)===null||c===void 0)&&c.hasBump)},property:[d.materialObject.userData._noiseBumpMat,"bumpNoiseParams"],onChange:this.setDirty}),()=>({type:"slider",label:"Bump Scale",bounds:[0,.001],stepSize:1e-5,hidden:()=>{var c;return!(!((c=d.materialObject.userData._noiseBumpMat)===null||c===void 0)&&c.hasBump)},property:[d.materialObject.userData._noiseBumpMat,"bumpScale"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Scale",bounds:[100,1e4],stepSize:1e-4,hidden:()=>{var c;return!(!((c=d.materialObject.userData._noiseBumpMat)===null||c===void 0)&&c.hasBump)},property:[d.materialObject.userData._noiseBumpMat,"flakeScale"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Clamp",bounds:[0,1],stepSize:1,hidden:()=>{var c;return!(!((c=d.materialObject.userData._noiseBumpMat)===null||c===void 0)&&c.hasBump)},property:[d.materialObject.userData._noiseBumpMat,"flakeClamp"],onChange:this.setDirty}),()=>({type:"slider",label:"Flake Radius",bounds:[.01,1],stepSize:.001,hidden:()=>{var c;return!(!((c=d.materialObject.userData._noiseBumpMat)===null||c===void 0)&&c.hasBump)},property:[d.materialObject.userData._noiseBumpMat,"flakeRadius"],onChange:this.setDirty}),()=>{var c;return{type:"slider",label:"Flake Roughness",bounds:[0,1],stepSize:.01,hidden:()=>{var u;return!(!((u=d.materialObject.userData._noiseBumpMat)===null||u===void 0)&&u.hasBump)},property:[(c=d.materialObject.userData._noiseBumpMat)===null||c===void 0?void 0:c.flakeParams,"x"],onChange:this.setDirty}},()=>{var c;return{type:"slider",label:"Flake Metalness",bounds:[0,1],stepSize:.01,hidden:()=>{var u;return!(!((u=d.materialObject.userData._noiseBumpMat)===null||u===void 0)&&u.hasBump)},property:[(c=d.materialObject.userData._noiseBumpMat)===null||c===void 0?void 0:c.flakeParams,"y"],onChange:this.setDirty}},()=>{var c;return{type:"slider",label:"Flake Strength",bounds:[0,100],stepSize:.001,hidden:()=>{var u;return!(!((u=d.materialObject.userData._noiseBumpMat)===null||u===void 0)&&u.hasBump)},property:[(c=d.materialObject.userData._noiseBumpMat)===null||c===void 0?void 0:c.flakeParams,"z"],onChange:this.setDirty}},()=>{var c;return{type:"slider",label:"Flake Threshold",bounds:[.1,10],stepSize:.001,hidden:()=>{var u;return!(!((u=d.materialObject.userData._noiseBumpMat)===null||u===void 0)&&u.hasBump)},property:[(c=d.materialObject.userData._noiseBumpMat)===null||c===void 0?void 0:c.flakeParams,"w"],onChange:this.setDirty}},()=>{var c;return{type:"slider",label:"Falloff",stepSize:1,bounds:[0,1],hidden:()=>{var u;return!(!((u=d.materialObject.userData._noiseBumpMat)===null||u===void 0)&&u.hasBump)},property:[(c=d.materialObject.userData._noiseBumpMat)===null||c===void 0?void 0:c.flakeFallOffParams,"x"],onChange:this.setDirty}},()=>{var c;return{type:"slider",label:"Linear falloff factor",bounds:[0,10],stepSize:.001,hidden:()=>{var u;return!(!((u=d.materialObject.userData._noiseBumpMat)===null||u===void 0)&&u.hasBump)},property:[(c=d.materialObject.userData._noiseBumpMat)===null||c===void 0?void 0:c.flakeFallOffParams,"y"],onChange:this.setDirty}},()=>{var c;return{type:"slider",label:"Quadratic falloff factor",bounds:[0,10],stepSize:.001,hidden:()=>{var u;return!(!((u=d.materialObject.userData._noiseBumpMat)===null||u===void 0)&&u.hasBump)},property:[(c=d.materialObject.userData._noiseBumpMat)===null||c===void 0?void 0:c.flakeFallOffParams,"z"],onChange:this.setDirty}},()=>({type:"checkbox",label:"Colored Flakes",hidden:()=>{var c;return!(!((c=d.materialObject.userData._noiseBumpMat)===null||c===void 0)&&c.hasBump)},property:[d.materialObject.userData._noiseBumpMat,"useColorFlakes"],onChange:this.setDirty})]};return l}},this.setDirty=()=>{var d,o,l;(o=(d=this.materialExtension).setDirty)===null||o===void 0||o.call(d),(l=this._viewer)===null||l===void 0||l.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(d){var o,l,c,u,h;await super.onAdded(d);const _=d.getPlugin(AssetManagerPlugin);(o=_==null?void 0:_.materials)===null||o===void 0||o.registerMaterialExtension(this.materialExtension),(l=_==null?void 0:_.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=_==null?void 0:_.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(glTFMaterialsNoiseBumpMaterialExtensionExport)}async onRemove(d){var o,l,c,u;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(d)}};function addNoiseBumpMaterial(d){const o=d==null?void 0:d.userData;if(!o)return!1;o._noiseBumpMat||(o._noiseBumpMat={});const l=o._noiseBumpMat;return l.hasBump=!0,l.bumpNoiseParams===void 0&&(l.bumpNoiseParams=[.5,.5]),l.bumpScale===void 0&&(l.bumpScale=.05),l.flakeScale===void 0&&(l.flakeScale=.05),l.flakeClamp===void 0&&(l.flakeClamp=1),l.flakeRadius===void 0&&(l.flakeRadius=.3),l.useColorFlakes===void 0&&(l.useColorFlakes=!1),l.flakeParams===void 0&&(l.flakeParams=new three_module.IUQ(0,1,3,0)),l.flakeFallOffParams===void 0&&(l.flakeFallOffParams=new three_module.Pq0(0,1,0)),d.isMaterial&&(d.needsUpdate=!0),!0}NoiseBumpMaterialPlugin.PluginType="NoiseBumpMaterialPlugin",NoiseBumpMaterialPlugin.NOISE_BUMP_MATERIAL_GLTF_EXTENSION="WEBGI_materials_noise_bump",NoiseBumpMaterialPlugin_decorate([uiToggle("Enabled",d=>({onChange:d.setDirty})),serialize()],NoiseBumpMaterialPlugin.prototype,"enabled",void 0),NoiseBumpMaterialPlugin=NoiseBumpMaterialPlugin_decorate([uiFolder("NoiseBump Materials")],NoiseBumpMaterialPlugin);class GLTFMaterialsNoiseBumpMaterialExtensionImport{constructor(o){this.parser=o,this.name=NoiseBumpMaterialPlugin.NOISE_BUMP_MATERIAL_GLTF_EXTENSION}async extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name];return l.userData||(l.userData={}),addNoiseBumpMaterial(l),l.userData._noiseBumpMat=deserializeObject(u,l.userData._noiseBumpMat,!1,{}),Promise.resolve()}}const glTFMaterialsNoiseBumpMaterialExtensionExport=d=>({writeMaterial:(o,l)=>{if(!o.isMeshStandardMaterial||!o.userData._noiseBumpMat||!o.userData._noiseBumpMat.hasBump)return;l.extensions=l.extensions||{};const c=serializeObject(o.userData._noiseBumpMat,!1);l.extensions[NoiseBumpMaterialPlugin.NOISE_BUMP_MATERIAL_GLTF_EXTENSION]=c,d.extensionsUsed[NoiseBumpMaterialPlugin.NOISE_BUMP_MATERIAL_GLTF_EXTENSION]=!0}});var taa=`#include <common>
varying vec2 vUv;uniform vec2 previousRTSize;uniform mat4 lastProjectionViewMatrix;uniform mat4 currentProjectionViewMatrix;uniform mat4 inverseViewMatrix;uniform vec2 jitterSample;uniform vec2 feedBack;uniform bool firstFrame;
#if HAS_VELOCITY_BUFFER == 1
uniform sampler2D tVelocity;
#endif
vec3 find_closest_fragment_3x3(const in vec2 uv){const vec3 offset=vec3(-1.,1.,0.);vec2 texelSize=1./previousRTSize;vec3 dtr=vec3(1,1,getDepth(uv+offset.yy*texelSize));vec3 dtc=vec3(0,1,getDepth(uv+offset.zy*texelSize));vec3 dtl=vec3(-1,1,getDepth(uv+offset.xy*texelSize));vec3 dml=vec3(-1,0,getDepth(uv+offset.xz*texelSize));vec3 dmc=vec3(0,0,getDepth(uv));vec3 dmr=vec3(1,0,getDepth(uv+offset.yz*texelSize));vec3 dbl=vec3(-1,-1,getDepth(uv+offset.xx*texelSize));vec3 dbc=vec3(0,-1,getDepth(uv+offset.zx*texelSize));vec3 dbr=vec3(1,-1,getDepth(uv+offset.yx*texelSize));vec3 dmin=dtl;if(dmin.z>dtc.z)dmin=dtc;if(dmin.z>dtr.z)dmin=dtr;if(dmin.z>dml.z)dmin=dml;if(dmin.z>dmc.z)dmin=dmc;if(dmin.z>dmr.z)dmin=dmr;if(dmin.z>dbl.z)dmin=dbl;if(dmin.z>dbc.z)dmin=dbc;if(dmin.z>dbr.z)dmin=dbr;return vec3(uv+texelSize.xy*dmin.xy,dmin.z);}vec3 find_closest_fragment_5tap(const in vec2 uv){vec2 texelSize=1./previousRTSize;vec2 offset=vec2(1.,-1.);vec3 dtl=vec3(-1,1,getDepth(uv+offset.yx*texelSize));vec3 dtr=vec3(1,1,getDepth(uv+offset.xx*texelSize));vec3 dmc=vec3(0,0,getDepth(uv));vec3 dbl=vec3(-1,-1,getDepth(uv+offset.yy*texelSize));vec3 dbr=vec3(1,-1,getDepth(uv+offset.xy*texelSize));vec3 dmin=dtl;if(dmin.z>dtr.z)dmin=dtr;if(dmin.z>dmc.z)dmin=dmc;if(dmin.z>dbl.z)dmin=dbl;if(dmin.z>dbr.z)dmin=dbr;return vec3(uv+dmin.xy*texelSize,dmin.z);}vec4 clip_aabb(const in vec4 aabb_min,const in vec4 aabb_max,vec4 p){const float FLT_EPS=1e-8;vec4 p_clip=0.5*(aabb_max+aabb_min);vec4 e_clip=0.5*(aabb_max-aabb_min)+FLT_EPS;vec4 v_clip=p-p_clip;vec4 v_unit=abs(v_clip/e_clip);float ma_unit=max(v_unit.x,max(v_unit.y,v_unit.z));if(ma_unit>1.)return p_clip+v_clip/ma_unit;else return p;}
#if HAS_VELOCITY_BUFFER == 0
vec2 computeScreenSpaceVelocity(const in vec3 worldPosition){vec4 currentPositionClip=currentProjectionViewMatrix*vec4(worldPosition,1.);vec4 prevPositionClip=lastProjectionViewMatrix*vec4(worldPosition,1.);vec2 currentPositionNDC=currentPositionClip.xy/currentPositionClip.w;vec2 prevPositionNDC=prevPositionClip.xy/prevPositionClip.w;if(prevPositionNDC.x>=1.||prevPositionNDC.x<=-1.||prevPositionNDC.x>=1.||prevPositionNDC.y<=-1.){return vec2(0.);}return 0.5*(currentPositionNDC-prevPositionNDC);}
#endif
vec4 computeTAA(const in vec2 uv,const in vec2 screenSpaceVelocity,const in float feedbackScale){vec2 uvUnJitter=uv;vec4 currentColor=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter));vec4 previousColor=previousRTTexelToLinear(texture2D(previousRT,uv-screenSpaceVelocity));const vec3 offset=vec3(1.,-1.,0.);vec2 texelSize=1./previousRTSize;float texelSpeed=length(screenSpaceVelocity);vec4 tl=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.yx*texelSize));vec4 tc=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.zx*texelSize));vec4 tr=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.xx*texelSize));vec4 ml=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.yz*texelSize));vec4 mc=currentColor;vec4 mr=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.xz*texelSize));vec4 bl=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.yy*texelSize));vec4 bc=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.zy*texelSize));vec4 br=currentRTTexelToLinear(texture2D(currentRT,uvUnJitter+offset.xy*texelSize));vec4 corners=2.*(tr+bl+br+tl)-2.*mc;mc+=(mc-(corners*0.166667))*2.718282*0.3;mc=max(vec4(0.),mc);vec4 min5=min(tc,min(ml,min(mc,min(mr,bc))));vec4 max5=max(tc,max(ml,max(mc,max(mr,bc))));vec4 cmin=min(min5,min(tl,min(tr,min(bl,br))));vec4 cmax=max(min5,max(tl,max(tr,max(bl,br))));;cmin=0.5*(cmin+min5);cmax=0.5*(cmax+max5);previousColor=clip_aabb(cmin,cmax,previousColor);float lum0=luminance(currentColor.rgb);float lum1=luminance(previousColor.rgb);float unbiased_diff=abs(lum0-lum1)/max(lum0,max(lum1,0.2));float unbiased_weight=1.-unbiased_diff;float unbiased_weight_sqr=unbiased_weight*unbiased_weight;float k_feedback=mix(feedBack.x,feedBack.y,unbiased_weight_sqr);return mix(currentColor,previousColor,clamp(k_feedback*feedbackScale,0.,1.));}vec3 getWorldPositionFromViewZ(const in vec2 uv,const in float viewDepth){vec2 uv_=2.*uv-1.;float xe=-(uv_.x+projection[2][0])*viewDepth/projection[0][0];float ye=-(uv_.y+projection[2][1])*viewDepth/projection[1][1];return(inverseViewMatrix*vec4(xe,ye,viewDepth,1.)).xyz;}void main(){
#if HAS_VELOCITY_BUFFER == 0
#if QUALITY == 1
vec3 c_frag=find_closest_fragment_3x3(vUv);
#else
vec3 c_frag=find_closest_fragment_5tap(vUv);
#endif
#else
vec3 c_frag=vec3(vUv,0.);
#endif
bool bg=firstFrame;
#if BACKGROUND_TAA 
float d=c_frag.z;float edgef=min(1.,max(0.,1.-(d*100.-99.)));
#else
bg=bg||c_frag.z>0.999;
#endif
if(firstFrame){gl_FragColor=currentRTTexelToLinear(texture2D(currentRT,vUv));}else{
#if HAS_VELOCITY_BUFFER == 0
float sampleViewZ=mix(-cameraNearFar.x,-cameraNearFar.y,c_frag.z);vec3 worldPosition=getWorldPositionFromViewZ(c_frag.xy,sampleViewZ);vec2 screenSpaceVelocity=computeScreenSpaceVelocity(worldPosition);
#else
vec2 screenSpaceVelocity=texture2D(tVelocity,c_frag.xy).xy*2.-1.;screenSpaceVelocity=sign(screenSpaceVelocity)*pow(abs(screenSpaceVelocity),vec2(4.));
#endif
#if BACKGROUND_TAA
gl_FragColor=computeTAA(vUv,screenSpaceVelocity*edgef,edgef);
#else
gl_FragColor=computeTAA(vUv,screenSpaceVelocity,1.);
#endif
}
#include <colorspace_fragment>
#ifdef DEBUG_VELOCITY
float sampleViewZ=mix(-cameraNearFar.x,-cameraNearFar.y,c_frag.z);vec3 worldPosition=getWorldPositionFromViewZ(c_frag.xy,sampleViewZ);vec2 screenSpaceVelocity=computeScreenSpaceVelocity(worldPosition);gl_FragColor=vec4(10.*length(screenSpaceVelocity),0.,0.,1.);
#endif
}`,TAAPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class TAAPass extends ShaderPass2{constructor(o,l,c=!1){super({vertexShader:CopyShader.vertexShader,fragmentShader:l+`
`+cameraHelpers+`
`+taa,uniforms:{currentRT:{value:null},previousRT:{value:null},previousRTSize:{value:new three_module.I9Y},cameraNearFar:{value:new three_module.I9Y},lastProjectionViewMatrix:{value:new three_module.kn4},currentProjectionViewMatrix:{value:new three_module.kn4},projection:{value:new three_module.kn4},inverseViewMatrix:{value:new three_module.kn4},jitterSample:{value:new three_module.I9Y},firstFrame:{value:!0},tNormalDepth:{value:null},tVelocity:{value:null}},defines:{HAS_VELOCITY_BUFFER:0,QUALITY:1,UNJITTER:0,BACKGROUND_TAA:c?1:0}},"currentRT","previousRT"),this.taaEnabled=!0,this.feedBack=new three_module.I9Y(.88,.97),this.uiConfig={type:"folder",label:"Temporal AA",children:[{type:"checkbox",label:"Enabled",property:[this,"enabled"],onChange:()=>this.onSizeUpdate()},{type:"input",label:"Feedback",stepSize:1e-4,property:[this,"feedBack"],onChange:this.setDirty}]},this.onSizeUpdate=this.onSizeUpdate.bind(this),this.target=o,this.clear=!1,this.needsSwap=!0}render(o,l,c,u,h){var _,A;if(!this.taaEnabled||!this.enabled)return void(this.needsSwap=!1);this.needsSwap=!0;const w=this.uniforms.tVelocity.value?1:0;w!==this.material.defines.HAS_VELOCITY_BUFFER&&(this.material.defines.HAS_VELOCITY_BUFFER=w,this.material.needsUpdate=!0),this.uniforms.previousRT.value=(A=(_=Ee(this.target))===null||_===void 0?void 0:_.texture)!==null&&A!==void 0?A:null,super.render(o,l,c,u,h),this.uniforms.lastProjectionViewMatrix.value.copy(this.uniforms.currentProjectionViewMatrix.value),this.uniforms.firstFrame.value=!1}updateCameraProperties(o){o&&(this.uniforms.currentProjectionViewMatrix.value.multiplyMatrices(o.projectionMatrix,o.matrixWorldInverse),this.uniforms.inverseViewMatrix.value.copy(o.matrixWorld))}onSizeUpdate(){this.uniforms.firstFrame.value=!0,this.setDirty()}setSize(o,l){super.setSize(o,l),this.onSizeUpdate()}}TAAPass_decorate([serialize(),uniform()],TAAPass.prototype,"feedBack",void 0);class TemporalAAPlugin extends GenericFilterPlugin{constructor(){super(...arguments),this.passId="taa",this._beforeFilters=["progressive"],this._afterFilters=[],this._requiredFilters=["render","progressive"],this.dependencies=[GBufferPlugin],this._stableNoise=!0,this._stableNoiseConfig={label:"Stable Noise (Use Total Frame Count)",type:"checkbox",property:[this,"stableNoise"]}}passCtor(o){if(!o.getPlugin(ProgressivePlugin))throw"Add ProgressivePlugin before TAA";const l=o.isAntialiased,c=new TAAPass(()=>{var u;return(u=o.getPlugin(ProgressivePlugin))===null||u===void 0?void 0:u.lastFrame},o.getPlugin(GBufferPlugin).getUnpackSnippet(),l);return o.renderer.addEventListener("resize",c.onSizeUpdate),c}setDirty(){var o;(o=this._viewer)===null||o===void 0||o.setDirty()}async onDispose(o){return this.pass&&o.renderer.removeEventListener("resize",this.pass.passObject.onSizeUpdate),super.onDispose(o)}_update(o){if(!super._update(o))return!1;const l=o.renderer.frameCount,c=this._pass.passObject;if(c.taaEnabled=l<=1&&o.scene.renderCamera===o.scene.activeCamera,!c.taaEnabled)return!1;const u=o.scene.renderCamera;return c.updateShaderProperties([o.getPlugin(GBufferPlugin),u,o.getPluginByType("VelocityBuffer")]),c.target=o.getPlugin(ProgressivePlugin).lastFrame,c.updateCameraProperties(u==null?void 0:u.cameraObject),!0}async onAdded(o){await super.onAdded(o),this.stableNoise=this._stableNoise}get stableNoise(){var o,l;return(l=(o=this._viewer)===null||o===void 0?void 0:o.renderer.stableNoise)!==null&&l!==void 0?l:this._stableNoise}set stableNoise(o){this._viewer&&(this._viewer.renderer.stableNoise=o),this._stableNoise=o}get uiConfig(){var o;const l=(o=this.pass)===null||o===void 0?void 0:o.passObject.uiConfig;if(l&&l.children)return l.children.includes(this._stableNoiseConfig)||l.children.push(this._stableNoiseConfig),l}}TemporalAAPlugin.PluginType="TAA";var FullScreenPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let FullScreenPlugin=class extends AViewerPlugin{constructor(){super(),this.toJSON=void 0,this.enabled=!0,this._lastSize=["100%","100%"],this._lastFsElement=null,this._fsChangeHandler=d=>{var o;if(this.isFullScreen())this.dispatchEvent({type:"enter"});else{const l=this._lastFsElement||((o=this._viewer)===null||o===void 0?void 0:o.canvas);l&&(l.style.width=this._lastSize[0],l.style.height=this._lastSize[1]),document.removeEventListener("webkitfullscreenchange",this._fsChangeHandler,!1),document.removeEventListener("mozfullscreenchange",this._fsChangeHandler,!1),document.removeEventListener("fullscreenchange",this._fsChangeHandler,!1),document.removeEventListener("MSFullscreenChange",this._fsChangeHandler,!1),this.dispatchEvent({type:"exit"})}},this.enter=this.enter.bind(this),this.exit=this.exit.bind(this)}async enter(d){var o;if(this.isFullScreen())return;const l=d||((o=this._viewer)===null||o===void 0?void 0:o.canvas);return l?(this._lastFsElement=l,document.addEventListener&&(document.addEventListener("webkitfullscreenchange",this._fsChangeHandler,!1),document.addEventListener("mozfullscreenchange",this._fsChangeHandler,!1),document.addEventListener("fullscreenchange",this._fsChangeHandler,!1),document.addEventListener("MSFullscreenChange",this._fsChangeHandler,!1)),this._lastSize=[l.style.width,l.style.height],l.style.width="100%",l.style.height="100%",l.requestFullscreen?l.requestFullscreen():l.mozRequestFullScreen?l.mozRequestFullScreen():l.webkitRequestFullscreen?l.webkitRequestFullscreen():l.msRequestFullscreen?l.msRequestFullscreen():void 0):void 0}async exit(){return document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen?document.msExitFullscreen():void 0}async toggle(d){return this.isFullScreen()?this.exit():this.enter(d)}isFullScreen(){return document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement!==void 0}};FullScreenPlugin.PluginType="FullScreenPlugin",FullScreenPlugin_decorate([uiButton("Enter FullScreen")],FullScreenPlugin.prototype,"enter",null),FullScreenPlugin_decorate([uiButton("Exit FullScreen")],FullScreenPlugin.prototype,"exit",null),FullScreenPlugin_decorate([uiButton("Toggle FullScreen")],FullScreenPlugin.prototype,"toggle",null),FullScreenPlugin=FullScreenPlugin_decorate([uiFolder("Full Screen")],FullScreenPlugin);const ensureUniqueNames=d=>{const o=[],l=new Set;for(const c of d){let u=c,h=0;for(;l.has(u);)u=c+"."+ ++h;l.add(u),o.push(u)}return o},mappingsArrayToTable=(d,o)=>{const l={};for(const c of d.mappings)for(const u of c.variants)l[o[u]]={material:null,gltfMaterialIndex:c.material};return l},compatibleObject=d=>d.material!==void 0&&d.userData&&d.userData._variantMaterials,khrMaterialsVariantsGLTF="KHR_materials_variants";class GLTFMaterialsVariantsExtensionImport{constructor(o){this.parser=o,this.name=khrMaterialsVariantsGLTF}async afterRoot(o){const l=this.parser,c=l.json;if(!c.extensions||!c.extensions[this.name])return;const u=c.extensions[this.name].variants||[],h=ensureUniqueNames(u.map(_=>_.name));for(const _ of o.scenes)_.traverse(A=>{const w=l.associations.get(A);if(!w||w.meshes===void 0||w.primitives===void 0)return;const C=c.meshes[w.meshes].primitives[w.primitives].extensions;C&&C[this.name]&&(A.userData._variantMaterials=mappingsArrayToTable(C[this.name],h))});await Promise.all(o.scenes.map(async _=>{const A=[];return _.traverse(w=>compatibleObject(w)&&A.push((async C=>{const M=C.material,O=C.userData._variantMaterials,ne=[];for(const ce in O){const ue=O[ce];if(ue.material)continue;const ye=ue.gltfMaterialIndex;ne.push(l.getDependency("material",ye).then(Oe=>{C.material=Oe,l.assignFinalMaterial(C),O[ce].material=C.material}))}return Promise.all(ne).then(()=>{C.material=M})})(w))),_.userData.__importData||(_.userData.__importData={}),_.userData.__importData[khrMaterialsVariantsGLTF]={names:h},Promise.all(A)}))}}const GLTFMaterialsVariantsExtensionExport_compatibleObject=d=>d.material!==void 0&&d.userData&&d.userData._variantMaterials&&!!Object.values(d.userData._variantMaterials).filter(o=>compatibleMaterial(o==null?void 0:o.material)),compatibleMaterial=d=>d&&d.isMaterial&&!Array.isArray(d);class GLTFExporterMaterialsVariantsExtensionExport{constructor(o){this.writer=o,this.name=khrMaterialsVariantsGLTF,this.variantNames=[]}beforeParse(o){const l=new Set;for(const c of o)c.traverse(u=>{if(!GLTFMaterialsVariantsExtensionExport_compatibleObject(u))return;const h=u.userData._variantMaterials;for(const _ in h){const A=h[_];compatibleMaterial(A.material)&&l.add(_)}});l.forEach(c=>this.variantNames.push(c))}writeMesh(o,l){var c;if(!GLTFMaterialsVariantsExtensionExport_compatibleObject(o))return;const u=o.userData,h=u._variantMaterials,_={};for(const C in h){const M=h[C].material;if(!compatibleMaterial(M))continue;const O=this.variantNames.indexOf(C),ne=this.writer.processMaterial(M);_[ne]||(_[ne]={material:ne,variants:[]}),_[ne].variants.push(O)}const A=Object.values(_).map(C=>C.variants.sort((M,O)=>M-O)&&C).sort((C,M)=>C.material-M.material);if(A.length===0)return;const w=compatibleMaterial(u._originalMaterial)&&(c=this.writer.processMaterial(u._originalMaterial))!==null&&c!==void 0?c:-1;for(const C of l.primitives)w>=0&&(C.material=w),C.extensions=C.extensions||{},C.extensions[this.name]={mappings:A}}afterParse(o){if(this.variantNames.length===0)return;const l=this.writer.json;l.extensions=l.extensions||{};const c=this.variantNames.map(u=>({name:u}));l.extensions[this.name]={variants:c},this.writer.extensionsUsed[this.name]=!0}}function gltfExporterMaterialsVariantsExtensionExport(d){return new GLTFExporterMaterialsVariantsExtensionExport(d)}var GLTFKHRMaterialVariantsPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class GLTFKHRMaterialVariantsPlugin extends AViewerPlugin{constructor(){super(),this.enabled=!0,this.toJSON=void 0,this.dependencies=[AssetManagerPlugin],this.variants={},this.selectedVariant="",this._objectAdded=o=>{var l,c;const u=o.object;(u==null?void 0:u.assetType)==="model"&&u.modelObject&&this._viewer&&(u.modelObject.traverse(h=>{var _,A,w,C,M;if(h.userData._variantMaterials)for(const ce of Object.values(h.userData._variantMaterials))ce!=null&&ce.material&&(ce.material=((w=(A=(_=this._viewer)===null||_===void 0?void 0:_.getManager())===null||A===void 0?void 0:A.materials)===null||w===void 0?void 0:w.processMaterial(ce.material,{}))||ce.material);const O=(M=(C=h.userData)===null||C===void 0?void 0:C.__importData)===null||M===void 0?void 0:M[khrMaterialsVariantsGLTF];if(!O)return;const ne=O.names||[];for(const ce of ne)this.variants[ce]||(this.variants[ce]=[]),this.variants[ce].push(h);delete h.userData.__importData[khrMaterialsVariantsGLTF]}),(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l))},this.uiConfig={type:"folder",label:"KHR Material Variants",children:[()=>({children:[null,...Object.keys(this.variants)].map(o=>o?{label:o}:{label:"none",value:""}),type:"dropdown",label:"Variant",property:[this,"selectedVariant"]})]},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(o){var l,c,u,h;await super.onAdded(o),o.scene.addEventListener("addSceneObject",this._objectAdded);const _=o.getPlugin(AssetManagerPlugin);(l=_==null?void 0:_.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=_==null?void 0:_.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(gltfExporterMaterialsVariantsExtensionExport)}_loaderCreate({loader:o}){o.isGLTFLoader2&&o.register(l=>new GLTFMaterialsVariantsExtensionImport(l))}async onRemove(o){var l,c,u,h,_,A;o.scene.removeEventListener("addSceneObject",this._objectAdded);const w=o.getPlugin(AssetManagerPlugin);(l=w.importer)===null||l===void 0||l.removeEventListener("loaderCreate",this._loaderCreate);const C=(h=(u=(c=w.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0?void 0:h.indexOf(gltfExporterMaterialsVariantsExtensionExport);return C!==void 0&&C!==-1&&((A=(_=w.exporter.getExporter("gltf","glb"))===null||_===void 0?void 0:_.extensions)===null||A===void 0||A.splice(C,1)),this.variants={},super.onRemove(o)}_variantChanged(){this.applyVariant(this.selectedVariant||"",!0)}applyVariant(o,l=!1,c,u=!0){if(!l&&!c&&this.selectedVariant===o||!o)return;c||(this.selectedVariant=o);const h=c?Array.isArray(c)?c:[c]:o?this.variants[o]||[]:Object.values(this.variants).flat();for(const _ of h){const A=new Set,w=C=>{var M,O;if(!C.userData._variantMaterials||A.has(C))return;const ne=o?(M=C.userData._variantMaterials[o])===null||M===void 0?void 0:M.material:C.userData._originalMaterial;ne&&(C.userData._originalMaterial||(C.userData._originalMaterial=C.material),(O=C==null?void 0:C.setMaterial)===null||O===void 0||O.call(C,ne)),A.add(C)};u?_.traverse(w):w(_)}}}GLTFKHRMaterialVariantsPlugin.PluginType="GLTFKHRMaterialVariantsPlugin",GLTFKHRMaterialVariantsPlugin_decorate([x(GLTFKHRMaterialVariantsPlugin.prototype._variantChanged)],GLTFKHRMaterialVariantsPlugin.prototype,"selectedVariant",void 0);var edgeMask="uniform vec2 screenSize;uniform sampler2D tNormalDepth;uniform sampler2D tNormalBuffer;uniform sampler2D tGBufferFlags;uniform float radius;uniform vec2 cameraNearFar;uniform vec3 cameraPositionWorld;const float depthStep=0.2;const float normalThreshold=0.9;float unpack16(vec2 value){return(value.x*0.996108949416342426275150501169264316558837890625+value.y*0.00389105058365758760263730664519243873655796051025390625);}vec3 unpackNormal(vec2 enc){vec2 fenc=enc*4.-2.;float f=dot(fenc,fenc);float g=sqrt(1.-f/4.);return vec3(fenc*g,1.-f/2.);}void lookupNormalDepth(out float depth,out vec3 normal,vec2 off){vec2 uv=(gl_FragCoord.st+off)/screenSize;vec4 texel=texture2D(tNormalDepth,uv);depth=mix(cameraNearFar.x,cameraNearFar.y,pow(unpack16(texel.xy),2.));normal=2.*texture2D(tNormalBuffer,uv).rgb-1.;}float getBorderWeight(){float depth1,depth2,depth3,depth4;vec3 normal1,normal2,normal3,normal4;float d_=dot(cameraPositionWorld,cameraPositionWorld);float radiusModifier=clamp(3./(1.+pow(abs(d_),0.5)),0.,1.);float modRad=radius;lookupNormalDepth(depth1,normal1,vec2(0.,modRad));lookupNormalDepth(depth2,normal2,vec2(0.,-modRad));lookupNormalDepth(depth3,normal3,vec2(modRad,0.));lookupNormalDepth(depth4,normal4,vec2(-modRad,0.));vec2 uv=(gl_FragCoord.st)/screenSize;float mask=step(0.0001,texture2D(tGBufferFlags,uv).g);float mask1=texture2D(tGBufferFlags,uv+vec2(0.,modRad)/screenSize).b*255.;float mask2=texture2D(tGBufferFlags,uv+vec2(0.,-modRad)/screenSize).b*255.;float mask3=texture2D(tGBufferFlags,uv+vec2(modRad,0.)/screenSize).b*255.;float mask4=texture2D(tGBufferFlags,uv+vec2(-modRad,0.)/screenSize).b*255.;float maskWeight=max(abs(mask1-mask2),abs(mask3-mask4))*255.;maskWeight=(step(maskWeight,0.01));float a1=dot(normal1,normal2);float a2=dot(normal3,normal4);float normalWeight=min(abs(a1),abs(a2));normalWeight=1.-step(normalThreshold,normalWeight);float depthWeight=max(abs(depth1-depth2),abs(depth3-depth4));depthWeight=(step(depthWeight,depthStep));return normalWeight*depthWeight*maskWeight*mask;}void main(){float weight=getBorderWeight();vec2 uv=gl_FragCoord.st/screenSize;vec4 texel=texture2D(tNormalDepth,uv);float depth=pow(unpack16(texel.xy),2.);vec3 outColor=vec3(0.);if(depth>0.999){weight=0.;}else{outColor=vec3(weight);}gl_FragColor=vec4(outColor,1.);}",seperableBlurShaderMasked="varying vec2 vUv;uniform sampler2D colorTexture;uniform sampler2D maskTexture;uniform vec2 texSize;uniform vec2 direction;float gaussianPdf(in float x,in float sigma){return 0.39894*exp(-0.5*x*x/(sigma*sigma))/sigma;}void main(){vec2 invSize=1./texSize;float fSigma=float(SIGMA);float weightSum=gaussianPdf(0.,fSigma);vec4 mask=texture2D(maskTexture,vUv);vec3 diffuseSum=texture2D(colorTexture,vUv).rgb*weightSum;for(int i=1;i<KERNEL_RADIUS;i++){float x=float(i);float w=gaussianPdf(x,fSigma);vec2 uvOffset=direction*invSize*x;vec3 sample1=texture2D(colorTexture,vUv+uvOffset).rgb;vec3 sample2=texture2D(colorTexture,vUv-uvOffset).rgb;diffuseSum+=(sample1+sample2)*w;weightSum+=2.*w;}gl_FragColor=vec4(diffuseSum/weightSum,1.);}",blurNormal=`uniform sampler2D tNormalBuffer;uniform sampler2D edgeMaskBuffer;uniform vec2 screenSize;uniform float dpr;const float depthStep=0.02;uniform vec2 samples[NUM_SAMPLES];uniform vec3 cameraPositionWorld;varying vec2 vUv;
#include <common>
float getBevelRadius(in float number){return floor(number/8.);}vec3 smoothNormal(){vec2 uv=gl_FragCoord.xy/screenSize;vec4 texel=texture2D(tNormalDepth,uv);vec4 edgeMask=texture2D(edgeMaskBuffer,uv);vec3 avgNormal=2.*texture2D(tNormalBuffer,uv).rgb-1.;float depth=pow(unpack16(texel.xy),2.);vec2 invScreenSize=vec2(1.)/screenSize;vec4 mask=texture2D(tGBufferFlags,uv);float weightSum=0.;float radius=getBevelRadius(mask.g*255.)*2.*dpr;float randomAngle=6.2*random(frameCount*0.1);float theta=randomAngle;float snTheta=sin(theta);float csTheta=cos(theta);mat2 randomRotationMatrix=mat2(csTheta,snTheta,-snTheta,csTheta);float d_=dot(cameraPositionWorld,cameraPositionWorld);float radiusModifier=clamp(1./(1.+pow(abs(d_),0.5)),0.,1.);for(int i=0;i<5;i++){float x=float(i)-2.;for(int j=0;j<5;j++){float y=float(j)-2.;vec2 offset=randomRotationMatrix*vec2(x,y)*radius*radiusModifier*invScreenSize;vec4 texel=texture2D(tNormalDepth,uv+offset);float offsetDepth=pow(unpack16(texel.xy),2.);float depthWeight=abs(offsetDepth-depth);depthWeight=(1.-step(depthStep,depthWeight));vec3 offsetNormal=2.*texture2D(tNormalBuffer,uv+offset).rgb-1.;if(dot(offsetNormal,offsetNormal)>0.){avgNormal+=offsetNormal*depthWeight;}}}return normalize(avgNormal);}void main(){vec2 uv=gl_FragCoord.xy/screenSize;vec4 edgeMask=texture2D(edgeMaskBuffer,uv);vec3 normal=vec3(0.);if(edgeMask.x>0.){normal=smoothNormal();}else{normal=2.*texture2D(tNormalBuffer,uv).rgb-1.;}gl_FragColor=vec4(vec3(0.5*normal+0.5),1.);}`,SSBevelPass_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};function addSSBevel(d){const o=d==null?void 0:d.userData;if(!o)return!1;o._ssBevel||(o._ssBevel={});const l=o._ssBevel;return l.hasSSBevel=!0,l.radius===void 0&&(l.radius=0),d.isMaterial&&(d.needsUpdate=!0),!0}let SSBevelPass=class extends ShaderPass2{constructor(d,o,l,c){super({defines:{NUM_SAMPLES:16},uniforms:{tNormalDepth:{value:null},tNormalBuffer:{value:null},tGBufferFlags:{value:null},edgeMaskBuffer:{value:null},screenSize:{value:new three_module.I9Y},radius:{value:1},samples:{value:null},frameCount:{value:0},dpr:{value:1},cameraPositionWorld:{value:new three_module.Pq0(1,1,1)}},vertexShader:defaultVertex,fragmentShader:`

            ${l}

            ${randomHelpers}

            ${blurNormal}
            
            `},"tDiffuse"),this.uiConfig=void 0,this.sceneBevel=!1,this.sceneBevelRadius=2,this.materialExtension={shaderExtender:(u,h,_)=>{var A,w;const C=(w=(A=h.materialObject.userData)===null||A===void 0?void 0:A._ssBevel)===null||w===void 0?void 0:w.hasSSBevel;!this.enabled||this.sceneBevel&&C===!1||!this.sceneBevel&&!C||(u.fragmentShader=shaderReplaceString(u.fragmentShader,"#include <normal_fragment_maps>",` 
                normal = 2. * texture2D(tSSBevelMap, viewToScreen(vViewPosition.xyz).xy).rgb - 1.;
                normal = normalize(normal);
            `))},onObjectRender:(u,h,_)=>{var A,w;const C=(w=(A=h.materialObject.userData)===null||A===void 0?void 0:A._ssBevel)===null||w===void 0?void 0:w.hasSSBevel;if(!this.enabled||this.sceneBevel&&C===!1||!this.sceneBevel&&!C)return;const M=h.materialObject,O=this._target.texture;this.materialExtension.extraUniforms.tSSBevelMap.value!==O&&(this.materialExtension.extraUniforms.tSSBevelMap.value=O,M.needsUpdate=!0)},getUiConfig:u=>{const h={type:"folder",label:"SSBevel (Dev)",children:[{type:"checkbox",label:"Enabled",get value(){var _;return((_=u.materialObject.userData._ssBevel)===null||_===void 0?void 0:_.hasSSBevel)||!1},set value(_){var A,w;_!==((A=u.materialObject.userData._ssBevel)===null||A===void 0?void 0:A.hasSSBevel)&&(_?addSSBevel(u.materialObject)||alert("Cannot add screen space bevel."):u.materialObject.userData._ssBevel&&(u.materialObject.userData._ssBevel.hasSSBevel=!1,u.materialObject.needsUpdate=!0),(w=h.uiRefresh)===null||w===void 0||w.call(h,"postFrame",!0))},onChange:this.setDirty},()=>({type:"slider",bounds:[0,16],label:"radius",hidden:()=>{var _;return!(!((_=u.materialObject.userData._ssBevel)===null||_===void 0)&&_.hasSSBevel)},property:[u.materialObject.userData._ssBevel,"radius"],onChange:this.setDirty})]};return h},parsFragmentSnippet:(u,h)=>{var _,A;const w=(A=(_=h==null?void 0:h.materialObject.userData)===null||_===void 0?void 0:_._ssBevel)===null||A===void 0?void 0:A.hasSSBevel;return!this.enabled||this.sceneBevel&&w===!1||!this.sceneBevel&&!w?"":fe`
            uniform sampler2D tSSBevelMap;
            ${simpleCameraHelpers}
            `},extraUniforms:{tSSBevelMap:{value:null}},computeCacheKey:u=>{var h,_;return(this.enabled?"1":"0")+(this.sceneBevel?"1":"0")+(!((_=(h=u.materialObject.userData)===null||h===void 0?void 0:h._ssBevel)===null||_===void 0)&&_.hasSSBevel?"1":"0")},isCompatible:u=>u.isMeshStandardMaterial2},this._target=o,this.needsSwap=!1,this.clear=!0,this._viewerApp=c,this._edgeMaterial=new ShaderMaterial2({uniforms:{tNormalDepth:{value:null},tNormalBuffer:{value:null},tGBufferFlags:{value:null},screenSize:{value:null},radius:{value:10},cameraNearFar:{value:new three_module.I9Y(1,1)},cameraPositionWorld:{value:new three_module.Pq0(1,1,1)}},vertexShader:defaultVertex,fragmentShader:edgeMask}),this._separableBlurMaterial=new ShaderMaterial2({defines:{KERNEL_RADIUS:3,SIGMA:3},uniforms:{colorTexture:{value:null},maskTexture:{value:null},texSize:{value:new three_module.I9Y(.5,.5)},direction:{value:new three_module.I9Y(.5,.5)}},vertexShader:defaultVertex,fragmentShader:seperableBlurShaderMasked})}render(d,o,l,c,u){var h,_;if(!this.enabled)return;const A=d.baseRenderer,w={minFilter:three_module.k6q,magFilter:three_module.k6q,isAntialiased:!1,format:three_module.GWd,depthBuffer:!1,generateMipmaps:!1},C=A.getTempTarget(w);this._renderEdges(A,C),this._blurEdges(A,C),this._viewerApp.scene.renderCamera.updateShaderProperties(this.material),(h=this._viewerApp.getPlugin(GBufferPlugin))===null||h===void 0||h.updateShaderProperties(this.material),(_=this._viewerApp.getPlugin(NormalBufferPlugin))===null||_===void 0||_.updateShaderProperties(this.material),this._viewerApp.renderer.updateShaderProperties(this.material),this.uniforms.edgeMaskBuffer.value=C.texture,this.uniforms.dpr.value=this._viewerApp.renderer.displayCanvasScaling,super.render(d,this._target,C,c,u),A.releaseTempTarget(C)}_initsamples(){const d=[];return d.push(new three_module.I9Y(-8,0).multiplyScalar(.125)),d.push(new three_module.I9Y(-6,-4).multiplyScalar(.125)),d.push(new three_module.I9Y(-3,-2).multiplyScalar(.125)),d.push(new three_module.I9Y(-2,-6).multiplyScalar(.125)),d.push(new three_module.I9Y(1,-1).multiplyScalar(.125)),d.push(new three_module.I9Y(2,-5).multiplyScalar(.125)),d.push(new three_module.I9Y(6,-7).multiplyScalar(.125)),d.push(new three_module.I9Y(5,-3).multiplyScalar(.125)),d.push(new three_module.I9Y(4,1).multiplyScalar(.125)),d.push(new three_module.I9Y(7,4).multiplyScalar(.125)),d.push(new three_module.I9Y(3,5).multiplyScalar(.125)),d.push(new three_module.I9Y(0,7).multiplyScalar(.125)),d.push(new three_module.I9Y(-1,3).multiplyScalar(.125)),d.push(new three_module.I9Y(-4,6).multiplyScalar(.125)),d.push(new three_module.I9Y(-7,8).multiplyScalar(.125)),d.push(new three_module.I9Y(-5,2).multiplyScalar(.125)),d}_blurEdges(d,o){var l,c;const u={minFilter:three_module.k6q,magFilter:three_module.k6q,isAntialiased:!1,format:three_module.GWd,depthBuffer:!1,generateMipmaps:!1,sizeMultiplier:.5},h=d.getTempTarget(u),_=((l=o.texture.image)===null||l===void 0?void 0:l.width)||1,A=((c=o.texture.image)===null||c===void 0?void 0:c.height)||1;this._separableBlurMaterial.uniforms.texSize.value=new three_module.I9Y(_,A),this._separableBlurMaterial.uniforms.colorTexture.value=o.texture,this._separableBlurMaterial.uniforms.direction.value=new three_module.I9Y(1,0),d.blit(void 0,h,{material:this._separableBlurMaterial}),this._separableBlurMaterial.uniforms.texSize.value=new three_module.I9Y(_/2,A/2),this._separableBlurMaterial.uniforms.colorTexture.value=h.texture,this._separableBlurMaterial.uniforms.direction.value=new three_module.I9Y(0,1),d.blit(void 0,o,{material:this._separableBlurMaterial}),d.releaseTempTarget(h)}_renderEdges(d,o){var l,c,u,h;const _=((l=o.texture.image)===null||l===void 0?void 0:l.width)||1,A=((c=o.texture.image)===null||c===void 0?void 0:c.height)||1;this._edgeMaterial.uniforms.screenSize.value=new three_module.I9Y(_,A),this._viewerApp.scene.renderCamera.updateShaderProperties(this._edgeMaterial),(u=this._viewerApp.getPlugin(GBufferPlugin))===null||u===void 0||u.updateShaderProperties(this._edgeMaterial),(h=this._viewerApp.getPlugin(NormalBufferPlugin))===null||h===void 0||h.updateShaderProperties(this._edgeMaterial),d.blit(void 0,o,{material:this._edgeMaterial})}};SSBevelPass_decorate([uiToggle("Scene Bevel"),serialize(),x(SSBevelPass.prototype.setDirty)],SSBevelPass.prototype,"sceneBevel",void 0),SSBevelPass_decorate([uiSlider("Scene Bevel Radius",[0,8],.1),serialize(),x(SSBevelPass.prototype.setDirty)],SSBevelPass.prototype,"sceneBevelRadius",void 0),SSBevelPass=SSBevelPass_decorate([uiFolder("SSBevel")],SSBevelPass);class SSBevelPlugin extends GenericFilterPlugin{get bevelTarget(){return this._bevelTarget}constructor(o=!0){super(),this.passId="ssBevel",this._beforeFilters=["render"],this._afterFilters=["gbuffer","normalBuffer"],this._requiredFilters=["render","gbuffer","normalBuffer"],this._lastEnabled=!1,this.dependencies=[AssetManagerPlugin,GBufferPlugin,NormalBufferPlugin],this.enabled=o,this.setDirty=this.setDirty.bind(this),this._loaderCreate=this._loaderCreate.bind(this),this.updateGBuffer=this.updateGBuffer.bind(this)}_loaderCreate({loader:o}){o.isGLTFLoader2&&o.register(l=>new GLTFMaterialsSSBevelExtensionImport(l))}passCtor(o){var l,c;return this._bevelTarget=o.renderer.createTarget({depthBuffer:!0,type:three_module.ix0,minFilter:three_module.hxR,magFilter:three_module.hxR,generateMipmaps:!1}),this._bevelTarget.texture.name="bevelBuffer",this._bevelTarget.texture.generateMipmaps=!1,o.getPluginByType("debug"),new SSBevelPass(o.renderer,this._bevelTarget,(c=(l=o.getPlugin(GBufferPlugin))===null||l===void 0?void 0:l.getUnpackSnippet())!==null&&c!==void 0?c:"",o)}async onAdded(o){var l,c,u,h,_,A,w,C;await super.onAdded(o);const M=o.getPlugin(AssetManagerPlugin);return!((l=this.pass)===null||l===void 0)&&l.passObject.materialExtension&&((c=M==null?void 0:M.materials)===null||c===void 0||c.registerMaterialExtension((u=this.pass)===null||u===void 0?void 0:u.passObject.materialExtension)),(h=M==null?void 0:M.importer)===null||h===void 0||h.addEventListener("loaderCreate",this._loaderCreate),(w=(A=(_=M==null?void 0:M.exporter)===null||_===void 0?void 0:_.getExporter("gltf","glb"))===null||A===void 0?void 0:A.extensions)===null||w===void 0||w.push(glTFMaterialsSSBevelExtensionExport),(C=o.getPlugin(GBufferPlugin))===null||C===void 0||C.registerGBufferUpdater(this.updateGBuffer),super.onAdded(o)}async onRemove(o){return o.renderer.disposeTarget(this._bevelTarget),super.onRemove(o)}setDirty(){var o,l,c,u;(o=this._viewer)===null||o===void 0||o.setDirty(),(u=(l=this.pass)===null||l===void 0?void 0:(c=l.passObject.materialExtension).setDirty)===null||u===void 0||u.call(c)}_update(o){var l,c;let u=this.enabled;if(u&&!this._lastEnabled){const h=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("NormalBufferPlugin");h&&!h.enabled&&(h.enabled=!0),h||(c=this._viewer)===null||c===void 0||c.console.error("SSBevelPlugin needs NormalBufferPlugin")}return this._lastEnabled=u,u}get uiConfig(){var o,l,c,u,h;const _=(c=(l=(o=this.pass)===null||o===void 0?void 0:o.passObject)===null||l===void 0?void 0:l.uiConfig)!==null&&c!==void 0?c:{};return(h=(u=_.children)===null||u===void 0?void 0:u.map(A=>Ee(A)))===null||h===void 0||h.flat(2).forEach(A=>A&&(A.onChange=this.setDirty)),_}updateGBuffer(o,l){var c,u,h,_;if(!((c=this._pass)===null||c===void 0)&&c.passObject&&o.isMesh&&(!((u=o.material)===null||u===void 0)&&u.userData)){for(let C=3;C<8;C++)l.y=clearBit(l.y,C);const A=(_=(h=o.material)===null||h===void 0?void 0:h.userData)===null||_===void 0?void 0:_._ssBevel;let w=this._pass.passObject.sceneBevel&&!(A!=null&&A.hasSSBevel)?this._pass.passObject.sceneBevelRadius:(A==null?void 0:A.radius)||0;w=Math.min(w,31),w<<=3,l.y=l.y|w}}getBevelMaterials(){var o;const l=new Set;return(o=this._viewer)===null||o===void 0||o.scene.modelRoot.traverse(c=>{var u,h;!((h=(u=c.material)===null||u===void 0?void 0:u.userData)===null||h===void 0)&&h._ssBevel.hasSSBevel&&l.add(c.material)}),Array.from(l)}}SSBevelPlugin.PluginType="SSBevelPlugin",SSBevelPlugin.SSBEVEL_GLTF_EXTENSION="WEBGI_materials_ssbevel";class GLTFMaterialsSSBevelExtensionImport{constructor(o){this.parser=o,this.name=SSBevelPlugin.SSBEVEL_GLTF_EXTENSION}async extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name];return l.userData||(l.userData={}),addSSBevel(l),l.userData._ssBevel=deserializeObject(u,l.userData._ssBevel,!1,{}),Promise.resolve()}}const glTFMaterialsSSBevelExtensionExport=d=>({writeMaterial:(o,l)=>{if(!o.isMeshStandardMaterial||!o.userData._ssBevel||!o.userData._ssBevel.hasSSBevel)return;l.extensions=l.extensions||{};const c=serializeObject(o.userData._ssBevel,!1);l.extensions[SSBevelPlugin.SSBEVEL_GLTF_EXTENSION]=c,d.extensionsUsed[SSBevelPlugin.SSBEVEL_GLTF_EXTENSION]=!0}});class GammaCorrectionExtension{constructor(){this.uiConfig=void 0,this.enabled=!0}shaderExtender(o,l,c){this.enabled&&(o.fragmentShader=shaderReplaceString(o.fragmentShader,"#glMarker",` 
            gl_FragColor = LinearTosRGB(gl_FragColor);
            #glMarker
        `))}computeCacheKey(o){return this.enabled?"1":"0"}isCompatible(o){return!0}}class GammaCorrectionPlugin extends GenericExtensionPlugin{generateExtension(o){return new GammaCorrectionExtension}}GammaCorrectionPlugin.PluginType="GammaCorrection";var triplanarmapping="struct TriplanarUV{vec2 x;vec2 y;vec2 z;};uniform float triplanarScale;uniform float triplanarBlend;uniform float triplanarOffset;vec3 getTriplanarWeights(in vec3 position,in vec3 normal){vec3 triW=abs(normal);triW=clamp(triW-vec3(triplanarOffset),vec3(0.),vec3(1.));triW=pow(triW,vec3(triplanarBlend));return triW/(triW.x+triW.y+triW.z);}TriplanarUV getTriplanarUV(in vec3 position,in vec3 normal){TriplanarUV triUV;triUV.x=position.zy*triplanarScale;triUV.y=position.xz*triplanarScale;triUV.z=position.xy*triplanarScale;if(normal.x<0.){triUV.x.x=-triUV.x.x;}if(normal.y<0.){triUV.y.x=-triUV.y.x;}if(normal.z>=0.){triUV.z.x=-triUV.z.x;}return triUV;}vec4 textureTriplanar(in sampler2D tex,in vec3 position,in vec3 normal){TriplanarUV triUV=getTriplanarUV(position,normal);vec4 texX=texture2D(tex,triUV.x);vec4 texY=texture2D(tex,triUV.y);vec4 texZ=texture2D(tex,triUV.z);vec3 triW=getTriplanarWeights(position,normal);return texX*triW.x+texY*triW.y+texZ*triW.z;}",TriplanarUVMappingPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let TriplanarUVMappingPlugin=class extends AViewerPlugin{addTriplanarMapping(d){var o;const l=(o=d.materialObject)===null||o===void 0?void 0:o.userData;return!!l&&(l._triplanarMapping||(l._triplanarMapping={}),l._triplanarMapping.enable=!0,l._triplanarMapping.scaleFactor===void 0&&(l._triplanarMapping.scaleFactor=1),l._triplanarMapping.blendFactor===void 0&&(l._triplanarMapping.blendFactor=1),l._triplanarMapping.offsetFactor===void 0&&(l._triplanarMapping.offsetFactor=0),d.materialObject.needsUpdate=!0,!0)}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFMaterialsTriplanarMappingExtensionImport(o))}constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin],this._uniforms={triplanarScale:{value:1},triplanarBlend:{value:1},triplanarOffset:{value:0}},this.materialExtension={shaderExtender:(d,o,l)=>{var c,u;if(!this.enabled||!(!((u=(c=o.materialObject.userData)===null||c===void 0?void 0:c._triplanarMapping)===null||u===void 0)&&u.enable))return;const h=fe`
                #ifndef USE_TRANSMISSION
                    varying vec3 vWorldPosition;
                #endif
                varying vec3 vWorldNormal;
            `;d.vertexShader=shaderReplaceString(d.vertexShader,"#include <common>",h,{prepend:!0});const _=fe`
                // same as worldpos_vertex.glsl.js but added a !
                #if !(defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0)
                vec4 worldPosition = vec4( transformed, 1.0 );
                #ifdef USE_INSTANCING
                worldPosition = instanceMatrix * worldPosition;
                #endif
                worldPosition = modelMatrix * worldPosition;
                #endif
                
                #ifndef USE_TRANSMISSION
                    vWorldPosition = worldPosition.xyz; 
                #endif
                vWorldNormal = normalize((modelMatrix * vec4(objectNormal, 0.)).xyz);
            `;d.vertexShader=shaderReplaceString(d.vertexShader,"#include <worldpos_vertex>",_,{append:!0});const A=fe`
                ${triplanarmapping}
                #ifndef USE_TRANSMISSION
                    varying vec3 vWorldPosition;
                #endif
                varying vec3 vWorldNormal;
            `;d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <common>",A,{prepend:!0});const w=fe`

            #ifdef USE_BUMPMAP

            uniform sampler2D bumpMap;
            uniform float bumpScale;

            // Bump Mapping Unparametrized Surfaces on the GPU by Morten S. Mikkelsen
            // https://mmikk.github.io/papers3d/mm_sfgrad_bump.pdf

            // Evaluate the derivative of the height w.r.t. screen-space using forward differencing (listing 2)

            vec2 dHdxy_fwd() {

                vec3 dSTdx = dFdx( vWorldPosition );
                vec3 dSTdy = dFdy( vWorldPosition );

                vec3 normal_ = normalize(vWorldNormal);
                float Hll = bumpScale * textureTriplanar( bumpMap, vWorldPosition, normal_ ).x;
                float dBx = bumpScale * textureTriplanar( bumpMap, vWorldPosition + dSTdx, normal_ ).x - Hll;
                float dBy = bumpScale * textureTriplanar( bumpMap, vWorldPosition + dSTdy, normal_ ).x - Hll;

                return vec2( dBx, dBy );

            }

            vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {

                vec3 vSigmaX = dFdx( surf_pos.xyz );
                vec3 vSigmaY = dFdy( surf_pos.xyz );
                vec3 vN = surf_norm; // normalized

                vec3 R1 = cross( vSigmaY, vN );
                vec3 R2 = cross( vN, vSigmaX );

                float fDet = dot( vSigmaX, R1 ) * faceDirection;

                vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
                return normalize( abs( fDet ) * surf_norm - vGrad );

            }

        #endif
            `;d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <bumpmap_pars_fragment>",w);let C=shaderReplaceString(three_module.vxI.map_fragment,"texture2D( map, vMapUv );","textureTriplanar( map, vWorldPosition, normalize(vWorldNormal) );");d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <map_fragment>",C),C=shaderReplaceString(three_module.vxI.roughnessmap_fragment,"texture2D( roughnessMap, vRoughnessMapUv );","textureTriplanar( roughnessMap, vWorldPosition, normalize(vWorldNormal));"),d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <roughnessmap_fragment>",C),C=shaderReplaceString(three_module.vxI.metalnessmap_fragment,"texture2D( metalnessMap, vMetalnessMapUv );","textureTriplanar( metalnessMap, vWorldPosition, normalize(vWorldNormal));"),d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <metalnessmap_fragment>",C),C=shaderReplaceString(three_module.vxI.normal_fragment_maps,"vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;","vec3 mapN = textureTriplanar( normalMap, vWorldPosition, normalize(vWorldNormal) ).xyz * 2.0 - 1.0;"),d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <normal_fragment_maps>",C),d.defines.USE_UV=""},onObjectRender:(d,o)=>{var l,c,u,h;const _=o.materialObject.userData;if(!(!((l=_==null?void 0:_._triplanarMapping)===null||l===void 0)&&l.enable))return;const A=d;A.isMesh&&A.geometry&&(this._uniforms.triplanarScale.value=(c=_._triplanarMapping)===null||c===void 0?void 0:c.scaleFactor,this._uniforms.triplanarBlend.value=(u=_._triplanarMapping)===null||u===void 0?void 0:u.blendFactor,this._uniforms.triplanarOffset.value=(h=_._triplanarMapping)===null||h===void 0?void 0:h.offsetFactor)},extraUniforms:{...this._uniforms},computeCacheKey:d=>{var o,l;return(this.enabled?"1":"0")+(!((l=(o=d.materialObject.userData)===null||o===void 0?void 0:o._triplanarMapping)===null||l===void 0)&&l.enable?"1":"0")},isCompatible:d=>d.isMeshStandardMaterial2,updaters:()=>{var d;return[(d=this._viewer)===null||d===void 0?void 0:d.renderer]},getUiConfig:d=>{const o=this._viewer,l=this.addTriplanarMapping,c={type:"folder",label:"Triplanar",children:[{type:"checkbox",label:"Enabled",get value(){var u;return((u=d.materialObject.userData._triplanarMapping)===null||u===void 0?void 0:u.enable)||!1},set value(u){var h,_;u!==((h=d.materialObject.userData._triplanarMapping)===null||h===void 0?void 0:h.enable)&&(u?l(d)||o.alert("Cannot add Triplanar mapping."):d.materialObject.userData._triplanarMapping&&(d.materialObject.userData._triplanarMapping.enable=!1,d.materialObject.needsUpdate=!0),(_=c.uiRefresh)===null||_===void 0||_.call(c,"postFrame",!0))},onChange:this.setDirty},()=>({type:"slider",bounds:[.1,10],label:"Scale",hidden:()=>{var u;return!(!((u=d.materialObject.userData._triplanarMapping)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._triplanarMapping,"scaleFactor"],onChange:this.setDirty}),()=>({type:"slider",bounds:[1,10],label:"Blend",hidden:()=>{var u;return!(!((u=d.materialObject.userData._triplanarMapping)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._triplanarMapping,"blendFactor"],onChange:this.setDirty}),()=>({type:"slider",bounds:[0,.5],stepSize:.01,label:"Offset",hidden:()=>{var u;return!(!((u=d.materialObject.userData._triplanarMapping)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._triplanarMapping,"offsetFactor"],onChange:this.setDirty})]};return c}},this.setDirty=()=>{var d,o,l;(o=(d=this.materialExtension).setDirty)===null||o===void 0||o.call(d),(l=this._viewer)===null||l===void 0||l.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(d){var o,l,c,u,h;await super.onAdded(d);const _=d.getPlugin(AssetManagerPlugin);(o=_==null?void 0:_.materials)===null||o===void 0||o.registerMaterialExtension(this.materialExtension),(l=_==null?void 0:_.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=_==null?void 0:_.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(glTFMaterialsTriplanarMappingExtensionExport)}async onRemove(d){var o,l,c,u;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(d)}};TriplanarUVMappingPlugin.PluginType="TriplanarUVMappingPlugin",TriplanarUVMappingPlugin.TRIPLANAR_GLTF_EXTENSION="WEBGI_materials_triplanar",TriplanarUVMappingPlugin_decorate([uiToggle("Enabled",d=>({onChange:d.setDirty})),serialize()],TriplanarUVMappingPlugin.prototype,"enabled",void 0),TriplanarUVMappingPlugin=TriplanarUVMappingPlugin_decorate([uiFolder("Triplanar Mapping")],TriplanarUVMappingPlugin);class GLTFMaterialsTriplanarMappingExtensionImport{constructor(o){this.parser=o,this.name=TriplanarUVMappingPlugin.TRIPLANAR_GLTF_EXTENSION}async extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name];l.userData||(l.userData={});const h=l.userData;return h._triplanarMapping||(h._triplanarMapping={}),h._triplanarMapping.enable=!0,h._triplanarMapping.scaleFactor===void 0&&(h._triplanarMapping.scaleFactor=1),h._triplanarMapping.blendFactor===void 0&&(h._triplanarMapping.blendFactor=1),h._triplanarMapping.offsetFactor===void 0&&(h._triplanarMapping.offsetFactor=0),l.userData._triplanarMapping=deserializeObject(u,l.userData._triplanarMapping,!1,{}),Promise.resolve()}}const glTFMaterialsTriplanarMappingExtensionExport=d=>({writeMaterial:(o,l)=>{var c;if(!o.isMeshStandardMaterial||!(!((c=o.userData._triplanarMapping)===null||c===void 0)&&c.enable))return;l.extensions=l.extensions||{};const u=serializeObject(o.userData._triplanarMapping,!1);l.extensions[TriplanarUVMappingPlugin.TRIPLANAR_GLTF_EXTENSION]=u,d.extensionsUsed[TriplanarUVMappingPlugin.TRIPLANAR_GLTF_EXTENSION]=!0}});var sscurvature="uniform float cutoff;uniform vec3 cavityColor;uniform float cavityRoughness;uniform float cavityMetalness;uniform float cavityScale;uniform float stepSize;uniform sampler2D cavityMap;float getSSCurvature(in vec3 position,in vec3 normal){vec3 n=normalize(normal);vec3 dx=dFdx(n);vec3 dy=dFdy(n);vec3 xneg=n-stepSize*dx;vec3 xpos=n+stepSize*dx;vec3 yneg=n-stepSize*dy;vec3 ypos=n+stepSize*dy;float depth=length(position);float curvature=(cross(xneg,xpos).y-cross(yneg,ypos).x)*4./depth;return curvature;}",LayeredMaterialPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let LayeredMaterialPlugin=class extends AViewerPlugin{addLayeredMaterial(d){var o;const l=(o=d.materialObject)===null||o===void 0?void 0:o.userData;return!!l&&(l._layeredMaterial||(l._layeredMaterial={}),l._layeredMaterial.enable=!0,l._layeredMaterial.cutoff===void 0&&(l._layeredMaterial.cutoff=-.65),l._layeredMaterial.cavityColor===void 0&&(l._layeredMaterial.cavityColor=new three_module.Q1f(5789527)),l._layeredMaterial.cavityRoughness===void 0&&(l._layeredMaterial.cavityRoughness=.5),l._layeredMaterial.cavityMetalness===void 0&&(l._layeredMaterial.cavityMetalness=.5),l._layeredMaterial.cavityScale===void 0&&(l._layeredMaterial.cavityScale=1),l._layeredMaterial.stepSize===void 0&&(l._layeredMaterial.stepSize=5),d.materialObject.needsUpdate=!0,!0)}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFLayeredMaterialsExtensionImport(o))}constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin],this._uniforms={cutoff:{value:0},cavityColor:{value:new three_module.Q1f},cavityRoughness:{value:0},cavityMetalness:{value:0},cavityScale:{value:1},stepSize:{value:1}},this.materialExtension={shaderExtender:(d,o,l)=>{var c,u;if(!this.enabled||!(!((u=(c=o.materialObject.userData)===null||c===void 0?void 0:c._layeredMaterial)===null||u===void 0)&&u.enable))return;const h=fe`
                ${sscurvature}
            `;d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <common>",h,{prepend:!0});const _=fe`
                material.roughness = min( material.roughness, 1.0 );
                float curvature = getSSCurvature(vViewPosition, normal);
                float smoothCurvature = smoothstep(0., 1., curvature - cutoff);
                material.roughness = min( material.roughness, 1.0 );
                curvature = curvature * cavityScale;
                smoothCurvature = smoothCurvature * cavityScale;
                smoothCurvature = min(smoothCurvature, 1.);
                vec3 finalCavityColor = mix(cavityColor, cavityColor*0.5, vec3(smoothCurvature));
                material.roughness = mix(cavityRoughness, material.roughness, smoothCurvature);
                material.diffuseColor = mix(finalCavityColor, material.diffuseColor, smoothCurvature);
            `,A=fe`
                material.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );
                material.specularColor = mix(material.specularColor, finalCavityColor, (1. - smoothCurvature) * cavityMetalness);
            `;let w=three_module.vxI.lights_physical_fragment.replace("material.roughness = min( material.roughness, 1.0 );",_);w=w.replace("material.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );",A),d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <lights_physical_fragment>",w);const C=fe`
                vec3 debugCurvatureColor = vec3(0., 0., 1.);
                float _epsilon = 1e-4;
                vec3 green = vec3(0., 0., 0.);
                vec3 red = vec3(1., 1., 1.);
                //if(curvature > cutoff)debugCurvatureColor = green;
                //if(curvature < cutoff)debugCurvatureColor = red;
                // curvature /= 2.;
                // curvature = curvature * 0.5 + 0.5;
                debugCurvatureColor = smoothstep(green, red, vec3(curvature - cutoff));
                //debugCurvatureColor = step(red, vec3(curvature - cutoff));
                //debugCurvatureColor = step(green, vec3(curvature - cutoff));
                //gl_FragColor = vec4(vec3(curvature), 1./16.);
            `;d.fragmentShader=shaderReplaceString(d.fragmentShader,"#include <dithering_fragment>",C),d.vertexUvs=!0},onObjectRender:(d,o)=>{var l,c,u,h,_,A,w;const C=o.materialObject.userData;if(!(!((l=C==null?void 0:C._layeredMaterial)===null||l===void 0)&&l.enable))return;const M=d;M.isMesh&&M.geometry&&(this._uniforms.cutoff.value=(c=C._layeredMaterial)===null||c===void 0?void 0:c.cutoff,this._uniforms.cavityRoughness.value=(u=C._layeredMaterial)===null||u===void 0?void 0:u.cavityRoughness,this._uniforms.cavityMetalness.value=(h=C._layeredMaterial)===null||h===void 0?void 0:h.cavityMetalness,this._uniforms.cavityScale.value=(_=C._layeredMaterial)===null||_===void 0?void 0:_.cavityScale,this._uniforms.stepSize.value=(A=C._layeredMaterial)===null||A===void 0?void 0:A.stepSize,this._uniforms.cavityColor.value.copy((w=C._layeredMaterial)===null||w===void 0?void 0:w.cavityColor))},extraUniforms:{...this._uniforms},computeCacheKey:d=>{var o,l;return(this.enabled?"1":"0")+(!((l=(o=d.materialObject.userData)===null||o===void 0?void 0:o._layeredMaterial)===null||l===void 0)&&l.enable?"1":"0")},isCompatible:d=>d.isMeshStandardMaterial2,updaters:()=>{var d;return[(d=this._viewer)===null||d===void 0?void 0:d.renderer]},getUiConfig:d=>{const o=this._viewer,l=this.addLayeredMaterial,c={type:"folder",label:"LayeredMaterial",children:[{type:"checkbox",label:"Enabled",get value(){var u;return((u=d.materialObject.userData._layeredMaterial)===null||u===void 0?void 0:u.enable)||!1},set value(u){var h,_;u!==((h=d.materialObject.userData._layeredMaterial)===null||h===void 0?void 0:h.enable)&&(u?l(d)||o.alert("Cannot add Triplanar mapping."):(d.materialObject.userData._layeredMaterial.enable=!1,d.materialObject.needsUpdate=!0),(_=c.uiRefresh)===null||_===void 0||_.call(c,"postFrame",!0))},onChange:this.setDirty},()=>({type:"slider",bounds:[-1,1],stepSize:.001,label:"cutoff",hidden:()=>{var u;return!(!((u=d.materialObject.userData._layeredMaterial)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._layeredMaterial,"cutoff"],onChange:this.setDirty}),()=>({type:"color",label:"color",hidden:()=>{var u;return!(!((u=d.materialObject.userData._layeredMaterial)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._layeredMaterial,"cavityColor"],onChange:this.setDirty}),()=>({type:"slider",bounds:[0,1],stepSize:.01,label:"roughness",hidden:()=>{var u;return!(!((u=d.materialObject.userData._layeredMaterial)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._layeredMaterial,"cavityRoughness"],onChange:this.setDirty}),()=>({type:"slider",bounds:[.1,20],stepSize:.01,label:"Scale",hidden:()=>{var u;return!(!((u=d.materialObject.userData._layeredMaterial)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._layeredMaterial,"cavityScale"],onChange:this.setDirty}),()=>({type:"slider",bounds:[.1,100],stepSize:.01,label:"StepSize",hidden:()=>{var u;return!(!((u=d.materialObject.userData._layeredMaterial)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._layeredMaterial,"stepSize"],onChange:this.setDirty}),()=>({type:"slider",bounds:[0,1],stepSize:.01,label:"metalness",hidden:()=>{var u;return!(!((u=d.materialObject.userData._layeredMaterial)===null||u===void 0)&&u.enable)},property:[d.materialObject.userData._layeredMaterial,"cavityMetalness"],onChange:this.setDirty})]};return c}},this.setDirty=()=>{var d;(d=this._viewer)===null||d===void 0||d.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(d){var o,l,c,u,h;await super.onAdded(d);const _=d.getPlugin(AssetManagerPlugin);(o=_==null?void 0:_.materials)===null||o===void 0||o.registerMaterialExtension(this.materialExtension),(l=_==null?void 0:_.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=_==null?void 0:_.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(glTFLayeredMaterialsExtensionExport)}async onRemove(d){var o,l,c,u;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(d)}};LayeredMaterialPlugin.PluginType="LayeredMaterialPlugin",LayeredMaterialPlugin.LAYERED_MATERIAL_GLTF_EXTENSION="WEBGI_materials_layered",LayeredMaterialPlugin_decorate([uiToggle("Enabled",d=>({onChange:d.setDirty})),serialize()],LayeredMaterialPlugin.prototype,"enabled",void 0),LayeredMaterialPlugin=LayeredMaterialPlugin_decorate([uiFolder("Layered Metal")],LayeredMaterialPlugin);class GLTFLayeredMaterialsExtensionImport{constructor(o){this.parser=o,this.name=LayeredMaterialPlugin.LAYERED_MATERIAL_GLTF_EXTENSION}async extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name];l.userData||(l.userData={});const h=l.userData;return h._layeredMaterial||(h._layeredMaterial={}),h._layeredMaterial.enable=!0,l.userData._layeredMaterial=deserializeObject(u,l.userData._layeredMaterial,!1,{}),Promise.resolve()}}const glTFLayeredMaterialsExtensionExport=d=>({writeMaterial:(o,l)=>{var c;if(!o.isMeshStandardMaterial||!(!((c=o.userData._layeredMaterial)===null||c===void 0)&&c.enable))return;l.extensions=l.extensions||{};const u=serializeObject(o.userData._layeredMaterial,!1);l.extensions[LayeredMaterialPlugin.LAYERED_MATERIAL_GLTF_EXTENSION]=u,d.extensionsUsed[LayeredMaterialPlugin.LAYERED_MATERIAL_GLTF_EXTENSION]=!0}});var ClearcoatTintPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let ClearcoatTintPlugin=class extends AViewerPlugin{addClearcoatTint(d){return addClearcoatTint(d.materialObject)}_loaderCreate({loader:d}){d.isGLTFLoader2&&d.register(o=>new GLTFMaterialsClearcoatTintExtensionImport(o))}constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin],this._defines={},this._uniforms={ccTintColor:{value:new three_module.Q1f},ccThickness:{value:0},ccIor:{value:0}},this.materialExtension={parsFragmentSnippet:(d,o)=>{var l;return this.enabled&&(!((l=o==null?void 0:o.materialObject.userData._clearcoatTint)===null||l===void 0)&&l.enableTint)&&o.materialObject.clearcoat>0?`
uniform vec3 ccTintColor;
uniform float ccThickness;
uniform float ccIor;
vec3 clearcoatTint(const in float dotNV, const in float dotNL, const in float clearcoat) {
    vec3 tint = ( ccThickness > 0. ? 1. - ccTintColor : ccTintColor); // Set thickness < 0 for glow.
    tint = exp(tint * -(ccThickness * ((dotNL + dotNV) / max(dotNL * dotNV, 1e-3)))); // beer's law
    return mix(vec3(1.0), tint, clearcoat);
}
        `:""},shaderExtender:(d,o,l)=>{var c;if(!(this.enabled&&(!((c=o==null?void 0:o.materialObject.userData._clearcoatTint)===null||c===void 0)&&c.enableTint)&&o.materialObject.clearcoat>0))return;const u="outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;",h="float dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );";d.fragmentShader.includes(h)&&d.fragmentShader.includes(u)||console.error("ClearcoatTintPlugin: shaderExtender cannot patch shader, version changed?"),d.fragmentShader=d.fragmentShader.replace(h,`
            float dotNVcc = saturate( dot( geometryClearcoatNormal, -refract(geometryViewDir, geometryClearcoatNormal, 1./ccIor) ) );
            `),d.fragmentShader=d.fragmentShader.replace(u,`
            outgoingLight *= clearcoatTint(dotNVcc, dotNVcc, material.clearcoat);
            `+u),d.defines.USE_UV=""},onObjectRender:(d,o)=>{var l;const c=(l=o.materialObject.userData)===null||l===void 0?void 0:l._clearcoatTint;if(!(c!=null&&c.enableTint))return;this._uniforms.ccTintColor.value.set(c.tintColor),this._uniforms.ccThickness.value=c.thickness,this._uniforms.ccIor.value=c.ior;const u=this.enabled?1:0;o.materialObject.defines.CLEARCOAT_TINT_ENABLED!==u&&(o.materialObject.defines.CLEARCOAT_TINT_ENABLED=u,o.materialObject.needsUpdate=!0)},extraUniforms:{...this._uniforms},computeCacheKey:d=>{var o,l;return(this.enabled?"1":"0")+(!((l=(o=d.materialObject.userData)===null||o===void 0?void 0:o._clearcoatTint)===null||l===void 0)&&l.enableTint?"1":"0")+(d.materialObject.clearcoat>0?"1":"0")},isCompatible:d=>d.isMeshStandardMaterial2,updaters:()=>[],getUiConfig:d=>{const o=this._viewer,l={type:"folder",label:"ClearcoatTint",children:[{type:"checkbox",label:"Enabled",get value(){var c;return((c=d.materialObject.userData._clearcoatTint)===null||c===void 0?void 0:c.enableTint)||!1},set value(c){var u,h;c!==((u=d.materialObject.userData._clearcoatTint)===null||u===void 0?void 0:u.enableTint)&&(c?addClearcoatTint(d.materialObject)||o.alert("Cannot add clearcoat tint."):d.materialObject.userData._clearcoatTint&&(d.materialObject.userData._clearcoatTint.enableTint=!1,d.materialObject.needsUpdate=!0),(h=l.uiRefresh)===null||h===void 0||h.call(l,"postFrame",!0))},onChange:this.setDirty},()=>({type:"color",label:"Tint color",hidden:()=>{var c;return!(!((c=d.materialObject.userData._clearcoatTint)===null||c===void 0)&&c.enableTint)},property:[d.materialObject.userData._clearcoatTint,"tintColor"],onChange:this.setDirty}),()=>({type:"input",label:"Thickness",hidden:()=>{var c;return!(!((c=d.materialObject.userData._clearcoatTint)===null||c===void 0)&&c.enableTint)},property:[d.materialObject.userData._clearcoatTint,"thickness"],onChange:this.setDirty}),()=>({type:"slider",bounds:[.8,2.5],label:"IOR",hidden:()=>{var c;return!(!((c=d.materialObject.userData._clearcoatTint)===null||c===void 0)&&c.enableTint)},property:[d.materialObject.userData._clearcoatTint,"ior"],onChange:this.setDirty})]};return l}},this.setDirty=()=>{var d,o,l;(o=(d=this.materialExtension).setDirty)===null||o===void 0||o.call(d),(l=this._viewer)===null||l===void 0||l.setDirty()},this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(d){var o,l,c,u,h;await super.onAdded(d);const _=d.getPlugin(AssetManagerPlugin);(o=_==null?void 0:_.materials)===null||o===void 0||o.registerMaterialExtension(this.materialExtension),(l=_==null?void 0:_.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate),(h=(u=(c=_==null?void 0:_.exporter)===null||c===void 0?void 0:c.getExporter("gltf","glb"))===null||u===void 0?void 0:u.extensions)===null||h===void 0||h.push(glTFMaterialsClearcoatTintExtensionExport)}async onRemove(d){var o,l,c,u;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this.materialExtension),(u=(c=d.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.importer)===null||u===void 0||u.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(d)}};function addClearcoatTint(d){const o=d==null?void 0:d.userData;if(!o)return!1;o._clearcoatTint||(o._clearcoatTint={});const l=o._clearcoatTint;return l.enableTint=!0,l.tintColor===void 0&&(l.tintColor=16777215),l.thickness===void 0&&(l.thickness=.1),l.ior===void 0&&(l.ior=1.5),d.isMaterial&&(d.needsUpdate=!0),!0}ClearcoatTintPlugin.PluginType="ClearcoatTintPlugin",ClearcoatTintPlugin.CLEARCOAT_TINT_GLTF_EXTENSION="WEBGI_materials_clearcoat_tint",ClearcoatTintPlugin_decorate([uiToggle("Enabled",d=>({onChange:d.setDirty})),serialize()],ClearcoatTintPlugin.prototype,"enabled",void 0),ClearcoatTintPlugin=ClearcoatTintPlugin_decorate([uiFolder("ClearcoatTint Materials")],ClearcoatTintPlugin);class GLTFMaterialsClearcoatTintExtensionImport{constructor(o){this.parser=o,this.name=ClearcoatTintPlugin.CLEARCOAT_TINT_GLTF_EXTENSION}async extendMaterialParams(o,l){const c=this.parser.json.materials[o];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();const u=c.extensions[this.name];return l.userData||(l.userData={}),addClearcoatTint(l),deserializeObject(u,l.userData._clearcoatTint,!1,{}),Promise.resolve()}}const glTFMaterialsClearcoatTintExtensionExport=d=>({writeMaterial:(o,l)=>{if(!o.isMeshStandardMaterial||!o.userData._clearcoatTint||!o.userData._clearcoatTint.enableTint)return;l.extensions=l.extensions||{};const c=serializeObject(o.userData._clearcoatTint,!1);l.extensions[ClearcoatTintPlugin.CLEARCOAT_TINT_GLTF_EXTENSION]=c,d.extensionsUsed[ClearcoatTintPlugin.CLEARCOAT_TINT_GLTF_EXTENSION]=!0}});class WorkerPool{constructor(o=4){this.pool=o,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(o){if(!this.workers[o]){const l=this.workerCreator();l.addEventListener("message",this._onMessage.bind(this,o)),this.workers[o]=l}}_getIdleWorker(){for(let o=0;o<this.pool;o++)if(!(this.workerStatus&1<<o))return o;return-1}_onMessage(o,l){const c=this.workersResolve[o];if(c&&c(l),this.queue.length){const{resolve:u,msg:h,transfer:_}=this.queue.shift();this.workersResolve[o]=u,this.workers[o].postMessage(h,_)}else this.workerStatus^=1<<o}setWorkerCreator(o){this.workerCreator=o}setWorkerLimit(o){this.pool=o}postMessage(o,l){return new Promise(c=>{const u=this._getIdleWorker();u!==-1?(this._initWorker(u),this.workerStatus|=1<<u,this.workersResolve[u]=c,this.workers[u].postMessage(o,l)):this.queue.push({resolve:c,msg:o,transfer:l})})}dispose(){this.workers.forEach(o=>o.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const ktx_parse_module_t=0,n=2,ktx_parse_module_p=1,ktx_parse_module_x=2,ktx_parse_module_E=0,ktx_parse_module_F=1,ktx_parse_module_X=10,ktx_parse_module_nt=0,ktx_parse_module_ct=9,gt=15,yt=16,dt=22,Ot=37,Ft=43,$t=76,ktx_parse_module_se=83,ktx_parse_module_pe=97,ktx_parse_module_xe=100,ktx_parse_module_de=103,ktx_parse_module_Ae=109,Sn=165,In=166;class Si{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class Ii{constructor(o,l,c,u){this._dataView=new DataView(o.buffer,o.byteOffset+l,c),this._littleEndian=u,this._offset=0}_nextUint8(){const o=this._dataView.getUint8(this._offset);return this._offset+=1,o}_nextUint16(){const o=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,o}_nextUint32(){const o=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,o}_nextUint64(){const o=this._dataView.getUint32(this._offset,this._littleEndian)+4294967296*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,o}_nextInt32(){const o=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,o}_skip(o){return this._offset+=o,this}_scan(o,l=0){const c=this._offset;let u=0;for(;this._dataView.getUint8(this._offset)!==l&&u<o;)u++,this._offset++;return u<o&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+c,u)}}const Ti=[171,75,84,88,32,50,48,187,13,10,26,10];function Ei(d){return typeof TextDecoder<"u"?new TextDecoder().decode(d):Buffer.from(d).toString("utf8")}function Pi(d){const o=new Uint8Array(d.buffer,d.byteOffset,Ti.length);if(o[0]!==Ti[0]||o[1]!==Ti[1]||o[2]!==Ti[2]||o[3]!==Ti[3]||o[4]!==Ti[4]||o[5]!==Ti[5]||o[6]!==Ti[6]||o[7]!==Ti[7]||o[8]!==Ti[8]||o[9]!==Ti[9]||o[10]!==Ti[10]||o[11]!==Ti[11])throw new Error("Missing KTX 2.0 identifier.");const l=new Si,c=17*Uint32Array.BYTES_PER_ELEMENT,u=new Ii(d,Ti.length,c,!0);l.vkFormat=u._nextUint32(),l.typeSize=u._nextUint32(),l.pixelWidth=u._nextUint32(),l.pixelHeight=u._nextUint32(),l.pixelDepth=u._nextUint32(),l.layerCount=u._nextUint32(),l.faceCount=u._nextUint32();const h=u._nextUint32();l.supercompressionScheme=u._nextUint32();const _=u._nextUint32(),A=u._nextUint32(),w=u._nextUint32(),C=u._nextUint32(),M=u._nextUint64(),O=u._nextUint64(),ne=new Ii(d,Ti.length+c,3*h*8,!0);for(let Vt=0;Vt<h;Vt++)l.levels.push({levelData:new Uint8Array(d.buffer,d.byteOffset+ne._nextUint64(),ne._nextUint64()),uncompressedByteLength:ne._nextUint64()});const ce=new Ii(d,_,A,!0),ue={vendorId:ce._skip(4)._nextUint16(),descriptorType:ce._nextUint16(),versionNumber:ce._nextUint16(),descriptorBlockSize:ce._nextUint16(),colorModel:ce._nextUint8(),colorPrimaries:ce._nextUint8(),transferFunction:ce._nextUint8(),flags:ce._nextUint8(),texelBlockDimension:[ce._nextUint8(),ce._nextUint8(),ce._nextUint8(),ce._nextUint8()],bytesPlane:[ce._nextUint8(),ce._nextUint8(),ce._nextUint8(),ce._nextUint8(),ce._nextUint8(),ce._nextUint8(),ce._nextUint8(),ce._nextUint8()],samples:[]},ye=(ue.descriptorBlockSize/4-6)/4;for(let Vt=0;Vt<ye;Vt++){const si={bitOffset:ce._nextUint16(),bitLength:ce._nextUint8(),channelType:ce._nextUint8(),samplePosition:[ce._nextUint8(),ce._nextUint8(),ce._nextUint8(),ce._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&si.channelType?(si.sampleLower=ce._nextInt32(),si.sampleUpper=ce._nextInt32()):(si.sampleLower=ce._nextUint32(),si.sampleUpper=ce._nextUint32()),ue.samples[Vt]=si}l.dataFormatDescriptor.length=0,l.dataFormatDescriptor.push(ue);const Oe=new Ii(d,w,C,!0);for(;Oe._offset<C;){const Vt=Oe._nextUint32(),si=Oe._scan(Vt),Jt=Ei(si),Wt=Oe._scan(Vt-si.byteLength);l.keyValue[Jt]=Jt.match(/^ktx/i)?Ei(Wt):Wt,Oe._offset%4&&Oe._skip(4-Oe._offset%4)}if(O<=0)return l;const ke=new Ii(d,M,O,!0),Ve=ke._nextUint16(),tt=ke._nextUint16(),ht=ke._nextUint32(),ut=ke._nextUint32(),_t=ke._nextUint32(),at=ke._nextUint32(),lt=[];for(let Vt=0;Vt<h;Vt++)lt.push({imageFlags:ke._nextUint32(),rgbSliceByteOffset:ke._nextUint32(),rgbSliceByteLength:ke._nextUint32(),alphaSliceByteOffset:ke._nextUint32(),alphaSliceByteLength:ke._nextUint32()});const pt=M+ke._offset,xt=pt+ht,Tt=xt+ut,Pt=Tt+_t,Lt=new Uint8Array(d.buffer,d.byteOffset+pt,ht),Bt=new Uint8Array(d.buffer,d.byteOffset+xt,ut),Ut=new Uint8Array(d.buffer,d.byteOffset+Tt,_t),kt=new Uint8Array(d.buffer,d.byteOffset+Pt,at);return l.globalData={endpointCount:Ve,selectorCount:tt,imageDescs:lt,endpointsData:Lt,selectorsData:Bt,tablesData:Ut,extendedData:kt},l}let zstddec_module_A,zstddec_module_I,zstddec_module_B;const zstddec_module_g={env:{emscripten_notify_memory_growth:function(d){zstddec_module_B=new Uint8Array(zstddec_module_I.exports.memory.buffer)}}};class zstddec_module_Q{init(){return zstddec_module_A||(zstddec_module_A=typeof fetch<"u"?fetch("data:application/wasm;base64,"+zstddec_module_C).then(o=>o.arrayBuffer()).then(o=>WebAssembly.instantiate(o,zstddec_module_g)).then(this._init):WebAssembly.instantiate(Buffer.from(zstddec_module_C,"base64"),zstddec_module_g).then(this._init),zstddec_module_A)}_init(o){zstddec_module_I=o.instance,zstddec_module_g.env.emscripten_notify_memory_growth(0)}decode(o,l=0){if(!zstddec_module_I)throw new Error("ZSTDDecoder: Await .init() before decoding.");const c=o.byteLength,u=zstddec_module_I.exports.malloc(c);zstddec_module_B.set(o,u),l=l||Number(zstddec_module_I.exports.ZSTD_findDecompressedSize(u,c));const h=zstddec_module_I.exports.malloc(l),_=zstddec_module_I.exports.ZSTD_decompress(h,l,u,c),A=zstddec_module_B.slice(h,h+_);return zstddec_module_I.exports.free(u),zstddec_module_I.exports.free(h),A}}const zstddec_module_C="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ",_taskCache=new WeakMap;let _activeLoaders=0,_zstd;class KTX2Loader extends three_module.aHM{constructor(o){super(o),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new WorkerPool,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(o){return this.transcoderPath=o,this}setWorkerLimit(o){return this.workerPool.setWorkerLimit(o),this}detectSupport(o){return o.isWebGPURenderer===!0?this.workerConfig={astcSupported:o.hasFeature("texture-compression-astc"),etc1Supported:!1,etc2Supported:o.hasFeature("texture-compression-etc2"),dxtSupported:o.hasFeature("texture-compression-bc"),bptcSupported:!1,pvrtcSupported:!1}:(this.workerConfig={astcSupported:o.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:o.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:o.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:o.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:o.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:o.extensions.has("WEBGL_compressed_texture_pvrtc")||o.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},o.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1)),this}init(){if(!this.transcoderPending){const o=new three_module.Y9S(this.manager);o.setPath(this.transcoderPath),o.setWithCredentials(this.withCredentials);const l=o.loadAsync("basis_transcoder.js"),c=new three_module.Y9S(this.manager);c.setPath(this.transcoderPath),c.setResponseType("arraybuffer"),c.setWithCredentials(this.withCredentials);const u=c.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([l,u]).then(([h,_])=>{const A=KTX2Loader.BasisWorker,w=["/* constants */","let _EngineFormat = "+JSON.stringify(KTX2Loader.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(KTX2Loader.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(KTX2Loader.BasisFormat),"/* basis_transcoder.js */",h,"/* worker */",A.substring(A.indexOf("{")+1,A.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([w])),this.transcoderBinary=_,this.workerPool.setWorkerCreator(()=>{const C=new Worker(this.workerSourceURL),M=this.transcoderBinary.slice(0);return C.postMessage({type:"init",config:this.workerConfig,transcoderBinary:M},[M]),C})}),_activeLoaders>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),_activeLoaders++}return this.transcoderPending}load(o,l,c,u){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const h=new three_module.Y9S(this.manager);h.setResponseType("arraybuffer"),h.setCrossOrigin(this.crossOrigin),h.setWithCredentials(this.withCredentials),h.load(o,_=>{if(_taskCache.has(_))return _taskCache.get(_).promise.then(l).catch(u);this.createTexture(_).then(A=>l?l(A):null).catch(u)},c,u)}_createTextureFrom(o,l){const{faces:c,width:u,height:h,format:_,type:A,error:w,dfdFlags:C}=o;if(A==="error")return Promise.reject(w);let M;if(l.faceCount===6)M=new three_module.c5h(c,_,three_module.OUM);else{const O=c[0].mipmaps;M=l.layerCount>1?new three_module.iOZ(O,u,h,l.layerCount,_,three_module.OUM):new three_module.FvD(O,u,h,_,three_module.OUM)}return M.minFilter=c[0].mipmaps.length===1?three_module.k6q:three_module.$_I,M.magFilter=three_module.k6q,M.generateMipmaps=!1,M.needsUpdate=!0,M.colorSpace=parseColorSpace(l),M.premultiplyAlpha=!!(C&ktx_parse_module_p),M}async createTexture(o,l={}){const c=Pi(new Uint8Array(o));if(c.vkFormat!==ktx_parse_module_nt)return createRawTexture(c);const u=l,h=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:o,taskConfig:u},[o])).then(_=>this._createTextureFrom(_.data,c));return _taskCache.set(o,{promise:h}),h}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),_activeLoaders--,this}}KTX2Loader.BasisFormat={ETC1S:0,UASTC_4x4:1},KTX2Loader.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},KTX2Loader.EngineFormat={RGBAFormat:three_module.GWd,RGBA_ASTC_4x4_Format:three_module.qa3,RGBA_BPTC_Format:three_module.Fn,RGBA_ETC2_EAC_Format:three_module.KDk,RGBA_PVRTC_4BPPV1_Format:three_module.HXV,RGBA_S3TC_DXT5_Format:three_module.BXX,RGB_ETC1_Format:three_module.CVz,RGB_ETC2_Format:three_module.Riy,RGB_PVRTC_4BPPV1_Format:three_module.k6Q,RGB_S3TC_DXT1_Format:three_module.IE4},KTX2Loader.BasisWorker=`function () {

	let config;
	let transcoderPending;
	let BasisModule;

	const EngineFormat = _EngineFormat; // eslint-disable-line no-undef
	const TranscoderFormat = _TranscoderFormat; // eslint-disable-line no-undef
	const BasisFormat = _BasisFormat; // eslint-disable-line no-undef

	self.addEventListener( 'message', function ( e ) {

		const message = e.data;

		switch ( message.type ) {

			case 'init':
				config = message.config;
				init( message.transcoderBinary );
				break;

			case 'transcode':
				transcoderPending.then( () => {

					try {

						const { faces, buffers, width, height, hasAlpha, format, dfdFlags } = transcode( message.buffer );

						self.postMessage( { type: 'transcode', id: message.id, faces, width, height, hasAlpha, format, dfdFlags }, buffers );

					} catch ( error ) {

						console.error( error );

						self.postMessage( { type: 'error', id: message.id, error: error.message } );

					}

				} );
				break;

		}

	} );

	function init( wasmBinary ) {

		transcoderPending = new Promise( ( resolve ) => {

			BasisModule = { wasmBinary, onRuntimeInitialized: resolve };
			BASIS( BasisModule ); // eslint-disable-line no-undef

		} ).then( () => {

			BasisModule.initializeBasis();

			if ( BasisModule.KTX2File === undefined ) {

				console.warn( 'THREE.KTX2Loader: Please update Basis Universal transcoder.' );

			}

		} );

	}

	function transcode( buffer ) {

		const ktx2File = new BasisModule.KTX2File( new Uint8Array( buffer ) );

		function cleanup() {

			ktx2File.close();
			ktx2File.delete();

		}

		if ( ! ktx2File.isValid() ) {

			cleanup();
			throw new Error( 'THREE.KTX2Loader:	Invalid or unsupported .ktx2 file' );

		}

		const basisFormat = ktx2File.isUASTC() ? BasisFormat.UASTC_4x4 : BasisFormat.ETC1S;
		const width = ktx2File.getWidth();
		const height = ktx2File.getHeight();
		const layerCount = ktx2File.getLayers() || 1;
		const levelCount = ktx2File.getLevels();
		const faceCount = ktx2File.getFaces();
		const hasAlpha = ktx2File.getHasAlpha();
		const dfdFlags = ktx2File.getDFDFlags();

		const { transcoderFormat, engineFormat } = getTranscoderFormat( basisFormat, width, height, hasAlpha );

		if ( ! width || ! height || ! levelCount ) {

			cleanup();
			throw new Error( 'THREE.KTX2Loader:	Invalid texture' );

		}

		if ( ! ktx2File.startTranscoding() ) {

			cleanup();
			throw new Error( 'THREE.KTX2Loader: .startTranscoding failed' );

		}

		const faces = [];
		const buffers = [];

		for ( let face = 0; face < faceCount; face ++ ) {

			const mipmaps = [];

			for ( let mip = 0; mip < levelCount; mip ++ ) {

				const layerMips = [];

				let mipWidth, mipHeight;

				for ( let layer = 0; layer < layerCount; layer ++ ) {

					const levelInfo = ktx2File.getImageLevelInfo( mip, layer, face );

					if ( face === 0 && mip === 0 && layer === 0 && ( levelInfo.origWidth % 4 !== 0 || levelInfo.origHeight % 4 !== 0 ) ) {

						console.warn( 'THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions.' );

					}

					if ( levelCount > 1 ) {

						mipWidth = levelInfo.origWidth;
						mipHeight = levelInfo.origHeight;

					} else {

						// Handles non-multiple-of-four dimensions in textures without mipmaps. Textures with
						// mipmaps must use multiple-of-four dimensions, for some texture formats and APIs.
						// See mrdoob/three.js#25908.
						mipWidth = levelInfo.width;
						mipHeight = levelInfo.height;

					}

					const dst = new Uint8Array( ktx2File.getImageTranscodedSizeInBytes( mip, layer, 0, transcoderFormat ) );
					const status = ktx2File.transcodeImage( dst, mip, layer, face, transcoderFormat, 0, - 1, - 1 );

					if ( ! status ) {

						cleanup();
						throw new Error( 'THREE.KTX2Loader: .transcodeImage failed.' );

					}

					layerMips.push( dst );

				}

				const mipData = concat( layerMips );

				mipmaps.push( { data: mipData, width: mipWidth, height: mipHeight } );
				buffers.push( mipData.buffer );

			}

			faces.push( { mipmaps, width, height, format: engineFormat } );

		}

		cleanup();

		return { faces, buffers, width, height, hasAlpha, format: engineFormat, dfdFlags };

	}

	//

	// Optimal choice of a transcoder target format depends on the Basis format (ETC1S or UASTC),
	// device capabilities, and texture dimensions. The list below ranks the formats separately
	// for ETC1S and UASTC.
	//
	// In some cases, transcoding UASTC to RGBA32 might be preferred for higher quality (at
	// significant memory cost) compared to ETC1/2, BC1/3, and PVRTC. The transcoder currently
	// chooses RGBA32 only as a last resort and does not expose that option to the caller.
	const FORMAT_OPTIONS = [
		{
			if: 'astcSupported',
			basisFormat: [ BasisFormat.UASTC_4x4 ],
			transcoderFormat: [ TranscoderFormat.ASTC_4x4, TranscoderFormat.ASTC_4x4 ],
			engineFormat: [ EngineFormat.RGBA_ASTC_4x4_Format, EngineFormat.RGBA_ASTC_4x4_Format ],
			priorityETC1S: Infinity,
			priorityUASTC: 1,
			needsPowerOfTwo: false,
		},
		{
			if: 'bptcSupported',
			basisFormat: [ BasisFormat.ETC1S, BasisFormat.UASTC_4x4 ],
			transcoderFormat: [ TranscoderFormat.BC7_M5, TranscoderFormat.BC7_M5 ],
			engineFormat: [ EngineFormat.RGBA_BPTC_Format, EngineFormat.RGBA_BPTC_Format ],
			priorityETC1S: 3,
			priorityUASTC: 2,
			needsPowerOfTwo: false,
		},
		{
			if: 'dxtSupported',
			basisFormat: [ BasisFormat.ETC1S, BasisFormat.UASTC_4x4 ],
			transcoderFormat: [ TranscoderFormat.BC1, TranscoderFormat.BC3 ],
			engineFormat: [ EngineFormat.RGB_S3TC_DXT1_Format, EngineFormat.RGBA_S3TC_DXT5_Format ],
			priorityETC1S: 4,
			priorityUASTC: 5,
			needsPowerOfTwo: false,
		},
		{
			if: 'etc2Supported',
			basisFormat: [ BasisFormat.ETC1S, BasisFormat.UASTC_4x4 ],
			transcoderFormat: [ TranscoderFormat.ETC1, TranscoderFormat.ETC2 ],
			engineFormat: [ EngineFormat.RGB_ETC2_Format, EngineFormat.RGBA_ETC2_EAC_Format ],
			priorityETC1S: 1,
			priorityUASTC: 3,
			needsPowerOfTwo: false,
		},
		{
			if: 'etc1Supported',
			basisFormat: [ BasisFormat.ETC1S, BasisFormat.UASTC_4x4 ],
			transcoderFormat: [ TranscoderFormat.ETC1 ],
			engineFormat: [ EngineFormat.RGB_ETC1_Format ],
			priorityETC1S: 2,
			priorityUASTC: 4,
			needsPowerOfTwo: false,
		},
		{
			if: 'pvrtcSupported',
			basisFormat: [ BasisFormat.ETC1S, BasisFormat.UASTC_4x4 ],
			transcoderFormat: [ TranscoderFormat.PVRTC1_4_RGB, TranscoderFormat.PVRTC1_4_RGBA ],
			engineFormat: [ EngineFormat.RGB_PVRTC_4BPPV1_Format, EngineFormat.RGBA_PVRTC_4BPPV1_Format ],
			priorityETC1S: 5,
			priorityUASTC: 6,
			needsPowerOfTwo: true,
		},
	];

	const ETC1S_OPTIONS = FORMAT_OPTIONS.sort( function ( a, b ) {

		return a.priorityETC1S - b.priorityETC1S;

	} );
	const UASTC_OPTIONS = FORMAT_OPTIONS.sort( function ( a, b ) {

		return a.priorityUASTC - b.priorityUASTC;

	} );

	function getTranscoderFormat( basisFormat, width, height, hasAlpha ) {

		let transcoderFormat;
		let engineFormat;

		const options = basisFormat === BasisFormat.ETC1S ? ETC1S_OPTIONS : UASTC_OPTIONS;

		for ( let i = 0; i < options.length; i ++ ) {

			const opt = options[ i ];

			if ( ! config[ opt.if ] ) continue;
			if ( ! opt.basisFormat.includes( basisFormat ) ) continue;
			if ( hasAlpha && opt.transcoderFormat.length < 2 ) continue;
			if ( opt.needsPowerOfTwo && ! ( isPowerOfTwo( width ) && isPowerOfTwo( height ) ) ) continue;

			transcoderFormat = opt.transcoderFormat[ hasAlpha ? 1 : 0 ];
			engineFormat = opt.engineFormat[ hasAlpha ? 1 : 0 ];

			return { transcoderFormat, engineFormat };

		}

		console.warn( 'THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32.' );

		transcoderFormat = TranscoderFormat.RGBA32;
		engineFormat = EngineFormat.RGBAFormat;

		return { transcoderFormat, engineFormat };

	}

	function isPowerOfTwo( value ) {

		if ( value <= 2 ) return true;

		return ( value & ( value - 1 ) ) === 0 && value !== 0;

	}

	/** Concatenates N byte arrays. */
	function concat( arrays ) {

		if ( arrays.length === 1 ) return arrays[ 0 ];

		let totalByteLength = 0;

		for ( let i = 0; i < arrays.length; i ++ ) {

			const array = arrays[ i ];
			totalByteLength += array.byteLength;

		}

		const result = new Uint8Array( totalByteLength );

		let byteOffset = 0;

		for ( let i = 0; i < arrays.length; i ++ ) {

			const array = arrays[ i ];
			result.set( array, byteOffset );

			byteOffset += array.byteLength;

		}

		return result;

	}

}`;const UNCOMPRESSED_FORMATS=new Set([three_module.GWd,three_module.paN,three_module.VT0]),FORMAT_MAP={[ktx_parse_module_Ae]:three_module.GWd,[ktx_parse_module_pe]:three_module.GWd,[Ot]:three_module.GWd,[Ft]:three_module.GWd,[ktx_parse_module_de]:three_module.paN,[ktx_parse_module_se]:three_module.paN,[yt]:three_module.paN,[dt]:three_module.paN,[ktx_parse_module_xe]:three_module.VT0,[$t]:three_module.VT0,[gt]:three_module.VT0,[ktx_parse_module_ct]:three_module.VT0,[In]:three_module.Qrf,[Sn]:three_module.Qrf},TYPE_MAP={[ktx_parse_module_Ae]:three_module.RQf,[ktx_parse_module_pe]:three_module.ix0,[Ot]:three_module.OUM,[Ft]:three_module.OUM,[ktx_parse_module_de]:three_module.RQf,[ktx_parse_module_se]:three_module.ix0,[yt]:three_module.OUM,[dt]:three_module.OUM,[ktx_parse_module_xe]:three_module.RQf,[$t]:three_module.ix0,[gt]:three_module.OUM,[ktx_parse_module_ct]:three_module.OUM,[In]:three_module.OUM,[Sn]:three_module.OUM};async function createRawTexture(d){const{vkFormat:o}=d;if(FORMAT_MAP[o]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let l;d.supercompressionScheme===n&&(_zstd||(_zstd=new Promise(async h=>{const _=new zstddec_module_Q;await _.init(),h(_)})),l=await _zstd);const c=[];for(let h=0;h<d.levels.length;h++){const _=Math.max(1,d.pixelWidth>>h),A=Math.max(1,d.pixelHeight>>h),w=d.pixelDepth?Math.max(1,d.pixelDepth>>h):0,C=d.levels[h];let M,O;if(d.supercompressionScheme===ktx_parse_module_t)M=C.levelData;else{if(d.supercompressionScheme!==n)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");M=l.decode(C.levelData,C.uncompressedByteLength)}O=TYPE_MAP[o]===three_module.RQf?new Float32Array(M.buffer,M.byteOffset,M.byteLength/Float32Array.BYTES_PER_ELEMENT):TYPE_MAP[o]===three_module.ix0?new Uint16Array(M.buffer,M.byteOffset,M.byteLength/Uint16Array.BYTES_PER_ELEMENT):M,c.push({data:O,width:_,height:A,depth:w})}let u;if(UNCOMPRESSED_FORMATS.has(FORMAT_MAP[o]))u=d.pixelDepth===0?new three_module.GYF(c[0].data,d.pixelWidth,d.pixelHeight):new three_module.dYF(c[0].data,d.pixelWidth,d.pixelHeight,d.pixelDepth);else{if(d.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");u=new three_module.FvD(c,d.pixelWidth,d.pixelHeight)}return u.mipmaps=c,u.type=TYPE_MAP[o],u.format=FORMAT_MAP[o],u.colorSpace=parseColorSpace(d),u.needsUpdate=!0,Promise.resolve(u)}function parseColorSpace(d){const o=d.dataFormatDescriptor[0];return o.colorPrimaries===ktx_parse_module_F?o.transferFunction===ktx_parse_module_x?three_module.er$:three_module.Zr2:o.colorPrimaries===ktx_parse_module_X?o.transferFunction===ktx_parse_module_x?three_module.V5c:three_module.qIQ:(o.colorPrimaries===ktx_parse_module_E||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${o.colorPrimaries}"`),three_module.jf0)}const KHR_TEXTURE_BASISU="KHR_texture_basisu";class KTX2LoadPlugin extends I{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin]}async onAdded(o){var l,c,u,h,_,A;this._importer||(this._importer=new Importer(class extends KTX2Loader{constructor(w){super(w),this.setTranscoderPath(KTX2LoadPlugin.TRANSCODER_LIBRARY_PATH).detectSupport(o.renderer.rendererObject)}async createTexture(w,C){const M=KTX2LoadPlugin.SAVE_SOURCE_BLOBS?new Uint8Array(w.slice(0)):void 0,O=await super.createTexture(w,C);return KTX2LoadPlugin.SAVE_SOURCE_BLOBS&&M&&(O.source._sourceImgBuffer=M,O.userData.mimeType="image/ktx2",O.source._canSerialize=!0,O.toJSON=ne=>serializeTextureInExtras(O,ne,O.name,"image/ktx2"),O.clone=()=>{throw new Error("ktx2 texture cloning not supported")}),O}},["ktx2"],!1)),(c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0||c.Importers.push(this._importer),(A=(_=(h=(u=o.getManager())===null||u===void 0?void 0:u.exporter)===null||h===void 0?void 0:h.getExporter("gltf","glb"))===null||_===void 0?void 0:_.extensions)===null||A===void 0||A.push(glTFTextureBasisUExtensionExport)}async onDispose(o){this._importer=void 0}async onRemove(o){var l,c;this._importer&&(!((c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0)&&c.Importers)&&o.getManager().importer.Importers.splice(o.getManager().importer.Importers.indexOf(this._importer),1),this._importer=void 0}}KTX2LoadPlugin.PluginType="KTX2LoadPlugin",KTX2LoadPlugin.TRANSCODER_LIBRARY_PATH="https://cdn.jsdelivr.net/gh/BinomialLLC/basis_universal@master/webgl/transcoder/build/",KTX2LoadPlugin.SAVE_SOURCE_BLOBS=!1;const glTFTextureBasisUExtensionExport=d=>({writeTexture:(o,l)=>{if(o.userData.mimeType!=="image/ktx2")return;if(l.source!==void 0&&l.source!==null)return void console.warn("ktx2 export: source already set");const c=o.source._sourceImgBuffer||o.userData.__sourceBuffer;if(!c)return void console.warn("ktx2 export: no source buffer for ktx2");l.extensions=l.extensions||{};const u={},h=new Blob([c],{type:"image/ktx2"});u.source=d.processImageBlob(h,o),l.extensions[KHR_TEXTURE_BASISU]=u,d.extensionsUsed[KHR_TEXTURE_BASISU]=!0}});class DebugPlugin extends I{constructor(){super(...arguments),this.dirty=!1,this.counters={},this._generators=new Map,this._preRender=()=>this._showDebug("preRender"),this._postRender=()=>this._showDebug("postRender")}async onAdded(o){this._viewer=o,o.addEventListener("preRender",this._preRender),o.addEventListener("postFrame",this._postRender)}addTexture(o,l,c,u,h,_="postRender",A=!1){var w;this._generators.has(_)||this._generators.set(_,[]),(w=this._generators.get(_))===null||w===void 0||w.push({key:o,fn:l,rect:c?[...c]:void 0,frag:h||u||A?new three_module.BKk({vertexShader:CopyShader.vertexShader,uniforms:{tDiffuse:{value:null},opacity:{value:1}},fragmentShader:h??`
        #include <common>
        #include <packing>
        uniform float opacity;
		uniform ${A?"samplerCube":"sampler2D"} tDiffuse;
		varying vec2 vUv;
		void main() {
			vec4 texel = ${A?"textureCube( tDiffuse, vec3(cos(vUv.y * PI2) * cos(vUv.x * PI2), sin(vUv.y * PI2), cos(vUv.y * PI2) * sin(vUv.x * PI2)) )":"texture2D( tDiffuse, vUv )"};
			${u??""}
			gl_FragColor = opacity * texel;
		}
            `}):void 0})}removeTexture(o,l="postRender"){var c,u;this._generators.set(l,(u=(c=this._generators.get(l))===null||c===void 0?void 0:c.filter(h=>h.key!==o))!==null&&u!==void 0?u:[])}async onDispose(o){return Promise.resolve(void 0)}async onRemove(o){return o.removeEventListener("preRender",this._preRender),o.removeEventListener("postRender",this._postRender),this._viewer=void 0,Promise.resolve(void 0)}_showDebug(o){var l;const c=this._viewer,u=c==null?void 0:c.renderer;u&&c&&((l=this._generators.get(o))===null||l===void 0||l.forEach(({key:h,fn:_,rect:A,frag:w})=>{const C=_(c);if(C){if(C.image&&A){const M=C.image.width/C.image.height;A[2]<1&&A[3]<1&&(A[2]=200),A[2]<1&&(A[2]=A[3]*M),A[3]<1&&(A[3]=A[2]/M)}u.blit(C,void 0,{viewport:A,clear:!1,material:w})}}))}}DebugPlugin.PluginType="debug";class MTLLoader2 extends three_module.aHM{constructor(o){super(o)}load(o,l,c,u){const h=this,_=this.path===""?three_module.r6x.extractUrlBase(o):this.path,A=new three_module.Y9S(this.manager);A.setPath(this.path),A.setRequestHeader(this.requestHeader),A.setWithCredentials(this.withCredentials),A.load(o,function(w){try{l(h.parse(w,_))}catch(C){u?u(C):console.error(C),h.manager.itemError(o)}},c,u)}setMaterialOptions(o){return this.materialOptions=o,this}parse(o,l){const c=o.split(`
`);let u={};const h=/\s+/,_={};for(let w=0;w<c.length;w++){let C=c[w];if(C=C.trim(),C.length===0||C.charAt(0)==="#")continue;const M=C.indexOf(" ");let O=M>=0?C.substring(0,M):C;O=O.toLowerCase();let ne=M>=0?C.substring(M+1):"";if(ne=ne.trim(),O==="newmtl")u={name:ne},_[ne]=u;else if(O==="ka"||O==="kd"||O==="ks"||O==="ke"){const ce=ne.split(h,3);u[O]=[parseFloat(ce[0]),parseFloat(ce[1]),parseFloat(ce[2])]}else u[O]=ne}const A=new MaterialCreator(this.resourcePath||l,this.materialOptions);return A.setCrossOrigin(this.crossOrigin),A.setManager(this.manager),A.setMaterials(_),A}}class MaterialCreator{constructor(o="",l={}){this.baseUrl=o,this.options=l,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.crossOrigin="anonymous",this.side=this.options.side!==void 0?this.options.side:three_module.hB5,this.wrap=this.options.wrap!==void 0?this.options.wrap:three_module.GJx}setCrossOrigin(o){return this.crossOrigin=o,this}setManager(o){this.manager=o}setMaterials(o){this.materialsInfo=this.convert(o),this.materials={},this.materialsArray=[],this.nameLookup={}}convert(o){if(!this.options)return o;const l={};for(const c in o){const u=o[c],h={};l[c]=h;for(const _ in u){let A=!0,w=u[_];const C=_.toLowerCase();switch(C){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(w=[w[0]/255,w[1]/255,w[2]/255]),this.options&&this.options.ignoreZeroRGBs&&w[0]===0&&w[1]===0&&w[2]===0&&(A=!1)}A&&(h[C]=w)}}return l}async preload(){for(const o in this.materialsInfo)await this.create(o)}getIndex(o){return this.nameLookup[o]}async getAsArray(){let o=0;for(const l in this.materialsInfo)this.materialsArray[o]=await this.create(l),this.nameLookup[l]=o,o++;return this.materialsArray}async create(o){return this.materials[o]===void 0&&await this.createMaterial_(o),this.materials[o]}async createMaterial_(o){const l=this,c=this.materialsInfo[o],u={name:o,side:this.side};async function h(w,C){if(u[w])return;const M=l.getTextureParams(C,u);return new Promise((O,ne)=>{let ce=!1,ue=()=>!ce&&(ce=!0)&&O();const ye=l.loadTexture((Oe=l.baseUrl,typeof(ke=M.url)!="string"||ke===""?"":/^https?:\/\//i.test(ke)?ke:Oe+ke),void 0,Ve=>{u[w]=Ve,ue()},void 0,ue);var Oe,ke;setTimeout(ue,50),ye.repeat.copy(M.scale),ye.offset.copy(M.offset),ye.wrapS=l.wrap,ye.wrapT=l.wrap,w!=="map"&&w!=="emissiveMap"||(ye.colorSpace=three_module.er$)})}const _=Array.from(Object.keys(c||{}));let A=_.includes("d")||_.includes("D");for(const w of _){const C=c[w];let M;if(C!=="")switch(w.toLowerCase()){case"kd":u.color=new three_module.Q1f().fromArray(C).convertSRGBToLinear();break;case"ks":u.specular=new three_module.Q1f().fromArray(C).convertSRGBToLinear();break;case"ke":u.emissive=new three_module.Q1f().fromArray(C).convertSRGBToLinear();break;case"map_kd":await h("map",C);break;case"map_ks":await h("specularMap",C);break;case"map_ke":await h("emissiveMap",C);break;case"norm":await h("normalMap",C);break;case"map_bump":case"bump":await h("bumpMap",C);break;case"map_d":await h("alphaMap",C),u.transparent=!0;break;case"ns":u.shininess=parseFloat(C);break;case"d":M=parseFloat(C),M<1&&(u.opacity=M,u.transparent=!0);break;case"tr":if(A)break;M=parseFloat(C),this.options&&this.options.invertTrProperty&&(M=1-M),M>0&&(u.opacity=1-M,u.transparent=!0)}}return this.materials[o]=new three_module.tXL(u),this.materials[o]}getTextureParams(o,l){const c={scale:new three_module.I9Y(1,1),offset:new three_module.I9Y(0,0)},u=o.split(/\s+/);let h;return h=u.indexOf("-bm"),h>=0&&(l.bumpScale=parseFloat(u[h+1]),u.splice(h,2)),h=u.indexOf("-s"),h>=0&&(c.scale.set(parseFloat(u[h+1]),parseFloat(u[h+2])),u.splice(h,4)),h=u.indexOf("-o"),h>=0&&(c.offset.set(parseFloat(u[h+1]),parseFloat(u[h+2])),u.splice(h,4)),c.url=u.join(" ").trim(),c}loadTexture(o,l,c,u,h){const _=this.manager!==void 0?this.manager:three_module.h_9;let A=_.getHandler(o);A===null&&(A=new three_module.Tap(_)),A.setCrossOrigin&&A.setCrossOrigin(this.crossOrigin);const w=A.load(o,c,u,h);return l!==void 0&&(w.mapping=l),w}}const _object_pattern=/^[og]\s*(.+)?/,_material_library_pattern=/^mtllib /,_material_use_pattern=/^usemtl /,_map_use_pattern=/^usemap /,_face_vertex_data_separator_pattern=/\s+/,_vA=new three_module.Pq0,_vB=new three_module.Pq0,_vC=new three_module.Pq0,_ab=new three_module.Pq0,_cb=new three_module.Pq0,_color=new three_module.Q1f;function ParserState(){const d={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(o,l){if(this.object&&this.object.fromDeclaration===!1)return this.object.name=o,void(this.object.fromDeclaration=l!==!1);const c=this.object&&typeof this.object.currentMaterial=="function"?this.object.currentMaterial():void 0;if(this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0),this.object={name:o||"",fromDeclaration:l!==!1,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(u,h){const _=this._finalize(!1);_&&(_.inherited||_.groupCount<=0)&&this.materials.splice(_.index,1);const A={index:this.materials.length,name:u||"",mtllib:Array.isArray(h)&&h.length>0?h[h.length-1]:"",smooth:_!==void 0?_.smooth:this.smooth,groupStart:_!==void 0?_.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(w){const C={index:typeof w=="number"?w:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return C.clone=this.clone.bind(C),C}};return this.materials.push(A),A},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(u){const h=this.currentMaterial();if(h&&h.groupEnd===-1&&(h.groupEnd=this.geometry.vertices.length/3,h.groupCount=h.groupEnd-h.groupStart,h.inherited=!1),u&&this.materials.length>1)for(let _=this.materials.length-1;_>=0;_--)this.materials[_].groupCount<=0&&this.materials.splice(_,1);return u&&this.materials.length===0&&this.materials.push({name:"",smooth:this.smooth}),h}},c&&c.name&&typeof c.clone=="function"){const u=c.clone(0);u.inherited=!0,this.object.materials.push(u)}this.objects.push(this.object)},finalize:function(){this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0)},parseVertexIndex:function(o,l){const c=parseInt(o,10);return 3*(c>=0?c-1:c+l/3)},parseNormalIndex:function(o,l){const c=parseInt(o,10);return 3*(c>=0?c-1:c+l/3)},parseUVIndex:function(o,l){const c=parseInt(o,10);return 2*(c>=0?c-1:c+l/2)},addVertex:function(o,l,c){const u=this.vertices,h=this.object.geometry.vertices;h.push(u[o+0],u[o+1],u[o+2]),h.push(u[l+0],u[l+1],u[l+2]),h.push(u[c+0],u[c+1],u[c+2])},addVertexPoint:function(o){const l=this.vertices;this.object.geometry.vertices.push(l[o+0],l[o+1],l[o+2])},addVertexLine:function(o){const l=this.vertices;this.object.geometry.vertices.push(l[o+0],l[o+1],l[o+2])},addNormal:function(o,l,c){const u=this.normals,h=this.object.geometry.normals;h.push(u[o+0],u[o+1],u[o+2]),h.push(u[l+0],u[l+1],u[l+2]),h.push(u[c+0],u[c+1],u[c+2])},addFaceNormal:function(o,l,c){const u=this.vertices,h=this.object.geometry.normals;_vA.fromArray(u,o),_vB.fromArray(u,l),_vC.fromArray(u,c),_cb.subVectors(_vC,_vB),_ab.subVectors(_vA,_vB),_cb.cross(_ab),_cb.normalize(),h.push(_cb.x,_cb.y,_cb.z),h.push(_cb.x,_cb.y,_cb.z),h.push(_cb.x,_cb.y,_cb.z)},addColor:function(o,l,c){const u=this.colors,h=this.object.geometry.colors;u[o]!==void 0&&h.push(u[o+0],u[o+1],u[o+2]),u[l]!==void 0&&h.push(u[l+0],u[l+1],u[l+2]),u[c]!==void 0&&h.push(u[c+0],u[c+1],u[c+2])},addUV:function(o,l,c){const u=this.uvs,h=this.object.geometry.uvs;h.push(u[o+0],u[o+1]),h.push(u[l+0],u[l+1]),h.push(u[c+0],u[c+1])},addDefaultUV:function(){const o=this.object.geometry.uvs;o.push(0,0),o.push(0,0),o.push(0,0)},addUVLine:function(o){const l=this.uvs;this.object.geometry.uvs.push(l[o+0],l[o+1])},addFace:function(o,l,c,u,h,_,A,w,C){const M=this.vertices.length;let O=this.parseVertexIndex(o,M),ne=this.parseVertexIndex(l,M),ce=this.parseVertexIndex(c,M);if(this.addVertex(O,ne,ce),this.addColor(O,ne,ce),A!==void 0&&A!==""){const ue=this.normals.length;O=this.parseNormalIndex(A,ue),ne=this.parseNormalIndex(w,ue),ce=this.parseNormalIndex(C,ue),this.addNormal(O,ne,ce)}else this.addFaceNormal(O,ne,ce);if(u!==void 0&&u!==""){const ue=this.uvs.length;O=this.parseUVIndex(u,ue),ne=this.parseUVIndex(h,ue),ce=this.parseUVIndex(_,ue),this.addUV(O,ne,ce),this.object.geometry.hasUVIndices=!0}else this.addDefaultUV()},addPointGeometry:function(o){this.object.geometry.type="Points";const l=this.vertices.length;for(let c=0,u=o.length;c<u;c++){const h=this.parseVertexIndex(o[c],l);this.addVertexPoint(h),this.addColor(h)}},addLineGeometry:function(o,l){this.object.geometry.type="Line";const c=this.vertices.length,u=this.uvs.length;for(let h=0,_=o.length;h<_;h++)this.addVertexLine(this.parseVertexIndex(o[h],c));for(let h=0,_=l.length;h<_;h++)this.addUVLine(this.parseUVIndex(l[h],u))}};return d.startObject("",!1),d}class OBJLoader2 extends three_module.aHM{constructor(o){super(o),this.materials=null}load(o,l,c,u){const h=this,_=new three_module.Y9S(this.manager);_.setPath(this.path),_.setRequestHeader(this.requestHeader),_.setWithCredentials(this.withCredentials),_.load(o,async function(A){try{l(await h.parse(A))}catch(w){u?u(w):console.error(w),h.manager.itemError(o)}},c,u)}setMaterials(o){return this.materials=o,this}async parse(o){const l=new ParserState;o.indexOf(`\r
`)!==-1&&(o=o.replace(/\r\n/g,`
`)),o.indexOf(`\\
`)!==-1&&(o=o.replace(/\\\n/g,""));const c=o.split(`
`);let u=[];for(let _=0,A=c.length;_<A;_++){const w=c[_].trimStart();if(w.length===0)continue;const C=w.charAt(0);if(C!=="#")if(C==="v"){const M=w.split(_face_vertex_data_separator_pattern);switch(M[0]){case"v":l.vertices.push(parseFloat(M[1]),parseFloat(M[2]),parseFloat(M[3])),M.length>=7?(_color.setRGB(parseFloat(M[4]),parseFloat(M[5]),parseFloat(M[6])).convertSRGBToLinear(),l.colors.push(_color.r,_color.g,_color.b)):l.colors.push(void 0,void 0,void 0);break;case"vn":l.normals.push(parseFloat(M[1]),parseFloat(M[2]),parseFloat(M[3]));break;case"vt":l.uvs.push(parseFloat(M[1]),parseFloat(M[2]))}}else if(C==="f"){const M=w.slice(1).trim().split(_face_vertex_data_separator_pattern),O=[];for(let ce=0,ue=M.length;ce<ue;ce++){const ye=M[ce];if(ye.length>0){const Oe=ye.split("/");O.push(Oe)}}const ne=O[0];for(let ce=1,ue=O.length-1;ce<ue;ce++){const ye=O[ce],Oe=O[ce+1];l.addFace(ne[0],ye[0],Oe[0],ne[1],ye[1],Oe[1],ne[2],ye[2],Oe[2])}}else if(C==="l"){const M=w.substring(1).trim().split(" ");let O=[];const ne=[];if(w.indexOf("/")===-1)O=M;else for(let ce=0,ue=M.length;ce<ue;ce++){const ye=M[ce].split("/");ye[0]!==""&&O.push(ye[0]),ye[1]!==""&&ne.push(ye[1])}l.addLineGeometry(O,ne)}else if(C==="p"){const M=w.slice(1).trim().split(" ");l.addPointGeometry(M)}else if((u=_object_pattern.exec(w))!==null){const M=(" "+u[0].slice(1).trim()).slice(1);l.startObject(M)}else if(_material_use_pattern.test(w))l.object.startMaterial(w.substring(7).trim(),l.materialLibraries);else if(_material_library_pattern.test(w)){l.materialLibraries.push(w.substring(7).trim());const M=w.substring(7).trim(),O=this.manager.getHandler(M);if(O){const ne=await O.loadAsync(M).catch(ce=>{console.warn(ce)});ne&&this.setMaterials(ne)}else console.warn("OBJLoader2: Set MTLLoader to loading manager to load materials.")}else if(_map_use_pattern.test(w))console.warn('OBJLoader2: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if(C==="s"){if(u=w.split(" "),u.length>1){const O=u[1].trim().toLowerCase();l.object.smooth=O!=="0"&&O!=="off"}else l.object.smooth=!0;const M=l.object.currentMaterial();M&&(M.smooth=l.object.smooth)}else{if(w==="\0")continue;console.warn('THREE.OBJLoader: Unexpected line: "'+w+'"')}}l.finalize();const h=new three_module.YJl;if(h.materialLibraries=[].concat(l.materialLibraries),!(l.objects.length===1&&l.objects[0].geometry.vertices.length===0))for(let _=0,A=l.objects.length;_<A;_++){const w=l.objects[_],C=w.geometry,M=w.materials,O=C.type==="Line",ne=C.type==="Points";let ce=!1;if(C.vertices.length===0)continue;const ue=new three_module.LoY;ue.setAttribute("position",new three_module.qtW(C.vertices,3)),C.normals.length>0&&ue.setAttribute("normal",new three_module.qtW(C.normals,3)),C.colors.length>0&&(ce=!0,ue.setAttribute("color",new three_module.qtW(C.colors,3))),C.hasUVIndices===!0&&ue.setAttribute("uv",new three_module.qtW(C.uvs,2));const ye=[];for(let ke=0,Ve=M.length;ke<Ve;ke++){const tt=M[ke],ht=tt.name+"_"+tt.smooth+"_"+ce;let ut=l.materials[ht];if(this.materials!==null)if(ut=await this.materials.create(tt.name),!O||!ut||ut instanceof three_module.mrM){if(ne&&ut&&!(ut instanceof three_module.BH$)){const _t=new three_module.BH$({size:10,sizeAttenuation:!1});three_module.imn.prototype.copy.call(_t,ut),_t.color.copy(ut.color),_t.map=ut.map,ut=_t}}else{const _t=new three_module.mrM;three_module.imn.prototype.copy.call(_t,ut),_t.color.copy(ut.color),ut=_t}ut===void 0&&(ut=O?new three_module.mrM:ne?new three_module.BH$({size:1,sizeAttenuation:!1}):new three_module.tXL,ut.name=tt.name,ut.flatShading=!tt.smooth,ut.vertexColors=ce,l.materials[ht]=ut),ye.push(ut)}let Oe;if(ye.length>1){for(let ke=0,Ve=M.length;ke<Ve;ke++){const tt=M[ke];ue.addGroup(tt.groupStart,tt.groupCount,ke)}Oe=O?new three_module.DXC(ue,ye):ne?new three_module.ONl(ue,ye):new three_module.eaF(ue,ye)}else Oe=O?new three_module.DXC(ue,ye[0]):ne?new three_module.ONl(ue,ye[0]):new three_module.eaF(ue,ye[0]);Oe.name=w.name,h.add(Oe)}else if(l.vertices.length>0){const _=new three_module.BH$({size:1,sizeAttenuation:!1}),A=new three_module.LoY;A.setAttribute("position",new three_module.qtW(l.vertices,3)),l.colors.length>0&&l.colors[0]!==void 0&&(A.setAttribute("color",new three_module.qtW(l.colors,3)),_.vertexColors=!0);const w=new three_module.ONl(A,_);h.add(w)}return h}}class ObjMtlLoadPlugin extends I{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin],this._importer1=new Importer(OBJLoader2,["obj"],!0),this._importer2=new Importer(MTLLoader2,["mtl"],!1)}async onAdded(o){var l,c,u,h;(c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0||c.Importers.push(this._importer1),(h=(u=o.getManager())===null||u===void 0?void 0:u.importer)===null||h===void 0||h.Importers.push(this._importer2)}async onDispose(o){}async onRemove(o){var l,c;!((c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0)&&c.Importers&&(o.getManager().importer.Importers.splice(o.getManager().importer.Importers.indexOf(this._importer1),1),o.getManager().importer.Importers.splice(o.getManager().importer.Importers.indexOf(this._importer2),1))}}ObjMtlLoadPlugin.PluginType="ObjMtlLoadPlugin";var durl=function(d){return URL.createObjectURL(new Blob([d],{type:"text/javascript"}))};try{URL.revokeObjectURL(durl(""))}catch(d){durl=function(o){return"data:application/javascript;charset=UTF-8,"+encodeURI(o)}}var fflate_module_u8=Uint8Array,fflate_module_u16=Uint16Array,fflate_module_u32=Uint32Array,fflate_module_fleb=new fflate_module_u8([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fflate_module_fdeb=new fflate_module_u8([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),fflate_module_clim=new fflate_module_u8([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),fflate_module_freb=function(d,o){for(var l=new fflate_module_u16(31),c=0;c<31;++c)l[c]=o+=1<<d[c-1];var u=new fflate_module_u32(l[30]);for(c=1;c<30;++c)for(var h=l[c];h<l[c+1];++h)u[h]=h-l[c]<<5|c;return[l,u]},fflate_module_a=fflate_module_freb(fflate_module_fleb,2),fflate_module_fl=fflate_module_a[0],fflate_module_revfl=fflate_module_a[1];fflate_module_fl[28]=258,fflate_module_revfl[258]=28;for(var fflate_module_b=fflate_module_freb(fflate_module_fdeb,0),fflate_module_fd=fflate_module_b[0],fflate_module_revfd=fflate_module_b[1],fflate_module_rev=new fflate_module_u16(32768),fflate_module_i=0;fflate_module_i<32768;++fflate_module_i){var fflate_module_x=(43690&fflate_module_i)>>>1|(21845&fflate_module_i)<<1;fflate_module_x=(52428&fflate_module_x)>>>2|(13107&fflate_module_x)<<2,fflate_module_x=(61680&fflate_module_x)>>>4|(3855&fflate_module_x)<<4,fflate_module_rev[fflate_module_i]=((65280&fflate_module_x)>>>8|(255&fflate_module_x)<<8)>>>1}for(var fflate_module_hMap=function(o,l,c){for(var u=o.length,h=0,_=new fflate_module_u16(l);h<u;++h)++_[o[h]-1];var A,w=new fflate_module_u16(l);for(h=0;h<l;++h)w[h]=w[h-1]+_[h-1]<<1;if(c){A=new fflate_module_u16(1<<l);var C=15-l;for(h=0;h<u;++h)if(o[h])for(var M=h<<4|o[h],O=l-o[h],ne=w[o[h]-1]++<<O,ce=ne|(1<<O)-1;ne<=ce;++ne)A[fflate_module_rev[ne]>>>C]=M}else for(A=new fflate_module_u16(u),h=0;h<u;++h)o[h]&&(A[h]=fflate_module_rev[w[o[h]-1]++]>>>15-o[h]);return A},fflate_module_flt=new fflate_module_u8(288),fflate_module_i=0;fflate_module_i<144;++fflate_module_i)fflate_module_flt[fflate_module_i]=8;for(var fflate_module_i=144;fflate_module_i<256;++fflate_module_i)fflate_module_flt[fflate_module_i]=9;for(var fflate_module_i=256;fflate_module_i<280;++fflate_module_i)fflate_module_flt[fflate_module_i]=7;for(var fflate_module_i=280;fflate_module_i<288;++fflate_module_i)fflate_module_flt[fflate_module_i]=8;for(var fflate_module_fdt=new fflate_module_u8(32),fflate_module_i=0;fflate_module_i<32;++fflate_module_i)fflate_module_fdt[fflate_module_i]=5;var fflate_module_flm=fflate_module_hMap(fflate_module_flt,9,0),fflate_module_flrm=fflate_module_hMap(fflate_module_flt,9,1),fflate_module_fdm=fflate_module_hMap(fflate_module_fdt,5,0),fflate_module_fdrm=fflate_module_hMap(fflate_module_fdt,5,1),fflate_module_max=function(d){for(var o=d[0],l=1;l<d.length;++l)d[l]>o&&(o=d[l]);return o},fflate_module_bits=function(d,o,l){var c=o/8|0;return(d[c]|d[c+1]<<8)>>(7&o)&l},fflate_module_bits16=function(d,o){var l=o/8|0;return(d[l]|d[l+1]<<8|d[l+2]<<16)>>(7&o)},fflate_module_shft=function(d){return(d/8|0)+(7&d&&1)},fflate_module_slc=function(d,o,l){(o==null||o<0)&&(o=0),(l==null||l>d.length)&&(l=d.length);var c=new(d instanceof fflate_module_u16?fflate_module_u16:d instanceof fflate_module_u32?fflate_module_u32:fflate_module_u8)(l-o);return c.set(d.subarray(o,l)),c},fflate_module_inflt=function(d,o,l){var c=d.length;if(!c||l&&!l.l&&c<5)return o||new fflate_module_u8(0);var u=!o||l,h=!l||l.i;l||(l={}),o||(o=new fflate_module_u8(3*c));var _=function(Ht){var qt=o.length;if(Ht>qt){var Li=new fflate_module_u8(Math.max(2*qt,Ht));Li.set(o),o=Li}},A=l.f||0,w=l.p||0,C=l.b||0,M=l.l,O=l.d,ne=l.m,ce=l.n,ue=8*c;do{if(!M){l.f=A=fflate_module_bits(d,w,1);var ye=fflate_module_bits(d,w+1,3);if(w+=3,!ye){var Oe=d[(Tt=fflate_module_shft(w)+4)-4]|d[Tt-3]<<8,ke=Tt+Oe;if(ke>c){if(h)throw"unexpected EOF";break}u&&_(C+Oe),o.set(d.subarray(Tt,ke),C),l.b=C+=Oe,l.p=w=8*ke;continue}if(ye==1)M=fflate_module_flrm,O=fflate_module_fdrm,ne=9,ce=5;else{if(ye!=2)throw"invalid block type";var Ve=fflate_module_bits(d,w,31)+257,tt=fflate_module_bits(d,w+10,15)+4,ht=Ve+fflate_module_bits(d,w+5,31)+1;w+=14;for(var ut=new fflate_module_u8(ht),_t=new fflate_module_u8(19),at=0;at<tt;++at)_t[fflate_module_clim[at]]=fflate_module_bits(d,w+3*at,7);w+=3*tt;var lt=fflate_module_max(_t),pt=(1<<lt)-1,xt=fflate_module_hMap(_t,lt,1);for(at=0;at<ht;){var Tt,Pt=xt[fflate_module_bits(d,w,pt)];if(w+=15&Pt,(Tt=Pt>>>4)<16)ut[at++]=Tt;else{var Lt=0,Bt=0;for(Tt==16?(Bt=3+fflate_module_bits(d,w,3),w+=2,Lt=ut[at-1]):Tt==17?(Bt=3+fflate_module_bits(d,w,7),w+=3):Tt==18&&(Bt=11+fflate_module_bits(d,w,127),w+=7);Bt--;)ut[at++]=Lt}}var Ut=ut.subarray(0,Ve),kt=ut.subarray(Ve);ne=fflate_module_max(Ut),ce=fflate_module_max(kt),M=fflate_module_hMap(Ut,ne,1),O=fflate_module_hMap(kt,ce,1)}if(w>ue){if(h)throw"unexpected EOF";break}}u&&_(C+131072);for(var Vt=(1<<ne)-1,si=(1<<ce)-1,Jt=w;;Jt=w){var Wt=(Lt=M[fflate_module_bits16(d,w)&Vt])>>>4;if((w+=15&Lt)>ue){if(h)throw"unexpected EOF";break}if(!Lt)throw"invalid length/literal";if(Wt<256)o[C++]=Wt;else{if(Wt==256){Jt=w,M=null;break}var Zt=Wt-254;if(Wt>264){var ti=fflate_module_fleb[at=Wt-257];Zt=fflate_module_bits(d,w,(1<<ti)-1)+fflate_module_fl[at],w+=ti}var ci=O[fflate_module_bits16(d,w)&si],ri=ci>>>4;if(!ci)throw"invalid distance";if(w+=15&ci,kt=fflate_module_fd[ri],ri>3&&(ti=fflate_module_fdeb[ri],kt+=fflate_module_bits16(d,w)&(1<<ti)-1,w+=ti),w>ue){if(h)throw"unexpected EOF";break}u&&_(C+131072);for(var Ct=C+Zt;C<Ct;C+=4)o[C]=o[C-kt],o[C+1]=o[C+1-kt],o[C+2]=o[C+2-kt],o[C+3]=o[C+3-kt];C=Ct}}l.l=M,l.p=Jt,l.b=C,M&&(A=1,l.m=ne,l.d=O,l.n=ce)}while(!A);return C==o.length?o:fflate_module_slc(o,0,C)},fflate_module_wbits=function(d,o,l){l<<=7&o;var c=o/8|0;d[c]|=l,d[c+1]|=l>>>8},fflate_module_wbits16=function(d,o,l){l<<=7&o;var c=o/8|0;d[c]|=l,d[c+1]|=l>>>8,d[c+2]|=l>>>16},fflate_module_hTree=function(d,o){for(var l=[],c=0;c<d.length;++c)d[c]&&l.push({s:c,f:d[c]});var u=l.length,h=l.slice();if(!u)return[fflate_module_et,0];if(u==1){var _=new fflate_module_u8(l[0].s+1);return _[l[0].s]=1,[_,1]}l.sort(function(ut,_t){return ut.f-_t.f}),l.push({s:-1,f:25001});var A=l[0],w=l[1],C=0,M=1,O=2;for(l[0]={s:-1,f:A.f+w.f,l:A,r:w};M!=u-1;)A=l[l[C].f<l[O].f?C++:O++],w=l[C!=M&&l[C].f<l[O].f?C++:O++],l[M++]={s:-1,f:A.f+w.f,l:A,r:w};var ne=h[0].s;for(c=1;c<u;++c)h[c].s>ne&&(ne=h[c].s);var ce=new fflate_module_u16(ne+1),ue=fflate_module_ln(l[M-1],ce,0);if(ue>o){c=0;var ye=0,Oe=ue-o,ke=1<<Oe;for(h.sort(function(ut,_t){return ce[_t.s]-ce[ut.s]||ut.f-_t.f});c<u;++c){var Ve=h[c].s;if(!(ce[Ve]>o))break;ye+=ke-(1<<ue-ce[Ve]),ce[Ve]=o}for(ye>>>=Oe;ye>0;){var tt=h[c].s;ce[tt]<o?ye-=1<<o-ce[tt]++-1:++c}for(;c>=0&&ye;--c){var ht=h[c].s;ce[ht]==o&&(--ce[ht],++ye)}ue=o}return[new fflate_module_u8(ce),ue]},fflate_module_ln=function(d,o,l){return d.s==-1?Math.max(fflate_module_ln(d.l,o,l+1),fflate_module_ln(d.r,o,l+1)):o[d.s]=l},fflate_module_lc=function(d){for(var o=d.length;o&&!d[--o];);for(var l=new fflate_module_u16(++o),c=0,u=d[0],h=1,_=function(w){l[c++]=w},A=1;A<=o;++A)if(d[A]==u&&A!=o)++h;else{if(!u&&h>2){for(;h>138;h-=138)_(32754);h>2&&(_(h>10?h-11<<5|28690:h-3<<5|12305),h=0)}else if(h>3){for(_(u),--h;h>6;h-=6)_(8304);h>2&&(_(h-3<<5|8208),h=0)}for(;h--;)_(u);h=1,u=d[A]}return[l.subarray(0,c),o]},fflate_module_clen=function(d,o){for(var l=0,c=0;c<o.length;++c)l+=d[c]*o[c];return l},fflate_module_wfblk=function(d,o,l){var c=l.length,u=fflate_module_shft(o+2);d[u]=255&c,d[u+1]=c>>>8,d[u+2]=255^d[u],d[u+3]=255^d[u+1];for(var h=0;h<c;++h)d[u+h+4]=l[h];return 8*(u+4+c)},fflate_module_wblk=function(d,o,l,c,u,h,_,A,w,C,M){fflate_module_wbits(o,M++,l),++u[256];for(var O=fflate_module_hTree(u,15),ne=O[0],ce=O[1],ue=fflate_module_hTree(h,15),ye=ue[0],Oe=ue[1],ke=fflate_module_lc(ne),Ve=ke[0],tt=ke[1],ht=fflate_module_lc(ye),ut=ht[0],_t=ht[1],at=new fflate_module_u16(19),lt=0;lt<Ve.length;++lt)at[31&Ve[lt]]++;for(lt=0;lt<ut.length;++lt)at[31&ut[lt]]++;for(var pt=fflate_module_hTree(at,7),xt=pt[0],Tt=pt[1],Pt=19;Pt>4&&!xt[fflate_module_clim[Pt-1]];--Pt);var Lt,Bt,Ut,kt,Vt=C+5<<3,si=fflate_module_clen(u,fflate_module_flt)+fflate_module_clen(h,fflate_module_fdt)+_,Jt=fflate_module_clen(u,ne)+fflate_module_clen(h,ye)+_+14+3*Pt+fflate_module_clen(at,xt)+(2*at[16]+3*at[17]+7*at[18]);if(Vt<=si&&Vt<=Jt)return fflate_module_wfblk(o,M,d.subarray(w,w+C));if(fflate_module_wbits(o,M,1+(Jt<si)),M+=2,Jt<si){Lt=fflate_module_hMap(ne,ce,0),Bt=ne,Ut=fflate_module_hMap(ye,Oe,0),kt=ye;var Wt=fflate_module_hMap(xt,Tt,0);for(fflate_module_wbits(o,M,tt-257),fflate_module_wbits(o,M+5,_t-1),fflate_module_wbits(o,M+10,Pt-4),M+=14,lt=0;lt<Pt;++lt)fflate_module_wbits(o,M+3*lt,xt[fflate_module_clim[lt]]);M+=3*Pt;for(var Zt=[Ve,ut],ti=0;ti<2;++ti){var ci=Zt[ti];for(lt=0;lt<ci.length;++lt){var ri=31&ci[lt];fflate_module_wbits(o,M,Wt[ri]),M+=xt[ri],ri>15&&(fflate_module_wbits(o,M,ci[lt]>>>5&127),M+=ci[lt]>>>12)}}}else Lt=fflate_module_flm,Bt=fflate_module_flt,Ut=fflate_module_fdm,kt=fflate_module_fdt;for(lt=0;lt<A;++lt)if(c[lt]>255){ri=c[lt]>>>18&31,fflate_module_wbits16(o,M,Lt[ri+257]),M+=Bt[ri+257],ri>7&&(fflate_module_wbits(o,M,c[lt]>>>23&31),M+=fflate_module_fleb[ri]);var Ct=31&c[lt];fflate_module_wbits16(o,M,Ut[Ct]),M+=kt[Ct],Ct>3&&(fflate_module_wbits16(o,M,c[lt]>>>5&8191),M+=fflate_module_fdeb[Ct])}else fflate_module_wbits16(o,M,Lt[c[lt]]),M+=Bt[c[lt]];return fflate_module_wbits16(o,M,Lt[256]),M+Bt[256]},fflate_module_deo=new fflate_module_u32([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),fflate_module_et=new fflate_module_u8(0),fflate_module_dflt=function(d,o,l,c,u,h){var _=d.length,A=new fflate_module_u8(c+_+5*(1+Math.ceil(_/7e3))+u),w=A.subarray(c,A.length-u),C=0;if(!o||_<8)for(var M=0;M<=_;M+=65535){var O=M+65535;O<_?C=fflate_module_wfblk(w,C,d.subarray(M,O)):(w[M]=h,C=fflate_module_wfblk(w,C,d.subarray(M,_)))}else{for(var ne=fflate_module_deo[o-1],ce=ne>>>13,ue=8191&ne,ye=(1<<l)-1,Oe=new fflate_module_u16(32768),ke=new fflate_module_u16(ye+1),Ve=Math.ceil(l/3),tt=2*Ve,ht=function(Ln){return(d[Ln]^d[Ln+1]<<Ve^d[Ln+2]<<tt)&ye},ut=new fflate_module_u32(25e3),_t=new fflate_module_u16(288),at=new fflate_module_u16(32),lt=0,pt=0,xt=(M=0,0),Tt=0,Pt=0;M<_;++M){var Lt=ht(M),Bt=32767&M,Ut=ke[Lt];if(Oe[Bt]=Ut,ke[Lt]=Bt,Tt<=M){var kt=_-M;if((lt>7e3||xt>24576)&&kt>423){C=fflate_module_wblk(d,w,0,ut,_t,at,pt,xt,Pt,M-Pt,C),xt=lt=pt=0,Pt=M;for(var Vt=0;Vt<286;++Vt)_t[Vt]=0;for(Vt=0;Vt<30;++Vt)at[Vt]=0}var si=2,Jt=0,Wt=ue,Zt=Bt-Ut&32767;if(kt>2&&Lt==ht(M-Zt))for(var ti=Math.min(ce,kt)-1,ci=Math.min(32767,M),ri=Math.min(258,kt);Zt<=ci&&--Wt&&Bt!=Ut;){if(d[M+si]==d[M+si-Zt]){for(var Ct=0;Ct<ri&&d[M+Ct]==d[M+Ct-Zt];++Ct);if(Ct>si){if(si=Ct,Jt=Zt,Ct>ti)break;var Ht=Math.min(Zt,Ct-2),qt=0;for(Vt=0;Vt<Ht;++Vt){var Li=M-Zt+Vt+32768&32767,Ui=Li-Oe[Li]+32768&32767;Ui>qt&&(qt=Ui,Ut=Li)}}}Zt+=(Bt=Ut)-(Ut=Oe[Bt])+32768&32767}if(Jt){ut[xt++]=268435456|fflate_module_revfl[si]<<18|fflate_module_revfd[Jt];var Xi=31&fflate_module_revfl[si],An=31&fflate_module_revfd[Jt];pt+=fflate_module_fleb[Xi]+fflate_module_fdeb[An],++_t[257+Xi],++at[An],Tt=M+si,++lt}else ut[xt++]=d[M],++_t[d[M]]}}C=fflate_module_wblk(d,w,h,ut,_t,at,pt,xt,Pt,M-Pt,C),!h&&7&C&&(C=fflate_module_wfblk(w,C+1,fflate_module_et))}return fflate_module_slc(A,0,c+fflate_module_shft(C)+u)},fflate_module_adler=function(){var d=1,o=0;return{p:function(l){for(var c=d,u=o,h=l.length,_=0;_!=h;){for(var A=Math.min(_+2655,h);_<A;++_)u+=c+=l[_];c=(65535&c)+15*(c>>16),u=(65535&u)+15*(u>>16)}d=c,o=u},d:function(){return(255&(d%=65521))<<24|d>>>8<<16|(255&(o%=65521))<<8|o>>>8}}},fflate_module_dopt=function(d,o,l,c,u){return fflate_module_dflt(d,o.level==null?6:o.level,o.mem==null?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(d.length)))):12+o.mem,l,c,!u)},fflate_module_wbytes=function(d,o,l){for(;l;++o)d[o]=l,l>>>=8},fflate_module_zlh=function(d,o){var l=o.level,c=l==0?0:l<6?1:l==9?3:2;d[0]=120,d[1]=c<<6|(c?32-2*c:1)},fflate_module_zlv=function(d){if((15&d[0])!=8||d[0]>>>4>7||(d[0]<<8|d[1])%31)throw"invalid zlib data";if(32&d[1])throw"invalid zlib data: preset dictionaries not supported"};function fflate_module_zlibSync(d,o){o||(o={});var l=fflate_module_adler();l.p(d);var c=fflate_module_dopt(d,o,2,4);return fflate_module_zlh(c,o),fflate_module_wbytes(c,c.length-4,l.d()),c}function fflate_module_unzlibSync(d,o){return fflate_module_inflt((fflate_module_zlv(d),d.subarray(2,-4)),o)}typeof TextEncoder<"u"&&new TextEncoder;var fflate_module_td=typeof TextDecoder<"u"&&new TextDecoder,fflate_module_tds=0;try{fflate_module_td.decode(fflate_module_et,{stream:!0}),fflate_module_tds=1}catch(d){}function findSpan(d,o,l){const c=l.length-d-1;if(o>=l[c])return c-1;if(o<=l[d])return d;let u=d,h=c,_=Math.floor((u+h)/2);for(;o<l[_]||o>=l[_+1];)o<l[_]?h=_:u=_,_=Math.floor((u+h)/2);return _}function calcBasisFunctions(d,o,l,c){const u=[],h=[],_=[];u[0]=1;for(let A=1;A<=l;++A){h[A]=o-c[d+1-A],_[A]=c[d+A]-o;let w=0;for(let C=0;C<A;++C){const M=_[C+1],O=h[A-C],ne=u[C]/(M+O);u[C]=w+M*ne,w=O*ne}u[A]=w}return u}function calcBSplinePoint(d,o,l,c){const u=findSpan(d,c,o),h=calcBasisFunctions(u,c,d,o),_=new three_module.IUQ(0,0,0,0);for(let A=0;A<=d;++A){const w=l[u-d+A],C=h[A],M=w.w*C;_.x+=w.x*M,_.y+=w.y*M,_.z+=w.z*M,_.w+=w.w*C}return _}function calcBasisFunctionDerivatives(d,o,l,c,u){const h=[];for(let O=0;O<=l;++O)h[O]=0;const _=[];for(let O=0;O<=c;++O)_[O]=h.slice(0);const A=[];for(let O=0;O<=l;++O)A[O]=h.slice(0);A[0][0]=1;const w=h.slice(0),C=h.slice(0);for(let O=1;O<=l;++O){w[O]=o-u[d+1-O],C[O]=u[d+O]-o;let ne=0;for(let ce=0;ce<O;++ce){const ue=C[ce+1],ye=w[O-ce];A[O][ce]=ue+ye;const Oe=A[ce][O-1]/A[O][ce];A[ce][O]=ne+ue*Oe,ne=ye*Oe}A[O][O]=ne}for(let O=0;O<=l;++O)_[0][O]=A[O][l];for(let O=0;O<=l;++O){let ne=0,ce=1;const ue=[];for(let ye=0;ye<=l;++ye)ue[ye]=h.slice(0);ue[0][0]=1;for(let ye=1;ye<=c;++ye){let Oe=0;const ke=O-ye,Ve=l-ye;O>=ye&&(ue[ce][0]=ue[ne][0]/A[Ve+1][ke],Oe=ue[ce][0]*A[ke][Ve]);const tt=O-1<=Ve?ye-1:l-O;for(let ut=ke>=-1?1:-ke;ut<=tt;++ut)ue[ce][ut]=(ue[ne][ut]-ue[ne][ut-1])/A[Ve+1][ke+ut],Oe+=ue[ce][ut]*A[ke+ut][Ve];O<=Ve&&(ue[ce][ye]=-ue[ne][ye-1]/A[Ve+1][O],Oe+=ue[ce][ye]*A[O][Ve]),_[ye][O]=Oe;const ht=ne;ne=ce,ce=ht}}let M=l;for(let O=1;O<=c;++O){for(let ne=0;ne<=l;++ne)_[O][ne]*=M;M*=l-O}return _}function calcBSplineDerivatives(d,o,l,c,u){const h=u<d?u:d,_=[],A=findSpan(d,c,o),w=calcBasisFunctionDerivatives(A,c,d,h,o),C=[];for(let M=0;M<l.length;++M){const O=l[M].clone(),ne=O.w;O.x*=ne,O.y*=ne,O.z*=ne,C[M]=O}for(let M=0;M<=h;++M){const O=C[A-d].clone().multiplyScalar(w[M][0]);for(let ne=1;ne<=d;++ne)O.add(C[A-d+ne].clone().multiplyScalar(w[M][ne]));_[M]=O}for(let M=h+1;M<=u+1;++M)_[M]=new three_module.IUQ(0,0,0);return _}function calcKoverI(d,o){let l=1;for(let u=2;u<=d;++u)l*=u;let c=1;for(let u=2;u<=o;++u)c*=u;for(let u=2;u<=d-o;++u)c*=u;return l/c}function calcRationalCurveDerivatives(d){const o=d.length,l=[],c=[];for(let h=0;h<o;++h){const _=d[h];l[h]=new three_module.Pq0(_.x,_.y,_.z),c[h]=_.w}const u=[];for(let h=0;h<o;++h){const _=l[h].clone();for(let A=1;A<=h;++A)_.sub(u[h-A].clone().multiplyScalar(calcKoverI(h,A)*c[A]));u[h]=_.divideScalar(c[0])}return u}function calcNURBSDerivatives(d,o,l,c,u){return calcRationalCurveDerivatives(calcBSplineDerivatives(d,o,l,c,u))}class NURBSCurve extends three_module.Ipv{constructor(o,l,c,u,h){super(),this.degree=o,this.knots=l,this.controlPoints=[],this.startKnot=u||0,this.endKnot=h||this.knots.length-1;for(let _=0;_<c.length;++_){const A=c[_];this.controlPoints[_]=new three_module.IUQ(A.x,A.y,A.z,A.w)}}getPoint(o,l=new three_module.Pq0){const c=l,u=this.knots[this.startKnot]+o*(this.knots[this.endKnot]-this.knots[this.startKnot]),h=calcBSplinePoint(this.degree,this.knots,this.controlPoints,u);return h.w!==1&&h.divideScalar(h.w),c.set(h.x,h.y,h.z)}getTangent(o,l=new three_module.Pq0){const c=l,u=this.knots[0]+o*(this.knots[this.knots.length-1]-this.knots[0]),h=calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,u,1);return c.copy(h[1]).normalize(),c}}let fbxTree,connections,sceneGraph;class FBXLoader extends three_module.aHM{constructor(o){super(o)}load(o,l,c,u){const h=this,_=h.path===""?three_module.r6x.extractUrlBase(o):h.path,A=new three_module.Y9S(this.manager);A.setPath(h.path),A.setResponseType("arraybuffer"),A.setRequestHeader(h.requestHeader),A.setWithCredentials(h.withCredentials),A.load(o,function(w){try{l(h.parse(w,_))}catch(C){u?u(C):console.error(C),h.manager.itemError(o)}},c,u)}parse(o,l){if(isFbxFormatBinary(o))fbxTree=new BinaryParser().parse(o);else{const h=convertArrayBufferToString(o);if(!isFbxFormatASCII(h))throw new Error("THREE.FBXLoader: Unknown format.");if(getFbxVersion(h)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+getFbxVersion(h));fbxTree=new TextParser().parse(h)}const c=new three_module.Tap(this.manager).setPath(this.resourcePath||l).setCrossOrigin(this.crossOrigin),u=new FBXTreeParser(c,this.manager).parse(fbxTree);return fbxTree=null,connections=null,sceneGraph=null,u}}class FBXTreeParser{constructor(o,l){this.textureLoader=o,this.manager=l}parse(){connections=this.parseConnections();const o=this.parseImages(),l=this.parseTextures(o),c=this.parseMaterials(l),u=this.parseDeformers(),h=new GeometryParser().parse(u);return this.parseScene(u,h,c),sceneGraph}parseConnections(){const o=new Map;return"Connections"in fbxTree&&fbxTree.Connections.connections.forEach(function(l){const c=l[0],u=l[1],h=l[2];o.has(c)||o.set(c,{parents:[],children:[]});const _={ID:u,relationship:h};o.get(c).parents.push(_),o.has(u)||o.set(u,{parents:[],children:[]});const A={ID:c,relationship:h};o.get(u).children.push(A)}),o}parseImages(){const o={},l={};if("Video"in fbxTree.Objects){const c=fbxTree.Objects.Video;for(const u in c){const h=c[u];if(o[parseInt(u)]=h.RelativeFilename||h.Filename,"Content"in h){const _=h.Content instanceof ArrayBuffer&&h.Content.byteLength>0,A=typeof h.Content=="string"&&h.Content!=="";if(_||A){const w=this.parseImage(c[u]);l[h.RelativeFilename||h.Filename]=w}}}}for(const c in o){const u=o[c];l[u]!==void 0?o[c]=l[u]:o[c]=o[c].split("\\").pop()}return o}parseImage(o){const l=o.Content,c=o.RelativeFilename||o.Filename,u=c.slice(c.lastIndexOf(".")+1).toLowerCase();let h;switch(u){case"bmp":h="image/bmp";break;case"jpg":case"jpeg":h="image/jpeg";break;case"png":h="image/png";break;case"tif":h="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",c),h="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+u+'" is not supported.')}if(typeof l=="string")return"data:"+h+";base64,"+l;{const _=new Uint8Array(l);return window.URL.createObjectURL(new Blob([_],{type:h}))}}parseTextures(o){const l=new Map;if("Texture"in fbxTree.Objects){const c=fbxTree.Objects.Texture;for(const u in c){const h=this.parseTexture(c[u],o);l.set(parseInt(u),h)}}return l}parseTexture(o,l){const c=this.loadTexture(o,l);c.ID=o.id,c.name=o.attrName;const u=o.WrapModeU,h=o.WrapModeV,_=u!==void 0?u.value:0,A=h!==void 0?h.value:0;if(c.wrapS=_===0?three_module.GJx:three_module.ghU,c.wrapT=A===0?three_module.GJx:three_module.ghU,"Scaling"in o){const w=o.Scaling.value;c.repeat.x=w[0],c.repeat.y=w[1]}if("Translation"in o){const w=o.Translation.value;c.offset.x=w[0],c.offset.y=w[1]}return c}loadTexture(o,l){let c;const u=this.textureLoader.path,h=connections.get(o.id).children;let _;h!==void 0&&h.length>0&&l[h[0].ID]!==void 0&&(c=l[h[0].ID],c.indexOf("blob:")!==0&&c.indexOf("data:")!==0||this.textureLoader.setPath(void 0));const A=o.FileName.slice(-3).toLowerCase();if(A==="tga"){const w=this.manager.getHandler(".tga");w===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",o.RelativeFilename),_=new three_module.gPd):(w.setPath(this.textureLoader.path),_=w.load(c))}else A==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",o.RelativeFilename),_=new three_module.gPd):_=this.textureLoader.load(c);return this.textureLoader.setPath(u),_}parseMaterials(o){const l=new Map;if("Material"in fbxTree.Objects){const c=fbxTree.Objects.Material;for(const u in c){const h=this.parseMaterial(c[u],o);h!==null&&l.set(parseInt(u),h)}}return l}parseMaterial(o,l){const c=o.id,u=o.attrName;let h=o.ShadingModel;if(typeof h=="object"&&(h=h.value),!connections.has(c))return null;const _=this.parseParameters(o,l,c);let A;switch(h.toLowerCase()){case"phong":A=new three_module.tXL;break;case"lambert":A=new three_module.G_z;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',h),A=new three_module.tXL}return A.setValues(_),A.name=u,A}parseParameters(o,l,c){const u={};o.BumpFactor&&(u.bumpScale=o.BumpFactor.value),o.Diffuse?u.color=new three_module.Q1f().fromArray(o.Diffuse.value).convertSRGBToLinear():!o.DiffuseColor||o.DiffuseColor.type!=="Color"&&o.DiffuseColor.type!=="ColorRGB"||(u.color=new three_module.Q1f().fromArray(o.DiffuseColor.value).convertSRGBToLinear()),o.DisplacementFactor&&(u.displacementScale=o.DisplacementFactor.value),o.Emissive?u.emissive=new three_module.Q1f().fromArray(o.Emissive.value).convertSRGBToLinear():!o.EmissiveColor||o.EmissiveColor.type!=="Color"&&o.EmissiveColor.type!=="ColorRGB"||(u.emissive=new three_module.Q1f().fromArray(o.EmissiveColor.value).convertSRGBToLinear()),o.EmissiveFactor&&(u.emissiveIntensity=parseFloat(o.EmissiveFactor.value)),o.Opacity&&(u.opacity=parseFloat(o.Opacity.value)),u.opacity<1&&(u.transparent=!0),o.ReflectionFactor&&(u.reflectivity=o.ReflectionFactor.value),o.Shininess&&(u.shininess=o.Shininess.value),o.Specular?u.specular=new three_module.Q1f().fromArray(o.Specular.value).convertSRGBToLinear():o.SpecularColor&&o.SpecularColor.type==="Color"&&(u.specular=new three_module.Q1f().fromArray(o.SpecularColor.value).convertSRGBToLinear());const h=this;return connections.get(c).children.forEach(function(_){const A=_.relationship;switch(A){case"Bump":u.bumpMap=h.getTexture(l,_.ID);break;case"Maya|TEX_ao_map":u.aoMap=h.getTexture(l,_.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":u.map=h.getTexture(l,_.ID),u.map!==void 0&&(u.map.colorSpace=three_module.er$);break;case"DisplacementColor":u.displacementMap=h.getTexture(l,_.ID);break;case"EmissiveColor":u.emissiveMap=h.getTexture(l,_.ID),u.emissiveMap!==void 0&&(u.emissiveMap.colorSpace=three_module.er$);break;case"NormalMap":case"Maya|TEX_normal_map":u.normalMap=h.getTexture(l,_.ID);break;case"ReflectionColor":u.envMap=h.getTexture(l,_.ID),u.envMap!==void 0&&(u.envMap.mapping=three_module.wfO,u.envMap.colorSpace=three_module.er$);break;case"SpecularColor":u.specularMap=h.getTexture(l,_.ID),u.specularMap!==void 0&&(u.specularMap.colorSpace=three_module.er$);break;case"TransparentColor":case"TransparencyFactor":u.alphaMap=h.getTexture(l,_.ID),u.transparent=!0;break;default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",A)}}),u}getTexture(o,l){return"LayeredTexture"in fbxTree.Objects&&l in fbxTree.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),l=connections.get(l).children[0].ID),o.get(l)}parseDeformers(){const o={},l={};if("Deformer"in fbxTree.Objects){const c=fbxTree.Objects.Deformer;for(const u in c){const h=c[u],_=connections.get(parseInt(u));if(h.attrType==="Skin"){const A=this.parseSkeleton(_,c);A.ID=u,_.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),A.geometryID=_.parents[0].ID,o[u]=A}else if(h.attrType==="BlendShape"){const A={id:u};A.rawTargets=this.parseMorphTargets(_,c),A.id=u,_.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),l[u]=A}}}return{skeletons:o,morphTargets:l}}parseSkeleton(o,l){const c=[];return o.children.forEach(function(u){const h=l[u.ID];if(h.attrType!=="Cluster")return;const _={ID:u.ID,indices:[],weights:[],transformLink:new three_module.kn4().fromArray(h.TransformLink.a)};"Indexes"in h&&(_.indices=h.Indexes.a,_.weights=h.Weights.a),c.push(_)}),{rawBones:c,bones:[]}}parseMorphTargets(o,l){const c=[];for(let u=0;u<o.children.length;u++){const h=o.children[u],_=l[h.ID],A={name:_.attrName,initialWeight:_.DeformPercent,id:_.id,fullWeights:_.FullWeights.a};if(_.attrType!=="BlendShapeChannel")return;A.geoID=connections.get(parseInt(h.ID)).children.filter(function(w){return w.relationship===void 0})[0].ID,c.push(A)}return c}parseScene(o,l,c){sceneGraph=new three_module.YJl;const u=this.parseModels(o.skeletons,l,c),h=fbxTree.Objects.Model,_=this;u.forEach(function(w){const C=h[w.ID];_.setLookAtProperties(w,C),connections.get(w.ID).parents.forEach(function(M){const O=u.get(M.ID);O!==void 0&&O.add(w)}),w.parent===null&&sceneGraph.add(w)}),this.bindSkeleton(o.skeletons,l,u),this.createAmbientLight(),sceneGraph.traverse(function(w){if(w.userData.transformData){w.parent&&(w.userData.transformData.parentMatrix=w.parent.matrix,w.userData.transformData.parentMatrixWorld=w.parent.matrixWorld);const C=generateTransform(w.userData.transformData);w.applyMatrix4(C),w.updateWorldMatrix()}});const A=new AnimationParser().parse();sceneGraph.children.length===1&&sceneGraph.children[0].isGroup&&(sceneGraph.children[0].animations=A,sceneGraph=sceneGraph.children[0]),sceneGraph.animations=A}parseModels(o,l,c){const u=new Map,h=fbxTree.Objects.Model;for(const _ in h){const A=parseInt(_),w=h[_],C=connections.get(A);let M=this.buildSkeleton(C,o,A,w.attrName);if(!M){switch(w.attrType){case"Camera":M=this.createCamera(C);break;case"Light":M=this.createLight(C);break;case"Mesh":M=this.createMesh(C,l,c);break;case"NurbsCurve":M=this.createCurve(C,l);break;case"LimbNode":case"Root":M=new three_module.$Kf;break;default:M=new three_module.YJl}M.name=w.attrName?three_module.Nwf.sanitizeNodeName(w.attrName):"",M.userData.originalName=w.attrName,M.ID=A}this.getTransformData(M,w),u.set(A,M)}return u}buildSkeleton(o,l,c,u){let h=null;return o.parents.forEach(function(_){for(const A in l){const w=l[A];w.rawBones.forEach(function(C,M){if(C.ID===_.ID){const O=h;h=new three_module.$Kf,h.matrixWorld.copy(C.transformLink),h.name=u?three_module.Nwf.sanitizeNodeName(u):"",h.userData.originalName=u,h.ID=c,w.bones[M]=h,O!==null&&h.add(O)}})}}),h}createCamera(o){let l,c;if(o.children.forEach(function(u){const h=fbxTree.Objects.NodeAttribute[u.ID];h!==void 0&&(c=h)}),c===void 0)l=new three_module.B69;else{let u=0;c.CameraProjectionType!==void 0&&c.CameraProjectionType.value===1&&(u=1);let h=1;c.NearPlane!==void 0&&(h=c.NearPlane.value/1e3);let _=1e3;c.FarPlane!==void 0&&(_=c.FarPlane.value/1e3);let A=window.innerWidth,w=window.innerHeight;c.AspectWidth!==void 0&&c.AspectHeight!==void 0&&(A=c.AspectWidth.value,w=c.AspectHeight.value);const C=A/w;let M=45;c.FieldOfView!==void 0&&(M=c.FieldOfView.value);const O=c.FocalLength?c.FocalLength.value:null;switch(u){case 0:l=new three_module.ubm(M,C,h,_),O!==null&&l.setFocalLength(O);break;case 1:l=new three_module.qUd(-A/2,A/2,w/2,-w/2,h,_);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+u+"."),l=new three_module.B69}}return l}createLight(o){let l,c;if(o.children.forEach(function(u){const h=fbxTree.Objects.NodeAttribute[u.ID];h!==void 0&&(c=h)}),c===void 0)l=new three_module.B69;else{let u;u=c.LightType===void 0?0:c.LightType.value;let h=16777215;c.Color!==void 0&&(h=new three_module.Q1f().fromArray(c.Color.value).convertSRGBToLinear());let _=c.Intensity===void 0?1:c.Intensity.value/100;c.CastLightOnObject!==void 0&&c.CastLightOnObject.value===0&&(_=0);let A=0;c.FarAttenuationEnd!==void 0&&(A=c.EnableFarAttenuation!==void 0&&c.EnableFarAttenuation.value===0?0:c.FarAttenuationEnd.value);const w=1;switch(u){case 0:l=new three_module.HiM(h,_,A,w);break;case 1:l=new three_module.ZyN(h,_);break;case 2:let C=Math.PI/3;c.InnerAngle!==void 0&&(C=three_module.cj9.degToRad(c.InnerAngle.value));let M=0;c.OuterAngle!==void 0&&(M=three_module.cj9.degToRad(c.OuterAngle.value),M=Math.max(M,1)),l=new three_module.nCl(h,_,A,C,M,w);break;default:console.warn("THREE.FBXLoader: Unknown light type "+c.LightType.value+", defaulting to a PointLight."),l=new three_module.HiM(h,_)}c.CastShadows!==void 0&&c.CastShadows.value===1&&(l.castShadow=!0)}return l}createMesh(o,l,c){let u,h=null,_=null;const A=[];return o.children.forEach(function(w){l.has(w.ID)&&(h=l.get(w.ID)),c.has(w.ID)&&A.push(c.get(w.ID))}),A.length>1?_=A:A.length>0?_=A[0]:(_=new three_module.tXL({name:three_module.aHM.DEFAULT_MATERIAL_NAME,color:13421772}),A.push(_)),"color"in h.attributes&&A.forEach(function(w){w.vertexColors=!0}),h.FBX_Deformer?(u=new three_module.I46(h,_),u.normalizeSkinWeights()):u=new three_module.eaF(h,_),u}createCurve(o,l){const c=o.children.reduce(function(h,_){return l.has(_.ID)&&(h=l.get(_.ID)),h},null),u=new three_module.mrM({name:three_module.aHM.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new three_module.N1A(c,u)}getTransformData(o,l){const c={};"InheritType"in l&&(c.inheritType=parseInt(l.InheritType.value)),c.eulerOrder="RotationOrder"in l?getEulerOrder(l.RotationOrder.value):"ZYX","Lcl_Translation"in l&&(c.translation=l.Lcl_Translation.value),"PreRotation"in l&&(c.preRotation=l.PreRotation.value),"Lcl_Rotation"in l&&(c.rotation=l.Lcl_Rotation.value),"PostRotation"in l&&(c.postRotation=l.PostRotation.value),"Lcl_Scaling"in l&&(c.scale=l.Lcl_Scaling.value),"ScalingOffset"in l&&(c.scalingOffset=l.ScalingOffset.value),"ScalingPivot"in l&&(c.scalingPivot=l.ScalingPivot.value),"RotationOffset"in l&&(c.rotationOffset=l.RotationOffset.value),"RotationPivot"in l&&(c.rotationPivot=l.RotationPivot.value),o.userData.transformData=c}setLookAtProperties(o,l){"LookAtProperty"in l&&connections.get(o.ID).children.forEach(function(c){if(c.relationship==="LookAtProperty"){const u=fbxTree.Objects.Model[c.ID];if("Lcl_Translation"in u){const h=u.Lcl_Translation.value;o.target!==void 0?(o.target.position.fromArray(h),sceneGraph.add(o.target)):o.lookAt(new three_module.Pq0().fromArray(h))}}})}bindSkeleton(o,l,c){const u=this.parsePoseNodes();for(const h in o){const _=o[h];connections.get(parseInt(_.ID)).parents.forEach(function(A){if(l.has(A.ID)){const w=A.ID;connections.get(w).parents.forEach(function(C){c.has(C.ID)&&c.get(C.ID).bind(new three_module.EAD(_.bones),u[C.ID])})}})}}parsePoseNodes(){const o={};if("Pose"in fbxTree.Objects){const l=fbxTree.Objects.Pose;for(const c in l)if(l[c].attrType==="BindPose"&&l[c].NbPoseNodes>0){const u=l[c].PoseNode;Array.isArray(u)?u.forEach(function(h){o[h.Node]=new three_module.kn4().fromArray(h.Matrix.a)}):o[u.Node]=new three_module.kn4().fromArray(u.Matrix.a)}}return o}createAmbientLight(){if("GlobalSettings"in fbxTree&&"AmbientColor"in fbxTree.GlobalSettings){const o=fbxTree.GlobalSettings.AmbientColor.value,l=o[0],c=o[1],u=o[2];if(l!==0||c!==0||u!==0){const h=new three_module.Q1f(l,c,u).convertSRGBToLinear();sceneGraph.add(new three_module.$p8(h,1))}}}}class GeometryParser{constructor(){this.negativeMaterialIndices=!1}parse(o){const l=new Map;if("Geometry"in fbxTree.Objects){const c=fbxTree.Objects.Geometry;for(const u in c){const h=connections.get(parseInt(u)),_=this.parseGeometry(h,c[u],o);l.set(parseInt(u),_)}}return this.negativeMaterialIndices===!0&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),l}parseGeometry(o,l,c){switch(l.attrType){case"Mesh":return this.parseMeshGeometry(o,l,c);case"NurbsCurve":return this.parseNurbsGeometry(l)}}parseMeshGeometry(o,l,c){const u=c.skeletons,h=[],_=o.parents.map(function(O){return fbxTree.Objects.Model[O.ID]});if(_.length===0)return;const A=o.children.reduce(function(O,ne){return u[ne.ID]!==void 0&&(O=u[ne.ID]),O},null);o.children.forEach(function(O){c.morphTargets[O.ID]!==void 0&&h.push(c.morphTargets[O.ID])});const w=_[0],C={};"RotationOrder"in w&&(C.eulerOrder=getEulerOrder(w.RotationOrder.value)),"InheritType"in w&&(C.inheritType=parseInt(w.InheritType.value)),"GeometricTranslation"in w&&(C.translation=w.GeometricTranslation.value),"GeometricRotation"in w&&(C.rotation=w.GeometricRotation.value),"GeometricScaling"in w&&(C.scale=w.GeometricScaling.value);const M=generateTransform(C);return this.genGeometry(l,A,h,M)}genGeometry(o,l,c,u){const h=new three_module.LoY;o.attrName&&(h.name=o.attrName);const _=this.parseGeoNode(o,l),A=this.genBuffers(_),w=new three_module.qtW(A.vertex,3);if(w.applyMatrix4(u),h.setAttribute("position",w),A.colors.length>0&&h.setAttribute("color",new three_module.qtW(A.colors,3)),l&&(h.setAttribute("skinIndex",new three_module.A$4(A.weightsIndices,4)),h.setAttribute("skinWeight",new three_module.qtW(A.vertexWeights,4)),h.FBX_Deformer=l),A.normal.length>0){const C=new three_module.dwI().getNormalMatrix(u),M=new three_module.qtW(A.normal,3);M.applyNormalMatrix(C),h.setAttribute("normal",M)}if(A.uvs.forEach(function(C,M){const O=M===0?"uv":`uv${M}`;h.setAttribute(O,new three_module.qtW(A.uvs[M],2))}),_.material&&_.material.mappingType!=="AllSame"){let C=A.materialIndex[0],M=0;if(A.materialIndex.forEach(function(O,ne){O!==C&&(h.addGroup(M,ne-M,C),C=O,M=ne)}),h.groups.length>0){const O=h.groups[h.groups.length-1],ne=O.start+O.count;ne!==A.materialIndex.length&&h.addGroup(ne,A.materialIndex.length-ne,C)}h.groups.length===0&&h.addGroup(0,A.materialIndex.length,A.materialIndex[0])}return this.addMorphTargets(h,o,c,u),h}parseGeoNode(o,l){const c={};if(c.vertexPositions=o.Vertices!==void 0?o.Vertices.a:[],c.vertexIndices=o.PolygonVertexIndex!==void 0?o.PolygonVertexIndex.a:[],o.LayerElementColor&&(c.color=this.parseVertexColors(o.LayerElementColor[0])),o.LayerElementMaterial&&(c.material=this.parseMaterialIndices(o.LayerElementMaterial[0])),o.LayerElementNormal&&(c.normal=this.parseNormals(o.LayerElementNormal[0])),o.LayerElementUV){c.uv=[];let u=0;for(;o.LayerElementUV[u];)o.LayerElementUV[u].UV&&c.uv.push(this.parseUVs(o.LayerElementUV[u])),u++}return c.weightTable={},l!==null&&(c.skeleton=l,l.rawBones.forEach(function(u,h){u.indices.forEach(function(_,A){c.weightTable[_]===void 0&&(c.weightTable[_]=[]),c.weightTable[_].push({id:h,weight:u.weights[A]})})})),c}genBuffers(o){const l={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let c=0,u=0,h=!1,_=[],A=[],w=[],C=[],M=[],O=[];const ne=this;return o.vertexIndices.forEach(function(ce,ue){let ye,Oe=!1;ce<0&&(ce=~ce,Oe=!0);let ke=[],Ve=[];if(_.push(3*ce,3*ce+1,3*ce+2),o.color){const tt=getData(ue,c,ce,o.color);w.push(tt[0],tt[1],tt[2])}if(o.skeleton){if(o.weightTable[ce]!==void 0&&o.weightTable[ce].forEach(function(tt){Ve.push(tt.weight),ke.push(tt.id)}),Ve.length>4){h||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),h=!0);const tt=[0,0,0,0],ht=[0,0,0,0];Ve.forEach(function(ut,_t){let at=ut,lt=ke[_t];ht.forEach(function(pt,xt,Tt){if(at>pt){Tt[xt]=at,at=pt;const Pt=tt[xt];tt[xt]=lt,lt=Pt}})}),ke=tt,Ve=ht}for(;Ve.length<4;)Ve.push(0),ke.push(0);for(let tt=0;tt<4;++tt)M.push(Ve[tt]),O.push(ke[tt])}if(o.normal){const tt=getData(ue,c,ce,o.normal);A.push(tt[0],tt[1],tt[2])}o.material&&o.material.mappingType!=="AllSame"&&(ye=getData(ue,c,ce,o.material)[0],ye<0&&(ne.negativeMaterialIndices=!0,ye=0)),o.uv&&o.uv.forEach(function(tt,ht){const ut=getData(ue,c,ce,tt);C[ht]===void 0&&(C[ht]=[]),C[ht].push(ut[0]),C[ht].push(ut[1])}),u++,Oe&&(u>4&&console.warn("THREE.FBXLoader: Polygons with more than four sides are not supported. Make sure to triangulate the geometry during export."),ne.genFace(l,o,_,ye,A,w,C,M,O,u),c++,u=0,_=[],A=[],w=[],C=[],M=[],O=[])}),l}genFace(o,l,c,u,h,_,A,w,C,M){for(let O=2;O<M;O++)o.vertex.push(l.vertexPositions[c[0]]),o.vertex.push(l.vertexPositions[c[1]]),o.vertex.push(l.vertexPositions[c[2]]),o.vertex.push(l.vertexPositions[c[3*(O-1)]]),o.vertex.push(l.vertexPositions[c[3*(O-1)+1]]),o.vertex.push(l.vertexPositions[c[3*(O-1)+2]]),o.vertex.push(l.vertexPositions[c[3*O]]),o.vertex.push(l.vertexPositions[c[3*O+1]]),o.vertex.push(l.vertexPositions[c[3*O+2]]),l.skeleton&&(o.vertexWeights.push(w[0]),o.vertexWeights.push(w[1]),o.vertexWeights.push(w[2]),o.vertexWeights.push(w[3]),o.vertexWeights.push(w[4*(O-1)]),o.vertexWeights.push(w[4*(O-1)+1]),o.vertexWeights.push(w[4*(O-1)+2]),o.vertexWeights.push(w[4*(O-1)+3]),o.vertexWeights.push(w[4*O]),o.vertexWeights.push(w[4*O+1]),o.vertexWeights.push(w[4*O+2]),o.vertexWeights.push(w[4*O+3]),o.weightsIndices.push(C[0]),o.weightsIndices.push(C[1]),o.weightsIndices.push(C[2]),o.weightsIndices.push(C[3]),o.weightsIndices.push(C[4*(O-1)]),o.weightsIndices.push(C[4*(O-1)+1]),o.weightsIndices.push(C[4*(O-1)+2]),o.weightsIndices.push(C[4*(O-1)+3]),o.weightsIndices.push(C[4*O]),o.weightsIndices.push(C[4*O+1]),o.weightsIndices.push(C[4*O+2]),o.weightsIndices.push(C[4*O+3])),l.color&&(o.colors.push(_[0]),o.colors.push(_[1]),o.colors.push(_[2]),o.colors.push(_[3*(O-1)]),o.colors.push(_[3*(O-1)+1]),o.colors.push(_[3*(O-1)+2]),o.colors.push(_[3*O]),o.colors.push(_[3*O+1]),o.colors.push(_[3*O+2])),l.material&&l.material.mappingType!=="AllSame"&&(o.materialIndex.push(u),o.materialIndex.push(u),o.materialIndex.push(u)),l.normal&&(o.normal.push(h[0]),o.normal.push(h[1]),o.normal.push(h[2]),o.normal.push(h[3*(O-1)]),o.normal.push(h[3*(O-1)+1]),o.normal.push(h[3*(O-1)+2]),o.normal.push(h[3*O]),o.normal.push(h[3*O+1]),o.normal.push(h[3*O+2])),l.uv&&l.uv.forEach(function(ne,ce){o.uvs[ce]===void 0&&(o.uvs[ce]=[]),o.uvs[ce].push(A[ce][0]),o.uvs[ce].push(A[ce][1]),o.uvs[ce].push(A[ce][2*(O-1)]),o.uvs[ce].push(A[ce][2*(O-1)+1]),o.uvs[ce].push(A[ce][2*O]),o.uvs[ce].push(A[ce][2*O+1])})}addMorphTargets(o,l,c,u){if(c.length===0)return;o.morphTargetsRelative=!0,o.morphAttributes.position=[];const h=this;c.forEach(function(_){_.rawTargets.forEach(function(A){const w=fbxTree.Objects.Geometry[A.geoID];w!==void 0&&h.genMorphGeometry(o,l,w,u,A.name)})})}genMorphGeometry(o,l,c,u,h){const _=l.PolygonVertexIndex!==void 0?l.PolygonVertexIndex.a:[],A=c.Vertices!==void 0?c.Vertices.a:[],w=c.Indexes!==void 0?c.Indexes.a:[],C=3*o.attributes.position.count,M=new Float32Array(C);for(let ue=0;ue<w.length;ue++){const ye=3*w[ue];M[ye]=A[3*ue],M[ye+1]=A[3*ue+1],M[ye+2]=A[3*ue+2]}const O={vertexIndices:_,vertexPositions:M},ne=this.genBuffers(O),ce=new three_module.qtW(ne.vertex,3);ce.name=h||c.attrName,ce.applyMatrix4(u),o.morphAttributes.position.push(ce)}parseNormals(o){const l=o.MappingInformationType,c=o.ReferenceInformationType,u=o.Normals.a;let h=[];return c==="IndexToDirect"&&("NormalIndex"in o?h=o.NormalIndex.a:"NormalsIndex"in o&&(h=o.NormalsIndex.a)),{dataSize:3,buffer:u,indices:h,mappingType:l,referenceType:c}}parseUVs(o){const l=o.MappingInformationType,c=o.ReferenceInformationType,u=o.UV.a;let h=[];return c==="IndexToDirect"&&(h=o.UVIndex.a),{dataSize:2,buffer:u,indices:h,mappingType:l,referenceType:c}}parseVertexColors(o){const l=o.MappingInformationType,c=o.ReferenceInformationType,u=o.Colors.a;let h=[];c==="IndexToDirect"&&(h=o.ColorIndex.a);for(let _=0,A=new three_module.Q1f;_<u.length;_+=4)A.fromArray(u,_).convertSRGBToLinear().toArray(u,_);return{dataSize:4,buffer:u,indices:h,mappingType:l,referenceType:c}}parseMaterialIndices(o){const l=o.MappingInformationType,c=o.ReferenceInformationType;if(l==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:c};const u=o.Materials.a,h=[];for(let _=0;_<u.length;++_)h.push(_);return{dataSize:1,buffer:u,indices:h,mappingType:l,referenceType:c}}parseNurbsGeometry(o){const l=parseInt(o.Order);if(isNaN(l))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",o.Order,o.id),new three_module.LoY;const c=l-1,u=o.KnotVector.a,h=[],_=o.Points.a;for(let M=0,O=_.length;M<O;M+=4)h.push(new three_module.IUQ().fromArray(_,M));let A,w;if(o.Form==="Closed")h.push(h[0]);else if(o.Form==="Periodic"){A=c,w=u.length-1-A;for(let M=0;M<c;++M)h.push(h[M])}const C=new NURBSCurve(c,u,h,A,w).getPoints(12*h.length);return new three_module.LoY().setFromPoints(C)}}class AnimationParser{parse(){const o=[],l=this.parseClips();if(l!==void 0)for(const c in l){const u=l[c],h=this.addClip(u);o.push(h)}return o}parseClips(){if(fbxTree.Objects.AnimationCurve===void 0)return;const o=this.parseAnimationCurveNodes();this.parseAnimationCurves(o);const l=this.parseAnimationLayers(o);return this.parseAnimStacks(l)}parseAnimationCurveNodes(){const o=fbxTree.Objects.AnimationCurveNode,l=new Map;for(const c in o){const u=o[c];if(u.attrName.match(/S|R|T|DeformPercent/)!==null){const h={id:u.id,attr:u.attrName,curves:{}};l.set(h.id,h)}}return l}parseAnimationCurves(o){const l=fbxTree.Objects.AnimationCurve;for(const c in l){const u={id:l[c].id,times:l[c].KeyTime.a.map(convertFBXTimeToSeconds),values:l[c].KeyValueFloat.a},h=connections.get(u.id);if(h!==void 0){const _=h.parents[0].ID,A=h.parents[0].relationship;A.match(/X/)?o.get(_).curves.x=u:A.match(/Y/)?o.get(_).curves.y=u:A.match(/Z/)?o.get(_).curves.z=u:A.match(/DeformPercent/)&&o.has(_)&&(o.get(_).curves.morph=u)}}}parseAnimationLayers(o){const l=fbxTree.Objects.AnimationLayer,c=new Map;for(const u in l){const h=[],_=connections.get(parseInt(u));_!==void 0&&(_.children.forEach(function(A,w){if(o.has(A.ID)){const C=o.get(A.ID);if(C.curves.x!==void 0||C.curves.y!==void 0||C.curves.z!==void 0){if(h[w]===void 0){const M=connections.get(A.ID).parents.filter(function(O){return O.relationship!==void 0})[0].ID;if(M!==void 0){const O=fbxTree.Objects.Model[M.toString()];if(O===void 0)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",A);const ne={modelName:O.attrName?three_module.Nwf.sanitizeNodeName(O.attrName):"",ID:O.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};sceneGraph.traverse(function(ce){ce.ID===O.id&&(ne.transform=ce.matrix,ce.userData.transformData&&(ne.eulerOrder=ce.userData.transformData.eulerOrder))}),ne.transform||(ne.transform=new three_module.kn4),"PreRotation"in O&&(ne.preRotation=O.PreRotation.value),"PostRotation"in O&&(ne.postRotation=O.PostRotation.value),h[w]=ne}}h[w]&&(h[w][C.attr]=C)}else if(C.curves.morph!==void 0){if(h[w]===void 0){const M=connections.get(A.ID).parents.filter(function(Oe){return Oe.relationship!==void 0})[0].ID,O=connections.get(M).parents[0].ID,ne=connections.get(O).parents[0].ID,ce=connections.get(ne).parents[0].ID,ue=fbxTree.Objects.Model[ce],ye={modelName:ue.attrName?three_module.Nwf.sanitizeNodeName(ue.attrName):"",morphName:fbxTree.Objects.Deformer[M].attrName};h[w]=ye}h[w][C.attr]=C}}}),c.set(parseInt(u),h))}return c}parseAnimStacks(o){const l=fbxTree.Objects.AnimationStack,c={};for(const u in l){const h=connections.get(parseInt(u)).children;h.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const _=o.get(h[0].ID);c[u]={name:l[u].attrName,layer:_}}return c}addClip(o){let l=[];const c=this;return o.layer.forEach(function(u){l=l.concat(c.generateTracks(u))}),new three_module.tz3(o.name,-1,l)}generateTracks(o){const l=[];let c=new three_module.Pq0,u=new three_module.PTz,h=new three_module.Pq0;if(o.transform&&o.transform.decompose(c,u,h),c=c.toArray(),u=new three_module.O9p().setFromQuaternion(u,o.eulerOrder).toArray(),h=h.toArray(),o.T!==void 0&&Object.keys(o.T.curves).length>0){const _=this.generateVectorTrack(o.modelName,o.T.curves,c,"position");_!==void 0&&l.push(_)}if(o.R!==void 0&&Object.keys(o.R.curves).length>0){const _=this.generateRotationTrack(o.modelName,o.R.curves,u,o.preRotation,o.postRotation,o.eulerOrder);_!==void 0&&l.push(_)}if(o.S!==void 0&&Object.keys(o.S.curves).length>0){const _=this.generateVectorTrack(o.modelName,o.S.curves,h,"scale");_!==void 0&&l.push(_)}if(o.DeformPercent!==void 0){const _=this.generateMorphTrack(o);_!==void 0&&l.push(_)}return l}generateVectorTrack(o,l,c,u){const h=this.getTimesForAllAxes(l),_=this.getKeyframeTrackValues(h,l,c);return new three_module.RiT(o+"."+u,h,_)}generateRotationTrack(o,l,c,u,h,_){l.x!==void 0&&(this.interpolateRotations(l.x),l.x.values=l.x.values.map(three_module.cj9.degToRad)),l.y!==void 0&&(this.interpolateRotations(l.y),l.y.values=l.y.values.map(three_module.cj9.degToRad)),l.z!==void 0&&(this.interpolateRotations(l.z),l.z.values=l.z.values.map(three_module.cj9.degToRad));const A=this.getTimesForAllAxes(l),w=this.getKeyframeTrackValues(A,l,c);u!==void 0&&((u=u.map(three_module.cj9.degToRad)).push(_),u=new three_module.O9p().fromArray(u),u=new three_module.PTz().setFromEuler(u)),h!==void 0&&((h=h.map(three_module.cj9.degToRad)).push(_),h=new three_module.O9p().fromArray(h),h=new three_module.PTz().setFromEuler(h).invert());const C=new three_module.PTz,M=new three_module.O9p,O=[];for(let ne=0;ne<w.length;ne+=3)M.set(w[ne],w[ne+1],w[ne+2],_),C.setFromEuler(M),u!==void 0&&C.premultiply(u),h!==void 0&&C.multiply(h),C.toArray(O,ne/3*4);return new three_module.MBL(o+".quaternion",A,O)}generateMorphTrack(o){const l=o.DeformPercent.curves.morph,c=l.values.map(function(h){return h/100}),u=sceneGraph.getObjectByName(o.modelName).morphTargetDictionary[o.morphName];return new three_module.Hit(o.modelName+".morphTargetInfluences["+u+"]",l.times,c)}getTimesForAllAxes(o){let l=[];if(o.x!==void 0&&(l=l.concat(o.x.times)),o.y!==void 0&&(l=l.concat(o.y.times)),o.z!==void 0&&(l=l.concat(o.z.times)),l=l.sort(function(c,u){return c-u}),l.length>1){let c=1,u=l[0];for(let h=1;h<l.length;h++){const _=l[h];_!==u&&(l[c]=_,u=_,c++)}l=l.slice(0,c)}return l}getKeyframeTrackValues(o,l,c){const u=c,h=[];let _=-1,A=-1,w=-1;return o.forEach(function(C){if(l.x&&(_=l.x.times.indexOf(C)),l.y&&(A=l.y.times.indexOf(C)),l.z&&(w=l.z.times.indexOf(C)),_!==-1){const M=l.x.values[_];h.push(M),u[0]=M}else h.push(u[0]);if(A!==-1){const M=l.y.values[A];h.push(M),u[1]=M}else h.push(u[1]);if(w!==-1){const M=l.z.values[w];h.push(M),u[2]=M}else h.push(u[2])}),h}interpolateRotations(o){for(let l=1;l<o.values.length;l++){const c=o.values[l-1],u=o.values[l]-c,h=Math.abs(u);if(h>=180){const _=h/180,A=u/_;let w=c+A;const C=o.times[l-1],M=(o.times[l]-C)/_;let O=C+M;const ne=[],ce=[];for(;O<o.times[l];)ne.push(O),O+=M,ce.push(w),w+=A;o.times=inject(o.times,l,ne),o.values=inject(o.values,l,ce)}}}}class TextParser{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(o){this.nodeStack.push(o),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(o,l){this.currentProp=o,this.currentPropName=l}parse(o){this.currentIndent=0,this.allNodes=new FBXTree,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const l=this,c=o.split(/[\r\n]+/);return c.forEach(function(u,h){const _=u.match(/^[\s\t]*;/),A=u.match(/^[\s\t]*$/);if(_||A)return;const w=u.match("^\\t{"+l.currentIndent+"}(\\w+):(.*){",""),C=u.match("^\\t{"+l.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),M=u.match("^\\t{"+(l.currentIndent-1)+"}}");w?l.parseNodeBegin(u,w):C?l.parseNodeProperty(u,C,c[++h]):M?l.popStack():u.match(/^[^\s\t}]/)&&l.parseNodePropertyContinued(u)}),this.allNodes}parseNodeBegin(o,l){const c=l[1].trim().replace(/^"/,"").replace(/"$/,""),u=l[2].split(",").map(function(w){return w.trim().replace(/^"/,"").replace(/"$/,"")}),h={name:c},_=this.parseNodeAttr(u),A=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(c,h):c in A?(c==="PoseNode"?A.PoseNode.push(h):A[c].id!==void 0&&(A[c]={},A[c][A[c].id]=A[c]),_.id!==""&&(A[c][_.id]=h)):typeof _.id=="number"?(A[c]={},A[c][_.id]=h):c!=="Properties70"&&(A[c]=c==="PoseNode"?[h]:h),typeof _.id=="number"&&(h.id=_.id),_.name!==""&&(h.attrName=_.name),_.type!==""&&(h.attrType=_.type),this.pushStack(h)}parseNodeAttr(o){let l=o[0];o[0]!==""&&(l=parseInt(o[0]),isNaN(l)&&(l=o[0]));let c="",u="";return o.length>1&&(c=o[1].replace(/^(\w+)::/,""),u=o[2]),{id:l,name:c,type:u}}parseNodeProperty(o,l,c){let u=l[1].replace(/^"/,"").replace(/"$/,"").trim(),h=l[2].replace(/^"/,"").replace(/"$/,"").trim();u==="Content"&&h===","&&(h=c.replace(/"/g,"").replace(/,$/,"").trim());const _=this.getCurrentNode();if(_.name!=="Properties70"){if(u==="C"){const A=h.split(",").slice(1),w=parseInt(A[0]),C=parseInt(A[1]);let M=h.split(",").slice(3);M=M.map(function(O){return O.trim().replace(/^"/,"")}),u="connections",h=[w,C],append(h,M),_[u]===void 0&&(_[u]=[])}u==="Node"&&(_.id=h),u in _&&Array.isArray(_[u])?_[u].push(h):u!=="a"?_[u]=h:_.a=h,this.setCurrentProp(_,u),u==="a"&&h.slice(-1)!==","&&(_.a=parseNumberArray(h))}else this.parseNodeSpecialProperty(o,u,h)}parseNodePropertyContinued(o){const l=this.getCurrentNode();l.a+=o,o.slice(-1)!==","&&(l.a=parseNumberArray(l.a))}parseNodeSpecialProperty(o,l,c){const u=c.split('",').map(function(M){return M.trim().replace(/^\"/,"").replace(/\s/,"_")}),h=u[0],_=u[1],A=u[2],w=u[3];let C=u[4];switch(_){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":C=parseFloat(C);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":C=parseNumberArray(C)}this.getPrevNode()[h]={type:_,type2:A,flag:w,value:C},this.setCurrentProp(this.getPrevNode(),h)}}class BinaryParser{parse(o){const l=new BinaryReader(o);l.skip(23);const c=l.getUint32();if(c<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+c);const u=new FBXTree;for(;!this.endOfContent(l);){const h=this.parseNode(l,c);h!==null&&u.add(h.name,h)}return u}endOfContent(o){return o.size()%16==0?(o.getOffset()+160+16&-16)>=o.size():o.getOffset()+160+16>=o.size()}parseNode(o,l){const c={},u=l>=7500?o.getUint64():o.getUint32(),h=l>=7500?o.getUint64():o.getUint32();l>=7500?o.getUint64():o.getUint32();const _=o.getUint8(),A=o.getString(_);if(u===0)return null;const w=[];for(let ne=0;ne<h;ne++)w.push(this.parseProperty(o));const C=w.length>0?w[0]:"",M=w.length>1?w[1]:"",O=w.length>2?w[2]:"";for(c.singleProperty=h===1&&o.getOffset()===u;u>o.getOffset();){const ne=this.parseNode(o,l);ne!==null&&this.parseSubNode(A,c,ne)}return c.propertyList=w,typeof C=="number"&&(c.id=C),M!==""&&(c.attrName=M),O!==""&&(c.attrType=O),A!==""&&(c.name=A),c}parseSubNode(o,l,c){if(c.singleProperty===!0){const u=c.propertyList[0];Array.isArray(u)?(l[c.name]=c,c.a=u):l[c.name]=u}else if(o==="Connections"&&c.name==="C"){const u=[];c.propertyList.forEach(function(h,_){_!==0&&u.push(h)}),l.connections===void 0&&(l.connections=[]),l.connections.push(u)}else if(c.name==="Properties70")Object.keys(c).forEach(function(u){l[u]=c[u]});else if(o==="Properties70"&&c.name==="P"){let u=c.propertyList[0],h=c.propertyList[1];const _=c.propertyList[2],A=c.propertyList[3];let w;u.indexOf("Lcl ")===0&&(u=u.replace("Lcl ","Lcl_")),h.indexOf("Lcl ")===0&&(h=h.replace("Lcl ","Lcl_")),w=h==="Color"||h==="ColorRGB"||h==="Vector"||h==="Vector3D"||h.indexOf("Lcl_")===0?[c.propertyList[4],c.propertyList[5],c.propertyList[6]]:c.propertyList[4],l[u]={type:h,type2:_,flag:A,value:w}}else l[c.name]===void 0?typeof c.id=="number"?(l[c.name]={},l[c.name][c.id]=c):l[c.name]=c:c.name==="PoseNode"?(Array.isArray(l[c.name])||(l[c.name]=[l[c.name]]),l[c.name].push(c)):l[c.name][c.id]===void 0&&(l[c.name][c.id]=c)}parseProperty(o){const l=o.getString(1);let c;switch(l){case"C":return o.getBoolean();case"D":return o.getFloat64();case"F":return o.getFloat32();case"I":return o.getInt32();case"L":return o.getInt64();case"R":return c=o.getUint32(),o.getArrayBuffer(c);case"S":return c=o.getUint32(),o.getString(c);case"Y":return o.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const u=o.getUint32(),h=o.getUint32(),_=o.getUint32();if(h===0)switch(l){case"b":case"c":return o.getBooleanArray(u);case"d":return o.getFloat64Array(u);case"f":return o.getFloat32Array(u);case"i":return o.getInt32Array(u);case"l":return o.getInt64Array(u)}const A=fflate_module_unzlibSync(new Uint8Array(o.getArrayBuffer(_))),w=new BinaryReader(A.buffer);switch(l){case"b":case"c":return w.getBooleanArray(u);case"d":return w.getFloat64Array(u);case"f":return w.getFloat32Array(u);case"i":return w.getInt32Array(u);case"l":return w.getInt64Array(u)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+l)}}}class BinaryReader{constructor(o,l){this.dv=new DataView(o),this.offset=0,this.littleEndian=l===void 0||l,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(o){this.offset+=o}getBoolean(){return!(1&~this.getUint8())}getBooleanArray(o){const l=[];for(let c=0;c<o;c++)l.push(this.getBoolean());return l}getUint8(){const o=this.dv.getUint8(this.offset);return this.offset+=1,o}getInt16(){const o=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,o}getInt32(){const o=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,o}getInt32Array(o){const l=[];for(let c=0;c<o;c++)l.push(this.getInt32());return l}getUint32(){const o=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,o}getInt64(){let o,l;return this.littleEndian?(o=this.getUint32(),l=this.getUint32()):(l=this.getUint32(),o=this.getUint32()),2147483648&l?(l=4294967295&~l,o=4294967295&~o,o===4294967295&&(l=l+1&4294967295),o=o+1&4294967295,-(4294967296*l+o)):4294967296*l+o}getInt64Array(o){const l=[];for(let c=0;c<o;c++)l.push(this.getInt64());return l}getUint64(){let o,l;return this.littleEndian?(o=this.getUint32(),l=this.getUint32()):(l=this.getUint32(),o=this.getUint32()),4294967296*l+o}getFloat32(){const o=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,o}getFloat32Array(o){const l=[];for(let c=0;c<o;c++)l.push(this.getFloat32());return l}getFloat64(){const o=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,o}getFloat64Array(o){const l=[];for(let c=0;c<o;c++)l.push(this.getFloat64());return l}getArrayBuffer(o){const l=this.dv.buffer.slice(this.offset,this.offset+o);return this.offset+=o,l}getString(o){const l=this.offset;let c=new Uint8Array(this.dv.buffer,l,o);this.skip(o);const u=c.indexOf(0);return u>=0&&(c=new Uint8Array(this.dv.buffer,l,u)),this._textDecoder.decode(c)}}class FBXTree{add(o,l){this[o]=l}}function isFbxFormatBinary(d){return d.byteLength>=21&&convertArrayBufferToString(d,0,21)==="Kaydara FBX Binary  \0"}function isFbxFormatASCII(d){const o=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let l=0;function c(u){const h=d[u-1];return d=d.slice(l+u),l++,h}for(let u=0;u<o.length;++u)if(c(1)===o[u])return!1;return!0}function getFbxVersion(d){const o=d.match(/FBXVersion: (\d+)/);if(o)return parseInt(o[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function convertFBXTimeToSeconds(d){return d/46186158e3}const dataArray=[];function getData(d,o,l,c){let u;switch(c.mappingType){case"ByPolygonVertex":u=d;break;case"ByPolygon":u=o;break;case"ByVertice":u=l;break;case"AllSame":u=c.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+c.mappingType)}c.referenceType==="IndexToDirect"&&(u=c.indices[u]);const h=u*c.dataSize,_=h+c.dataSize;return slice(dataArray,c.buffer,h,_)}const tempEuler=new three_module.O9p,FBXLoader_tempVec=new three_module.Pq0;function generateTransform(d){const o=new three_module.kn4,l=new three_module.kn4,c=new three_module.kn4,u=new three_module.kn4,h=new three_module.kn4,_=new three_module.kn4,A=new three_module.kn4,w=new three_module.kn4,C=new three_module.kn4,M=new three_module.kn4,O=new three_module.kn4,ne=new three_module.kn4,ce=d.inheritType?d.inheritType:0;if(d.translation&&o.setPosition(FBXLoader_tempVec.fromArray(d.translation)),d.preRotation){const xt=d.preRotation.map(three_module.cj9.degToRad);xt.push(d.eulerOrder||three_module.O9p.DEFAULT_ORDER),l.makeRotationFromEuler(tempEuler.fromArray(xt))}if(d.rotation){const xt=d.rotation.map(three_module.cj9.degToRad);xt.push(d.eulerOrder||three_module.O9p.DEFAULT_ORDER),c.makeRotationFromEuler(tempEuler.fromArray(xt))}if(d.postRotation){const xt=d.postRotation.map(three_module.cj9.degToRad);xt.push(d.eulerOrder||three_module.O9p.DEFAULT_ORDER),u.makeRotationFromEuler(tempEuler.fromArray(xt)),u.invert()}d.scale&&h.scale(FBXLoader_tempVec.fromArray(d.scale)),d.scalingOffset&&A.setPosition(FBXLoader_tempVec.fromArray(d.scalingOffset)),d.scalingPivot&&_.setPosition(FBXLoader_tempVec.fromArray(d.scalingPivot)),d.rotationOffset&&w.setPosition(FBXLoader_tempVec.fromArray(d.rotationOffset)),d.rotationPivot&&C.setPosition(FBXLoader_tempVec.fromArray(d.rotationPivot)),d.parentMatrixWorld&&(O.copy(d.parentMatrix),M.copy(d.parentMatrixWorld));const ue=l.clone().multiply(c).multiply(u),ye=new three_module.kn4;ye.extractRotation(M);const Oe=new three_module.kn4;Oe.copyPosition(M);const ke=Oe.clone().invert().multiply(M),Ve=ye.clone().invert().multiply(ke),tt=h,ht=new three_module.kn4;if(ce===0)ht.copy(ye).multiply(ue).multiply(Ve).multiply(tt);else if(ce===1)ht.copy(ye).multiply(Ve).multiply(ue).multiply(tt);else{const xt=new three_module.kn4().scale(new three_module.Pq0().setFromMatrixScale(O)).clone().invert(),Tt=Ve.clone().multiply(xt);ht.copy(ye).multiply(ue).multiply(Tt).multiply(tt)}const ut=C.clone().invert(),_t=_.clone().invert();let at=o.clone().multiply(w).multiply(C).multiply(l).multiply(c).multiply(u).multiply(ut).multiply(A).multiply(_).multiply(h).multiply(_t);const lt=new three_module.kn4().copyPosition(at),pt=M.clone().multiply(lt);return ne.copyPosition(pt),at=ne.clone().multiply(ht),at.premultiply(M.invert()),at}function getEulerOrder(d){const o=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return(d=d||0)===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),o[0]):o[d]}function parseNumberArray(d){return d.split(",").map(function(o){return parseFloat(o)})}function convertArrayBufferToString(d,o,l){return o===void 0&&(o=0),l===void 0&&(l=d.byteLength),new TextDecoder().decode(new Uint8Array(d,o,l))}function append(d,o){for(let l=0,c=d.length,u=o.length;l<u;l++,c++)d[c]=o[l]}function slice(d,o,l,c){for(let u=l,h=0;u<c;u++,h++)d[h]=o[u];return d}function inject(d,o,l){return d.slice(0,o).concat(l).concat(d.slice(o))}class FBXLoader2 extends FBXLoader{async loadAsync(o,l){const c=three_module.gPd.DEFAULT_IMAGE;three_module.gPd.DEFAULT_IMAGE||(three_module.gPd.DEFAULT_IMAGE=AssetImporter.WHITE_IMAGE_DATA);const u=await super.loadAsync(o,l);return three_module.gPd.DEFAULT_IMAGE=c,u}}class FBXLoadPlugin extends I{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin],this._importer=new Importer(FBXLoader2,["fbx"],!0)}async onAdded(o){var l,c;(c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0||c.Importers.push(this._importer)}async onDispose(o){}async onRemove(o){var l,c,u,h;!((c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0)&&c.Importers&&((h=(u=o.getManager())===null||u===void 0?void 0:u.importer)===null||h===void 0||h.Importers.splice(o.getManager().importer.Importers.indexOf(this._importer),1))}}FBXLoadPlugin.PluginType="FBXLoadPlugin";const camera=new three_module.ubm(45,1,.1,1e3);function snapObject(d,o,l,c=7,u=new three_module.Pq0(0,0,1.5)){l=l??d.scene.modelObject;const h=new Box3B().expandByObject(l??o,!0,!0),_=h.getCenter(new three_module.Pq0),A=h.getSize(new three_module.Pq0);camera.position.copy(_).add(u.clone().multiplyScalar(Math.max(A.x,A.y,A.z))),camera.lookAt(_),o&&o.traverseVisible(M=>{M.layers.enable(c)}),c>0?camera.layers.set(c):camera.layers.enableAll();const w=o==null?void 0:o.visible;o&&(o.visible=!0),d.renderer.rendererObject.setRenderTarget(null),d.renderer.rendererObject.render(l,camera);const C=d.renderer.rendererObject.domElement.toDataURL("image/png");return o&&(o.visible=w,o.traverseVisible(M=>{M.layers.disable(c)}),camera.layers.enableAll()),d.setDirty(),C}class MaterialPreviewGenerator{constructor(o){this.viewer=o,this._lights=[],this.shapes={sphere:new three_module.eaF(new three_module.Gu$(1)),cube:new three_module.eaF(new three_module.iNn(1,1,1)),cylinder:new three_module.eaF(new three_module.Ho_(.5,.5,1))};const l=new three_module.Z58;this._channel=7;const c=new three_module.dth(16777215,4473924,1);c.position.set(0,10,0),c.layers.set(this._channel),l.add(c),this._lights.push(c),this._scene=l}dispose(){[...this._lights].forEach(o=>o.dispose()),Object.values(this.shapes).forEach(o=>{o.geometry&&o.geometry.dispose()})}generate(o,l="sphere"){const c=this.shapes[l]||new three_module.eaF(new three_module.Gu$(1));c.material=o.materialObject,c.geometry.attributes.tangent||c.geometry.computeTangents(),this._scene.add(c),this._scene.environment=this.viewer.scene.environment;const u=c.material.envMapIntensity;typeof u=="number"&&(c.material.envMapIntensity=Math.max(u,2));const h=snapObject(this.viewer,c,this._scene,this._channel,new three_module.Pq0(0,0,1.5));return typeof u=="number"&&(c.material.envMapIntensity=u),this._scene.remove(c),c.material=void 0,h}}var MaterialConfiguratorBasePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class MaterialConfiguratorBasePlugin extends AViewerPlugin{constructor(){super(),this.enabled=!0,this._uiNeedRefresh=!1,this.applyOnLoad=!0,this._refreshUiConfig=()=>{var o,l;this.enabled&&((l=(o=this.uiConfig).uiRefresh)===null||l===void 0||l.call(o))},this.dependencies=[AssetManagerPlugin],this.variations=[],this._selectedMaterial=()=>{var o,l;return((l=(o=this._picking)===null||o===void 0?void 0:o.getSelectedObject())===null||l===void 0?void 0:l.material)||void 0},this.uiConfig={label:"Material Configurator",type:"folder",children:[()=>{var o;return[{type:"input",label:"uuid",property:[this._selectedMaterial(),"uuid"],hidden:()=>!this._selectedMaterial(),disabled:!0},{type:"input",label:"mapping",hidden:()=>!this._selectedMaterial(),property:()=>[this.getSelectedVariation(),"uuid"],onChange:async()=>this.refreshUi()},{type:"input",label:"title",hidden:()=>!this._selectedMaterial(),property:()=>[this.getSelectedVariation(),"title"],onChange:async()=>this.refreshUi()},{type:"dropdown",label:"Preview Type",hidden:()=>!this._selectedMaterial(),property:()=>[this.getSelectedVariation(),"preview"],onChange:async()=>this.refreshUi(),children:["generate:sphere","generate:cube","color","map","emissive",...Object.keys(standardMaterialPropList).filter(l=>l.endsWith("Map"))].map(l=>({label:l,value:l}))},...((o=this.getSelectedVariation())===null||o===void 0?void 0:o.materials.map(l=>l.uiConfig?Object.assign(l.uiConfig,{expanded:!1}):{}))||[],{type:"button",label:"Clear variations",hidden:()=>!this._selectedMaterial(),value:async()=>{const l=this.getSelectedVariation();l&&await this._viewer.confirm("Material configurator: Remove all variations for this material?")&&(l.materials=[]),this.refreshUi()}},{type:"button",label:"Remove completely",hidden:()=>!this._selectedMaterial(),value:async()=>{const l=this.getSelectedVariation();l&&await this._viewer.confirm("Material configurator: Remove this variation?")&&this.removeVariation(l)}},{type:"button",label:"Add Variation",hidden:()=>!this._selectedMaterial(),value:async()=>{var l;const c=this._selectedMaterial();c&&(c.name||await((l=this._viewer)===null||l===void 0?void 0:l.confirm("Material configurator: Material has no name. Use uuid instead?")))&&this.addVariation(c)}},{type:"button",label:"Refresh Ui",value:()=>this.refreshUi()},{type:"button",label:"Apply All",value:()=>{this.variations.forEach(async l=>this.applyVariation(l,l.materials[0].uuid))}}]}]},this.addEventListener("deserialize",this.refreshUi),this.refreshUi=this.refreshUi.bind(this),this._refreshUi=this._refreshUi.bind(this)}async onAdded(o){var l,c;await super.onAdded(o),this._picking=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("Picking"),this._previewGenerator=new MaterialPreviewGenerator(this._viewer),(c=this._picking)===null||c===void 0||c.addEventListener("selectedObjectChanged",this._refreshUiConfig),o.addEventListener("preFrame",this._refreshUi)}reapplyAll(){this.variations.forEach(async o=>{var l;return this.applyVariation(o,o.materials[(l=o.selectedIndex)!==null&&l!==void 0?l:0].uuid)})}fromJSON(o,l){return this.variations=[],super.fromJSON(o,l)?(o.applyOnLoad===void 0&&(this.applyOnLoad=!1),this.applyOnLoad&&this.reapplyAll(),this):null}async onRemove(o){var l,c;return(l=this._previewGenerator)===null||l===void 0||l.dispose(),this._previewGenerator=void 0,(c=this._picking)===null||c===void 0||c.removeEventListener("selectedObjectChanged",this._refreshUiConfig),this.removeEventListener("deserialize",this.refreshUi),o.removeEventListener("preFrame",this._refreshUi),this._picking=void 0,super.onRemove(o)}findVariation(o){return o?this.variations.find(l=>l.uuid===o):void 0}getSelectedVariation(){var o,l;return this.findVariation((o=this._selectedMaterial())===null||o===void 0?void 0:o.uuid)||this.findVariation((l=this._selectedMaterial())===null||l===void 0?void 0:l.name)}applyVariation(o,l){var c,u;const h=(u=(c=this._viewer)===null||c===void 0?void 0:c.getManager())===null||u===void 0?void 0:u.materials;if(!h)return!1;const _=typeof l=="string"?o.materials.find(A=>A.uuid===l):o.materials[l];return!!_&&(o.selectedIndex=o.materials.indexOf(_),h.applyMaterial(_,o.uuid))}getPreview(o,l,c=!0){if(!this._viewer)return"";const u=o;if(!u)return"";let h="";if(l.startsWith("generate:"))h=this._previewGenerator.generate(u,l.split(":")[1]);else{const _=u[l]||"#ff00ff";h=_.image?Ne(_.image,100):"",h.length||(h=Ge(_.isColor?_.getHexString():_))}return c&&this._viewer.setDirty(),h}refreshUi(){this.enabled&&this._viewer&&(this._uiNeedRefresh=!0)}async _refreshUi(){return!(!this.enabled||!this._viewer||!this._uiNeedRefresh||(this._uiNeedRefresh=!1,this._refreshUiConfig(),0))}removeVariationForMaterial(o){let l=this.findVariation(o.uuid);!l&&o.name.length>0&&(l=this.findVariation(o.name)),l&&this.removeVariation(l)}removeVariation(o){o&&(this.variations.splice(this.variations.indexOf(o),1),this.refreshUi())}addVariation(o,l,c=!0){var u;const h=c?(u=o==null?void 0:o.clone)===null||u===void 0?void 0:u.call(o):o;if(o&&h){let _=this.findVariation(l??o.uuid);!_&&!l&&o.name.length>0&&(_=this.findVariation(o.name)),_||(_=this.createVariation(o,l)),_.materials.push(h),this.refreshUi()}}createVariation(o,l){return this.variations.push({uuid:l??o.name.length>0?o.name:o.uuid,title:o.name.length>0?o.name:"No Name",preview:"generate:sphere",materials:[]}),this.variations[this.variations.length-1]}}MaterialConfiguratorBasePlugin.PluginType="MaterialConfiguratorPlugin",MaterialConfiguratorBasePlugin_decorate([serialize()],MaterialConfiguratorBasePlugin.prototype,"variations",void 0);class CustomContextGrid{static _initializeStyles(){P($`
  .customContextGrid {
    background: #eeeeee55;
    border: 0.5px solid rgba(220, 220, 220, 0.2);
    width: auto;
    height: auto;
    position: absolute;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    z-index: 200;
    padding: 0.35rem 0.35rem;
    border-radius: 0.375rem;
    min-width: 5rem;
    pointer-events: auto;
    box-shadow: 0px 2px 6px rgba(12, 12, 12, 0.2);

    color: #111111;
    font-size: 0.65rem;
    font-family: Inter, "Roboto Mono", "Source Code Pro", Menlo, Courier, monospace;
    backdrop-filter: blur(20px);
  }
  .customContextGridItems {
    background-color: transparent;
    cursor: pointer;
    border-radius: 0.25rem;
    line-height: 1rem;
    font-weight: 500;
    overflow: hidden;
    margin: 0.12rem;
  }

  .customContextGridItems:hover {
    color: white;
    //background-color: #017AFF;
    box-shadow: 0 0 7px 0px rgba(64, 64, 64, 0.3);
  }
  .customContextGridItemImage{
    width: 100%;
    height: 100%;
  }
  .customContextGridHeading{
    width: 100%;
    padding: 5px;
    font-size: 0.85rem;
  }
  .customContextGridParent{
    position: absolute;
    top: 0;
    left: 0;
    width: 270px;
    height: calc(100% - 100px);
    overflow-y: scroll;
    z-index: 100;
    display: flex;
    flex-direction: column;
    margin-bottom: 50px;
    margin-top: 50px;
  }
  /* Hide scrollbar for Chrome, Safari and Opera */
  .customContextGridParent::-webkit-scrollbar {
    display: none;
  }
  /* Hide scrollbar for IE, Edge and Firefox */
  .customContextGridParent {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }

        `,this._container),this._container.style.position="absolute",this._container.style.top="0",this._container.style.left="0",this._container.style.width="270px",this._container.style.height="100%",this._container.style.pointerEvents="none",this._container.style.zIndex="100",this._container.style.overflowY="auto"}static Create(o,l,c,u,h,_,A){var w;const C=we(),M=C?.15:.25,O=C?1.5:2.5,ne=ee({classList:["customContextGrid"],addToBody:!1,innerHTML:`
            <div class="customContextGridHeading"> ${l} </div>
            `});ne.style.top=h+"px",ne.style.left=u+"px",ne.style.gap=M+"rem",ne.style.width=(O+M)*c-M+"rem",ne.dataset.tag=o;for(const ce of _){const ue=ee({classList:["customContextGridItems"],addToBody:!1,innerHTML:`
            <img src="${ce.image}" class="customContextGridItemImage">
            `});ue.style.width=O+"rem",ue.style.height=O+"rem",ne.appendChild(ue),ue.onclick=()=>{var ye;return(ye=ce.onClick)===null||ye===void 0?void 0:ye.call(ce,ce.id)},A(ue,ce,ne)}return(w=this.Elements)===null||w===void 0||w.push(ne),ne}static RemoveAll(o){if(o){const l=this.Elements.filter(c=>c.dataset.tag===o);for(const c of l)c.remove();this.Elements=this.Elements.filter(c=>c.dataset.tag!==o)}else{for(const l of this.Elements)l.remove();this.Elements=[]}}static RebuildUi(o){if(this.Elements.length===0)return;o||(o=ee({addToBody:!0,classList:["customContextGridParent"]}));for(const c of this.Elements)c.remove();this._container.innerHTML="",this._initializeStyles();let l=20;o.appendChild(this._container);for(const c of this.Elements)c.style.top=l+"px",this._container.appendChild(c),l+=c.clientHeight+20}}function getWindow(d){if(d==null)return window;if(d.toString()!=="[object Window]"){var o=d.ownerDocument;return o&&o.defaultView||window}return d}function isElement(d){return d instanceof getWindow(d).Element||d instanceof Element}function isHTMLElement(d){return d instanceof getWindow(d).HTMLElement||d instanceof HTMLElement}function isShadowRoot(d){return typeof ShadowRoot<"u"&&(d instanceof getWindow(d).ShadowRoot||d instanceof ShadowRoot)}CustomContextGrid.Elements=[],CustomContextGrid._container=document.createElement("div");var math_max=Math.max,math_min=Math.min,round=Math.round;function getUAString(){var d=navigator.userAgentData;return d!=null&&d.brands&&Array.isArray(d.brands)?d.brands.map(function(o){return o.brand+"/"+o.version}).join(" "):navigator.userAgent}function isLayoutViewport(){return!/^((?!chrome|android).)*safari/i.test(getUAString())}function getBoundingClientRect(d,o,l){o===void 0&&(o=!1),l===void 0&&(l=!1);var c=d.getBoundingClientRect(),u=1,h=1;o&&isHTMLElement(d)&&(u=d.offsetWidth>0&&round(c.width)/d.offsetWidth||1,h=d.offsetHeight>0&&round(c.height)/d.offsetHeight||1);var _=(isElement(d)?getWindow(d):window).visualViewport,A=!isLayoutViewport()&&l,w=(c.left+(A&&_?_.offsetLeft:0))/u,C=(c.top+(A&&_?_.offsetTop:0))/h,M=c.width/u,O=c.height/h;return{width:M,height:O,top:C,right:w+M,bottom:C+O,left:w,x:w,y:C}}function getWindowScroll(d){var o=getWindow(d);return{scrollLeft:o.pageXOffset,scrollTop:o.pageYOffset}}function getHTMLElementScroll(d){return{scrollLeft:d.scrollLeft,scrollTop:d.scrollTop}}function getNodeScroll(d){return d!==getWindow(d)&&isHTMLElement(d)?getHTMLElementScroll(d):getWindowScroll(d)}function getNodeName(d){return d?(d.nodeName||"").toLowerCase():null}function getDocumentElement(d){return((isElement(d)?d.ownerDocument:d.document)||window.document).documentElement}function getWindowScrollBarX(d){return getBoundingClientRect(getDocumentElement(d)).left+getWindowScroll(d).scrollLeft}function getComputedStyle(d){return getWindow(d).getComputedStyle(d)}function isScrollParent(d){var o=getComputedStyle(d),l=o.overflow,c=o.overflowX,u=o.overflowY;return/auto|scroll|overlay|hidden/.test(l+u+c)}function isElementScaled(d){var o=d.getBoundingClientRect(),l=round(o.width)/d.offsetWidth||1,c=round(o.height)/d.offsetHeight||1;return l!==1||c!==1}function getCompositeRect(d,o,l){l===void 0&&(l=!1);var c=isHTMLElement(o),u=isHTMLElement(o)&&isElementScaled(o),h=getDocumentElement(o),_=getBoundingClientRect(d,u,l),A={scrollLeft:0,scrollTop:0},w={x:0,y:0};return(c||!c&&!l)&&((getNodeName(o)!=="body"||isScrollParent(h))&&(A=getNodeScroll(o)),isHTMLElement(o)?((w=getBoundingClientRect(o,!0)).x+=o.clientLeft,w.y+=o.clientTop):h&&(w.x=getWindowScrollBarX(h))),{x:_.left+A.scrollLeft-w.x,y:_.top+A.scrollTop-w.y,width:_.width,height:_.height}}function getLayoutRect(d){var o=getBoundingClientRect(d),l=d.offsetWidth,c=d.offsetHeight;return Math.abs(o.width-l)<=1&&(l=o.width),Math.abs(o.height-c)<=1&&(c=o.height),{x:d.offsetLeft,y:d.offsetTop,width:l,height:c}}function getParentNode(d){return getNodeName(d)==="html"?d:d.assignedSlot||d.parentNode||(isShadowRoot(d)?d.host:null)||getDocumentElement(d)}function getScrollParent(d){return["html","body","#document"].indexOf(getNodeName(d))>=0?d.ownerDocument.body:isHTMLElement(d)&&isScrollParent(d)?d:getScrollParent(getParentNode(d))}function listScrollParents(d,o){var l;o===void 0&&(o=[]);var c=getScrollParent(d),u=c===((l=d.ownerDocument)==null?void 0:l.body),h=getWindow(c),_=u?[h].concat(h.visualViewport||[],isScrollParent(c)?c:[]):c,A=o.concat(_);return u?A:A.concat(listScrollParents(getParentNode(_)))}function isTableElement(d){return["table","td","th"].indexOf(getNodeName(d))>=0}function getTrueOffsetParent(d){return isHTMLElement(d)&&getComputedStyle(d).position!=="fixed"?d.offsetParent:null}function getContainingBlock(d){var o=/firefox/i.test(getUAString());if(/Trident/i.test(getUAString())&&isHTMLElement(d)&&getComputedStyle(d).position==="fixed")return null;var l=getParentNode(d);for(isShadowRoot(l)&&(l=l.host);isHTMLElement(l)&&["html","body"].indexOf(getNodeName(l))<0;){var c=getComputedStyle(l);if(c.transform!=="none"||c.perspective!=="none"||c.contain==="paint"||["transform","perspective"].indexOf(c.willChange)!==-1||o&&c.willChange==="filter"||o&&c.filter&&c.filter!=="none")return l;l=l.parentNode}return null}function getOffsetParent(d){for(var o=getWindow(d),l=getTrueOffsetParent(d);l&&isTableElement(l)&&getComputedStyle(l).position==="static";)l=getTrueOffsetParent(l);return l&&(getNodeName(l)==="html"||getNodeName(l)==="body"&&getComputedStyle(l).position==="static")?o:l||getContainingBlock(d)||o}var enums_top="top",bottom="bottom",right="right",left="left",auto="auto",basePlacements=[enums_top,bottom,right,left],start="start",end="end",clippingParents="clippingParents",viewport="viewport",popper="popper",reference="reference",variationPlacements=basePlacements.reduce(function(d,o){return d.concat([o+"-"+start,o+"-"+end])},[]),enums_placements=[].concat(basePlacements,[auto]).reduce(function(d,o){return d.concat([o,o+"-"+start,o+"-"+end])},[]),beforeRead="beforeRead",enums_read="read",afterRead="afterRead",beforeMain="beforeMain",main="main",afterMain="afterMain",beforeWrite="beforeWrite",write="write",afterWrite="afterWrite",modifierPhases=[beforeRead,enums_read,afterRead,beforeMain,main,afterMain,beforeWrite,write,afterWrite];function order(d){var o=new Map,l=new Set,c=[];function u(h){l.add(h.name),[].concat(h.requires||[],h.requiresIfExists||[]).forEach(function(_){if(!l.has(_)){var A=o.get(_);A&&u(A)}}),c.push(h)}return d.forEach(function(h){o.set(h.name,h)}),d.forEach(function(h){l.has(h.name)||u(h)}),c}function orderModifiers(d){var o=order(d);return modifierPhases.reduce(function(l,c){return l.concat(o.filter(function(u){return u.phase===c}))},[])}function debounce(d){var o;return function(){return o||(o=new Promise(function(l){Promise.resolve().then(function(){o=void 0,l(d())})})),o}}function mergeByName(d){var o=d.reduce(function(l,c){var u=l[c.name];return l[c.name]=u?Object.assign({},u,c,{options:Object.assign({},u.options,c.options),data:Object.assign({},u.data,c.data)}):c,l},{});return Object.keys(o).map(function(l){return o[l]})}var DEFAULT_OPTIONS={placement:"bottom",modifiers:[],strategy:"absolute"};function areValidElements(){for(var d=arguments.length,o=new Array(d),l=0;l<d;l++)o[l]=arguments[l];return!o.some(function(c){return!(c&&typeof c.getBoundingClientRect=="function")})}function popperGenerator(d){d===void 0&&(d={});var o=d,l=o.defaultModifiers,c=l===void 0?[]:l,u=o.defaultOptions,h=u===void 0?DEFAULT_OPTIONS:u;return function(_,A,w){w===void 0&&(w=h);var C={placement:"bottom",orderedModifiers:[],options:Object.assign({},DEFAULT_OPTIONS,h),modifiersData:{},elements:{reference:_,popper:A},attributes:{},styles:{}},M=[],O=!1,ne={state:C,setOptions:function(ue){var ye=typeof ue=="function"?ue(C.options):ue;ce(),C.options=Object.assign({},h,C.options,ye),C.scrollParents={reference:isElement(_)?listScrollParents(_):_.contextElement?listScrollParents(_.contextElement):[],popper:listScrollParents(A)};var Oe=orderModifiers(mergeByName([].concat(c,C.options.modifiers)));return C.orderedModifiers=Oe.filter(function(ke){return ke.enabled}),C.orderedModifiers.forEach(function(ke){var Ve=ke.name,tt=ke.options,ht=tt===void 0?{}:tt,ut=ke.effect;if(typeof ut=="function"){var _t=ut({state:C,name:Ve,instance:ne,options:ht});M.push(_t||function(){})}}),ne.update()},forceUpdate:function(){if(!O){var ue=C.elements,ye=ue.reference,Oe=ue.popper;if(areValidElements(ye,Oe)){C.rects={reference:getCompositeRect(ye,getOffsetParent(Oe),C.options.strategy==="fixed"),popper:getLayoutRect(Oe)},C.reset=!1,C.placement=C.options.placement,C.orderedModifiers.forEach(function(at){return C.modifiersData[at.name]=Object.assign({},at.data)});for(var ke=0;ke<C.orderedModifiers.length;ke++)if(C.reset!==!0){var Ve=C.orderedModifiers[ke],tt=Ve.fn,ht=Ve.options,ut=ht===void 0?{}:ht,_t=Ve.name;typeof tt=="function"&&(C=tt({state:C,options:ut,name:_t,instance:ne})||C)}else C.reset=!1,ke=-1}}},update:debounce(function(){return new Promise(function(ue){ne.forceUpdate(),ue(C)})}),destroy:function(){ce(),O=!0}};if(!areValidElements(_,A))return ne;function ce(){M.forEach(function(ue){return ue()}),M=[]}return ne.setOptions(w).then(function(ue){!O&&w.onFirstUpdate&&w.onFirstUpdate(ue)}),ne}}var createPopper=popperGenerator(),passive={passive:!0};function effect(d){var o=d.state,l=d.instance,c=d.options,u=c.scroll,h=u===void 0||u,_=c.resize,A=_===void 0||_,w=getWindow(o.elements.popper),C=[].concat(o.scrollParents.reference,o.scrollParents.popper);return h&&C.forEach(function(M){M.addEventListener("scroll",l.update,passive)}),A&&w.addEventListener("resize",l.update,passive),function(){h&&C.forEach(function(M){M.removeEventListener("scroll",l.update,passive)}),A&&w.removeEventListener("resize",l.update,passive)}}var eventListeners={name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect,data:{}};function getBasePlacement(d){return d.split("-")[0]}function getVariation(d){return d.split("-")[1]}function getMainAxisFromPlacement(d){return["top","bottom"].indexOf(d)>=0?"x":"y"}function computeOffsets(d){var o,l=d.reference,c=d.element,u=d.placement,h=u?getBasePlacement(u):null,_=u?getVariation(u):null,A=l.x+l.width/2-c.width/2,w=l.y+l.height/2-c.height/2;switch(h){case enums_top:o={x:A,y:l.y-c.height};break;case bottom:o={x:A,y:l.y+l.height};break;case right:o={x:l.x+l.width,y:w};break;case left:o={x:l.x-c.width,y:w};break;default:o={x:l.x,y:l.y}}var C=h?getMainAxisFromPlacement(h):null;if(C!=null){var M=C==="y"?"height":"width";switch(_){case start:o[C]=o[C]-(l[M]/2-c[M]/2);break;case end:o[C]=o[C]+(l[M]/2-c[M]/2)}}return o}function popperOffsets(d){var o=d.state,l=d.name;o.modifiersData[l]=computeOffsets({reference:o.rects.reference,element:o.rects.popper,strategy:"absolute",placement:o.placement})}var modifiers_popperOffsets={name:"popperOffsets",enabled:!0,phase:"read",fn:popperOffsets,data:{}},unsetSides={top:"auto",right:"auto",bottom:"auto",left:"auto"};function roundOffsetsByDPR(d,o){var l=d.x,c=d.y,u=o.devicePixelRatio||1;return{x:round(l*u)/u||0,y:round(c*u)/u||0}}function mapToStyles(d){var o,l=d.popper,c=d.popperRect,u=d.placement,h=d.variation,_=d.offsets,A=d.position,w=d.gpuAcceleration,C=d.adaptive,M=d.roundOffsets,O=d.isFixed,ne=_.x,ce=ne===void 0?0:ne,ue=_.y,ye=ue===void 0?0:ue,Oe=typeof M=="function"?M({x:ce,y:ye}):{x:ce,y:ye};ce=Oe.x,ye=Oe.y;var ke=_.hasOwnProperty("x"),Ve=_.hasOwnProperty("y"),tt=left,ht=enums_top,ut=window;if(C){var _t=getOffsetParent(l),at="clientHeight",lt="clientWidth";_t===getWindow(l)&&getComputedStyle(_t=getDocumentElement(l)).position!=="static"&&A==="absolute"&&(at="scrollHeight",lt="scrollWidth"),(u===enums_top||(u===left||u===right)&&h===end)&&(ht=bottom,ye-=(O&&_t===ut&&ut.visualViewport?ut.visualViewport.height:_t[at])-c.height,ye*=w?1:-1),u!==left&&(u!==enums_top&&u!==bottom||h!==end)||(tt=right,ce-=(O&&_t===ut&&ut.visualViewport?ut.visualViewport.width:_t[lt])-c.width,ce*=w?1:-1)}var pt,xt=Object.assign({position:A},C&&unsetSides),Tt=M===!0?roundOffsetsByDPR({x:ce,y:ye},getWindow(l)):{x:ce,y:ye};return ce=Tt.x,ye=Tt.y,w?Object.assign({},xt,((pt={})[ht]=Ve?"0":"",pt[tt]=ke?"0":"",pt.transform=(ut.devicePixelRatio||1)<=1?"translate("+ce+"px, "+ye+"px)":"translate3d("+ce+"px, "+ye+"px, 0)",pt)):Object.assign({},xt,((o={})[ht]=Ve?ye+"px":"",o[tt]=ke?ce+"px":"",o.transform="",o))}function computeStyles(d){var o=d.state,l=d.options,c=l.gpuAcceleration,u=c===void 0||c,h=l.adaptive,_=h===void 0||h,A=l.roundOffsets,w=A===void 0||A,C={placement:getBasePlacement(o.placement),variation:getVariation(o.placement),popper:o.elements.popper,popperRect:o.rects.popper,gpuAcceleration:u,isFixed:o.options.strategy==="fixed"};o.modifiersData.popperOffsets!=null&&(o.styles.popper=Object.assign({},o.styles.popper,mapToStyles(Object.assign({},C,{offsets:o.modifiersData.popperOffsets,position:o.options.strategy,adaptive:_,roundOffsets:w})))),o.modifiersData.arrow!=null&&(o.styles.arrow=Object.assign({},o.styles.arrow,mapToStyles(Object.assign({},C,{offsets:o.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:w})))),o.attributes.popper=Object.assign({},o.attributes.popper,{"data-popper-placement":o.placement})}var modifiers_computeStyles={name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:computeStyles,data:{}};function applyStyles(d){var o=d.state;Object.keys(o.elements).forEach(function(l){var c=o.styles[l]||{},u=o.attributes[l]||{},h=o.elements[l];isHTMLElement(h)&&getNodeName(h)&&(Object.assign(h.style,c),Object.keys(u).forEach(function(_){var A=u[_];A===!1?h.removeAttribute(_):h.setAttribute(_,A===!0?"":A)}))})}function applyStyles_effect(d){var o=d.state,l={popper:{position:o.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(o.elements.popper.style,l.popper),o.styles=l,o.elements.arrow&&Object.assign(o.elements.arrow.style,l.arrow),function(){Object.keys(o.elements).forEach(function(c){var u=o.elements[c],h=o.attributes[c]||{},_=Object.keys(o.styles.hasOwnProperty(c)?o.styles[c]:l[c]).reduce(function(A,w){return A[w]="",A},{});isHTMLElement(u)&&getNodeName(u)&&(Object.assign(u.style,_),Object.keys(h).forEach(function(A){u.removeAttribute(A)}))})}}var modifiers_applyStyles={name:"applyStyles",enabled:!0,phase:"write",fn:applyStyles,effect:applyStyles_effect,requires:["computeStyles"]};function distanceAndSkiddingToXY(d,o,l){var c=getBasePlacement(d),u=[left,enums_top].indexOf(c)>=0?-1:1,h=typeof l=="function"?l(Object.assign({},o,{placement:d})):l,_=h[0],A=h[1];return _=_||0,A=(A||0)*u,[left,right].indexOf(c)>=0?{x:A,y:_}:{x:_,y:A}}function offset(d){var o=d.state,l=d.options,c=d.name,u=l.offset,h=u===void 0?[0,0]:u,_=enums_placements.reduce(function(M,O){return M[O]=distanceAndSkiddingToXY(O,o.rects,h),M},{}),A=_[o.placement],w=A.x,C=A.y;o.modifiersData.popperOffsets!=null&&(o.modifiersData.popperOffsets.x+=w,o.modifiersData.popperOffsets.y+=C),o.modifiersData[c]=_}var modifiers_offset={name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:offset},getOppositePlacement_hash={left:"right",right:"left",bottom:"top",top:"bottom"};function getOppositePlacement(d){return d.replace(/left|right|bottom|top/g,function(o){return getOppositePlacement_hash[o]})}var getOppositeVariationPlacement_hash={start:"end",end:"start"};function getOppositeVariationPlacement(d){return d.replace(/start|end/g,function(o){return getOppositeVariationPlacement_hash[o]})}function getViewportRect(d,o){var l=getWindow(d),c=getDocumentElement(d),u=l.visualViewport,h=c.clientWidth,_=c.clientHeight,A=0,w=0;if(u){h=u.width,_=u.height;var C=isLayoutViewport();(C||!C&&o==="fixed")&&(A=u.offsetLeft,w=u.offsetTop)}return{width:h,height:_,x:A+getWindowScrollBarX(d),y:w}}function getDocumentRect(d){var o,l=getDocumentElement(d),c=getWindowScroll(d),u=(o=d.ownerDocument)==null?void 0:o.body,h=math_max(l.scrollWidth,l.clientWidth,u?u.scrollWidth:0,u?u.clientWidth:0),_=math_max(l.scrollHeight,l.clientHeight,u?u.scrollHeight:0,u?u.clientHeight:0),A=-c.scrollLeft+getWindowScrollBarX(d),w=-c.scrollTop;return getComputedStyle(u||l).direction==="rtl"&&(A+=math_max(l.clientWidth,u?u.clientWidth:0)-h),{width:h,height:_,x:A,y:w}}function contains(d,o){var l=o.getRootNode&&o.getRootNode();if(d.contains(o))return!0;if(l&&isShadowRoot(l)){var c=o;do{if(c&&d.isSameNode(c))return!0;c=c.parentNode||c.host}while(c)}return!1}function rectToClientRect(d){return Object.assign({},d,{left:d.x,top:d.y,right:d.x+d.width,bottom:d.y+d.height})}function getInnerBoundingClientRect(d,o){var l=getBoundingClientRect(d,!1,o==="fixed");return l.top=l.top+d.clientTop,l.left=l.left+d.clientLeft,l.bottom=l.top+d.clientHeight,l.right=l.left+d.clientWidth,l.width=d.clientWidth,l.height=d.clientHeight,l.x=l.left,l.y=l.top,l}function getClientRectFromMixedType(d,o,l){return o===viewport?rectToClientRect(getViewportRect(d,l)):isElement(o)?getInnerBoundingClientRect(o,l):rectToClientRect(getDocumentRect(getDocumentElement(d)))}function getClippingParents(d){var o=listScrollParents(getParentNode(d)),l=["absolute","fixed"].indexOf(getComputedStyle(d).position)>=0&&isHTMLElement(d)?getOffsetParent(d):d;return isElement(l)?o.filter(function(c){return isElement(c)&&contains(c,l)&&getNodeName(c)!=="body"}):[]}function getClippingRect(d,o,l,c){var u=o==="clippingParents"?getClippingParents(d):[].concat(o),h=[].concat(u,[l]),_=h[0],A=h.reduce(function(w,C){var M=getClientRectFromMixedType(d,C,c);return w.top=math_max(M.top,w.top),w.right=math_min(M.right,w.right),w.bottom=math_min(M.bottom,w.bottom),w.left=math_max(M.left,w.left),w},getClientRectFromMixedType(d,_,c));return A.width=A.right-A.left,A.height=A.bottom-A.top,A.x=A.left,A.y=A.top,A}function getFreshSideObject(){return{top:0,right:0,bottom:0,left:0}}function mergePaddingObject(d){return Object.assign({},getFreshSideObject(),d)}function expandToHashMap(d,o){return o.reduce(function(l,c){return l[c]=d,l},{})}function detectOverflow(d,o){o===void 0&&(o={});var l=o,c=l.placement,u=c===void 0?d.placement:c,h=l.strategy,_=h===void 0?d.strategy:h,A=l.boundary,w=A===void 0?clippingParents:A,C=l.rootBoundary,M=C===void 0?viewport:C,O=l.elementContext,ne=O===void 0?popper:O,ce=l.altBoundary,ue=ce!==void 0&&ce,ye=l.padding,Oe=ye===void 0?0:ye,ke=mergePaddingObject(typeof Oe!="number"?Oe:expandToHashMap(Oe,basePlacements)),Ve=ne===popper?reference:popper,tt=d.rects.popper,ht=d.elements[ue?Ve:ne],ut=getClippingRect(isElement(ht)?ht:ht.contextElement||getDocumentElement(d.elements.popper),w,M,_),_t=getBoundingClientRect(d.elements.reference),at=computeOffsets({reference:_t,element:tt,strategy:"absolute",placement:u}),lt=rectToClientRect(Object.assign({},tt,at)),pt=ne===popper?lt:_t,xt={top:ut.top-pt.top+ke.top,bottom:pt.bottom-ut.bottom+ke.bottom,left:ut.left-pt.left+ke.left,right:pt.right-ut.right+ke.right},Tt=d.modifiersData.offset;if(ne===popper&&Tt){var Pt=Tt[u];Object.keys(xt).forEach(function(Lt){var Bt=[right,bottom].indexOf(Lt)>=0?1:-1,Ut=[enums_top,bottom].indexOf(Lt)>=0?"y":"x";xt[Lt]+=Pt[Ut]*Bt})}return xt}function computeAutoPlacement(d,o){o===void 0&&(o={});var l=o,c=l.placement,u=l.boundary,h=l.rootBoundary,_=l.padding,A=l.flipVariations,w=l.allowedAutoPlacements,C=w===void 0?enums_placements:w,M=getVariation(c),O=M?A?variationPlacements:variationPlacements.filter(function(ue){return getVariation(ue)===M}):basePlacements,ne=O.filter(function(ue){return C.indexOf(ue)>=0});ne.length===0&&(ne=O);var ce=ne.reduce(function(ue,ye){return ue[ye]=detectOverflow(d,{placement:ye,boundary:u,rootBoundary:h,padding:_})[getBasePlacement(ye)],ue},{});return Object.keys(ce).sort(function(ue,ye){return ce[ue]-ce[ye]})}function getExpandedFallbackPlacements(d){if(getBasePlacement(d)===auto)return[];var o=getOppositePlacement(d);return[getOppositeVariationPlacement(d),o,getOppositeVariationPlacement(o)]}function flip(d){var o=d.state,l=d.options,c=d.name;if(!o.modifiersData[c]._skip){for(var u=l.mainAxis,h=u===void 0||u,_=l.altAxis,A=_===void 0||_,w=l.fallbackPlacements,C=l.padding,M=l.boundary,O=l.rootBoundary,ne=l.altBoundary,ce=l.flipVariations,ue=ce===void 0||ce,ye=l.allowedAutoPlacements,Oe=o.options.placement,ke=getBasePlacement(Oe),Ve=w||(ke!==Oe&&ue?getExpandedFallbackPlacements(Oe):[getOppositePlacement(Oe)]),tt=[Oe].concat(Ve).reduce(function(Zt,ti){return Zt.concat(getBasePlacement(ti)===auto?computeAutoPlacement(o,{placement:ti,boundary:M,rootBoundary:O,padding:C,flipVariations:ue,allowedAutoPlacements:ye}):ti)},[]),ht=o.rects.reference,ut=o.rects.popper,_t=new Map,at=!0,lt=tt[0],pt=0;pt<tt.length;pt++){var xt=tt[pt],Tt=getBasePlacement(xt),Pt=getVariation(xt)===start,Lt=[enums_top,bottom].indexOf(Tt)>=0,Bt=Lt?"width":"height",Ut=detectOverflow(o,{placement:xt,boundary:M,rootBoundary:O,altBoundary:ne,padding:C}),kt=Lt?Pt?right:left:Pt?bottom:enums_top;ht[Bt]>ut[Bt]&&(kt=getOppositePlacement(kt));var Vt=getOppositePlacement(kt),si=[];if(h&&si.push(Ut[Tt]<=0),A&&si.push(Ut[kt]<=0,Ut[Vt]<=0),si.every(function(Zt){return Zt})){lt=xt,at=!1;break}_t.set(xt,si)}if(at)for(var Jt=function(Zt){var ti=tt.find(function(ci){var ri=_t.get(ci);if(ri)return ri.slice(0,Zt).every(function(Ct){return Ct})});if(ti)return lt=ti,"break"},Wt=ue?3:1;Wt>0&&Jt(Wt)!=="break";Wt--);o.placement!==lt&&(o.modifiersData[c]._skip=!0,o.placement=lt,o.reset=!0)}}var modifiers_flip={name:"flip",enabled:!0,phase:"main",fn:flip,requiresIfExists:["offset"],data:{_skip:!1}};function getAltAxis(d){return d==="x"?"y":"x"}function within(d,o,l){return math_max(d,math_min(o,l))}function withinMaxClamp(d,o,l){var c=within(d,o,l);return c>l?l:c}function preventOverflow(d){var o=d.state,l=d.options,c=d.name,u=l.mainAxis,h=u===void 0||u,_=l.altAxis,A=_!==void 0&&_,w=l.boundary,C=l.rootBoundary,M=l.altBoundary,O=l.padding,ne=l.tether,ce=ne===void 0||ne,ue=l.tetherOffset,ye=ue===void 0?0:ue,Oe=detectOverflow(o,{boundary:w,rootBoundary:C,padding:O,altBoundary:M}),ke=getBasePlacement(o.placement),Ve=getVariation(o.placement),tt=!Ve,ht=getMainAxisFromPlacement(ke),ut=getAltAxis(ht),_t=o.modifiersData.popperOffsets,at=o.rects.reference,lt=o.rects.popper,pt=typeof ye=="function"?ye(Object.assign({},o.rects,{placement:o.placement})):ye,xt=typeof pt=="number"?{mainAxis:pt,altAxis:pt}:Object.assign({mainAxis:0,altAxis:0},pt),Tt=o.modifiersData.offset?o.modifiersData.offset[o.placement]:null,Pt={x:0,y:0};if(_t){if(h){var Lt,Bt=ht==="y"?enums_top:left,Ut=ht==="y"?bottom:right,kt=ht==="y"?"height":"width",Vt=_t[ht],si=Vt+Oe[Bt],Jt=Vt-Oe[Ut],Wt=ce?-lt[kt]/2:0,Zt=Ve===start?at[kt]:lt[kt],ti=Ve===start?-lt[kt]:-at[kt],ci=o.elements.arrow,ri=ce&&ci?getLayoutRect(ci):{width:0,height:0},Ct=o.modifiersData["arrow#persistent"]?o.modifiersData["arrow#persistent"].padding:getFreshSideObject(),Ht=Ct[Bt],qt=Ct[Ut],Li=within(0,at[kt],ri[kt]),Ui=tt?at[kt]/2-Wt-Li-Ht-xt.mainAxis:Zt-Li-Ht-xt.mainAxis,Xi=tt?-at[kt]/2+Wt+Li+qt+xt.mainAxis:ti+Li+qt+xt.mainAxis,An=o.elements.arrow&&getOffsetParent(o.elements.arrow),Ln=An?ht==="y"?An.clientTop||0:An.clientLeft||0:0,Nn=(Lt=Tt==null?void 0:Tt[ht])!=null?Lt:0,Kn=Vt+Xi-Nn,_i=within(ce?math_min(si,Vt+Ui-Nn-Ln):si,Vt,ce?math_max(Jt,Kn):Jt);_t[ht]=_i,Pt[ht]=_i-Vt}if(A){var Gi,sn=ht==="x"?enums_top:left,jt=ht==="x"?bottom:right,Gt=_t[ut],li=ut==="y"?"height":"width",vi=Gt+Oe[sn],xi=Gt-Oe[jt],mi=[enums_top,left].indexOf(ke)!==-1,Ri=(Gi=Tt==null?void 0:Tt[ut])!=null?Gi:0,Zi=mi?vi:Gt-at[li]-lt[li]-Ri+xt.altAxis,dn=mi?Gt+at[li]+lt[li]-Ri-xt.altAxis:xi,hn=ce&&mi?withinMaxClamp(Zi,Gt,dn):within(ce?Zi:vi,Gt,ce?dn:xi);_t[ut]=hn,Pt[ut]=hn-Gt}o.modifiersData[c]=Pt}}var modifiers_preventOverflow={name:"preventOverflow",enabled:!0,phase:"main",fn:preventOverflow,requiresIfExists:["offset"]},toPaddingObject=function(d,o){return mergePaddingObject(typeof(d=typeof d=="function"?d(Object.assign({},o.rects,{placement:o.placement})):d)!="number"?d:expandToHashMap(d,basePlacements))};function arrow(d){var o,l=d.state,c=d.name,u=d.options,h=l.elements.arrow,_=l.modifiersData.popperOffsets,A=getBasePlacement(l.placement),w=getMainAxisFromPlacement(A),C=[left,right].indexOf(A)>=0?"height":"width";if(h&&_){var M=toPaddingObject(u.padding,l),O=getLayoutRect(h),ne=w==="y"?enums_top:left,ce=w==="y"?bottom:right,ue=l.rects.reference[C]+l.rects.reference[w]-_[w]-l.rects.popper[C],ye=_[w]-l.rects.reference[w],Oe=getOffsetParent(h),ke=Oe?w==="y"?Oe.clientHeight||0:Oe.clientWidth||0:0,Ve=ue/2-ye/2,tt=M[ne],ht=ke-O[C]-M[ce],ut=ke/2-O[C]/2+Ve,_t=within(tt,ut,ht),at=w;l.modifiersData[c]=((o={})[at]=_t,o.centerOffset=_t-ut,o)}}function arrow_effect(d){var o=d.state,l=d.options.element,c=l===void 0?"[data-popper-arrow]":l;c!=null&&(typeof c!="string"||(c=o.elements.popper.querySelector(c)))&&contains(o.elements.popper,c)&&(o.elements.arrow=c)}var modifiers_arrow={name:"arrow",enabled:!0,phase:"main",fn:arrow,effect:arrow_effect,requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function getSideOffsets(d,o,l){return l===void 0&&(l={x:0,y:0}),{top:d.top-o.height-l.y,right:d.right-o.width+l.x,bottom:d.bottom-o.height+l.y,left:d.left-o.width-l.x}}function isAnySideFullyClipped(d){return[enums_top,right,bottom,left].some(function(o){return d[o]>=0})}function hide(d){var o=d.state,l=d.name,c=o.rects.reference,u=o.rects.popper,h=o.modifiersData.preventOverflow,_=detectOverflow(o,{elementContext:"reference"}),A=detectOverflow(o,{altBoundary:!0}),w=getSideOffsets(_,c),C=getSideOffsets(A,u,h),M=isAnySideFullyClipped(w),O=isAnySideFullyClipped(C);o.modifiersData[l]={referenceClippingOffsets:w,popperEscapeOffsets:C,isReferenceHidden:M,hasPopperEscaped:O},o.attributes.popper=Object.assign({},o.attributes.popper,{"data-popper-reference-hidden":M,"data-popper-escaped":O})}var modifiers_hide={name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:hide},defaultModifiers=[eventListeners,modifiers_popperOffsets,modifiers_computeStyles,modifiers_applyStyles,modifiers_offset,modifiers_flip,modifiers_preventOverflow,modifiers_arrow,modifiers_hide],popper_createPopper=popperGenerator({defaultModifiers}),BOX_CLASS="tippy-box",CONTENT_CLASS="tippy-content",BACKDROP_CLASS="tippy-backdrop",ARROW_CLASS="tippy-arrow",SVG_ARROW_CLASS="tippy-svg-arrow",TOUCH_OPTIONS={passive:!0,capture:!0},TIPPY_DEFAULT_APPEND_TO=function(){return document.body};function getValueAtIndexOrReturn(d,o,l){if(Array.isArray(d)){var c=d[o];return c??(Array.isArray(l)?l[o]:l)}return d}function isType(d,o){var l={}.toString.call(d);return l.indexOf("[object")===0&&l.indexOf(o+"]")>-1}function invokeWithArgsOrReturn(d,o){return typeof d=="function"?d.apply(void 0,o):d}function tippy_esm_debounce(d,o){return o===0?d:function(c){clearTimeout(l),l=setTimeout(function(){d(c)},o)};var l}function removeProperties(d,o){var l=Object.assign({},d);return o.forEach(function(c){delete l[c]}),l}function splitBySpaces(d){return d.split(/\s+/).filter(Boolean)}function normalizeToArray(d){return[].concat(d)}function pushIfUnique(d,o){d.indexOf(o)===-1&&d.push(o)}function unique(d){return d.filter(function(o,l){return d.indexOf(o)===l})}function tippy_esm_getBasePlacement(d){return d.split("-")[0]}function arrayFrom(d){return[].slice.call(d)}function removeUndefinedProps(d){return Object.keys(d).reduce(function(o,l){return d[l]!==void 0&&(o[l]=d[l]),o},{})}function div(){return document.createElement("div")}function tippy_esm_isElement(d){return["Element","Fragment"].some(function(o){return isType(d,o)})}function isNodeList(d){return isType(d,"NodeList")}function isMouseEvent(d){return isType(d,"MouseEvent")}function isReferenceElement(d){return!(!d||!d._tippy||d._tippy.reference!==d)}function getArrayOfElements(d){return tippy_esm_isElement(d)?[d]:isNodeList(d)?arrayFrom(d):Array.isArray(d)?d:arrayFrom(document.querySelectorAll(d))}function setTransitionDuration(d,o){d.forEach(function(l){l&&(l.style.transitionDuration=o+"ms")})}function setVisibilityState(d,o){d.forEach(function(l){l&&l.setAttribute("data-state",o)})}function getOwnerDocument(d){var o,l=normalizeToArray(d)[0];return l!=null&&(o=l.ownerDocument)!=null&&o.body?l.ownerDocument:document}function isCursorOutsideInteractiveBorder(d,o){var l=o.clientX,c=o.clientY;return d.every(function(u){var h=u.popperRect,_=u.popperState,A=u.props.interactiveBorder,w=tippy_esm_getBasePlacement(_.placement),C=_.modifiersData.offset;if(!C)return!0;var M=w==="bottom"?C.top.y:0,O=w==="top"?C.bottom.y:0,ne=w==="right"?C.left.x:0,ce=w==="left"?C.right.x:0,ue=h.top-c+M>A,ye=c-h.bottom-O>A,Oe=h.left-l+ne>A,ke=l-h.right-ce>A;return ue||ye||Oe||ke})}function updateTransitionEndListener(d,o,l){var c=o+"EventListener";["transitionend","webkitTransitionEnd"].forEach(function(u){d[c](u,l)})}function actualContains(d,o){for(var l=o;l;){var c;if(d.contains(l))return!0;l=l.getRootNode==null||(c=l.getRootNode())==null?void 0:c.host}return!1}var currentInput={isTouch:!1},lastMouseMoveTime=0;function onDocumentTouchStart(){currentInput.isTouch||(currentInput.isTouch=!0,window.performance&&document.addEventListener("mousemove",onDocumentMouseMove))}function onDocumentMouseMove(){var d=performance.now();d-lastMouseMoveTime<20&&(currentInput.isTouch=!1,document.removeEventListener("mousemove",onDocumentMouseMove)),lastMouseMoveTime=d}function onWindowBlur(){var d=document.activeElement;if(isReferenceElement(d)){var o=d._tippy;d.blur&&!o.state.isVisible&&d.blur()}}function bindGlobalEventListeners(){document.addEventListener("touchstart",onDocumentTouchStart,TOUCH_OPTIONS),window.addEventListener("blur",onWindowBlur)}var isBrowser=typeof window<"u"&&typeof document<"u",isIE11=!!isBrowser&&!!window.msCrypto,pluginProps={animateFill:!1,followCursor:!1,inlinePositioning:!1,sticky:!1},renderProps={allowHTML:!1,animation:"fade",arrow:!0,content:"",inertia:!1,maxWidth:350,role:"tooltip",theme:"",zIndex:9999},defaultProps=Object.assign({appendTo:TIPPY_DEFAULT_APPEND_TO,aria:{content:"auto",expanded:"auto"},delay:0,duration:[300,250],getReferenceClientRect:null,hideOnClick:!0,ignoreAttributes:!1,interactive:!1,interactiveBorder:2,interactiveDebounce:0,moveTransition:"",offset:[0,10],onAfterUpdate:function(){},onBeforeUpdate:function(){},onCreate:function(){},onDestroy:function(){},onHidden:function(){},onHide:function(){},onMount:function(){},onShow:function(){},onShown:function(){},onTrigger:function(){},onUntrigger:function(){},onClickOutside:function(){},placement:"top",plugins:[],popperOptions:{},render:null,showOnCreate:!1,touch:!0,trigger:"mouseenter focus",triggerTarget:null},pluginProps,renderProps),defaultKeys=Object.keys(defaultProps),setDefaultProps=function(d){Object.keys(d).forEach(function(o){defaultProps[o]=d[o]})};function getExtendedPassedProps(d){var o=(d.plugins||[]).reduce(function(l,c){var u,h=c.name,_=c.defaultValue;return h&&(l[h]=d[h]!==void 0?d[h]:(u=defaultProps[h])!=null?u:_),l},{});return Object.assign({},d,o)}function getDataAttributeProps(d,o){return(o?Object.keys(getExtendedPassedProps(Object.assign({},defaultProps,{plugins:o}))):defaultKeys).reduce(function(l,c){var u=(d.getAttribute("data-tippy-"+c)||"").trim();if(!u)return l;if(c==="content")l[c]=u;else try{l[c]=JSON.parse(u)}catch{l[c]=u}return l},{})}function evaluateProps(d,o){var l=Object.assign({},o,{content:invokeWithArgsOrReturn(o.content,[d])},o.ignoreAttributes?{}:getDataAttributeProps(d,o.plugins));return l.aria=Object.assign({},defaultProps.aria,l.aria),l.aria={expanded:l.aria.expanded==="auto"?o.interactive:l.aria.expanded,content:l.aria.content==="auto"?o.interactive?null:"describedby":l.aria.content},l}var innerHTML=function(){return"innerHTML"};function dangerouslySetInnerHTML(d,o){d[innerHTML()]=o}function createArrowElement(d){var o=div();return d===!0?o.className=ARROW_CLASS:(o.className=SVG_ARROW_CLASS,tippy_esm_isElement(d)?o.appendChild(d):dangerouslySetInnerHTML(o,d)),o}function setContent(d,o){tippy_esm_isElement(o.content)?(dangerouslySetInnerHTML(d,""),d.appendChild(o.content)):typeof o.content!="function"&&(o.allowHTML?dangerouslySetInnerHTML(d,o.content):d.textContent=o.content)}function getChildren(d){var o=d.firstElementChild,l=arrayFrom(o.children);return{box:o,content:l.find(function(c){return c.classList.contains(CONTENT_CLASS)}),arrow:l.find(function(c){return c.classList.contains(ARROW_CLASS)||c.classList.contains(SVG_ARROW_CLASS)}),backdrop:l.find(function(c){return c.classList.contains(BACKDROP_CLASS)})}}function render(d){var o=div(),l=div();l.className=BOX_CLASS,l.setAttribute("data-state","hidden"),l.setAttribute("tabindex","-1");var c=div();function u(h,_){var A=getChildren(o),w=A.box,C=A.content,M=A.arrow;_.theme?w.setAttribute("data-theme",_.theme):w.removeAttribute("data-theme"),typeof _.animation=="string"?w.setAttribute("data-animation",_.animation):w.removeAttribute("data-animation"),_.inertia?w.setAttribute("data-inertia",""):w.removeAttribute("data-inertia"),w.style.maxWidth=typeof _.maxWidth=="number"?_.maxWidth+"px":_.maxWidth,_.role?w.setAttribute("role",_.role):w.removeAttribute("role"),h.content===_.content&&h.allowHTML===_.allowHTML||setContent(C,d.props),_.arrow?M?h.arrow!==_.arrow&&(w.removeChild(M),w.appendChild(createArrowElement(_.arrow))):w.appendChild(createArrowElement(_.arrow)):M&&w.removeChild(M)}return c.className=CONTENT_CLASS,c.setAttribute("data-state","hidden"),setContent(c,d.props),o.appendChild(l),l.appendChild(c),u(d.props,d.props),{popper:o,onUpdate:u}}render.$$tippy=!0;var idCounter=1,mouseMoveListeners=[],mountedInstances=[];function createTippy(d,o){var l,c,u,h,_,A,w,C=evaluateProps(d,Object.assign({},defaultProps,getExtendedPassedProps(removeUndefinedProps(o)))),M=!1,O=!1,ne=!1,ce=!1,ue=[],ye=tippy_esm_debounce(Xi,C.interactiveDebounce),Oe=idCounter++,ke=unique(C.plugins),Ve={id:Oe,reference:d,popper:div(),popperInstance:null,props:C,state:{isEnabled:!0,isVisible:!1,isDestroyed:!1,isMounted:!1,isShown:!1},plugins:ke,clearDelayTimeouts:function(){clearTimeout(l),clearTimeout(c),cancelAnimationFrame(u)},setProps:function(Gt){if(!Ve.state.isDestroyed){kt("onBeforeUpdate",[Ve,Gt]),Li();var li=Ve.props,vi=evaluateProps(d,Object.assign({},li,removeUndefinedProps(Gt),{ignoreAttributes:!0}));Ve.props=vi,qt(),li.interactiveDebounce!==vi.interactiveDebounce&&(Jt(),ye=tippy_esm_debounce(Xi,vi.interactiveDebounce)),li.triggerTarget&&!vi.triggerTarget?normalizeToArray(li.triggerTarget).forEach(function(xi){xi.removeAttribute("aria-expanded")}):vi.triggerTarget&&d.removeAttribute("aria-expanded"),si(),Ut(),ut&&ut(li,vi),Ve.popperInstance&&(Kn(),Gi().forEach(function(xi){requestAnimationFrame(xi._tippy.popperInstance.forceUpdate)})),kt("onAfterUpdate",[Ve,Gt])}},setContent:function(Gt){Ve.setProps({content:Gt})},show:function(){var Gt=Ve.state.isVisible,li=Ve.state.isDestroyed,vi=!Ve.state.isEnabled,xi=currentInput.isTouch&&!Ve.props.touch,mi=getValueAtIndexOrReturn(Ve.props.duration,0,defaultProps.duration);if(!(Gt||li||vi||xi||Tt().hasAttribute("disabled")||(kt("onShow",[Ve],!1),Ve.props.onShow(Ve)===!1))){if(Ve.state.isVisible=!0,xt()&&(ht.style.visibility="visible"),Ut(),ci(),Ve.state.isMounted||(ht.style.transition="none"),xt()){var Ri=Lt();setTransitionDuration([Ri.box,Ri.content],0)}var Zi,dn,hn;A=function(){var an;if(Ve.state.isVisible&&!ce){if(ce=!0,ht.offsetHeight,ht.style.transition=Ve.props.moveTransition,xt()&&Ve.props.animation){var pn=Lt(),Yi=pn.box,nn=pn.content;setTransitionDuration([Yi,nn],mi),setVisibilityState([Yi,nn],"visible")}Vt(),si(),pushIfUnique(mountedInstances,Ve),(an=Ve.popperInstance)==null||an.forceUpdate(),kt("onMount",[Ve]),Ve.props.animation&&xt()&&function(kn){Ct(kn,function(){Ve.state.isShown=!0,kt("onShown",[Ve])})}(mi)}},dn=Ve.props.appendTo,hn=Tt(),(Zi=Ve.props.interactive&&dn===TIPPY_DEFAULT_APPEND_TO||dn==="parent"?hn.parentNode:invokeWithArgsOrReturn(dn,[hn])).contains(ht)||Zi.appendChild(ht),Ve.state.isMounted=!0,Kn()}},hide:function(){var Gt=!Ve.state.isVisible,li=Ve.state.isDestroyed,vi=!Ve.state.isEnabled,xi=getValueAtIndexOrReturn(Ve.props.duration,1,defaultProps.duration);if(!(Gt||li||vi)&&(kt("onHide",[Ve],!1),Ve.props.onHide(Ve)!==!1)){if(Ve.state.isVisible=!1,Ve.state.isShown=!1,ce=!1,M=!1,xt()&&(ht.style.visibility="hidden"),Jt(),ri(),Ut(!0),xt()){var mi=Lt(),Ri=mi.box,Zi=mi.content;Ve.props.animation&&(setTransitionDuration([Ri,Zi],xi),setVisibilityState([Ri,Zi],"hidden"))}Vt(),si(),Ve.props.animation?xt()&&function(dn,hn){Ct(dn,function(){!Ve.state.isVisible&&ht.parentNode&&ht.parentNode.contains(ht)&&hn()})}(xi,Ve.unmount):Ve.unmount()}},hideWithInteractivity:function(Gt){Pt().addEventListener("mousemove",ye),pushIfUnique(mouseMoveListeners,ye),ye(Gt)},enable:function(){Ve.state.isEnabled=!0},disable:function(){Ve.hide(),Ve.state.isEnabled=!1},unmount:function(){Ve.state.isVisible&&Ve.hide(),Ve.state.isMounted&&(_i(),Gi().forEach(function(Gt){Gt._tippy.unmount()}),ht.parentNode&&ht.parentNode.removeChild(ht),mountedInstances=mountedInstances.filter(function(Gt){return Gt!==Ve}),Ve.state.isMounted=!1,kt("onHidden",[Ve]))},destroy:function(){Ve.state.isDestroyed||(Ve.clearDelayTimeouts(),Ve.unmount(),Li(),delete d._tippy,Ve.state.isDestroyed=!0,kt("onDestroy",[Ve]))}};if(!C.render)return Ve;var tt=C.render(Ve),ht=tt.popper,ut=tt.onUpdate;ht.setAttribute("data-tippy-root",""),ht.id="tippy-"+Ve.id,Ve.popper=ht,d._tippy=Ve,ht._tippy=Ve;var _t=ke.map(function(Gt){return Gt.fn(Ve)}),at=d.hasAttribute("aria-expanded");return qt(),si(),Ut(),kt("onCreate",[Ve]),C.showOnCreate&&sn(),ht.addEventListener("mouseenter",function(){Ve.props.interactive&&Ve.state.isVisible&&Ve.clearDelayTimeouts()}),ht.addEventListener("mouseleave",function(){Ve.props.interactive&&Ve.props.trigger.indexOf("mouseenter")>=0&&Pt().addEventListener("mousemove",ye)}),Ve;function lt(){var Gt=Ve.props.touch;return Array.isArray(Gt)?Gt:[Gt,0]}function pt(){return lt()[0]==="hold"}function xt(){var Gt;return!((Gt=Ve.props.render)==null||!Gt.$$tippy)}function Tt(){return w||d}function Pt(){var Gt=Tt().parentNode;return Gt?getOwnerDocument(Gt):document}function Lt(){return getChildren(ht)}function Bt(Gt){return Ve.state.isMounted&&!Ve.state.isVisible||currentInput.isTouch||h&&h.type==="focus"?0:getValueAtIndexOrReturn(Ve.props.delay,Gt?0:1,defaultProps.delay)}function Ut(Gt){Gt===void 0&&(Gt=!1),ht.style.pointerEvents=Ve.props.interactive&&!Gt?"":"none",ht.style.zIndex=""+Ve.props.zIndex}function kt(Gt,li,vi){var xi;vi===void 0&&(vi=!0),_t.forEach(function(mi){mi[Gt]&&mi[Gt].apply(mi,li)}),vi&&(xi=Ve.props)[Gt].apply(xi,li)}function Vt(){var Gt=Ve.props.aria;if(Gt.content){var li="aria-"+Gt.content,vi=ht.id;normalizeToArray(Ve.props.triggerTarget||d).forEach(function(xi){var mi=xi.getAttribute(li);if(Ve.state.isVisible)xi.setAttribute(li,mi?mi+" "+vi:vi);else{var Ri=mi&&mi.replace(vi,"").trim();Ri?xi.setAttribute(li,Ri):xi.removeAttribute(li)}})}}function si(){!at&&Ve.props.aria.expanded&&normalizeToArray(Ve.props.triggerTarget||d).forEach(function(Gt){Ve.props.interactive?Gt.setAttribute("aria-expanded",Ve.state.isVisible&&Gt===Tt()?"true":"false"):Gt.removeAttribute("aria-expanded")})}function Jt(){Pt().removeEventListener("mousemove",ye),mouseMoveListeners=mouseMoveListeners.filter(function(Gt){return Gt!==ye})}function Wt(Gt){if(!currentInput.isTouch||!ne&&Gt.type!=="mousedown"){var li=Gt.composedPath&&Gt.composedPath()[0]||Gt.target;if(!Ve.props.interactive||!actualContains(ht,li)){if(normalizeToArray(Ve.props.triggerTarget||d).some(function(vi){return actualContains(vi,li)})){if(currentInput.isTouch||Ve.state.isVisible&&Ve.props.trigger.indexOf("click")>=0)return}else kt("onClickOutside",[Ve,Gt]);Ve.props.hideOnClick===!0&&(Ve.clearDelayTimeouts(),Ve.hide(),O=!0,setTimeout(function(){O=!1}),Ve.state.isMounted||ri())}}}function Zt(){ne=!0}function ti(){ne=!1}function ci(){var Gt=Pt();Gt.addEventListener("mousedown",Wt,!0),Gt.addEventListener("touchend",Wt,TOUCH_OPTIONS),Gt.addEventListener("touchstart",ti,TOUCH_OPTIONS),Gt.addEventListener("touchmove",Zt,TOUCH_OPTIONS)}function ri(){var Gt=Pt();Gt.removeEventListener("mousedown",Wt,!0),Gt.removeEventListener("touchend",Wt,TOUCH_OPTIONS),Gt.removeEventListener("touchstart",ti,TOUCH_OPTIONS),Gt.removeEventListener("touchmove",Zt,TOUCH_OPTIONS)}function Ct(Gt,li){var vi=Lt().box;function xi(mi){mi.target===vi&&(updateTransitionEndListener(vi,"remove",xi),li())}if(Gt===0)return li();updateTransitionEndListener(vi,"remove",_),updateTransitionEndListener(vi,"add",xi),_=xi}function Ht(Gt,li,vi){vi===void 0&&(vi=!1),normalizeToArray(Ve.props.triggerTarget||d).forEach(function(xi){xi.addEventListener(Gt,li,vi),ue.push({node:xi,eventType:Gt,handler:li,options:vi})})}function qt(){pt()&&(Ht("touchstart",Ui,{passive:!0}),Ht("touchend",An,{passive:!0})),splitBySpaces(Ve.props.trigger).forEach(function(Gt){if(Gt!=="manual")switch(Ht(Gt,Ui),Gt){case"mouseenter":Ht("mouseleave",An);break;case"focus":Ht(isIE11?"focusout":"blur",Ln);break;case"focusin":Ht("focusout",Ln)}})}function Li(){ue.forEach(function(Gt){var li=Gt.node,vi=Gt.eventType,xi=Gt.handler,mi=Gt.options;li.removeEventListener(vi,xi,mi)}),ue=[]}function Ui(Gt){var li,vi=!1;if(Ve.state.isEnabled&&!Nn(Gt)&&!O){var xi=((li=h)==null?void 0:li.type)==="focus";h=Gt,w=Gt.currentTarget,si(),!Ve.state.isVisible&&isMouseEvent(Gt)&&mouseMoveListeners.forEach(function(mi){return mi(Gt)}),Gt.type==="click"&&(Ve.props.trigger.indexOf("mouseenter")<0||M)&&Ve.props.hideOnClick!==!1&&Ve.state.isVisible?vi=!0:sn(Gt),Gt.type==="click"&&(M=!vi),vi&&!xi&&jt(Gt)}}function Xi(Gt){var li=Gt.target,vi=Tt().contains(li)||ht.contains(li);if(Gt.type!=="mousemove"||!vi){var xi=Gi().concat(ht).map(function(mi){var Ri,Zi=(Ri=mi._tippy.popperInstance)==null?void 0:Ri.state;return Zi?{popperRect:mi.getBoundingClientRect(),popperState:Zi,props:C}:null}).filter(Boolean);isCursorOutsideInteractiveBorder(xi,Gt)&&(Jt(),jt(Gt))}}function An(Gt){Nn(Gt)||Ve.props.trigger.indexOf("click")>=0&&M||(Ve.props.interactive?Ve.hideWithInteractivity(Gt):jt(Gt))}function Ln(Gt){Ve.props.trigger.indexOf("focusin")<0&&Gt.target!==Tt()||Ve.props.interactive&&Gt.relatedTarget&&ht.contains(Gt.relatedTarget)||jt(Gt)}function Nn(Gt){return!!currentInput.isTouch&&pt()!==Gt.type.indexOf("touch")>=0}function Kn(){_i();var Gt=Ve.props,li=Gt.popperOptions,vi=Gt.placement,xi=Gt.offset,mi=Gt.getReferenceClientRect,Ri=Gt.moveTransition,Zi=xt()?getChildren(ht).arrow:null,dn=mi?{getBoundingClientRect:mi,contextElement:mi.contextElement||Tt()}:d,hn=[{name:"offset",options:{offset:xi}},{name:"preventOverflow",options:{padding:{top:2,bottom:2,left:5,right:5}}},{name:"flip",options:{padding:5}},{name:"computeStyles",options:{adaptive:!Ri}},{name:"$$tippy",enabled:!0,phase:"beforeWrite",requires:["computeStyles"],fn:function(an){var pn=an.state;if(xt()){var Yi=Lt().box;["placement","reference-hidden","escaped"].forEach(function(nn){nn==="placement"?Yi.setAttribute("data-placement",pn.placement):pn.attributes.popper["data-popper-"+nn]?Yi.setAttribute("data-"+nn,""):Yi.removeAttribute("data-"+nn)}),pn.attributes.popper={}}}}];xt()&&Zi&&hn.push({name:"arrow",options:{element:Zi,padding:3}}),hn.push.apply(hn,(li==null?void 0:li.modifiers)||[]),Ve.popperInstance=popper_createPopper(dn,ht,Object.assign({},li,{placement:vi,onFirstUpdate:A,modifiers:hn}))}function _i(){Ve.popperInstance&&(Ve.popperInstance.destroy(),Ve.popperInstance=null)}function Gi(){return arrayFrom(ht.querySelectorAll("[data-tippy-root]"))}function sn(Gt){Ve.clearDelayTimeouts(),Gt&&kt("onTrigger",[Ve,Gt]),ci();var li=Bt(!0),vi=lt(),xi=vi[0],mi=vi[1];currentInput.isTouch&&xi==="hold"&&mi&&(li=mi),li?l=setTimeout(function(){Ve.show()},li):Ve.show()}function jt(Gt){if(Ve.clearDelayTimeouts(),kt("onUntrigger",[Ve,Gt]),Ve.state.isVisible){if(!(Ve.props.trigger.indexOf("mouseenter")>=0&&Ve.props.trigger.indexOf("click")>=0&&["mouseleave","mousemove"].indexOf(Gt.type)>=0&&M)){var li=Bt(!1);li?c=setTimeout(function(){Ve.state.isVisible&&Ve.hide()},li):u=requestAnimationFrame(function(){Ve.hide()})}}else ri()}}function tippy(d,o){o===void 0&&(o={});var l=defaultProps.plugins.concat(o.plugins||[]);bindGlobalEventListeners();var c=Object.assign({},o,{plugins:l}),u=getArrayOfElements(d).reduce(function(h,_){var A=_&&createTippy(_,c);return A&&h.push(A),h},[]);return tippy_esm_isElement(d)?u[0]:u}tippy.defaultProps=defaultProps,tippy.setDefaultProps=setDefaultProps,tippy.currentInput=currentInput;var applyStylesModifier=Object.assign({},modifiers_applyStyles,{effect:function(d){var o=d.state,l={popper:{position:o.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};Object.assign(o.elements.popper.style,l.popper),o.styles=l,o.elements.arrow&&Object.assign(o.elements.arrow.style,l.arrow)}}),createSingleton=function(d,o){var l;o===void 0&&(o={});var c,u=d,h=[],_=[],A=o.overrides,w=[],C=!1;function M(){_=u.map(function(tt){return normalizeToArray(tt.props.triggerTarget||tt.reference)}).reduce(function(tt,ht){return tt.concat(ht)},[])}function O(){h=u.map(function(tt){return tt.reference})}function ne(tt){u.forEach(function(ht){tt?ht.enable():ht.disable()})}function ce(tt){return u.map(function(ht){var ut=ht.setProps;return ht.setProps=function(_t){ut(_t),ht.reference===c&&tt.setProps(_t)},function(){ht.setProps=ut}})}function ue(tt,ht){var ut=_.indexOf(ht);if(ht!==c){c=ht;var _t=(A||[]).concat("content").reduce(function(at,lt){return at[lt]=u[ut].props[lt],at},{});tt.setProps(Object.assign({},_t,{getReferenceClientRect:typeof _t.getReferenceClientRect=="function"?_t.getReferenceClientRect:function(){var at;return(at=h[ut])==null?void 0:at.getBoundingClientRect()}}))}}ne(!1),O(),M();var ye={fn:function(){return{onDestroy:function(){ne(!0)},onHidden:function(){c=null},onClickOutside:function(tt){tt.props.showOnCreate&&!C&&(C=!0,c=null)},onShow:function(tt){tt.props.showOnCreate&&!C&&(C=!0,ue(tt,h[0]))},onTrigger:function(tt,ht){ue(tt,ht.currentTarget)}}}},Oe=tippy(div(),Object.assign({},removeProperties(o,["overrides"]),{plugins:[ye].concat(o.plugins||[]),triggerTarget:_,popperOptions:Object.assign({},o.popperOptions,{modifiers:[].concat(((l=o.popperOptions)==null?void 0:l.modifiers)||[],[applyStylesModifier])})})),ke=Oe.show;Oe.show=function(tt){if(ke(),!c&&tt==null)return ue(Oe,h[0]);if(!c||tt!=null){if(typeof tt=="number")return h[tt]&&ue(Oe,h[tt]);if(u.indexOf(tt)>=0){var ht=tt.reference;return ue(Oe,ht)}return h.indexOf(tt)>=0?ue(Oe,tt):void 0}},Oe.showNext=function(){var tt=h[0];if(!c)return Oe.show(0);var ht=h.indexOf(c);Oe.show(h[ht+1]||tt)},Oe.showPrevious=function(){var tt=h[h.length-1];if(!c)return Oe.show(tt);var ht=h.indexOf(c),ut=h[ht-1]||tt;Oe.show(ut)};var Ve=Oe.setProps;return Oe.setProps=function(tt){A=tt.overrides||A,Ve(tt)},Oe.setInstances=function(tt){ne(!0),w.forEach(function(ht){return ht()}),u=tt,ne(!1),O(),M(),w=ce(Oe),Oe.setProps({triggerTarget:_})},w=ce(Oe),Oe};tippy.setDefaultProps({render});var tippy_esm=tippy;class CustomContextMenu{static _initialize(){this._inited=!0,P($`
          #customContextMenu {
            background: #2c2c2e99;
            backdrop-filter: blur(8px);
            border: 0.5px solid rgba(20, 20, 20, 0.3);
            width: auto;
            height: auto;
            position: absolute;
            display: flex;
            flex-direction: column;
            z-index: 9999;
            padding: 0.35rem 0.20rem;
            border-radius: 0.375rem;
            min-width: 6rem;
            pointer-events: auto;
            box-shadow: 0px 2px 10px rgba(12, 12, 12, 0.2);
          }

          .customContextMenuItems {
            color: white;
            font-size: 0.65rem;
            font-family: "Roboto Mono", "Source Code Pro", Menlo, Courier, monospace;
            background-color: transparent;
            cursor: pointer;
            padding: 0.12rem 0.35rem;
            border-radius: 0.25rem;
            line-height: 1rem;
            font-weight: 500;
          }

          .customContextMenuItems:hover {
            color: white;
            background-color: #017AFF;
          }
        `),document.addEventListener("mouseup",o=>{this.Element&&!this.Element.contains(o.target)&&o.button===0&&this.Remove()})}static Create(o,l,c){this._inited||this._initialize(),this.Element&&this.Remove();const u=ee({id:"customContextMenu",addToBody:!1});u.style.top=c+"px",u.style.left=l+"px";for(const[h,_]of Object.entries(o)){const A=ee({classList:["customContextMenuItems"],addToBody:!1,innerHTML:h});u.appendChild(A),A.onclick=_}return this.Element=u,u}static Remove(){var o;(o=this.Element)===null||o===void 0||o.remove(),this.Element=void 0}}CustomContextMenu.Element=void 0,CustomContextMenu._inited=!1;class MaterialConfiguratorPlugin extends MaterialConfiguratorBasePlugin{constructor(){super(...arguments),this.enableEditContextMenus=!1}async _refreshUi(){var o;if(!await super._refreshUi())return!1;CustomContextGrid.RemoveAll(MaterialConfiguratorPlugin.PluginType);for(const l of this.variations)CustomContextGrid.Create(MaterialConfiguratorPlugin.PluginType,l.title+(this.enableEditContextMenus?" ("+l.uuid+")":""),5,20,0,l.materials.map(c=>{let u;if(l.preview.startsWith("generate:"))u=this._previewGenerator.generate(c,l.preview.split(":")[1]);else{const h=c[l.preview]||"#ff00ff";u=h.image?Ne(h.image,100):void 0,u||(u=Ge(h!=null&&h.isColor?h.getHexString():h))}return{id:c.uuid,image:u,onClick:h=>this.applyVariation(l,h),tooltip:c.name||c.uuid}}),(c,u,h)=>{tippy_esm(c,{placement:"bottom",content:u.tooltip}),c.oncontextmenu=_=>{if(!this.enableEditContextMenus)return;_.preventDefault(),_.stopPropagation();const A=CustomContextMenu.Create({Remove:async()=>{var w;await((w=this._viewer)===null||w===void 0?void 0:w.confirm("Remove material: Remove material from this variation list?"))&&(l.materials=l.materials.filter(C=>C.uuid!==u.id),this.refreshUi(),CustomContextMenu.Remove())},"Remove All":async()=>{var w;await((w=this._viewer)===null||w===void 0?void 0:w.confirm("Remove all: Remove all materials from this variation list?"))&&(l.materials=[],this.refreshUi(),CustomContextMenu.Remove())}},_.clientX,_.clientY);document.body.appendChild(A)},h.oncontextmenu=_=>{if(!this.enableEditContextMenus)return;_.preventDefault(),_.stopPropagation();const A=CustomContextMenu.Create({"Rename mapping":async()=>{var w;const C=await((w=this._viewer)===null||w===void 0?void 0:w.prompt("Change name: New material name to map to",l.uuid,!0));C&&(l.uuid=C,this.refreshUi())},"Rename title":async()=>{var w;const C=await((w=this._viewer)===null||w===void 0?void 0:w.prompt("Change name: New material name to map to",l.title,!0));C&&(l.title=C,this.refreshUi())},"Remove Section":async()=>{var w;await((w=this._viewer)===null||w===void 0?void 0:w.confirm("Remove variations: Remove this category of variations?"))&&(this.removeVariation(l),CustomContextMenu.Remove())}},_.clientX,_.clientY);document.body.appendChild(A)}});return CustomContextGrid.RebuildUi((o=this._viewer)===null||o===void 0?void 0:o.container),!0}}MaterialConfiguratorPlugin.PluginType="MaterialConfiguratorPlugin";var SwitchNodeBasePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class SwitchNodeBasePlugin extends AViewerPlugin{constructor(){super(),this.enabled=!0,this._uiNeedRefresh=!1,this._isVisibleChanged=!1,this._postFrame=()=>{this._uiNeedRefresh&&this._refreshUi()},this._preRender=()=>{if(this._viewer&&this.enabled){for(const o of this.variations){if(!o.name)continue;const l=this._viewer.scene.getObjectByName(o.name);if(!l||l.children.length<1)return;o.selected||(o.selected=l.children[0].name||l.children[0].uuid);for(const c of l.children)c.userData.__oldVisible=c.visible,c.visible=(c.name||c.uuid)===o.selected}this._isVisibleChanged=!0}},this._postRender=()=>{if(this._viewer&&this._isVisibleChanged){for(const o of this.variations){if(!o.name)continue;const l=this._viewer.scene.getObjectByName(o.name);if(!l||l.children.length<1)return;for(const c of l.children){if(c.userData.__oldVisible===void 0)return;c.visible=c.userData.__oldVisible,delete c.userData.__oldVisible}}this._isVisibleChanged=!1}},this.autoSnapIcons=!1,this.dependencies=[AssetManagerPlugin],this.variations=[],this._selectedSwitchNode=()=>{var o;const l=(o=this._picking)===null||o===void 0?void 0:o.getSelectedObject();if(!l)return;const c=this.variations.map(h=>h.name);let u;return l.traverseAncestors(h=>{u||h.name&&c.includes(h.name)&&(u=h)}),u},this.uiConfig={label:"Switch Node",type:"folder",children:[{type:"checkbox",label:"Enabled",property:[this,"enabled"]},()=>[{type:"folder",label:"All nodes",expanded:!0,children:[this.variations.map(o=>({type:"input",label:o.title,property:[o,"name"],onChange:()=>this.refreshUi()}))]},{type:"button",label:"Add Node",value:()=>{this.variations.push({name:"switch_node",selected:"",title:"Switch Node",camView:"front",camDistance:1}),this.refreshUi()}},{type:"button",label:"Refresh UI",value:()=>this.refreshUi()},{type:"input",label:"Selected node title",hidden:()=>!this._selectedSwitchNode(),property:()=>{const o=this._selectedSwitchNode();return o?[this.variations.find(l=>l.name===o.name),"title"]:[]},onChange:()=>this.refreshUi()},{type:"slider",bounds:[.01,2],stepSize:.01,label:"Cam Distance",hidden:()=>!this._selectedSwitchNode(),property:()=>{const o=this._selectedSwitchNode();return o?[this.variations.find(l=>l.name===o.name),"camDistance"]:[]}},{type:"dropdown",label:"Cam View",hidden:()=>!this._selectedSwitchNode(),property:()=>{const o=this._selectedSwitchNode();return o?[this.variations.find(l=>l.name===o.name),"camView"]:[]},onChange:()=>this.refreshUi(),children:["top","bottom","front","back","left","right"].map(o=>({label:o,value:o}))}]]},this.refreshUi=this.refreshUi.bind(this),this._refreshUi=this._refreshUi.bind(this)}async onAdded(o){var l,c;await super.onAdded(o),this._picking=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("Picking"),(c=this._picking)===null||c===void 0||c.addEventListener("selectedObjectChanged",this._refreshUi),o.addEventListener("postFrame",this._postFrame),o.addEventListener("preRender",this._preRender),o.addEventListener("postRender",this._postRender),this.addEventListener("deserialize",this.refreshUi)}async onRemove(o){var l;return(l=this._picking)===null||l===void 0||l.removeEventListener("selectedObjectChanged",this._refreshUi),o.removeEventListener("postFrame",this._postFrame),o.removeEventListener("preRender",this._preRender),o.removeEventListener("postRender",this._postRender),this._picking=void 0,super.onRemove(o)}refreshUi(){this.enabled&&(this._uiNeedRefresh=!0)}_refreshUi(){var o,l;return!!this.enabled&&!!this._viewer&&(this._uiNeedRefresh=!1,(l=(o=this.uiConfig).uiRefresh)===null||l===void 0||l.call(o),this.autoSnapIcons&&this.snapIcons(),!0)}snapIcons(){for(const o of this.variations){const l=this._viewer.scene.getObjectByName(o.name);if(l){l.children.length<1&&console.warn("SwitchNode does not have enough children",o);for(const c of l.children){if(c.userData.__icon)return;const u=o.camView,h=new three_module.Pq0((u.includes("right")?1:0)-(u.includes("left")?1:0),(u.includes("top")?1:0)-(u.includes("bottom")?1:0),(u.includes("front")?1:0)-(u.includes("back")?1:0));o.camDistance||(o.camDistance=1);const _=snapObject(this._viewer,c,void 0,7,h.multiplyScalar(.5*o.camDistance));c.userData.__icon=_}}else console.warn("no object found for variation, skipping",o)}}}SwitchNodeBasePlugin_decorate([serialize()],SwitchNodeBasePlugin.prototype,"variations",void 0);class SwitchNodePlugin extends SwitchNodeBasePlugin{_refreshUi(){var o;if(!super._refreshUi())return!1;CustomContextGrid.RemoveAll(SwitchNodePlugin.PluginType);for(const l of this.variations){const c=this._viewer.scene.getObjectByName(l.name);c?(c.children.length<1&&console.warn("SwitchNode does not have enough children",l),CustomContextGrid.Create(SwitchNodePlugin.PluginType,l.title,Math.min(5,c.children.length),20,0,c.children.map(u=>{const h=l.camView,_=new three_module.Pq0((h.includes("right")?1:0)-(h.includes("left")?1:0),(h.includes("top")?1:0)-(h.includes("bottom")?1:0),(h.includes("front")?1:0)-(h.includes("back")?1:0));l.camDistance||(l.camDistance=1);const A=snapObject(this._viewer,u,void 0,7,_.multiplyScalar(.5*l.camDistance));return{id:u.uuid,image:A,onClick:()=>{var w;l.selected=u.name||u.uuid,(w=this._viewer)===null||w===void 0||w.scene.setDirty({sceneUpdate:!0,frameFade:!0})},tooltip:u.name||u.uuid}}),(u,h)=>tippy_esm(u,{placement:"bottom",content:h.tooltip}))):console.warn("no object found for variation, skipping",l)}return CustomContextGrid.RebuildUi((o=this._viewer)===null||o===void 0?void 0:o.container),!0}}SwitchNodePlugin.PluginType="SwitchNodePlugin";var MaterialLibraryBasePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class MaterialLibraryBasePlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this._uiNeedRefresh=!1,this._refreshUiConfig=()=>{var o,l;this.enabled&&((l=(o=this.uiConfig)===null||o===void 0?void 0:o.uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0))},this.dependencies=[AssetManagerPlugin],this._selectedObject=()=>{var o;return((o=this._picking)===null||o===void 0?void 0:o.getSelectedObject())||void 0},this._selectedMaterial=()=>{var o;return((o=this._selectedObject())===null||o===void 0?void 0:o.material)||void 0}}async onAdded(o){var l,c;await super.onAdded(o),this.refreshUi=this.refreshUi.bind(this),this._refreshUi=this._refreshUi.bind(this),this._picking=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("Picking"),this._previewGenerator=new MaterialPreviewGenerator(this._viewer),(c=this._picking)===null||c===void 0||c.addEventListener("selectedObjectChanged",this._refreshUiConfig),o.addEventListener("preFrame",this._refreshUi),this.addEventListener("deserialize",this.refreshUi)}async onRemove(o){var l,c;return(l=this._previewGenerator)===null||l===void 0||l.dispose(),this._previewGenerator=void 0,(c=this._picking)===null||c===void 0||c.removeEventListener("selectedObjectChanged",this._refreshUiConfig),this.removeEventListener("deserialize",this.refreshUi),o.removeEventListener("preFrame",this._refreshUi),this._picking=void 0,super.onRemove(o)}refreshUi(){this.enabled&&(this._uiNeedRefresh=!0)}async _refreshUi(){return this._uiNeedRefresh&&this.enabled&&this._refreshUiConfig(),this._uiNeedRefresh=!1,!1}}MaterialLibraryBasePlugin.PluginType="MaterialLibraryBasePlugin",MaterialLibraryBasePlugin_decorate([uiToggle("Enabled")],MaterialLibraryBasePlugin.prototype,"enabled",void 0);var MaterialLibraryPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class MaterialLibraryPlugin extends MaterialLibraryBasePlugin{constructor(){super(...arguments),this.replaceMaterial=!1,this.uiConfig={type:"folder",label:"Material Library",uuid:esm_browser_v4(),children:[...generateUiConfig(this),()=>({type:"dropdown",label:"Apply Material",limitedUi:!0,hidden:()=>!this._selectedObject(),children:[{label:"select one",value:""},[...this._viewer.getPlugin(AssetManagerPlugin).materials.getAllMaterials().map(o=>({label:o.name||o.uuid,value:o.uuid}))||[]]],getValue:()=>{var o;return(o=this._selectedMaterial())===null||o===void 0?void 0:o.uuid},setValue:o=>{var l,c,u,h,_;const A=(u=(c=(l=this._viewer)===null||l===void 0?void 0:l.getPlugin(AssetManagerPlugin))===null||c===void 0?void 0:c.materials)===null||u===void 0?void 0:u.findMaterial(o);if(A)if(this.replaceMaterial)(_=(h=this._selectedObject())===null||h===void 0?void 0:h.setMaterial)===null||_===void 0||_.call(h,A);else{const w=this._selectedMaterial();if(w){const C=w.name,M=w.uuid;w.copyProps(A),w.name=C,w.uuid=M,w.userData.uuid&&(w.userData.uuid=M)}}this._refreshUi()}})]}}async _refreshUi(){var o,l,c;if(!await super._refreshUi())return!1;const u=[MeshStandardMaterial2.TypeSlug,DiamondMaterial.TypeSlug],h=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(AssetManagerPlugin))===null||l===void 0?void 0:l.materials,_=u.map(A=>[A,h==null?void 0:h.getMaterialsOfType(A)]);CustomContextGrid.RemoveAll(MaterialLibraryPlugin.PluginType);for(const[A,w]of _)CustomContextGrid.Create(MaterialLibraryPlugin.PluginType,A,5,20,0,w==null?void 0:w.filter(C=>!C.userData.runtimeMaterial).map(C=>{let M;const O="generate:sphere";if(O.startsWith("generate:"))M=this._previewGenerator.generate(C,O.split(":")[1]);else{const ne=C[O]||"#ff00ff";M=ne.image?Ne(ne.image,100):void 0,M||(M=Je(ne))}return{id:C.uuid,image:M,onClick:ne=>{const ce=h==null?void 0:h.findMaterial(ne);if(ce){const ue=ce.userData.__appliedMeshes;if(ue!=null&&ue.size){const ye=ue.keys().next().value;ye==null||ye.dispatchEvent({type:"select",value:ye})}}},tooltip:C.name||C.uuid}}),(C,M)=>tippy_esm(C,{placement:"bottom",content:M.tooltip}));return CustomContextGrid.RebuildUi((c=this._viewer)===null||c===void 0?void 0:c.container),!0}}MaterialLibraryPlugin.PluginType="MaterialLibraryPlugin",MaterialLibraryPlugin_decorate([uiToggle("Replace Material")],MaterialLibraryPlugin.prototype,"replaceMaterial",void 0);var FSShadowMaterial_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class FSShadowMaterial extends three_module.q2{constructor(){super(...arguments),this.typeSlug="fsShadow",this.assetType="material",this._uniforms={},this.lastFrameTexture=null}get materialObject(){return this}onBeforeCompile(o,l){o.vertexShader=o.vertexShader.replace("#include <project_vertex>",`
#include <project_vertex>
gl_Position = vec4(uv*2.-1., 0, 1.); 
        `),o.vertexShader=o.vertexShader.replace("void main() {",`
varying vec2 vUv;
void main() {
    vUv = uv;
        `),o.fragmentShader=o.fragmentShader.replace("void main() {",`
varying vec2 vUv;
uniform sampler2D tLastThis;
void main() {
        `),o.fragmentShader=o.fragmentShader.replace("gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );",fe`
float shadow = getShadowMask();

//shift the color by dither_shift
shadow = clamp(shadow + mix(-1./512., 1./512., rand( gl_FragCoord.xy )), 0., 1.);

float last = unpackRGBAToDepth(texture2D(tLastThis, vUv));
gl_FragColor = packDepthToRGBA(mix(last, shadow, opacity));
//if not useMovingAverage:
//gl_FragColor = packDepthToRGBA(shadow * opacity + last);
        `),Object.assign(o.uniforms,this._uniforms),super.onBeforeCompile(o,l)}customProgramCacheKey(){return super.customProgramCacheKey()}toJSON(o){throw new Error("Method not supported for this material.")}fromJSON(o,l){throw new Error("Method not supported for this material.")}copyProps(o){throw new Error("Method not supported for this material.")}setDirty(o){this.needsUpdate=!0,this.dispatchEvent({...o,type:"materialUpdate"})}}FSShadowMaterial_decorate([uniform({propKey:"tLastThis"})],FSShadowMaterial.prototype,"lastFrameTexture",void 0);var seperableShadowBlur=`#include <packing>
uniform sampler2D colorTexture;uniform vec2 size;uniform vec2 direction;uniform float step;varying vec2 vUv;void main(){float sum=0.;vec2 uvDelta=step*direction/size;sum+=unpackRGBAToDepth(texture2D(colorTexture,vUv-1.*uvDelta))*0.3333;sum+=unpackRGBAToDepth(texture2D(colorTexture,vec2(vUv.x,vUv.y)))*0.3333;sum+=unpackRGBAToDepth(texture2D(colorTexture,vUv+1.*uvDelta))*0.3333;gl_FragColor=packDepthToRGBA(sum);}`,ShadowMapBaker_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class ShadowMapBaker extends I{get attachedMesh(){return this._attachedMesh}set attachedMesh(o){this._attachedMesh!==o&&(this._attachedMesh&&this.cleanupMaterial(),this._attachedMesh=o,this._attachedMesh&&this._updateMaterial())}get target(){return this._target}get light(){return this._light}constructor(o){super(),this.enabled=!0,this._lightLayer=5,this._frameNumber=0,this.maxFrameNumber=400,this.smoothShadow=!1,this.shadowMapType=three_module.bTm,this.groundMapMode="aoMap",this.alphaVignette=!0,this.alphaVignetteAxis="xy",this.shadowAutoUpdate=!0,this._bakeCounter=0,this.maxBakeCount=1/0,this.materialExtension={parsFragmentSnippet:(c,u)=>fe`
            uniform float transitionOpacity;
            `,extraUniforms:{transitionOpacity:{value:1}},shaderExtender:(c,u,h)=>{this.groundMapMode==="aoMap"?c.fragmentShader=shaderReplaceString(c.fragmentShader,"#include <aomap_fragment>",shaderReplaceString(three_module.vxI.aomap_fragment,"float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;","float ambientOcclusion = ( mix(1., unpackRGBAToDepth(texture2D( aoMap, vAoMapUv ) ), transitionOpacity) - 1.0) * aoMapIntensity + 1.0;")):this.groundMapMode==="map"?c.fragmentShader=shaderReplaceString(c.fragmentShader,"#include <map_fragment>",shaderReplaceString(three_module.vxI.map_fragment,"diffuseColor *= sampledDiffuseColor","float groundShadow = mix(1., unpackRGBAToDepth(sampledDiffuseColor), transitionOpacity); diffuseColor.rgb *= groundShadow; diffuseColor.a *= max(0., 1.-groundShadow) * transitionOpacity;")):this.groundMapMode==="alphaMap"&&(c.fragmentShader=shaderReplaceString(c.fragmentShader,"#include <alphamap_fragment>",shaderReplaceString(three_module.vxI.alphamap_fragment,"texture2D( alphaMap, vAlphaMapUv ).g","1. - unpackRGBAToDepth( texture2D( alphaMap, vAlphaMapUv ) )",{replaceAll:!0}))),c.fragmentShader=shaderReplaceString(c.fragmentShader,"#include <opaque_fragment>",fe`#include <opaque_fragment>
                #ifndef OPAQUE
                    #ifdef USE_AOMAP
                        #if NUM_DIR_LIGHT_SHADOWS > 0
                            // TODO find a better solution
                            float alphaMod = length(reflectedLight.directDiffuse)*4./float(NUM_DIR_LIGHT_SHADOWS);
                        #else
                            float alphaMod = 1.;
                        #endif
                        float t1 = 1. - ambientOcclusion;
                        float t2 = max(1. - alphaMod, 0.);
                        float t = t1 + t2;
                        gl_FragColor.a *= max(t, 0.);
                    #endif
                #endif
            `),this.alphaVignette&&h.capabilities.isWebGL2&&(c.defines.USE_UV="",c.fragmentShader=shaderReplaceString(c.fragmentShader,"#include <opaque_fragment>",fe`#include <opaque_fragment>
                    #ifndef OPAQUE
                    float weight = 0.;
                    #ifdef USE_UV // why are we checking for this? this is always supposed to be true
                    weight = 2.*abs(length(0.5 - vUv.${this.alphaVignetteAxis}));
                    #endif
                    #if defined(USE_LIGHTMAP) || defined(USE_AOMAP)
                    weight = 2.*abs(length(0.5 - vAoMapUv.${this.alphaVignetteAxis}));
                    #endif
                    weight = min(1., max(0., weight))-0.5;
                    weight = min(1., max(0., 1.0-2.*weight));
                    weight = pow(weight, 1.5);
                    gl_FragColor.a *= weight;
                    //gl_FragColor.rgb /= max(0.01, weight);
                    gl_FragColor = saturate(gl_FragColor);
                    //gl_FragColor.a = 0.5;
                    #endif
                    `))},computeCacheKey:()=>this.groundMapMode+"."+this.alphaVignette+"."+this.alphaVignetteAxis,onObjectRender:(c,u)=>{u.materialObject.userData.gMapMode!==this.groundMapMode&&(u.materialObject.userData.gMapMode=this.groundMapMode,u.materialObject.needsUpdate=!0)},isCompatible:c=>c.isMeshStandardMaterial2},this._viewer=o;const l=new RandomizedDirectionalLight(16777215,10,{near:1.5,far:20,bias:0,frustumSize:4,width:1024,height:1024,enabled:!0,radius:10,normalBias:0},{direction:new three_module.Pq0(.2,1,.2).normalize(),spread:.9,focus:1,distanceScale:20,minDistanceScale:new three_module.Pq0(10,10,10),normalDirection:new three_module.Pq0(0,1,0)});l.shadow.camera.updateProjectionMatrix(),l.layers.disableAll(),l.layers.set(this._lightLayer),this._light=l,o.scene.addLight(this._light,{addToRoot:!0}),this._shadowMat=new FSShadowMaterial({color:"#ffffff",toneMapped:!1,depthWrite:!1,depthTest:!1,premultipliedAlpha:!1,opacity:1,transparent:!1,blending:three_module.XIg}),this._shadowBlurMat=new ShaderMaterial2({uniforms:{colorTexture:{value:null},step:{value:.1},size:{value:new three_module.I9Y(.5,.5)},direction:{value:new three_module.I9Y(.5,.5)}},vertexShader:defaultVertex,fragmentShader:seperableShadowBlur})}dispose(){this._shadowMat.dispose(),this._target=void 0,this.reset()}cleanupMaterial(){this._updateMaterial(!0)}_groundMapModeChanged(){this._attachedMesh&&(this.cleanupMaterial(),this._updateMaterial(),this.groundMapMode==="alphaMap"?this._attachedMesh.material.transparent=!0:this._attachedMesh.material.transparent=!1),this.reset()}_alphaVignetteChanged(){var o,l,c;(l=(o=this.materialExtension)===null||o===void 0?void 0:o.setDirty)===null||l===void 0||l.call(o),(c=this._viewer)===null||c===void 0||c.setDirty()}fromJSON(o,l){return deserializeObject(o,this,!0,l),this.reset(),this}reset(){this._frameNumber=0}get frameNumber(){return this._frameNumber}autoUpdateShadow(){return!(!this.shadowAutoUpdate||this._bakeCounter>=this.maxBakeCount||!this.updateShadow()||(this._frameNumber===this.maxFrameNumber?this.dispatchEvent({type:"shadowBaked",bakeCount:++this._bakeCounter}):this._frameNumber>0&&this._frameNumber<this.maxFrameNumber&&this.dispatchEvent({type:"shadowBaking",progress:this._frameNumber/this.maxFrameNumber,bakeCount:this._bakeCounter}),0))}updateShadow(){if(!this.enabled)return!1;const o=this._attachedMesh;if(!o||++this._frameNumber>this.maxFrameNumber)return!1;const l=1024;this._target||(this._target=this._viewer.renderer.createTarget({type:three_module.OUM,depthBuffer:!1,size:new three_module.I9Y(l,l),sizeMultiplier:void 0,colorSpace:three_module.jf0,format:three_module.GWd})),this._frameNumber<3?this._light.randomizePosition(0,1,0):this._light.randomizePosition(this._frameNumber),o.castShadow=!1;const c=this._viewer.renderer.rendererObject,u=c.shadowMap,h=u.type,_=u.needsUpdate,A=u.autoUpdate;u.type=this.shadowMapType,u.needsUpdate=!0,u.autoUpdate=!1;const w=this._viewer.scene,C=new three_module.zgK;C.disableAll(),w.modelObject.traverse(ue=>{ue.isLight&&ue!==this._light.lightObject&&(ue.userData.__gp_layers=ue.layers,ue.layers=C)});const M=w.activeCamera.cameraObject;if(M.layers.mask&1<<this._lightLayer)throw"Camera can render pseudo directional light, check layers";M.layers.enable(this._lightLayer),o.layers.disable(this._lightLayer),setThreeRendererMode(c,{shadowMapRender:!0,backgroundRender:!1,sceneRender:!1},()=>this._viewer.renderer.renderScene(w)),M.layers.disable(this._lightLayer);const O=M.layers.mask;M.layers.set(this._lightLayer),o.layers.enable(this._lightLayer);const ne=this._viewer.renderer.getTempTarget({type:three_module.OUM,depthBuffer:!1,size:new three_module.I9Y(l,l),colorSpace:three_module.jf0,format:three_module.GWd}),ce=ne.texture.colorSpace;ne.texture.colorSpace=three_module.jf0,this._viewer.renderer.blit(this._target.texture,ne,{clear:!0});{const ue=o.material,ye=o.frustumCulled,Oe=c.getRenderTarget(),ke=c.getActiveCubeFace(),Ve=c.getActiveMipmapLevel();o.material=this._shadowMat,o.frustumCulled=!1,c.setRenderTarget(this._target),this._shadowMat.opacity=Math.max(1/this.maxFrameNumber,1/this._frameNumber),this._shadowMat.lastFrameTexture=ne.texture,this._shadowMat.needsUpdate=!0,setThreeRendererMode(c,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!1,transmissionRender:!1},()=>this._viewer.renderer.renderScene(w)),c.setRenderTarget(Oe,ke,Ve),o.frustumCulled=ye,o.material=ue,this.smoothShadow&&this._applySmoothFilter(this._target,ne)}return ne.texture.colorSpace=ce,this._viewer.renderer.releaseTempTarget(ne),o.layers.disable(this._lightLayer),M.layers.mask=O,w.modelObject.traverse(ue=>{ue.isLight&&ue!==this._light.lightObject&&(ue.layers=ue.userData.__gp_layers,delete ue.userData.__gp_layers)}),u.type=h,u.needsUpdate=_,u.autoUpdate=A,o.castShadow=!0,(this._frameNumber<3||this._frameNumber>Math.min(100,this.maxFrameNumber)&&this._frameNumber%4==0)&&(this._updateMaterial(),this._viewer.setDirty(),o.dispatchEvent({type:"materialUpdate"})),!0}_updateMaterial(o=!1){var l,c,u;this._attachedMesh&&(o?(this._attachedMesh.material.alphaMap===((l=this._target)===null||l===void 0?void 0:l.texture)&&(this._attachedMesh.material.alphaMap=null),this._attachedMesh.material.aoMap===((c=this._target)===null||c===void 0?void 0:c.texture)&&(this._attachedMesh.material.aoMap=null),this._attachedMesh.material.map===((u=this._target)===null||u===void 0?void 0:u.texture)&&(this._attachedMesh.material.map=null)):this._target&&(this.groundMapMode==="alphaMap"&&(this._attachedMesh.material.alphaMap=this._target.texture),this.groundMapMode==="aoMap"&&(this._attachedMesh.material.aoMap=this._target.texture),this.groundMapMode==="map"&&(this._attachedMesh.material.map=this._target.texture)),this._attachedMesh.material&&(this._attachedMesh.material.userData.ALPHA_I_RGBA_PACKING=!o&&this.groundMapMode==="alphaMap",this._attachedMesh.material.alphaTest=o||this.groundMapMode!=="alphaMap"?0:.01,this._attachedMesh.material.needsUpdate=!0))}_applySmoothFilter(o,l){this._shadowBlurMat.uniforms.colorTexture.value=o.texture,this._shadowBlurMat.uniforms.direction.value.set(1,0),this._shadowBlurMat.uniforms.size.value.set(o.width,o.height),this._viewer.renderer.blit(void 0,l,{material:this._shadowBlurMat}),this._shadowBlurMat.uniforms.colorTexture.value=l.texture,this._shadowBlurMat.uniforms.direction.value.set(0,1),this._shadowBlurMat.uniforms.size.value.set(l.width,l.height),this._viewer.renderer.blit(void 0,o,{material:this._shadowBlurMat})}}ShadowMapBaker_decorate([serialize("randomizedLight")],ShadowMapBaker.prototype,"_light",void 0),ShadowMapBaker_decorate([x(ShadowMapBaker.prototype.reset),serialize()],ShadowMapBaker.prototype,"maxFrameNumber",void 0),ShadowMapBaker_decorate([x(ShadowMapBaker.prototype.reset),serialize()],ShadowMapBaker.prototype,"smoothShadow",void 0),ShadowMapBaker_decorate([serialize(),x(ShadowMapBaker.prototype.reset)],ShadowMapBaker.prototype,"shadowMapType",void 0),ShadowMapBaker_decorate([x(ShadowMapBaker.prototype._groundMapModeChanged),serialize()],ShadowMapBaker.prototype,"groundMapMode",void 0),ShadowMapBaker_decorate([serialize(),x(ShadowMapBaker.prototype._alphaVignetteChanged)],ShadowMapBaker.prototype,"alphaVignette",void 0),ShadowMapBaker_decorate([serialize(),x(ShadowMapBaker.prototype._alphaVignetteChanged)],ShadowMapBaker.prototype,"alphaVignetteAxis",void 0),ShadowMapBaker_decorate([serialize()],ShadowMapBaker.prototype,"maxBakeCount",void 0);var reflectorSample=`#ifndef D_sceneBoundingRadius
#define D_sceneBoundingRadius 
uniform float sceneBoundingRadius;
#endif
varying vec4 vRefUv;uniform sampler2D tRefDiffuse;uniform vec2 tRefDiffuseSize;float getSpecularMIPLevel(const in float roughness,const in float maxMIPLevel){float sigma=PI*roughness*roughness/(1.+roughness);float desiredMIPLevel=maxMIPLevel+log2(sigma);return clamp(desiredMIPLevel,0.,maxMIPLevel);}vec4 getReflectionColor(const in float roughness,const in float depthModifier){float mip=getSpecularMIPLevel(roughness+depthModifier,5.);vec4 color=texture2D(tRefDiffuse,vRefUv.xy/vRefUv.w,mip);float blurDist=saturate(2./(1.+pow(abs(vViewPosition.z),0.25)))*mip*32.*color.a;float rnd=PI2*interleavedGradientNoise(vUv.xy,frameCount);vec4 rotationMatrix=vec4(cos(rnd),-sin(rnd),0.,0.);rotationMatrix.z=-rotationMatrix.y;rotationMatrix.w=rotationMatrix.x;vec3 colorSum=color.rgb*color.a;float weightSum=0.001+color.a;vec2 ofs;setPds();
#pragma unroll_loop_start
for(int i=0;i<16;i++){ofs=poisson_disk_samples[UNROLLED_LOOP_INDEX];ofs=vec2(dot(ofs,rotationMatrix.xy),dot(ofs,rotationMatrix.zw));ofs=vRefUv.xy+vRefUv.w*blurDist*ofs/tRefDiffuseSize.xy;color=texture2D(tRefDiffuse,ofs/vRefUv.w,mip);colorSum+=color.rgb*color.a;weightSum+=color.a;}
#pragma unroll_loop_end
return vec4(colorSum/weightSum,1.);}`,Reflector2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class Reflector2 extends three_module.eaF{_updateExtension(){var o,l;this.transparentReflectionBackground=this.reflectorModePhysical,(l=(o=this.materialExtension)===null||o===void 0?void 0:o.setDirty)===null||l===void 0||l.call(o)}constructor(o,l,c=0){super(o),this.type="Reflector",this.isReflector2=!0,this.enabled=!0,this.reflectorModePhysical=!0,this.reflectionTargetNeedsUpdate=!0,this.transparentReflectionBackground=!0,this.materialExtension={extraUniforms:{tRefDiffuse:{value:null},tRefDiffuseSize:{value:new three_module.I9Y},refTextureMatrix:{value:null},frameCount:{value:0},sceneBoundingRadius:{value:0}},extraDefines:{USE_UV:""},updaters:[],shaderExtender:(Oe,ke,Ve)=>{if(this.enabled){Oe.vertexShader=shaderReplaceString(Oe.vertexShader,"void main() {",`void main() {
vRefUv = refTextureMatrix * vec4( position, 1.0 );`);const tt="#glMarker beforeModulation";Oe.fragmentShader=shaderReplaceString(Oe.fragmentShader,tt,`
                    if(roughnessFactor < 0.95) {
                        float d = 0.;//textureProj(tRefDepth, vRefUv).r;
                        // d = min(2., max(0., (d-0.06) * ((7./3.-ior)) * sceneBoundingRadius));
                        vec4 refBaseColor = getReflectionColor(material.roughness, material.roughness * d);
                        // refBaseColor.rgb = vec3(refBaseColor.a);
                        // refBaseColor.a *= 1.0 - clamp(material.roughness * .3, 0., 1.);
                        `+(this.reflectorModePhysical?`
                        #if !defined(SSR_ENABLED) || SSR_ENABLED < 1 
                        vec3 specularColor = EnvironmentBRDF(geometryNormal, geometryViewDir, material.specularColor.rgb, material.specularF90, material.roughness);
                        #endif
                        reflectedLight.indirectSpecular = mix(vec3(reflectedLight.indirectSpecular), saturate(specularColor.rgb * refBaseColor.rgb), refBaseColor.a);
                        `:`
                        reflectedLight.indirectSpecular = saturate(diffuseColor.rgb * refBaseColor.rgb);
                        diffuseColor.a *= refBaseColor.a;
                        `)+`}
`+tt)}},parsVertexSnippet:()=>this.enabled?`
		uniform mat4 refTextureMatrix;
		varying vec4 vRefUv;
`:"",parsFragmentSnippet:()=>this.enabled?poissonDiskSamples+`
`+randomHelpers+`
`+reflectorSample:"",computeCacheKey:Oe=>this.enabled+" "+Oe.materialObject.transparent+" "+this.reflectorModePhysical+" ",onObjectRender:(Oe,{materialObject:ke})=>{ke.userData.__lastTransparent!==ke.transparent&&(ke.needsUpdate=!0,ke.userData.__lastTransparent=ke.transparent)},isCompatible:Oe=>Oe.isMeshStandardMaterial2},this.material=void 0,this._renderTarget=l;const u=new three_module.Zcv,h=new three_module.Pq0,_=new three_module.Pq0,A=new three_module.Pq0,w=new three_module.kn4,C=new three_module.Pq0(0,0,-1),M=new three_module.IUQ,O=new three_module.Pq0,ne=new three_module.Pq0,ce=new three_module.IUQ,ue=new three_module.kn4,ye=new three_module.ubm;three_module.cj9.isPowerOfTwo(l.texture.image.width)&&three_module.cj9.isPowerOfTwo(l.texture.image.height)||(this._renderTarget.texture.generateMipmaps=!1),this.onBeforeRender=(Oe,ke,Ve)=>{if(!this.enabled||!Oe.userData.mainRenderPass||!this.reflectionTargetNeedsUpdate)return;const tt=Ve.view?Object.assign({},Ve.view):null;if(tt&&Ve.clearViewOffset&&Ve.clearViewOffset(),_.setFromMatrixPosition(this.matrixWorld),A.setFromMatrixPosition(Ve.matrixWorld),w.extractRotation(this.matrixWorld),h.set(0,0,1),h.applyMatrix4(w),O.subVectors(_,A),O.dot(h)>0)return;O.reflect(h).negate(),O.add(_),w.extractRotation(Ve.matrixWorld),C.set(0,0,-1),C.applyMatrix4(w),C.add(A),ne.subVectors(_,C),ne.reflect(h).negate(),ne.add(_),ye.position.copy(O),ye.up.set(0,1,0),ye.up.applyMatrix4(w),ye.up.reflect(h),ye.lookAt(ne),ye.far=2,ye.near=0,ye.updateMatrixWorld(),ye.projectionMatrix.copy(Ve.projectionMatrix),ue.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),ue.multiply(ye.projectionMatrix),ue.multiply(ye.matrixWorldInverse),ue.multiply(this.matrixWorld),u.setFromNormalAndCoplanarPoint(h,_),u.applyMatrix4(ye.matrixWorldInverse),M.set(u.normal.x,u.normal.y,u.normal.z,u.constant);const ht=ye.projectionMatrix;ce.x=(Math.sign(M.x)+ht.elements[8])/ht.elements[0],ce.y=(Math.sign(M.y)+ht.elements[9])/ht.elements[5],ce.z=-1,ce.w=(1+ht.elements[10])/ht.elements[14],M.multiplyScalar(2/M.dot(ce)),ht.elements[2]=M.x,ht.elements[6]=M.y,ht.elements[10]=M.z+1-c,ht.elements[14]=M.w,this.visible=!1;const ut=Oe.getRenderTarget(),_t=Oe.xr.enabled,at=Oe.shadowMap.autoUpdate;Oe.xr.enabled=!1,Oe.shadowMap.autoUpdate=!1,Oe.setRenderTarget(this._renderTarget),Oe.state.buffers.depth.setMask(!0),Oe.autoClear===!1&&Oe.clear();const lt=ke.background;this.transparentReflectionBackground&&(ke.background=null);const pt=!this.transparentReflectionBackground;lt!=null&&lt.isTexture&&pt&&(lt.userData||(lt.userData={}),lt.userData.flipX=!lt.userData.flipX),setThreeRendererMode(Oe,{shadowMapRender:!1,backgroundRender:pt,opaqueRender:!0,transparentRender:!0,transmissionRender:!1,screenSpaceRendering:!1},()=>Oe.render(ke,ye)),lt!=null&&lt.isTexture&&pt&&(lt.userData.flipX=!lt.userData.flipX||void 0),this.transparentReflectionBackground&&(ke.background=lt),Oe.xr.enabled=_t,Oe.shadowMap.autoUpdate=at,Oe.setRenderTarget(ut),tt!=null&&tt.enabled&&Ve.setViewOffset&&Ve.setViewOffset(tt.fullWidth,tt.fullHeight,tt.offsetX,tt.offsetY,tt.width,tt.height);const xt=Ve.viewport;xt!==void 0&&Oe.state.viewport(xt),this.visible=!0,this.reflectionTargetNeedsUpdate=!1},this.textureMatrix=ue,this.materialExtension.extraUniforms.tRefDiffuse.value=this._renderTarget.texture,this.materialExtension.extraUniforms.tRefDiffuseSize.value=new three_module.I9Y(this._renderTarget.width,this._renderTarget.height),this.materialExtension.extraUniforms.refTextureMatrix.value=ue}getRenderTarget(){return this._renderTarget}}Reflector2_decorate([x(Reflector2.prototype._updateExtension)],Reflector2.prototype,"enabled",void 0),Reflector2_decorate([x(Reflector2.prototype._updateExtension)],Reflector2.prototype,"reflectorModePhysical",void 0),Reflector2.prototype.isReflector=!0;var BaseGroundPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class BaseGroundPlugin extends AViewerPlugin{get enabled(){return this.visible}set enabled(o){this.visible=o}get material(){return this._material}get mesh(){return this._iMesh}constructor(o={}){super(),this._transformNeedRefresh=!0,this.dependencies=[AssetManagerPlugin],this.visible=!0,this.size=8,this.yOffset=0,this.renderToDepth=!0,this.tonemapGround=!0,this.limitCameraAboveGround=!1,this.enableRefreshTransform=!0,this._cameraLimitsSet=!1,this._cameraLastMaxPolarAngle=Math.PI,this.useModelBounds=!1,this._refreshMaterial=this._refreshMaterial.bind(this),this._refreshTransform=this._refreshTransform.bind(this),this._refreshCameraLimits=this._refreshCameraLimits.bind(this),this.refreshOptions=this.refreshOptions.bind(this),this._refreshOptions2=this._refreshOptions2.bind(this),this._onSceneUpdate=this._onSceneUpdate.bind(this),this._preRender=this._preRender.bind(this),this._postFrame=this._postFrame.bind(this),this._geometry=new three_module.bdM(1,1,1,1),this._geometry.attributes.uv2=this._geometry.attributes.uv.clone(),this._geometry.attributes.uv2.needsUpdate=!0,this._options={shape:"",up:[0,100,0],autoAdjustTransform:!0},this.setOptions(o)}get autoAdjustTransform(){return this._options.autoAdjustTransform}set autoAdjustTransform(o){this._options.autoAdjustTransform=o,this.refreshTransform()}_createMesh(){return new three_module.eaF(this._geometry)}setGeometry(o){o?this._geometry&&this._geometry.dispose():o=this._geometry,o&&(o.attributes.uv2||(o.attributes.uv2=o.attributes.uv.clone(),o.attributes.uv2.needsUpdate=!0),this._mesh&&(this._mesh.geometry=o))}async onAdded(o){var l,c;await super.onAdded(o),o.getPluginByType("TweakpaneUi")&&console.error("TweakpaneUiPlugin must be added after Ground Plugin"),this._manager=o.getPlugin(AssetManagerPlugin);const u=this._createMesh();u.userData.physicsMass=0,u.userData.isGroundMesh=!0,this._iMesh=await((l=this._manager)===null||l===void 0?void 0:l.addImportedSingle(u,{pseudoCenter:!1,autoScale:!1,addToRoot:!0})),this._mesh=(c=this._iMesh)===null||c===void 0?void 0:c.modelObject,this._mesh&&(this._mesh.userData.userSelectable=!1,this._mesh.castShadow=!0,this._mesh.receiveShadow=!0,this._mesh.name="Ground Plane"),o.scene.addEventListener("sceneUpdate",this._onSceneUpdate),o.scene.addEventListener("addSceneObject",this._onSceneUpdate),o.addEventListener("preRender",this._preRender),o.addEventListener("postFrame",this._postFrame),this.refreshOptions()}_postFrame(){this._transformNeedRefresh&&this._refreshTransform(),this._viewer}_preRender(){this._viewer}async onDispose(o){var l,c,u;return this._removeMaterial(),this._geometry.dispose(),(l=this._material)===null||l===void 0||l.dispose(),(u=(c=this._iMesh)===null||c===void 0?void 0:c.dispose)===null||u===void 0||u.call(c),super.onDispose(o)}async onRemove(o){return this._removeMaterial(),o.scene.removeEventListener("sceneUpdate",this._onSceneUpdate),o.scene.removeEventListener("addSceneObject",this._onSceneUpdate),o.removeEventListener("postFrame",this._postFrame),o.removeEventListener("preRender",this._preRender),this._manager=void 0,super.onRemove(o)}_removeMaterial(){this._material&&(this._material.userData.renderToDepth=this._material.userData.__renderToDepth,this._material.userData.__renderToDepth=void 0,this._material=void 0)}_onSceneUpdate(o){(o==null?void 0:o.geometryChanged)!==!1&&(o==null?void 0:o.updateGround)!==!1&&this.refreshTransform()}refreshTransform(){this.enableRefreshTransform&&(this._transformNeedRefresh=!0)}_refreshOptions2(){this.refreshOptions()}refreshOptions(){this._viewer&&(this._refreshMaterial(),this.refreshTransform(),this._refreshCameraLimits())}_refreshCameraLimits(){var o;const l=(o=this._viewer)===null||o===void 0?void 0:o.scene.activeCamera.controls;l&&(l.maxPolarAngle!==void 0?this.limitCameraAboveGround?(this._cameraLimitsSet||(this._cameraLastMaxPolarAngle=l.maxPolarAngle),l.maxPolarAngle=Math.PI/2,this._cameraLimitsSet=!0):this._cameraLimitsSet&&(l.maxPolarAngle=this._cameraLastMaxPolarAngle,this._cameraLimitsSet=!1):console.warn("refreshCameraLimits only available with orbit controls."))}_refreshTransform(){var o,l,c;if(!this._mesh||!this._viewer)return;let u=!1;if(this.visible!==this._mesh.visible&&(this._mesh.visible=this.visible,u=!0),this.enabled){if(this._options.autoAdjustTransform){this._mesh.userData.bboxVisible=!1;const h=this.useModelBounds?this._viewer.scene.getModelBounds(!0,!0,!0):this._viewer.scene.getBounds(!0,!0,!0);this._mesh.userData.bboxVisible=!0;const _=h.getCenter(new three_module.Pq0).sub(new three_module.Pq0(0,h.getSize(new three_module.Pq0).y/2+this.yOffset,0));u=u||_.clone().sub(this._mesh.position).length()>1e-4,u&&this._mesh.position.copy(_)}u=u||Math.abs(this._mesh.scale.x-this.size)>1e-4,u&&(this._mesh.scale.setScalar(this.size),this._mesh.setRotationFromEuler(new three_module.O9p(-Math.PI/2,0,this._mesh.rotation.z)),this._mesh.matrixWorldNeedsUpdate=!0,(c=(l=this._mesh).setDirty)===null||c===void 0||c.call(l)),this._transformNeedRefresh=!1}else u&&((o=this._viewer)===null||o===void 0||o.scene.setDirty())}_refreshMaterial(){var o,l,c,u,h,_;if(!this._viewer||!this.enabled)return!1;this._manager||console.error("GroundPlugin requires asset manager");const A=(o=this._material)!==null&&o!==void 0?o:(c=(l=this._manager)===null||l===void 0?void 0:l.materials)===null||c===void 0?void 0:c.findOrCreate("standard",{name:"BaseGroundMaterial",runtimeMaterial:!0,color:16777215,roughness:.75,metalness:.5});A&&A.userData.runtimeMaterial;let w=!1;return A!==this._material&&(this._removeMaterial(),A&&(this._material=A),!((u=this._material)===null||u===void 0)&&u.uuid||console.warn("No material found for ground"),this._viewer.scene.setDirty(),this._mesh&&this._material&&(this._material.roughness=.75,this._material.metalness=.5,((_=(h=this._mesh)===null||h===void 0?void 0:h.setMaterial)!==null&&_!==void 0?_:M=>{this._mesh&&(this._mesh.material=M.materialObject)})(this._material)),w=!0),this._material&&(this._material.userData.__renderToDepth===void 0&&(this._material.userData.__renderToDepth=this._material.userData.renderToDepth),this._material.userData.renderToDepth!==this.renderToDepth&&(this._material.userData.renderToDepth=this.renderToDepth),this._material.userData.__postTonemap===void 0&&(this._material.userData.__postTonemap=this._material.userData.postTonemap),this._material.userData.postTonemap!==this.tonemapGround&&(this._material.userData.postTonemap=this.tonemapGround),this._material.materialObject.userData.ssaoDisabled=!0,this._material.materialObject.userData.sscsDisabled=!0),this._viewer.setDirty(this),w}setOptions(o){Object.assign(this._options,o),this.refreshOptions()}fromJSON(o,l){return super.fromJSON(o,l)?(this.refreshOptions(),this):null}_extraUiConfig(){return[()=>{var o;return(o=this._material)===null||o===void 0?void 0:o.uiConfig}]}get uiConfig(){return this._uiConfig?this._uiConfig:this._uiConfig={type:"folder",label:"Ground",children:[{label:"Visible",type:"checkbox",property:[this,"visible"],limitedUi:!0},{label:"Size",type:"input",property:[this,"size"],limitedUi:!0},{label:"Render to Depth",type:"checkbox",property:[this,"renderToDepth"]},{label:"Limit Camera",type:"checkbox",property:[this,"limitCameraAboveGround"]},{label:"Tonemap",type:"checkbox",property:[this,"tonemapGround"]},{label:"Height",type:"slider",bounds:[-2,2],property:[this,"yOffset"]},{label:"Auto adjust transform",type:"checkbox",property:[this,"autoAdjustTransform"]},...this._extraUiConfig()]}}}BaseGroundPlugin_decorate([serialize("material")],BaseGroundPlugin.prototype,"_material",void 0),BaseGroundPlugin_decorate([x(BaseGroundPlugin.prototype.refreshTransform),serialize()],BaseGroundPlugin.prototype,"visible",void 0),BaseGroundPlugin_decorate([ze(BaseGroundPlugin.prototype._onSceneUpdate),serialize()],BaseGroundPlugin.prototype,"size",void 0),BaseGroundPlugin_decorate([ze(BaseGroundPlugin.prototype._onSceneUpdate),serialize()],BaseGroundPlugin.prototype,"yOffset",void 0),BaseGroundPlugin_decorate([x(BaseGroundPlugin.prototype._refreshOptions2),serialize()],BaseGroundPlugin.prototype,"renderToDepth",void 0),BaseGroundPlugin_decorate([x(BaseGroundPlugin.prototype._refreshOptions2),serialize()],BaseGroundPlugin.prototype,"tonemapGround",void 0),BaseGroundPlugin_decorate([x(BaseGroundPlugin.prototype._refreshCameraLimits),serialize()],BaseGroundPlugin.prototype,"limitCameraAboveGround",void 0);var GroundPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class GroundPlugin extends BaseGroundPlugin{get shadowBaker(){return this._shadowBaker}bakeShadows(){var o;(o=this._shadowBaker)===null||o===void 0||o.reset()}constructor(o={},l=!1){super(o),this.bakedShadows=!0,this.groundReflection=!1,this.physicalReflections=!1,this.autoFrustumSize=!0,this.autoBakeShadows=!0,this._showDebug=l,l&&this.dependencies.push(DebugPlugin),this._onSceneUpdate=this._onSceneUpdate.bind(this)}_createMesh(){const o=new Reflector2(this._geometry,this._viewer.renderer.createTarget({type:three_module.OUM,format:three_module.GWd,colorSpace:three_module.jf0,size:{width:1024,height:1024},generateMipmaps:!0,depthBuffer:!0,minFilter:three_module.$_I,magFilter:three_module.k6q})),l=o.onBeforeRender;return o.onBeforeRender=(...c)=>{var u,h,_,A,w;let C=(h=(u=this._viewer)===null||u===void 0?void 0:u.getPluginByType("SSReflection"))===null||h===void 0?void 0:h.passes.ssr.passObject;C&&!C.enabled&&(C=void 0),C&&(C.enabled=!1);let M=(w=(A=(_=this._viewer)===null||_===void 0?void 0:_.getPluginByType("SSBevelPlugin"))===null||A===void 0?void 0:A.pass)===null||w===void 0?void 0:w.passObject;M&&!M.enabled&&(M=void 0),M&&(M.enabled=!1),l(...c),C&&(C.enabled=!0),M&&(M.enabled=!0)},o}async onAdded(o){var l,c;await super.onAdded(o),this._showDebug&&((l=o.getPlugin(DebugPlugin))===null||l===void 0||l.addTexture("bake_ground_1",()=>{var u,h;return(h=(u=this._shadowBaker)===null||u===void 0?void 0:u.light.shadow.map)===null||h===void 0?void 0:h.texture},[100,100,200,200]),(c=o.getPlugin(DebugPlugin))===null||c===void 0||c.addTexture("bake_ground_2",()=>{var u,h;return(h=(u=this._shadowBaker)===null||u===void 0?void 0:u.target)===null||h===void 0?void 0:h.texture},[100,400,400,400],"texel = vec4(vec3(unpackRGBAToDepth(texel)), 1.0);"))}_postFrame(){super._postFrame(),this._viewer&&this.enabled&&this._shadowBaker&&this.bakedShadows&&this._shadowBaker.autoUpdateShadow()}_preRender(){super._preRender(),this._viewer&&(this._mesh.reflectionTargetNeedsUpdate=this._viewer.renderer.frameCount<1)}async onDispose(o){return super.onDispose(o)}async onRemove(o){return super.onRemove(o)}_removeMaterial(){var o,l,c,u;if(this._material){if(this._shadowBaker&&this._material.groundMatExtension&&((l=(o=this._material).unregisterMaterialExtensions)===null||l===void 0||l.call(o,[this._shadowBaker.materialExtension]),delete this._material.groundMatExtension),this._material.reflectorMatExtension){const h=this._mesh.materialExtension;h||console.warn("WebGi GroundPlugin: unable to find the extension to unregister"),(u=(c=this._material).unregisterMaterialExtensions)===null||u===void 0||u.call(c,[h]),delete this._material.reflectorMatExtension}super._removeMaterial()}}_onSceneUpdate(o){var l;super._onSceneUpdate(o),o.geometryChanged!==!1&&this.autoBakeShadows&&((l=this._shadowBaker)===null||l===void 0||l.reset())}refreshOptions(){if(!this._viewer)return;this.bakedShadows&&!this._shadowBaker?(this._shadowBaker=new ShadowMapBaker(this._viewer),this._shadowBaker.attachedMesh=this._mesh):!this.bakedShadows&&this._shadowBaker&&(this._shadowBaker.reset(),this._shadowBaker.cleanupMaterial());const o=this._mesh;o.isReflector2&&(o.enabled=this.groundReflection,o.reflectorModePhysical=this.physicalReflections),super.refreshOptions(),this._viewer.setDirty(this)}_refreshTransform(){if(this.autoFrustumSize){const o=this.shadowBaker;if(o){const l=this.size/2;l!==o.light.shadowParams.frustumSize&&(o.light.shadowParams.frustumSize=l,o.light.updateShadowParams(),o.reset())}}super._refreshTransform()}fromJSON(o,l){return super.fromJSON(o,l)?(o.autoFrustumSize===void 0&&(this.autoFrustumSize=!1),this):null}_refreshMaterial(){var o,l,c,u;if(!this._viewer)return!1;const h=super._refreshMaterial();if(!this._material)return h;if(this.groundReflection&&this._mesh.isReflector2&&!this._material.reflectorMatExtension){const _=this._mesh.materialExtension;_.updaters=[this._viewer.scene,this._viewer.renderer],(l=(o=this._material).registerMaterialExtensions)===null||l===void 0||l.call(o,[_]),this._material.reflectorMatExtension=!0}return this.bakedShadows&&this._shadowBaker&&!this._material.groundMatExtension&&((u=(c=this._material).registerMaterialExtensions)===null||u===void 0||u.call(c,[this._shadowBaker.materialExtension]),this._material.groundMatExtension=!0),this._material.materialObject.userData.ssreflDisabled=this.groundReflection,this._material.materialObject.userData.ssreflNonPhysical=!this.physicalReflections,this._viewer.setDirty(this),h}_extraUiConfig(){var o,l,c,u,h,_,A,w,C,M,O,ne,ce,ue,ye,Oe,ke,Ve,tt,ht,ut,_t,at,lt,pt,xt,Tt,Pt,Lt,Bt;return[{label:"Baked Shadows",type:"checkbox",property:[this,"bakedShadows"]},{label:"Shadow Frames",type:"input",hidden:()=>!this._shadowBaker,stepSize:1,bounds:[1,1e3],property:[this._shadowBaker,"maxFrameNumber"]},{label:"Alpha Vignette",type:"checkbox",hidden:()=>!this._material||this._material.transmission<1e-4&&!this._material.transparent,property:[this._shadowBaker,"alphaVignette"],limitedUi:!0,onChange:()=>{var Ut,kt;return(kt=(Ut=this._uiConfig)===null||Ut===void 0?void 0:Ut.uiRefresh)===null||kt===void 0?void 0:kt.call(Ut,"postFrame",!0)}},{label:"Alpha Vignette Axis",type:"dropdown",hidden:()=>{var Ut;return!(!((Ut=this._shadowBaker)===null||Ut===void 0)&&Ut.alphaVignette)||!this._material||this._material.transmission<1e-4&&!this._material.transparent},property:[this._shadowBaker,"alphaVignetteAxis"],children:["x","y","xy"].map(Ut=>({label:Ut,value:Ut})),limitedUi:!0},{label:"Planar Reflections",type:"checkbox",property:[this,"groundReflection"]},{label:"Auto Frustum Size",type:"checkbox",property:[this,"autoFrustumSize"]},{label:"Physical Reflections",type:"checkbox",property:[this,"physicalReflections"],limitedUi:!0},{label:"Shadow type",type:"dropdown",hidden:()=>!this._shadowBaker,property:[this._shadowBaker,"groundMapMode"],children:[{label:"aoMap"},{label:"map"},{label:"alphaMap"}],limitedUi:!0},{label:"Smooth Shadow",type:"checkbox",property:[this._shadowBaker,"smoothShadow"]},{label:"Baked shadow type",type:"dropdown",children:[["Basic",three_module.bTm],["PCF",three_module.QP0],["PCFSoft",three_module.Wk7],["VSM",three_module.RyA]].map(Ut=>({label:Ut[0].toString(),value:Ut[1]})),property:[this._shadowBaker,"shadowMapType"]},{type:"folder",label:"Randomized Light",hidden:()=>!this._shadowBaker,limitedUi:!0,children:[{type:"color",label:"Color",property:[(o=this._shadowBaker)===null||o===void 0?void 0:o.light,"color"]},{type:"slider",label:"Intensity",bounds:[0,100],property:[(l=this._shadowBaker)===null||l===void 0?void 0:l.light,"intensity"]},{type:"checkbox",label:"Shadow Enabled",property:[(u=(c=this._shadowBaker)===null||c===void 0?void 0:c.light)===null||u===void 0?void 0:u.shadowParams,"enabled"],onChange:[(_=(h=this._shadowBaker)===null||h===void 0?void 0:h.light)===null||_===void 0?void 0:_.updateShadowParams,this._onSceneUpdate]},{type:"slider",bounds:[0,1],property:[(w=(A=this._shadowBaker)===null||A===void 0?void 0:A.light)===null||w===void 0?void 0:w.randomParams,"focus"],onChange:[this._onSceneUpdate]},{type:"slider",bounds:[0,1],property:[(M=(C=this._shadowBaker)===null||C===void 0?void 0:C.light)===null||M===void 0?void 0:M.randomParams,"spread"],onChange:[this._onSceneUpdate],limitedUi:!0},{type:"slider",bounds:[.01,60],property:[(ne=(O=this._shadowBaker)===null||O===void 0?void 0:O.light)===null||ne===void 0?void 0:ne.randomParams,"distanceScale"],onChange:[(ue=(ce=this._shadowBaker)===null||ce===void 0?void 0:ce.light)===null||ue===void 0?void 0:ue.updateShadowParams,this._onSceneUpdate]},{type:"vec3",bounds:[-1,1],property:[(Oe=(ye=this._shadowBaker)===null||ye===void 0?void 0:ye.light)===null||Oe===void 0?void 0:Oe.randomParams,"direction"],onChange:[this._onSceneUpdate],limitedUi:!0},{type:"vec3",bounds:[-1,1],property:[(Ve=(ke=this._shadowBaker)===null||ke===void 0?void 0:ke.light)===null||Ve===void 0?void 0:Ve.randomParams,"normalDirection"],onChange:[this._onSceneUpdate],limitedUi:!0},{type:"slider",bounds:[.01,10],property:[(ht=(tt=this._shadowBaker)===null||tt===void 0?void 0:tt.light)===null||ht===void 0?void 0:ht.shadowParams,"radius"],onChange:[(_t=(ut=this._shadowBaker)===null||ut===void 0?void 0:ut.light)===null||_t===void 0?void 0:_t.updateShadowParams,this._onSceneUpdate]},{type:"input",property:[(lt=(at=this._shadowBaker)===null||at===void 0?void 0:at.light)===null||lt===void 0?void 0:lt.shadowParams,"frustumSize"],hidden:()=>this.autoFrustumSize,onChange:[(xt=(pt=this._shadowBaker)===null||pt===void 0?void 0:pt.light)===null||xt===void 0?void 0:xt.updateShadowParams,this._onSceneUpdate]},{type:"slider",bounds:[-.1,.1],property:[(Pt=(Tt=this._shadowBaker)===null||Tt===void 0?void 0:Tt.light)===null||Pt===void 0?void 0:Pt.shadowParams,"bias"],onChange:[(Bt=(Lt=this._shadowBaker)===null||Lt===void 0?void 0:Lt.light)===null||Bt===void 0?void 0:Bt.updateShadowParams,this._onSceneUpdate]}]},...super._extraUiConfig()]}}GroundPlugin.PluginType="Ground",GroundPlugin_decorate([x(GroundPlugin.prototype.refreshOptions),serialize()],GroundPlugin.prototype,"bakedShadows",void 0),GroundPlugin_decorate([x(GroundPlugin.prototype.refreshOptions),serialize()],GroundPlugin.prototype,"groundReflection",void 0),GroundPlugin_decorate([x(GroundPlugin.prototype.refreshOptions),serialize()],GroundPlugin.prototype,"physicalReflections",void 0),GroundPlugin_decorate([x(GroundPlugin.prototype.refreshOptions),serialize()],GroundPlugin.prototype,"autoFrustumSize",void 0),GroundPlugin_decorate([serialize("shadowBaker")],GroundPlugin.prototype,"_shadowBaker",void 0);class EXRLoader extends three_module.BRH{constructor(o){super(o),this.type=three_module.ix0}parse(o){const h=Math.pow(2.7182818,2.2),_={l:0,c:0,lc:0};function A(jt,Gt,li,vi,xi){for(;li<jt;)Gt=Gt<<8|ti(vi,xi),li+=8;li-=jt,_.l=Gt>>li&(1<<jt)-1,_.c=Gt,_.lc=li}const w=new Array(59);function C(jt){return 63&jt}function M(jt){return jt>>6}const O={c:0,lc:0};function ne(jt,Gt,li,vi){jt=jt<<8|ti(li,vi),Gt+=8,O.c=jt,O.lc=Gt}const ce={c:0,lc:0};function ue(jt,Gt,li,vi,xi,mi,Ri,Zi,dn){if(jt==Gt){vi<8&&(ne(li,vi,xi,mi),li=O.c,vi=O.lc);let hn=li>>(vi-=8);if(hn=new Uint8Array([hn])[0],Zi.value+hn>dn)return!1;const an=Ri[Zi.value-1];for(;hn-- >0;)Ri[Zi.value++]=an}else{if(!(Zi.value<dn))return!1;Ri[Zi.value++]=jt}ce.c=li,ce.lc=vi}function ye(jt){return 65535&jt}function Oe(jt){const Gt=ye(jt);return Gt>32767?Gt-65536:Gt}const ke={a:0,b:0};function Ve(jt,Gt){const li=Oe(jt),vi=Oe(Gt),xi=li+(1&vi)+(vi>>1),mi=xi,Ri=xi-vi;ke.a=mi,ke.b=Ri}function tt(jt,Gt){const li=ye(jt),vi=ye(Gt),xi=li-(vi>>1)&65535,mi=vi+xi-32768&65535;ke.a=mi,ke.b=xi}function ht(jt,Gt,li,vi,xi,mi,Ri){const Zi=Ri<16384,dn=li>xi?xi:li;let hn,an,pn=1;for(;pn<=dn;)pn<<=1;for(pn>>=1,hn=pn,pn>>=1;pn>=1;){an=0;const Yi=an+mi*(xi-hn),nn=mi*pn,kn=mi*hn,un=vi*pn,On=vi*hn;let fn,Fn,xr,Zn;for(;an<=Yi;an+=kn){let Rn=an;const Un=an+vi*(li-hn);for(;Rn<=Un;Rn+=On){const Ai=Rn+un,Fi=Rn+nn,Ki=Fi+un;Zi?(Ve(jt[Rn+Gt],jt[Fi+Gt]),fn=ke.a,xr=ke.b,Ve(jt[Ai+Gt],jt[Ki+Gt]),Fn=ke.a,Zn=ke.b,Ve(fn,Fn),jt[Rn+Gt]=ke.a,jt[Ai+Gt]=ke.b,Ve(xr,Zn),jt[Fi+Gt]=ke.a,jt[Ki+Gt]=ke.b):(tt(jt[Rn+Gt],jt[Fi+Gt]),fn=ke.a,xr=ke.b,tt(jt[Ai+Gt],jt[Ki+Gt]),Fn=ke.a,Zn=ke.b,tt(fn,Fn),jt[Rn+Gt]=ke.a,jt[Ai+Gt]=ke.b,tt(xr,Zn),jt[Fi+Gt]=ke.a,jt[Ki+Gt]=ke.b)}if(li&pn){const Ai=Rn+nn;Zi?Ve(jt[Rn+Gt],jt[Ai+Gt]):tt(jt[Rn+Gt],jt[Ai+Gt]),fn=ke.a,jt[Ai+Gt]=ke.b,jt[Rn+Gt]=fn}}if(xi&pn){let Rn=an;const Un=an+vi*(li-hn);for(;Rn<=Un;Rn+=On){const Ai=Rn+un;Zi?Ve(jt[Rn+Gt],jt[Ai+Gt]):tt(jt[Rn+Gt],jt[Ai+Gt]),fn=ke.a,jt[Ai+Gt]=ke.b,jt[Rn+Gt]=fn}}hn=pn,pn>>=1}return an}function ut(jt,Gt,li,vi,xi,mi){const Ri=li.value,Zi=Zt(Gt,li),dn=Zt(Gt,li);li.value+=4;const hn=Zt(Gt,li);if(li.value+=4,Zi<0||Zi>=65537||dn<0||dn>=65537)throw new Error("Something wrong with HUF_ENCSIZE");const an=new Array(65537),pn=new Array(16384);if(function(Yi){for(let nn=0;nn<16384;nn++)Yi[nn]={},Yi[nn].len=0,Yi[nn].lit=0,Yi[nn].p=null}(pn),function(Yi,nn,kn,un,On,fn){const Fn=nn;let xr=0,Zn=0;for(;un<=On;un++){if(Fn.value-nn.value>kn)return!1;A(6,xr,Zn,Yi,Fn);const Rn=_.l;if(xr=_.c,Zn=_.lc,fn[un]=Rn,Rn==63){if(Fn.value-nn.value>kn)throw new Error("Something wrong with hufUnpackEncTable");A(8,xr,Zn,Yi,Fn);let Un=_.l+6;if(xr=_.c,Zn=_.lc,un+Un>On+1)throw new Error("Something wrong with hufUnpackEncTable");for(;Un--;)fn[un++]=0;un--}else if(Rn>=59){let Un=Rn-59+2;if(un+Un>On+1)throw new Error("Something wrong with hufUnpackEncTable");for(;Un--;)fn[un++]=0;un--}}(function(Rn){for(let Ai=0;Ai<=58;++Ai)w[Ai]=0;for(let Ai=0;Ai<65537;++Ai)w[Rn[Ai]]+=1;let Un=0;for(let Ai=58;Ai>0;--Ai){const Fi=Un+w[Ai]>>1;w[Ai]=Un,Un=Fi}for(let Ai=0;Ai<65537;++Ai){const Fi=Rn[Ai];Fi>0&&(Rn[Ai]=Fi|w[Fi]++<<6)}})(fn)}(jt,li,vi-(li.value-Ri),Zi,dn,an),hn>8*(vi-(li.value-Ri)))throw new Error("Something wrong with hufUncompress");(function(Yi,nn,kn,un){for(;nn<=kn;nn++){const On=M(Yi[nn]),fn=C(Yi[nn]);if(On>>fn)throw new Error("Invalid table entry");if(fn>14){const Fn=un[On>>fn-14];if(Fn.len)throw new Error("Invalid table entry");if(Fn.lit++,Fn.p){const xr=Fn.p;Fn.p=new Array(Fn.lit);for(let Zn=0;Zn<Fn.lit-1;++Zn)Fn.p[Zn]=xr[Zn]}else Fn.p=new Array(1);Fn.p[Fn.lit-1]=nn}else if(fn){let Fn=0;for(let xr=1<<14-fn;xr>0;xr--){const Zn=un[(On<<14-fn)+Fn];if(Zn.len||Zn.p)throw new Error("Invalid table entry");Zn.len=fn,Zn.lit=nn,Fn++}}}})(an,Zi,dn,pn),function(Yi,nn,kn,un,On,fn,Fn,xr,Zn){let Rn=0,Un=0;const Ai=Fn,Fi=Math.trunc(un.value+(On+7)/8);for(;un.value<Fi;)for(ne(Rn,Un,kn,un),Rn=O.c,Un=O.lc;Un>=14;){const _n=nn[Rn>>Un-14&16383];if(_n.len)Un-=_n.len,ue(_n.lit,fn,Rn,Un,kn,un,xr,Zn,Ai),Rn=ce.c,Un=ce.lc;else{if(!_n.p)throw new Error("hufDecode issues");let yn;for(yn=0;yn<_n.lit;yn++){const Tn=C(Yi[_n.p[yn]]);for(;Un<Tn&&un.value<Fi;)ne(Rn,Un,kn,un),Rn=O.c,Un=O.lc;if(Un>=Tn&&M(Yi[_n.p[yn]])==(Rn>>Un-Tn&(1<<Tn)-1)){Un-=Tn,ue(_n.p[yn],fn,Rn,Un,kn,un,xr,Zn,Ai),Rn=ce.c,Un=ce.lc;break}}if(yn==_n.lit)throw new Error("hufDecode issues")}}const Ki=8-On&7;for(Rn>>=Ki,Un-=Ki;Un>0;){const _n=nn[Rn<<14-Un&16383];if(!_n.len)throw new Error("hufDecode issues");Un-=_n.len,ue(_n.lit,fn,Rn,Un,kn,un,xr,Zn,Ai),Rn=ce.c,Un=ce.lc}}(an,pn,jt,li,hn,dn,mi,xi,{value:0})}function _t(jt){for(let Gt=1;Gt<jt.length;Gt++){const li=jt[Gt-1]+jt[Gt]-128;jt[Gt]=li}}function at(jt,Gt){let li=0,vi=Math.floor((jt.length+1)/2),xi=0;const mi=jt.length-1;for(;!(xi>mi||(Gt[xi++]=jt[li++],xi>mi));)Gt[xi++]=jt[vi++]}function lt(jt){let Gt=jt.byteLength;const li=new Array;let vi=0;const xi=new DataView(jt);for(;Gt>0;){const mi=xi.getInt8(vi++);if(mi<0){const Ri=-mi;Gt-=Ri+1;for(let Zi=0;Zi<Ri;Zi++)li.push(xi.getUint8(vi++))}else{const Ri=mi;Gt-=2;const Zi=xi.getUint8(vi++);for(let dn=0;dn<Ri+1;dn++)li.push(Zi)}}return li}function pt(jt,Gt,li){let vi,xi=1;for(;xi<64;)vi=Gt[jt.value],vi==65280?xi=64:vi>>8==255?xi+=255&vi:(li[xi]=vi,xi++),jt.value++}function xt(jt){const Gt=.5*Math.cos(.7853975),li=.5*Math.cos(3.14159/16),vi=.5*Math.cos(3.14159/8),xi=.5*Math.cos(3*3.14159/16),mi=.5*Math.cos(.981746875),Ri=.5*Math.cos(3*3.14159/8),Zi=.5*Math.cos(1.374445625),dn=new Array(4),hn=new Array(4),an=new Array(4),pn=new Array(4);for(let Yi=0;Yi<8;++Yi){const nn=8*Yi;dn[0]=vi*jt[nn+2],dn[1]=Ri*jt[nn+2],dn[2]=vi*jt[nn+6],dn[3]=Ri*jt[nn+6],hn[0]=li*jt[nn+1]+xi*jt[nn+3]+mi*jt[nn+5]+Zi*jt[nn+7],hn[1]=xi*jt[nn+1]-Zi*jt[nn+3]-li*jt[nn+5]-mi*jt[nn+7],hn[2]=mi*jt[nn+1]-li*jt[nn+3]+Zi*jt[nn+5]+xi*jt[nn+7],hn[3]=Zi*jt[nn+1]-mi*jt[nn+3]+xi*jt[nn+5]-li*jt[nn+7],an[0]=Gt*(jt[nn+0]+jt[nn+4]),an[3]=Gt*(jt[nn+0]-jt[nn+4]),an[1]=dn[0]+dn[3],an[2]=dn[1]-dn[2],pn[0]=an[0]+an[1],pn[1]=an[3]+an[2],pn[2]=an[3]-an[2],pn[3]=an[0]-an[1],jt[nn+0]=pn[0]+hn[0],jt[nn+1]=pn[1]+hn[1],jt[nn+2]=pn[2]+hn[2],jt[nn+3]=pn[3]+hn[3],jt[nn+4]=pn[3]-hn[3],jt[nn+5]=pn[2]-hn[2],jt[nn+6]=pn[1]-hn[1],jt[nn+7]=pn[0]-hn[0]}for(let Yi=0;Yi<8;++Yi)dn[0]=vi*jt[16+Yi],dn[1]=Ri*jt[16+Yi],dn[2]=vi*jt[48+Yi],dn[3]=Ri*jt[48+Yi],hn[0]=li*jt[8+Yi]+xi*jt[24+Yi]+mi*jt[40+Yi]+Zi*jt[56+Yi],hn[1]=xi*jt[8+Yi]-Zi*jt[24+Yi]-li*jt[40+Yi]-mi*jt[56+Yi],hn[2]=mi*jt[8+Yi]-li*jt[24+Yi]+Zi*jt[40+Yi]+xi*jt[56+Yi],hn[3]=Zi*jt[8+Yi]-mi*jt[24+Yi]+xi*jt[40+Yi]-li*jt[56+Yi],an[0]=Gt*(jt[Yi]+jt[32+Yi]),an[3]=Gt*(jt[Yi]-jt[32+Yi]),an[1]=dn[0]+dn[3],an[2]=dn[1]-dn[2],pn[0]=an[0]+an[1],pn[1]=an[3]+an[2],pn[2]=an[3]-an[2],pn[3]=an[0]-an[1],jt[0+Yi]=pn[0]+hn[0],jt[8+Yi]=pn[1]+hn[1],jt[16+Yi]=pn[2]+hn[2],jt[24+Yi]=pn[3]+hn[3],jt[32+Yi]=pn[3]-hn[3],jt[40+Yi]=pn[2]-hn[2],jt[48+Yi]=pn[1]-hn[1],jt[56+Yi]=pn[0]-hn[0]}function Tt(jt){for(let Gt=0;Gt<64;++Gt){const li=jt[0][Gt],vi=jt[1][Gt],xi=jt[2][Gt];jt[0][Gt]=li+1.5747*xi,jt[1][Gt]=li-.1873*vi-.4682*xi,jt[2][Gt]=li+1.8556*vi}}function Pt(jt,Gt,li){for(let xi=0;xi<64;++xi)Gt[li+xi]=three_module.GxU.toHalfFloat((vi=jt[xi])<=1?Math.sign(vi)*Math.pow(Math.abs(vi),2.2):Math.sign(vi)*Math.pow(h,Math.abs(vi)-1));var vi}function Lt(jt){return new DataView(jt.array.buffer,jt.offset.value,jt.size)}function Bt(jt){const Gt=jt.viewer.buffer.slice(jt.offset.value,jt.offset.value+jt.size),li=new Uint8Array(lt(Gt)),vi=new Uint8Array(li.length);return _t(li),at(li,vi),new DataView(vi.buffer)}function Ut(jt){const Gt=fflate_module_unzlibSync(jt.array.slice(jt.offset.value,jt.offset.value+jt.size)),li=new Uint8Array(Gt.length);return _t(Gt),at(Gt,li),new DataView(li.buffer)}function kt(jt){const Gt=jt.viewer,li={value:jt.offset.value},vi=new Uint16Array(jt.width*jt.scanlineBlockSize*(jt.channels*jt.type)),xi=new Uint8Array(8192);let mi=0;const Ri=new Array(jt.channels);for(let kn=0;kn<jt.channels;kn++)Ri[kn]={},Ri[kn].start=mi,Ri[kn].end=Ri[kn].start,Ri[kn].nx=jt.width,Ri[kn].ny=jt.lines,Ri[kn].size=jt.type,mi+=Ri[kn].nx*Ri[kn].ny*Ri[kn].size;const Zi=Li(Gt,li),dn=Li(Gt,li);if(dn>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(Zi<=dn)for(let kn=0;kn<dn-Zi+1;kn++)xi[kn+Zi]=ci(Gt,li);const hn=new Uint16Array(65536),an=function(kn,un){let On=0;for(let Fn=0;Fn<65536;++Fn)(Fn==0||kn[Fn>>3]&1<<(7&Fn))&&(un[On++]=Fn);const fn=On-1;for(;On<65536;)un[On++]=0;return fn}(xi,hn),pn=Zt(Gt,li);ut(jt.array,Gt,li,pn,vi,mi);for(let kn=0;kn<jt.channels;++kn){const un=Ri[kn];for(let On=0;On<Ri[kn].size;++On)ht(vi,un.start+On,un.nx,un.size,un.ny,un.nx*un.size,an)}(function(kn,un,On){for(let fn=0;fn<On;++fn)un[fn]=kn[un[fn]]})(hn,vi,mi);let Yi=0;const nn=new Uint8Array(vi.buffer.byteLength);for(let kn=0;kn<jt.lines;kn++)for(let un=0;un<jt.channels;un++){const On=Ri[un],fn=On.nx*On.size,Fn=new Uint8Array(vi.buffer,2*On.end,2*fn);nn.set(Fn,Yi),Yi+=2*fn,On.end+=fn}return new DataView(nn.buffer)}function Vt(jt){const Gt=fflate_module_unzlibSync(jt.array.slice(jt.offset.value,jt.offset.value+jt.size)),li=jt.lines*jt.channels*jt.width,vi=jt.type==1?new Uint16Array(li):new Uint32Array(li);let xi=0,mi=0;const Ri=new Array(4);for(let Zi=0;Zi<jt.lines;Zi++)for(let dn=0;dn<jt.channels;dn++){let hn=0;switch(jt.type){case 1:Ri[0]=xi,Ri[1]=Ri[0]+jt.width,xi=Ri[1]+jt.width;for(let an=0;an<jt.width;++an)hn+=Gt[Ri[0]++]<<8|Gt[Ri[1]++],vi[mi]=hn,mi++;break;case 2:Ri[0]=xi,Ri[1]=Ri[0]+jt.width,Ri[2]=Ri[1]+jt.width,xi=Ri[2]+jt.width;for(let an=0;an<jt.width;++an)hn+=Gt[Ri[0]++]<<24|Gt[Ri[1]++]<<16|Gt[Ri[2]++]<<8,vi[mi]=hn,mi++}}return new DataView(vi.buffer)}function si(jt){const Gt=jt.viewer,li={value:jt.offset.value},vi=new Uint8Array(jt.width*jt.lines*(jt.channels*jt.type*2)),xi={version:ri(Gt,li),unknownUncompressedSize:ri(Gt,li),unknownCompressedSize:ri(Gt,li),acCompressedSize:ri(Gt,li),dcCompressedSize:ri(Gt,li),rleCompressedSize:ri(Gt,li),rleUncompressedSize:ri(Gt,li),rleRawSize:ri(Gt,li),totalAcUncompressedCount:ri(Gt,li),totalDcUncompressedCount:ri(Gt,li),acCompression:ri(Gt,li)};if(xi.version<2)throw new Error("EXRLoader.parse: "+Kn.compression+" version "+xi.version+" is unsupported");const mi=new Array;let Ri=Li(Gt,li)-2;for(;Ri>0;){const un=Jt(Gt.buffer,li),On=ci(Gt,li),fn=On>>2&3,Fn=new Int8Array([(On>>4)-1])[0],xr=ci(Gt,li);mi.push({name:un,index:Fn,type:xr,compression:fn}),Ri-=un.length+3}const Zi=Kn.channels,dn=new Array(jt.channels);for(let un=0;un<jt.channels;++un){const On=dn[un]={},fn=Zi[un];On.name=fn.name,On.compression=0,On.decoded=!1,On.type=fn.pixelType,On.pLinear=fn.pLinear,On.width=jt.width,On.height=jt.lines}const hn={idx:new Array(3)};for(let un=0;un<jt.channels;++un){const On=dn[un];for(let fn=0;fn<mi.length;++fn){const Fn=mi[fn];On.name==Fn.name&&(On.compression=Fn.compression,Fn.index>=0&&(hn.idx[Fn.index]=un),On.offset=un)}}let an,pn,Yi;if(xi.acCompressedSize>0)switch(xi.acCompression){case 0:an=new Uint16Array(xi.totalAcUncompressedCount),ut(jt.array,Gt,li,xi.acCompressedSize,an,xi.totalAcUncompressedCount);break;case 1:const un=fflate_module_unzlibSync(jt.array.slice(li.value,li.value+xi.totalAcUncompressedCount));an=new Uint16Array(un.buffer),li.value+=xi.totalAcUncompressedCount}if(xi.dcCompressedSize>0){const un={array:jt.array,offset:li,size:xi.dcCompressedSize};pn=new Uint16Array(Ut(un).buffer),li.value+=xi.dcCompressedSize}xi.rleRawSize>0&&(Yi=lt(fflate_module_unzlibSync(jt.array.slice(li.value,li.value+xi.rleCompressedSize)).buffer),li.value+=xi.rleCompressedSize);let nn=0;const kn=new Array(dn.length);for(let un=0;un<kn.length;++un)kn[un]=new Array;for(let un=0;un<jt.lines;++un)for(let On=0;On<dn.length;++On)kn[On].push(nn),nn+=dn[On].width*jt.type*2;(function(un,On,fn,Fn,xr,Zn){let Rn=new DataView(Zn.buffer);const Un=fn[un.idx[0]].width,Ai=fn[un.idx[0]].height,Fi=Math.floor(Un/8),Ki=Math.ceil(Un/8),_n=Math.ceil(Ai/8),yn=Un-8*(Ki-1),Tn=Ai-8*(_n-1),qn={value:0},fr=new Array(3),wr=new Array(3),jr=new Array(3),Xr=new Array(3),Nr=new Array(3);for(let or=0;or<3;++or)Nr[or]=On[un.idx[or]],fr[or]=or<1?0:fr[or-1]+Ki*_n,wr[or]=new Float32Array(64),jr[or]=new Uint16Array(64),Xr[or]=new Uint16Array(64*Ki);for(let or=0;or<_n;++or){let eo=8;or==_n-1&&(eo=Tn);let Kr=8;for(let cr=0;cr<Ki;++cr){cr==Ki-1&&(Kr=yn);for(let Er=0;Er<3;++Er)jr[Er].fill(0),jr[Er][0]=xr[fr[Er]++],pt(qn,Fn,jr[Er]),vn=jr[Er],(wn=wr[Er])[0]=qt(vn[0]),wn[1]=qt(vn[1]),wn[2]=qt(vn[5]),wn[3]=qt(vn[6]),wn[4]=qt(vn[14]),wn[5]=qt(vn[15]),wn[6]=qt(vn[27]),wn[7]=qt(vn[28]),wn[8]=qt(vn[2]),wn[9]=qt(vn[4]),wn[10]=qt(vn[7]),wn[11]=qt(vn[13]),wn[12]=qt(vn[16]),wn[13]=qt(vn[26]),wn[14]=qt(vn[29]),wn[15]=qt(vn[42]),wn[16]=qt(vn[3]),wn[17]=qt(vn[8]),wn[18]=qt(vn[12]),wn[19]=qt(vn[17]),wn[20]=qt(vn[25]),wn[21]=qt(vn[30]),wn[22]=qt(vn[41]),wn[23]=qt(vn[43]),wn[24]=qt(vn[9]),wn[25]=qt(vn[11]),wn[26]=qt(vn[18]),wn[27]=qt(vn[24]),wn[28]=qt(vn[31]),wn[29]=qt(vn[40]),wn[30]=qt(vn[44]),wn[31]=qt(vn[53]),wn[32]=qt(vn[10]),wn[33]=qt(vn[19]),wn[34]=qt(vn[23]),wn[35]=qt(vn[32]),wn[36]=qt(vn[39]),wn[37]=qt(vn[45]),wn[38]=qt(vn[52]),wn[39]=qt(vn[54]),wn[40]=qt(vn[20]),wn[41]=qt(vn[22]),wn[42]=qt(vn[33]),wn[43]=qt(vn[38]),wn[44]=qt(vn[46]),wn[45]=qt(vn[51]),wn[46]=qt(vn[55]),wn[47]=qt(vn[60]),wn[48]=qt(vn[21]),wn[49]=qt(vn[34]),wn[50]=qt(vn[37]),wn[51]=qt(vn[47]),wn[52]=qt(vn[50]),wn[53]=qt(vn[56]),wn[54]=qt(vn[59]),wn[55]=qt(vn[61]),wn[56]=qt(vn[35]),wn[57]=qt(vn[36]),wn[58]=qt(vn[48]),wn[59]=qt(vn[49]),wn[60]=qt(vn[57]),wn[61]=qt(vn[58]),wn[62]=qt(vn[62]),wn[63]=qt(vn[63]),xt(wr[Er]);Tt(wr);for(let Er=0;Er<3;++Er)Pt(wr[Er],Xr[Er],64*cr)}let to=0;for(let cr=0;cr<3;++cr){const Er=fn[un.idx[cr]].type;for(let co=8*or;co<8*or+eo;++co){to=Nr[cr][co];for(let Uo=0;Uo<Fi;++Uo){const uo=64*Uo+8*(7&co);Rn.setUint16(to+0*Er,Xr[cr][uo+0],!0),Rn.setUint16(to+2*Er,Xr[cr][uo+1],!0),Rn.setUint16(to+4*Er,Xr[cr][uo+2],!0),Rn.setUint16(to+6*Er,Xr[cr][uo+3],!0),Rn.setUint16(to+8*Er,Xr[cr][uo+4],!0),Rn.setUint16(to+10*Er,Xr[cr][uo+5],!0),Rn.setUint16(to+12*Er,Xr[cr][uo+6],!0),Rn.setUint16(to+14*Er,Xr[cr][uo+7],!0),to+=16*Er}}if(Fi!=Ki)for(let co=8*or;co<8*or+eo;++co){const Uo=Nr[cr][co]+8*Fi*2*Er,uo=64*Fi+8*(7&co);for(let rs=0;rs<Kr;++rs)Rn.setUint16(Uo+2*rs*Er,Xr[cr][uo+rs],!0)}}}var vn,wn;const Zr=new Uint16Array(Un);Rn=new DataView(Zn.buffer);for(let or=0;or<3;++or){fn[un.idx[or]].decoded=!0;const eo=fn[un.idx[or]].type;if(fn[or].type==2)for(let Kr=0;Kr<Ai;++Kr){const to=Nr[or][Kr];for(let cr=0;cr<Un;++cr)Zr[cr]=Rn.getUint16(to+2*cr*eo,!0);for(let cr=0;cr<Un;++cr)Rn.setFloat32(to+2*cr*eo,qt(Zr[cr]),!0)}}})(hn,kn,dn,an,pn,vi);for(let un=0;un<dn.length;++un){const On=dn[un];if(!On.decoded){if(On.compression!==2)throw new Error("EXRLoader.parse: unsupported channel compression");{let fn=0,Fn=0;for(let xr=0;xr<jt.lines;++xr){let Zn=kn[un][fn];for(let Rn=0;Rn<On.width;++Rn){for(let Un=0;Un<2*On.type;++Un)vi[Zn++]=Yi[Fn+Un*On.width*On.height];Fn++}fn++}}}}return new DataView(vi.buffer)}function Jt(jt,Gt){const li=new Uint8Array(jt);let vi=0;for(;li[Gt.value+vi]!=0;)vi+=1;const xi=new TextDecoder().decode(li.slice(Gt.value,Gt.value+vi));return Gt.value=Gt.value+vi+1,xi}function Wt(jt,Gt){const li=jt.getInt32(Gt.value,!0);return Gt.value=Gt.value+4,li}function Zt(jt,Gt){const li=jt.getUint32(Gt.value,!0);return Gt.value=Gt.value+4,li}function ti(jt,Gt){const li=jt[Gt.value];return Gt.value=Gt.value+1,li}function ci(jt,Gt){const li=jt.getUint8(Gt.value);return Gt.value=Gt.value+1,li}const ri=function(jt,Gt){let li;return li="getBigInt64"in DataView.prototype?Number(jt.getBigInt64(Gt.value,!0)):jt.getUint32(Gt.value+4,!0)+Number(jt.getUint32(Gt.value,!0)<<32),Gt.value+=8,li};function Ct(jt,Gt){const li=jt.getFloat32(Gt.value,!0);return Gt.value+=4,li}function Ht(jt,Gt){return three_module.GxU.toHalfFloat(Ct(jt,Gt))}function qt(jt){const Gt=(31744&jt)>>10,li=1023&jt;return(jt>>15?-1:1)*(Gt?Gt===31?li?NaN:1/0:Math.pow(2,Gt-15)*(1+li/1024):li/1024*6103515625e-14)}function Li(jt,Gt){const li=jt.getUint16(Gt.value,!0);return Gt.value+=2,li}function Ui(jt,Gt){return qt(Li(jt,Gt))}function Xi(jt,Gt,li,vi,xi){return vi==="string"||vi==="stringvector"||vi==="iccProfile"?function(mi,Ri,Zi){const dn=new TextDecoder().decode(new Uint8Array(mi).slice(Ri.value,Ri.value+Zi));return Ri.value=Ri.value+Zi,dn}(Gt,li,xi):vi==="chlist"?function(mi,Ri,Zi,dn){const hn=Zi.value,an=[];for(;Zi.value<hn+dn-1;){const pn=Jt(Ri,Zi),Yi=Wt(mi,Zi),nn=ci(mi,Zi);Zi.value+=3;const kn=Wt(mi,Zi),un=Wt(mi,Zi);an.push({name:pn,pixelType:Yi,pLinear:nn,xSampling:kn,ySampling:un})}return Zi.value+=1,an}(jt,Gt,li,xi):vi==="chromaticities"?function(mi,Ri){return{redX:Ct(mi,Ri),redY:Ct(mi,Ri),greenX:Ct(mi,Ri),greenY:Ct(mi,Ri),blueX:Ct(mi,Ri),blueY:Ct(mi,Ri),whiteX:Ct(mi,Ri),whiteY:Ct(mi,Ri)}}(jt,li):vi==="compression"?function(mi,Ri){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][ci(mi,Ri)]}(jt,li):vi==="box2i"?function(mi,Ri){return{xMin:Zt(mi,Ri),yMin:Zt(mi,Ri),xMax:Zt(mi,Ri),yMax:Zt(mi,Ri)}}(jt,li):vi==="lineOrder"?function(mi,Ri){return["INCREASING_Y"][ci(mi,Ri)]}(jt,li):vi==="float"?Ct(jt,li):vi==="v2f"?function(mi,Ri){return[Ct(mi,Ri),Ct(mi,Ri)]}(jt,li):vi==="v3f"?function(mi,Ri){return[Ct(mi,Ri),Ct(mi,Ri),Ct(mi,Ri)]}(jt,li):vi==="int"?Wt(jt,li):vi==="rational"?function(mi,Ri){return[Wt(mi,Ri),Zt(mi,Ri)]}(jt,li):vi==="timecode"?function(mi,Ri){return[Zt(mi,Ri),Zt(mi,Ri)]}(jt,li):vi==="preview"?(li.value+=xi,"skipped"):void(li.value+=xi)}const An=new DataView(o),Ln=new Uint8Array(o),Nn={value:0},Kn=function(jt,Gt,li){const vi={};if(jt.getUint32(0,!0)!=20000630)throw new Error("THREE.EXRLoader: Provided file doesn't appear to be in OpenEXR format.");vi.version=jt.getUint8(4);const xi=jt.getUint8(5);vi.spec={singleTile:!!(2&xi),longName:!!(4&xi),deepFormat:!!(8&xi),multiPart:!!(16&xi)},li.value=8;let mi=!0;for(;mi;){const Ri=Jt(Gt,li);if(Ri==0)mi=!1;else{const Zi=Jt(Gt,li),dn=Xi(jt,Gt,li,Zi,Zt(jt,li));dn===void 0?console.warn(`THREE.EXRLoader: Skipped unknown header attribute type '${Zi}'.`):vi[Ri]=dn}}if(-5&xi)throw console.error("THREE.EXRHeader:",vi),new Error("THREE.EXRLoader: Provided file is currently unsupported.");return vi}(An,o,Nn),_i=function(jt,Gt,li,vi,xi){const mi={size:0,viewer:Gt,array:li,offset:vi,width:jt.dataWindow.xMax-jt.dataWindow.xMin+1,height:jt.dataWindow.yMax-jt.dataWindow.yMin+1,channels:jt.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:jt.channels[0].pixelType,uncompress:null,getter:null,format:null,colorSpace:three_module.Zr2};switch(jt.compression){case"NO_COMPRESSION":mi.lines=1,mi.uncompress=Lt;break;case"RLE_COMPRESSION":mi.lines=1,mi.uncompress=Bt;break;case"ZIPS_COMPRESSION":mi.lines=1,mi.uncompress=Ut;break;case"ZIP_COMPRESSION":mi.lines=16,mi.uncompress=Ut;break;case"PIZ_COMPRESSION":mi.lines=32,mi.uncompress=kt;break;case"PXR24_COMPRESSION":mi.lines=16,mi.uncompress=Vt;break;case"DWAA_COMPRESSION":mi.lines=32,mi.uncompress=si;break;case"DWAB_COMPRESSION":mi.lines=256,mi.uncompress=si;break;default:throw new Error("EXRLoader.parse: "+jt.compression+" is unsupported")}if(mi.scanlineBlockSize=mi.lines,mi.type==1)switch(xi){case three_module.RQf:mi.getter=Ui,mi.inputSize=2;break;case three_module.ix0:mi.getter=Li,mi.inputSize=2}else{if(mi.type!=2)throw new Error("EXRLoader.parse: unsupported pixelType "+mi.type+" for "+jt.compression+".");switch(xi){case three_module.RQf:mi.getter=Ct,mi.inputSize=4;break;case three_module.ix0:mi.getter=Ht,mi.inputSize=4}}mi.blockCount=(jt.dataWindow.yMax+1)/mi.scanlineBlockSize;for(let Zi=0;Zi<mi.blockCount;Zi++)ri(Gt,vi);mi.outputChannels=mi.channels==3?4:mi.channels;const Ri=mi.width*mi.height*mi.outputChannels;switch(xi){case three_module.RQf:mi.byteArray=new Float32Array(Ri),mi.channels<mi.outputChannels&&mi.byteArray.fill(1,0,Ri);break;case three_module.ix0:mi.byteArray=new Uint16Array(Ri),mi.channels<mi.outputChannels&&mi.byteArray.fill(15360,0,Ri);break;default:console.error("THREE.EXRLoader: unsupported type: ",xi)}return mi.bytesPerLine=mi.width*mi.inputSize*mi.channels,mi.outputChannels==4?(mi.format=three_module.GWd,mi.colorSpace=three_module.Zr2):(mi.format=three_module.VT0,mi.colorSpace=three_module.jf0),mi}(Kn,An,Ln,Nn,this.type),Gi={value:0},sn={R:0,G:1,B:2,A:3,Y:0};for(let jt=0;jt<_i.height/_i.scanlineBlockSize;jt++){const Gt=Zt(An,Nn);_i.size=Zt(An,Nn),_i.lines=Gt+_i.scanlineBlockSize>_i.height?_i.height-Gt:_i.scanlineBlockSize;const li=_i.size<_i.lines*_i.bytesPerLine?_i.uncompress(_i):Lt(_i);Nn.value+=_i.size;for(let vi=0;vi<_i.scanlineBlockSize;vi++){const xi=vi+jt*_i.scanlineBlockSize;if(xi>=_i.height)break;for(let mi=0;mi<_i.channels;mi++){const Ri=sn[Kn.channels[mi].name];for(let Zi=0;Zi<_i.width;Zi++){Gi.value=(vi*(_i.channels*_i.width)+mi*_i.width+Zi)*_i.inputSize;const dn=(_i.height-1-xi)*(_i.width*_i.outputChannels)+Zi*_i.outputChannels+Ri;_i.byteArray[dn]=_i.getter(li,Gi)}}}}return{header:Kn,width:_i.width,height:_i.height,data:_i.byteArray,format:_i.format,colorSpace:_i.colorSpace,type:this.type}}setDataType(o){return this.type=o,this}load(o,l,c,u){return super.load(o,function(h,_){h.colorSpace=_.colorSpace,h.minFilter=three_module.k6q,h.magFilter=three_module.k6q,h.generateMipmaps=!1,h.flipY=!1,l&&l(h,_)},c,u)}}class EXRLoadPlugin extends I{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin]}async onAdded(o){var l,c;this._importer||(this._importer=new Importer(class extends EXRLoader{constructor(u){super(u),this.setDataType(getTextureDataType(o.renderer.rendererObject))}},["exr"],!1)),(c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0||c.Importers.push(this._importer)}async onDispose(o){this._importer=void 0}async onRemove(o){var l,c;this._importer&&(!((c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0)&&c.Importers)&&o.getManager().importer.Importers.splice(o.getManager().importer.Importers.indexOf(this._importer),1),this._importer=void 0}}EXRLoadPlugin.PluginType="EXRLoadPlugin";const _3DMLoader_taskCache=new WeakMap;class Rhino3dmLoader extends three_module.aHM{constructor(o){super(o),this.libraryPath="",this.libraryPending=null,this.libraryBinary=null,this.libraryConfig={},this.url="",this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig={},this.materials=[],this.warnings=[]}setLibraryPath(o){return this.libraryPath=o,this}setWorkerLimit(o){return this.workerLimit=o,this}load(o,l,c,u){const h=new three_module.Y9S(this.manager);h.setPath(this.path),h.setResponseType("arraybuffer"),h.setRequestHeader(this.requestHeader),this.url=o,h.load(o,_=>{if(_3DMLoader_taskCache.has(_))return _3DMLoader_taskCache.get(_).promise.then(l).catch(u);this.decodeObjects(_,o).then(A=>{A.userData.warnings=this.warnings,this.warnings=[],l(A)}).catch(A=>u(A))},c,u)}debug(){console.log("Task load: ",this.workerPool.map(o=>o._taskLoad))}decodeObjects(o,l){let c,u;const h=o.byteLength,_=this._getWorker(h).then(A=>(c=A,u=this.workerNextTaskID++,new Promise((w,C)=>{c._callbacks[u]={resolve:w,reject:C},c.postMessage({type:"decode",id:u,buffer:o},[o])}))).then(A=>this._createGeometry(A.data)).catch(A=>{throw A});return _.catch(()=>!0).then(()=>{c&&u&&this._releaseTask(c,u)}),_3DMLoader_taskCache.set(o,{url:l,promise:_}),_}parse(o,l,c){this.decodeObjects(o,"").then(u=>{u.userData.warnings=this.warnings,l(u)}).catch(u=>c(u))}_compareMaterials(o){if(this.materials.includes(o))return o;const l={};l.name=o.name,l.color={},l.color.r=o.color.r,l.color.g=o.color.g,l.color.b=o.color.b,l.type=o.type,l.vertexColors=o.vertexColors;const c=JSON.stringify(l);for(let u=0;u<this.materials.length;u++){const h=this.materials[u],_={};if(_.name=h.name,_.color={},_.color.r=h.color.r,_.color.g=h.color.g,_.color.b=h.color.b,_.type=h.type,_.vertexColors=h.vertexColors,JSON.stringify(_)===c)return h}return this.materials.push(o),o}_createMaterial(o,l){if(o===void 0)return new three_module._4j({color:new three_module.Q1f(1,1,1),metalness:.8,name:three_module.aHM.DEFAULT_MATERIAL_NAME,side:three_module.$EB});const c=new three_module.uSd({color:new three_module.Q1f(o.diffuseColor.r/255,o.diffuseColor.g/255,o.diffuseColor.b/255),emissive:new three_module.Q1f(o.emissionColor.r,o.emissionColor.g,o.emissionColor.b),flatShading:o.disableLighting,ior:o.indexOfRefraction,name:o.name,reflectivity:o.reflectivity,opacity:1-o.transparency,side:three_module.$EB,specularColor:o.specularColor,transparent:o.transparency>0});if(c.userData.id=o.id,o.pbrSupported){const h=o.pbr;c.anisotropy=h.anisotropic,c.anisotropyRotation=h.anisotropicRotation,c.color=new three_module.Q1f(h.baseColor.r,h.baseColor.g,h.baseColor.b),c.clearcoat=h.clearcoat,c.clearcoatRoughness=h.clearcoatRoughness,c.metalness=h.metallic,c.transmission=1-h.opacity,c.roughness=h.roughness,c.sheen=h.sheen,c.specularIntensity=h.specular,c.thickness=h.subsurface}o.pbrSupported&&o.pbr.opacity===0&&o.transparency===1&&(c.opacity=.2,c.transmission=1);const u=new three_module.Tap;for(let h=0;h<o.textures.length;h++){const _=o.textures[h];if(_.image!==null){const A=u.load(_.image);switch(_.type){case"Bump":c.bumpMap=A;break;case"Diffuse":case"PBR_BaseColor":c.map=A;break;case"Emap":c.envMap=A;break;case"Opacity":c.transmissionMap=A;break;case"Transparency":case"PBR_Alpha":c.alphaMap=A,c.transparent=!0;break;case"PBR_AmbientOcclusion":c.aoMap=A;break;case"PBR_Anisotropic":c.anisotropyMap=A;break;case"PBR_Clearcoat":c.clearcoatMap=A;break;case"PBR_ClearcoatBump":c.clearcoatNormalMap=A;break;case"PBR_ClearcoatRoughness":c.clearcoatRoughnessMap=A;break;case"PBR_Displacement":c.displacementMap=A;break;case"PBR_Emission":c.emissiveMap=A;break;case"PBR_Metallic":c.metalnessMap=A;break;case"PBR_Roughness":c.roughnessMap=A;break;case"PBR_Sheen":c.sheenColorMap=A;break;case"PBR_Specular":c.specularColorMap=A;break;case"PBR_Subsurface":c.thicknessMap=A;break;default:this.warnings.push({message:`THREE.3DMLoader: No conversion exists for 3dm ${_.type}.`,type:"no conversion"})}A.wrapS=_.wrapU===0?three_module.GJx:three_module.ghU,A.wrapT=_.wrapV===0?three_module.GJx:three_module.ghU,_.repeat&&A.repeat.set(_.repeat[0],_.repeat[1])}}return l&&new EXRLoader().load(l.image,function(h){h.mapping=THREE.EquirectangularReflectionMapping,c.envMap=h}),c}_createGeometry(o){const l=new three_module.B69,c=[],u=[],h=[];l.userData.layers=o.layers,l.userData.groups=o.groups,l.userData.settings=o.settings,l.userData.settings.renderSettings=o.renderSettings,l.userData.strings=o.strings,l.userData.objectType="File3dm",l.userData.materials=null,l.name=this.url;let _=o.objects;const A=o.materials;for(let w=0;w<_.length;w++){const C=_[w],M=C.attributes;switch(C.objectType){case"InstanceDefinition":u.push(C);break;case"InstanceReference":h.push(C);break;default:let O,ne=null;switch(M.materialSource.name){case"ObjectMaterialSource_MaterialFromLayer":M.layerIndex>=0&&(ne=o.layers[M.layerIndex].renderMaterialIndex);break;case"ObjectMaterialSource_MaterialFromObject":ne=M.materialIndex>=0?M.materialIndex:null}if(ne>=0){const ye=A[ne];O=this._createMaterial(ye,o.renderEnvironment)}else O=this._createMaterial();O=this._compareMaterials(O);const ce=this._createObject(C,O);if(ce===void 0)continue;const ue=o.layers[M.layerIndex];ce.visible=!ue||ue.visible,M.isInstanceDefinitionObject?c.push(ce):l.add(ce)}}for(let w=0;w<u.length;w++){const C=u[w];_=[];for(let M=0;M<C.attributes.objectIds.length;M++){const O=C.attributes.objectIds[M];for(let ne=0;ne<c.length;ne++)O===c[ne].userData.attributes.id&&_.push(c[ne])}for(let M=0;M<h.length;M++){const O=h[M];if(O.geometry.parentIdefId===C.attributes.id){const ne=O.geometry.xform.array,ce=new three_module.kn4;if(ce.set(...ne),_.length===1){const ue=_[0].clone(!0);if(ue.name=O.attributes.name||ue.name,ue.applyMatrix4(ce),O.attributes.materialIndex>=0&&O.attributes.materialIndex!==_[0].userData.attributes.materialIndex){const ye=A[O.attributes.materialIndex],Oe=this._createMaterial(ye);ue.material=this._compareMaterials(Oe)}if(ue.userData.defAttributes=ue.userData.attributes,ue.userData.defObjectType=ue.userData.objectType,ue.userData.attributes={...ue.userData.attributes,...O.attributes},ue.userData.objectType=O.objectType,O.attributes.layerIndex!==void 0){const ye=o.layers[O.attributes.layerIndex];ue.visible=ye?ye.visible:ue.visible}l.add(ue)}else{console.warn("THREE.Rhino3dmLoader: InstanceReference with multiple/no objects, not all properties will be copied.");const ue=new three_module.B69;ue.applyMatrix4(ce);for(let ye=0;ye<_.length;ye++)ue.add(_[ye].clone(!0));l.add(ue)}}}}return l.userData.materials=this.materials,l.name="",l}_createObject(o,l){const c=new three_module.SUR,u=o.attributes;let h,_,A,w;switch(o.objectType){case"Point":case"PointSet":h=c.parse(o.geometry),h.attributes.hasOwnProperty("color")?_=new three_module.BH$({vertexColors:!0,sizeAttenuation:!1,size:2}):(A=u.drawColor,w=new three_module.Q1f(A.r/255,A.g/255,A.b/255),_=new three_module.BH$({color:w,sizeAttenuation:!1,size:2})),_=this._compareMaterials(_);const C=new three_module.ONl(h,_);return C.userData.attributes=u,C.userData.objectType=o.objectType,u.name&&(C.name=u.name),C;case"Mesh":case"Extrusion":case"SubD":case"Brep":if(o.geometry===null)return;h=c.parse(o.geometry),l===null&&(l=this._createMaterial(),l=this._compareMaterials(l)),h.attributes.hasOwnProperty("color")&&(l.vertexColors=!0);const M=new three_module.eaF(h,l);return M.castShadow=u.castsShadows,M.receiveShadow=u.receivesShadows,M.userData.attributes=u,M.userData.objectType=o.objectType,u.name&&(M.name=u.name,h.name=u.name),M;case"Curve":h=c.parse(o.geometry),A=u.drawColor,w=new three_module.Q1f(A.r/255,A.g/255,A.b/255),_=new three_module.mrM({color:w}),_=this._compareMaterials(_);const O=new three_module.N1A(h,_);return O.userData.attributes=u,O.userData.objectType=o.objectType,u.name&&(O.name=u.name),O;case"TextDot":h=o.geometry;const ne=document.createElement("canvas").getContext("2d"),ce=`${h.fontHeight}px ${h.fontFace}`;ne.font=ce;const ue=ne.measureText(h.text).width+10,ye=h.fontHeight+10,Oe=window.devicePixelRatio;ne.canvas.width=ue*Oe,ne.canvas.height=ye*Oe,ne.canvas.style.width=ue+"px",ne.canvas.style.height=ye+"px",ne.setTransform(Oe,0,0,Oe,0,0),ne.font=ce,ne.textBaseline="middle",ne.textAlign="center",w=u.drawColor,ne.fillStyle=`rgba(${w.r},${w.g},${w.b},${w.a})`,ne.fillRect(0,0,ue,ye),ne.fillStyle="white",ne.fillText(h.text,ue/2,ye/2);const ke=new three_module.GOR(ne.canvas);ke.minFilter=three_module.k6q,ke.generateMipmaps=!1,ke.wrapS=three_module.ghU,ke.wrapT=three_module.ghU,_=new three_module.RoJ({map:ke,depthTest:!1});const Ve=new three_module.kxk(_);return Ve.position.set(h.point[0],h.point[1],h.point[2]),Ve.scale.set(ue/10,ye/10,1),Ve.userData.attributes=u,Ve.userData.objectType=o.objectType,u.name&&(Ve.name=u.name),Ve;case"Light":let tt;switch(h=o.geometry,h.lightStyle.name){case"LightStyle_WorldPoint":tt=new three_module.HiM,tt.castShadow=u.castsShadows,tt.position.set(h.location[0],h.location[1],h.location[2]),tt.shadow.normalBias=.1;break;case"LightStyle_WorldSpot":tt=new three_module.nCl,tt.castShadow=u.castsShadows,tt.position.set(h.location[0],h.location[1],h.location[2]),tt.target.position.set(h.direction[0],h.direction[1],h.direction[2]),tt.angle=h.spotAngleRadians,tt.shadow.normalBias=.1;break;case"LightStyle_WorldRectangular":tt=new three_module.ure;const ht=Math.abs(h.width[2]),ut=Math.abs(h.length[0]);tt.position.set(h.location[0]-ut/2,h.location[1],h.location[2]-ht/2),tt.height=ut,tt.width=ht,tt.lookAt(h.direction[0],h.direction[1],h.direction[2]);break;case"LightStyle_WorldDirectional":tt=new three_module.ZyN,tt.castShadow=u.castsShadows,tt.position.set(h.location[0],h.location[1],h.location[2]),tt.target.position.set(h.direction[0],h.direction[1],h.direction[2]),tt.shadow.normalBias=.1}return tt&&(tt.intensity=h.intensity,A=h.diffuse,w=new three_module.Q1f(A.r/255,A.g/255,A.b/255),tt.color=w,tt.userData.attributes=u,tt.userData.objectType=o.objectType),tt}}_initLibrary(){if(!this.libraryPending){const o=new three_module.Y9S(this.manager);o.setPath(this.libraryPath);const l=new Promise((h,_)=>{o.load("rhino3dm.js",h,void 0,_)}),c=new three_module.Y9S(this.manager);c.setPath(this.libraryPath),c.setResponseType("arraybuffer");const u=new Promise((h,_)=>{c.load("rhino3dm.wasm",h,void 0,_)});this.libraryPending=Promise.all([l,u]).then(([h,_])=>{this.libraryConfig.wasmBinary=_;const A=DRACOWorkerStr,w=["/* rhino3dm.js */",h,"/* worker */",A.substring(A.indexOf("{")+1,A.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([w]))})}return this.libraryPending}_getWorker(o){return this._initLibrary().then(()=>{if(this.workerPool.length<this.workerLimit){const c=new Worker(this.workerSourceURL);c._callbacks={},c._taskCosts={},c._taskLoad=0,c.postMessage({type:"init",libraryConfig:this.libraryConfig}),c.onmessage=u=>{const h=u.data;switch(h.type){case"warning":this.warnings.push(h.data),console.warn(h.data);break;case"decode":c._callbacks[h.id].resolve(h);break;case"error":c._callbacks[h.id].reject(h);break;default:console.error('THREE.Rhino3dmLoader: Unexpected message, "'+h.type+'"')}},this.workerPool.push(c)}else this.workerPool.sort(function(c,u){return c._taskLoad>u._taskLoad?-1:1});const l=this.workerPool[this.workerPool.length-1];return l._taskLoad+=o,l})}_releaseTask(o,l){o._taskLoad-=o._taskCosts[l],delete o._callbacks[l],delete o._taskCosts[l]}dispose(){for(let o=0;o<this.workerPool.length;++o)this.workerPool[o].terminate();return this.workerPool.length=0,this}}const DRACOWorkerStr=`
function Rhino3dmWorker() {

	let libraryPending;
	let libraryConfig;
	let rhino;
	let taskID;

	onmessage = function ( e ) {

		const message = e.data;

		switch ( message.type ) {

			case 'init':

				libraryConfig = message.libraryConfig;
				const wasmBinary = libraryConfig.wasmBinary;
				let RhinoModule;
				libraryPending = new Promise( function ( resolve ) {

					/* Like Basis Loader */
					RhinoModule = { wasmBinary, onRuntimeInitialized: resolve };

					rhino3dm( RhinoModule ); // eslint-disable-line no-undef

				 } ).then( () => {

					rhino = RhinoModule;

				 } );

				break;

			case 'decode':

				taskID = message.id;
				const buffer = message.buffer;
				libraryPending.then( () => {

					try {

						const data = decodeObjects( rhino, buffer );
						self.postMessage( { type: 'decode', id: message.id, data } );

					} catch ( error ) {

						self.postMessage( { type: 'error', id: message.id, error } );

					}

				} );

				break;

		}

	};

	function decodeObjects( rhino, buffer ) {

		const arr = new Uint8Array( buffer );
		const doc = rhino.File3dm.fromByteArray( arr );

		const objects = [];
		const materials = [];
		const layers = [];
		const views = [];
		const namedViews = [];
		const groups = [];
		const strings = [];

		//Handle objects

		const objs = doc.objects();
		const cnt = objs.count;

		for ( let i = 0; i < cnt; i ++ ) {

			const _object = objs.get( i );

			const object = extractObjectData( _object, doc );

			_object.delete();

			if ( object ) {

				objects.push( object );

			}

		}

		// Handle instance definitions
		// console.log( \`Instance Definitions Count: \${doc.instanceDefinitions().count()}\` );

		for ( let i = 0; i < doc.instanceDefinitions().count; i ++ ) {

			const idef = doc.instanceDefinitions().get( i );
			const idefAttributes = extractProperties( idef );
			idefAttributes.objectIds = idef.getObjectIds();

			objects.push( { geometry: null, attributes: idefAttributes, objectType: 'InstanceDefinition' } );

		}

		// Handle materials

		const textureTypes = [
			// rhino.TextureType.Bitmap,
			rhino.TextureType.Diffuse,
			rhino.TextureType.Bump,
			rhino.TextureType.Transparency,
			rhino.TextureType.Opacity,
			rhino.TextureType.Emap
		];

		const pbrTextureTypes = [
			rhino.TextureType.PBR_BaseColor,
			rhino.TextureType.PBR_Subsurface,
			rhino.TextureType.PBR_SubsurfaceScattering,
			rhino.TextureType.PBR_SubsurfaceScatteringRadius,
			rhino.TextureType.PBR_Metallic,
			rhino.TextureType.PBR_Specular,
			rhino.TextureType.PBR_SpecularTint,
			rhino.TextureType.PBR_Roughness,
			rhino.TextureType.PBR_Anisotropic,
			rhino.TextureType.PBR_Anisotropic_Rotation,
			rhino.TextureType.PBR_Sheen,
			rhino.TextureType.PBR_SheenTint,
			rhino.TextureType.PBR_Clearcoat,
			rhino.TextureType.PBR_ClearcoatBump,
			rhino.TextureType.PBR_ClearcoatRoughness,
			rhino.TextureType.PBR_OpacityIor,
			rhino.TextureType.PBR_OpacityRoughness,
			rhino.TextureType.PBR_Emission,
			rhino.TextureType.PBR_AmbientOcclusion,
			rhino.TextureType.PBR_Displacement
		];

		for ( let i = 0; i < doc.materials().count; i ++ ) {

			const _material = doc.materials().get( i );

			let material = extractProperties( _material );

			const textures = [];

			textures.push( ...extractTextures( _material, textureTypes, doc ) );

			material.pbrSupported = _material.physicallyBased().supported;

			if ( material.pbrSupported ) {

				textures.push( ...extractTextures( _material, pbrTextureTypes, doc ) );
				material.pbr = extractProperties( _material.physicallyBased() );

			}

			material.textures = textures;

			materials.push( material );

			_material.delete();

		}

		// Handle layers

		for ( let i = 0; i < doc.layers().count; i ++ ) {

			const _layer = doc.layers().get( i );
			const layer = extractProperties( _layer );

			layers.push( layer );

			_layer.delete();

		}

		// Handle views

		for ( let i = 0; i < doc.views().count; i ++ ) {

			const _view = doc.views().get( i );
			const view = extractProperties( _view );

			views.push( view );

			_view.delete();

		}

		// Handle named views

		for ( let i = 0; i < doc.namedViews().count; i ++ ) {

			const _namedView = doc.namedViews().get( i );
			const namedView = extractProperties( _namedView );

			namedViews.push( namedView );

			_namedView.delete();

		}

		// Handle groups

		for ( let i = 0; i < doc.groups().count; i ++ ) {

			const _group = doc.groups().get( i );
			const group = extractProperties( _group );

			groups.push( group );

			_group.delete();

		}

		// Handle settings

		const settings = extractProperties( doc.settings() );

		//TODO: Handle other document stuff like dimstyles, instance definitions, bitmaps etc.

		// Handle dimstyles
		// console.log( \`Dimstyle Count: \${doc.dimstyles().count()}\` );

		// Handle bitmaps
		// console.log( \`Bitmap Count: \${doc.bitmaps().count()}\` );

		// Handle strings
		// console.log( \`Document Strings Count: \${doc.strings().count()}\` );
		// Note: doc.strings().documentUserTextCount() counts any doc.strings defined in a section
		// console.log( \`Document User Text Count: \${doc.strings().documentUserTextCount()}\` );

		const strings_count = doc.strings().count;

		for ( let i = 0; i < strings_count; i ++ ) {

			strings.push( doc.strings().get( i ) );

		}

		// Handle Render Environments for Material Environment

		// get the id of the active render environment skylight, which we'll use for environment texture
		const reflectionId = doc.settings().renderSettings().renderEnvironments.reflectionId;

		const rc = doc.renderContent();

		let renderEnvironment = null;

		for( let i = 0; i < rc.count; i++ ) {

			const content = rc.get(i);

			switch( content.kind ) {

				case 'environment':

					const id = content.id;

					// there could be multiple render environments in a 3dm file
					if ( id !== reflectionId ) break;

					const renderTexture = content.findChild( 'texture' );
					const fileName = renderTexture.fileName;

					for ( let j = 0; j < doc.embeddedFiles().count; j ++ ) {

						const _fileName = doc.embeddedFiles().get( j ).fileName;

						if ( fileName === _fileName ) {

							const background = doc.getEmbeddedFileAsBase64( fileName );
							const backgroundImage = 'data:image/png;base64,' + background;
							renderEnvironment = { type: 'renderEnvironment', image: backgroundImage, name: fileName };

						}

					}

					break;

			}

		}

		// Handle Render Settings

		const renderSettings = {
			ambientLight: doc.settings().renderSettings().ambientLight,
			backgroundColorTop: doc.settings().renderSettings().backgroundColorTop,
			backgroundColorBottom: doc.settings().renderSettings().backgroundColorBottom,
			useHiddenLights: doc.settings().renderSettings().useHiddenLights,
			depthCue: doc.settings().renderSettings().depthCue,
			flatShade: doc.settings().renderSettings().flatShade,
			renderBackFaces: doc.settings().renderSettings().renderBackFaces,
			renderPoints: doc.settings().renderSettings().renderPoints,
			renderCurves: doc.settings().renderSettings().renderCurves,
			renderIsoParams: doc.settings().renderSettings().renderIsoParams,
			renderMeshEdges: doc.settings().renderSettings().renderMeshEdges,
			renderAnnotations: doc.settings().renderSettings().renderAnnotations,
			useViewportSize: doc.settings().renderSettings().useViewportSize,
			scaleBackgroundToFit: doc.settings().renderSettings().scaleBackgroundToFit,
			transparentBackground: doc.settings().renderSettings().transparentBackground,
			imageDpi: doc.settings().renderSettings().imageDpi,
			shadowMapLevel: doc.settings().renderSettings().shadowMapLevel,
			namedView: doc.settings().renderSettings().namedView,
			snapShot: doc.settings().renderSettings().snapShot,
			specificViewport: doc.settings().renderSettings().specificViewport,
			groundPlane: extractProperties( doc.settings().renderSettings().groundPlane ),
			safeFrame: extractProperties( doc.settings().renderSettings().safeFrame ),
			dithering: extractProperties( doc.settings().renderSettings().dithering ),
			skylight: extractProperties( doc.settings().renderSettings().skylight ),
			linearWorkflow: extractProperties( doc.settings().renderSettings().linearWorkflow ),
			renderChannels: extractProperties( doc.settings().renderSettings().renderChannels ),
			sun: extractProperties( doc.settings().renderSettings().sun ),
			renderEnvironments: extractProperties( doc.settings().renderSettings().renderEnvironments ),
			postEffects: extractProperties( doc.settings().renderSettings().postEffects ),

		};

		doc.delete();

		return { objects, materials, layers, views, namedViews, groups, strings, settings, renderSettings, renderEnvironment };

	}

	function extractTextures( m, tTypes, d ) {

		const textures = [];

		for ( let i = 0; i < tTypes.length; i ++ ) {

			const _texture = m.getTexture( tTypes[ i ] );
			if ( _texture ) {

				let textureType = tTypes[ i ].constructor.name;
				textureType = textureType.substring( 12, textureType.length );
				const texture = extractTextureData( _texture, textureType, d );
				textures.push( texture );
				_texture.delete();

			}

		}

		return textures;

	}

	function extractTextureData( t, tType, d ) {

		const texture = { type: tType };

		const image = d.getEmbeddedFileAsBase64( t.fileName );

		texture.wrapU = t.wrapU;
		texture.wrapV = t.wrapV;
		texture.wrapW = t.wrapW;
		const uvw = t.uvwTransform.toFloatArray( true );

		texture.repeat = [ uvw[ 0 ], uvw[ 5 ] ];

		if ( image ) {

			texture.image = 'data:image/png;base64,' + image;

		} else {

			self.postMessage( { type: 'warning', id: taskID, data: {
				message: \`THREE.3DMLoader: Image for \${tType} texture not embedded in file.\`,
				type: 'missing resource'
			}

			} );

			texture.image = null;

		}

		return texture;

	}

	function extractObjectData( object, doc ) {

		const _geometry = object.geometry();
		const _attributes = object.attributes();
		let objectType = _geometry.objectType;
		let geometry, attributes, position, data, mesh;

		// skip instance definition objects
		//if( _attributes.isInstanceDefinitionObject ) { continue; }

		// TODO: handle other geometry types
		switch ( objectType ) {

			case rhino.ObjectType.Curve:

				const pts = curveToPoints( _geometry, 100 );

				position = {};
				attributes = {};
				data = {};

				position.itemSize = 3;
				position.type = 'Float32Array';
				position.array = [];

				for ( let j = 0; j < pts.length; j ++ ) {

					position.array.push( pts[ j ][ 0 ] );
					position.array.push( pts[ j ][ 1 ] );
					position.array.push( pts[ j ][ 2 ] );

				}

				attributes.position = position;
				data.attributes = attributes;

				geometry = { data };

				break;

			case rhino.ObjectType.Point:

				const pt = _geometry.location;

				position = {};
				const color = {};
				attributes = {};
				data = {};

				position.itemSize = 3;
				position.type = 'Float32Array';
				position.array = [ pt[ 0 ], pt[ 1 ], pt[ 2 ] ];

				const _color = _attributes.drawColor( doc );

				color.itemSize = 3;
				color.type = 'Float32Array';
				color.array = [ _color.r / 255.0, _color.g / 255.0, _color.b / 255.0 ];

				attributes.position = position;
				attributes.color = color;
				data.attributes = attributes;

				geometry = { data };

				break;

			case rhino.ObjectType.PointSet:
			case rhino.ObjectType.Mesh:

				geometry = _geometry.toThreejsJSON();

				break;

			case rhino.ObjectType.Brep:

				const faces = _geometry.faces();
				mesh = new rhino.Mesh();

				for ( let faceIndex = 0; faceIndex < faces.count; faceIndex ++ ) {

					const face = faces.get( faceIndex );
					const _mesh = face.getMesh( rhino.MeshType.Any );

					if ( _mesh ) {

						mesh.append( _mesh );
						_mesh.delete();

					}

					face.delete();

				}

				if ( mesh.faces().count > 0 ) {

					mesh.compact();
					geometry = mesh.toThreejsJSON();
					faces.delete();

				}

				mesh.delete();

				break;

			case rhino.ObjectType.Extrusion:

				mesh = _geometry.getMesh( rhino.MeshType.Any );

				if ( mesh ) {

					geometry = mesh.toThreejsJSON();
					mesh.delete();

				}

				break;

			case rhino.ObjectType.TextDot:

				geometry = extractProperties( _geometry );

				break;

			case rhino.ObjectType.Light:

				geometry = extractProperties( _geometry );

				if ( geometry.lightStyle.name === 'LightStyle_WorldLinear' ) {

					self.postMessage( { type: 'warning', id: taskID, data: {
						message: \`THREE.3DMLoader: No conversion exists for \${objectType.constructor.name} \${geometry.lightStyle.name}\`,
						type: 'no conversion',
						guid: _attributes.id
					}

					} );

				}

				break;

			case rhino.ObjectType.InstanceReference:

				geometry = extractProperties( _geometry );
				geometry.xform = extractProperties( _geometry.xform );
				geometry.xform.array = _geometry.xform.toFloatArray( true );

				break;

			case rhino.ObjectType.SubD:

				// TODO: precalculate resulting vertices and faces and warn on excessive results
				_geometry.subdivide( 3 );
				mesh = rhino.Mesh.createFromSubDControlNet( _geometry, false );
				if ( mesh ) {

					geometry = mesh.toThreejsJSON();
					mesh.delete();

				}

				break;

				/*
				case rhino.ObjectType.Annotation:
				case rhino.ObjectType.Hatch:
				case rhino.ObjectType.ClipPlane:
				*/

			default:

				self.postMessage( { type: 'warning', id: taskID, data: {
					message: \`THREE.3DMLoader: Conversion not implemented for \${objectType.constructor.name}\`,
					type: 'not implemented',
					guid: _attributes.id
				}

				} );

				break;

		}

		if ( geometry ) {

			attributes = extractProperties( _attributes );
			attributes.geometry = extractProperties( _geometry );

			if ( _attributes.groupCount > 0 ) {

				attributes.groupIds = _attributes.getGroupList();

			}

			if ( _attributes.userStringCount > 0 ) {

				attributes.userStrings = _attributes.getUserStrings();

			}

			if ( _geometry.userStringCount > 0 ) {

				attributes.geometry.userStrings = _geometry.getUserStrings();

			}

			if ( _attributes.decals().count > 0 ) {

				self.postMessage( { type: 'warning', id: taskID, data: {
					message: \`THREE.3DMLoader: No conversion exists for the decals associated with this object.\`,
					type: 'no conversion',
					guid: _attributes.id
				}

				} );

			}

			attributes.drawColor = _attributes.drawColor( doc );

			objectType = objectType.constructor.name;
			objectType = objectType.substring( 11, objectType.length );

			return { geometry, attributes, objectType };

		} else {

			self.postMessage( { type: 'warning', id: taskID, data: {
				message: \`THREE.3DMLoader: \${objectType.constructor.name} has no associated mesh geometry.\`,
				type: 'missing mesh',
				guid: _attributes.id
			}

			} );

		}

	}

	function extractProperties( object ) {

		const result = {};

		for ( const property in object ) {

			const value = object[ property ];

			if ( typeof value !== 'function' ) {

				if ( typeof value === 'object' && value !== null && value.hasOwnProperty( 'constructor' ) ) {

					result[ property ] = { name: value.constructor.name, value: value.value };

				} else if ( typeof value === 'object' && value !== null ) {

					result[ property ] = extractProperties( value );

				} else {

					result[ property ] = value;

				}

			} else {

				// these are functions that could be called to extract more data.
				//console.log( \`\${property}: \${object[ property ].constructor.name}\` );

			}

		}

		return result;

	}

	function curveToPoints( curve, pointLimit ) {

		let pointCount = pointLimit;
		let rc = [];
		const ts = [];

		if ( curve instanceof rhino.LineCurve ) {

			return [ curve.pointAtStart, curve.pointAtEnd ];

		}

		if ( curve instanceof rhino.PolylineCurve ) {

			pointCount = curve.pointCount;
			for ( let i = 0; i < pointCount; i ++ ) {

				rc.push( curve.point( i ) );

			}

			return rc;

		}

		if ( curve instanceof rhino.PolyCurve ) {

			const segmentCount = curve.segmentCount;

			for ( let i = 0; i < segmentCount; i ++ ) {

				const segment = curve.segmentCurve( i );
				const segmentArray = curveToPoints( segment, pointCount );
				rc = rc.concat( segmentArray );
				segment.delete();

			}

			return rc;

		}

		if ( curve instanceof rhino.ArcCurve ) {

			pointCount = Math.floor( curve.angleDegrees / 5 );
			pointCount = pointCount < 2 ? 2 : pointCount;
			// alternative to this hardcoded version: https://stackoverflow.com/a/18499923/2179399

		}

		if ( curve instanceof rhino.NurbsCurve && curve.degree === 1 ) {

			const pLine = curve.tryGetPolyline();

			for ( let i = 0; i < pLine.count; i ++ ) {

				rc.push( pLine.get( i ) );

			}

			pLine.delete();

			return rc;

		}

		const domain = curve.domain;
		const divisions = pointCount - 1.0;

		for ( let j = 0; j < pointCount; j ++ ) {

			const t = domain[ 0 ] + ( j / divisions ) * ( domain[ 1 ] - domain[ 0 ] );

			if ( t === domain[ 0 ] || t === domain[ 1 ] ) {

				ts.push( t );
				continue;

			}

			const tan = curve.tangentAt( t );
			const prevTan = curve.tangentAt( ts.slice( - 1 )[ 0 ] );

			// Duplicated from THREE.Vector3
			// How to pass imports to worker?

			const tS = tan[ 0 ] * tan[ 0 ] + tan[ 1 ] * tan[ 1 ] + tan[ 2 ] * tan[ 2 ];
			const ptS = prevTan[ 0 ] * prevTan[ 0 ] + prevTan[ 1 ] * prevTan[ 1 ] + prevTan[ 2 ] * prevTan[ 2 ];

			const denominator = Math.sqrt( tS * ptS );

			let angle;

			if ( denominator === 0 ) {

				angle = Math.PI / 2;

			} else {

				const theta = ( tan.x * prevTan.x + tan.y * prevTan.y + tan.z * prevTan.z ) / denominator;
				angle = Math.acos( Math.max( - 1, Math.min( 1, theta ) ) );

			}

			if ( angle < 0.1 ) continue;

			ts.push( t );

		}

		rc = ts.map( t => curve.pointAt( t ) );
		return rc;

	}

}
`;var rhino3dm_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class Rhino3dmLoader2 extends Rhino3dmLoader{constructor(o){super(o),this.materials=[],this.setLibraryPath(Rhino3dmLoader2.LIBRARY_PATH)}_createMaterial(o){return Rhino3dmLoader2.ImportMaterials?super._createMaterial(o):this.materials[0]||new three_module._4j({color:new three_module.Q1f(1,1,1),metalness:.8,name:three_module.aHM.DEFAULT_MATERIAL_NAME,side:three_module.$EB})}async loadAsync(o,l){const c=await super.loadAsync(o,l);c.rotateX(-Math.PI/2),c.userData.materials&&delete c.userData.materials;const u=c.userData.layers;return c.traverse(h=>{var _,A,w,C,M;const O=(_=h.userData.attributes)===null||_===void 0?void 0:_.castsShadows,ne=(A=h.userData.attributes)===null||A===void 0?void 0:A.receivesShadows;h.castShadow=O,h.receiveShadow=ne;const ce=(C=(w=h.userData.attributes)===null||w===void 0?void 0:w.layerIndex)!==null&&C!==void 0?C:(M=h.userData.defAttributes)===null||M===void 0?void 0:M.layerIndex,ue=u[ce];ue&&(h.userData.rhinoLayer=ue),h.userData.rhino3dmRoot=c.uuid,Rhino3dmLoader2.LoadUserDataStrings||(h.userData.strings=[]),Rhino3dmLoader2.LoadUserDataWarnings||delete h.userData.warnings,this._hideLineMesh(h),this._useInstancedMesh(h),this._useMaterialSource(h,ue)}),this.materials=[],c}_useMaterialSource(o,l){var c,u,h,_,A;if(!Rhino3dmLoader2.ImportMaterials)return;const w=o;if(((c=w.material)===null||c===void 0?void 0:c.name)==="default"||Rhino3dmLoader2.ForceLayerMaterials){const C=((u=w.userData.attributes)===null||u===void 0?void 0:u.materialSource)||((h=w.userData.defAttributes)===null||h===void 0?void 0:h.materialSource),M=((_=w.userData.attributes)===null||_===void 0?void 0:_.colorSource)||((A=w.userData.defAttributes)===null||A===void 0?void 0:A.colorSource);if(!Rhino3dmLoader2.ForceLayerMaterials&&!C&&!M)return;Rhino3dmLoader2.ForceLayerMaterials||(C==null?void 0:C.value)===0||(C==null?void 0:C.value)===1&&(M==null?void 0:M.value)===0?l&&(w.material=this._compareMaterials(this._createMaterial({diffuseColor:l.color,name:l.name,emissionColor:{r:0,g:0,b:0},disableLighting:!1,indexOfRefraction:1.5,reflectivity:1,transparency:0,specularColor:{r:0,g:0,b:0},textures:[]}))):(C==null?void 0:C.value)===3||(C==null?void 0:C.value)===1&&(M==null?void 0:M.value)===3?w.traverseAncestors(O=>{O!=null&&O.material&&(w.material=O.material)}):C&&C.value!==1&&console.warn("Unknown material source",C,w,w.userData.attributes)}}_useInstancedMesh(o){if(!Rhino3dmLoader2.ReplaceWithInstancedMesh||o.children.length<=0)return;const l=o.children,c=l.map(h=>h.geometry);c.filter((h,_)=>c.indexOf(h)===_).forEach(h=>{var _;const A=l.filter(C=>C.geometry===h),w=A.length>0?A.filter(C=>C.material===A[0].material):[];if(w.length>1){const C=new three_module.ZLX(h,w[0].material,w.length);C.userData={...w[0].userData},C.userData.instanceUserData=[],C.userData.attributes=C.userData.defAttributes||C.userData.attributes,C.userData.defAttributes&&delete C.userData.defAttributes,C.name=((_=C.userData.attributes)===null||_===void 0?void 0:_.name)||w[0].name,w.forEach((M,O)=>{C.setMatrixAt(O,M.matrix),o.remove(M),C.userData.instanceUserData.push(M.userData)}),o.add(C)}})}_hideLineMesh(o){if(!Rhino3dmLoader2.HideLineMesh&&!Rhino3dmLoader2.HidePointMesh||o.children.length<=0)return;const l=[];o.traverse(c=>{(c&&Rhino3dmLoader2.HideLineMesh&&(c.isLine||c.isLineSegments)||Rhino3dmLoader2.HidePointMesh&&c.isPoints)&&l.push(c)}),l.forEach(c=>{c.userData.visible_3dm=c.visible,c.visible=!1})}}Rhino3dmLoader2.LIBRARY_PATH="https://cdn.jsdelivr.net/npm/rhino3dm@8.9.0/",Rhino3dmLoader2.ImportMaterials=!0,Rhino3dmLoader2.ForceLayerMaterials=!1,Rhino3dmLoader2.ReplaceWithInstancedMesh=!1,Rhino3dmLoader2.HideLineMesh=!1,Rhino3dmLoader2.HidePointMesh=!1,Rhino3dmLoader2.LoadUserDataStrings=!0,Rhino3dmLoader2.LoadUserDataWarnings=!0;let Rhino3dmLoadPlugin=class extends I{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin],this._importer=new Importer(Rhino3dmLoader2,["3dm"],!0),this.importMaterials=!0,this.forceLayerMaterials=!1,this.replaceWithInstancedMesh=!1,this.hideLineMesh=!1,this.hidePointMesh=!0,this.loadUserDataStrings=!0}_refresh(){Rhino3dmLoader2.ImportMaterials=this.importMaterials,Rhino3dmLoader2.ForceLayerMaterials=this.forceLayerMaterials,Rhino3dmLoader2.ReplaceWithInstancedMesh=this.replaceWithInstancedMesh,Rhino3dmLoader2.HideLineMesh=this.hideLineMesh,Rhino3dmLoader2.HidePointMesh=this.hidePointMesh,Rhino3dmLoader2.LoadUserDataStrings=this.loadUserDataStrings,Rhino3dmLoader2.LoadUserDataWarnings=!1}async onAdded(d){var o,l;(l=(o=d.getManager())===null||o===void 0?void 0:o.importer)===null||l===void 0||l.Importers.push(this._importer),this._refresh()}async onDispose(d){}async onRemove(d){var o,l;!((l=(o=d.getManager())===null||o===void 0?void 0:o.importer)===null||l===void 0)&&l.Importers&&d.getManager().importer.Importers.splice(d.getManager().importer.Importers.indexOf(this._importer),1)}};Rhino3dmLoadPlugin.PluginType="Rhino3dmLoadPlugin",rhino3dm_decorate([x(Rhino3dmLoadPlugin.prototype._refresh),uiToggle()],Rhino3dmLoadPlugin.prototype,"importMaterials",void 0),rhino3dm_decorate([x(Rhino3dmLoadPlugin.prototype._refresh),uiToggle()],Rhino3dmLoadPlugin.prototype,"forceLayerMaterials",void 0),rhino3dm_decorate([x(Rhino3dmLoadPlugin.prototype._refresh),uiToggle()],Rhino3dmLoadPlugin.prototype,"replaceWithInstancedMesh",void 0),rhino3dm_decorate([x(Rhino3dmLoadPlugin.prototype._refresh),uiToggle()],Rhino3dmLoadPlugin.prototype,"hideLineMesh",void 0),rhino3dm_decorate([x(Rhino3dmLoadPlugin.prototype._refresh),uiToggle()],Rhino3dmLoadPlugin.prototype,"hidePointMesh",void 0),rhino3dm_decorate([x(Rhino3dmLoadPlugin.prototype._refresh),uiToggle()],Rhino3dmLoadPlugin.prototype,"loadUserDataStrings",void 0),Rhino3dmLoadPlugin=rhino3dm_decorate([uiFolder("Rhino 3dm loader")],Rhino3dmLoadPlugin);class STLLoader extends three_module.aHM{constructor(o){super(o)}load(o,l,c,u){const h=this,_=new three_module.Y9S(this.manager);_.setPath(this.path),_.setResponseType("arraybuffer"),_.setRequestHeader(this.requestHeader),_.setWithCredentials(this.withCredentials),_.load(o,function(A){try{l(h.parse(A))}catch(w){u?u(w):console.error(w),h.manager.itemError(o)}},c,u)}parse(o){function l(h,_,A){for(let w=0,C=h.length;w<C;w++)if(h[w]!==_.getUint8(A+w))return!1;return!0}const c=function(h){if(typeof h=="string"){const _=new Uint8Array(h.length);for(let A=0;A<h.length;A++)_[A]=255&h.charCodeAt(A);return _.buffer||_}return h}(o);return function(h){const _=new DataView(h);if(84+50*_.getUint32(80,!0)===_.byteLength)return!0;const A=[115,111,108,105,100];for(let w=0;w<5;w++)if(l(A,_,w))return!1;return!0}(c)?function(h){const _=new DataView(h),A=_.getUint32(80,!0);let w,C,M,O,ne,ce,ue,ye,Oe=!1;for(let ut=0;ut<70;ut++)_.getUint32(ut,!1)==1129270351&&_.getUint8(ut+4)==82&&_.getUint8(ut+5)==61&&(Oe=!0,O=new Float32Array(3*A*3),ne=_.getUint8(ut+6)/255,ce=_.getUint8(ut+7)/255,ue=_.getUint8(ut+8)/255,ye=_.getUint8(ut+9)/255);const ke=new three_module.LoY,Ve=new Float32Array(3*A*3),tt=new Float32Array(3*A*3),ht=new three_module.Q1f;for(let ut=0;ut<A;ut++){const _t=84+50*ut,at=_.getFloat32(_t,!0),lt=_.getFloat32(_t+4,!0),pt=_.getFloat32(_t+8,!0);if(Oe){const xt=_.getUint16(_t+48,!0);32768&xt?(w=ne,C=ce,M=ue):(w=(31&xt)/31,C=(xt>>5&31)/31,M=(xt>>10&31)/31)}for(let xt=1;xt<=3;xt++){const Tt=_t+12*xt,Pt=3*ut*3+3*(xt-1);Ve[Pt]=_.getFloat32(Tt,!0),Ve[Pt+1]=_.getFloat32(Tt+4,!0),Ve[Pt+2]=_.getFloat32(Tt+8,!0),tt[Pt]=at,tt[Pt+1]=lt,tt[Pt+2]=pt,Oe&&(ht.set(w,C,M).convertSRGBToLinear(),O[Pt]=ht.r,O[Pt+1]=ht.g,O[Pt+2]=ht.b)}}return ke.setAttribute("position",new three_module.THS(Ve,3)),ke.setAttribute("normal",new three_module.THS(tt,3)),Oe&&(ke.setAttribute("color",new three_module.THS(O,3)),ke.hasColors=!0,ke.alpha=ye),ke}(c):function(h){const _=new three_module.LoY,A=/solid([\s\S]*?)endsolid/g,w=/facet([\s\S]*?)endfacet/g,C=/solid\s(.+)/;let M=0;const O=/[\s]+([+-]?(?:\d*)(?:\.\d*)?(?:[eE][+-]?\d+)?)/.source,ne=new RegExp("vertex"+O+O+O,"g"),ce=new RegExp("normal"+O+O+O,"g"),ue=[],ye=[],Oe=[],ke=new three_module.Pq0;let Ve,tt=0,ht=0,ut=0;for(;(Ve=A.exec(h))!==null;){ht=ut;const _t=Ve[0],at=(Ve=C.exec(_t))!==null?Ve[1]:"";for(Oe.push(at);(Ve=w.exec(_t))!==null;){let xt=0,Tt=0;const Pt=Ve[0];for(;(Ve=ce.exec(Pt))!==null;)ke.x=parseFloat(Ve[1]),ke.y=parseFloat(Ve[2]),ke.z=parseFloat(Ve[3]),Tt++;for(;(Ve=ne.exec(Pt))!==null;)ue.push(parseFloat(Ve[1]),parseFloat(Ve[2]),parseFloat(Ve[3])),ye.push(ke.x,ke.y,ke.z),xt++,ut++;Tt!==1&&console.error("THREE.STLLoader: Something isn't right with the normal of face number "+M),xt!==3&&console.error("THREE.STLLoader: Something isn't right with the vertices of face number "+M),M++}const lt=ht,pt=ut-ht;_.userData.groupNames=Oe,_.addGroup(lt,pt,tt),tt++}return _.setAttribute("position",new three_module.qtW(ue,3)),_.setAttribute("normal",new three_module.qtW(ye,3)),_}(typeof(u=o)!="string"?new TextDecoder().decode(u):u);var u}}class STLLoadPlugin extends I{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin]}async onAdded(o){var l,c;this._importer||(this._importer=new Importer(STLLoader,["stl"],!0)),(c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0||c.Importers.push(this._importer)}async onDispose(o){this._importer=void 0}async onRemove(o){var l,c;this._importer&&(!((c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0)&&c.Importers)&&o.getManager().importer.Importers.splice(o.getManager().importer.Importers.indexOf(this._importer),1),this._importer=void 0}}STLLoadPlugin.PluginType="STLLoadPlugin";class GLTFMeshOptPlugin extends I{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin]}async onAdded(o){const l=document.createElement("script");l.type="module",l.innerHTML=`
import { MeshoptDecoder } from '${GLTFMeshOptPlugin.DECODER_URL}';
window.MeshoptDecoder = MeshoptDecoder
`,document.head.appendChild(l),this._script=l}async onDispose(o){}async onRemove(o){this._script&&(document.head.removeChild(this._script),this._script=void 0)}}GLTFMeshOptPlugin.PluginType="GLTFMeshOptPlugin",GLTFMeshOptPlugin.DECODER_URL="https://unpkg.com/meshoptimizer@0.20.0/meshopt_decoder.module.js";var SnowFallPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},SnowFallPlugin_1;let SnowFallPlugin=SnowFallPlugin_1=class extends AViewerPlugin{constructor(){super(),this.enabled=!1,this.maxRange=maxRange,this.particleSize=.35,this.particleSpeed=.35,this.minRangeY=1,this.paused=!1,this._needsReset=!0,this._preFrame=()=>{var h,_;if(!this._viewer||!this.enabled)return;const A=this.maxRange,w=A/2;if(this._viewer.scene.fog){const ne=this._viewer.scene.activeCamera;this._viewer.scene.fog.near=Math.max(0,ne.near-2),this._viewer.scene.fog.far=ne.far}if(this._viewer.scene.backgroundColor&&((h=this._viewer.scene.fog)===null||h===void 0||h.color.set(this._viewer.scene.backgroundColor)),this.paused)return;const C=this.particles;C.material.size=this.particleSize;const M=C.geometry.getAttribute("position"),O=C.geometry.velocities;if(this._needsReset){for(let ne=0;ne<particleNum;ne++){const ce=Math.random()*A-w,ue=Math.random()*A-w,ye=Math.random()*A-w;M.setXYZ(ne,ce,ue,ye);const Oe=.005*(6*Math.random()-3),ke=-.002*(10*Math.random()+3),Ve=.005*(6*Math.random()-3);O[ne].set(Oe,ke,Ve).multiplyScalar(this.particleSpeed)}this._needsReset=!1}for(let ne=0;ne<M.count;ne++){const ce=O[ne];if(!ce)return;const ue=g(),ye=.001*Math.sin(.001*ue*ce.x),Oe=.001*Math.cos(.0015*ue*ce.z);let ke=M.getX(ne)+ye,Ve=M.getY(ne)+ce.y,tt=M.getZ(ne)+Oe;ke<-w?ke=w:ke>w&&(ke=-w),Ve<Math.max(-w,-this.minRangeY)&&(Ve=w),tt<-w?tt=w:tt>w&&(tt=-w),M.setX(ne,ke),M.setY(ne,Ve),M.setZ(ne,tt)}M.needsUpdate=!0,(_=this._viewer)===null||_===void 0||_.setDirty()};const d=new three_module.LoY,o=[];for(let h=0;h<particleNum;h++){const _=Math.random()*maxRange-minRange,A=Math.random()*maxRange-minRange,w=Math.random()*maxRange-minRange;o.push(_,A,w)}d.setAttribute("position",new three_module.qtW(o,3));const l=new three_module.BH$({size:.75,color:16777215,vertexColors:!1,map:getTexture(),transparent:!0,fog:!0,depthWrite:!1});l.userData.renderToDepth=!1;const c=[];for(let h=0;h<particleNum;h++){const _=.005*(6*Math.random()-3),A=-.002*(10*Math.random()+3),w=.005*(6*Math.random()-3),C=new three_module.Pq0(_,A,w);c.push(C)}const u=new three_module.ONl(d,l);u.userData.bboxVisible=!1,u.geometry.velocities=c,this.particles=u}async onAdded(d){await super.onAdded(d),d.addEventListener("preFrame",this._preFrame),this.enabled&&await this.onEnable()}async onEnable(){var d,o;const l=this._viewer;if(!l)return;const c=l.getPlugin(FrameFadePlugin);if(!this.enabled)return this.particles.visible=!1,this.particles.geometry.dispose(),this.particles.material.dispose(),void(c&&c.enable(SnowFallPlugin_1.PluginType));l.scene.fog=new three_module.jUj((d=l.scene.backgroundColor)!==null&&d!==void 0?d:54,0,maxRange);const u=(o=l.scene.getObjectByName("SnowFallPlugin_root"))!==null&&o!==void 0?o:(await l.createObject3D(void 0,!0)).modelObject;u.name="SnowFallPlugin_root",u.clear(),c&&c.disable(SnowFallPlugin_1.PluginType),u.add(this.particles),this.particles.visible=!0,this._needsReset=!0}async onRemove(d){return d.removeEventListener("preFrame",this._preFrame),this.particles.removeFromParent(),super.onRemove(d)}reset(){this._needsReset=!0}};SnowFallPlugin.PluginType="SnowFallPlugin",SnowFallPlugin_decorate([uiToggle(),serialize(),x(SnowFallPlugin.prototype.onEnable)],SnowFallPlugin.prototype,"enabled",void 0),SnowFallPlugin_decorate([uiSlider("Bounds size",[1,50]),x(SnowFallPlugin.prototype.reset),serialize()],SnowFallPlugin.prototype,"maxRange",void 0),SnowFallPlugin_decorate([uiSlider("Particle size",[.01,2]),serialize()],SnowFallPlugin.prototype,"particleSize",void 0),SnowFallPlugin_decorate([uiSlider("Particle speed",[0,2]),x(SnowFallPlugin.prototype.reset),serialize()],SnowFallPlugin.prototype,"particleSpeed",void 0),SnowFallPlugin_decorate([uiSlider("Bottom clamp",[0,30]),serialize()],SnowFallPlugin.prototype,"minRangeY",void 0),SnowFallPlugin_decorate([uiToggle("Paused"),serialize()],SnowFallPlugin.prototype,"paused",void 0),SnowFallPlugin=SnowFallPlugin_1=SnowFallPlugin_decorate([uiFolder("Snow Fall Particles")],SnowFallPlugin);const particleNum=4e3,maxRange=17,minRange=maxRange/2,textureSize=64,drawRadialGradation=(d,o,l,c)=>{d.save();const u=d.createRadialGradient(o,o,0,o,o,o);u.addColorStop(0,"rgba(255,255,255,1.0)"),u.addColorStop(.5,"rgba(255,255,255,0.5)"),u.addColorStop(1,"rgba(255,255,255,0)"),d.fillStyle=u,d.fillRect(0,0,l,c),d.restore()},getTexture=()=>{const d=document.createElement("canvas"),o=d.getContext("2d");if(!o)throw new Error("no context");const l=textureSize;d.width=l,d.height=l,drawRadialGradation(o,l/2,d.width,d.height);const c=new three_module.gPd(d);return c.type=three_module.RQf,c.colorSpace="srgb-linear",c.needsUpdate=!0,c};class SnowFlakes extends three_module.B69{constructor(){super(),this.snowList=[],this.angle=0;const o=new three_module.LoY,l=[],c=new three_module.Tap,u=c.load("https://dl.dropbox.com/s/13ec3ht27adnu1l/snowflake1.png?dl=0"),h=c.load("https://dl.dropbox.com/s/rczse8o8zt5mxe6/snowflake2.png?dl=0"),_=c.load("https://dl.dropbox.com/s/cs17pph4bu096k7/snowflake3.png?dl=0"),A=c.load("https://dl.dropbox.com/s/plwtcfvokuoz931/snowflake4.png?dl=0"),w=c.load("https://dl.dropbox.com/s/uhh77omqdwqo2z5/snowflake5.png?dl=0"),C=[];for(let O=0;O<10;O++){const ne=getRandom(0,500),ce=getRandom(0,500),ue=getRandom(0,500);C.push(ne,ce,ue)}o.setAttribute("position",new three_module.qtW(C,3));const M=[["#FFFFFF",h,getRandom(10,10)],["#FFFFFF",_,getRandom(10,15)],["#FFFFFF",u,getRandom(10,15)],["#FFFFFF",w,getRandom(5,10)],["#FFFFFF",A,getRandom(5,10)]];for(let O=0;O<M.length;O++){const ne=M[O][1],ce=M[O][2];l[O]=new three_module.BH$({size:ce,map:ne,blending:three_module.EZo,depthTest:!1,transparent:!0});const ue=new three_module.ONl(o,l[O]);ue.rotation.x=360*Math.random(),ue.rotation.y=360*Math.random(),ue.rotation.z=360*Math.random(),ue.vx=0,ue.vy=0,ue.material.opacity=0,this.add(ue),this.snowList.push(ue)}}update(){this.angle+=.001;for(let o=0;o<this.snowList.length;o++)this.snowList[o].material.opacity+=.01,this.snowList[o].vy-=1,this.snowList[o].vx=Math.sin(this.angle)*Math.cos(this.angle)*10,this.snowList[o].vx*=.2,this.snowList[o].vy*=.6,this.snowList[o].position.x+=this.snowList[o].vx,this.snowList[o].position.y+=this.snowList[o].vy,this.snowList[o].position.y<-1e3&&(this.snowList[o].material.opacity+=.1,this.remove(this.snowList[o]),this.snowList.splice(o,1),o-=1);return this.snowList.length}}function getRandom(d,o){return Math.random()*(o-d)+d}var ModelStagePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let ModelStagePlugin=class extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.model="",this.dependencies=[AssetManagerPlugin],this._sceneUpdate=d=>{d.hierarchyChanged&&this.refreshTransform()},this._lastPhysicalGroundProps=void 0,this.groundBelowModel=!1}async promptLoadModel(){if(!this._viewer)return void console.warn("ModelStagePlugin: No viewer");const d=await ge(!1,!1);if(!d.length)return;const o=d[0];await this.setModel(o)}async promptLoadModelUrl(){if(!this._viewer)return void console.warn("ModelStagePlugin: No viewer");const d=await this._viewer.prompt("Model Stage Plugin: Enter URL for the 3d model (glb, gltf, obj, fbx, etc)");d&&await this.setModel(d)}async setModel(d){var o,l,c;if(!this._viewer)return void console.warn("ModelStagePlugin: No viewer");const u=this.modelRef,h=d?await this._viewer.load(typeof d=="string"?d:{path:d.name,file:d},{autoCenter:!1,autoScale:!1,addToRoot:!0,importConfig:!1}):void 0;if(!h&&d)return void console.warn("ModelStagePlugin: Unable to load stage model");this.model=d||"",this.modelRef=h,u&&u.modelObject!==((o=this.modelRef)===null||o===void 0?void 0:o.modelObject)&&u.dispose(),this.refreshTransform();const _=this._viewer.getPlugin(LoadingScreenPlugin);return _!=null&&_.visible&&await _.hideWithDelay(),(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0,1),this.model}refreshTransform(){var d,o,l,c,u,h;const _=this.modelRef;if(!_||!this._viewer)return;const A=this._viewer.getPluginByType("Ground");if(A){A.useModelBounds=this.groundBelowModel;const Ve=this._viewer.getPlugin(GroundPlugin);Ve&&(this.groundBelowModel?(this._lastPhysicalGroundProps={renderToDepth:Ve.renderToDepth,physicalReflections:Ve.physicalReflections,groundReflection:Ve.groundReflection,material:{transparent:(d=Ve.material)===null||d===void 0?void 0:d.transparent}},Ve.renderToDepth=!1,Ve.physicalReflections=!1,Ve.groundReflection=!1,Ve.material&&(Ve.material.transparent=!0)):this._lastPhysicalGroundProps&&(Ve.renderToDepth=this._lastPhysicalGroundProps.renderToDepth,Ve.physicalReflections=this._lastPhysicalGroundProps.physicalReflections,Ve.groundReflection=this._lastPhysicalGroundProps.groundReflection,Ve.material&&this._lastPhysicalGroundProps.material&&(Ve.material.transparent=this._lastPhysicalGroundProps.material.transparent),this._lastPhysicalGroundProps=void 0))}const w=this._getPlaceholders(),C=w[0];if(w.forEach(Ve=>Ve.visible=!1),!C)return void console.warn("ModelStagePlugin: No placeholder found");const M=this._viewer.scene.modelRoot.children[0];if(!M)return void console.warn("ModelStagePlugin: No object in scene");const O=new Box3B().expandByObject(M,!0,!0),ne=new Box3B().expandByObject(C,!0,!1),ce=O.getSize(new three_module.Pq0),ue=ne.getSize(new three_module.Pq0),ye=O.getCenter(new three_module.Pq0),Oe=ne.getCenter(new three_module.Pq0),ke=Math.max(ce.x/ue.x,ce.y/ue.y,ce.z/ue.z);if(isFinite(ke)&&ke!==0){_.modelObject.scale.multiplyScalar(ke),Oe.multiplyScalar(ke),_.modelObject.position.add(ye).sub(Oe),_.modelObject.position.y+=(ue.y*ke-ce.y)/2,(l=(o=_.modelObject).setDirty)===null||l===void 0||l.call(o);for(let Ve=1;Ve<this._viewer.scene.modelRoot.children.length;Ve++){const tt=w[Ve%w.length],ht=this._viewer.scene.modelRoot.children[Ve];tt.updateMatrixWorld(!0),ht.updateMatrixWorld(!0);const ut=tt.getWorldQuaternion(new three_module.PTz);ht.applyQuaternion(ut),ht.updateMatrixWorld(!0);const _t=new Box3B().expandByObject(tt,!0,!1),at=new Box3B().expandByObject(ht,!0,!0),lt=_t.getSize(new three_module.Pq0),pt=at.getSize(new three_module.Pq0),xt=_t.getCenter(new three_module.Pq0),Tt=at.getCenter(new three_module.Pq0),Pt=Math.min(lt.x/pt.x,lt.y/pt.y,lt.z/pt.z);isFinite(Pt)&&Pt!==0&&(ht.scale.multiplyScalar(Pt),Tt.multiplyScalar(Pt),ht.position.add(xt).sub(Tt),ht.position.y+=(pt.y*Pt-lt.y)/2,(u=(c=ht).setDirty)===null||u===void 0||u.call(c))}if(!this.groundBelowModel){const Ve=this._viewer.getPluginByType("Ground");if(!((h=Ve==null?void 0:Ve.mesh)===null||h===void 0)&&h.modelObject&&Ve){const tt=new Box3B().expandByObject(_.modelObject,!0,!1).getSize(new three_module.Pq0),ht=Math.max(tt.x,tt.z);Ve.autoFrustumSize=!1,Ve.size=ht;const ut=Ve.shadowBaker;ut&&(ut.light.shadowParams.frustumSize=2*ht,ut.light.updateShadowParams())}}}}_getPlaceholders(d){var o;const l=[];return(o=d??this.modelRef)===null||o===void 0||o.modelObject.traverse(c=>{c.name.toLowerCase().startsWith("placeholder")&&l.push(c)}),l}async onAdded(d){await super.onAdded(d),d.scene.addEventListener("sceneUpdate",this._sceneUpdate)}async onRemove(d){return this.modelRef&&this.modelRef.dispose(),d.scene.removeEventListener("sceneUpdate",this._sceneUpdate),super.onRemove(d)}fromJSON(d,o){return d.model!==void 0&&this.setModel(d.model),super.fromJSON(d,o)}loadSampleModel(){this.setModel("https://cors-proxy.r2cache.com/https://assets.demodrive.ijewel3d.com/test-stage/stage-placeholder4.glb")}togglePlaceholders(){var d;this._getPlaceholders().forEach(o=>{o.material&&(o.material.opacity=Math.min(.75,o.material.opacity||1),o.material.transparent=!0),o.visible=!o.visible}),(d=this._viewer)===null||d===void 0||d.setDirty()}importStageViewerConfig(){var d,o,l;const c=((d=this.modelRef)===null||d===void 0?void 0:d.modelObject).__importedViewerConfig;if(!c||typeof c!="object"||!this._viewer)return;const u=this._viewer.scene.activeCamera.toJSON(),h=this._viewer.serializePluginsIgnored;this._viewer.serializePluginsIgnored=[...h,LoadingScreenPlugin.PluginType,InteractionPromptPlugin.PluginType,"ReliefParallaxMapping","RendererParamsUiPlugin",CameraViewPlugin.PluginType,"MaterialConfiguratorPlugin","SwitchNodePlugin","FrameFade","GLTFAnimationPlugin","ModelStagePlugin",SnowFallPlugin.PluginType],(l=(o=this._viewer)===null||o===void 0?void 0:o.assetManager)===null||l===void 0||l.applyViewerConfig(c,c.resources),this._viewer.serializePluginsIgnored=h,this._viewer.scene.activeCamera.fromJSON(u)}};ModelStagePlugin.PluginType="ModelStagePlugin",ModelStagePlugin_decorate([serialize()],ModelStagePlugin.prototype,"model",void 0),ModelStagePlugin_decorate([uiButton("Prompt Local File")],ModelStagePlugin.prototype,"promptLoadModel",null),ModelStagePlugin_decorate([uiButton("Prompt URL")],ModelStagePlugin.prototype,"promptLoadModelUrl",null),ModelStagePlugin_decorate([uiButton("Refresh Placeholder Transform")],ModelStagePlugin.prototype,"refreshTransform",null),ModelStagePlugin_decorate([serialize(),x(ModelStagePlugin.prototype.refreshTransform),uiToggle()],ModelStagePlugin.prototype,"groundBelowModel",void 0),ModelStagePlugin_decorate([uiButton("Load sample model")],ModelStagePlugin.prototype,"loadSampleModel",null),ModelStagePlugin_decorate([uiButton("Toggle Placeholders")],ModelStagePlugin.prototype,"togglePlaceholders",null),ModelStagePlugin_decorate([uiButton("Import Stage Config",d=>({hidden:()=>{var o,l;return!(!((l=(o=d.modelRef)===null||o===void 0?void 0:o.modelObject)===null||l===void 0)&&l.__importedViewerConfig)}}))],ModelStagePlugin.prototype,"importStageViewerConfig",null),ModelStagePlugin=ModelStagePlugin_decorate([uiFolder("Model Stage")],ModelStagePlugin);class CoreViewerApp extends ViewerApp{constructor(o){super(o),this.licenseKey=o.licenseKey}async initialize({caching:o=!0,ground:l=!0,bloom:c=!0,depthTonemap:u=!0,enableDrop:h=!1,importPopup:_=!0,debug:A=!1,interactionPrompt:w=!0}={}){A&&await this.addPlugin(DebugPlugin),this.getPlugin(AssetManagerPlugin)||this.addPluginSync(AssetManagerPlugin,void 0,void 0,{storage:o&&window.caches?await caches.open("webgi-cache-storage"):void 0}),await addBasePlugins(this,{ground:l,bloom:c,depthTonemap:u,enableDrop:h,importPopup:_,interactionPrompt:w}),await this.getOrAddPlugin(PresetLibraryPlugin);const C=await this.getOrAddPlugin(DiamondPlugin);return this.licenseKey&&C.setKey(this.licenseKey),await this.addPlugin(MaterialConfiguratorPlugin),await this.addPlugin(SwitchNodePlugin),await this.addPlugin(MaterialLibraryPlugin),this}}async function addBasePlugins(d,{ground:o=!0,bloom:l=!0,depthTonemap:c=!0,enableDrop:u=!1,importPopup:h=!1,interactionPrompt:_=!0}={}){await d.getOrAddPlugin(AssetManagerPlugin),h&&await d.getOrAddPlugin(LoadingScreenPlugin),await d.getOrAddPlugin(GBufferPlugin),await d.getOrAddPlugin(FullScreenPlugin),u&&await d.getOrAddPlugin(DropzonePlugin),await d.addPlugin(new ProgressivePlugin(32)),await d.getOrAddPlugin(CombinedPostPlugin),await d.getOrAddPlugin(ChromaticAberrationPlugin),await d.addPlugin(new TonemapPlugin(c||!d.useRgbm)),await d.getOrAddPlugin(LUTPlugin),await d.getOrAddPlugin(VignettePlugin),await d.getOrAddPlugin(FilmicGrainPlugin),await d.getOrAddPlugin(GammaCorrectionPlugin),await d.getOrAddPlugin(SSRPlugin),await d.getOrAddPlugin(SSAOPlugin),await d.getOrAddPlugin(FrameFadePlugin),await d.getOrAddPlugin(GLTFAnimationPlugin),await d.getOrAddPlugin(AnisotropyPlugin),await d.getOrAddPlugin(TriplanarUVMappingPlugin),await d.getOrAddPlugin(ThinFilmLayerPlugin),await d.getOrAddPlugin(FragmentClippingExtensionPlugin),await d.getOrAddPlugin(NoiseBumpMaterialPlugin),await d.getOrAddPlugin(CustomBumpMapPlugin),await d.getOrAddPlugin(ClearcoatTintPlugin),await d.getOrAddPlugin(GLTFKHRMaterialVariantsPlugin),await d.getOrAddPlugin(VelocityBufferPlugin,!1),await d.getOrAddPlugin(TemporalAAPlugin),await d.getOrAddPlugin(CameraViewPlugin),await d.getOrAddPlugin(RandomizedDirectionalLightPlugin,!1),await d.getOrAddPlugin(HDRiGroundPlugin,!1),await d.getOrAddPlugin(DepthOfFieldPlugin,!1),await d.getOrAddPlugin(SSContactShadows,!1),await d.getOrAddPlugin(SSGIPlugin,!1),await d.getOrAddPlugin(NormalBufferPlugin,!1),await d.getOrAddPlugin(SSBevelPlugin,!1),await d.getOrAddPlugin(KTX2LoadPlugin),await d.getOrAddPlugin(ObjMtlLoadPlugin),await d.getOrAddPlugin(FBXLoadPlugin),await d.getOrAddPlugin(Rhino3dmLoadPlugin),await d.getOrAddPlugin(STLLoadPlugin),await d.getOrAddPlugin(EXRLoadPlugin),await d.getOrAddPlugin(GLTFMeshOptPlugin),await d.getOrAddPlugin(ModelStagePlugin),await d.getOrAddPlugin(ParallaxCameraControllerPlugin),l&&await d.getOrAddPlugin(BloomPlugin),o&&await d.getOrAddPlugin(GroundPlugin),_&&await d.getOrAddPlugin(InteractionPromptPlugin),await d.getOrAddPlugin(LayeredMaterialPlugin),d.renderer.refreshPipeline()}var dist_tippy=__webpackgi_require__(774),tippy_exported={};dist_tippy.A&&dist_tippy.A.locals&&(tippy_exported.locals=dist_tippy.A.locals);var tippy_refs=0,tippy_update,tippy_options={};tippy_options.styleTagTransform=styleTagTransform_default(),tippy_options.setAttributes=setAttributesWithoutAttributes_default(),tippy_options.insert=function(d,o){(o.target||document.head).appendChild(d)},tippy_options.domAPI=styleDomAPI_default(),tippy_options.insertStyleElement=insertStyleElement_default(),tippy_exported.use=function(d){return tippy_options.options=d||{},tippy_refs++||(tippy_update=injectStylesIntoStyleTag_default()(dist_tippy.A,tippy_options)),tippy_exported},tippy_exported.unuse=function(){tippy_refs>0&&!--tippy_refs&&(tippy_update(),tippy_update=null)};var tippy_js_dist_tippy=tippy_exported;const placeholderModel="",placeholderEnvironment="";let id=0;class WebGiViewerElement extends HTMLElement{constructor(){super(),this._initialized=!1,this._state={src:"",environment:""},this._models={},this._refreshingModels=!1,this._refreshingEnvironment=!1,this._environmentFromSource=null,this.viewerIndex=id++,this.canvasId="webgi-viewer-"+this.viewerIndex,window.freeViewers||(window.freeViewers=[]),this.attachShadow({mode:"open"}),this.wrapper=document.createElement("div"),this.wrapper.style.width="100%",this.wrapper.style.height="100%",this.wrapper.style.display="block";const o=window.freeViewers.pop(),l=document.createElement("style");l.textContent=$`
            #${this.canvasId}{
              width: 100%; height: 100%; z-index: 1;
              display: block;
            }
            //.tippy-box[data-theme~='editor']{
            //    margin: 0.25rem !important;
            //    background-color: hsla(230, 10%, 30%, 1.00) !important;
            //    font-size: 0.9rem !important;
            //    color: hsla(230, 5%, 90%, 1.00) !important;
            //}
        `,tippy_js_dist_tippy.use({target:this.wrapper}),tippy_esm.setDefaultProps({duration:300,arrow:!0,appendTo:()=>this.wrapper}),this.shadowRoot.append(l,this.wrapper),this._initialized=!0,this._initialize(o).then(async()=>this.refreshAll())}async refreshAll(){this.viewer&&(this.viewer.renderer.displayCanvasScaling=parseFloat(this.getAttribute("renderScale")||this.getAttribute("renderscale")||this.viewer.renderer.displayCanvasScaling.toString())),await Promise.all([this.refreshModelSource(),this.refreshEnvironment()])}async _initialize(o){o!=null&&o._lastState&&(this._state.src=o._lastState.src||this._state.src,this._state.environment=o._lastState.environment||this._state.environment,delete o._lastState),o!=null&&o.__models&&(this._models={...this._models,...o.__models},delete o.__models),this.canvas=(o==null?void 0:o.canvas)||j(),this.canvas.setAttribute("id",this.canvasId),this.wrapper.append(this.canvas),this.viewer=o??new CoreViewerApp({canvas:this.canvas,useRgbm:this._getAttr("rgbm","true")==="true",useGBufferDepth:this._getAttr("depth-prepass","true")==="true",assetManager:{storage:window.caches?await caches.open("webgi-cache-storage"):void 0}}),this.viewer&&(this.viewer.renderer.displayCanvasScaling=parseFloat(this.getAttribute("renderScale")||this.getAttribute("renderscale")||this.viewer.renderer.displayCanvasScaling.toString())),o||await this.viewer.initialize({debug:this._getAttr("debug","false")==="true",ground:this._getAttr("ground","baked")==="baked",bloom:this._getAttr("bloom","true")==="true",depthTonemap:!0}),this.dispatchEvent(new Event("initialized"))}connectedCallback(){this._initialized&&this.viewer&&(this.viewer.resize(),this.viewer.enabled=!0,this.dispatchEvent(new Event("connected")))}disconnectedCallback(){var o,l;this.viewer&&(this.getAttribute("disposeOnRemove")==="true"||this.getAttribute("disposeonremove")==="true"?((o=this.canvas)===null||o===void 0||o.remove(),this.clearViewer(),this.viewer.dispose(),this.viewer=void 0,this.canvas=void 0,this._initialized=!1):this.getAttribute("autoManageViewers")==="true"||this.getAttribute("automanageviewers")==="true"?((l=this.canvas)===null||l===void 0||l.remove(),this.viewer._lastState={...this._state},this.viewer._lastState.src="",this.clearViewer(),window.freeViewers.push(this.viewer),this.viewer=void 0,this.canvas=void 0,this._initialized=!1):this.viewer.enabled=!1,this.dispatchEvent(new Event("disconnected")))}adoptedCallback(){this.viewer&&(this.viewer.resize(),this.viewer.enabled=!0)}static get observedAttributes(){return["src","environment","renderScale"]}attributeChangedCallback(o,l,c){this.refreshAll()}clearViewer(){var o,l;(o=this.viewer)===null||o===void 0||o.scene.disposeSceneModels(),(l=this.viewer)===null||l===void 0||l.scene.setEnvironment(null),Object.values(this._models).forEach(async c=>c.then(u=>u.forEach(h=>h.dispose&&h.dispose()))),this._models={}}async refreshModelSource(){if(!this.viewer)return;const o=this._getAttr("src",placeholderModel);if(o===this._state.src||this._refreshingModels)return;this._refreshingModels=!0;const l=[o],c=[],u=[],h=this.viewer.scene.environment;this.viewer.scene.environment=null,this._environmentFromSource=null;for(const A of l)!this._models[A]&&A&&(this._models[A]=this.viewer.getManager().importer.importPath(A,{autoScale:this._getAttr("auto-scale","true")==="true",autoCenter:this._getAttr("auto-center","true")==="true",processImported:!0,pathOverride:this._getAttr("filename","")||void 0}));const _=this.viewer.scene.environment;_?this._environmentFromSource=_:this.viewer.scene.environment=h;for(const[A,w]of Object.entries(this._models))l.includes(A)?c.push(w.then(C=>[A,C])):u.push(w);await Promise.all([Promise.all(c).then(async A=>Promise.all(A.map(async w=>(this._models[w[0]]=this.viewer.getManager().importer.processImported(w[1]),this._models[w[0]])))).then(A=>{for(const w of A)for(const C of w)C&&C.assetType==="model"&&this.viewer.scene.addSceneObject(C)}),Promise.all(u).then(A=>{for(const w of A)for(const C of w)C&&C.assetType==="model"&&C.modelObject.removeFromParent()})]),this._state.src=o,this._refreshingModels=!1}async refreshEnvironment(){if(!this.viewer)return;if(!this.hasAttribute("environment"))return void(this._state.environment=null);if(this._environmentFromSource)return void this.viewer.console.warn("Environment is already set by model source, ignoring environment attribute.");const o=this._getAttr("environment",placeholderEnvironment);if(o===this._state.src||this._refreshingEnvironment)return;this._refreshingEnvironment=!0;const l=this.viewer.scene.getEnvironment(),c=o?await this.viewer.getManager().importer.importSinglePath(o):void 0;this._environmentFromSource?this.viewer.console.warn("Environment is already set by model source, ignoring environment attribute."):(c&&c.assetType!=="texture"||await this.viewer.scene.setEnvironment(c),l==null||l.dispose(),this.dispatchEvent(new CustomEvent("environment-loaded",{detail:{src:o}})),this._state.environment=o,this._refreshingEnvironment=!1)}_getAttr(o,l){return this.hasAttribute(o)?this.getAttribute(o):l}addEventListener(o,l,c){super.addEventListener(o,l,c),o==="initialized"&&this._initialized&&this.dispatchEvent(new Event("initialized"))}}window&&window.customElements&&!window.customElements.get("webgi-viewer")&&window.customElements.define("webgi-viewer",WebGiViewerElement);var popup=__webpackgi_require__(636),popup_exported={};popup.A&&popup.A.locals&&(popup_exported.locals=popup.A.locals);var popup_refs=0,popup_update,popup_options={};popup_options.styleTagTransform=styleTagTransform_default(),popup_options.setAttributes=setAttributesWithoutAttributes_default(),popup_options.insert=function(d,o){(o.target||document.head).appendChild(d)},popup_options.domAPI=styleDomAPI_default(),popup_options.insertStyleElement=insertStyleElement_default(),popup_exported.use=function(d){return popup_options.options=d||{},popup_refs++||(popup_update=injectStylesIntoStyleTag_default()(popup.A,popup_options)),popup_exported},popup_exported.unuse=function(){popup_refs>0&&!--popup_refs&&(popup_update(),popup_update=null)};var styles_popup=popup_exported,AssetManagerPopupPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let AssetManagerBasicPopupPlugin=class extends AAssetManagerProcessStatePlugin{constructor(){super("Popup");const d=ee({id:"assetManagerPopupClose",addToBody:!1,innerHTML:"&#10005"});d.addEventListener("click",()=>{this._mainDiv.style.display="none"}),this._mainDiv.appendChild(d)}_updateMainDiv(d){if(!this._contentDiv)return;if(!this.enabled)return void(this._mainDiv.style.display="none");let o="";d.forEach((l,c)=>{o+=`<span class="processState">${l.state}</span>: ${(c||"").split("/").pop()} ${l.progress?" - "+l.progress.toFixed(0)+"%":""}<br>`}),this._contentDiv.innerHTML=o,d.size===0?this._mainDiv.style.display="none":this._mainDiv.style.display="block"}async onAdded(d){styles_popup.use({target:d.container}),await super.onAdded(d)}};AssetManagerBasicPopupPlugin.PluginType="AssetManagerBasicPopupPlugin",AssetManagerBasicPopupPlugin=AssetManagerPopupPlugin_decorate([uiFolder("Asset manager popup")],AssetManagerBasicPopupPlugin);var loadingBar=__webpackgi_require__(223),loadingBar_exported={};loadingBar.A&&loadingBar.A.locals&&(loadingBar_exported.locals=loadingBar.A.locals);var loadingBar_refs=0,loadingBar_update,loadingBar_options={};loadingBar_options.styleTagTransform=styleTagTransform_default(),loadingBar_options.setAttributes=setAttributesWithoutAttributes_default(),loadingBar_options.insert=function(d,o){(o.target||document.head).appendChild(d)},loadingBar_options.domAPI=styleDomAPI_default(),loadingBar_options.insertStyleElement=insertStyleElement_default(),loadingBar_exported.use=function(d){return loadingBar_options.options=d||{},loadingBar_refs++||(loadingBar_update=injectStylesIntoStyleTag_default()(loadingBar.A,loadingBar_options)),loadingBar_exported},loadingBar_exported.unuse=function(){loadingBar_refs>0&&!--loadingBar_refs&&(loadingBar_update(),loadingBar_update=null)};var styles_loadingBar=loadingBar_exported,AssetManagerLoadingBarPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let AssetManagerLoadingBarPlugin=class extends AAssetManagerProcessStatePlugin{constructor(d=!0){super("LoadingBar"),this.showText=d,this.hideOnOnlyErrors=!0}_updateMainDiv(d){if(!this._contentDiv)return;if(!this.enabled)return void(this._mainDiv.style.display="none");let o=1,l=1;d.forEach((u,h)=>{var _;o+=(_=u.progress)!==null&&_!==void 0?_:99,l+=100}),this._contentDiv.innerHTML=this.showText?(100*o/l).toFixed(0)+"%":"&nbsp;",this._contentDiv.style.width=(100*o/l).toFixed(0)+"%";const c=[...d.values()].filter(u=>u.state==="error");c.length>0&&c.length===d.size&&this.hideOnOnlyErrors||d.size===0?this._mainDiv.style.display="none":this._mainDiv.style.display="block"}async onAdded(d){styles_loadingBar.use({target:d.container}),await super.onAdded(d)}};AssetManagerLoadingBarPlugin.PluginType="AssetManagerLoadingBarPlugin",AssetManagerLoadingBarPlugin_decorate([uiToggle("Hide on only errors"),serialize()],AssetManagerLoadingBarPlugin.prototype,"hideOnOnlyErrors",void 0),AssetManagerLoadingBarPlugin=AssetManagerLoadingBarPlugin_decorate([uiFolder("Asset manager loading bar")],AssetManagerLoadingBarPlugin);class SimpleAssetList{get basePath(){return this._basePath}get assets(){return this._assets}constructor(o){var l,c,u;this._basePath=(l=o==null?void 0:o.basePath)!==null&&l!==void 0?l:"",this._assets=(u=(c=o==null?void 0:o.assets)===null||c===void 0?void 0:c.map(h=>this._resolveAsset(h)))!==null&&u!==void 0?u:[]}find(o){const l=this._assets.find(o);return l??void 0}_resolveAsset(o){return{...o,path:ot([this._basePath,o.path])}}}class SimpleDataSource extends I{constructor(...o){super(),this._assets=o}addAssetList(o){this._assets.push(o)}removeAssetList(o){const l=this._assets.indexOf(o);l>=0&&this._assets.splice(l,1)}async findAssetRegex(o){for(const l of this._assets){const c=l.find(u=>{var h,_;return u&&(o.test(u.path)||o.test((_=(h=u.file)===null||h===void 0?void 0:h.name)!==null&&_!==void 0?_:""))});if(c)return c}console.warn("Asset not found:",o)}async findAsset(o){return this.findAssetRegex(o.query)}async findAssetSimple(o,l=!1){return this.findAssetRegex(new RegExp(o,l?"i":""))}}const LineSegments2_start=new three_module.Pq0,LineSegments2_end=new three_module.Pq0,_start4=new three_module.IUQ,_end4=new three_module.IUQ,_ssOrigin=new three_module.IUQ,_ssOrigin3=new three_module.Pq0,_mvMatrix=new three_module.kn4,_line=new three_module.cZY,_closestPoint=new three_module.Pq0,LineSegments2_box=new three_module.NRn,_sphere=new three_module.iyt,_clipToWorldVector=new three_module.IUQ;let LineSegments2_ray,_lineWidth;function getWorldSpaceHalfWidth(d,o,l){return _clipToWorldVector.set(0,0,-o,1).applyMatrix4(d.projectionMatrix),_clipToWorldVector.multiplyScalar(1/_clipToWorldVector.w),_clipToWorldVector.x=_lineWidth/l.width,_clipToWorldVector.y=_lineWidth/l.height,_clipToWorldVector.applyMatrix4(d.projectionMatrixInverse),_clipToWorldVector.multiplyScalar(1/_clipToWorldVector.w),Math.abs(Math.max(_clipToWorldVector.x,_clipToWorldVector.y))}function raycastWorldUnits(d,o){const l=d.matrixWorld,c=d.geometry,u=c.attributes.instanceStart,h=c.attributes.instanceEnd;for(let _=0,A=Math.min(c.instanceCount,u.count);_<A;_++){_line.start.fromBufferAttribute(u,_),_line.end.fromBufferAttribute(h,_),_line.applyMatrix4(l);const w=new three_module.Pq0,C=new three_module.Pq0;LineSegments2_ray.distanceSqToSegment(_line.start,_line.end,C,w),C.distanceTo(w)<.5*_lineWidth&&o.push({point:C,pointOnLine:w,distance:LineSegments2_ray.origin.distanceTo(C),object:d,face:null,faceIndex:_,uv:null,uv1:null})}}function raycastScreenSpace(d,o,l){const c=o.projectionMatrix,u=d.material.resolution,h=d.matrixWorld,_=d.geometry,A=_.attributes.instanceStart,w=_.attributes.instanceEnd,C=Math.min(_.instanceCount,A.count),M=-o.near;LineSegments2_ray.at(1,_ssOrigin),_ssOrigin.w=1,_ssOrigin.applyMatrix4(o.matrixWorldInverse),_ssOrigin.applyMatrix4(c),_ssOrigin.multiplyScalar(1/_ssOrigin.w),_ssOrigin.x*=u.x/2,_ssOrigin.y*=u.y/2,_ssOrigin.z=0,_ssOrigin3.copy(_ssOrigin),_mvMatrix.multiplyMatrices(o.matrixWorldInverse,h);for(let O=0,ne=C;O<ne;O++){if(_start4.fromBufferAttribute(A,O),_end4.fromBufferAttribute(w,O),_start4.w=1,_end4.w=1,_start4.applyMatrix4(_mvMatrix),_end4.applyMatrix4(_mvMatrix),_start4.z>M&&_end4.z>M)continue;if(_start4.z>M){const ke=_start4.z-_end4.z,Ve=(_start4.z-M)/ke;_start4.lerp(_end4,Ve)}else if(_end4.z>M){const ke=_end4.z-_start4.z,Ve=(_end4.z-M)/ke;_end4.lerp(_start4,Ve)}_start4.applyMatrix4(c),_end4.applyMatrix4(c),_start4.multiplyScalar(1/_start4.w),_end4.multiplyScalar(1/_end4.w),_start4.x*=u.x/2,_start4.y*=u.y/2,_end4.x*=u.x/2,_end4.y*=u.y/2,_line.start.copy(_start4),_line.start.z=0,_line.end.copy(_end4),_line.end.z=0;const ce=_line.closestPointToPointParameter(_ssOrigin3,!0);_line.at(ce,_closestPoint);const ue=three_module.cj9.lerp(_start4.z,_end4.z,ce),ye=ue>=-1&&ue<=1,Oe=_ssOrigin3.distanceTo(_closestPoint)<.5*_lineWidth;if(ye&&Oe){_line.start.fromBufferAttribute(A,O),_line.end.fromBufferAttribute(w,O),_line.start.applyMatrix4(h),_line.end.applyMatrix4(h);const ke=new three_module.Pq0,Ve=new three_module.Pq0;LineSegments2_ray.distanceSqToSegment(_line.start,_line.end,Ve,ke),l.push({point:Ve,pointOnLine:ke,distance:LineSegments2_ray.origin.distanceTo(Ve),object:d,face:null,faceIndex:O,uv:null,uv1:null})}}}class LineSegments2 extends three_module.eaF{constructor(o=new LineSegmentsGeometry,l=new LineMaterial({color:16777215*Math.random()})){super(o,l),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const o=this.geometry,l=o.attributes.instanceStart,c=o.attributes.instanceEnd,u=new Float32Array(2*l.count);for(let _=0,A=0,w=l.count;_<w;_++,A+=2)LineSegments2_start.fromBufferAttribute(l,_),LineSegments2_end.fromBufferAttribute(c,_),u[A]=A===0?0:u[A-1],u[A+1]=u[A]+LineSegments2_start.distanceTo(LineSegments2_end);const h=new three_module.LuO(u,2,1);return o.setAttribute("instanceDistanceStart",new three_module.eHs(h,1,0)),o.setAttribute("instanceDistanceEnd",new three_module.eHs(h,1,1)),this}raycast(o,l){const c=this.material.worldUnits,u=o.camera;u!==null||c||console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const h=o.params.Line2!==void 0&&o.params.Line2.threshold||0;LineSegments2_ray=o.ray;const _=this.matrixWorld,A=this.geometry,w=this.material;let C,M;_lineWidth=w.linewidth+h,A.boundingSphere===null&&A.computeBoundingSphere(),_sphere.copy(A.boundingSphere).applyMatrix4(_),C=c?.5*_lineWidth:getWorldSpaceHalfWidth(u,Math.max(u.near,_sphere.distanceToPoint(LineSegments2_ray.origin)),w.resolution),_sphere.radius+=C,LineSegments2_ray.intersectsSphere(_sphere)!==!1&&(A.boundingBox===null&&A.computeBoundingBox(),LineSegments2_box.copy(A.boundingBox).applyMatrix4(_),M=c?.5*_lineWidth:getWorldSpaceHalfWidth(u,Math.max(u.near,LineSegments2_box.distanceToPoint(LineSegments2_ray.origin)),w.resolution),LineSegments2_box.expandByScalar(M),LineSegments2_ray.intersectsBox(LineSegments2_box)!==!1&&(c?raycastWorldUnits(this,l):raycastScreenSpace(this,u,l)))}}class LineGeometry extends LineSegmentsGeometry{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(o){const l=o.length-3,c=new Float32Array(2*l);for(let u=0;u<l;u+=3)c[2*u]=o[u],c[2*u+1]=o[u+1],c[2*u+2]=o[u+2],c[2*u+3]=o[u+3],c[2*u+4]=o[u+4],c[2*u+5]=o[u+5];return super.setPositions(c),this}setColors(o){const l=o.length-3,c=new Float32Array(2*l);for(let u=0;u<l;u+=3)c[2*u]=o[u],c[2*u+1]=o[u+1],c[2*u+2]=o[u+2],c[2*u+3]=o[u+3],c[2*u+4]=o[u+4],c[2*u+5]=o[u+5];return super.setColors(c),this}fromLine(o){const l=o.geometry;return this.setPositions(l.attributes.position.array),this}}class Line2 extends LineSegments2{constructor(o=new LineGeometry,l=new LineMaterial({color:16777215*Math.random()})){super(o,l),this.isLine2=!0,this.type="Line2"}}class KTXLoader extends three_module.YRT{constructor(o){super(o)}parse(o,l){const c=new KhronosTextureContainer(o,1);return{mipmaps:c.mipmaps(l),width:c.pixelWidth,height:c.pixelHeight,format:c.glInternalFormat,isCubemap:c.numberOfFaces===6,mipmapCount:c.numberOfMipmapLevels}}}const HEADER_LEN=64,COMPRESSED_2D=0;class KhronosTextureContainer{constructor(o,l){this.arrayBuffer=o;const c=new Uint8Array(this.arrayBuffer,0,12);if(c[0]!==171||c[1]!==75||c[2]!==84||c[3]!==88||c[4]!==32||c[5]!==49||c[6]!==49||c[7]!==187||c[8]!==13||c[9]!==10||c[10]!==26||c[11]!==10)return void console.error("texture missing KTX identifier");const u=Uint32Array.BYTES_PER_ELEMENT,h=new DataView(this.arrayBuffer,12,13*u),_=h.getUint32(0,!0)===67305985;this.glType=h.getUint32(1*u,_),this.glTypeSize=h.getUint32(2*u,_),this.glFormat=h.getUint32(3*u,_),this.glInternalFormat=h.getUint32(4*u,_),this.glBaseInternalFormat=h.getUint32(5*u,_),this.pixelWidth=h.getUint32(6*u,_),this.pixelHeight=h.getUint32(7*u,_),this.pixelDepth=h.getUint32(8*u,_),this.numberOfArrayElements=h.getUint32(9*u,_),this.numberOfFaces=h.getUint32(10*u,_),this.numberOfMipmapLevels=h.getUint32(11*u,_),this.bytesOfKeyValueData=h.getUint32(12*u,_),this.glType===0?(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),this.pixelHeight!==0&&this.pixelDepth===0?this.numberOfArrayElements===0?this.numberOfFaces===l?this.loadType=COMPRESSED_2D:console.warn("number of faces expected"+l+", but found "+this.numberOfFaces):console.warn("texture arrays not currently supported"):console.warn("only 2D textures currently supported")):console.warn("only compressed formats currently supported")}mipmaps(o){const l=[];let c=HEADER_LEN+this.bytesOfKeyValueData,u=this.pixelWidth,h=this.pixelHeight;const _=o?this.numberOfMipmapLevels:1;for(let A=0;A<_;A++){const w=new Int32Array(this.arrayBuffer,c,1)[0];c+=4;for(let C=0;C<this.numberOfFaces;C++){const M=new Uint8Array(this.arrayBuffer,c,w);l.push({data:M,width:u,height:h}),c+=w,c+=3-(w+3)%4}u=Math.max(1,.5*u),h=Math.max(1,.5*h)}return l}}class KTXLoadPlugin extends I{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin]}async onAdded(o){var l,c;this._importer||(this._importer=new Importer(KTXLoader,["ktx"],!1)),(c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0||c.Importers.push(this._importer)}async onDispose(o){this._importer=void 0}async onRemove(o){var l,c;this._importer&&(!((c=(l=o.getManager())===null||l===void 0?void 0:l.importer)===null||c===void 0)&&c.Importers)&&o.getManager().importer.Importers.splice(o.getManager().importer.Importers.indexOf(this._importer),1),this._importer=void 0}}KTXLoadPlugin.PluginType="KTXLoadPlugin";class BlobLoader extends three_module.Y9S{constructor(o){super(o),this.responseType="blob"}}class DataUrlLoader extends three_module.Y9S{constructor(o){super(o),this.responseType="blob"}load(o,l,c,u){return super.load(o,h=>{try{l==null||l(q(h))}catch(_){u==null||u(_)}},c,u)}}class SimpleJSONExporter{async parseAsync(o,l){var c;return new Blob([JSON.stringify(o,null,(c=l.jsonSpaces)!==null&&c!==void 0?c:2)],{type:"application/json"})}}class SimpleTextExporter{async parseAsync(o,l){return new Blob([o],{type:"text/plain"})}}let _renderer,fullscreenQuadGeometry,fullscreenQuadMaterial,fullscreenQuad;function TextureUtils_decompress(d,o=1/0,l=null){fullscreenQuadGeometry||(fullscreenQuadGeometry=new three_module.bdM(2,2,1,1)),fullscreenQuadMaterial||(fullscreenQuadMaterial=new three_module.BKk({uniforms:{blitTexture:new three_module.nc$(d)},vertexShader:`
            varying vec2 vUv;
            void main(){
                vUv = uv;
                gl_Position = vec4(position.xy * 1.0,0.,.999999);
            }`,fragmentShader:`
            uniform sampler2D blitTexture; 
            varying vec2 vUv;

            void main(){ 
                gl_FragColor = vec4(vUv.xy, 0, 1);
                
                #ifdef IS_SRGB
                gl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );
                #else
                gl_FragColor = texture2D( blitTexture, vUv);
                #endif
            }`})),fullscreenQuadMaterial.uniforms.blitTexture.value=d,fullscreenQuadMaterial.defines.IS_SRGB=d.colorSpace==three_module.er$,fullscreenQuadMaterial.needsUpdate=!0,fullscreenQuad||(fullscreenQuad=new three_module.eaF(fullscreenQuadGeometry,fullscreenQuadMaterial),fullscreenQuad.frustrumCulled=!1);const c=new three_module.ubm,u=new three_module.Z58;u.add(fullscreenQuad),l||(l=_renderer=new three_module.JeP({antialias:!1})),l.setSize(Math.min(d.image.width,o),Math.min(d.image.height,o)),l.clear(),l.render(u,c);const h=new three_module.gPd(l.domElement);return h.minFilter=d.minFilter,h.magFilter=d.magFilter,h.wrapS=d.wrapS,h.wrapT=d.wrapT,h.name=d.name,_renderer&&(_renderer.dispose(),_renderer=null),h}const KHR_mesh_quantization_ExtraAttrTypes={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class GLTFExporter{constructor(){this.pluginCallbacks=[],this.register(function(o){return new GLTFLightExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsUnlitExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsTransmissionExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsVolumeExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsIorExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsSpecularExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsClearcoatExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsIridescenceExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsSheenExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsAnisotropyExtension(o)}),this.register(function(o){return new GLTFExporter_GLTFMaterialsEmissiveStrengthExtension(o)})}register(o){return this.pluginCallbacks.indexOf(o)===-1&&this.pluginCallbacks.push(o),this}unregister(o){return this.pluginCallbacks.indexOf(o)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(o),1),this}parse(o,l,c,u,h){const _=h||new GLTFWriter,A=[];for(let w=0,C=this.pluginCallbacks.length;w<C;w++)A.push(this.pluginCallbacks[w](_));_.setPlugins(A),_.write(o,l,u).catch(c)}parseAsync(o,l){const c=this;return new Promise(function(u,h){c.parse(o,u,h,l)})}}const GLTFExporter_WEBGL_CONSTANTS={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},KHR_MESH_QUANTIZATION="KHR_mesh_quantization",THREE_TO_WEBGL={};THREE_TO_WEBGL[three_module.hxR]=GLTFExporter_WEBGL_CONSTANTS.NEAREST,THREE_TO_WEBGL[three_module.pHI]=GLTFExporter_WEBGL_CONSTANTS.NEAREST_MIPMAP_NEAREST,THREE_TO_WEBGL[three_module.Cfg]=GLTFExporter_WEBGL_CONSTANTS.NEAREST_MIPMAP_LINEAR,THREE_TO_WEBGL[three_module.k6q]=GLTFExporter_WEBGL_CONSTANTS.LINEAR,THREE_TO_WEBGL[three_module.kRr]=GLTFExporter_WEBGL_CONSTANTS.LINEAR_MIPMAP_NEAREST,THREE_TO_WEBGL[three_module.$_I]=GLTFExporter_WEBGL_CONSTANTS.LINEAR_MIPMAP_LINEAR,THREE_TO_WEBGL[three_module.ghU]=GLTFExporter_WEBGL_CONSTANTS.CLAMP_TO_EDGE,THREE_TO_WEBGL[three_module.GJx]=GLTFExporter_WEBGL_CONSTANTS.REPEAT,THREE_TO_WEBGL[three_module.kTW]=GLTFExporter_WEBGL_CONSTANTS.MIRRORED_REPEAT;const GLTFExporter_PATH_PROPERTIES={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},DEFAULT_SPECULAR_COLOR=new three_module.Q1f,GLB_HEADER_BYTES=12,GLB_HEADER_MAGIC=1179937895,GLB_VERSION=2,GLB_CHUNK_PREFIX_BYTES=8,GLB_CHUNK_TYPE_JSON=1313821514,GLB_CHUNK_TYPE_BIN=5130562;function equalArray(d,o){return d.length===o.length&&d.every(function(l,c){return l===o[c]})}function stringToArrayBuffer(d){return new TextEncoder().encode(d).buffer}function isIdentityMatrix(d){return equalArray(d.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function getMinMax(d,o,l){const c={min:new Array(d.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(d.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let u=o;u<o+l;u++)for(let h=0;h<d.itemSize;h++){let _;d.itemSize>4?_=d.array[u*d.itemSize+h]:(h===0?_=d.getX(u):h===1?_=d.getY(u):h===2?_=d.getZ(u):h===3&&(_=d.getW(u)),d.normalized===!0&&(_=three_module.cj9.normalize(_,d.array))),c.min[h]=Math.min(c.min[h],_),c.max[h]=Math.max(c.max[h],_)}return c}function getPaddedBufferSize(d){return 4*Math.ceil(d/4)}function getPaddedArrayBuffer(d,o=0){const l=getPaddedBufferSize(d.byteLength);if(l!==d.byteLength){const c=new Uint8Array(l);if(c.set(new Uint8Array(d)),o!==0)for(let u=d.byteLength;u<l;u++)c[u]=o;return c.buffer}return d}function getCanvas(){return typeof document>"u"&&typeof OffscreenCanvas<"u"?new OffscreenCanvas(1,1):document.createElement("canvas")}function getToBlobPromise(d,o){if(d.toBlob!==void 0)return new Promise(c=>d.toBlob(c,o));let l;return o==="image/jpeg"?l=.92:o==="image/webp"&&(l=.8),d.convertToBlob({type:o,quality:l})}class GLTFWriter{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(o){this.plugins=o}async write(o,l,c={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1,ignoreInvalidMorphTargetTracks:!1,ignoreEmptyTextures:!1},c),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(o),await Promise.all(this.pending);const u=this,h=u.buffers,_=u.json;c=u.options;const A=u.extensionsUsed,w=u.extensionsRequired,C=new Blob(h,{type:"application/octet-stream"}),M=Object.keys(A),O=Object.keys(w);if(M.length>0&&(_.extensionsUsed=M),O.length>0&&(_.extensionsRequired=O),_.buffers&&_.buffers.length>0&&(_.buffers[0].byteLength=C.size),c.binary===!0){const ne=new FileReader;ne.readAsArrayBuffer(C),ne.onloadend=function(){const ce=getPaddedArrayBuffer(ne.result),ue=new DataView(new ArrayBuffer(GLB_CHUNK_PREFIX_BYTES));ue.setUint32(0,ce.byteLength,!0),ue.setUint32(4,GLB_CHUNK_TYPE_BIN,!0);const ye=getPaddedArrayBuffer(stringToArrayBuffer(JSON.stringify(_)),32),Oe=new DataView(new ArrayBuffer(GLB_CHUNK_PREFIX_BYTES));Oe.setUint32(0,ye.byteLength,!0),Oe.setUint32(4,GLB_CHUNK_TYPE_JSON,!0);const ke=new ArrayBuffer(GLB_HEADER_BYTES),Ve=new DataView(ke);Ve.setUint32(0,GLB_HEADER_MAGIC,!0),Ve.setUint32(4,GLB_VERSION,!0);const tt=GLB_HEADER_BYTES+Oe.byteLength+ye.byteLength+ue.byteLength+ce.byteLength;Ve.setUint32(8,tt,!0);const ht=new Blob([ke,Oe,ye,ue,ce],{type:"application/octet-stream"}),ut=new FileReader;ut.readAsArrayBuffer(ht),ut.onloadend=function(){l(ut.result)}}}else if(_.buffers&&_.buffers.length>0){const ne=new FileReader;ne.readAsDataURL(C),ne.onloadend=function(){const ce=ne.result;_.buffers[0].uri=ce,l(_)}}else l(_)}serializeUserData(o,l){if(Object.keys(o.userData).length===0)return;const c=this.options,u=this.extensionsUsed;try{const h=JSON.parse(JSON.stringify(o.userData));if(c.includeCustomExtensions&&h.gltfExtensions){l.extensions===void 0&&(l.extensions={});for(const _ in h.gltfExtensions)l.extensions[_]=h.gltfExtensions[_],u[_]=!0;delete h.gltfExtensions}Object.keys(h).length>0&&(l.extras=h)}catch(h){console.warn("THREE.GLTFExporter: userData of '"+o.name+"' won't be serialized because of JSON.stringify error - "+h.message),console.warn({...o.userData})}}getUID(o,l=!1){if(this.uids.has(o)===!1){const c=new Map;c.set(!0,this.uid++),c.set(!1,this.uid++),this.uids.set(o,c)}return this.uids.get(o).get(l)}isNormalizedNormalAttribute(o){if(this.cache.attributesNormalized.has(o))return!1;const l=new three_module.Pq0;for(let c=0,u=o.count;c<u;c++)if(Math.abs(l.fromBufferAttribute(o,c).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(o){const l=this.cache;if(l.attributesNormalized.has(o))return l.attributesNormalized.get(o);const c=o.clone(),u=new three_module.Pq0;for(let h=0,_=c.count;h<_;h++)u.fromBufferAttribute(c,h),u.x===0&&u.y===0&&u.z===0?u.setX(1):u.normalize(),c.setXYZ(h,u.x,u.y,u.z);return l.attributesNormalized.set(o,c),c}applyTextureTransform(o,l){let c=!1;const u={};l.offset.x===0&&l.offset.y===0||(u.offset=l.offset.toArray(),c=!0),l.rotation!==0&&(u.rotation=l.rotation,c=!0),l.repeat.x===1&&l.repeat.y===1||(u.scale=l.repeat.toArray(),c=!0),c&&(o.extensions=o.extensions||{},o.extensions.KHR_texture_transform=u,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(o,l){if(o===l)return o;function c(ne){return ne.colorSpace===three_module.er$?function(ce){return ce<.04045?.0773993808*ce:Math.pow(.9478672986*ce+.0521327014,2.4)}:function(ce){return ce}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),o instanceof three_module.FvD&&(o=TextureUtils_decompress(o)),l instanceof three_module.FvD&&(l=TextureUtils_decompress(l));const u=o?o.image:null,h=l?l.image:null,_=Math.max(u?u.width:0,h?h.width:0),A=Math.max(u?u.height:0,h?h.height:0),w=getCanvas();w.width=_,w.height=A;const C=w.getContext("2d");C.fillStyle="#00ffff",C.fillRect(0,0,_,A);const M=C.getImageData(0,0,_,A);if(u){C.drawImage(u,0,0,_,A);const ne=c(o),ce=C.getImageData(0,0,_,A).data;for(let ue=2;ue<ce.length;ue+=4)M.data[ue]=256*ne(ce[ue]/256)}if(h){C.drawImage(h,0,0,_,A);const ne=c(l),ce=C.getImageData(0,0,_,A).data;for(let ue=1;ue<ce.length;ue+=4)M.data[ue]=256*ne(ce[ue]/256)}C.putImageData(M,0,0);const O=(o||l).clone();return O.source=new three_module.kLi(w),O.colorSpace=three_module.jf0,O.channel=(o||l).channel,o&&l&&o.channel!==l.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),O}processBuffer(o){const l=this.json,c=this.buffers;return l.buffers||(l.buffers=[{byteLength:0}]),c.push(o),0}processBufferView(o,l,c,u,h){const _=this.json;let A;switch(_.bufferViews||(_.bufferViews=[]),l){case GLTFExporter_WEBGL_CONSTANTS.BYTE:case GLTFExporter_WEBGL_CONSTANTS.UNSIGNED_BYTE:A=1;break;case GLTFExporter_WEBGL_CONSTANTS.SHORT:case GLTFExporter_WEBGL_CONSTANTS.UNSIGNED_SHORT:A=2;break;default:A=4}const w=getPaddedBufferSize(u*o.itemSize*A),C=new DataView(new ArrayBuffer(w));let M=0;for(let ne=c;ne<c+u;ne++)for(let ce=0;ce<o.itemSize;ce++){let ue;o.itemSize>4?ue=o.array[ne*o.itemSize+ce]:(ce===0?ue=o.getX(ne):ce===1?ue=o.getY(ne):ce===2?ue=o.getZ(ne):ce===3&&(ue=o.getW(ne)),o.normalized===!0&&(ue=three_module.cj9.normalize(ue,o.array))),l===GLTFExporter_WEBGL_CONSTANTS.FLOAT?C.setFloat32(M,ue,!0):l===GLTFExporter_WEBGL_CONSTANTS.INT?C.setInt32(M,ue,!0):l===GLTFExporter_WEBGL_CONSTANTS.UNSIGNED_INT?C.setUint32(M,ue,!0):l===GLTFExporter_WEBGL_CONSTANTS.SHORT?C.setInt16(M,ue,!0):l===GLTFExporter_WEBGL_CONSTANTS.UNSIGNED_SHORT?C.setUint16(M,ue,!0):l===GLTFExporter_WEBGL_CONSTANTS.BYTE?C.setInt8(M,ue):l===GLTFExporter_WEBGL_CONSTANTS.UNSIGNED_BYTE&&C.setUint8(M,ue),M+=A}const O={buffer:this.processBuffer(C.buffer),byteOffset:this.byteOffset,byteLength:w};return h!==void 0&&(O.target=h),h===GLTFExporter_WEBGL_CONSTANTS.ARRAY_BUFFER&&(O.byteStride=o.itemSize*A),this.byteOffset+=w,_.bufferViews.push(O),{id:_.bufferViews.length-1,byteLength:0}}processBufferViewImage(o){const l=this,c=l.json;return c.bufferViews||(c.bufferViews=[]),new Promise(function(u){const h=new FileReader;h.readAsArrayBuffer(o),h.onloadend=function(){const _=getPaddedArrayBuffer(h.result),A={buffer:l.processBuffer(_),byteOffset:l.byteOffset,byteLength:_.byteLength};l.byteOffset+=_.byteLength,u(c.bufferViews.push(A)-1)}})}processBufferViewImageBuffer(o){const l=this,c=l.json;c.bufferViews||(c.bufferViews=[]),o=getPaddedArrayBuffer(o);const u={buffer:l.processBuffer(o),byteOffset:l.byteOffset,byteLength:o.byteLength};return l.byteOffset+=o.byteLength,c.bufferViews.push(u)-1}processAccessor(o,l,c,u){const h=this.json;let _;if(o.array.constructor===Float32Array)_=GLTFExporter_WEBGL_CONSTANTS.FLOAT;else if(o.array.constructor===Int32Array)_=GLTFExporter_WEBGL_CONSTANTS.INT;else if(o.array.constructor===Uint32Array)_=GLTFExporter_WEBGL_CONSTANTS.UNSIGNED_INT;else if(o.array.constructor===Int16Array)_=GLTFExporter_WEBGL_CONSTANTS.SHORT;else if(o.array.constructor===Uint16Array)_=GLTFExporter_WEBGL_CONSTANTS.UNSIGNED_SHORT;else if(o.array.constructor===Int8Array)_=GLTFExporter_WEBGL_CONSTANTS.BYTE;else{if(o.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+o.array.constructor.name);_=GLTFExporter_WEBGL_CONSTANTS.UNSIGNED_BYTE}if(c===void 0&&(c=0),u===void 0&&(u=o.count),u===0)return null;const A=getMinMax(o,c,u);let w;l!==void 0&&(w=o===l.index?GLTFExporter_WEBGL_CONSTANTS.ELEMENT_ARRAY_BUFFER:GLTFExporter_WEBGL_CONSTANTS.ARRAY_BUFFER);const C=this.processBufferView(o,_,c,u,w),M={bufferView:C.id,byteOffset:C.byteOffset,componentType:_,count:u,max:A.max,min:A.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[o.itemSize]};return o.normalized===!0&&(M.normalized=!0),h.accessors||(h.accessors=[]),h.accessors.push(M)-1}processImage(o,l,c,u="image/png",h=void 0,_=void 0){if(o!==null){const A=this,w=A.cache,C=A.json,M=A.options,O=A.pending;w.images.has(o)||w.images.set(o,{});const ne=w.images.get(o),ce=u+":flipY/"+c.toString()+(h||_?";"+h+";"+_:"");if(ne[ce]!==void 0)return ne[ce];C.images||(C.images=[]);const ue={mimeType:u},ye=getCanvas();ye.width=Math.min(h||o.width,M.maxTextureSize),ye.height=Math.min(_||o.height,M.maxTextureSize);const Oe=ye.getContext("2d");if(c===!0&&(Oe.translate(0,ye.height),Oe.scale(1,-1)),o.data!==void 0){l!==three_module.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",l),(o.width>M.maxTextureSize||o.height>M.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",o);const Ve=new Uint8ClampedArray(o.height*o.width*4);for(let tt=0;tt<Ve.length;tt+=4)Ve[tt+0]=o.data[tt+0],Ve[tt+1]=o.data[tt+1],Ve[tt+2]=o.data[tt+2],Ve[tt+3]=o.data[tt+3];Oe.putImageData(new ImageData(Ve,o.width,o.height),0,0)}else Oe.drawImage(o,0,0,ye.width,ye.height);M.binary===!0?O.push(getToBlobPromise(ye,u).then(Ve=>A.processBufferViewImage(Ve)).then(Ve=>{ue.bufferView=Ve})):ye.toDataURL!==void 0?ue.uri=ye.toDataURL(u):O.push(getToBlobPromise(ye,u).then(Ve=>new FileReader().readAsDataURL(Ve)).then(Ve=>{ue.uri=Ve}));const ke=C.images.push(ue)-1;return ne[ce]=ke,ke}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(o){const l=this.json;l.samplers||(l.samplers=[]);const c={magFilter:THREE_TO_WEBGL[o.magFilter],minFilter:THREE_TO_WEBGL[o.minFilter],wrapS:THREE_TO_WEBGL[o.wrapS],wrapT:THREE_TO_WEBGL[o.wrapT]};return l.samplers.push(c)-1}processTexture(o){const l=this.options,c=this.cache,u=this.json;if(c.textures.has(o))return c.textures.get(o);u.textures||(u.textures=[]),o instanceof three_module.FvD&&!o.source._canSerialize&&(o=TextureUtils_decompress(o,l.maxTextureSize));let h=o.userData.mimeType;h==="image/webp"&&(h="image/png"),h==="image/jpg"&&(h="image/jpeg");const _={sampler:this.processSampler(o),source:!h||["image/jpeg","image/png"].includes(h)?this.processImage(o.image,o.format,o.flipY,h):null};o.name&&(_.name=o.name),this._invokeAll(function(w){w.writeTexture&&w.writeTexture(o,_)}),_.source===null&&console.error("GLTFExporter: Unsupported mime type: "+h+". Cannot export texture.",o);const A=u.textures.push(_)-1;return c.textures.set(o,A),A}processMaterial(o){const l=this.cache,c=this.json;if(l.materials.has(o))return l.materials.get(o);if(o.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;c.materials||(c.materials=[]);const u={pbrMetallicRoughness:{}};o.isMeshStandardMaterial!==!0&&o.isMeshBasicMaterial!==!0&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const h=o.color.toArray().concat([o.opacity]);if(equalArray(h,[1,1,1,1])||(u.pbrMetallicRoughness.baseColorFactor=h),o.isMeshStandardMaterial?(u.pbrMetallicRoughness.metallicFactor=o.metalness,u.pbrMetallicRoughness.roughnessFactor=o.roughness):(u.pbrMetallicRoughness.metallicFactor=.5,u.pbrMetallicRoughness.roughnessFactor=.5),this.checkEmptyMap(o.metalnessMap)||this.checkEmptyMap(o.roughnessMap)){const A=this.buildMetalRoughTexture(o.metalnessMap,o.roughnessMap),w={index:this.processTexture(A),channel:A.channel};this.applyTextureTransform(w,A),u.pbrMetallicRoughness.metallicRoughnessTexture=w}if(this.checkEmptyMap(o.map)){const A={index:this.processTexture(o.map),texCoord:o.map.channel};this.applyTextureTransform(A,o.map),u.pbrMetallicRoughness.baseColorTexture=A}if(o.emissive){const A=o.emissive;if(Math.max(A.r,A.g,A.b)>0&&(u.emissiveFactor=o.emissive.toArray()),this.checkEmptyMap(o.emissiveMap)){const w={index:this.processTexture(o.emissiveMap),texCoord:o.emissiveMap.channel};this.applyTextureTransform(w,o.emissiveMap),u.emissiveTexture=w}}if(this.checkEmptyMap(o.normalMap)){const A={index:this.processTexture(o.normalMap),texCoord:o.normalMap.channel};o.normalScale&&o.normalScale.x!==1&&(A.scale=o.normalScale.x),this.applyTextureTransform(A,o.normalMap),u.normalTexture=A}if(this.checkEmptyMap(o.aoMap)){const A={index:this.processTexture(o.aoMap),texCoord:o.aoMap.channel};o.aoMapIntensity!==1&&(A.strength=o.aoMapIntensity),this.applyTextureTransform(A,o.aoMap),u.occlusionTexture=A}o.transparent?u.alphaMode="BLEND":o.alphaTest>0&&(u.alphaMode="MASK",u.alphaCutoff=o.alphaTest),o.side===three_module.$EB&&(u.doubleSided=!0),o.name!==""&&(u.name=o.name),this.serializeUserData(o,u),this._invokeAll(function(A){A.writeMaterial&&A.writeMaterial(o,u)});const _=c.materials.push(u)-1;return l.materials.set(o,_),_}processMesh(o){const l=this.cache,c=this.json,u=[o.geometry.uuid];if(Array.isArray(o.material))for(let tt=0,ht=o.material.length;tt<ht;tt++)u.push(o.material[tt].uuid);else u.push(o.material.uuid);const h=u.join(":");if(l.meshes.has(h))return l.meshes.get(h);const _=o.geometry;let A;A=o.isLineSegments?GLTFExporter_WEBGL_CONSTANTS.LINES:o.isLineLoop?GLTFExporter_WEBGL_CONSTANTS.LINE_LOOP:o.isLine?GLTFExporter_WEBGL_CONSTANTS.LINE_STRIP:o.isPoints?GLTFExporter_WEBGL_CONSTANTS.POINTS:o.material.wireframe?GLTFExporter_WEBGL_CONSTANTS.LINES:GLTFExporter_WEBGL_CONSTANTS.TRIANGLES;const w={},C={},M=[],O=[],ne={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},ce=_.getAttribute("normal");ce===void 0||this.isNormalizedNormalAttribute(ce)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),_.setAttribute("normal",this.createNormalizedNormalAttribute(ce)));let ue=null;for(let tt in _.attributes){if(tt.slice(0,5)==="morph")continue;const ht=_.attributes[tt];if(tt=ne[tt]||tt.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(tt)||(tt="_"+tt),l.attributes.has(this.getUID(ht))){C[tt]=l.attributes.get(this.getUID(ht));continue}ue=null;const ut=ht.array;tt!=="JOINTS_0"||ut instanceof Uint16Array||ut instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),ue=new three_module.THS(new Uint16Array(ut),ht.itemSize,ht.normalized));const _t=this.processAccessor(ue||ht,_);_t!==null&&(tt.startsWith("_")||this.detectMeshQuantization(tt,ht),C[tt]=_t,l.attributes.set(this.getUID(ht),_t))}if(ce!==void 0&&_.setAttribute("normal",ce),Object.keys(C).length===0)return null;if(o.morphTargetInfluences!==void 0&&o.morphTargetInfluences.length>0){const tt=[],ht=[],ut={};if(o.morphTargetDictionary!==void 0)for(const _t in o.morphTargetDictionary)ut[o.morphTargetDictionary[_t]]=_t;for(let _t=0;_t<o.morphTargetInfluences.length;++_t){const at={};let lt=!1;for(const pt in _.morphAttributes){if(pt!=="position"&&pt!=="normal"){lt||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),lt=!0);continue}const xt=_.morphAttributes[pt][_t],Tt=pt.toUpperCase(),Pt=_.attributes[pt];if(l.attributes.has(this.getUID(xt,!0))){at[Tt]=l.attributes.get(this.getUID(xt,!0));continue}const Lt=xt.clone();if(!_.morphTargetsRelative)for(let Bt=0,Ut=xt.count;Bt<Ut;Bt++)for(let kt=0;kt<xt.itemSize;kt++)kt===0&&Lt.setX(Bt,xt.getX(Bt)-Pt.getX(Bt)),kt===1&&Lt.setY(Bt,xt.getY(Bt)-Pt.getY(Bt)),kt===2&&Lt.setZ(Bt,xt.getZ(Bt)-Pt.getZ(Bt)),kt===3&&Lt.setW(Bt,xt.getW(Bt)-Pt.getW(Bt));at[Tt]=this.processAccessor(Lt,_),l.attributes.set(this.getUID(Pt,!0),at[Tt])}O.push(at),tt.push(o.morphTargetInfluences[_t]),o.morphTargetDictionary!==void 0&&ht.push(ut[_t])}w.weights=tt,ht.length>0&&(w.extras={},w.extras.targetNames=ht)}const ye=Array.isArray(o.material);if(ye&&_.groups.length===0)return null;const Oe=ye?o.material:[o.material],ke=ye?_.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let tt=0,ht=ke.length;tt<ht;tt++){const ut={mode:A,attributes:C};if(this.serializeUserData(_,ut),O.length>0&&(ut.targets=O),_.index!==null){let at=this.getUID(_.index);ke[tt].start===void 0&&ke[tt].count===void 0||(at+=":"+ke[tt].start+":"+ke[tt].count),l.attributes.has(at)?ut.indices=l.attributes.get(at):(ut.indices=this.processAccessor(_.index,_,ke[tt].start,ke[tt].count),l.attributes.set(at,ut.indices)),ut.indices===null&&delete ut.indices}const _t=this.processMaterial(Oe[ke[tt].materialIndex]);_t!==null&&(ut.material=_t),M.push(ut)}w.primitives=M,c.meshes||(c.meshes=[]),this._invokeAll(function(tt){tt.writeMesh&&tt.writeMesh(o,w)});const Ve=c.meshes.push(w)-1;return l.meshes.set(h,Ve),Ve}detectMeshQuantization(o,l){if(this.extensionsUsed[KHR_MESH_QUANTIZATION])return;let c;switch(l.array.constructor){case Int8Array:c="byte";break;case Uint8Array:c="unsigned byte";break;case Int16Array:c="short";break;case Uint16Array:c="unsigned short";break;default:return}l.normalized&&(c+=" normalized");const u=o.split("_",1)[0];KHR_mesh_quantization_ExtraAttrTypes[u]&&KHR_mesh_quantization_ExtraAttrTypes[u].includes(c)&&(this.extensionsUsed[KHR_MESH_QUANTIZATION]=!0,this.extensionsRequired[KHR_MESH_QUANTIZATION]=!0)}processCamera(o){const l=this.json;l.cameras||(l.cameras=[]);const c=o.isOrthographicCamera,u={type:c?"orthographic":"perspective"};return c?u.orthographic={xmag:2*o.right,ymag:2*o.top,zfar:o.far<=0?.001:o.far,znear:o.near<0?0:o.near}:u.perspective={aspectRatio:o.aspect,yfov:three_module.cj9.degToRad(o.fov),zfar:o.far<=0?.001:o.far,znear:o.near<0?0:o.near},o.name!==""&&(u.name=o.type),l.cameras.push(u)-1}processAnimation(o,l){const c=this.json,u=this.nodeMap;c.animations||(c.animations=[]);try{o=GLTFExporter.Utils.mergeMorphTargetTracks(o.clone(),l)}catch(w){if(console.warn('THREE.GLTFExporter: Could not export animation clip "%s".',o.name),!this.options.ignoreInvalidMorphTargetTracks)throw w;return console.error(w),null}const h=o.tracks,_=[],A=[];for(let w=0;w<h.length;++w){const C=h[w],M=three_module.Nwf.parseTrackName(C.name);let O=three_module.Nwf.findNode(l,M.nodeName);const ne=GLTFExporter_PATH_PROPERTIES[M.propertyName];if(M.objectName==="bones"&&(O=O.isSkinnedMesh===!0?O.skeleton.getBoneByName(M.objectIndex):void 0),!O||!ne)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',C.name),null;const ce=1;let ue,ye=C.values.length/C.times.length;ne===GLTFExporter_PATH_PROPERTIES.morphTargetInfluences&&(ye/=O.morphTargetInfluences.length),C.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline===!0?(ue="CUBICSPLINE",ye/=3):ue=C.getInterpolation()===three_module.ljd?"STEP":"LINEAR",A.push({input:this.processAccessor(new three_module.THS(C.times,ce)),output:this.processAccessor(new three_module.THS(C.values,ye)),interpolation:ue}),_.push({sampler:A.length-1,target:{node:u.get(O),path:ne}})}return c.animations.push({name:o.name||"clip_"+c.animations.length,samplers:A,channels:_}),c.animations.length-1}processSkin(o){const l=this.json,c=this.nodeMap,u=l.nodes[c.get(o)],h=o.skeleton;if(h===void 0)return null;const _=o.skeleton.bones[0];if(_===void 0)return null;const A=[],w=new Float32Array(16*h.bones.length),C=new three_module.kn4;for(let M=0;M<h.bones.length;++M)A.push(c.get(h.bones[M])),C.copy(h.boneInverses[M]),C.multiply(o.bindMatrix).toArray(w,16*M);return l.skins===void 0&&(l.skins=[]),l.skins.push({inverseBindMatrices:this.processAccessor(new three_module.THS(w,16)),joints:A,skeleton:c.get(_)}),u.skin=l.skins.length-1}processNode(o){const l=this.json,c=this.options,u=this.nodeMap;l.nodes||(l.nodes=[]);const h={};if(c.trs){const A=o.quaternion.toArray(),w=o.position.toArray(),C=o.scale.toArray();equalArray(A,[0,0,0,1])||(h.rotation=A),equalArray(w,[0,0,0])||(h.translation=w),equalArray(C,[1,1,1])||(h.scale=C)}else o.matrixAutoUpdate&&o.updateMatrix(),isIdentityMatrix(o.matrix)===!1&&(h.matrix=o.matrix.elements);if(o.name!==""&&(h.name=String(o.name)),this.serializeUserData(o,h),o.isMesh||o.isLine||o.isPoints){const A=this.processMesh(o);A!==null&&(h.mesh=A)}else o.isCamera&&(h.camera=this.processCamera(o));if(o.isSkinnedMesh&&this.skins.push(o),o.children.length>0){const A=[];for(let w=0,C=o.children.length;w<C;w++){const M=o.children[w];if(M.visible||c.onlyVisible===!1){const O=this.processNode(M);O!==null&&A.push(O)}}A.length>0&&(h.children=A)}this._invokeAll(function(A){A.writeNode&&A.writeNode(o,h)});const _=l.nodes.push(h)-1;return u.set(o,_),_}processScene(o){const l=this.json,c=this.options;l.scenes||(l.scenes=[],l.scene=0);const u={};o.name!==""&&(u.name=o.name),l.scenes.push(u);const h=[];for(let _=0,A=o.children.length;_<A;_++){const w=o.children[_];if(w.visible||c.onlyVisible===!1){const C=this.processNode(w);C!==null&&h.push(C)}}h.length>0&&(u.nodes=h),this.serializeUserData(o,u)}processObjects(o){const l=new three_module.Z58;l.name="AuxScene";for(let c=0;c<o.length;c++)l.children.push(o[c]);this.processScene(l)}processInput(o){const l=this.options;o=o instanceof Array?o:[o],this._invokeAll(function(u){u.beforeParse&&u.beforeParse(o)});const c=[];for(let u=0;u<o.length;u++)o[u]instanceof three_module.Z58?this.processScene(o[u]):c.push(o[u]);c.length>0&&this.processObjects(c);for(let u=0;u<this.skins.length;++u)this.processSkin(this.skins[u]);for(let u=0;u<l.animations.length;++u)this.processAnimation(l.animations[u],o[0]);this._invokeAll(function(u){u.afterParse&&u.afterParse(o)})}_invokeAll(o){for(let l=0,c=this.plugins.length;l<c;l++)o(this.plugins[l])}checkEmptyMap(o){return!(!o||this.options.ignoreEmptyTextures&&!o.image)}}class GLTFLightExtension{constructor(o){this.writer=o,this.name="KHR_lights_punctual"}writeNode(o,l){if(!o.isLight)return;if(!o.isDirectionalLight&&!o.isPointLight&&!o.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",o);const c=this.writer,u=c.json,h=c.extensionsUsed,_={};o.name&&(_.name=o.name),_.color=o.color.toArray(),_.intensity=o.intensity,o.isDirectionalLight?_.type="directional":o.isPointLight?(_.type="point",o.distance>0&&(_.range=o.distance)):o.isSpotLight&&(_.type="spot",o.distance>0&&(_.range=o.distance),_.spot={},_.spot.innerConeAngle=(1-o.penumbra)*o.angle,_.spot.outerConeAngle=o.angle),o.decay!==void 0&&o.decay!==2&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!o.target||o.target.parent===o&&o.target.position.x===0&&o.target.position.y===0&&o.target.position.z===-1||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),h[this.name]||(u.extensions=u.extensions||{},u.extensions[this.name]={lights:[]},h[this.name]=!0);const A=u.extensions[this.name].lights;A.push(_),l.extensions=l.extensions||{},l.extensions[this.name]={light:A.length-1}}}class GLTFExporter_GLTFMaterialsUnlitExtension{constructor(o){this.writer=o,this.name="KHR_materials_unlit"}writeMaterial(o,l){if(!o.isMeshBasicMaterial)return;const c=this.writer.extensionsUsed;l.extensions=l.extensions||{},l.extensions[this.name]={},c[this.name]=!0,l.pbrMetallicRoughness.metallicFactor=0,l.pbrMetallicRoughness.roughnessFactor=.9}}class GLTFExporter_GLTFMaterialsClearcoatExtension{constructor(o){this.writer=o,this.name="KHR_materials_clearcoat"}writeMaterial(o,l){if(!o.isMeshPhysicalMaterial||o.clearcoat===0)return;const c=this.writer,u=c.extensionsUsed,h={};if(h.clearcoatFactor=o.clearcoat,c.checkEmptyMap(o.clearcoatMap)){const _={index:c.processTexture(o.clearcoatMap),texCoord:o.clearcoatMap.channel};c.applyTextureTransform(_,o.clearcoatMap),h.clearcoatTexture=_}if(h.clearcoatRoughnessFactor=o.clearcoatRoughness,c.checkEmptyMap(o.clearcoatRoughnessMap)){const _={index:c.processTexture(o.clearcoatRoughnessMap),texCoord:o.clearcoatRoughnessMap.channel};c.applyTextureTransform(_,o.clearcoatRoughnessMap),h.clearcoatRoughnessTexture=_}if(c.checkEmptyMap(o.clearcoatNormalMap)){const _={index:c.processTexture(o.clearcoatNormalMap),texCoord:o.clearcoatNormalMap.channel};c.applyTextureTransform(_,o.clearcoatNormalMap),h.clearcoatNormalTexture=_}l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFExporter_GLTFMaterialsIridescenceExtension{constructor(o){this.writer=o,this.name="KHR_materials_iridescence"}writeMaterial(o,l){if(!o.isMeshPhysicalMaterial||o.iridescence===0)return;const c=this.writer,u=c.extensionsUsed,h={};if(h.iridescenceFactor=o.iridescence,c.checkEmptyMap(o.iridescenceMap)){const _={index:c.processTexture(o.iridescenceMap),texCoord:o.iridescenceMap.channel};c.applyTextureTransform(_,o.iridescenceMap),h.iridescenceTexture=_}if(h.iridescenceIor=o.iridescenceIOR,h.iridescenceThicknessMinimum=o.iridescenceThicknessRange[0],h.iridescenceThicknessMaximum=o.iridescenceThicknessRange[1],c.checkEmptyMap(o.iridescenceThicknessMap)){const _={index:c.processTexture(o.iridescenceThicknessMap),texCoord:o.iridescenceThicknessMap.channel};c.applyTextureTransform(_,o.iridescenceThicknessMap),h.iridescenceThicknessTexture=_}l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFExporter_GLTFMaterialsTransmissionExtension{constructor(o){this.writer=o,this.name="KHR_materials_transmission"}writeMaterial(o,l){if(!o.isMeshPhysicalMaterial||o.transmission===0)return;const c=this.writer,u=c.extensionsUsed,h={};if(h.transmissionFactor=o.transmission,c.checkEmptyMap(o.transmissionMap)){const _={index:c.processTexture(o.transmissionMap),texCoord:o.transmissionMap.channel};c.applyTextureTransform(_,o.transmissionMap),h.transmissionTexture=_}l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFExporter_GLTFMaterialsVolumeExtension{constructor(o){this.writer=o,this.name="KHR_materials_volume"}writeMaterial(o,l){if(!o.isMeshPhysicalMaterial||o.transmission===0)return;const c=this.writer,u=c.extensionsUsed,h={};if(h.thicknessFactor=o.thickness,c.checkEmptyMap(o.thicknessMap)){const _={index:c.processTexture(o.thicknessMap),texCoord:o.thicknessMap.channel};c.applyTextureTransform(_,o.thicknessMap),h.thicknessTexture=_}h.attenuationDistance=o.attenuationDistance,h.attenuationColor=o.attenuationColor.toArray(),l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFExporter_GLTFMaterialsIorExtension{constructor(o){this.writer=o,this.name="KHR_materials_ior"}writeMaterial(o,l){if(!o.isMeshPhysicalMaterial||o.ior===1.5)return;const c=this.writer.extensionsUsed,u={};u.ior=o.ior,l.extensions=l.extensions||{},l.extensions[this.name]=u,c[this.name]=!0}}class GLTFExporter_GLTFMaterialsSpecularExtension{constructor(o){this.writer=o,this.name="KHR_materials_specular"}writeMaterial(o,l){if(!o.isMeshPhysicalMaterial||o.specularIntensity===1&&o.specularColor.equals(DEFAULT_SPECULAR_COLOR)&&!o.specularIntensityMap&&!o.specularColorTexture)return;const c=this.writer,u=c.extensionsUsed,h={};if(c.checkEmptyMap(o.specularIntensityMap)){const _={index:c.processTexture(o.specularIntensityMap),texCoord:o.specularIntensityMap.channel};c.applyTextureTransform(_,o.specularIntensityMap),h.specularTexture=_}if(c.checkEmptyMap(o.specularColorMap)){const _={index:c.processTexture(o.specularColorMap),texCoord:o.specularColorMap.channel};c.applyTextureTransform(_,o.specularColorMap),h.specularColorTexture=_}h.specularFactor=o.specularIntensity,h.specularColorFactor=o.specularColor.toArray(),l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFExporter_GLTFMaterialsSheenExtension{constructor(o){this.writer=o,this.name="KHR_materials_sheen"}writeMaterial(o,l){if(!o.isMeshPhysicalMaterial||o.sheen<.001)return;const c=this.writer,u=c.extensionsUsed,h={};if(c.checkEmptyMap(o.sheenRoughnessMap)){const _={index:c.processTexture(o.sheenRoughnessMap),texCoord:o.sheenRoughnessMap.channel};c.applyTextureTransform(_,o.sheenRoughnessMap),h.sheenRoughnessTexture=_}if(c.checkEmptyMap(o.sheenColorMap)){const _={index:c.processTexture(o.sheenColorMap),texCoord:o.sheenColorMap.channel};c.applyTextureTransform(_,o.sheenColorMap),h.sheenColorTexture=_}h.sheenRoughnessFactor=o.sheenRoughness,h.sheenColorFactor=o.sheenColor.toArray(),l.extensions=l.extensions||{},l.extensions[this.name]=h,l.extras=l.extras||{},l.extras.sheenFactor=o.sheen,u[this.name]=!0}}class GLTFExporter_GLTFMaterialsAnisotropyExtension{constructor(o){this.writer=o,this.name="KHR_materials_anisotropy"}writeMaterial(o,l){if(!o.isMeshPhysicalMaterial||o.anisotropy==0)return;const c=this.writer,u=c.extensionsUsed,h={};if(c.checkEmptyMap(o.anisotropyMap)){const _={index:c.processTexture(o.anisotropyMap)};c.applyTextureTransform(_,o.anisotropyMap),h.anisotropyTexture=_}h.anisotropyStrength=o.anisotropy,h.anisotropyRotation=o.anisotropyRotation,l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFExporter_GLTFMaterialsEmissiveStrengthExtension{constructor(o){this.writer=o,this.name="KHR_materials_emissive_strength"}writeMaterial(o,l){if(!o.isMeshStandardMaterial||o.emissiveIntensity===1)return;const c=this.writer.extensionsUsed,u={};u.emissiveStrength=o.emissiveIntensity,l.extensions=l.extensions||{},l.extensions[this.name]=u,c[this.name]=!0}}GLTFExporter.Utils={GLTFWriter,insertKeyframe:function(d,o){const c=d.getValueSize(),u=new d.TimeBufferType(d.times.length+1),h=new d.ValueBufferType(d.values.length+c),_=d.createInterpolant(new d.ValueBufferType(c));let A;if(d.times.length===0){u[0]=o;for(let w=0;w<c;w++)h[w]=0;A=0}else if(o<d.times[0]){if(Math.abs(d.times[0]-o)<.001)return 0;u[0]=o,u.set(d.times,1),h.set(_.evaluate(o),0),h.set(d.values,c),A=0}else if(o>d.times[d.times.length-1]){if(Math.abs(d.times[d.times.length-1]-o)<.001)return d.times.length-1;u[u.length-1]=o,u.set(d.times,0),h.set(d.values,0),h.set(_.evaluate(o),d.values.length),A=u.length-1}else for(let w=0;w<d.times.length;w++){if(Math.abs(d.times[w]-o)<.001)return w;if(d.times[w]<o&&d.times[w+1]>o){u.set(d.times.slice(0,w+1),0),u[w+1]=o,u.set(d.times.slice(w+1),w+2),h.set(d.values.slice(0,(w+1)*c),0),h.set(_.evaluate(o),(w+1)*c),h.set(d.values.slice((w+1)*c),(w+2)*c),A=w+1;break}}return d.times=u,d.values=h,A},mergeMorphTargetTracks:function(d,o){const l=[],c={},u=d.tracks;for(let h=0;h<u.length;++h){let _=u[h];const A=three_module.Nwf.parseTrackName(_.name),w=three_module.Nwf.findNode(o,A.nodeName);if(A.propertyName!=="morphTargetInfluences"||A.propertyIndex===void 0){l.push(_);continue}if(_.createInterpolant!==_.InterpolantFactoryMethodDiscrete&&_.createInterpolant!==_.InterpolantFactoryMethodLinear){if(_.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),_=_.clone(),_.setInterpolation(three_module.PJ3)}const C=w.morphTargetInfluences.length,M=w.morphTargetDictionary[A.propertyIndex];if(M===void 0)throw new Error("THREE.GLTFExporter: Morph target name not found: "+A.propertyIndex);let O;if(c[w.uuid]===void 0){O=_.clone();const ce=new O.ValueBufferType(C*O.times.length);for(let ue=0;ue<O.times.length;ue++)ce[ue*C+M]=O.values[ue];O.name=(A.nodeName||"")+".morphTargetInfluences",O.values=ce,c[w.uuid]=O,l.push(O);continue}const ne=_.createInterpolant(new _.ValueBufferType(1));O=c[w.uuid];for(let ce=0;ce<O.times.length;ce++)O.values[ce*C+M]=ne.evaluate(O.times[ce]);for(let ce=0;ce<_.times.length;ce++){const ue=this.insertKeyframe(O,_.times[ce]);O.values[ue*C+M]=_.values[ce]}}return d.tracks=l,d}};class GLTFWriter2 extends GLTFExporter.Utils.GLTFWriter{constructor(){super(...arguments),this._defaultMaterial=new three_module._4j}serializeUserData(o,l){const c=o.userData,u={};c.__disposed&&console.error("Serializing a disposed object",o),Object.entries(c).forEach(([_,A])=>{(!A||typeof A=="function"||A.isObject3D||A.isTexture||A.isMaterial||A.assetType!=null||_.startsWith("_")||_!=="uuid"&&(iGeometryIgnoredUserData.includes(_)||iModelIgnoredUserData.includes(_)||iMaterialIgnoredUserData.includes(_)))&&(u[_]=A,delete c[_])});const h=serializeObject(c,!1);Object.entries(u).forEach(([_,A])=>{c[_]=A,delete u[_]}),o.userData=h,super.serializeUserData(o,l),o.userData=c}processObjects(o){var l;o.length===1&&(!((l=o[0])===null||l===void 0)&&l.userData.rootSceneModelRoot)?this.processScene(o[0]):super.processObjects(o)}processMaterial(o){if(this.cache.materials.has(o))return this.cache.materials.get(o);let l=o;l&&!l.isShaderMaterial||(l=this._defaultMaterial);const c=super.processMaterial(l);if(c===null)return console.error("GLTFWriter2: Unexpected error: Failed to process material",o),null;if(!o||l===o)return c;const u=JSON.stringify(this.json.materials[c]),h=JSON.parse(u);this.serializeUserData(o,h),this._invokeAll(A=>{A.writeMaterial&&A.writeMaterial(o,h)});const _=this.json.materials.push(h)-1;return this.cache.materials.set(o,_),_}processImageBlob(o,l){if(!o)return-1;const c=this.cache,u=this.options,h=this.pending,_=this.json,A=l.image;c.images.has(A)||c.images.set(A,{});const w=c.images.get(A),C=o.type+":flipY/"+l.flipY.toString();if(w[C]!==void 0)return w[C];_.images||(_.images=[]);const M={mimeType:o.type};u.binary===!0?h.push(new Promise(ne=>{this.processBufferViewImage(o).then(ce=>{M.bufferView=ce,ne()})})):h.push(q(o).then(ne=>{M.uri=ne}));const O=_.images.push(M)-1;return w[C]=O,O}processSampler(o){return super.processSampler(o)}processTexture(o){const l=this.cache,c=this.json;if(l.textures.has(o))return l.textures.get(o);const u=o.source.data,h=o.userData.mimeType;o.userData.rootPath&&!this.options.embedUrlImages&&(o.userData.rootPath.startsWith("http")||o.userData.rootPath.startsWith("data:"))&&(o.source.data&&(!this.options.exporterOptions.embedUrlImagePreviews||o.isDataTexture?o.source.data=null:o.source.data._savePreview=!0),delete o.userData.mimeType);const _=super.processTexture(o),A=c.textures[_];if(!A)return console.error("No texture def",_,o),_;const w=c.images?c.images[A.source]:null;if(w&&(w.extras||(w.extras={}),o.source&&(w.extras.uuid=o.source.uuid),w.extras.t_uuid=o.uuid),o.userData.rootPath&&!this.options.embedUrlImages&&(o.userData.rootPath.startsWith("http")||o.userData.rootPath.startsWith("data:"))){if(o.source.data?delete o.source.data._savePreview:o.source.data=u,o.userData.mimeType=h,!A)return console.error("textureDef is null",_,o),_;if(A.source>=0){const C=this.json.images[A.source];C.uri?console.warn("GLTFWriter2: uri already set",C.uri):(C.uri=o.userData.rootPath,C.mimeType=h,C.extras||(C.extras={}),C.extras.flipY=o.flipY,C.extras.uri=o.userData.rootPath)}else A.source=this.processImageUri(o.image,o.userData.rootPath,o.flipY,h)}return A.source<0&&(console.error("textureDef.source cannot be saved",A,o),delete A.source),_}processImage(o,l,c,u="image/png"){return o?super.processImage(o,l,c,u,o._savePreview?32:void 0,o._savePreview?32:void 0):-1}processImageUri(o,l,c,u="image/png"){const h=this.cache,_=this.json;h.images.has(o)||h.images.set(o,{});const A=h.images.get(o),w=u+":flipY/"+c.toString();if(A[w]!==void 0)return A[w];_.images||(_.images=[]);const C={mimeType:u,uri:l,extras:{flipY:c}},M=_.images.push(C)-1;return A[w]=M,M}}async function setInnerHTMLWithScripts(d,o){var l;d.innerHTML=o;const c=d.getElementsByTagName("script");for(let u=0;u<c.length;u++){const h=c[u],_=cloneScriptTag(h);let A=!1;await new Promise(w=>{_.onload=w,_.onerror=()=>{A=!0,w(void 0)}}),A||(l=h.parentNode)===null||l===void 0||l.replaceChild(_,h)}}function cloneScriptTag(d,o){(o=o??document.createElement("script")).type=d.type||"text/javascript",o.text=d.text;for(let l=0;l<d.attributes.length;l++){const c=d.attributes[l];o.setAttribute(c.name,c.value)}return o}function dom_getPaddedArrayBuffer(d,o=0){const l=dom_getPaddedBufferSize(d.byteLength);if(l!==d.byteLength){const c=new Uint8Array(l);if(c.set(new Uint8Array(d)),o!==0)for(let u=d.byteLength;u<l;u++)c[u]=o;return c.buffer}return d}function dom_getPaddedBufferSize(d){return 4*Math.ceil(d/4)}ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(d,o){const l=new Uint8Array(this);o==null&&(o=l.length);const c=new ArrayBuffer(o-(d||0)),u=new Uint8Array(c);for(let h=0;h<u.length;h++)u[h]=l[h+(d||0)];return c});const dom_GLB_HEADER_BYTES=12,dom_GLB_HEADER_MAGIC=1179937895,dom_GLB_VERSION=2,dom_GLB_CHUNK_PREFIX_BYTES=8,dom_GLB_CHUNK_TYPE_JSON=1313821514,dom_GLB_CHUNK_TYPE_BIN=5130562;function makeGLBFile(d,o){const l=dom_getPaddedArrayBuffer(d),c=new DataView(new ArrayBuffer(dom_GLB_CHUNK_PREFIX_BYTES));c.setUint32(0,l.byteLength,!0),c.setUint32(4,dom_GLB_CHUNK_TYPE_BIN,!0);const u=dom_getPaddedArrayBuffer(new TextEncoder().encode(JSON.stringify(o||{})).buffer,32),h=new DataView(new ArrayBuffer(dom_GLB_CHUNK_PREFIX_BYTES));h.setUint32(0,u.byteLength,!0),h.setUint32(4,dom_GLB_CHUNK_TYPE_JSON,!0);const _=new ArrayBuffer(dom_GLB_HEADER_BYTES),A=new DataView(_);A.setUint32(0,dom_GLB_HEADER_MAGIC,!0),A.setUint32(4,dom_GLB_VERSION,!0);const w=dom_GLB_HEADER_BYTES+h.byteLength+u.byteLength+c.byteLength+l.byteLength;A.setUint32(8,w,!0);const C=new Blob([_,h,u,c,l],{type:"application/octet-stream"});return C.ext="glb",C}class GLTFExporter2 extends GLTFExporter{register(o){return super.register(o)}async parseAsync(o,l){var c;if(!o)throw new Error("No object to export");const u=o.__isGLTFOutput||!Array.isArray(o)&&!o.isObject3D?o:await new Promise((h,_)=>this.parse(o,h,_,l));if(u&&typeof u=="object"&&!u.byteLength)return new Blob([JSON.stringify(u,(h,_)=>h.startsWith("__")?void 0:_,(c=l.jsonSpaces)!==null&&c!==void 0?c:2)],{type:"model/gltf+json"});if(u){let h=null;return l.encrypt&&(!l.encryptKey&&window.prompt&&(l.encryptKey=window.prompt("GLTFEncryption: Enter encryption key")||""),l.encryptKey?h=makeGLBFile(await Te(new Uint8Array(u),l.encryptKey),{asset:{version:"2.0",generator:"WebGiGLBWrapper",encryption:{type:"aesgcm",version:1}}}):console.warn("WebGi GLTF Export: encryption key not provided, skipping encryption")),h||(h=new Blob([u],{type:"model/gltf+binary"})),h}throw new Error("GLTFExporter2.parse() failed")}parse(o,l,c,u={}){var h,_,A,w,C,M,O;const ne={binary:!1,trs:(h=u.trs)!==null&&h!==void 0&&h,onlyVisible:(_=u.onlyVisible)!==null&&_!==void 0&&_,truncateDrawRange:(A=u.truncateDrawRange)===null||A===void 0||A,externalImagesInExtras:!u.embedUrlImages&&u.externalImagesInExtras||!1,embedUrlImages:(w=u.embedUrlImages)!==null&&w!==void 0&&w,maxTextureSize:(C=u.maxTextureSize)!==null&&C!==void 0?C:1/0,animations:(M=u.animations)!==null&&M!==void 0?M:[],includeCustomExtensions:(O=u.includeCustomExtensions)===null||O===void 0||O,exporterOptions:u,ignoreInvalidMorphTargetTracks:u.ignoreInvalidMorphTargetTracks,ignoreEmptyTextures:u.ignoreEmptyTextures};return u.exportExt==="glb"&&(ne.binary=!0),u.preserveUUIDs!==!1&&(Array.isArray(o)?o:[o]).forEach(ce=>ce.traverse(ue=>{ue.uuid&&(ue.userData.gltfUUID=ue.uuid)})),(Array.isArray(o)?o:[o]).forEach(ce=>ce.traverse(ue=>{if(ue.animations)for(const ye of ue.animations)ye.__gltfExport===!1||ne.animations.includes(ye)||ne.animations.push(...ue.animations)})),super.parse(o,ce=>{u.preserveUUIDs!==!1&&(Array.isArray(o)?o:[o]).forEach(ue=>ue.traverse(ye=>{delete ye.userData.gltfUUID})),l(Object.assign(ce,{__isGLTFOutput:!0}))},c,ne,new GLTFWriter2)}}function processViewer(d,o){const l=d.getPlugin(AssetManagerPlugin).exportViewerConfig();o.json.textures&&o.json.samplers&&o.json.images&&l.resources.textures&&[...Object.entries(l.resources.textures)].forEach(([u,h])=>{o.json.textures.find(A=>{var w,C,M,O,ne;return((w=A.extras)===null||w===void 0?void 0:w.uuid)===u||((M=(C=o.json.samplers[A.sampler])===null||C===void 0?void 0:C.extras)===null||M===void 0?void 0:M.uuid)===u||((ne=(O=o.json.images[A.source])===null||O===void 0?void 0:O.extras)===null||ne===void 0?void 0:ne.t_uuid)===u})&&(h.image&&l.resources.images&&l.resources.images[h.image]&&delete l.resources.images[h.image],l.resources.textures[u]={})}),o.json.materials&&l.resources.materials&&[...Object.entries(l.resources.materials)].forEach(([u,h])=>{o.json.materials.find(A=>{var w;return((w=A.extras)===null||w===void 0?void 0:w.uuid)===u})&&(l.resources.materials[u]={})});const c=[];Object.values(l.resources).forEach(u=>{u&&Object.values(u).forEach(h=>{h.url&&(h.url.type==="Uint16Array"&&h.url.data?(h.url.data instanceof Uint16Array||(h.url.data=new Uint16Array(h.url.data)),c.push(h.url)):h.url.type==="Uint8Array"&&h.url.data&&(h.url.data instanceof Uint8Array||(h.url.data=new Uint8Array(h.url.data)),c.push(h.url)))})});for(const u of c){let h="application/octet-stream";if(u.mimeType&&(h=u.mimeType),o.options.exporterOptions.encodeUint16Rgbe&&u.type==="Uint16Array"&&u.width>0&&u.height>0){const C=halfFloatToRgbe(u.data,4),M=new ImageData(C,u.width,u.height),O=three_module.HgN.getDataURL(M,!0).split(",")[1],ne=2;h="image/png",ne===1||(u.data=Uint8Array.from(atob(O),ce=>ce.charCodeAt(0))),u.encoding="rgbe",u.encodingVersion=ne}o.json.images||(o.json.images=[]);const _={mimeType:h},A=o.json.images.push(_)-1,w=u.data;_.bufferView=o.processBufferViewImageBuffer(w),u.data={image:A}}return l}function halfFloatToRgbe(d,o=3,l){let c,u,h,_,A;const w=d.byteLength/(2*o)|0;l=l||new Uint8ClampedArray(4*w);for(let C=0;C<w;C++){c=d[C*o],u=d[C*o+1],h=d[C*o+2],_=Math.max(Math.max(c,u),h);const M=Math.ceil(Math.log2(_));A=Math.pow(2,M-8),l[4*C]=c/A|0,l[4*C+1]=u/A|0,l[4*C+2]=h/A|0,l[4*C+3]=M+128}return l}function addGLTFExporter(d,o,l=GLTFExporter2,c){var u;if(!o)return;const h=d.Exporters.findIndex(A=>A.ext.includes("gltf")||A.ext.includes("glb")),_=[];h>=0?(_.push(...(u=d.Exporters[h].extensions)!==null&&u!==void 0?u:[]),d.Exporters.splice(h,1)):(_.push(gltfMaterialExtrasWriter),_.push(gltfObject3DExtrasWriter),_.push(gltfLightExtrasWriter),_.push(A=>new GLTFMeshGpuInstancingExporter(A)),_.push(A=>new GLTFMaterialsBumpMapExtensionExport(A)),_.push(A=>new GLTFMaterialsDisplacementMapExtensionExport(A)),_.push(A=>new GLTFMaterialsLightMapExtensionExport(A)),_.push(A=>new GLTFMaterialsAlphaMapExtensionExport(A))),d.Exporters.push({ctor:()=>{const A=new l;return _.forEach(w=>A.register(w)),A.register(w=>({afterParse:C=>{var M,O;if(!(!((M=(C=Array.isArray(C)?C[0]:C)==null?void 0:C.userData)===null||M===void 0)&&M.rootSceneModelRoot)||((O=C==null?void 0:C.userData)===null||O===void 0?void 0:O.__exportViewerConfig)===!1)return;const ne=w.json.scenes[w.json.scene||0];ne.extensions||(ne.extensions={}),ne.extensions[viewerGLTFExtension]=processViewer(o,w),w.extensionsUsed[viewerGLTFExtension]=!0}})),c==null||c(A),A},ext:["gltf","glb"],extensions:_})}const gltfLightExtrasWriter=d=>({writeNode:(o,l)=>{if(!(o!=null&&o.isLight))return;l.extensions||(l.extensions={});const c={};o.shadow&&(c.shadow=o.shadow.toJSON()),Object.keys(c).length>0&&(l.extensions[webgiLightExtrasExtension]=c,d.extensionsUsed[webgiLightExtrasExtension]=!0)}}),gltfObject3DExtrasWriter=d=>({writeNode:(o,l)=>{if(!(o!=null&&o.isObject3D))return;l.extensions||(l.extensions={});const c={};o.castShadow!==void 0&&(c.castShadow=o.castShadow),o.receiveShadow!==void 0&&(c.receiveShadow=o.receiveShadow),o.visible===!1&&(c.visible=!1),o.frustumCulled===!1&&(c.frustumCulled=!1),o.renderOrder!==0&&(c.renderOrder=o.renderOrder),o.layers.mask!==1&&(c.layers=o.layers.mask),o.matrixAutoUpdate===!1&&(c.matrixAutoUpdate=!1),Object.keys(c).length>0&&(l.extensions[webgiObject3DExtrasExtension]=c,d.extensionsUsed[webgiObject3DExtrasExtension]=!0)}}),gltfMaterialExtrasWriter=d=>({writeMaterial(o,l){if(!(o!=null&&o.isMaterial))return;l.extensions||(l.extensions={});const c={};o.fog!==void 0&&(c.fog=o.fog),o.flatShading!==void 0&&(c.flatShading=o.flatShading),o.blending!==void 0&&(c.blending=o.blending),o.side!==void 0&&o.side!==three_module.$EB&&(c.side=o.side),o.shadowSide!==void 0&&(c.shadowSide=o.shadowSide),o.depthFunc!==void 0&&(c.depthFunc=o.depthFunc),o.depthTest!==void 0&&(c.depthTest=o.depthTest),o.depthWrite!==void 0&&(c.depthWrite=o.depthWrite),o.colorWrite!==void 0&&(c.colorWrite=o.colorWrite),o.vertexColors!==void 0&&(c.vertexColors=o.vertexColors),o.alphaTest!==void 0&&(c.alphaTest=o.alphaTest),o.alphaHash!==void 0&&(c.alphaHash=o.alphaHash),o.envMapIntensity!==void 0&&(c.envMapIntensity=o.envMapIntensity),o.wireframe!==void 0&&(c.wireframe=o.wireframe),o.wireframeLinewidth!==void 0&&(c.wireframeLinewidth=o.wireframeLinewidth),o.wireframeLinecap!==void 0&&(c.wireframeLinecap=o.wireframeLinecap),o.wireframeLinejoin!==void 0&&(c.wireframeLinejoin=o.wireframeLinejoin),o.rotation!==void 0&&(c.rotation=o.rotation),o.polygonOffset!==void 0&&(c.polygonOffset=o.polygonOffset),o.polygonOffsetFactor!==void 0&&(c.polygonOffsetFactor=o.polygonOffsetFactor),o.polygonOffsetUnits!==void 0&&(c.polygonOffsetUnits=o.polygonOffsetUnits),o.dithering!==void 0&&(c.dithering=o.dithering),o.alphaToCoverage!==void 0&&(c.alphaToCoverage=o.alphaToCoverage),o.premultipliedAlpha!==void 0&&(c.premultipliedAlpha=o.premultipliedAlpha),o.toneMapped!==void 0&&(c.toneMapped=o.toneMapped),o.normalScale!==void 0&&(c.normalScale=[o.normalScale.x,o.normalScale.y]);const u=this.materialExternalResources[o.uuid];u&&Object.entries(u).forEach(([h,_])=>{var A;h.startsWith("_")||(_!=null&&_.userData&&(_.userData.__embedUrlImagePreviews=(A=d.options.exporterOptions)===null||A===void 0?void 0:A.embedUrlImagePreviews),c[h]=serializeObject(_,!1,this.serializedMeta),_!=null&&_.userData&&delete _.userData.__embedUrlImagePreviews)}),Object.keys(c).length>0&&(l.extensions[webgiMaterialExtrasExtension]=c,d.extensionsUsed[webgiMaterialExtrasExtension]=!0)},materialExternalResources:{},serializedMeta:{images:{},textures:{}},beforeParse(o){if(this.materialExternalResources={},!d.options.externalImagesInExtras)return;const l=[];(Array.isArray(o)?o:[o]).forEach(c=>{c==null||c.traverse(u=>{var h;u&&(!((h=u.material)===null||h===void 0)&&h.isMaterial)&&l.push(u.material)})}),l.forEach(c=>{c&&(this.materialExternalResources[c.uuid]||(this.materialExternalResources[c.uuid]={}),this.materialExternalResources[c.uuid].__materialRef=c,Object.entries(c).forEach(([u,h])=>{u.startsWith("_")||h&&h.isTexture&&h.userData.rootPath&&(h.userData.rootPath.startsWith("http")||h.userData.rootPath.startsWith("data:"))&&(c[u]=null,this.materialExternalResources[c.uuid][u]=h)}))})},afterParse(o){const l=Object.values(this.materialExternalResources);if(l.length<1)return;l.forEach(u=>{const h=u.__materialRef;h&&(Object.entries(u).forEach(([_,A])=>{_.startsWith("_")||A&&(h[_]=A)}),delete this.materialExternalResources[h.uuid])});const c=d.json.scenes[d.json.scene||0];c.extensions||(c.extensions={}),c.extensions[webgiMaterialExtrasExtension]={resources:this.serializedMeta},d.extensionsUsed[webgiMaterialExtrasExtension]=!0}});class GLTFMaterialsBumpMapExtensionExport{constructor(o){this.writer=o,this.name=GLTFMaterialsBumpMapExtensionName}writeMaterial(o,l){if(!o.isMeshStandardMaterial||o.bumpScale===0)return;const c=this.writer,u=c.extensionsUsed,h={};if(h.bumpScale=o.bumpScale,o.bumpMap&&c.checkEmptyMap(o.bumpMap)){const _={index:c.processTexture(o.bumpMap)};c.applyTextureTransform(_,o.bumpMap),h.bumpTexture=_}l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFMaterialsDisplacementMapExtensionExport{constructor(o){this.writer=o,this.name=GLTFMaterialsDisplacementMapExtensionName}writeMaterial(o,l){if(!o.isMeshStandardMaterial||o.displacementScale===0)return;const c=this.writer,u=c.extensionsUsed,h={};if(h.displacementScale=o.displacementScale,h.displacementBias=o.displacementBias,o.displacementMap&&c.checkEmptyMap(o.displacementMap)){const _={index:c.processTexture(o.displacementMap)};c.applyTextureTransform(_,o.displacementMap),h.displacementTexture=_}l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFMaterialsLightMapExtensionExport{constructor(o){this.writer=o,this.name=GLTFMaterialsLightMapExtensionName}writeMaterial(o,l){if(!o.isMeshStandardMaterial||o.lightMapIntensity===0)return;const c=this.writer,u=c.extensionsUsed,h={};if(h.lightMapIntensity=o.lightMapIntensity,o.lightMap&&c.checkEmptyMap(o.lightMap)){const _={index:c.processTexture(o.lightMap)};c.applyTextureTransform(_,o.lightMap),h.lightMapTexture=_}l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}class GLTFMaterialsAlphaMapExtensionExport{constructor(o){this.writer=o,this.name=GLTFMaterialsAlphaMapExtensionName}writeMaterial(o,l){if(!o.isMeshStandardMaterial||!o.alphaMap)return;const c=this.writer,u=c.extensionsUsed,h={};if(c.checkEmptyMap(o.alphaMap)){const _={index:c.processTexture(o.alphaMap)};c.applyTextureTransform(_,o.alphaMap),h.alphaTexture=_}l.extensions=l.extensions||{},l.extensions[this.name]=h,u[this.name]=!0}}const textEncoder=new TextEncoder,ZIP_COMPRESSION=3;class EXRExporter{parse(o,l,c){if(!o||!o.isWebGLRenderer&&!o.isDataTexture)throw Error("EXRExporter.parse: Unsupported first parameter, expected instance of WebGLRenderer or DataTexture.");if(o.isWebGLRenderer){const u=o,h=l,_=c;supportedRTT(h);const A=buildInfoRTT(h,_);return fillData(compressData(reorganizeDataBuffer(getPixelData(u,h,A),A),A),A)}if(o.isDataTexture){const u=o,h=l;supportedDT(u);const _=buildInfoDT(u,h);return fillData(compressData(reorganizeDataBuffer(u.image.data,_),_),_)}}}function supportedRTT(d){if(!d||!d.isWebGLRenderTarget)throw Error("EXRExporter.parse: Unsupported second parameter, expected instance of WebGLRenderTarget.");if(d.isWebGLCubeRenderTarget||d.isWebGL3DRenderTarget||d.isWebGLArrayRenderTarget)throw Error("EXRExporter.parse: Unsupported render target type, expected instance of WebGLRenderTarget.");if(d.texture.type!==three_module.RQf&&d.texture.type!==three_module.ix0)throw Error("EXRExporter.parse: Unsupported WebGLRenderTarget texture type.");if(d.texture.format!==three_module.GWd)throw Error("EXRExporter.parse: Unsupported WebGLRenderTarget texture format, expected RGBAFormat.")}function supportedDT(d){if(d.type!==three_module.RQf&&d.type!==three_module.ix0)throw Error("EXRExporter.parse: Unsupported DataTexture texture type.");if(d.format!==three_module.GWd)throw Error("EXRExporter.parse: Unsupported DataTexture texture format, expected RGBAFormat.");if(!d.image.data)throw Error("EXRExporter.parse: Invalid DataTexture image data.");if(d.type===three_module.RQf&&d.image.data.constructor.name!=="Float32Array")throw Error("EXRExporter.parse: DataTexture image data doesn't match type, expected 'Float32Array'.");if(d.type===three_module.ix0&&d.image.data.constructor.name!=="Uint16Array")throw Error("EXRExporter.parse: DataTexture image data doesn't match type, expected 'Uint16Array'.")}function buildInfoRTT(d,o={}){const l=d.width,c=d.height,u=d.texture.type,h=d.texture.format,_=(texture.colorSpace,o.compression!==void 0?o.compression:ZIP_COMPRESSION),A=(o.type!==void 0?o.type:three_module.ix0)===three_module.RQf?2:1,w={0:1,2:1,3:16}[_];return{width:l,height:c,type:u,format:h,compression:_,blockLines:w,dataType:A,dataSize:2*A,numBlocks:Math.ceil(c/w),numInputChannels:4,numOutputChannels:4,textureIndex:o.textureIndex||0}}function buildInfoDT(d,o={}){const l=d.image.width,c=d.image.height,u=d.type,h=d.format,_=d.colorSpace,A=o.compression!==void 0?o.compression:ZIP_COMPRESSION,w=(o.type!==void 0?o.type:three_module.ix0)===three_module.RQf?2:1,C={0:1,2:1,3:16}[A];return{width:l,height:c,type:u,format:h,colorSpace:_,compression:A,blockLines:C,dataType:w,dataSize:2*w,numBlocks:Math.ceil(c/C),numInputChannels:4,numOutputChannels:4,flipY:d.isDataTexture&&d.flipY,textureIndex:o.textureIndex||0}}function getPixelData(d,o,l){let c;return c=l.type===three_module.RQf?new Float32Array(l.width*l.height*l.numInputChannels):new Uint16Array(l.width*l.height*l.numInputChannels),d.readRenderTargetPixels(o,0,0,l.width,l.height,c,void 0,l.textureIndex),c}function reorganizeDataBuffer(d,o){const l=o.width,c=o.height,u={r:0,g:0,b:0,a:0},h={value:0},_=o.numOutputChannels==4?1:0,A=o.type==three_module.RQf?getFloat32:getFloat16,w=o.dataType==1?setFloat16:setFloat32,C=new Uint8Array(o.width*o.height*o.numOutputChannels*o.dataSize),M=new DataView(C.buffer);for(let O=0;O<c;++O)for(let ne=0;ne<l;++ne){const ce=O*l*4+4*ne,ue=A(d,ce),ye=A(d,ce+1),Oe=A(d,ce+2),ke=A(d,ce+3),Ve=(o.flipY?O:c-O-1)*l*(3+_)*o.dataSize;decodeLinear(u,ue,ye,Oe,ke),h.value=Ve+ne*o.dataSize,w(M,u.a,h),h.value=Ve+_*l*o.dataSize+ne*o.dataSize,w(M,u.b,h),h.value=Ve+(1+_)*l*o.dataSize+ne*o.dataSize,w(M,u.g,h),h.value=Ve+(2+_)*l*o.dataSize+ne*o.dataSize,w(M,u.r,h)}return C}function compressData(d,o){let l,c,u=0;const h={data:new Array,totalSize:0},_=o.width*o.numOutputChannels*o.blockLines*o.dataSize;switch(o.compression){case 0:l=compressNONE;break;case 2:case 3:l=compressZIP}o.compression!==0&&(c=new Uint8Array(_));for(let A=0;A<o.numBlocks;++A){const w=l(d.subarray(_*A,_*(A+1)),c);u+=w.length,h.data.push({dataChunk:w,size:w.length})}return h.totalSize=u,h}function compressNONE(d){return d}function compressZIP(d,o){let l=0,c=Math.floor((d.length+1)/2),u=0;const h=d.length-1;for(;!(u>h||(o[l++]=d[u++],u>h));)o[c++]=d[u++];let _=o[0];for(let A=1;A<o.length;A++){const w=o[A]-_+384;_=o[A],o[A]=w}return fflate_module_zlibSync(o)}function fillHeader(d,o,l){const c={value:0},u=new DataView(d.buffer);setUint32(u,20000630,c),setUint32(u,2,c),setString(u,"compression",c),setString(u,"compression",c),setUint32(u,1,c),setUint8(u,l.compression,c),setString(u,"screenWindowCenter",c),setString(u,"v2f",c),setUint32(u,8,c),setUint32(u,0,c),setUint32(u,0,c),setString(u,"screenWindowWidth",c),setString(u,"float",c),setUint32(u,4,c),setFloat32(u,1,c),setString(u,"pixelAspectRatio",c),setString(u,"float",c),setUint32(u,4,c),setFloat32(u,1,c),setString(u,"lineOrder",c),setString(u,"lineOrder",c),setUint32(u,1,c),setUint8(u,0,c),setString(u,"dataWindow",c),setString(u,"box2i",c),setUint32(u,16,c),setUint32(u,0,c),setUint32(u,0,c),setUint32(u,l.width-1,c),setUint32(u,l.height-1,c),setString(u,"displayWindow",c),setString(u,"box2i",c),setUint32(u,16,c),setUint32(u,0,c),setUint32(u,0,c),setUint32(u,l.width-1,c),setUint32(u,l.height-1,c),setString(u,"channels",c),setString(u,"chlist",c),setUint32(u,18*l.numOutputChannels+1,c),setString(u,"A",c),setUint32(u,l.dataType,c),c.value+=4,setUint32(u,1,c),setUint32(u,1,c),setString(u,"B",c),setUint32(u,l.dataType,c),c.value+=4,setUint32(u,1,c),setUint32(u,1,c),setString(u,"G",c),setUint32(u,l.dataType,c),c.value+=4,setUint32(u,1,c),setUint32(u,1,c),setString(u,"R",c),setUint32(u,l.dataType,c),c.value+=4,setUint32(u,1,c),setUint32(u,1,c),setUint8(u,0,c),setUint8(u,0,c);let h=c.value+8*l.numBlocks;for(let _=0;_<o.data.length;++_)setUint64(u,h,c),h+=o.data[_].size+8}function fillData(d,o){const l=8*o.numBlocks,c=259+18*o.numOutputChannels,u={value:c+l},h=new Uint8Array(c+l+d.totalSize+8*o.numBlocks),_=new DataView(h.buffer);fillHeader(h,d,o);for(let A=0;A<d.data.length;++A){const w=d.data[A].dataChunk,C=d.data[A].size;setUint32(_,A*o.blockLines,u),setUint32(_,C,u),h.set(w,u.value),u.value+=C}return h}function decodeLinear(d,o,l,c,u){d.r=o,d.g=l,d.b=c,d.a=u}function setUint8(d,o,l){d.setUint8(l.value,o),l.value+=1}function setUint32(d,o,l){d.setUint32(l.value,o,!0),l.value+=4}function setFloat16(d,o,l){d.setUint16(l.value,three_module.GxU.toHalfFloat(o),!0),l.value+=2}function setFloat32(d,o,l){d.setFloat32(l.value,o,!0),l.value+=4}function setUint64(d,o,l){d.setBigUint64(l.value,BigInt(o),!0),l.value+=8}function setString(d,o,l){const c=textEncoder.encode(o+"\0");for(let u=0;u<c.length;++u)setUint8(d,c[u],l)}function decodeFloat16(d){const o=(31744&d)>>10,l=1023&d;return(d>>15?-1:1)*(o?o===31?l?NaN:1/0:Math.pow(2,o-15)*(1+l/1024):l/1024*6103515625e-14)}function getFloat16(d,o){return decodeFloat16(d[o])}function getFloat32(d,o){return d[o]}class EXRExporter2 extends EXRExporter{async parseAsync(o,l){const c=o;if(c.isWebGLRenderTarget&&!o.renderer)throw new Error("No renderManager on renderTarget");if(!c.isWebGLRenderTarget&&!o.isDataTexture)throw new Error("Invalid object type");c.isWebGLMultipleRenderTargets&&l.textureIndex===void 0&&console.warn("No textureIndex specified for WebGLMultipleRenderTargets");const u=c.isWebGLRenderTarget?this.parse(o.renderer.rendererObject,c,l):this.parse(o,l);return new Blob([u],{type:"image/x-exr"})}}class AssetExporter extends I{get processors(){return this._processors}getExporter(...o){return this.Exporters.find(l=>l.ext.some(c=>o.includes(c)))}constructor(o,l={}){super(),this._processors=new ObjectProcessorMap,this.Exporters=[{ctor:()=>new SimpleJSONExporter,ext:["json"]},{ctor:()=>new SimpleTextExporter,ext:["txt","text"]},{ctor:()=>new EXRExporter2,ext:["exr"]}],this._cachedParsers=[],addGLTFExporter(this,o)}async exportObject(o,l={}){var c,u;if(!(o!=null&&o.assetType))return void console.error("Object has no asset type");!((c=o==null?void 0:o.userData)===null||c===void 0)&&c.rootSceneModelRoot&&l.viewerConfig===!1&&(o.userData.__exportViewerConfig=!1);const h=[];o.assetType==="model"&&o.modelObject.traverse(A=>{A.userData.excludeFromExport&&A.visible&&(A.visible=!1,h.push(A))});const _=await this._exportFile(o,l);return o.assetType==="model"&&h.forEach(A=>A.visible=!0),!((u=o==null?void 0:o.userData)===null||u===void 0)&&u.rootSceneModelRoot&&l.viewerConfig===!1&&delete o.userData.__exportViewerConfig,_}async _exportFile(o,l={}){var c,u,h;let _;this.dispatchEvent({type:"exportFile",obj:o,state:"processing"});try{const A=await this.processBeforeExport(o,l),w=(u=(c=l.exportExt)!==null&&c!==void 0?c:A==null?void 0:A.typeExt)!==null&&u!==void 0?u:A==null?void 0:A.ext;if(!A||!w)throw new Error(`Unable to preprocess before export ${w}`);const C=this._getParser(w);this.dispatchEvent({type:"exportFile",obj:o,state:"exporting"});const M=await C.parseAsync(A.obj,{exportExt:(h=A.ext)!==null&&h!==void 0?h:w,...l});M.ext=A.ext,_=M}catch(A){return console.error("AssetExporter: Unable to Export file",o),console.error(A),void this.dispatchEvent({type:"exportFile",obj:o,state:"error",error:A})}return this.dispatchEvent({type:"exportFile",obj:o,state:"done"}),_}_createParser(o){const l=this.Exporters.find(u=>u.ext.includes(o));if(!l)throw new Error(`No exporter found for extension ${o}`);const c=l==null?void 0:l.ctor(this);if(!c)throw new Error(`Unable to create parser for extension ${o}`);return this._cachedParsers.push({ext:l.ext,parser:c}),this.dispatchEvent({type:"exporterCreate",exporter:l,parser:c}),c}_getParser(o){var l,c;return(c=(l=this._cachedParsers.find(u=>u.ext.includes(o)))===null||l===void 0?void 0:l.parser)!==null&&c!==void 0?c:this._createParser(o)}async processBeforeExport(o,l={}){if(o.assetType!=null&&o.assetType!=="renderTarget"&&(o=await this._processors.process(o.assetType,o,l)),o.isWebGLRenderTarget)return{obj:o,ext:"exr"};switch(o.assetType){case"light":return void console.error("AssetExporter: light export not implemented");case"model":return{obj:o,ext:"glb"};case"material":return{obj:o.toJSON(),ext:o.typeSlug||"json",typeExt:"json"};case"texture":return{obj:o.toJSON(),ext:"json"};case"renderTarget":return{obj:o,ext:"exr"};default:console.error("AssetExporter: unknown asset type",o.assetType)}}dispose(){var o;(o=this._processors)===null||o===void 0||o.dispose()}}var AssetExporterPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},EncoderMethod;(function(d){d[d.EDGEBREAKER=1]="EDGEBREAKER",d[d.SEQUENTIAL=0]="SEQUENTIAL"})(EncoderMethod||(EncoderMethod={}));class AssetExporterPlugin extends AViewerPlugin{constructor(o){super(),this.enabled=!0,this.exportOptions={compress:!1,name:"scene",viewerConfig:!0,encodeUint16Rgbe:!1,convertMeshToIndexed:!1,embedUrlImagePreviews:!1,embedUrlImages:!1,dracoOptions:{encodeSpeed:5,method:EncoderMethod.EDGEBREAKER,quantizationVolume:"mesh",quantizationBits:{POSITION:14,NORMAL:10,COLOR:8,TEX_COORD:12,GENERIC:12}},encrypt:!1,encryptKey:"",ignoreInvalidMorphTargetTracks:!0,ignoreEmptyTextures:!0},this.exporter=o,this.exportScene=this.exportScene.bind(this)}async onAdded(o){await super.onAdded(o),this.exporter||(this.exporter=new AssetExporter(o)),this.exporter.processors.add("model",{forAssetType:"model",processAsync:async(l,c)=>{var u;return c.convertMeshToIndexed&&((u=l.modelObject)===null||u===void 0||u.traverse(h=>{if(h.geometry&&!h.geometry.attributes.index)try{const _=toIndexedGeometry(h.geometry);h.setGeometry&&h.setGeometry(_)}catch(_){console.error("AssetExporterPlugin.convertMeshToIndexed: Error converting geometry to indexed",_)}})),l}})}async onRemove(o){return super.onRemove(o)}async exportScene(o){var l,c;return(l=this.exporter)===null||l===void 0?void 0:l.exportObject((c=this._viewer)===null||c===void 0?void 0:c.scene.modelRoot,o||{...this.exportOptions})}async downloadSceneGlb(){const o=await this.exportScene(this.exportOptions);o&&await this._downloadBlob(o,this.exportOptions.name+"."+o.ext)}async _downloadBlob(o,l){var c,u;const h=(c=this._viewer)===null||c===void 0?void 0:c.getPluginByType("FileTransferPlugin");h?await h.exportFile(o,l):(u=this._viewer)===null||u===void 0||u.console.error("FileTransferPlugin required to export/download file")}get uiConfig(){if(this._uiConfig)return this._uiConfig;const o=this._viewer;o.addEventListener("addPlugin",c=>{var u;typeof((u=c.plugin)===null||u===void 0?void 0:u.toJSON)=="function"&&console.error("Add all plugins before setting up the export UI, or use `toJSON: any = null` in the plugin ")});const l=Object.entries(o.plugins).filter(([c,u])=>typeof(u==null?void 0:u.toJSON)=="function"&&(u==null?void 0:u.serializeWithViewer)!==!1).map(([c,u])=>({label:c,type:"checkbox",value:!0}));return this._uiConfig={type:"folder",label:"Asset Export",limitedUi:!0,children:[{type:"input",property:[this.exportOptions,"name"],limitedUi:!0},{type:"folder",label:"GLB Export",limitedUi:!0,children:[{type:"checkbox",label:"DRACO Compress",property:[this.exportOptions,"compress"],limitedUi:!0,onChange:()=>{var c,u;return(u=(c=this._uiConfig)===null||c===void 0?void 0:c.uiRefresh)===null||u===void 0?void 0:u.call(c,"postFrame",!0)}},this.exportOptions.dracoOptions?{type:"folder",hidden:()=>!this.exportOptions.compress,label:"DRACO Options",children:[{type:"slider",label:"Encode Speed",bounds:[1,10],property:[this.exportOptions.dracoOptions,"encodeSpeed"]},{type:"dropdown",label:"Encoder Method",property:[this.exportOptions.dracoOptions,"method"],children:Object.entries(EncoderMethod).map(([c,u])=>({label:c,value:u}))},{type:"dropdown",label:"Quantization Volume",property:[this.exportOptions.dracoOptions,"quantizationVolume"],children:["mesh","scene","bbox"].map(c=>({label:c}))},{type:"folder",label:"Quantization Bits",children:Object.keys(this.exportOptions.dracoOptions.quantizationBits).map(c=>({type:"slider",label:c,bounds:[1,16],stepSize:1,property:[this.exportOptions.dracoOptions.quantizationBits,c]}))}]}:{},{type:"checkbox",label:"Scene Settings",property:[this.exportOptions,"viewerConfig"],limitedUi:!0,onChange:()=>{var c,u;return(u=(c=this._uiConfig)===null||c===void 0?void 0:c.uiRefresh)===null||u===void 0?void 0:u.call(c,"postFrame",!0)}},{type:"checkbox",label:"Embed Image Previews",property:[this.exportOptions,"embedUrlImagePreviews"]},{type:"checkbox",label:"Encrypt",property:[this.exportOptions,"encrypt"],onChange:()=>{var c,u;return(u=(c=this._uiConfig)===null||c===void 0?void 0:c.uiRefresh)===null||u===void 0?void 0:u.call(c,"postFrame",!0)}},{type:"checkbox",label:"Encrypt Password",hidden:()=>!this.exportOptions.encrypt,property:[this.exportOptions,"encryptKey"]},{type:"checkbox",label:"Compress hdr env maps",hidden:()=>!this.exportOptions.viewerConfig,property:[this.exportOptions,"encodeUint16Rgbe"]},{type:"checkbox",label:"Convert to indexed",property:[this.exportOptions,"convertMeshToIndexed"]},{type:"checkbox",label:"Ignore invalid animations",property:[this.exportOptions,"ignoreInvalidMorphTargetTracks"]},{type:"checkbox",label:"Ignore invalid textures",property:[this.exportOptions,"ignoreInvalidTextures"]},{type:"button",label:"Export GLB",limitedUi:!0,value:async()=>this.downloadSceneGlb()}]},{type:"folder",label:"Preset/Config export",children:[{type:"folder",label:"Plugins",children:l},{type:"button",label:"Select none",value:()=>{l.forEach(c=>{var u;c.value=!1,(u=c.uiRefresh)===null||u===void 0||u.call(c)})}},{type:"button",label:"Select all",value:()=>{l.forEach(c=>{var u;c.value=!0,(u=c.uiRefresh)===null||u===void 0||u.call(c)})}},{type:"button",label:"Export Plugins",limitedUi:!0,value:async()=>{const c=new Blob([JSON.stringify(o.getPlugin(AssetManagerPlugin).exportPluginPresets(l.filter(u=>!!u.value).map(u=>Ee(u.label)||"")),null,2)],{type:"application/json"});c&&await this._downloadBlob(c,this.exportOptions.name+"."+AssetManagerPlugin.ViewerTypeSlug)}},{type:"button",label:"Export All Viewer Config",limitedUi:!0,value:async()=>{const c=new Blob([JSON.stringify(o.getPlugin(AssetManagerPlugin).exportViewerConfig(!1),null,2)],{type:"application/json"});c&&await this._downloadBlob(c,this.exportOptions.name+"."+AssetManagerPlugin.ViewerTypeSlug)}}]}]}}}AssetExporterPlugin.PluginType="AssetExporterPlugin",AssetExporterPlugin_decorate([serialize()],AssetExporterPlugin.prototype,"exportOptions",void 0);class EventDispatcher{constructor(){this._listeners={}}addEventListener(o,l){const c=this._listeners;return c[o]===void 0&&(c[o]=[]),c[o].indexOf(l)===-1&&c[o].push(l),this}removeEventListener(o,l){const c=this._listeners[o];if(c!==void 0){const u=c.indexOf(l);u!==-1&&c.splice(u,1)}return this}dispatchEvent(o){const l=this._listeners[o.type];if(l!==void 0){const c=l.slice(0);for(let u=0,h=c.length;u<h;u++)c[u].call(this,o)}return this}dispose(){for(const o in this._listeners)delete this._listeners[o]}}class GraphEdge{constructor(o,l,c,u={}){if(this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=o,this._parent=l,this._child=c,this._attributes=u,!l.isOnGraph(c))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(o){return this._child=o,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._parent._destroyRef(this),this._disposed=!0)}isDisposed(){return this._disposed}}class Graph extends EventDispatcher{constructor(...o){super(...o),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(o){return Array.from(this._childEdges.get(o)||this._emptySet)}listParents(o){const l=new Set;for(const c of this.listParentEdges(o))l.add(c.getParent());return Array.from(l)}listChildEdges(o){return Array.from(this._parentEdges.get(o)||this._emptySet)}listChildren(o){const l=new Set;for(const c of this.listChildEdges(o))l.add(c.getChild());return Array.from(l)}disconnectParents(o,l){for(const c of this.listParentEdges(o))l&&!l(c.getParent())||c.dispose();return this}_createEdge(o,l,c,u){const h=new GraphEdge(o,l,c,u);this._edges.add(h);const _=h.getParent();this._parentEdges.has(_)||this._parentEdges.set(_,new Set),this._parentEdges.get(_).add(h);const A=h.getChild();return this._childEdges.has(A)||this._childEdges.set(A,new Set),this._childEdges.get(A).add(h),h}_destroyEdge(o){return this._edges.delete(o),this._parentEdges.get(o.getParent()).delete(o),this._childEdges.get(o.getChild()).delete(o),this}}function _extends(){return _extends=Object.assign||function(d){for(var o=1;o<arguments.length;o++){var l=arguments[o];for(var c in l)Object.prototype.hasOwnProperty.call(l,c)&&(d[c]=l[c])}return d},_extends.apply(this,arguments)}class RefList{constructor(o){if(this.list=[],o)for(const l of o)this.list.push(l)}add(o){this.list.push(o)}remove(o){const l=this.list.indexOf(o);l>=0&&this.list.splice(l,1)}removeChild(o){const l=[];for(const c of this.list)c.getChild()===o&&l.push(c);for(const c of l)this.remove(c);return l}listRefsByChild(o){const l=[];for(const c of this.list)c.getChild()===o&&l.push(c);return l}values(){return this.list}}class RefSet{constructor(o){if(this.set=new Set,this.map=new Map,o)for(const l of o)this.add(l)}add(o){const l=o.getChild();this.removeChild(l),this.set.add(o),this.map.set(l,o)}remove(o){this.set.delete(o),this.map.delete(o.getChild())}removeChild(o){const l=this.map.get(o)||null;return l&&this.remove(l),l}getRefByChild(o){return this.map.get(o)||null}values(){return Array.from(this.set)}}class RefMap{constructor(o){this.map={},o&&Object.assign(this.map,o)}set(o,l){this.map[o]=l}delete(o){delete this.map[o]}get(o){return this.map[o]||null}keys(){return Object.keys(this.map)}values(){return Object.values(this.map)}}const $attributes=Symbol("attributes"),$immutableKeys=Symbol("immutableKeys");class GraphNode extends EventDispatcher{constructor(o){super(),this._disposed=!1,this.graph=void 0,this[$attributes]=void 0,this[$immutableKeys]=void 0,this.graph=o,this[$immutableKeys]=new Set,this[$attributes]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const o=this.getDefaults(),l={};for(const c in o){const u=o[c];if(u instanceof GraphNode){const h=this.graph._createEdge(c,this,u);this[$immutableKeys].add(c),l[c]=h}else l[c]=u}return l}isOnGraph(o){return this.graph===o.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(o=>o.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(o,l){for(const c in this[$attributes]){const u=this[$attributes][c];if(u instanceof GraphEdge){const h=u;h.getChild()===o&&this.setRef(c,l,h.getAttributes())}else if(u instanceof RefList)for(const h of u.listRefsByChild(o)){const _=h.getAttributes();this.removeRef(c,o),this.addRef(c,l,_)}else if(u instanceof RefSet){const h=u.getRefByChild(o);if(h){const _=h.getAttributes();this.removeRef(c,o),this.addRef(c,l,_)}}else if(u instanceof RefMap)for(const h of u.keys()){const _=u.get(h);_.getChild()===o&&this.setRefMap(c,h,l,_.getAttributes())}}return this}get(o){return this[$attributes][o]}set(o,l){return this[$attributes][o]=l,this.dispatchEvent({type:"change",attribute:o})}getRef(o){const l=this[$attributes][o];return l?l.getChild():null}setRef(o,l,c){if(this[$immutableKeys].has(o))throw new Error(`Cannot overwrite immutable attribute, "${o}".`);const u=this[$attributes][o];if(u&&u.dispose(),!l)return this;const h=this.graph._createEdge(o,this,l,c);return this[$attributes][o]=h,this.dispatchEvent({type:"change",attribute:o})}listRefs(o){return this.assertRefList(o).values().map(l=>l.getChild())}addRef(o,l,c){const u=this.graph._createEdge(o,this,l,c);return this.assertRefList(o).add(u),this.dispatchEvent({type:"change",attribute:o})}removeRef(o,l){const c=this.assertRefList(o);if(c instanceof RefList)for(const u of c.listRefsByChild(l))u.dispose();else{const u=c.getRefByChild(l);u&&u.dispose()}return this}assertRefList(o){const l=this[$attributes][o];if(l instanceof RefList||l instanceof RefSet)return l;throw new Error(`Expected RefList or RefSet for attribute "${o}"`)}listRefMapKeys(o){return this.assertRefMap(o).keys()}listRefMapValues(o){return this.assertRefMap(o).values().map(l=>l.getChild())}getRefMap(o,l){const c=this.assertRefMap(o).get(l);return c?c.getChild():null}setRefMap(o,l,c,u){const h=this.assertRefMap(o),_=h.get(l);if(_&&_.dispose(),!c)return this;u=Object.assign(u||{},{key:l});const A=this.graph._createEdge(o,this,c,_extends({},u,{key:l}));return h.set(l,A),this.dispatchEvent({type:"change",attribute:o,key:l})}assertRefMap(o){const l=this[$attributes][o];if(l instanceof RefMap)return l;throw new Error(`Expected RefMap for attribute "${o}"`)}dispatchEvent(o){return super.dispatchEvent(_extends({},o,{target:this})),this.graph.dispatchEvent(_extends({},o,{target:this,type:`node:${o.type}`})),this}_destroyRef(o){const l=o.getName();if(this[$attributes][l]===o)this[$attributes][l]=null,this[$immutableKeys].has(l)&&o.getChild().dispose();else if(this[$attributes][l]instanceof RefList)this[$attributes][l].remove(o);else if(this[$attributes][l]instanceof RefSet)this[$attributes][l].remove(o);else{if(!(this[$attributes][l]instanceof RefMap))return;{const c=this[$attributes][l];for(const u of c.keys())c.get(u)===o&&c.delete(u)}}this.graph._destroyEdge(o),this.dispatchEvent({type:"change",attribute:l})}}const VERSION="v4.1.1",GLB_BUFFER="@glb.bin";var index_modern_PropertyType,VertexLayout,BufferViewUsage$1,index_modern_TextureChannel,Format;(function(d){d.ACCESSOR="Accessor",d.ANIMATION="Animation",d.ANIMATION_CHANNEL="AnimationChannel",d.ANIMATION_SAMPLER="AnimationSampler",d.BUFFER="Buffer",d.CAMERA="Camera",d.MATERIAL="Material",d.MESH="Mesh",d.PRIMITIVE="Primitive",d.PRIMITIVE_TARGET="PrimitiveTarget",d.NODE="Node",d.ROOT="Root",d.SCENE="Scene",d.SKIN="Skin",d.TEXTURE="Texture",d.TEXTURE_INFO="TextureInfo"})(index_modern_PropertyType||(index_modern_PropertyType={})),function(d){d.INTERLEAVED="interleaved",d.SEPARATE="separate"}(VertexLayout||(VertexLayout={})),function(d){d.ARRAY_BUFFER="ARRAY_BUFFER",d.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",d.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",d.OTHER="OTHER",d.SPARSE="SPARSE"}(BufferViewUsage$1||(BufferViewUsage$1={})),function(d){d[d.R=4096]="R",d[d.G=256]="G",d[d.B=16]="B",d[d.A=1]="A"}(index_modern_TextureChannel||(index_modern_TextureChannel={})),function(d){d.GLTF="GLTF",d.GLB="GLB"}(Format||(Format={}));const index_modern_ComponentTypeToTypedArray={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};var ARRAY_TYPE=typeof Float32Array<"u"?Float32Array:Array,_Logger,Verbosity;function create(){var d=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(d[0]=0,d[1]=0,d[2]=0),d}function index_modern_length(d){var o=d[0],l=d[1],c=d[2];return Math.hypot(o,l,c)}function transformMat4(d,o,l){var c=o[0],u=o[1],h=o[2],_=l[3]*c+l[7]*u+l[11]*h+l[15];return _=_||1,d[0]=(l[0]*c+l[4]*u+l[8]*h+l[12])/_,d[1]=(l[1]*c+l[5]*u+l[9]*h+l[13])/_,d[2]=(l[2]*c+l[6]*u+l[10]*h+l[14])/_,d}function getBounds(d){const o=createBounds(),l=d.propertyType===index_modern_PropertyType.NODE?[d]:d.listChildren();for(const c of l)c.traverse(u=>{const h=u.getMesh();if(!h)return;const _=getMeshBounds(h,u.getWorldMatrix());_.min.every(isFinite)&&_.max.every(isFinite)&&(expandBounds(_.min,o),expandBounds(_.max,o))});return o}function getMeshBounds(d,o){const l=createBounds();for(const c of d.listPrimitives()){const u=c.getAttribute("POSITION"),h=c.getIndices();if(!u)continue;let _=[0,0,0],A=[0,0,0];for(let w=0,C=h?h.getCount():u.getCount();w<C;w++){const M=h?h.getScalar(w):w;_=u.getElement(M,_),A=transformMat4(A,_,o),expandBounds(A,l)}}return l}function expandBounds(d,o){for(let l=0;l<3;l++)o.min[l]=Math.min(d[l],o.min[l]),o.max[l]=Math.max(d[l],o.max[l])}function createBounds(){return{min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]}}Math.hypot||(Math.hypot=function(){for(var d=0,o=arguments.length;o--;)d+=arguments[o]*arguments[o];return Math.sqrt(d)}),create();class index_modern_BufferUtils{static createBufferFromDataURI(o){if(typeof Buffer>"u"){const l=atob(o.split(",")[1]),c=new Uint8Array(l.length);for(let u=0;u<l.length;u++)c[u]=l.charCodeAt(u);return c}{const l=o.split(",")[1],c=o.indexOf("base64")>=0;return Buffer.from(l,c?"base64":"utf8")}}static encodeText(o){return new TextEncoder().encode(o)}static decodeText(o){return new TextDecoder().decode(o)}static concat(o){let l=0;for(const h of o)l+=h.byteLength;const c=new Uint8Array(l);let u=0;for(const h of o)c.set(h,u),u+=h.byteLength;return c}static pad(o,l=0){const c=this.padNumber(o.byteLength);if(c===o.byteLength)return o;const u=new Uint8Array(c);if(u.set(o),l!==0)for(let h=o.byteLength;h<c;h++)u[h]=l;return u}static padNumber(o){return 4*Math.ceil(o/4)}static equals(o,l){if(o===l)return!0;if(o.byteLength!==l.byteLength)return!1;let c=o.byteLength;for(;c--;)if(o[c]!==l[c])return!1;return!0}static toView(o,l=0,c=1/0){return new Uint8Array(o.buffer,o.byteOffset+l,Math.min(o.byteLength,c))}static assertView(o){if(o&&!ArrayBuffer.isView(o))throw new Error(`Method requires Uint8Array parameter; received "${typeof o}".`);return o}}class JPEGImageUtils{match(o){return o.length>=3&&o[0]===255&&o[1]===216&&o[2]===255}getSize(o){let l,c,u=new DataView(o.buffer,o.byteOffset+4);for(;u.byteLength;){if(l=u.getUint16(0,!1),validateJPEGBuffer(u,l),c=u.getUint8(l+1),c===192||c===193||c===194)return[u.getUint16(l+7,!1),u.getUint16(l+5,!1)];u=new DataView(o.buffer,u.byteOffset+l+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(o){return 3}}class PNGImageUtils{match(o){return o.length>=8&&o[0]===137&&o[1]===80&&o[2]===78&&o[3]===71&&o[4]===13&&o[5]===10&&o[6]===26&&o[7]===10}getSize(o){const l=new DataView(o.buffer,o.byteOffset);return index_modern_BufferUtils.decodeText(o.slice(12,16))===PNGImageUtils.PNG_FRIED_CHUNK_NAME?[l.getUint32(32,!1),l.getUint32(36,!1)]:[l.getUint32(16,!1),l.getUint32(20,!1)]}getChannels(o){return 4}}PNGImageUtils.PNG_FRIED_CHUNK_NAME="CgBI";class index_modern_ImageUtils{static registerFormat(o,l){this.impls[o]=l}static getMimeType(o){for(const l in this.impls)if(this.impls[l].match(o))return l;return null}static getSize(o,l){return this.impls[l]?this.impls[l].getSize(o):null}static getChannels(o,l){return this.impls[l]?this.impls[l].getChannels(o):null}static getVRAMByteLength(o,l){if(!this.impls[l])return null;if(this.impls[l].getVRAMByteLength)return this.impls[l].getVRAMByteLength(o);let c=0;const u=this.getSize(o,l);if(!u)return null;for(;u[0]>1||u[1]>1;)c+=u[0]*u[1]*4,u[0]=Math.max(Math.floor(u[0]/2),1),u[1]=Math.max(Math.floor(u[1]/2),1);return c+=4,c}static mimeTypeToExtension(o){return o==="image/jpeg"?"jpg":o.split("/").pop()}static extensionToMimeType(o){return o==="jpg"?"image/jpeg":o?`image/${o}`:""}}function validateJPEGBuffer(d,o){if(o>d.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(d.getUint8(o)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return d}index_modern_ImageUtils.impls={"image/jpeg":new JPEGImageUtils,"image/png":new PNGImageUtils};class index_modern_FileUtils{static basename(o){const l=o.split(/[\\/]/).pop();return l.substring(0,l.lastIndexOf("."))}static extension(o){if(o.startsWith("data:image/")){const l=o.match(/data:(image\/\w+)/)[1];return index_modern_ImageUtils.mimeTypeToExtension(l)}return o.startsWith("data:model/gltf+json")?"gltf":o.startsWith("data:model/gltf-binary")?"glb":o.startsWith("data:application/")?"bin":o.split(/[\\/]/).pop().split(/[.]/).pop()}}function isObject(d){return Object.prototype.toString.call(d)==="[object Object]"}function isPlainObject(d){if(isObject(d)===!1)return!1;const o=d.constructor;if(o===void 0)return!0;const l=o.prototype;return isObject(l)!==!1&&Object.prototype.hasOwnProperty.call(l,"isPrototypeOf")!==!1}(function(d){d[d.SILENT=4]="SILENT",d[d.ERROR=3]="ERROR",d[d.WARN=2]="WARN",d[d.INFO=1]="INFO",d[d.DEBUG=0]="DEBUG"})(Verbosity||(Verbosity={}));class Logger{constructor(o){this.verbosity=void 0,this.verbosity=o}debug(o){this.verbosity<=Logger.Verbosity.DEBUG&&console.debug(o)}info(o){this.verbosity<=Logger.Verbosity.INFO&&console.info(o)}warn(o){this.verbosity<=Logger.Verbosity.WARN&&console.warn(o)}error(o){this.verbosity<=Logger.Verbosity.ERROR&&console.error(o)}}function determinant(d){var o=d[0],l=d[1],c=d[2],u=d[3],h=d[4],_=d[5],A=d[6],w=d[7],C=d[8],M=d[9],O=d[10],ne=d[11],ce=d[12],ue=d[13],ye=d[14],Oe=d[15];return(o*_-l*h)*(O*Oe-ne*ye)-(o*A-c*h)*(M*Oe-ne*ue)+(o*w-u*h)*(M*ye-O*ue)+(l*A-c*_)*(C*Oe-ne*ce)-(l*w-u*_)*(C*ye-O*ce)+(c*w-u*A)*(C*ue-M*ce)}function multiply(d,o,l){var c=o[0],u=o[1],h=o[2],_=o[3],A=o[4],w=o[5],C=o[6],M=o[7],O=o[8],ne=o[9],ce=o[10],ue=o[11],ye=o[12],Oe=o[13],ke=o[14],Ve=o[15],tt=l[0],ht=l[1],ut=l[2],_t=l[3];return d[0]=tt*c+ht*A+ut*O+_t*ye,d[1]=tt*u+ht*w+ut*ne+_t*Oe,d[2]=tt*h+ht*C+ut*ce+_t*ke,d[3]=tt*_+ht*M+ut*ue+_t*Ve,tt=l[4],ht=l[5],ut=l[6],_t=l[7],d[4]=tt*c+ht*A+ut*O+_t*ye,d[5]=tt*u+ht*w+ut*ne+_t*Oe,d[6]=tt*h+ht*C+ut*ce+_t*ke,d[7]=tt*_+ht*M+ut*ue+_t*Ve,tt=l[8],ht=l[9],ut=l[10],_t=l[11],d[8]=tt*c+ht*A+ut*O+_t*ye,d[9]=tt*u+ht*w+ut*ne+_t*Oe,d[10]=tt*h+ht*C+ut*ce+_t*ke,d[11]=tt*_+ht*M+ut*ue+_t*Ve,tt=l[12],ht=l[13],ut=l[14],_t=l[15],d[12]=tt*c+ht*A+ut*O+_t*ye,d[13]=tt*u+ht*w+ut*ne+_t*Oe,d[14]=tt*h+ht*C+ut*ce+_t*ke,d[15]=tt*_+ht*M+ut*ue+_t*Ve,d}function getScaling(d,o){var l=o[0],c=o[1],u=o[2],h=o[4],_=o[5],A=o[6],w=o[8],C=o[9],M=o[10];return d[0]=Math.hypot(l,c,u),d[1]=Math.hypot(h,_,A),d[2]=Math.hypot(w,C,M),d}function getRotation(d,o){var l=new ARRAY_TYPE(3);getScaling(l,o);var c=1/l[0],u=1/l[1],h=1/l[2],_=o[0]*c,A=o[1]*u,w=o[2]*h,C=o[4]*c,M=o[5]*u,O=o[6]*h,ne=o[8]*c,ce=o[9]*u,ue=o[10]*h,ye=_+M+ue,Oe=0;return ye>0?(Oe=2*Math.sqrt(ye+1),d[3]=.25*Oe,d[0]=(O-ce)/Oe,d[1]=(ne-w)/Oe,d[2]=(A-C)/Oe):_>M&&_>ue?(Oe=2*Math.sqrt(1+_-M-ue),d[3]=(O-ce)/Oe,d[0]=.25*Oe,d[1]=(A+C)/Oe,d[2]=(ne+w)/Oe):M>ue?(Oe=2*Math.sqrt(1+M-_-ue),d[3]=(ne-w)/Oe,d[0]=(A+C)/Oe,d[1]=.25*Oe,d[2]=(O+ce)/Oe):(Oe=2*Math.sqrt(1+ue-_-M),d[3]=(A-C)/Oe,d[0]=(ne+w)/Oe,d[1]=(O+ce)/Oe,d[2]=.25*Oe),d}_Logger=Logger,Logger.Verbosity=Verbosity,Logger.DEFAULT_INSTANCE=new _Logger(_Logger.Verbosity.INFO);class index_modern_MathUtils{static identity(o){return o}static eq(o,l,c=1e-5){if(o.length!==l.length)return!1;for(let u=0;u<o.length;u++)if(Math.abs(o[u]-l[u])>c)return!1;return!0}static clamp(o,l,c){return o<l?l:o>c?c:o}static decodeNormalizedInt(o,l){switch(l){case 5126:return o;case 5123:return o/65535;case 5121:return o/255;case 5122:return Math.max(o/32767,-1);case 5120:return Math.max(o/127,-1);default:throw new Error("Invalid component type.")}}static encodeNormalizedInt(o,l){switch(l){case 5126:return o;case 5123:return Math.round(65535*index_modern_MathUtils.clamp(o,0,1));case 5121:return Math.round(255*index_modern_MathUtils.clamp(o,0,1));case 5122:return Math.round(32767*index_modern_MathUtils.clamp(o,-1,1));case 5120:return Math.round(127*index_modern_MathUtils.clamp(o,-1,1));default:throw new Error("Invalid component type.")}}static decompose(o,l,c,u){let h=index_modern_length([o[0],o[1],o[2]]);const _=index_modern_length([o[4],o[5],o[6]]),A=index_modern_length([o[8],o[9],o[10]]);determinant(o)<0&&(h=-h),l[0]=o[12],l[1]=o[13],l[2]=o[14];const w=o.slice(),C=1/h,M=1/_,O=1/A;w[0]*=C,w[1]*=C,w[2]*=C,w[4]*=M,w[5]*=M,w[6]*=M,w[8]*=O,w[9]*=O,w[10]*=O,getRotation(c,w),u[0]=h,u[1]=_,u[2]=A}static compose(o,l,c,u){const h=u,_=l[0],A=l[1],w=l[2],C=l[3],M=_+_,O=A+A,ne=w+w,ce=_*M,ue=_*O,ye=_*ne,Oe=A*O,ke=A*ne,Ve=w*ne,tt=C*M,ht=C*O,ut=C*ne,_t=c[0],at=c[1],lt=c[2];return h[0]=(1-(Oe+Ve))*_t,h[1]=(ue+ut)*_t,h[2]=(ye-ht)*_t,h[3]=0,h[4]=(ue-ut)*at,h[5]=(1-(ce+Ve))*at,h[6]=(ke+tt)*at,h[7]=0,h[8]=(ye+ht)*lt,h[9]=(ke-tt)*lt,h[10]=(1-(ce+Oe))*lt,h[11]=0,h[12]=o[0],h[13]=o[1],h[14]=o[2],h[15]=1,h}}function equalsRef(d,o){if(!!d!=!!o)return!1;const l=d.getChild(),c=o.getChild();return l===c||l.equals(c)}function equalsRefSet(d,o){if(!!d!=!!o)return!1;const l=d.values(),c=o.values();if(l.length!==c.length)return!1;for(let u=0;u<l.length;u++){const h=l[u],_=c[u];if(h.getChild()!==_.getChild()&&!h.getChild().equals(_.getChild()))return!1}return!0}function equalsRefMap(d,o){if(!!d!=!!o)return!1;const l=d.keys(),c=o.keys();if(l.length!==c.length)return!1;for(const u of l){const h=d.get(u),_=o.get(u);if(!!h!=!!_)return!1;const A=h.getChild(),w=_.getChild();if(A!==w&&!A.equals(w))return!1}return!0}function equalsArray(d,o){if(d===o)return!0;if(!!d!=!!o||!d||!o||d.length!==o.length)return!1;for(let l=0;l<d.length;l++)if(d[l]!==o[l])return!1;return!0}function equalsObject(d,o){if(d===o)return!0;if(!!d!=!!o)return!1;if(!isPlainObject(d)||!isPlainObject(o))return d===o;const l=d,c=o;let u,h=0,_=0;for(u in l)h++;for(u in c)_++;if(h!==_)return!1;for(u in l){const A=l[u],w=c[u];if(isArray(A)&&isArray(w)){if(!equalsArray(A,w))return!1}else if(isPlainObject(A)&&isPlainObject(w)){if(!equalsObject(A,w))return!1}else if(A!==w)return!1}return!0}function isArray(d){return Array.isArray(d)||ArrayBuffer.isView(d)}const ALPHABET="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",UNIQUE_RETRIES=999,ID_LENGTH=6,previousIDs=new Set,generateOne=function(){let d="";for(let o=0;o<ID_LENGTH;o++)d+=ALPHABET.charAt(Math.floor(Math.random()*ALPHABET.length));return d},index_modern_uuid=function(){for(let d=0;d<UNIQUE_RETRIES;d++){const o=generateOne();if(!previousIDs.has(o))return previousIDs.add(o),o}return""},NULL_DOMAIN="https://null.example";class HTTPUtils{static dirname(o){const l=o.lastIndexOf("/");return l===-1?"./":o.substring(0,l+1)}static basename(o){return index_modern_FileUtils.basename(new URL(o,NULL_DOMAIN).pathname)}static extension(o){return index_modern_FileUtils.extension(new URL(o,NULL_DOMAIN).pathname)}static resolve(o,l){if(!this.isRelativePath(l))return l;const c=o.split("/"),u=l.split("/");c.pop();for(let h=0;h<u.length;h++)u[h]!=="."&&(u[h]===".."?c.pop():c.push(u[h]));return c.join("/")}static isAbsoluteURL(o){return this.PROTOCOL_REGEXP.test(o)}static isRelativePath(o){return!/^(?:[a-zA-Z]+:)?\//.test(o)}}HTTPUtils.DEFAULT_INIT={},HTTPUtils.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;const COPY_IDENTITY=d=>d,EMPTY_SET=new Set;class Property extends GraphNode{constructor(o,l=""){super(o),this[$attributes].name=l,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(o,l){return Array.isArray(l)&&(l=l.slice()),super.set(o,l)}getName(){return this.get("name")}setName(o){return this.set("name",o)}getExtras(){return this.get("extras")}setExtras(o){return this.set("extras",o)}clone(){return new this.constructor(this.graph).copy(this,COPY_IDENTITY)}copy(o,l=COPY_IDENTITY){for(const c in this[$attributes]){const u=this[$attributes][c];if(u instanceof GraphEdge)this[$immutableKeys].has(c)||u.dispose();else if(u instanceof RefList||u instanceof RefSet)for(const h of u.values())h.dispose();else if(u instanceof RefMap)for(const h of u.values())h.dispose()}for(const c in o[$attributes]){const u=this[$attributes][c],h=o[$attributes][c];if(h instanceof GraphEdge)this[$immutableKeys].has(c)?u.getChild().copy(l(h.getChild()),l):this.setRef(c,l(h.getChild()),h.getAttributes());else if(h instanceof RefSet||h instanceof RefList)for(const _ of h.values())this.addRef(c,l(_.getChild()),_.getAttributes());else if(h instanceof RefMap)for(const _ of h.keys()){const A=h.get(_);this.setRefMap(c,_,l(A.getChild()),A.getAttributes())}else isPlainObject(h)?this[$attributes][c]=JSON.parse(JSON.stringify(h)):Array.isArray(h)||h instanceof ArrayBuffer||ArrayBuffer.isView(h)?this[$attributes][c]=h.slice():this[$attributes][c]=h}return this}equals(o,l=EMPTY_SET){if(this===o)return!0;if(this.propertyType!==o.propertyType)return!1;for(const c in this[$attributes]){if(l.has(c))continue;const u=this[$attributes][c],h=o[$attributes][c];if(u instanceof GraphEdge||h instanceof GraphEdge){if(!equalsRef(u,h))return!1}else if(u instanceof RefSet||h instanceof RefSet||u instanceof RefList||h instanceof RefList){if(!equalsRefSet(u,h))return!1}else if(u instanceof RefMap||h instanceof RefMap){if(!equalsRefMap(u,h))return!1}else if(isPlainObject(u)||isPlainObject(h)){if(!equalsObject(u,h))return!1}else if(isArray(u)||isArray(h)){if(!equalsArray(u,h))return!1}else if(u!==h)return!1}return!0}detach(){return this.graph.disconnectParents(this,o=>o.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}}class ExtensibleProperty extends Property{getDefaults(){return Object.assign(super.getDefaults(),{extensions:new RefMap})}getExtension(o){return this.getRefMap("extensions",o)}setExtension(o,l){return l&&l._validateParent(this),this.setRefMap("extensions",o,l)}listExtensions(){return this.listRefMapValues("extensions")}}class index_modern_Accessor extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:index_modern_Accessor.Type.SCALAR,componentType:index_modern_Accessor.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}static getElementSize(o){switch(o){case index_modern_Accessor.Type.SCALAR:return 1;case index_modern_Accessor.Type.VEC2:return 2;case index_modern_Accessor.Type.VEC3:return 3;case index_modern_Accessor.Type.VEC4:case index_modern_Accessor.Type.MAT2:return 4;case index_modern_Accessor.Type.MAT3:return 9;case index_modern_Accessor.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+o)}}static getComponentSize(o){switch(o){case index_modern_Accessor.ComponentType.BYTE:case index_modern_Accessor.ComponentType.UNSIGNED_BYTE:return 1;case index_modern_Accessor.ComponentType.SHORT:case index_modern_Accessor.ComponentType.UNSIGNED_SHORT:return 2;case index_modern_Accessor.ComponentType.UNSIGNED_INT:case index_modern_Accessor.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+o)}}getMinNormalized(o){const l=this.getNormalized(),c=this.getElementSize(),u=this.getComponentType();if(this.getMin(o),l)for(let h=0;h<c;h++)o[h]=index_modern_MathUtils.decodeNormalizedInt(o[h],u);return o}getMin(o){const l=this.getArray(),c=this.getCount(),u=this.getElementSize();for(let h=0;h<u;h++)o[h]=1/0;for(let h=0;h<c*u;h+=u)for(let _=0;_<u;_++){const A=l[h+_];Number.isFinite(A)&&(o[_]=Math.min(o[_],A))}return o}getMaxNormalized(o){const l=this.getNormalized(),c=this.getElementSize(),u=this.getComponentType();if(this.getMax(o),l)for(let h=0;h<c;h++)o[h]=index_modern_MathUtils.decodeNormalizedInt(o[h],u);return o}getMax(o){const l=this.get("array"),c=this.getCount(),u=this.getElementSize();for(let h=0;h<u;h++)o[h]=-1/0;for(let h=0;h<c*u;h+=u)for(let _=0;_<u;_++){const A=l[h+_];Number.isFinite(A)&&(o[_]=Math.max(o[_],A))}return o}getCount(){const o=this.get("array");return o?o.length/this.getElementSize():0}getType(){return this.get("type")}setType(o){return this.set("type",o)}getElementSize(){return index_modern_Accessor.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(o){return this.set("normalized",o)}getScalar(o){const l=this.getElementSize(),c=this.getComponentType(),u=this.getArray();return this.getNormalized()?index_modern_MathUtils.decodeNormalizedInt(u[o*l],c):u[o*l]}setScalar(o,l){const c=this.getElementSize(),u=this.getComponentType(),h=this.getArray();return this.getNormalized()?h[o*c]=index_modern_MathUtils.encodeNormalizedInt(l,u):h[o*c]=l,this}getElement(o,l){const c=this.getNormalized(),u=this.getElementSize(),h=this.getComponentType(),_=this.getArray();for(let A=0;A<u;A++)l[A]=c?index_modern_MathUtils.decodeNormalizedInt(_[o*u+A],h):_[o*u+A];return l}setElement(o,l){const c=this.getNormalized(),u=this.getElementSize(),h=this.getComponentType(),_=this.getArray();for(let A=0;A<u;A++)_[o*u+A]=c?index_modern_MathUtils.encodeNormalizedInt(l[A],h):l[A];return this}getSparse(){return this.get("sparse")}setSparse(o){return this.set("sparse",o)}getBuffer(){return this.getRef("buffer")}setBuffer(o){return this.setRef("buffer",o)}getArray(){return this.get("array")}setArray(o){return this.set("componentType",o?arrayToComponentType(o):index_modern_Accessor.ComponentType.FLOAT),this.set("array",o),this}getByteLength(){const o=this.get("array");return o?o.byteLength:0}}function arrayToComponentType(d){switch(d.constructor){case Float32Array:return index_modern_Accessor.ComponentType.FLOAT;case Uint32Array:return index_modern_Accessor.ComponentType.UNSIGNED_INT;case Uint16Array:return index_modern_Accessor.ComponentType.UNSIGNED_SHORT;case Uint8Array:return index_modern_Accessor.ComponentType.UNSIGNED_BYTE;case Int16Array:return index_modern_Accessor.ComponentType.SHORT;case Int8Array:return index_modern_Accessor.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}index_modern_Accessor.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},index_modern_Accessor.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};class Animation extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:new RefSet,samplers:new RefSet})}addChannel(o){return this.addRef("channels",o)}removeChannel(o){return this.removeRef("channels",o)}listChannels(){return this.listRefs("channels")}addSampler(o){return this.addRef("samplers",o)}removeSampler(o){return this.removeRef("samplers",o)}listSamplers(){return this.listRefs("samplers")}}class index_modern_AnimationChannel extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(o){return this.set("targetPath",o)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(o){return this.setRef("targetNode",o)}getSampler(){return this.getRef("sampler")}setSampler(o){return this.setRef("sampler",o)}}index_modern_AnimationChannel.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class index_modern_AnimationSampler extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:index_modern_AnimationSampler.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(o){return this.set("interpolation",o)}getInput(){return this.getRef("input")}setInput(o){return this.setRef("input",o,{usage:BufferViewUsage$1.OTHER})}getOutput(){return this.getRef("output")}setOutput(o){return this.setRef("output",o,{usage:BufferViewUsage$1.OTHER})}}index_modern_AnimationSampler.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class Buffer$1 extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(o){return this.set("uri",o)}}class Camera extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Camera.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:2*Math.PI*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(o){return this.set("type",o)}getZNear(){return this.get("znear")}setZNear(o){return this.set("znear",o)}getZFar(){return this.get("zfar")}setZFar(o){return this.set("zfar",o)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(o){return this.set("aspectRatio",o)}getYFov(){return this.get("yfov")}setYFov(o){return this.set("yfov",o)}getXMag(){return this.get("xmag")}setXMag(o){return this.set("xmag",o)}getYMag(){return this.get("ymag")}setYMag(o){return this.set("ymag",o)}}Camera.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class index_modern_ExtensionProperty extends Property{_validateParent(o){if(!this.parentTypes.includes(o.propertyType))throw new Error(`Parent "${o.propertyType}" invalid for child "${this.propertyType}".`)}}index_modern_ExtensionProperty.EXTENSION_NAME=void 0;class index_modern_TextureInfo extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:index_modern_TextureInfo.WrapMode.REPEAT,wrapT:index_modern_TextureInfo.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(o){return this.set("texCoord",o)}getMagFilter(){return this.get("magFilter")}setMagFilter(o){return this.set("magFilter",o)}getMinFilter(){return this.get("minFilter")}setMinFilter(o){return this.set("minFilter",o)}getWrapS(){return this.get("wrapS")}setWrapS(o){return this.set("wrapS",o)}getWrapT(){return this.get("wrapT")}setWrapT(o){return this.set("wrapT",o)}}index_modern_TextureInfo.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},index_modern_TextureInfo.MagFilter={NEAREST:9728,LINEAR:9729},index_modern_TextureInfo.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:index_modern_R,G:index_modern_G,B:index_modern_B,A:index_modern_A}=index_modern_TextureChannel;class index_modern_Material extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:index_modern_Material.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new index_modern_TextureInfo(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new index_modern_TextureInfo(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new index_modern_TextureInfo(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new index_modern_TextureInfo(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new index_modern_TextureInfo(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(o){return this.set("doubleSided",o)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(o){const l=this.get("baseColorFactor").slice();return l[3]=o,this.set("baseColorFactor",l)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(o){return this.set("alphaMode",o)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(o){return this.set("alphaCutoff",o)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(o){return this.set("baseColorFactor",o)}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(o){return this.setRef("baseColorTexture",o,{channels:index_modern_R|index_modern_G|index_modern_B|index_modern_A,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(o){return this.set("emissiveFactor",o)}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(o){return this.setRef("emissiveTexture",o,{channels:index_modern_R|index_modern_G|index_modern_B,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(o){return this.set("normalScale",o)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(o){return this.setRef("normalTexture",o,{channels:index_modern_R|index_modern_G|index_modern_B})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(o){return this.set("occlusionStrength",o)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(o){return this.setRef("occlusionTexture",o,{channels:index_modern_R})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(o){return this.set("roughnessFactor",o)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(o){return this.set("metallicFactor",o)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(o){return this.setRef("metallicRoughnessTexture",o,{channels:index_modern_G|index_modern_B})}}index_modern_Material.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class index_modern_Mesh extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:new RefSet})}addPrimitive(o){return this.addRef("primitives",o)}removePrimitive(o){return this.removeRef("primitives",o)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(o){return this.set("weights",o)}}class index_modern_Node extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:new RefSet})}copy(o,l=COPY_IDENTITY){if(l===COPY_IDENTITY)throw new Error("Node cannot be copied.");return super.copy(o,l)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(o){return this.set("translation",o)}setRotation(o){return this.set("rotation",o)}setScale(o){return this.set("scale",o)}getMatrix(){return index_modern_MathUtils.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(o){const l=this.get("translation").slice(),c=this.get("rotation").slice(),u=this.get("scale").slice();return index_modern_MathUtils.decompose(o,l,c,u),this.set("translation",l).set("rotation",c).set("scale",u)}getWorldTranslation(){const o=[0,0,0];return index_modern_MathUtils.decompose(this.getWorldMatrix(),o,[0,0,0,1],[1,1,1]),o}getWorldRotation(){const o=[0,0,0,1];return index_modern_MathUtils.decompose(this.getWorldMatrix(),[0,0,0],o,[1,1,1]),o}getWorldScale(){const o=[1,1,1];return index_modern_MathUtils.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],o),o}getWorldMatrix(){const o=[];for(let u=this;u!=null;u=u.getParentNode())o.push(u);let l;const c=o.pop().getMatrix();for(;l=o.pop();)multiply(c,c,l.getMatrix());return c}addChild(o){const l=o.getParentNode();l&&l.removeChild(o);for(const c of o.listParents())c.propertyType===index_modern_PropertyType.SCENE&&c.removeChild(o);return this.addRef("children",o)}removeChild(o){return this.removeRef("children",o)}listChildren(){return this.listRefs("children")}getParentNode(){for(const o of this.listParents())if(o.propertyType===index_modern_PropertyType.NODE)return o;return null}getMesh(){return this.getRef("mesh")}setMesh(o){return this.setRef("mesh",o)}getCamera(){return this.getRef("camera")}setCamera(o){return this.setRef("camera",o)}getSkin(){return this.getRef("skin")}setSkin(o){return this.setRef("skin",o)}getWeights(){return this.get("weights")}setWeights(o){return this.set("weights",o)}traverse(o){o(this);for(const l of this.listChildren())l.traverse(o);return this}}class index_modern_Primitive extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:index_modern_Primitive.Mode.TRIANGLES,material:null,indices:null,attributes:new RefMap,targets:new RefSet})}getIndices(){return this.getRef("indices")}setIndices(o){return this.setRef("indices",o,{usage:BufferViewUsage$1.ELEMENT_ARRAY_BUFFER})}getAttribute(o){return this.getRefMap("attributes",o)}setAttribute(o,l){return this.setRefMap("attributes",o,l,{usage:BufferViewUsage$1.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(o){return this.setRef("material",o)}getMode(){return this.get("mode")}setMode(o){return this.set("mode",o)}listTargets(){return this.listRefs("targets")}addTarget(o){return this.addRef("targets",o)}removeTarget(o){return this.removeRef("targets",o)}}index_modern_Primitive.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class index_modern_PrimitiveTarget extends Property{init(){this.propertyType=index_modern_PropertyType.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new RefMap})}getAttribute(o){return this.getRefMap("attributes",o)}setAttribute(o,l){return this.setRefMap("attributes",o,l,{usage:BufferViewUsage$1.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}function index_modern_extends(){return index_modern_extends=Object.assign?Object.assign.bind():function(d){for(var o=1;o<arguments.length;o++){var l=arguments[o];for(var c in l)({}).hasOwnProperty.call(l,c)&&(d[c]=l[c])}return d},index_modern_extends.apply(null,arguments)}class index_modern_Scene extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:new RefSet})}copy(o,l=COPY_IDENTITY){if(l===COPY_IDENTITY)throw new Error("Scene cannot be copied.");return super.copy(o,l)}addChild(o){const l=o.getParentNode();return l&&l.removeChild(o),this.addRef("children",o)}removeChild(o){return this.removeRef("children",o)}listChildren(){return this.listRefs("children")}traverse(o){for(const l of this.listChildren())l.traverse(o);return this}}class Skin extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:new RefSet})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(o){return this.setRef("skeleton",o)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(o){return this.setRef("inverseBindMatrices",o,{usage:BufferViewUsage$1.INVERSE_BIND_MATRICES})}addJoint(o){return this.addRef("joints",o)}removeJoint(o){return this.removeRef("joints",o)}listJoints(){return this.listRefs("joints")}}class index_modern_Texture extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||index_modern_ImageUtils.extensionToMimeType(index_modern_FileUtils.extension(this.get("uri")))}setMimeType(o){return this.set("mimeType",o)}getURI(){return this.get("uri")}setURI(o){this.set("uri",o);const l=index_modern_ImageUtils.extensionToMimeType(index_modern_FileUtils.extension(o));return l&&this.set("mimeType",l),this}getImage(){return this.get("image")}setImage(o){return this.set("image",index_modern_BufferUtils.assertView(o))}getSize(){const o=this.get("image");return o?index_modern_ImageUtils.getSize(o,this.getMimeType()):null}}class index_modern_Root extends ExtensibleProperty{init(){this.propertyType=index_modern_PropertyType.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${VERSION}`,version:"2.0"},defaultScene:null,accessors:new RefSet,animations:new RefSet,buffers:new RefSet,cameras:new RefSet,materials:new RefSet,meshes:new RefSet,nodes:new RefSet,scenes:new RefSet,skins:new RefSet,textures:new RefSet})}constructor(o){super(o),this._extensions=new Set,o.addEventListener("node:create",l=>{this._addChildOfRoot(l.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(o,l=COPY_IDENTITY){if(l===COPY_IDENTITY)throw new Error("Root cannot be copied.");this.set("asset",index_modern_extends({},o.get("asset"))),this.setName(o.getName()),this.setExtras(index_modern_extends({},o.getExtras())),this.setDefaultScene(o.getDefaultScene()?l(o.getDefaultScene()):null);for(const c of o.listRefMapKeys("extensions")){const u=o.getExtension(c);this.setExtension(c,l(u))}return this}_addChildOfRoot(o){return o instanceof index_modern_Scene?this.addRef("scenes",o):o instanceof index_modern_Node?this.addRef("nodes",o):o instanceof Camera?this.addRef("cameras",o):o instanceof Skin?this.addRef("skins",o):o instanceof index_modern_Mesh?this.addRef("meshes",o):o instanceof index_modern_Material?this.addRef("materials",o):o instanceof index_modern_Texture?this.addRef("textures",o):o instanceof Animation?this.addRef("animations",o):o instanceof index_modern_Accessor?this.addRef("accessors",o):o instanceof Buffer$1&&this.addRef("buffers",o),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this._extensions)}listExtensionsRequired(){return this.listExtensionsUsed().filter(o=>o.isRequired())}_enableExtension(o){return this._extensions.add(o),this}_disableExtension(o){return this._extensions.delete(o),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(o){return this.setRef("defaultScene",o)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}}class index_modern_Document{static fromGraph(o){return index_modern_Document._GRAPH_DOCUMENTS.get(o)||null}constructor(){this._graph=new Graph,this._root=new index_modern_Root(this._graph),this._logger=Logger.DEFAULT_INSTANCE,index_modern_Document._GRAPH_DOCUMENTS.set(this._graph,this)}getRoot(){return this._root}getGraph(){return this._graph}getLogger(){return this._logger}setLogger(o){return this._logger=o,this}clone(){throw new Error("Use 'cloneDocument(source)' from '@gltf-transform/functions'.")}merge(o){throw new Error("Use 'mergeDocuments(target, source)' from '@gltf-transform/functions'.")}async transform(...o){const l=o.map(c=>c.name);for(const c of o)await c(this,{stack:l});return this}createExtension(o){const l=o.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(c=>c.extensionName===l)||new o(this)}createScene(o=""){return new index_modern_Scene(this._graph,o)}createNode(o=""){return new index_modern_Node(this._graph,o)}createCamera(o=""){return new Camera(this._graph,o)}createSkin(o=""){return new Skin(this._graph,o)}createMesh(o=""){return new index_modern_Mesh(this._graph,o)}createPrimitive(){return new index_modern_Primitive(this._graph)}createPrimitiveTarget(o=""){return new index_modern_PrimitiveTarget(this._graph,o)}createMaterial(o=""){return new index_modern_Material(this._graph,o)}createTexture(o=""){return new index_modern_Texture(this._graph,o)}createAnimation(o=""){return new Animation(this._graph,o)}createAnimationChannel(o=""){return new index_modern_AnimationChannel(this._graph,o)}createAnimationSampler(o=""){return new index_modern_AnimationSampler(this._graph,o)}createAccessor(o="",l=null){return l||(l=this.getRoot().listBuffers()[0]),new index_modern_Accessor(this._graph,o).setBuffer(l)}createBuffer(o=""){return new Buffer$1(this._graph,o)}}index_modern_Document._GRAPH_DOCUMENTS=new WeakMap;class Extension{constructor(o){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this._listener=void 0,this.document=o,o.getRoot()._enableExtension(this),this._listener=c=>{const u=c,h=u.target;h instanceof index_modern_ExtensionProperty&&h.extensionName===this.extensionName&&(u.type==="node:create"&&this._addExtensionProperty(h),u.type==="node:dispose"&&this._removeExtensionProperty(h))};const l=o.getGraph();l.addEventListener("node:create",this._listener),l.addEventListener("node:dispose",this._listener)}dispose(){this.document.getRoot()._disableExtension(this);const o=this.document.getGraph();o.removeEventListener("node:create",this._listener),o.removeEventListener("node:dispose",this._listener);for(const l of this.properties)l.dispose()}static register(){}isRequired(){return this.required}setRequired(o){return this.required=o,this}listProperties(){return Array.from(this.properties)}_addExtensionProperty(o){return this.properties.add(o),this}_removeExtensionProperty(o){return this.properties.delete(o),this}install(o,l){return this}preread(o,l){return this}prewrite(o,l){return this}}Extension.EXTENSION_NAME=void 0;class ReaderContext{constructor(o){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=o}setTextureInfo(o,l){this.textureInfos.set(o,l),l.texCoord!==void 0&&o.setTexCoord(l.texCoord),l.extras!==void 0&&o.setExtras(l.extras);const c=this.jsonDoc.json.textures[l.index];if(c.sampler===void 0)return;const u=this.jsonDoc.json.samplers[c.sampler];u.magFilter!==void 0&&o.setMagFilter(u.magFilter),u.minFilter!==void 0&&o.setMinFilter(u.minFilter),u.wrapS!==void 0&&o.setWrapS(u.wrapS),u.wrapT!==void 0&&o.setWrapT(u.wrapT)}}const index_modern_DEFAULT_OPTIONS={logger:Logger.DEFAULT_INSTANCE,extensions:[],dependencies:{}},SUPPORTED_PREREAD_TYPES=new Set([index_modern_PropertyType.BUFFER,index_modern_PropertyType.TEXTURE,index_modern_PropertyType.MATERIAL,index_modern_PropertyType.MESH,index_modern_PropertyType.PRIMITIVE,index_modern_PropertyType.NODE,index_modern_PropertyType.SCENE]);class GLTFReader{static read(o,l=index_modern_DEFAULT_OPTIONS){const c=index_modern_extends({},index_modern_DEFAULT_OPTIONS,l),{json:u}=o,h=new index_modern_Document().setLogger(c.logger);this.validate(o,c);const _=new ReaderContext(o),A=u.asset,w=h.getRoot().getAsset();A.copyright&&(w.copyright=A.copyright),A.extras&&(w.extras=A.extras),u.extras!==void 0&&h.getRoot().setExtras(index_modern_extends({},u.extras));const C=u.extensionsUsed||[],M=u.extensionsRequired||[];c.extensions.sort((at,lt)=>at.EXTENSION_NAME>lt.EXTENSION_NAME?1:-1);for(const at of c.extensions)if(C.includes(at.EXTENSION_NAME)){const lt=h.createExtension(at).setRequired(M.includes(at.EXTENSION_NAME)),pt=lt.prereadTypes.filter(xt=>!SUPPORTED_PREREAD_TYPES.has(xt));pt.length&&c.logger.warn(`Preread hooks for some types (${pt.join()}), requested by extension ${lt.extensionName}, are unsupported. Please file an issue or a PR.`);for(const xt of lt.readDependencies)lt.install(xt,c.dependencies[xt])}const O=u.buffers||[];h.getRoot().listExtensionsUsed().filter(at=>at.prereadTypes.includes(index_modern_PropertyType.BUFFER)).forEach(at=>at.preread(_,index_modern_PropertyType.BUFFER)),_.buffers=O.map(at=>{const lt=h.createBuffer(at.name);return at.extras&&lt.setExtras(at.extras),at.uri&&at.uri.indexOf("__")!==0&&lt.setURI(at.uri),lt});const ne=u.bufferViews||[];_.bufferViewBuffers=ne.map((at,lt)=>{if(!_.bufferViews[lt]){const pt=o.json.buffers[at.buffer],xt=pt.uri?o.resources[pt.uri]:o.resources[GLB_BUFFER],Tt=at.byteOffset||0;_.bufferViews[lt]=index_modern_BufferUtils.toView(xt,Tt,at.byteLength)}return _.buffers[at.buffer]});const ce=u.accessors||[];_.accessors=ce.map(at=>{const lt=_.bufferViewBuffers[at.bufferView],pt=h.createAccessor(at.name,lt).setType(at.type);return at.extras&&pt.setExtras(at.extras),at.normalized!==void 0&&pt.setNormalized(at.normalized),at.bufferView===void 0||pt.setArray(getAccessorArray(at,_)),pt});const ue=u.images||[],ye=u.textures||[];h.getRoot().listExtensionsUsed().filter(at=>at.prereadTypes.includes(index_modern_PropertyType.TEXTURE)).forEach(at=>at.preread(_,index_modern_PropertyType.TEXTURE)),_.textures=ue.map(at=>{const lt=h.createTexture(at.name);if(at.extras&&lt.setExtras(at.extras),at.bufferView!==void 0){const pt=u.bufferViews[at.bufferView],xt=o.json.buffers[pt.buffer],Tt=xt.uri?o.resources[xt.uri]:o.resources[GLB_BUFFER],Pt=pt.byteOffset||0,Lt=pt.byteLength,Bt=Tt.slice(Pt,Pt+Lt);lt.setImage(Bt)}else at.uri!==void 0&&(lt.setImage(o.resources[at.uri]),at.uri.indexOf("__")!==0&&lt.setURI(at.uri));if(at.mimeType!==void 0)lt.setMimeType(at.mimeType);else if(at.uri){const pt=index_modern_FileUtils.extension(at.uri);lt.setMimeType(index_modern_ImageUtils.extensionToMimeType(pt))}return lt}),h.getRoot().listExtensionsUsed().filter(at=>at.prereadTypes.includes(index_modern_PropertyType.MATERIAL)).forEach(at=>at.preread(_,index_modern_PropertyType.MATERIAL));const Oe=u.materials||[];_.materials=Oe.map(at=>{const lt=h.createMaterial(at.name);at.extras&&lt.setExtras(at.extras),at.alphaMode!==void 0&&lt.setAlphaMode(at.alphaMode),at.alphaCutoff!==void 0&&lt.setAlphaCutoff(at.alphaCutoff),at.doubleSided!==void 0&&lt.setDoubleSided(at.doubleSided);const pt=at.pbrMetallicRoughness||{};if(pt.baseColorFactor!==void 0&&lt.setBaseColorFactor(pt.baseColorFactor),at.emissiveFactor!==void 0&&lt.setEmissiveFactor(at.emissiveFactor),pt.metallicFactor!==void 0&&lt.setMetallicFactor(pt.metallicFactor),pt.roughnessFactor!==void 0&&lt.setRoughnessFactor(pt.roughnessFactor),pt.baseColorTexture!==void 0){const xt=pt.baseColorTexture,Tt=_.textures[ye[xt.index].source];lt.setBaseColorTexture(Tt),_.setTextureInfo(lt.getBaseColorTextureInfo(),xt)}if(at.emissiveTexture!==void 0){const xt=at.emissiveTexture,Tt=_.textures[ye[xt.index].source];lt.setEmissiveTexture(Tt),_.setTextureInfo(lt.getEmissiveTextureInfo(),xt)}if(at.normalTexture!==void 0){const xt=at.normalTexture,Tt=_.textures[ye[xt.index].source];lt.setNormalTexture(Tt),_.setTextureInfo(lt.getNormalTextureInfo(),xt),at.normalTexture.scale!==void 0&&lt.setNormalScale(at.normalTexture.scale)}if(at.occlusionTexture!==void 0){const xt=at.occlusionTexture,Tt=_.textures[ye[xt.index].source];lt.setOcclusionTexture(Tt),_.setTextureInfo(lt.getOcclusionTextureInfo(),xt),at.occlusionTexture.strength!==void 0&&lt.setOcclusionStrength(at.occlusionTexture.strength)}if(pt.metallicRoughnessTexture!==void 0){const xt=pt.metallicRoughnessTexture,Tt=_.textures[ye[xt.index].source];lt.setMetallicRoughnessTexture(Tt),_.setTextureInfo(lt.getMetallicRoughnessTextureInfo(),xt)}return lt}),h.getRoot().listExtensionsUsed().filter(at=>at.prereadTypes.includes(index_modern_PropertyType.MESH)).forEach(at=>at.preread(_,index_modern_PropertyType.MESH));const ke=u.meshes||[];h.getRoot().listExtensionsUsed().filter(at=>at.prereadTypes.includes(index_modern_PropertyType.PRIMITIVE)).forEach(at=>at.preread(_,index_modern_PropertyType.PRIMITIVE)),_.meshes=ke.map(at=>{const lt=h.createMesh(at.name);return at.extras&&lt.setExtras(at.extras),at.weights!==void 0&&lt.setWeights(at.weights),(at.primitives||[]).forEach(pt=>{const xt=h.createPrimitive();pt.extras&&xt.setExtras(pt.extras),pt.material!==void 0&&xt.setMaterial(_.materials[pt.material]),pt.mode!==void 0&&xt.setMode(pt.mode);for(const[Pt,Lt]of Object.entries(pt.attributes||{}))xt.setAttribute(Pt,_.accessors[Lt]);pt.indices!==void 0&&xt.setIndices(_.accessors[pt.indices]);const Tt=at.extras&&at.extras.targetNames||[];(pt.targets||[]).forEach((Pt,Lt)=>{const Bt=Tt[Lt]||Lt.toString(),Ut=h.createPrimitiveTarget(Bt);for(const[kt,Vt]of Object.entries(Pt))Ut.setAttribute(kt,_.accessors[Vt]);xt.addTarget(Ut)}),lt.addPrimitive(xt)}),lt});const Ve=u.cameras||[];_.cameras=Ve.map(at=>{const lt=h.createCamera(at.name).setType(at.type);if(at.extras&&lt.setExtras(at.extras),at.type===Camera.Type.PERSPECTIVE){const pt=at.perspective;lt.setYFov(pt.yfov),lt.setZNear(pt.znear),pt.zfar!==void 0&&lt.setZFar(pt.zfar),pt.aspectRatio!==void 0&&lt.setAspectRatio(pt.aspectRatio)}else{const pt=at.orthographic;lt.setZNear(pt.znear).setZFar(pt.zfar).setXMag(pt.xmag).setYMag(pt.ymag)}return lt});const tt=u.nodes||[];h.getRoot().listExtensionsUsed().filter(at=>at.prereadTypes.includes(index_modern_PropertyType.NODE)).forEach(at=>at.preread(_,index_modern_PropertyType.NODE)),_.nodes=tt.map(at=>{const lt=h.createNode(at.name);if(at.extras&&lt.setExtras(at.extras),at.translation!==void 0&&lt.setTranslation(at.translation),at.rotation!==void 0&&lt.setRotation(at.rotation),at.scale!==void 0&&lt.setScale(at.scale),at.matrix!==void 0){const pt=[0,0,0],xt=[0,0,0,1],Tt=[1,1,1];index_modern_MathUtils.decompose(at.matrix,pt,xt,Tt),lt.setTranslation(pt),lt.setRotation(xt),lt.setScale(Tt)}return at.weights!==void 0&&lt.setWeights(at.weights),lt});const ht=u.skins||[];_.skins=ht.map(at=>{const lt=h.createSkin(at.name);at.extras&&lt.setExtras(at.extras),at.inverseBindMatrices!==void 0&&lt.setInverseBindMatrices(_.accessors[at.inverseBindMatrices]),at.skeleton!==void 0&&lt.setSkeleton(_.nodes[at.skeleton]);for(const pt of at.joints)lt.addJoint(_.nodes[pt]);return lt}),tt.map((at,lt)=>{const pt=_.nodes[lt];(at.children||[]).forEach(xt=>pt.addChild(_.nodes[xt])),at.mesh!==void 0&&pt.setMesh(_.meshes[at.mesh]),at.camera!==void 0&&pt.setCamera(_.cameras[at.camera]),at.skin!==void 0&&pt.setSkin(_.skins[at.skin])});const ut=u.animations||[];_.animations=ut.map(at=>{const lt=h.createAnimation(at.name);at.extras&&lt.setExtras(at.extras);const pt=(at.samplers||[]).map(xt=>{const Tt=h.createAnimationSampler().setInput(_.accessors[xt.input]).setOutput(_.accessors[xt.output]).setInterpolation(xt.interpolation||index_modern_AnimationSampler.Interpolation.LINEAR);return xt.extras&&Tt.setExtras(xt.extras),lt.addSampler(Tt),Tt});return(at.channels||[]).forEach(xt=>{const Tt=h.createAnimationChannel().setSampler(pt[xt.sampler]).setTargetPath(xt.target.path);xt.target.node!==void 0&&Tt.setTargetNode(_.nodes[xt.target.node]),xt.extras&&Tt.setExtras(xt.extras),lt.addChannel(Tt)}),lt});const _t=u.scenes||[];return h.getRoot().listExtensionsUsed().filter(at=>at.prereadTypes.includes(index_modern_PropertyType.SCENE)).forEach(at=>at.preread(_,index_modern_PropertyType.SCENE)),_.scenes=_t.map(at=>{const lt=h.createScene(at.name);return at.extras&&lt.setExtras(at.extras),(at.nodes||[]).map(pt=>_.nodes[pt]).forEach(pt=>lt.addChild(pt)),lt}),u.scene!==void 0&&h.getRoot().setDefaultScene(_.scenes[u.scene]),h.getRoot().listExtensionsUsed().forEach(at=>at.read(_)),ce.forEach((at,lt)=>{const pt=_.accessors[lt],xt=!!at.sparse,Tt=!at.bufferView&&!pt.getArray();(xt||Tt)&&pt.setSparse(!0).setArray(getSparseArray(at,_))}),h}static validate(o,l){const c=o.json;if(c.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${c.asset.version}".`);if(c.extensionsRequired){for(const u of c.extensionsRequired)if(!l.extensions.find(h=>h.EXTENSION_NAME===u))throw new Error(`Missing required extension, "${u}".`)}if(c.extensionsUsed)for(const u of c.extensionsUsed)l.extensions.find(h=>h.EXTENSION_NAME===u)||l.logger.warn(`Missing optional extension, "${u}".`)}}function getInterleavedArray(d,o){const l=o.jsonDoc,c=o.bufferViews[d.bufferView],u=l.json.bufferViews[d.bufferView],h=index_modern_ComponentTypeToTypedArray[d.componentType],_=index_modern_Accessor.getElementSize(d.type),A=h.BYTES_PER_ELEMENT,w=d.byteOffset||0,C=new h(d.count*_),M=new DataView(c.buffer,c.byteOffset,c.byteLength),O=u.byteStride;for(let ne=0;ne<d.count;ne++)for(let ce=0;ce<_;ce++){const ue=w+ne*O+ce*A;let ye;switch(d.componentType){case index_modern_Accessor.ComponentType.FLOAT:ye=M.getFloat32(ue,!0);break;case index_modern_Accessor.ComponentType.UNSIGNED_INT:ye=M.getUint32(ue,!0);break;case index_modern_Accessor.ComponentType.UNSIGNED_SHORT:ye=M.getUint16(ue,!0);break;case index_modern_Accessor.ComponentType.UNSIGNED_BYTE:ye=M.getUint8(ue);break;case index_modern_Accessor.ComponentType.SHORT:ye=M.getInt16(ue,!0);break;case index_modern_Accessor.ComponentType.BYTE:ye=M.getInt8(ue);break;default:throw new Error(`Unexpected componentType "${d.componentType}".`)}C[ne*_+ce]=ye}return C}function getAccessorArray(d,o){const l=o.jsonDoc,c=o.bufferViews[d.bufferView],u=l.json.bufferViews[d.bufferView],h=index_modern_ComponentTypeToTypedArray[d.componentType],_=index_modern_Accessor.getElementSize(d.type),A=h.BYTES_PER_ELEMENT,w=_*A;if(u.byteStride!==void 0&&u.byteStride!==w)return getInterleavedArray(d,o);const C=c.byteOffset+(d.byteOffset||0),M=d.count*_*A;return new h(c.buffer.slice(C,C+M))}function getSparseArray(d,o){const l=index_modern_ComponentTypeToTypedArray[d.componentType],c=index_modern_Accessor.getElementSize(d.type);let u;u=d.bufferView!==void 0?getAccessorArray(d,o):new l(d.count*c);const h=d.sparse;if(!h)return u;const _=h.count,A=index_modern_extends({},d,h.indices,{count:_,type:"SCALAR"}),w=index_modern_extends({},d,h.values,{count:_}),C=getAccessorArray(A,o),M=getAccessorArray(w,o);for(let O=0;O<A.count;O++)for(let ne=0;ne<c;ne++)u[C[O]*c+ne]=M[O*c+ne];return u}var BufferViewTarget;(function(d){d[d.ARRAY_BUFFER=34962]="ARRAY_BUFFER",d[d.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(BufferViewTarget||(BufferViewTarget={}));class WriterContext{constructor(o,l,c){this._doc=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this._accessorUsageMap=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this._doc=o,this.jsonDoc=l,this.options=c;const u=o.getRoot(),h=u.listBuffers().length,_=u.listTextures().length;this.bufferURIGenerator=new UniqueURIGenerator(h>1,()=>c.basename||"buffer"),this.imageURIGenerator=new UniqueURIGenerator(_>1,A=>getSlot(o,A)||c.basename||"texture"),this.logger=o.getLogger()}createTextureInfoDef(o,l){const c={magFilter:l.getMagFilter()||void 0,minFilter:l.getMinFilter()||void 0,wrapS:l.getWrapS(),wrapT:l.getWrapT()},u=JSON.stringify(c);this.samplerDefIndexMap.has(u)||(this.samplerDefIndexMap.set(u,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(c));const h={source:this.imageIndexMap.get(o),sampler:this.samplerDefIndexMap.get(u)},_=JSON.stringify(h);this.textureDefIndexMap.has(_)||(this.textureDefIndexMap.set(_,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(h));const A={index:this.textureDefIndexMap.get(_)};return l.getTexCoord()!==0&&(A.texCoord=l.getTexCoord()),Object.keys(l.getExtras()).length>0&&(A.extras=l.getExtras()),this.textureInfoDefMap.set(l,A),A}createPropertyDef(o){const l={};return o.getName()&&(l.name=o.getName()),Object.keys(o.getExtras()).length>0&&(l.extras=o.getExtras()),l}createAccessorDef(o){const l=this.createPropertyDef(o);return l.type=o.getType(),l.componentType=o.getComponentType(),l.count=o.getCount(),this._doc.getGraph().listParentEdges(o).some(c=>c.getName()==="attributes"&&c.getAttributes().key==="POSITION"||c.getName()==="input")&&(l.max=o.getMax([]).map(Math.fround),l.min=o.getMin([]).map(Math.fround)),o.getNormalized()&&(l.normalized=o.getNormalized()),l}createImageData(o,l,c){if(this.options.format===Format.GLB)this.imageBufferViews.push(l),o.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:l.byteLength});else{const u=index_modern_ImageUtils.mimeTypeToExtension(c.getMimeType());o.uri=this.imageURIGenerator.createURI(c,u),this.assignResourceURI(o.uri,l,!1)}}assignResourceURI(o,l,c){const u=this.jsonDoc.resources;if(!(o in u))return void(u[o]=l);if(l===u[o])return void this.logger.warn(`Duplicate resource URI, "${o}".`);const h=`Resource URI "${o}" already assigned to different data.`;if(c)throw new Error(h);this.logger.warn(h)}getAccessorUsage(o){const l=this._accessorUsageMap.get(o);if(l)return l;if(o.getSparse())return BufferViewUsage$1.SPARSE;for(const c of this._doc.getGraph().listParentEdges(o)){const{usage:u}=c.getAttributes();if(u)return u;c.getParent().propertyType!==index_modern_PropertyType.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${c.getName()}".`)}return BufferViewUsage$1.OTHER}addAccessorToUsageGroup(o,l){const c=this._accessorUsageMap.get(o);if(c&&c!==l)throw new Error(`Accessor with usage "${c}" cannot be reused as "${l}".`);return this._accessorUsageMap.set(o,l),this}}WriterContext.BufferViewTarget=BufferViewTarget,WriterContext.BufferViewUsage=BufferViewUsage$1,WriterContext.USAGE_TO_TARGET={[BufferViewUsage$1.ARRAY_BUFFER]:BufferViewTarget.ARRAY_BUFFER,[BufferViewUsage$1.ELEMENT_ARRAY_BUFFER]:BufferViewTarget.ELEMENT_ARRAY_BUFFER};class UniqueURIGenerator{constructor(o,l){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=o,this.basename=l}createURI(o,l){if(o.getURI())return o.getURI();if(this.multiple){const c=this.basename(o);return this.counter[c]=this.counter[c]||1,`${c}_${this.counter[c]++}.${l}`}return`${this.basename(o)}.${l}`}}function getSlot(d,o){const l=d.getGraph().listParentEdges(o).find(c=>c.getParent()!==d.getRoot());return l?l.getName().replace(/texture$/i,""):""}const{BufferViewUsage}=WriterContext,{UNSIGNED_INT,UNSIGNED_SHORT,UNSIGNED_BYTE}=index_modern_Accessor.ComponentType,SUPPORTED_PREWRITE_TYPES=new Set([index_modern_PropertyType.ACCESSOR,index_modern_PropertyType.BUFFER,index_modern_PropertyType.MATERIAL,index_modern_PropertyType.MESH]);class index_modern_GLTFWriter{static write(o,l){const c=o.getGraph(),u=o.getRoot(),h={asset:index_modern_extends({generator:`glTF-Transform ${VERSION}`},u.getAsset()),extras:index_modern_extends({},u.getExtras())},_={json:h,resources:{}},A=new WriterContext(o,_,l),w=l.logger||Logger.DEFAULT_INSTANCE,C=new Set(l.extensions.map(Oe=>Oe.EXTENSION_NAME)),M=o.getRoot().listExtensionsUsed().filter(Oe=>C.has(Oe.extensionName)).sort((Oe,ke)=>Oe.extensionName>ke.extensionName?1:-1),O=o.getRoot().listExtensionsRequired().filter(Oe=>C.has(Oe.extensionName)).sort((Oe,ke)=>Oe.extensionName>ke.extensionName?1:-1);M.length<o.getRoot().listExtensionsUsed().length&&w.warn("Some extensions were not registered for I/O, and will not be written.");for(const Oe of M){const ke=Oe.prewriteTypes.filter(Ve=>!SUPPORTED_PREWRITE_TYPES.has(Ve));ke.length&&w.warn(`Prewrite hooks for some types (${ke.join()}), requested by extension ${Oe.extensionName}, are unsupported. Please file an issue or a PR.`);for(const Ve of Oe.writeDependencies)Oe.install(Ve,l.dependencies[Ve])}function ne(Oe,ke,Ve,tt){const ht=[];let ut=0;for(const at of Oe){const lt=A.createAccessorDef(at);lt.bufferView=h.bufferViews.length;const pt=at.getArray(),xt=index_modern_BufferUtils.pad(index_modern_BufferUtils.toView(pt));lt.byteOffset=ut,ut+=xt.byteLength,ht.push(xt),A.accessorIndexMap.set(at,h.accessors.length),h.accessors.push(lt)}const _t={buffer:ke,byteOffset:Ve,byteLength:index_modern_BufferUtils.concat(ht).byteLength};return tt&&(_t.target=tt),h.bufferViews.push(_t),{buffers:ht,byteLength:ut}}function ce(Oe,ke,Ve){const tt=Oe[0].getCount();let ht=0;for(const pt of Oe){const xt=A.createAccessorDef(pt);xt.bufferView=h.bufferViews.length,xt.byteOffset=ht;const Tt=pt.getElementSize(),Pt=pt.getComponentSize();ht+=index_modern_BufferUtils.padNumber(Tt*Pt),A.accessorIndexMap.set(pt,h.accessors.length),h.accessors.push(xt)}const ut=tt*ht,_t=new ArrayBuffer(ut),at=new DataView(_t);for(let pt=0;pt<tt;pt++){let xt=0;for(const Tt of Oe){const Pt=Tt.getElementSize(),Lt=Tt.getComponentSize(),Bt=Tt.getComponentType(),Ut=Tt.getArray();for(let kt=0;kt<Pt;kt++){const Vt=pt*ht+xt+kt*Lt,si=Ut[pt*Pt+kt];switch(Bt){case index_modern_Accessor.ComponentType.FLOAT:at.setFloat32(Vt,si,!0);break;case index_modern_Accessor.ComponentType.BYTE:at.setInt8(Vt,si);break;case index_modern_Accessor.ComponentType.SHORT:at.setInt16(Vt,si,!0);break;case index_modern_Accessor.ComponentType.UNSIGNED_BYTE:at.setUint8(Vt,si);break;case index_modern_Accessor.ComponentType.UNSIGNED_SHORT:at.setUint16(Vt,si,!0);break;case index_modern_Accessor.ComponentType.UNSIGNED_INT:at.setUint32(Vt,si,!0);break;default:throw new Error("Unexpected component type: "+Bt)}}xt+=index_modern_BufferUtils.padNumber(Pt*Lt)}}const lt={buffer:ke,byteOffset:Ve,byteLength:ut,byteStride:ht,target:WriterContext.BufferViewTarget.ARRAY_BUFFER};return h.bufferViews.push(lt),{byteLength:ut,buffers:[new Uint8Array(_t)]}}function ue(Oe,ke,Ve){const tt=[];let ht=0;const ut=new Map;let _t=-1/0,at=!1;for(const Bt of Oe){const Ut=A.createAccessorDef(Bt);h.accessors.push(Ut),A.accessorIndexMap.set(Bt,h.accessors.length-1);const kt=[],Vt=[],si=[],Jt=new Array(Bt.getElementSize()).fill(0);for(let ci=0,ri=Bt.getCount();ci<ri;ci++)if(Bt.getElement(ci,si),!index_modern_MathUtils.eq(si,Jt,0)){_t=Math.max(ci,_t),kt.push(ci);for(let Ct=0;Ct<si.length;Ct++)Vt.push(si[Ct])}const Wt=kt.length,Zt={accessorDef:Ut,count:Wt};if(ut.set(Bt,Zt),Wt===0)continue;Wt>Bt.getCount()/2&&(at=!0);const ti=index_modern_ComponentTypeToTypedArray[Bt.getComponentType()];Zt.indices=kt,Zt.values=new ti(Vt)}if(!Number.isFinite(_t))return{buffers:tt,byteLength:ht};at&&w.warn("Some sparse accessors have >50% non-zero elements, which may increase file size.");const lt=_t<255?Uint8Array:_t<65535?Uint16Array:Uint32Array,pt=_t<255?UNSIGNED_BYTE:_t<65535?UNSIGNED_SHORT:UNSIGNED_INT,xt={buffer:ke,byteOffset:Ve+ht,byteLength:0};for(const Bt of Oe){const Ut=ut.get(Bt);if(Ut.count===0)continue;Ut.indicesByteOffset=xt.byteLength;const kt=index_modern_BufferUtils.pad(index_modern_BufferUtils.toView(new lt(Ut.indices)));tt.push(kt),ht+=kt.byteLength,xt.byteLength+=kt.byteLength}h.bufferViews.push(xt);const Tt=h.bufferViews.length-1,Pt={buffer:ke,byteOffset:Ve+ht,byteLength:0};for(const Bt of Oe){const Ut=ut.get(Bt);if(Ut.count===0)continue;Ut.valuesByteOffset=Pt.byteLength;const kt=index_modern_BufferUtils.pad(index_modern_BufferUtils.toView(Ut.values));tt.push(kt),ht+=kt.byteLength,Pt.byteLength+=kt.byteLength}h.bufferViews.push(Pt);const Lt=h.bufferViews.length-1;for(const Bt of Oe){const Ut=ut.get(Bt);Ut.count!==0&&(Ut.accessorDef.sparse={count:Ut.count,indices:{bufferView:Tt,byteOffset:Ut.indicesByteOffset,componentType:pt},values:{bufferView:Lt,byteOffset:Ut.valuesByteOffset}})}return{buffers:tt,byteLength:ht}}if(h.accessors=[],h.bufferViews=[],h.samplers=[],h.textures=[],h.images=u.listTextures().map((Oe,ke)=>{const Ve=A.createPropertyDef(Oe);Oe.getMimeType()&&(Ve.mimeType=Oe.getMimeType());const tt=Oe.getImage();return tt&&A.createImageData(Ve,tt,Oe),A.imageIndexMap.set(Oe,ke),Ve}),M.filter(Oe=>Oe.prewriteTypes.includes(index_modern_PropertyType.ACCESSOR)).forEach(Oe=>Oe.prewrite(A,index_modern_PropertyType.ACCESSOR)),u.listAccessors().forEach(Oe=>{const ke=A.accessorUsageGroupedByParent,Ve=A.accessorParents;if(A.accessorIndexMap.has(Oe))return;const tt=A.getAccessorUsage(Oe);if(A.addAccessorToUsageGroup(Oe,tt),ke.has(tt)){const ht=c.listParents(Oe).find(ut=>ut.propertyType!==index_modern_PropertyType.ROOT);Ve.set(Oe,ht)}}),M.filter(Oe=>Oe.prewriteTypes.includes(index_modern_PropertyType.BUFFER)).forEach(Oe=>Oe.prewrite(A,index_modern_PropertyType.BUFFER)),(u.listAccessors().length>0||A.otherBufferViews.size>0||u.listTextures().length>0&&l.format===Format.GLB)&&u.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");h.buffers=[],u.listBuffers().forEach((Oe,ke)=>{const Ve=A.createPropertyDef(Oe),tt=A.accessorUsageGroupedByParent,ht=Oe.listParents().filter(Pt=>Pt instanceof index_modern_Accessor),ut=new Set(ht.map(Pt=>A.accessorParents.get(Pt))),_t=new Map(Array.from(ut).map((Pt,Lt)=>[Pt,Lt])),at={};for(const Pt of ht){var lt;if(A.accessorIndexMap.has(Pt))continue;const Lt=A.getAccessorUsage(Pt);let Bt=Lt;if(tt.has(Lt)){const Ut=A.accessorParents.get(Pt);Bt+=`:${_t.get(Ut)}`}at[lt=Bt]||(at[lt]={usage:Lt,accessors:[]}),at[Bt].accessors.push(Pt)}const pt=[],xt=h.buffers.length;let Tt=0;for(const{usage:Pt,accessors:Lt}of Object.values(at))if(Pt===BufferViewUsage.ARRAY_BUFFER&&l.vertexLayout===VertexLayout.INTERLEAVED){const Bt=ce(Lt,xt,Tt);Tt+=Bt.byteLength;for(const Ut of Bt.buffers)pt.push(Ut)}else if(Pt===BufferViewUsage.ARRAY_BUFFER)for(const Bt of Lt){const Ut=ce([Bt],xt,Tt);Tt+=Ut.byteLength;for(const kt of Ut.buffers)pt.push(kt)}else if(Pt===BufferViewUsage.SPARSE){const Bt=ue(Lt,xt,Tt);Tt+=Bt.byteLength;for(const Ut of Bt.buffers)pt.push(Ut)}else if(Pt===BufferViewUsage.ELEMENT_ARRAY_BUFFER){const Bt=ne(Lt,xt,Tt,WriterContext.BufferViewTarget.ELEMENT_ARRAY_BUFFER);Tt+=Bt.byteLength;for(const Ut of Bt.buffers)pt.push(Ut)}else{const Bt=ne(Lt,xt,Tt);Tt+=Bt.byteLength;for(const Ut of Bt.buffers)pt.push(Ut)}if(A.imageBufferViews.length&&ke===0){for(let Pt=0;Pt<A.imageBufferViews.length;Pt++)if(h.bufferViews[h.images[Pt].bufferView].byteOffset=Tt,Tt+=A.imageBufferViews[Pt].byteLength,pt.push(A.imageBufferViews[Pt]),Tt%8){const Lt=8-Tt%8;Tt+=Lt,pt.push(new Uint8Array(Lt))}}if(A.otherBufferViews.has(Oe))for(const Pt of A.otherBufferViews.get(Oe))h.bufferViews.push({buffer:xt,byteOffset:Tt,byteLength:Pt.byteLength}),A.otherBufferViewsIndexMap.set(Pt,h.bufferViews.length-1),Tt+=Pt.byteLength,pt.push(Pt);if(Tt){let Pt;l.format===Format.GLB?Pt=GLB_BUFFER:(Pt=A.bufferURIGenerator.createURI(Oe,"bin"),Ve.uri=Pt),Ve.byteLength=Tt,A.assignResourceURI(Pt,index_modern_BufferUtils.concat(pt),!0)}h.buffers.push(Ve),A.bufferIndexMap.set(Oe,ke)}),u.listAccessors().find(Oe=>!Oe.getBuffer())&&w.warn("Skipped writing one or more Accessors: no Buffer assigned."),M.filter(Oe=>Oe.prewriteTypes.includes(index_modern_PropertyType.MATERIAL)).forEach(Oe=>Oe.prewrite(A,index_modern_PropertyType.MATERIAL)),h.materials=u.listMaterials().map((Oe,ke)=>{const Ve=A.createPropertyDef(Oe);if(Oe.getAlphaMode()!==index_modern_Material.AlphaMode.OPAQUE&&(Ve.alphaMode=Oe.getAlphaMode()),Oe.getAlphaMode()===index_modern_Material.AlphaMode.MASK&&(Ve.alphaCutoff=Oe.getAlphaCutoff()),Oe.getDoubleSided()&&(Ve.doubleSided=!0),Ve.pbrMetallicRoughness={},index_modern_MathUtils.eq(Oe.getBaseColorFactor(),[1,1,1,1])||(Ve.pbrMetallicRoughness.baseColorFactor=Oe.getBaseColorFactor()),index_modern_MathUtils.eq(Oe.getEmissiveFactor(),[0,0,0])||(Ve.emissiveFactor=Oe.getEmissiveFactor()),Oe.getRoughnessFactor()!==1&&(Ve.pbrMetallicRoughness.roughnessFactor=Oe.getRoughnessFactor()),Oe.getMetallicFactor()!==1&&(Ve.pbrMetallicRoughness.metallicFactor=Oe.getMetallicFactor()),Oe.getBaseColorTexture()){const tt=Oe.getBaseColorTexture(),ht=Oe.getBaseColorTextureInfo();Ve.pbrMetallicRoughness.baseColorTexture=A.createTextureInfoDef(tt,ht)}if(Oe.getEmissiveTexture()){const tt=Oe.getEmissiveTexture(),ht=Oe.getEmissiveTextureInfo();Ve.emissiveTexture=A.createTextureInfoDef(tt,ht)}if(Oe.getNormalTexture()){const tt=Oe.getNormalTexture(),ht=Oe.getNormalTextureInfo(),ut=A.createTextureInfoDef(tt,ht);Oe.getNormalScale()!==1&&(ut.scale=Oe.getNormalScale()),Ve.normalTexture=ut}if(Oe.getOcclusionTexture()){const tt=Oe.getOcclusionTexture(),ht=Oe.getOcclusionTextureInfo(),ut=A.createTextureInfoDef(tt,ht);Oe.getOcclusionStrength()!==1&&(ut.strength=Oe.getOcclusionStrength()),Ve.occlusionTexture=ut}if(Oe.getMetallicRoughnessTexture()){const tt=Oe.getMetallicRoughnessTexture(),ht=Oe.getMetallicRoughnessTextureInfo();Ve.pbrMetallicRoughness.metallicRoughnessTexture=A.createTextureInfoDef(tt,ht)}return A.materialIndexMap.set(Oe,ke),Ve}),M.filter(Oe=>Oe.prewriteTypes.includes(index_modern_PropertyType.MESH)).forEach(Oe=>Oe.prewrite(A,index_modern_PropertyType.MESH)),h.meshes=u.listMeshes().map((Oe,ke)=>{const Ve=A.createPropertyDef(Oe);let tt=null;return Ve.primitives=Oe.listPrimitives().map(ht=>{const ut={attributes:{}};ut.mode=ht.getMode();const _t=ht.getMaterial();_t&&(ut.material=A.materialIndexMap.get(_t)),Object.keys(ht.getExtras()).length&&(ut.extras=ht.getExtras());const at=ht.getIndices();at&&(ut.indices=A.accessorIndexMap.get(at));for(const lt of ht.listSemantics())ut.attributes[lt]=A.accessorIndexMap.get(ht.getAttribute(lt));for(const lt of ht.listTargets()){const pt={};for(const xt of lt.listSemantics())pt[xt]=A.accessorIndexMap.get(lt.getAttribute(xt));ut.targets=ut.targets||[],ut.targets.push(pt)}return ht.listTargets().length&&!tt&&(tt=ht.listTargets().map(lt=>lt.getName())),ut}),Oe.getWeights().length&&(Ve.weights=Oe.getWeights()),tt&&(Ve.extras=Ve.extras||{},Ve.extras.targetNames=tt),A.meshIndexMap.set(Oe,ke),Ve}),h.cameras=u.listCameras().map((Oe,ke)=>{const Ve=A.createPropertyDef(Oe);if(Ve.type=Oe.getType(),Ve.type===Camera.Type.PERSPECTIVE){Ve.perspective={znear:Oe.getZNear(),zfar:Oe.getZFar(),yfov:Oe.getYFov()};const tt=Oe.getAspectRatio();tt!==null&&(Ve.perspective.aspectRatio=tt)}else Ve.orthographic={znear:Oe.getZNear(),zfar:Oe.getZFar(),xmag:Oe.getXMag(),ymag:Oe.getYMag()};return A.cameraIndexMap.set(Oe,ke),Ve}),h.nodes=u.listNodes().map((Oe,ke)=>{const Ve=A.createPropertyDef(Oe);return index_modern_MathUtils.eq(Oe.getTranslation(),[0,0,0])||(Ve.translation=Oe.getTranslation()),index_modern_MathUtils.eq(Oe.getRotation(),[0,0,0,1])||(Ve.rotation=Oe.getRotation()),index_modern_MathUtils.eq(Oe.getScale(),[1,1,1])||(Ve.scale=Oe.getScale()),Oe.getWeights().length&&(Ve.weights=Oe.getWeights()),A.nodeIndexMap.set(Oe,ke),Ve}),h.skins=u.listSkins().map((Oe,ke)=>{const Ve=A.createPropertyDef(Oe),tt=Oe.getInverseBindMatrices();tt&&(Ve.inverseBindMatrices=A.accessorIndexMap.get(tt));const ht=Oe.getSkeleton();return ht&&(Ve.skeleton=A.nodeIndexMap.get(ht)),Ve.joints=Oe.listJoints().map(ut=>A.nodeIndexMap.get(ut)),A.skinIndexMap.set(Oe,ke),Ve}),u.listNodes().forEach((Oe,ke)=>{const Ve=h.nodes[ke],tt=Oe.getMesh();tt&&(Ve.mesh=A.meshIndexMap.get(tt));const ht=Oe.getCamera();ht&&(Ve.camera=A.cameraIndexMap.get(ht));const ut=Oe.getSkin();ut&&(Ve.skin=A.skinIndexMap.get(ut)),Oe.listChildren().length>0&&(Ve.children=Oe.listChildren().map(_t=>A.nodeIndexMap.get(_t)))}),h.animations=u.listAnimations().map((Oe,ke)=>{const Ve=A.createPropertyDef(Oe),tt=new Map;return Ve.samplers=Oe.listSamplers().map((ht,ut)=>{const _t=A.createPropertyDef(ht);return _t.input=A.accessorIndexMap.get(ht.getInput()),_t.output=A.accessorIndexMap.get(ht.getOutput()),_t.interpolation=ht.getInterpolation(),tt.set(ht,ut),_t}),Ve.channels=Oe.listChannels().map(ht=>{const ut=A.createPropertyDef(ht);return ut.sampler=tt.get(ht.getSampler()),ut.target={node:A.nodeIndexMap.get(ht.getTargetNode()),path:ht.getTargetPath()},ut}),A.animationIndexMap.set(Oe,ke),Ve}),h.scenes=u.listScenes().map((Oe,ke)=>{const Ve=A.createPropertyDef(Oe);return Ve.nodes=Oe.listChildren().map(tt=>A.nodeIndexMap.get(tt)),A.sceneIndexMap.set(Oe,ke),Ve});const ye=u.getDefaultScene();return ye&&(h.scene=u.listScenes().indexOf(ye)),h.extensionsUsed=M.map(Oe=>Oe.extensionName),h.extensionsRequired=O.map(Oe=>Oe.extensionName),M.forEach(Oe=>Oe.write(A)),index_modern_clean(h),_}}function index_modern_clean(d){const o=[];for(const l in d){const c=d[l];(Array.isArray(c)&&c.length===0||c===null||c===""||c&&typeof c=="object"&&Object.keys(c).length===0)&&o.push(l)}for(const l of o)delete d[l]}var ChunkType;(function(d){d[d.JSON=1313821514]="JSON",d[d.BIN=5130562]="BIN"})(ChunkType||(ChunkType={}));class PlatformIO{constructor(){this._logger=Logger.DEFAULT_INSTANCE,this._extensions=new Set,this._dependencies={},this._vertexLayout=VertexLayout.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(o){return this._logger=o,this}registerExtensions(o){for(const l of o)this._extensions.add(l),l.register();return this}registerDependencies(o){return Object.assign(this._dependencies,o),this}setVertexLayout(o){return this._vertexLayout=o,this}async read(o){return await this.readJSON(await this.readAsJSON(o))}async readAsJSON(o){const l=await this.readURI(o,"view");this.lastReadBytes=l.byteLength;const c=isGLB(l)?this._binaryToJSON(l):{json:JSON.parse(index_modern_BufferUtils.decodeText(l)),resources:{}};return await this._readResourcesExternal(c,this.dirname(o)),this._readResourcesInternal(c),c}async readJSON(o){return o=this._copyJSON(o),this._readResourcesInternal(o),GLTFReader.read(o,{extensions:Array.from(this._extensions),dependencies:this._dependencies,logger:this._logger})}async binaryToJSON(o){const l=this._binaryToJSON(index_modern_BufferUtils.assertView(o));this._readResourcesInternal(l);const c=l.json;if(c.buffers&&c.buffers.some(u=>isExternalBuffer(l,u)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(c.images&&c.images.some(u=>isExternalImage(l,u)))throw new Error("Cannot resolve external images with binaryToJSON().");return l}async readBinary(o){return this.readJSON(await this.binaryToJSON(index_modern_BufferUtils.assertView(o)))}async writeJSON(o,l={}){if(l.format===Format.GLB&&o.getRoot().listBuffers().length>1)throw new Error("GLB must have 0–1 buffers.");return index_modern_GLTFWriter.write(o,{format:l.format||Format.GLTF,basename:l.basename||"",logger:this._logger,vertexLayout:this._vertexLayout,dependencies:index_modern_extends({},this._dependencies),extensions:Array.from(this._extensions)})}async writeBinary(o){const{json:l,resources:c}=await this.writeJSON(o,{format:Format.GLB}),u=new Uint32Array([1179937895,2,12]),h=JSON.stringify(l),_=index_modern_BufferUtils.pad(index_modern_BufferUtils.encodeText(h),32),A=index_modern_BufferUtils.toView(new Uint32Array([_.byteLength,1313821514])),w=index_modern_BufferUtils.concat([A,_]);u[u.length-1]+=w.byteLength;const C=Object.values(c)[0];if(!C||!C.byteLength)return index_modern_BufferUtils.concat([index_modern_BufferUtils.toView(u),w]);const M=index_modern_BufferUtils.pad(C,0),O=index_modern_BufferUtils.toView(new Uint32Array([M.byteLength,5130562])),ne=index_modern_BufferUtils.concat([O,M]);return u[u.length-1]+=ne.byteLength,index_modern_BufferUtils.concat([index_modern_BufferUtils.toView(u),w,ne])}async _readResourcesExternal(o,l){var c=this;const u=[...o.json.images||[],...o.json.buffers||[]].map(async function(h){const _=h.uri;if(!_||_.match(/data:/))return Promise.resolve();o.resources[_]=await c.readURI(c.resolve(l,_),"view"),c.lastReadBytes+=o.resources[_].byteLength});await Promise.all(u)}_readResourcesInternal(o){function l(c){if(c.uri){if(c.uri in o.resources)index_modern_BufferUtils.assertView(o.resources[c.uri]);else if(c.uri.match(/data:/)){const u=`__${index_modern_uuid()}.${index_modern_FileUtils.extension(c.uri)}`;o.resources[u]=index_modern_BufferUtils.createBufferFromDataURI(c.uri),c.uri=u}}}(o.json.images||[]).forEach(c=>{if(c.bufferView===void 0&&c.uri===void 0)throw new Error("Missing resource URI or buffer view.");l(c)}),(o.json.buffers||[]).forEach(l)}_copyJSON(o){const{images:l,buffers:c}=o.json;return o={json:index_modern_extends({},o.json),resources:index_modern_extends({},o.resources)},l&&(o.json.images=l.map(u=>index_modern_extends({},u))),c&&(o.json.buffers=c.map(u=>index_modern_extends({},u))),o}_binaryToJSON(o){if(!isGLB(o))throw new Error("Invalid glTF 2.0 binary.");const l=new Uint32Array(o.buffer,o.byteOffset+12,2);if(l[1]!==ChunkType.JSON)throw new Error("Missing required GLB JSON chunk.");const c=l[0],u=index_modern_BufferUtils.decodeText(index_modern_BufferUtils.toView(o,20,c)),h=JSON.parse(u),_=20+c;if(o.byteLength<=_)return{json:h,resources:{}};const A=new Uint32Array(o.buffer,o.byteOffset+_,2);if(A[1]!==ChunkType.BIN)return{json:h,resources:{}};const w=A[0],C=index_modern_BufferUtils.toView(o,_+8,w);return{json:h,resources:{[GLB_BUFFER]:C}}}}function isExternalBuffer(d,o){return o.uri!==void 0&&!(o.uri in d.resources)}function isExternalImage(d,o){return o.uri!==void 0&&!(o.uri in d.resources)&&o.bufferView===void 0}function isGLB(d){if(d.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const o=new Uint32Array(d.buffer,d.byteOffset,3);return o[0]===1179937895&&o[1]===2}class WebIO extends PlatformIO{constructor(o=HTTPUtils.DEFAULT_INIT){super(),this._fetchConfig=void 0,this._fetchConfig=o}async readURI(o,l){const c=await fetch(o,this._fetchConfig);switch(l){case"view":return new Uint8Array(await c.arrayBuffer());case"text":return c.text()}}resolve(o,l){return HTTPUtils.resolve(o,l)}dirname(o){return HTTPUtils.dirname(o)}}const KHR_SUPERCOMPRESSION_NONE=0,KHR_DF_KHR_DESCRIPTORTYPE_BASICFORMAT=0,KHR_DF_VENDORID_KHRONOS=0,KHR_DF_VERSION=2,KHR_DF_MODEL_UNSPECIFIED=0,ktx_parse_modern_KHR_DF_MODEL_ETC1S=163,ktx_parse_modern_KHR_DF_MODEL_UASTC=166,KHR_DF_FLAG_ALPHA_STRAIGHT=0,KHR_DF_TRANSFER_SRGB=2,KHR_DF_PRIMARIES_BT709=1,KHR_DF_SAMPLE_DATATYPE_SIGNED=64,VK_FORMAT_UNDEFINED=0;class KTX2Container{constructor(){this.vkFormat=VK_FORMAT_UNDEFINED,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=KHR_SUPERCOMPRESSION_NONE,this.levels=[],this.dataFormatDescriptor=[{vendorId:KHR_DF_VENDORID_KHRONOS,descriptorType:KHR_DF_KHR_DESCRIPTORTYPE_BASICFORMAT,descriptorBlockSize:0,versionNumber:KHR_DF_VERSION,colorModel:KHR_DF_MODEL_UNSPECIFIED,colorPrimaries:KHR_DF_PRIMARIES_BT709,transferFunction:KHR_DF_TRANSFER_SRGB,flags:KHR_DF_FLAG_ALPHA_STRAIGHT,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class BufferReader{constructor(o,l,c,u){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(o.buffer,o.byteOffset+l,c),this._littleEndian=u,this._offset=0}_nextUint8(){const o=this._dataView.getUint8(this._offset);return this._offset+=1,o}_nextUint16(){const o=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,o}_nextUint32(){const o=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,o}_nextUint64(){const o=this._dataView.getUint32(this._offset,this._littleEndian)+4294967296*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,o}_nextInt32(){const o=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,o}_skip(o){return this._offset+=o,this}_scan(o,l=0){const c=this._offset;let u=0;for(;this._dataView.getUint8(this._offset)!==l&&u<o;)u++,this._offset++;return u<o&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+c,u)}}const KTX2_ID=[171,75,84,88,32,50,48,187,13,10,26,10];function decodeText(d){return typeof TextDecoder<"u"?new TextDecoder().decode(d):Buffer.from(d).toString("utf8")}function ktx_parse_modern_read(d){const o=new Uint8Array(d.buffer,d.byteOffset,KTX2_ID.length);if(o[0]!==KTX2_ID[0]||o[1]!==KTX2_ID[1]||o[2]!==KTX2_ID[2]||o[3]!==KTX2_ID[3]||o[4]!==KTX2_ID[4]||o[5]!==KTX2_ID[5]||o[6]!==KTX2_ID[6]||o[7]!==KTX2_ID[7]||o[8]!==KTX2_ID[8]||o[9]!==KTX2_ID[9]||o[10]!==KTX2_ID[10]||o[11]!==KTX2_ID[11])throw new Error("Missing KTX 2.0 identifier.");const l=new KTX2Container,c=17*Uint32Array.BYTES_PER_ELEMENT,u=new BufferReader(d,KTX2_ID.length,c,!0);l.vkFormat=u._nextUint32(),l.typeSize=u._nextUint32(),l.pixelWidth=u._nextUint32(),l.pixelHeight=u._nextUint32(),l.pixelDepth=u._nextUint32(),l.layerCount=u._nextUint32(),l.faceCount=u._nextUint32();const h=u._nextUint32();l.supercompressionScheme=u._nextUint32();const _=u._nextUint32(),A=u._nextUint32(),w=u._nextUint32(),C=u._nextUint32(),M=u._nextUint64(),O=u._nextUint64(),ne=3*h*8,ce=new BufferReader(d,KTX2_ID.length+c,ne,!0);for(let si=0;si<h;si++)l.levels.push({levelData:new Uint8Array(d.buffer,d.byteOffset+ce._nextUint64(),ce._nextUint64()),uncompressedByteLength:ce._nextUint64()});const ue=new BufferReader(d,_,A,!0),ye={vendorId:ue._skip(4)._nextUint16(),descriptorType:ue._nextUint16(),versionNumber:ue._nextUint16(),descriptorBlockSize:ue._nextUint16(),colorModel:ue._nextUint8(),colorPrimaries:ue._nextUint8(),transferFunction:ue._nextUint8(),flags:ue._nextUint8(),texelBlockDimension:[ue._nextUint8(),ue._nextUint8(),ue._nextUint8(),ue._nextUint8()],bytesPlane:[ue._nextUint8(),ue._nextUint8(),ue._nextUint8(),ue._nextUint8(),ue._nextUint8(),ue._nextUint8(),ue._nextUint8(),ue._nextUint8()],samples:[]},Oe=(ye.descriptorBlockSize/4-6)/4;for(let si=0;si<Oe;si++){const Jt={bitOffset:ue._nextUint16(),bitLength:ue._nextUint8(),channelType:ue._nextUint8(),samplePosition:[ue._nextUint8(),ue._nextUint8(),ue._nextUint8(),ue._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};Jt.channelType&KHR_DF_SAMPLE_DATATYPE_SIGNED?(Jt.sampleLower=ue._nextInt32(),Jt.sampleUpper=ue._nextInt32()):(Jt.sampleLower=ue._nextUint32(),Jt.sampleUpper=ue._nextUint32()),ye.samples[si]=Jt}l.dataFormatDescriptor.length=0,l.dataFormatDescriptor.push(ye);const ke=new BufferReader(d,w,C,!0);for(;ke._offset<C;){const si=ke._nextUint32(),Jt=ke._scan(si),Wt=decodeText(Jt),Zt=ke._scan(si-Jt.byteLength);l.keyValue[Wt]=Wt.match(/^ktx/i)?decodeText(Zt):Zt,ke._offset%4&&ke._skip(4-ke._offset%4)}if(O<=0)return l;const Ve=new BufferReader(d,M,O,!0),tt=Ve._nextUint16(),ht=Ve._nextUint16(),ut=Ve._nextUint32(),_t=Ve._nextUint32(),at=Ve._nextUint32(),lt=Ve._nextUint32(),pt=[];for(let si=0;si<h;si++)pt.push({imageFlags:Ve._nextUint32(),rgbSliceByteOffset:Ve._nextUint32(),rgbSliceByteLength:Ve._nextUint32(),alphaSliceByteOffset:Ve._nextUint32(),alphaSliceByteLength:Ve._nextUint32()});const xt=M+Ve._offset,Tt=xt+ut,Pt=Tt+_t,Lt=Pt+at,Bt=new Uint8Array(d.buffer,d.byteOffset+xt,ut),Ut=new Uint8Array(d.buffer,d.byteOffset+Tt,_t),kt=new Uint8Array(d.buffer,d.byteOffset+Pt,at),Vt=new Uint8Array(d.buffer,d.byteOffset+Lt,lt);return l.globalData={endpointCount:tt,selectorCount:ht,imageDescs:pt,endpointsData:Bt,selectorsData:Ut,tablesData:kt,extendedData:Vt},l}const EXT_MESH_GPU_INSTANCING="EXT_mesh_gpu_instancing",EXT_MESHOPT_COMPRESSION="EXT_meshopt_compression",EXT_TEXTURE_WEBP="EXT_texture_webp",EXT_TEXTURE_AVIF="EXT_texture_avif",KHR_DRACO_MESH_COMPRESSION="KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL="KHR_lights_punctual",KHR_MATERIALS_ANISOTROPY="KHR_materials_anisotropy",KHR_MATERIALS_CLEARCOAT="KHR_materials_clearcoat",KHR_MATERIALS_DIFFUSE_TRANSMISSION="KHR_materials_diffuse_transmission",KHR_MATERIALS_DISPERSION="KHR_materials_dispersion",KHR_MATERIALS_EMISSIVE_STRENGTH="KHR_materials_emissive_strength",KHR_MATERIALS_IOR="KHR_materials_ior",KHR_MATERIALS_IRIDESCENCE="KHR_materials_iridescence",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS="KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN="KHR_materials_sheen",KHR_MATERIALS_SPECULAR="KHR_materials_specular",KHR_MATERIALS_TRANSMISSION="KHR_materials_transmission",KHR_MATERIALS_UNLIT="KHR_materials_unlit",KHR_MATERIALS_VOLUME="KHR_materials_volume",KHR_MATERIALS_VARIANTS="KHR_materials_variants",index_modern_KHR_MESH_QUANTIZATION="KHR_mesh_quantization",index_modern_KHR_TEXTURE_BASISU="KHR_texture_basisu",KHR_TEXTURE_TRANSFORM="KHR_texture_transform",KHR_XMP_JSON_LD="KHR_xmp_json_ld",INSTANCE_ATTRIBUTE="INSTANCE_ATTRIBUTE";class InstancedMesh extends index_modern_ExtensionProperty{init(){this.extensionName=EXT_MESH_GPU_INSTANCING,this.propertyType="InstancedMesh",this.parentTypes=[index_modern_PropertyType.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new RefMap})}getAttribute(o){return this.getRefMap("attributes",o)}setAttribute(o,l){return this.setRefMap("attributes",o,l,{usage:INSTANCE_ATTRIBUTE})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}InstancedMesh.EXTENSION_NAME=EXT_MESH_GPU_INSTANCING;const NAME$o=EXT_MESH_GPU_INSTANCING;class index_modern_EXTMeshGPUInstancing extends Extension{constructor(...o){super(...o),this.extensionName=NAME$o,this.provideTypes=[index_modern_PropertyType.NODE],this.prewriteTypes=[index_modern_PropertyType.ACCESSOR]}createInstancedMesh(){return new InstancedMesh(this.document.getGraph())}read(o){return(o.jsonDoc.json.nodes||[]).forEach((l,c)=>{if(!l.extensions||!l.extensions[NAME$o])return;const u=l.extensions[NAME$o],h=this.createInstancedMesh();for(const _ in u.attributes)h.setAttribute(_,o.accessors[u.attributes[_]]);o.nodes[c].setExtension(NAME$o,h)}),this}prewrite(o){o.accessorUsageGroupedByParent.add(INSTANCE_ATTRIBUTE);for(const l of this.properties)for(const c of l.listAttributes())o.addAccessorToUsageGroup(c,INSTANCE_ATTRIBUTE);return this}write(o){const l=o.jsonDoc;return this.document.getRoot().listNodes().forEach(c=>{const u=c.getExtension(NAME$o);if(u){const h=o.nodeIndexMap.get(c),_=l.json.nodes[h],A={attributes:{}};u.listSemantics().forEach(w=>{const C=u.getAttribute(w);A.attributes[w]=o.accessorIndexMap.get(C)}),_.extensions=_.extensions||{},_.extensions[NAME$o]=A}}),this}}function dist_index_modern_extends(){return dist_index_modern_extends=Object.assign?Object.assign.bind():function(d){for(var o=1;o<arguments.length;o++){var l=arguments[o];for(var c in l)({}).hasOwnProperty.call(l,c)&&(d[c]=l[c])}return d},dist_index_modern_extends.apply(null,arguments)}var EncoderMethod$1,MeshoptMode,MeshoptFilter;index_modern_EXTMeshGPUInstancing.EXTENSION_NAME=NAME$o,function(d){d.QUANTIZE="quantize",d.FILTER="filter"}(EncoderMethod$1||(EncoderMethod$1={})),function(d){d.ATTRIBUTES="ATTRIBUTES",d.TRIANGLES="TRIANGLES",d.INDICES="INDICES"}(MeshoptMode||(MeshoptMode={})),function(d){d.NONE="NONE",d.OCTAHEDRAL="OCTAHEDRAL",d.QUATERNION="QUATERNION",d.EXPONENTIAL="EXPONENTIAL"}(MeshoptFilter||(MeshoptFilter={}));const{BYTE,SHORT,FLOAT}=index_modern_Accessor.ComponentType,{encodeNormalizedInt,decodeNormalizedInt}=index_modern_MathUtils;function prepareAccessor(d,o,l,c){const{filter:u,bits:h}=c,_={array:d.getArray(),byteStride:d.getElementSize()*d.getComponentSize(),componentType:d.getComponentType(),normalized:d.getNormalized()};if(l!==MeshoptMode.ATTRIBUTES)return _;if(u!==MeshoptFilter.NONE){let A=d.getNormalized()?decodeNormalizedIntArray(d):new Float32Array(_.array);switch(u){case MeshoptFilter.EXPONENTIAL:_.byteStride=4*d.getElementSize(),_.componentType=FLOAT,_.normalized=!1,_.array=o.encodeFilterExp(A,d.getCount(),_.byteStride,h);break;case MeshoptFilter.OCTAHEDRAL:_.byteStride=h>8?8:4,_.componentType=h>8?SHORT:BYTE,_.normalized=!0,A=d.getElementSize()===3?padNormals(A):A,_.array=o.encodeFilterOct(A,d.getCount(),_.byteStride,h);break;case MeshoptFilter.QUATERNION:_.byteStride=8,_.componentType=SHORT,_.normalized=!0,_.array=o.encodeFilterQuat(A,d.getCount(),_.byteStride,h);break;default:throw new Error("Invalid filter.")}_.min=d.getMin([]),_.max=d.getMax([]),d.getNormalized()&&(_.min=_.min.map(w=>decodeNormalizedInt(w,d.getComponentType())),_.max=_.max.map(w=>decodeNormalizedInt(w,d.getComponentType()))),_.normalized&&(_.min=_.min.map(w=>encodeNormalizedInt(w,_.componentType)),_.max=_.max.map(w=>encodeNormalizedInt(w,_.componentType)))}else _.byteStride%4&&(_.array=padArrayElements(_.array,d.getElementSize()),_.byteStride=_.array.byteLength/d.getCount());return _}function decodeNormalizedIntArray(d){const o=d.getComponentType(),l=d.getArray(),c=new Float32Array(l.length);for(let u=0;u<l.length;u++)c[u]=decodeNormalizedInt(l[u],o);return c}function padArrayElements(d,o){const l=index_modern_BufferUtils.padNumber(d.BYTES_PER_ELEMENT*o)/d.BYTES_PER_ELEMENT,c=d.length/o,u=new d.constructor(c*l);for(let h=0;h*o<d.length;h++)for(let _=0;_<o;_++)u[h*l+_]=d[h*o+_];return u}function padNormals(d){const o=new Float32Array(4*d.length/3);for(let l=0,c=d.length/3;l<c;l++)o[4*l]=d[3*l],o[4*l+1]=d[3*l+1],o[4*l+2]=d[3*l+2];return o}function getMeshoptMode(d,o){return o===WriterContext.BufferViewUsage.ELEMENT_ARRAY_BUFFER?d.listParents().some(l=>l instanceof index_modern_Primitive&&l.getMode()===index_modern_Primitive.Mode.TRIANGLES)?MeshoptMode.TRIANGLES:MeshoptMode.INDICES:MeshoptMode.ATTRIBUTES}function getMeshoptFilter(d,o){const l=o.getGraph().listParentEdges(d).filter(c=>!(c.getParent()instanceof index_modern_Root));for(const c of l){const u=c.getName(),h=c.getAttributes().key||"",_=c.getParent().propertyType===index_modern_PropertyType.PRIMITIVE_TARGET;if(u==="indices")return{filter:MeshoptFilter.NONE};if(u==="attributes"){if(h==="POSITION")return{filter:MeshoptFilter.NONE};if(h==="TEXCOORD_0")return{filter:MeshoptFilter.NONE};if(h.startsWith("JOINTS_"))return{filter:MeshoptFilter.NONE};if(h.startsWith("WEIGHTS_"))return{filter:MeshoptFilter.NONE};if(h==="NORMAL"||h==="TANGENT")return _?{filter:MeshoptFilter.NONE}:{filter:MeshoptFilter.OCTAHEDRAL,bits:8}}if(u==="output"){const A=getTargetPath(d);return A==="rotation"?{filter:MeshoptFilter.QUATERNION,bits:16}:A==="translation"||A==="scale"?{filter:MeshoptFilter.EXPONENTIAL,bits:12}:{filter:MeshoptFilter.NONE}}if(u==="input")return{filter:MeshoptFilter.NONE};if(u==="inverseBindMatrices")return{filter:MeshoptFilter.NONE}}return{filter:MeshoptFilter.NONE}}function getTargetPath(d){for(const o of d.listParents())if(o instanceof index_modern_AnimationSampler){for(const l of o.listParents())if(l instanceof index_modern_AnimationChannel)return l.getTargetPath()}return null}function isFallbackBuffer(d){return!(!d.extensions||!d.extensions[EXT_MESHOPT_COMPRESSION])&&!!d.extensions[EXT_MESHOPT_COMPRESSION].fallback}const NAME$n=EXT_MESHOPT_COMPRESSION,DEFAULT_ENCODER_OPTIONS$1={method:EncoderMethod$1.QUANTIZE};class index_modern_EXTMeshoptCompression extends Extension{constructor(...o){super(...o),this.extensionName=NAME$n,this.prereadTypes=[index_modern_PropertyType.BUFFER,index_modern_PropertyType.PRIMITIVE],this.prewriteTypes=[index_modern_PropertyType.BUFFER,index_modern_PropertyType.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=DEFAULT_ENCODER_OPTIONS$1,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(o,l){return o==="meshopt.decoder"&&(this._decoder=l),o==="meshopt.encoder"&&(this._encoder=l),this}setEncoderOptions(o){return this._encoderOptions=dist_index_modern_extends({},DEFAULT_ENCODER_OPTIONS$1,o),this}preread(o,l){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${NAME$n}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${NAME$n}]: Missing WASM support.`)}return l===index_modern_PropertyType.BUFFER?this._prereadBuffers(o):l===index_modern_PropertyType.PRIMITIVE&&this._prereadPrimitives(o),this}_prereadBuffers(o){const l=o.jsonDoc;(l.json.bufferViews||[]).forEach((c,u)=>{if(!c.extensions||!c.extensions[NAME$n])return;const h=c.extensions[NAME$n],_=h.byteOffset||0,A=h.byteLength||0,w=h.count,C=h.byteStride,M=new Uint8Array(w*C),O=l.json.buffers[h.buffer],ne=O.uri?l.resources[O.uri]:l.resources[GLB_BUFFER],ce=index_modern_BufferUtils.toView(ne,_,A);this._decoder.decodeGltfBuffer(M,w,C,ce,h.mode,h.filter),o.bufferViews[u]=M})}_prereadPrimitives(o){const l=o.jsonDoc;(l.json.bufferViews||[]).forEach(c=>{if(!c.extensions||!c.extensions[NAME$n])return;const u=c.extensions[NAME$n],h=o.buffers[u.buffer],_=o.buffers[c.buffer];isFallbackBuffer(l.json.buffers[c.buffer])&&this._decoderFallbackBufferMap.set(_,h)})}read(o){if(!this.isRequired())return this;for(const[l,c]of this._decoderFallbackBufferMap){for(const u of l.listParents())u instanceof index_modern_Accessor&&u.swap(l,c);l.dispose()}return this}prewrite(o,l){return l===index_modern_PropertyType.ACCESSOR?this._prewriteAccessors(o):l===index_modern_PropertyType.BUFFER&&this._prewriteBuffers(o),this}_prewriteAccessors(o){const l=o.jsonDoc.json,c=this._encoder,u=this._encoderOptions,h=this.document.getGraph(),_=this.document.createBuffer(),A=this.document.getRoot().listBuffers().indexOf(_);let w=1;const C=new Map,M=O=>{for(const ne of h.listParents(O)){if(ne.propertyType===index_modern_PropertyType.ROOT)continue;let ce=C.get(O);return ce===void 0&&C.set(O,ce=w++),ce}return-1};this._encoderFallbackBuffer=_,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const O of this.document.getRoot().listAccessors()){if(getTargetPath(O)==="weights"||O.getSparse())continue;const ne=o.getAccessorUsage(O),ce=o.accessorUsageGroupedByParent.has(ne)?M(O):null,ue=getMeshoptMode(O,ne),ye=u.method===EncoderMethod$1.FILTER?getMeshoptFilter(O,this.document):{filter:MeshoptFilter.NONE},Oe=prepareAccessor(O,c,ue,ye),{array:ke,byteStride:Ve}=Oe,tt=O.getBuffer();if(!tt)throw new Error(`${NAME$n}: Missing buffer for accessor.`);const ht=this.document.getRoot().listBuffers().indexOf(tt),ut=[ne,ce,ue,ye.filter,Ve,ht].join(":");let _t=this._encoderBufferViews[ut],at=this._encoderBufferViewData[ut],lt=this._encoderBufferViewAccessors[ut];_t&&at||(lt=this._encoderBufferViewAccessors[ut]=[],at=this._encoderBufferViewData[ut]=[],_t=this._encoderBufferViews[ut]={buffer:A,target:WriterContext.USAGE_TO_TARGET[ne],byteOffset:0,byteLength:0,byteStride:ne===WriterContext.BufferViewUsage.ARRAY_BUFFER?Ve:void 0,extensions:{[NAME$n]:{buffer:ht,byteOffset:0,byteLength:0,mode:ue,filter:ye.filter!==MeshoptFilter.NONE?ye.filter:void 0,byteStride:Ve,count:0}}});const pt=o.createAccessorDef(O);pt.componentType=Oe.componentType,pt.normalized=Oe.normalized,pt.byteOffset=_t.byteLength,pt.min&&Oe.min&&(pt.min=Oe.min),pt.max&&Oe.max&&(pt.max=Oe.max),o.accessorIndexMap.set(O,l.accessors.length),l.accessors.push(pt),lt.push(pt),at.push(new Uint8Array(ke.buffer,ke.byteOffset,ke.byteLength)),_t.byteLength+=ke.byteLength,_t.extensions.EXT_meshopt_compression.count+=O.getCount()}}_prewriteBuffers(o){const l=this._encoder;for(const c in this._encoderBufferViews){const u=this._encoderBufferViews[c],h=this._encoderBufferViewData[c],_=this.document.getRoot().listBuffers()[u.extensions[NAME$n].buffer],A=o.otherBufferViews.get(_)||[],{count:w,byteStride:C,mode:M}=u.extensions[NAME$n],O=index_modern_BufferUtils.concat(h),ne=l.encodeGltfBuffer(O,w,C,M),ce=index_modern_BufferUtils.pad(ne);u.extensions[NAME$n].byteLength=ne.byteLength,h.length=0,h.push(ce),A.push(ce),o.otherBufferViews.set(_,A)}}write(o){let l=0;for(const _ in this._encoderBufferViews){const A=this._encoderBufferViews[_],w=this._encoderBufferViewData[_][0],C=o.otherBufferViewsIndexMap.get(w),M=this._encoderBufferViewAccessors[_];for(const ce of M)ce.bufferView=C;const O=o.jsonDoc.json.bufferViews[C],ne=O.byteOffset||0;Object.assign(O,A),O.byteOffset=l,O.extensions[NAME$n].byteOffset=ne,l+=index_modern_BufferUtils.padNumber(A.byteLength)}const c=this._encoderFallbackBuffer,u=o.bufferIndexMap.get(c),h=o.jsonDoc.json.buffers[u];return h.byteLength=l,h.extensions={[NAME$n]:{fallback:!0}},c.dispose(),this}}index_modern_EXTMeshoptCompression.EXTENSION_NAME=NAME$n,index_modern_EXTMeshoptCompression.EncoderMethod=EncoderMethod$1;const NAME$m=EXT_TEXTURE_AVIF;class AVIFImageUtils{match(o){return o.length>=12&&index_modern_BufferUtils.decodeText(o.slice(4,12))==="ftypavif"}getSize(o){if(!this.match(o))return null;const l=new DataView(o.buffer,o.byteOffset,o.byteLength);let c=unbox(l,0);if(!c)return null;let u=c.end;for(;c=unbox(l,u);)if(c.type==="meta")u=c.start+4;else if(c.type==="iprp"||c.type==="ipco")u=c.start;else{if(c.type==="ispe")return[l.getUint32(c.start+4),l.getUint32(c.start+8)];if(c.type==="mdat")break;u=c.end}return null}getChannels(o){return 4}}class index_modern_EXTTextureAVIF extends Extension{constructor(...o){super(...o),this.extensionName=NAME$m,this.prereadTypes=[index_modern_PropertyType.TEXTURE]}static register(){index_modern_ImageUtils.registerFormat("image/avif",new AVIFImageUtils)}preread(o){return(o.jsonDoc.json.textures||[]).forEach(l=>{l.extensions&&l.extensions[NAME$m]&&(l.source=l.extensions[NAME$m].source)}),this}read(o){return this}write(o){const l=o.jsonDoc;return this.document.getRoot().listTextures().forEach(c=>{if(c.getMimeType()==="image/avif"){const u=o.imageIndexMap.get(c);(l.json.textures||[]).forEach(h=>{h.source===u&&(h.extensions=h.extensions||{},h.extensions[NAME$m]={source:h.source},delete h.source)})}}),this}}function unbox(d,o){if(d.byteLength<4+o)return null;const l=d.getUint32(o);return d.byteLength<l+o||l<8?null:{type:index_modern_BufferUtils.decodeText(new Uint8Array(d.buffer,d.byteOffset+o+4,4)),start:o+8,end:o+l}}index_modern_EXTTextureAVIF.EXTENSION_NAME=NAME$m;const NAME$l=EXT_TEXTURE_WEBP;class WEBPImageUtils{match(o){return o.length>=12&&o[8]===87&&o[9]===69&&o[10]===66&&o[11]===80}getSize(o){const l=index_modern_BufferUtils.decodeText(o.slice(0,4)),c=index_modern_BufferUtils.decodeText(o.slice(8,12));if(l!=="RIFF"||c!=="WEBP")return null;const u=new DataView(o.buffer,o.byteOffset);let h=12;for(;h<u.byteLength;){const _=index_modern_BufferUtils.decodeText(new Uint8Array([u.getUint8(h),u.getUint8(h+1),u.getUint8(h+2),u.getUint8(h+3)])),A=u.getUint32(h+4,!0);if(_==="VP8 ")return[16383&u.getInt16(h+14,!0),16383&u.getInt16(h+16,!0)];if(_==="VP8L"){const w=u.getUint8(h+9),C=u.getUint8(h+10),M=u.getUint8(h+11);return[1+((63&C)<<8|w),1+((15&u.getUint8(h+12))<<10|M<<2|(192&C)>>6)]}h+=8+A+A%2}return null}getChannels(o){return 4}}class index_modern_EXTTextureWebP extends Extension{constructor(...o){super(...o),this.extensionName=NAME$l,this.prereadTypes=[index_modern_PropertyType.TEXTURE]}static register(){index_modern_ImageUtils.registerFormat("image/webp",new WEBPImageUtils)}preread(o){return(o.jsonDoc.json.textures||[]).forEach(l=>{l.extensions&&l.extensions[NAME$l]&&(l.source=l.extensions[NAME$l].source)}),this}read(o){return this}write(o){const l=o.jsonDoc;return this.document.getRoot().listTextures().forEach(c=>{if(c.getMimeType()==="image/webp"){const u=o.imageIndexMap.get(c);(l.json.textures||[]).forEach(h=>{h.source===u&&(h.extensions=h.extensions||{},h.extensions[NAME$l]={source:h.source},delete h.source)})}}),this}}index_modern_EXTTextureWebP.EXTENSION_NAME=NAME$l;const NAME$k=KHR_DRACO_MESH_COMPRESSION;let decoderModule,COMPONENT_ARRAY,DATA_TYPE,encoderModule;function decodeGeometry(d,o){const l=new decoderModule.DecoderBuffer;try{if(l.Init(o,o.length),d.GetEncodedGeometryType(l)!==decoderModule.TRIANGULAR_MESH)throw new Error(`[${NAME$k}] Unknown geometry type.`);const c=new decoderModule.Mesh;if(!d.DecodeBufferToMesh(l,c).ok()||c.ptr===0)throw new Error(`[${NAME$k}] Decoding failure.`);return c}finally{decoderModule.destroy(l)}}function decodeIndex(d,o){const l=3*o.num_faces();let c,u;if(o.num_points()<=65534){const h=l*Uint16Array.BYTES_PER_ELEMENT;c=decoderModule._malloc(h),d.GetTrianglesUInt16Array(o,h,c),u=new Uint16Array(decoderModule.HEAPU16.buffer,c,l).slice()}else{const h=l*Uint32Array.BYTES_PER_ELEMENT;c=decoderModule._malloc(h),d.GetTrianglesUInt32Array(o,h,c),u=new Uint32Array(decoderModule.HEAPU32.buffer,c,l).slice()}return decoderModule._free(c),u}function decodeAttribute(d,o,l,c){const u=DATA_TYPE[c.componentType],h=COMPONENT_ARRAY[c.componentType],_=l.num_components(),A=o.num_points()*_,w=A*h.BYTES_PER_ELEMENT,C=decoderModule._malloc(w);d.GetAttributeDataArrayForAllPoints(o,l,u,w,C);const M=new h(decoderModule.HEAPF32.buffer,C,A).slice();return decoderModule._free(C),M}function initDecoderModule(d){decoderModule=d,COMPONENT_ARRAY={[index_modern_Accessor.ComponentType.FLOAT]:Float32Array,[index_modern_Accessor.ComponentType.UNSIGNED_INT]:Uint32Array,[index_modern_Accessor.ComponentType.UNSIGNED_SHORT]:Uint16Array,[index_modern_Accessor.ComponentType.UNSIGNED_BYTE]:Uint8Array,[index_modern_Accessor.ComponentType.SHORT]:Int16Array,[index_modern_Accessor.ComponentType.BYTE]:Int8Array},DATA_TYPE={[index_modern_Accessor.ComponentType.FLOAT]:decoderModule.DT_FLOAT32,[index_modern_Accessor.ComponentType.UNSIGNED_INT]:decoderModule.DT_UINT32,[index_modern_Accessor.ComponentType.UNSIGNED_SHORT]:decoderModule.DT_UINT16,[index_modern_Accessor.ComponentType.UNSIGNED_BYTE]:decoderModule.DT_UINT8,[index_modern_Accessor.ComponentType.SHORT]:decoderModule.DT_INT16,[index_modern_Accessor.ComponentType.BYTE]:decoderModule.DT_INT8}}var index_modern_EncoderMethod,AttributeEnum;(function(d){d[d.EDGEBREAKER=1]="EDGEBREAKER",d[d.SEQUENTIAL=0]="SEQUENTIAL"})(index_modern_EncoderMethod||(index_modern_EncoderMethod={})),function(d){d.POSITION="POSITION",d.NORMAL="NORMAL",d.COLOR="COLOR",d.TEX_COORD="TEX_COORD",d.GENERIC="GENERIC"}(AttributeEnum||(AttributeEnum={}));const DEFAULT_QUANTIZATION_BITS={[AttributeEnum.POSITION]:14,[AttributeEnum.NORMAL]:10,[AttributeEnum.COLOR]:8,[AttributeEnum.TEX_COORD]:12,[AttributeEnum.GENERIC]:12},DEFAULT_ENCODER_OPTIONS={decodeSpeed:5,encodeSpeed:5,method:index_modern_EncoderMethod.EDGEBREAKER,quantizationBits:DEFAULT_QUANTIZATION_BITS,quantizationVolume:"mesh"};function initEncoderModule(d){encoderModule=d}function encodeGeometry(d,o=DEFAULT_ENCODER_OPTIONS){const l=dist_index_modern_extends({},DEFAULT_ENCODER_OPTIONS,o);l.quantizationBits=dist_index_modern_extends({},DEFAULT_QUANTIZATION_BITS,o.quantizationBits);const c=new encoderModule.MeshBuilder,u=new encoderModule.Mesh,h=new encoderModule.ExpertEncoder(u),_={},A=new encoderModule.DracoInt8Array,w=d.listTargets().length>0;let C=!1;for(const ye of d.listSemantics()){const Oe=d.getAttribute(ye);if(Oe.getSparse()){C=!0;continue}const ke=getAttributeEnum(ye),Ve=addAttribute(c,Oe.getComponentType(),u,encoderModule[ke],Oe.getCount(),Oe.getElementSize(),Oe.getArray());if(Ve===-1)throw new Error(`Error compressing "${ye}" attribute.`);if(_[ye]=Ve,l.quantizationVolume==="mesh"||ye!=="POSITION")h.SetAttributeQuantization(Ve,l.quantizationBits[ke]);else{if(typeof l.quantizationVolume!="object")throw new Error("Invalid quantization volume state.");{const{quantizationVolume:tt}=l,ht=Math.max(tt.max[0]-tt.min[0],tt.max[1]-tt.min[1],tt.max[2]-tt.min[2]);h.SetAttributeExplicitQuantization(Ve,l.quantizationBits[ke],Oe.getElementSize(),tt.min,ht)}}}const M=d.getIndices();if(!M)throw new EncodingError("Primitive must have indices.");c.AddFacesToMesh(u,M.getCount()/3,M.getArray()),h.SetSpeedOptions(l.encodeSpeed,l.decodeSpeed),h.SetTrackEncodedProperties(!0),l.method===index_modern_EncoderMethod.SEQUENTIAL||w||C?h.SetEncodingMethod(encoderModule.MESH_SEQUENTIAL_ENCODING):h.SetEncodingMethod(encoderModule.MESH_EDGEBREAKER_ENCODING);const O=h.EncodeToDracoBuffer(!(w||C),A);if(O<=0)throw new EncodingError("Error applying Draco compression.");const ne=new Uint8Array(O);for(let ye=0;ye<O;++ye)ne[ye]=A.GetValue(ye);const ce=h.GetNumberOfEncodedPoints(),ue=3*h.GetNumberOfEncodedFaces();return encoderModule.destroy(A),encoderModule.destroy(u),encoderModule.destroy(c),encoderModule.destroy(h),{numVertices:ce,numIndices:ue,data:ne,attributeIDs:_}}function getAttributeEnum(d){return d==="POSITION"?AttributeEnum.POSITION:d==="NORMAL"?AttributeEnum.NORMAL:d.startsWith("COLOR_")?AttributeEnum.COLOR:d.startsWith("TEXCOORD_")?AttributeEnum.TEX_COORD:AttributeEnum.GENERIC}function addAttribute(d,o,l,c,u,h,_){switch(o){case index_modern_Accessor.ComponentType.UNSIGNED_BYTE:return d.AddUInt8Attribute(l,c,u,h,_);case index_modern_Accessor.ComponentType.BYTE:return d.AddInt8Attribute(l,c,u,h,_);case index_modern_Accessor.ComponentType.UNSIGNED_SHORT:return d.AddUInt16Attribute(l,c,u,h,_);case index_modern_Accessor.ComponentType.SHORT:return d.AddInt16Attribute(l,c,u,h,_);case index_modern_Accessor.ComponentType.UNSIGNED_INT:return d.AddUInt32Attribute(l,c,u,h,_);case index_modern_Accessor.ComponentType.FLOAT:return d.AddFloatAttribute(l,c,u,h,_);default:throw new Error(`Unexpected component type, "${o}".`)}}class EncodingError extends Error{}const NAME$j=KHR_DRACO_MESH_COMPRESSION;class index_modern_KHRDracoMeshCompression extends Extension{constructor(...o){super(...o),this.extensionName=NAME$j,this.prereadTypes=[index_modern_PropertyType.PRIMITIVE],this.prewriteTypes=[index_modern_PropertyType.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(o,l){return o==="draco3d.decoder"&&(this._decoderModule=l,initDecoderModule(this._decoderModule)),o==="draco3d.encoder"&&(this._encoderModule=l,initEncoderModule(this._encoderModule)),this}setEncoderOptions(o){return this._encoderOptions=o,this}preread(o){if(!this._decoderModule)throw new Error(`[${NAME$j}] Please install extension dependency, "draco3d.decoder".`);const l=this.document.getLogger(),c=o.jsonDoc,u=new Map;try{const h=c.json.meshes||[];for(const _ of h)for(const A of _.primitives){if(!A.extensions||!A.extensions[NAME$j])continue;const w=A.extensions[NAME$j];let[C,M]=u.get(w.bufferView)||[];if(!M||!C){const O=c.json.bufferViews[w.bufferView],ne=c.json.buffers[O.buffer],ce=ne.uri?c.resources[ne.uri]:c.resources[GLB_BUFFER],ue=O.byteOffset||0,ye=O.byteLength,Oe=index_modern_BufferUtils.toView(ce,ue,ye);C=new this._decoderModule.Decoder,M=decodeGeometry(C,Oe),u.set(w.bufferView,[C,M]),l.debug(`[${NAME$j}] Decompressed ${Oe.byteLength} bytes.`)}for(const O in A.attributes){const ne=o.jsonDoc.json.accessors[A.attributes[O]],ce=C.GetAttributeByUniqueId(M,w.attributes[O]),ue=decodeAttribute(C,M,ce,ne);o.accessors[A.attributes[O]].setArray(ue)}A.indices!==void 0&&o.accessors[A.indices].setArray(decodeIndex(C,M))}}finally{for(const[h,_]of Array.from(u.values()))this._decoderModule.destroy(h),this._decoderModule.destroy(_)}return this}read(o){return this}prewrite(o,l){if(!this._encoderModule)throw new Error(`[${NAME$j}] Please install extension dependency, "draco3d.encoder".`);const c=this.document.getLogger();c.debug(`[${NAME$j}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const u=listDracoPrimitives(this.document),h=new Map;let _="mesh";this._encoderOptions.quantizationVolume==="scene"&&(this.document.getRoot().listScenes().length!==1?c.warn(`[${NAME$j}]: quantizationVolume=scene requires exactly 1 scene.`):_=getBounds(this.document.getRoot().listScenes().pop()));for(const A of Array.from(u.keys())){const w=u.get(A);if(!w)throw new Error("Unexpected primitive.");if(h.has(w)){h.set(w,h.get(w));continue}const C=A.getIndices(),M=o.jsonDoc.json.accessors;let O;try{O=encodeGeometry(A,dist_index_modern_extends({},this._encoderOptions,{quantizationVolume:_}))}catch(ue){if(ue instanceof EncodingError){c.warn(`[${NAME$j}]: ${ue.message} Skipping primitive compression.`);continue}throw ue}h.set(w,O);const ne=o.createAccessorDef(C);ne.count=O.numIndices,o.accessorIndexMap.set(C,M.length),M.push(ne),O.numVertices>65534&&index_modern_Accessor.getComponentSize(ne.componentType)<=2?ne.componentType=index_modern_Accessor.ComponentType.UNSIGNED_INT:O.numVertices>254&&index_modern_Accessor.getComponentSize(ne.componentType)<=1&&(ne.componentType=index_modern_Accessor.ComponentType.UNSIGNED_SHORT);for(const ue of A.listSemantics()){const ye=A.getAttribute(ue);if(O.attributeIDs[ue]===void 0)continue;const Oe=o.createAccessorDef(ye);Oe.count=O.numVertices,o.accessorIndexMap.set(ye,M.length),M.push(Oe)}const ce=A.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];o.otherBufferViews.has(ce)||o.otherBufferViews.set(ce,[]),o.otherBufferViews.get(ce).push(O.data)}return c.debug(`[${NAME$j}] Compressed ${u.size} primitives.`),o.extensionData[NAME$j]={primitiveHashMap:u,primitiveEncodingMap:h},this}write(o){const l=o.extensionData[NAME$j];for(const c of this.document.getRoot().listMeshes()){const u=o.jsonDoc.json.meshes[o.meshIndexMap.get(c)];for(let h=0;h<c.listPrimitives().length;h++){const _=c.listPrimitives()[h],A=u.primitives[h],w=l.primitiveHashMap.get(_);if(!w)continue;const C=l.primitiveEncodingMap.get(w);C&&(A.extensions=A.extensions||{},A.extensions[NAME$j]={bufferView:o.otherBufferViewsIndexMap.get(C.data),attributes:C.attributeIDs})}}if(!l.primitiveHashMap.size){const c=o.jsonDoc.json;c.extensionsUsed=(c.extensionsUsed||[]).filter(u=>u!==NAME$j),c.extensionsRequired=(c.extensionsRequired||[]).filter(u=>u!==NAME$j)}return this}}function listDracoPrimitives(d){const o=d.getLogger(),l=new Set,c=new Set;let u=0,h=0;for(const O of d.getRoot().listMeshes())for(const ne of O.listPrimitives())ne.getIndices()?ne.getMode()!==index_modern_Primitive.Mode.TRIANGLES?(c.add(ne),h++):l.add(ne):(c.add(ne),u++);u>0&&o.warn(`[${NAME$j}] Skipping Draco compression of ${u} non-indexed primitives.`),h>0&&o.warn(`[${NAME$j}] Skipping Draco compression of ${h} non-TRIANGLES primitives.`);const _=d.getRoot().listAccessors(),A=new Map;for(let O=0;O<_.length;O++)A.set(_[O],O);const w=new Map,C=new Set,M=new Map;for(const O of Array.from(l)){let ne=createHashKey(O,A);if(C.has(ne))M.set(O,ne);else{if(w.has(O.getIndices())){const ce=O.getIndices(),ue=ce.clone();A.set(ue,d.getRoot().listAccessors().length-1),O.swap(ce,ue)}for(const ce of O.listAttributes())if(w.has(ce)){const ue=ce.clone();A.set(ue,d.getRoot().listAccessors().length-1),O.swap(ce,ue)}ne=createHashKey(O,A),C.add(ne),M.set(O,ne),w.set(O.getIndices(),ne);for(const ce of O.listAttributes())w.set(ce,ne)}}for(const O of Array.from(w.keys())){const ne=new Set(O.listParents().map(ce=>ce.propertyType));if(ne.size!==2||!ne.has(index_modern_PropertyType.PRIMITIVE)||!ne.has(index_modern_PropertyType.ROOT))throw new Error(`[${NAME$j}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const O of Array.from(l)){const ne=M.get(O),ce=O.getIndices();if(w.get(ce)!==ne||O.listAttributes().some(ue=>w.get(ue)!==ne))throw new Error(`[${NAME$j}] Draco primitives must share all, or no, accessors.`)}for(const O of Array.from(c)){const ne=O.getIndices();if(w.has(ne)||O.listAttributes().some(ce=>w.has(ce)))throw new Error(`[${NAME$j}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return M}function createHashKey(d,o){const l=[],c=d.getIndices();l.push(o.get(c));for(const u of d.listAttributes())l.push(o.get(u));return l.sort().join("|")}index_modern_KHRDracoMeshCompression.EXTENSION_NAME=NAME$j,index_modern_KHRDracoMeshCompression.EncoderMethod=index_modern_EncoderMethod;class Light extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_LIGHTS_PUNCTUAL,this.propertyType="Light",this.parentTypes=[index_modern_PropertyType.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:Light.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(o){return this.set("color",o)}getIntensity(){return this.get("intensity")}setIntensity(o){return this.set("intensity",o)}getType(){return this.get("type")}setType(o){return this.set("type",o)}getRange(){return this.get("range")}setRange(o){return this.set("range",o)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(o){return this.set("innerConeAngle",o)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(o){return this.set("outerConeAngle",o)}}Light.EXTENSION_NAME=KHR_LIGHTS_PUNCTUAL,Light.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};const NAME$i=KHR_LIGHTS_PUNCTUAL;class KHRLightsPunctual extends Extension{constructor(...o){super(...o),this.extensionName=NAME$i}createLight(o=""){return new Light(this.document.getGraph(),o)}read(o){const l=o.jsonDoc;if(!l.json.extensions||!l.json.extensions[NAME$i])return this;const c=(l.json.extensions[NAME$i].lights||[]).map(u=>{var h,_;const A=this.createLight().setName(u.name||"").setType(u.type);return u.color!==void 0&&A.setColor(u.color),u.intensity!==void 0&&A.setIntensity(u.intensity),u.range!==void 0&&A.setRange(u.range),((h=u.spot)==null?void 0:h.innerConeAngle)!==void 0&&A.setInnerConeAngle(u.spot.innerConeAngle),((_=u.spot)==null?void 0:_.outerConeAngle)!==void 0&&A.setOuterConeAngle(u.spot.outerConeAngle),A});return l.json.nodes.forEach((u,h)=>{if(!u.extensions||!u.extensions[NAME$i])return;const _=u.extensions[NAME$i];o.nodes[h].setExtension(NAME$i,c[_.light])}),this}write(o){const l=o.jsonDoc;if(this.properties.size===0)return this;const c=[],u=new Map;for(const h of this.properties){const _=h,A={type:_.getType()};index_modern_MathUtils.eq(_.getColor(),[1,1,1])||(A.color=_.getColor()),_.getIntensity()!==1&&(A.intensity=_.getIntensity()),_.getRange()!=null&&(A.range=_.getRange()),_.getName()&&(A.name=_.getName()),_.getType()===Light.Type.SPOT&&(A.spot={innerConeAngle:_.getInnerConeAngle(),outerConeAngle:_.getOuterConeAngle()}),c.push(A),u.set(_,c.length-1)}return this.document.getRoot().listNodes().forEach(h=>{const _=h.getExtension(NAME$i);if(_){const A=o.nodeIndexMap.get(h),w=l.json.nodes[A];w.extensions=w.extensions||{},w.extensions[NAME$i]={light:u.get(_)}}}),l.json.extensions=l.json.extensions||{},l.json.extensions[NAME$i]={lights:c},this}}KHRLightsPunctual.EXTENSION_NAME=NAME$i;const{R:R$7,G:G$7,B:B$5}=index_modern_TextureChannel;class Anisotropy extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_ANISOTROPY,this.propertyType="Anisotropy",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{anisotropyStrength:0,anisotropyRotation:0,anisotropyTexture:null,anisotropyTextureInfo:new index_modern_TextureInfo(this.graph,"anisotropyTextureInfo")})}getAnisotropyStrength(){return this.get("anisotropyStrength")}setAnisotropyStrength(o){return this.set("anisotropyStrength",o)}getAnisotropyRotation(){return this.get("anisotropyRotation")}setAnisotropyRotation(o){return this.set("anisotropyRotation",o)}getAnisotropyTexture(){return this.getRef("anisotropyTexture")}getAnisotropyTextureInfo(){return this.getRef("anisotropyTexture")?this.getRef("anisotropyTextureInfo"):null}setAnisotropyTexture(o){return this.setRef("anisotropyTexture",o,{channels:R$7|G$7|B$5})}}Anisotropy.EXTENSION_NAME=KHR_MATERIALS_ANISOTROPY;const NAME$h=KHR_MATERIALS_ANISOTROPY;class KHRMaterialsAnisotropy extends Extension{constructor(...o){super(...o),this.extensionName=NAME$h,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createAnisotropy(){return new Anisotropy(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$h]){const A=this.createAnisotropy();o.materials[_].setExtension(NAME$h,A);const w=h.extensions[NAME$h];if(w.anisotropyStrength!==void 0&&A.setAnisotropyStrength(w.anisotropyStrength),w.anisotropyRotation!==void 0&&A.setAnisotropyRotation(w.anisotropyRotation),w.anisotropyTexture!==void 0){const C=w.anisotropyTexture,M=o.textures[u[C.index].source];A.setAnisotropyTexture(M),o.setTextureInfo(A.getAnisotropyTextureInfo(),C)}}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$h);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$h]={};if(u.getAnisotropyStrength()>0&&(A.anisotropyStrength=u.getAnisotropyStrength()),u.getAnisotropyRotation()!==0&&(A.anisotropyRotation=u.getAnisotropyRotation()),u.getAnisotropyTexture()){const w=u.getAnisotropyTexture(),C=u.getAnisotropyTextureInfo();A.anisotropyTexture=o.createTextureInfoDef(w,C)}}}),this}}KHRMaterialsAnisotropy.EXTENSION_NAME=NAME$h;const{R:R$6,G:G$6,B:B$4}=index_modern_TextureChannel;class Clearcoat extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_CLEARCOAT,this.propertyType="Clearcoat",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new index_modern_TextureInfo(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new index_modern_TextureInfo(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new index_modern_TextureInfo(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(o){return this.set("clearcoatFactor",o)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(o){return this.setRef("clearcoatTexture",o,{channels:R$6})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(o){return this.set("clearcoatRoughnessFactor",o)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(o){return this.setRef("clearcoatRoughnessTexture",o,{channels:G$6})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(o){return this.set("clearcoatNormalScale",o)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(o){return this.setRef("clearcoatNormalTexture",o,{channels:R$6|G$6|B$4})}}Clearcoat.EXTENSION_NAME=KHR_MATERIALS_CLEARCOAT;const NAME$g=KHR_MATERIALS_CLEARCOAT;class KHRMaterialsClearcoat extends Extension{constructor(...o){super(...o),this.extensionName=NAME$g,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createClearcoat(){return new Clearcoat(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$g]){const A=this.createClearcoat();o.materials[_].setExtension(NAME$g,A);const w=h.extensions[NAME$g];if(w.clearcoatFactor!==void 0&&A.setClearcoatFactor(w.clearcoatFactor),w.clearcoatRoughnessFactor!==void 0&&A.setClearcoatRoughnessFactor(w.clearcoatRoughnessFactor),w.clearcoatTexture!==void 0){const C=w.clearcoatTexture,M=o.textures[u[C.index].source];A.setClearcoatTexture(M),o.setTextureInfo(A.getClearcoatTextureInfo(),C)}if(w.clearcoatRoughnessTexture!==void 0){const C=w.clearcoatRoughnessTexture,M=o.textures[u[C.index].source];A.setClearcoatRoughnessTexture(M),o.setTextureInfo(A.getClearcoatRoughnessTextureInfo(),C)}if(w.clearcoatNormalTexture!==void 0){const C=w.clearcoatNormalTexture,M=o.textures[u[C.index].source];A.setClearcoatNormalTexture(M),o.setTextureInfo(A.getClearcoatNormalTextureInfo(),C),C.scale!==void 0&&A.setClearcoatNormalScale(C.scale)}}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$g);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$g]={clearcoatFactor:u.getClearcoatFactor(),clearcoatRoughnessFactor:u.getClearcoatRoughnessFactor()};if(u.getClearcoatTexture()){const w=u.getClearcoatTexture(),C=u.getClearcoatTextureInfo();A.clearcoatTexture=o.createTextureInfoDef(w,C)}if(u.getClearcoatRoughnessTexture()){const w=u.getClearcoatRoughnessTexture(),C=u.getClearcoatRoughnessTextureInfo();A.clearcoatRoughnessTexture=o.createTextureInfoDef(w,C)}if(u.getClearcoatNormalTexture()){const w=u.getClearcoatNormalTexture(),C=u.getClearcoatNormalTextureInfo();A.clearcoatNormalTexture=o.createTextureInfoDef(w,C),u.getClearcoatNormalScale()!==1&&(A.clearcoatNormalTexture.scale=u.getClearcoatNormalScale())}}}),this}}KHRMaterialsClearcoat.EXTENSION_NAME=NAME$g;const{R:R$5,G:G$5,B:B$3,A:A$3}=index_modern_TextureChannel;class DiffuseTransmission extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_DIFFUSE_TRANSMISSION,this.propertyType="DiffuseTransmission",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseTransmissionFactor:0,diffuseTransmissionTexture:null,diffuseTransmissionTextureInfo:new index_modern_TextureInfo(this.graph,"diffuseTransmissionTextureInfo"),diffuseTransmissionColorFactor:[1,1,1],diffuseTransmissionColorTexture:null,diffuseTransmissionColorTextureInfo:new index_modern_TextureInfo(this.graph,"diffuseTransmissionColorTextureInfo")})}getDiffuseTransmissionFactor(){return this.get("diffuseTransmissionFactor")}setDiffuseTransmissionFactor(o){return this.set("diffuseTransmissionFactor",o)}getDiffuseTransmissionTexture(){return this.getRef("diffuseTransmissionTexture")}getDiffuseTransmissionTextureInfo(){return this.getRef("diffuseTransmissionTexture")?this.getRef("diffuseTransmissionTextureInfo"):null}setDiffuseTransmissionTexture(o){return this.setRef("diffuseTransmissionTexture",o,{channels:A$3})}getDiffuseTransmissionColorFactor(){return this.get("diffuseTransmissionColorFactor")}setDiffuseTransmissionColorFactor(o){return this.set("diffuseTransmissionColorFactor",o)}getDiffuseTransmissionColorTexture(){return this.getRef("diffuseTransmissionColorTexture")}getDiffuseTransmissionColorTextureInfo(){return this.getRef("diffuseTransmissionColorTexture")?this.getRef("diffuseTransmissionColorTextureInfo"):null}setDiffuseTransmissionColorTexture(o){return this.setRef("diffuseTransmissionColorTexture",o,{channels:R$5|G$5|B$3})}}DiffuseTransmission.EXTENSION_NAME=KHR_MATERIALS_DIFFUSE_TRANSMISSION;const NAME$f=KHR_MATERIALS_DIFFUSE_TRANSMISSION;class KHRMaterialsDiffuseTransmission extends Extension{constructor(...o){super(...o),this.extensionName=NAME$f}createDiffuseTransmission(){return new DiffuseTransmission(this.document.getGraph())}read(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$f]){const A=this.createDiffuseTransmission();o.materials[_].setExtension(NAME$f,A);const w=h.extensions[NAME$f];if(w.diffuseTransmissionFactor!==void 0&&A.setDiffuseTransmissionFactor(w.diffuseTransmissionFactor),w.diffuseTransmissionColorFactor!==void 0&&A.setDiffuseTransmissionColorFactor(w.diffuseTransmissionColorFactor),w.diffuseTransmissionTexture!==void 0){const C=w.diffuseTransmissionTexture,M=o.textures[u[C.index].source];A.setDiffuseTransmissionTexture(M),o.setTextureInfo(A.getDiffuseTransmissionTextureInfo(),C)}if(w.diffuseTransmissionColorTexture!==void 0){const C=w.diffuseTransmissionColorTexture,M=o.textures[u[C.index].source];A.setDiffuseTransmissionColorTexture(M),o.setTextureInfo(A.getDiffuseTransmissionColorTextureInfo(),C)}}}),this}write(o){const l=o.jsonDoc;for(const c of this.document.getRoot().listMaterials()){const u=c.getExtension(NAME$f);if(!u)continue;const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$f]={diffuseTransmissionFactor:u.getDiffuseTransmissionFactor(),diffuseTransmissionColorFactor:u.getDiffuseTransmissionColorFactor()};if(u.getDiffuseTransmissionTexture()){const w=u.getDiffuseTransmissionTexture(),C=u.getDiffuseTransmissionTextureInfo();A.diffuseTransmissionTexture=o.createTextureInfoDef(w,C)}if(u.getDiffuseTransmissionColorTexture()){const w=u.getDiffuseTransmissionColorTexture(),C=u.getDiffuseTransmissionColorTextureInfo();A.diffuseTransmissionColorTexture=o.createTextureInfoDef(w,C)}}return this}}KHRMaterialsDiffuseTransmission.EXTENSION_NAME=NAME$f;class Dispersion extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_DISPERSION,this.propertyType="Dispersion",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{dispersion:0})}getDispersion(){return this.get("dispersion")}setDispersion(o){return this.set("dispersion",o)}}Dispersion.EXTENSION_NAME=KHR_MATERIALS_DISPERSION;const NAME$e=KHR_MATERIALS_DISPERSION;class KHRMaterialsDispersion extends Extension{constructor(...o){super(...o),this.extensionName=NAME$e,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createDispersion(){return new Dispersion(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){return(o.jsonDoc.json.materials||[]).forEach((l,c)=>{if(l.extensions&&l.extensions[NAME$e]){const u=this.createDispersion();o.materials[c].setExtension(NAME$e,u);const h=l.extensions[NAME$e];h.dispersion!==void 0&&u.setDispersion(h.dispersion)}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$e);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{},_.extensions[NAME$e]={dispersion:u.getDispersion()}}}),this}}KHRMaterialsDispersion.EXTENSION_NAME=NAME$e;class EmissiveStrength extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_EMISSIVE_STRENGTH,this.propertyType="EmissiveStrength",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(o){return this.set("emissiveStrength",o)}}EmissiveStrength.EXTENSION_NAME=KHR_MATERIALS_EMISSIVE_STRENGTH;const NAME$d=KHR_MATERIALS_EMISSIVE_STRENGTH;class KHRMaterialsEmissiveStrength extends Extension{constructor(...o){super(...o),this.extensionName=NAME$d,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createEmissiveStrength(){return new EmissiveStrength(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){return(o.jsonDoc.json.materials||[]).forEach((l,c)=>{if(l.extensions&&l.extensions[NAME$d]){const u=this.createEmissiveStrength();o.materials[c].setExtension(NAME$d,u);const h=l.extensions[NAME$d];h.emissiveStrength!==void 0&&u.setEmissiveStrength(h.emissiveStrength)}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$d);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{},_.extensions[NAME$d]={emissiveStrength:u.getEmissiveStrength()}}}),this}}KHRMaterialsEmissiveStrength.EXTENSION_NAME=NAME$d;class IOR extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_IOR,this.propertyType="IOR",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:1.5})}getIOR(){return this.get("ior")}setIOR(o){return this.set("ior",o)}}IOR.EXTENSION_NAME=KHR_MATERIALS_IOR;const NAME$c=KHR_MATERIALS_IOR;class KHRMaterialsIOR extends Extension{constructor(...o){super(...o),this.extensionName=NAME$c,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createIOR(){return new IOR(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){return(o.jsonDoc.json.materials||[]).forEach((l,c)=>{if(l.extensions&&l.extensions[NAME$c]){const u=this.createIOR();o.materials[c].setExtension(NAME$c,u);const h=l.extensions[NAME$c];h.ior!==void 0&&u.setIOR(h.ior)}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$c);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{},_.extensions[NAME$c]={ior:u.getIOR()}}}),this}}KHRMaterialsIOR.EXTENSION_NAME=NAME$c;const{R:R$4,G:G$4}=index_modern_TextureChannel;class Iridescence extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_IRIDESCENCE,this.propertyType="Iridescence",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new index_modern_TextureInfo(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new index_modern_TextureInfo(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(o){return this.set("iridescenceFactor",o)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(o){return this.setRef("iridescenceTexture",o,{channels:R$4})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(o){return this.set("iridescenceIOR",o)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(o){return this.set("iridescenceThicknessMinimum",o)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(o){return this.set("iridescenceThicknessMaximum",o)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(o){return this.setRef("iridescenceThicknessTexture",o,{channels:G$4})}}Iridescence.EXTENSION_NAME=KHR_MATERIALS_IRIDESCENCE;const NAME$b=KHR_MATERIALS_IRIDESCENCE;class KHRMaterialsIridescence extends Extension{constructor(...o){super(...o),this.extensionName=NAME$b,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createIridescence(){return new Iridescence(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$b]){const A=this.createIridescence();o.materials[_].setExtension(NAME$b,A);const w=h.extensions[NAME$b];if(w.iridescenceFactor!==void 0&&A.setIridescenceFactor(w.iridescenceFactor),w.iridescenceIor!==void 0&&A.setIridescenceIOR(w.iridescenceIor),w.iridescenceThicknessMinimum!==void 0&&A.setIridescenceThicknessMinimum(w.iridescenceThicknessMinimum),w.iridescenceThicknessMaximum!==void 0&&A.setIridescenceThicknessMaximum(w.iridescenceThicknessMaximum),w.iridescenceTexture!==void 0){const C=w.iridescenceTexture,M=o.textures[u[C.index].source];A.setIridescenceTexture(M),o.setTextureInfo(A.getIridescenceTextureInfo(),C)}if(w.iridescenceThicknessTexture!==void 0){const C=w.iridescenceThicknessTexture,M=o.textures[u[C.index].source];A.setIridescenceThicknessTexture(M),o.setTextureInfo(A.getIridescenceThicknessTextureInfo(),C)}}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$b);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$b]={};if(u.getIridescenceFactor()>0&&(A.iridescenceFactor=u.getIridescenceFactor()),u.getIridescenceIOR()!==1.3&&(A.iridescenceIor=u.getIridescenceIOR()),u.getIridescenceThicknessMinimum()!==100&&(A.iridescenceThicknessMinimum=u.getIridescenceThicknessMinimum()),u.getIridescenceThicknessMaximum()!==400&&(A.iridescenceThicknessMaximum=u.getIridescenceThicknessMaximum()),u.getIridescenceTexture()){const w=u.getIridescenceTexture(),C=u.getIridescenceTextureInfo();A.iridescenceTexture=o.createTextureInfoDef(w,C)}if(u.getIridescenceThicknessTexture()){const w=u.getIridescenceThicknessTexture(),C=u.getIridescenceThicknessTextureInfo();A.iridescenceThicknessTexture=o.createTextureInfoDef(w,C)}}}),this}}KHRMaterialsIridescence.EXTENSION_NAME=NAME$b;const{R:R$3,G:G$3,B:B$2,A:A$2}=index_modern_TextureChannel;class PBRSpecularGlossiness extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.propertyType="PBRSpecularGlossiness",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new index_modern_TextureInfo(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new index_modern_TextureInfo(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(o){return this.set("diffuseFactor",o)}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(o){return this.setRef("diffuseTexture",o,{channels:R$3|G$3|B$2|A$2,isColor:!0})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(o){return this.set("specularFactor",o)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(o){return this.set("glossinessFactor",o)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(o){return this.setRef("specularGlossinessTexture",o,{channels:R$3|G$3|B$2|A$2})}}PBRSpecularGlossiness.EXTENSION_NAME=KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS;const NAME$a=KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS;class KHRMaterialsPBRSpecularGlossiness extends Extension{constructor(...o){super(...o),this.extensionName=NAME$a,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createPBRSpecularGlossiness(){return new PBRSpecularGlossiness(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$a]){const A=this.createPBRSpecularGlossiness();o.materials[_].setExtension(NAME$a,A);const w=h.extensions[NAME$a];if(w.diffuseFactor!==void 0&&A.setDiffuseFactor(w.diffuseFactor),w.specularFactor!==void 0&&A.setSpecularFactor(w.specularFactor),w.glossinessFactor!==void 0&&A.setGlossinessFactor(w.glossinessFactor),w.diffuseTexture!==void 0){const C=w.diffuseTexture,M=o.textures[u[C.index].source];A.setDiffuseTexture(M),o.setTextureInfo(A.getDiffuseTextureInfo(),C)}if(w.specularGlossinessTexture!==void 0){const C=w.specularGlossinessTexture,M=o.textures[u[C.index].source];A.setSpecularGlossinessTexture(M),o.setTextureInfo(A.getSpecularGlossinessTextureInfo(),C)}}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$a);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$a]={diffuseFactor:u.getDiffuseFactor(),specularFactor:u.getSpecularFactor(),glossinessFactor:u.getGlossinessFactor()};if(u.getDiffuseTexture()){const w=u.getDiffuseTexture(),C=u.getDiffuseTextureInfo();A.diffuseTexture=o.createTextureInfoDef(w,C)}if(u.getSpecularGlossinessTexture()){const w=u.getSpecularGlossinessTexture(),C=u.getSpecularGlossinessTextureInfo();A.specularGlossinessTexture=o.createTextureInfoDef(w,C)}}}),this}}KHRMaterialsPBRSpecularGlossiness.EXTENSION_NAME=NAME$a;const{R:R$2,G:G$2,B:B$1,A:A$1}=index_modern_TextureChannel;class Sheen extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_SHEEN,this.propertyType="Sheen",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new index_modern_TextureInfo(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new index_modern_TextureInfo(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}setSheenColorFactor(o){return this.set("sheenColorFactor",o)}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(o){return this.setRef("sheenColorTexture",o,{channels:R$2|G$2|B$1,isColor:!0})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(o){return this.set("sheenRoughnessFactor",o)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(o){return this.setRef("sheenRoughnessTexture",o,{channels:A$1})}}Sheen.EXTENSION_NAME=KHR_MATERIALS_SHEEN;const NAME$9=KHR_MATERIALS_SHEEN;class KHRMaterialsSheen extends Extension{constructor(...o){super(...o),this.extensionName=NAME$9,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createSheen(){return new Sheen(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$9]){const A=this.createSheen();o.materials[_].setExtension(NAME$9,A);const w=h.extensions[NAME$9];if(w.sheenColorFactor!==void 0&&A.setSheenColorFactor(w.sheenColorFactor),w.sheenRoughnessFactor!==void 0&&A.setSheenRoughnessFactor(w.sheenRoughnessFactor),w.sheenColorTexture!==void 0){const C=w.sheenColorTexture,M=o.textures[u[C.index].source];A.setSheenColorTexture(M),o.setTextureInfo(A.getSheenColorTextureInfo(),C)}if(w.sheenRoughnessTexture!==void 0){const C=w.sheenRoughnessTexture,M=o.textures[u[C.index].source];A.setSheenRoughnessTexture(M),o.setTextureInfo(A.getSheenRoughnessTextureInfo(),C)}}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$9);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$9]={sheenColorFactor:u.getSheenColorFactor(),sheenRoughnessFactor:u.getSheenRoughnessFactor()};if(u.getSheenColorTexture()){const w=u.getSheenColorTexture(),C=u.getSheenColorTextureInfo();A.sheenColorTexture=o.createTextureInfoDef(w,C)}if(u.getSheenRoughnessTexture()){const w=u.getSheenRoughnessTexture(),C=u.getSheenRoughnessTextureInfo();A.sheenRoughnessTexture=o.createTextureInfoDef(w,C)}}}),this}}KHRMaterialsSheen.EXTENSION_NAME=NAME$9;const{R:R$1,G:G$1,B:dist_index_modern_B,A:dist_index_modern_A}=index_modern_TextureChannel;class Specular extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_SPECULAR,this.propertyType="Specular",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new index_modern_TextureInfo(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new index_modern_TextureInfo(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(o){return this.set("specularFactor",o)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(o){return this.set("specularColorFactor",o)}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(o){return this.setRef("specularTexture",o,{channels:dist_index_modern_A})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(o){return this.setRef("specularColorTexture",o,{channels:R$1|G$1|dist_index_modern_B,isColor:!0})}}Specular.EXTENSION_NAME=KHR_MATERIALS_SPECULAR;const NAME$8=KHR_MATERIALS_SPECULAR;class KHRMaterialsSpecular extends Extension{constructor(...o){super(...o),this.extensionName=NAME$8,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createSpecular(){return new Specular(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$8]){const A=this.createSpecular();o.materials[_].setExtension(NAME$8,A);const w=h.extensions[NAME$8];if(w.specularFactor!==void 0&&A.setSpecularFactor(w.specularFactor),w.specularColorFactor!==void 0&&A.setSpecularColorFactor(w.specularColorFactor),w.specularTexture!==void 0){const C=w.specularTexture,M=o.textures[u[C.index].source];A.setSpecularTexture(M),o.setTextureInfo(A.getSpecularTextureInfo(),C)}if(w.specularColorTexture!==void 0){const C=w.specularColorTexture,M=o.textures[u[C.index].source];A.setSpecularColorTexture(M),o.setTextureInfo(A.getSpecularColorTextureInfo(),C)}}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$8);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$8]={};if(u.getSpecularFactor()!==1&&(A.specularFactor=u.getSpecularFactor()),index_modern_MathUtils.eq(u.getSpecularColorFactor(),[1,1,1])||(A.specularColorFactor=u.getSpecularColorFactor()),u.getSpecularTexture()){const w=u.getSpecularTexture(),C=u.getSpecularTextureInfo();A.specularTexture=o.createTextureInfoDef(w,C)}if(u.getSpecularColorTexture()){const w=u.getSpecularColorTexture(),C=u.getSpecularColorTextureInfo();A.specularColorTexture=o.createTextureInfoDef(w,C)}}}),this}}KHRMaterialsSpecular.EXTENSION_NAME=NAME$8;const{R:dist_index_modern_R}=index_modern_TextureChannel;class Transmission extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_TRANSMISSION,this.propertyType="Transmission",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new index_modern_TextureInfo(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(o){return this.set("transmissionFactor",o)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(o){return this.setRef("transmissionTexture",o,{channels:dist_index_modern_R})}}Transmission.EXTENSION_NAME=KHR_MATERIALS_TRANSMISSION;const NAME$7=KHR_MATERIALS_TRANSMISSION;class KHRMaterialsTransmission extends Extension{constructor(...o){super(...o),this.extensionName=NAME$7,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createTransmission(){return new Transmission(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$7]){const A=this.createTransmission();o.materials[_].setExtension(NAME$7,A);const w=h.extensions[NAME$7];if(w.transmissionFactor!==void 0&&A.setTransmissionFactor(w.transmissionFactor),w.transmissionTexture!==void 0){const C=w.transmissionTexture,M=o.textures[u[C.index].source];A.setTransmissionTexture(M),o.setTextureInfo(A.getTransmissionTextureInfo(),C)}}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$7);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$7]={transmissionFactor:u.getTransmissionFactor()};if(u.getTransmissionTexture()){const w=u.getTransmissionTexture(),C=u.getTransmissionTextureInfo();A.transmissionTexture=o.createTextureInfoDef(w,C)}}}),this}}KHRMaterialsTransmission.EXTENSION_NAME=NAME$7;class Unlit extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_UNLIT,this.propertyType="Unlit",this.parentTypes=[index_modern_PropertyType.MATERIAL]}}Unlit.EXTENSION_NAME=KHR_MATERIALS_UNLIT;const NAME$6=KHR_MATERIALS_UNLIT;class index_modern_KHRMaterialsUnlit extends Extension{constructor(...o){super(...o),this.extensionName=NAME$6,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createUnlit(){return new Unlit(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){return(o.jsonDoc.json.materials||[]).forEach((l,c)=>{l.extensions&&l.extensions[NAME$6]&&o.materials[c].setExtension(NAME$6,this.createUnlit())}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{if(c.getExtension(NAME$6)){const u=o.materialIndexMap.get(c),h=l.json.materials[u];h.extensions=h.extensions||{},h.extensions[NAME$6]={}}}),this}}index_modern_KHRMaterialsUnlit.EXTENSION_NAME=NAME$6;class Mapping extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_VARIANTS,this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:new RefSet})}getMaterial(){return this.getRef("material")}setMaterial(o){return this.setRef("material",o)}addVariant(o){return this.addRef("variants",o)}removeVariant(o){return this.removeRef("variants",o)}listVariants(){return this.listRefs("variants")}}Mapping.EXTENSION_NAME=KHR_MATERIALS_VARIANTS;class MappingList extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_VARIANTS,this.propertyType="MappingList",this.parentTypes=[index_modern_PropertyType.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:new RefSet})}addMapping(o){return this.addRef("mappings",o)}removeMapping(o){return this.removeRef("mappings",o)}listMappings(){return this.listRefs("mappings")}}MappingList.EXTENSION_NAME=KHR_MATERIALS_VARIANTS;class Variant extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_VARIANTS,this.propertyType="Variant",this.parentTypes=["MappingList"]}}Variant.EXTENSION_NAME=KHR_MATERIALS_VARIANTS;const NAME$5=KHR_MATERIALS_VARIANTS;class KHRMaterialsVariants extends Extension{constructor(...o){super(...o),this.extensionName=NAME$5}createMappingList(){return new MappingList(this.document.getGraph())}createVariant(o=""){return new Variant(this.document.getGraph(),o)}createMapping(){return new Mapping(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter(o=>o instanceof Variant)}read(o){const l=o.jsonDoc;if(!l.json.extensions||!l.json.extensions[NAME$5])return this;const c=(l.json.extensions[NAME$5].variants||[]).map(u=>this.createVariant().setName(u.name||""));return(l.json.meshes||[]).forEach((u,h)=>{const _=o.meshes[h];(u.primitives||[]).forEach((A,w)=>{if(!A.extensions||!A.extensions[NAME$5])return;const C=this.createMappingList(),M=A.extensions[NAME$5];for(const O of M.mappings){const ne=this.createMapping();O.material!==void 0&&ne.setMaterial(o.materials[O.material]);for(const ce of O.variants||[])ne.addVariant(c[ce]);C.addMapping(ne)}_.listPrimitives()[w].setExtension(NAME$5,C)})}),this}write(o){const l=o.jsonDoc,c=this.listVariants();if(!c.length)return this;const u=[],h=new Map;for(const _ of c)h.set(_,u.length),u.push(o.createPropertyDef(_));for(const _ of this.document.getRoot().listMeshes()){const A=o.meshIndexMap.get(_);_.listPrimitives().forEach((w,C)=>{const M=w.getExtension(NAME$5);if(!M)return;const O=o.jsonDoc.json.meshes[A].primitives[C],ne=M.listMappings().map(ce=>{const ue=o.createPropertyDef(ce),ye=ce.getMaterial();return ye&&(ue.material=o.materialIndexMap.get(ye)),ue.variants=ce.listVariants().map(Oe=>h.get(Oe)),ue});O.extensions=O.extensions||{},O.extensions[NAME$5]={mappings:ne}})}return l.json.extensions=l.json.extensions||{},l.json.extensions[NAME$5]={variants:u},this}}KHRMaterialsVariants.EXTENSION_NAME=NAME$5;const{G:dist_index_modern_G}=index_modern_TextureChannel;class Volume extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_MATERIALS_VOLUME,this.propertyType="Volume",this.parentTypes=[index_modern_PropertyType.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new index_modern_TextureInfo(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(o){return this.set("thicknessFactor",o)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(o){return this.setRef("thicknessTexture",o,{channels:dist_index_modern_G})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(o){return this.set("attenuationDistance",o)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(o){return this.set("attenuationColor",o)}}Volume.EXTENSION_NAME=KHR_MATERIALS_VOLUME;const NAME$4=KHR_MATERIALS_VOLUME;class KHRMaterialsVolume extends Extension{constructor(...o){super(...o),this.extensionName=NAME$4,this.prereadTypes=[index_modern_PropertyType.MESH],this.prewriteTypes=[index_modern_PropertyType.MESH]}createVolume(){return new Volume(this.document.getGraph())}read(o){return this}write(o){return this}preread(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{if(h.extensions&&h.extensions[NAME$4]){const A=this.createVolume();o.materials[_].setExtension(NAME$4,A);const w=h.extensions[NAME$4];if(w.thicknessFactor!==void 0&&A.setThicknessFactor(w.thicknessFactor),w.attenuationDistance!==void 0&&A.setAttenuationDistance(w.attenuationDistance),w.attenuationColor!==void 0&&A.setAttenuationColor(w.attenuationColor),w.thicknessTexture!==void 0){const C=w.thicknessTexture,M=o.textures[u[C.index].source];A.setThicknessTexture(M),o.setTextureInfo(A.getThicknessTextureInfo(),C)}}}),this}prewrite(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(NAME$4);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A=_.extensions[NAME$4]={};if(u.getThicknessFactor()>0&&(A.thicknessFactor=u.getThicknessFactor()),Number.isFinite(u.getAttenuationDistance())&&(A.attenuationDistance=u.getAttenuationDistance()),index_modern_MathUtils.eq(u.getAttenuationColor(),[1,1,1])||(A.attenuationColor=u.getAttenuationColor()),u.getThicknessTexture()){const w=u.getThicknessTexture(),C=u.getThicknessTextureInfo();A.thicknessTexture=o.createTextureInfoDef(w,C)}}}),this}}KHRMaterialsVolume.EXTENSION_NAME=NAME$4;const NAME$3=index_modern_KHR_MESH_QUANTIZATION;class index_modern_KHRMeshQuantization extends Extension{constructor(...o){super(...o),this.extensionName=NAME$3}read(o){return this}write(o){return this}}index_modern_KHRMeshQuantization.EXTENSION_NAME=NAME$3;const NAME$2=index_modern_KHR_TEXTURE_BASISU;class KTX2ImageUtils{match(o){return o[0]===171&&o[1]===75&&o[2]===84&&o[3]===88&&o[4]===32&&o[5]===50&&o[6]===48&&o[7]===187&&o[8]===13&&o[9]===10&&o[10]===26&&o[11]===10}getSize(o){const l=ktx_parse_modern_read(o);return[l.pixelWidth,l.pixelHeight]}getChannels(o){const l=ktx_parse_modern_read(o).dataFormatDescriptor[0];if(l.colorModel===ktx_parse_modern_KHR_DF_MODEL_ETC1S)return l.samples.length!==2||15&~l.samples[1].channelType?3:4;if(l.colorModel===ktx_parse_modern_KHR_DF_MODEL_UASTC)return(15&l.samples[0].channelType)==3?4:3;throw new Error(`Unexpected KTX2 colorModel, "${l.colorModel}".`)}getVRAMByteLength(o){const l=ktx_parse_modern_read(o),c=this.getChannels(o)>3;let u=0;for(let h=0;h<l.levels.length;h++){const _=l.levels[h];_.uncompressedByteLength?u+=_.uncompressedByteLength:u+=Math.max(1,Math.floor(l.pixelWidth/Math.pow(2,h)))/4*(Math.max(1,Math.floor(l.pixelHeight/Math.pow(2,h)))/4)*(c?16:8)}return u}}class KHRTextureBasisu extends Extension{constructor(...o){super(...o),this.extensionName=NAME$2,this.prereadTypes=[index_modern_PropertyType.TEXTURE]}static register(){index_modern_ImageUtils.registerFormat("image/ktx2",new KTX2ImageUtils)}preread(o){return o.jsonDoc.json.textures.forEach(l=>{if(l.extensions&&l.extensions[NAME$2]){const c=l.extensions[NAME$2];l.source=c.source}}),this}read(o){return this}write(o){const l=o.jsonDoc;return this.document.getRoot().listTextures().forEach(c=>{if(c.getMimeType()==="image/ktx2"){const u=o.imageIndexMap.get(c);l.json.textures.forEach(h=>{h.source===u&&(h.extensions=h.extensions||{},h.extensions[NAME$2]={source:h.source},delete h.source)})}}),this}}KHRTextureBasisu.EXTENSION_NAME=NAME$2;class Transform extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_TEXTURE_TRANSFORM,this.propertyType="Transform",this.parentTypes=[index_modern_PropertyType.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(o){return this.set("offset",o)}getRotation(){return this.get("rotation")}setRotation(o){return this.set("rotation",o)}getScale(){return this.get("scale")}setScale(o){return this.set("scale",o)}getTexCoord(){return this.get("texCoord")}setTexCoord(o){return this.set("texCoord",o)}}Transform.EXTENSION_NAME=KHR_TEXTURE_TRANSFORM;const NAME$1=KHR_TEXTURE_TRANSFORM;class KHRTextureTransform extends Extension{constructor(...o){super(...o),this.extensionName=NAME$1}createTransform(){return new Transform(this.document.getGraph())}read(o){for(const[l,c]of Array.from(o.textureInfos.entries())){if(!c.extensions||!c.extensions[NAME$1])continue;const u=this.createTransform(),h=c.extensions[NAME$1];h.offset!==void 0&&u.setOffset(h.offset),h.rotation!==void 0&&u.setRotation(h.rotation),h.scale!==void 0&&u.setScale(h.scale),h.texCoord!==void 0&&u.setTexCoord(h.texCoord),l.setExtension(NAME$1,u)}return this}write(o){const l=Array.from(o.textureInfoDefMap.entries());for(const[c,u]of l){const h=c.getExtension(NAME$1);if(!h)continue;u.extensions=u.extensions||{};const _={},A=index_modern_MathUtils.eq;A(h.getOffset(),[0,0])||(_.offset=h.getOffset()),h.getRotation()!==0&&(_.rotation=h.getRotation()),A(h.getScale(),[1,1])||(_.scale=h.getScale()),h.getTexCoord()!=null&&(_.texCoord=h.getTexCoord()),u.extensions[NAME$1]=_}return this}}KHRTextureTransform.EXTENSION_NAME=NAME$1;const PARENT_TYPES=[index_modern_PropertyType.ROOT,index_modern_PropertyType.SCENE,index_modern_PropertyType.NODE,index_modern_PropertyType.MESH,index_modern_PropertyType.MATERIAL,index_modern_PropertyType.TEXTURE,index_modern_PropertyType.ANIMATION];class Packet extends index_modern_ExtensionProperty{init(){this.extensionName=KHR_XMP_JSON_LD,this.propertyType="Packet",this.parentTypes=PARENT_TYPES}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(o){return this.set("context",dist_index_modern_extends({},o))}listProperties(){return Object.keys(this.get("properties"))}getProperty(o){const l=this.get("properties");return o in l?l[o]:null}setProperty(o,l){this._assertContext(o);const c=dist_index_modern_extends({},this.get("properties"));return l?c[o]=l:delete c[o],this.set("properties",c)}toJSONLD(){return dist_index_modern_extends({"@context":copyJSON(this.get("context"))},copyJSON(this.get("properties")))}fromJSONLD(o){const l=(o=copyJSON(o))["@context"];return l&&this.set("context",l),delete o["@context"],this.set("properties",o)}_assertContext(o){if(!(o.split(":")[0]in this.get("context")))throw new Error(`${KHR_XMP_JSON_LD}: Missing context for term, "${o}".`)}}function copyJSON(d){return JSON.parse(JSON.stringify(d))}Packet.EXTENSION_NAME=KHR_XMP_JSON_LD;const NAME=KHR_XMP_JSON_LD;class KHRXMP extends Extension{constructor(...o){super(...o),this.extensionName=NAME}createPacket(){return new Packet(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(o){var l;const c=(l=o.jsonDoc.json.extensions)==null?void 0:l[NAME];if(!c||!c.packets)return this;const u=o.jsonDoc.json,h=this.document.getRoot(),_=c.packets.map(C=>this.createPacket().fromJSONLD(C)),A=[[u.asset],u.scenes,u.nodes,u.meshes,u.materials,u.images,u.animations],w=[[h],h.listScenes(),h.listNodes(),h.listMeshes(),h.listMaterials(),h.listTextures(),h.listAnimations()];for(let C=0;C<A.length;C++){const M=A[C]||[];for(let O=0;O<M.length;O++){const ne=M[O];if(ne.extensions&&ne.extensions[NAME]){const ce=ne.extensions[NAME];w[C][O].setExtension(NAME,_[ce.packet])}}}return this}write(o){const{json:l}=o.jsonDoc,c=[];for(const u of this.properties){c.push(u.toJSONLD());for(const h of u.listParents()){let _;switch(h.propertyType){case index_modern_PropertyType.ROOT:_=l.asset;break;case index_modern_PropertyType.SCENE:_=l.scenes[o.sceneIndexMap.get(h)];break;case index_modern_PropertyType.NODE:_=l.nodes[o.nodeIndexMap.get(h)];break;case index_modern_PropertyType.MESH:_=l.meshes[o.meshIndexMap.get(h)];break;case index_modern_PropertyType.MATERIAL:_=l.materials[o.materialIndexMap.get(h)];break;case index_modern_PropertyType.TEXTURE:_=l.images[o.imageIndexMap.get(h)];break;case index_modern_PropertyType.ANIMATION:_=l.animations[o.animationIndexMap.get(h)];break;default:_=null,this.document.getLogger().warn(`[${NAME}]: Unsupported parent property, "${h.propertyType}"`)}_&&(_.extensions=_.extensions||{},_.extensions[NAME]={packet:c.length-1})}}return c.length>0&&(l.extensions=l.extensions||{},l.extensions[NAME]={packets:c}),this}}KHRXMP.EXTENSION_NAME=NAME;const KHRONOS_EXTENSIONS=[index_modern_KHRDracoMeshCompression,KHRLightsPunctual,KHRMaterialsAnisotropy,KHRMaterialsClearcoat,KHRMaterialsDiffuseTransmission,KHRMaterialsDispersion,KHRMaterialsEmissiveStrength,KHRMaterialsIOR,KHRMaterialsIridescence,KHRMaterialsPBRSpecularGlossiness,KHRMaterialsSpecular,KHRMaterialsSheen,KHRMaterialsTransmission,index_modern_KHRMaterialsUnlit,KHRMaterialsVariants,KHRMaterialsVolume,index_modern_KHRMeshQuantization,KHRTextureBasisu,KHRTextureTransform,KHRXMP],ALL_EXTENSIONS=[index_modern_EXTMeshGPUInstancing,index_modern_EXTMeshoptCompression,index_modern_EXTTextureAVIF,index_modern_EXTTextureWebP,...KHRONOS_EXTENSIONS];class GLTFDracoExporter extends GLTFExporter2{constructor(o){super(),this._loadedLibs=!1,o=o||{method:index_modern_KHRDracoMeshCompression.EncoderMethod.EDGEBREAKER,encodeSpeed:5},this._io=new WebIO().registerExtensions(ALL_EXTENSIONS).registerExtensions(ALL_WEBGI_EXTENSIONS),this._encoderOptions=o}preload(){return this._loadLibs(),this}async _loadLibs(){if(this._loadedLibs||!this.loader)return;const o=await Promise.all([this.loader.initEncoder(),this.loader.initDecoder()]);this._io.registerDependencies({"draco3d.encoder":o[0],"draco3d.decoder":o[1]}),this._loadedLibs=!0}async parseAsync(o,{compress:l=!1,dracoOptions:c,...u},h=!1){if(!this.loader)return console.error("GLTFDracoExporter: No DRACOLoader2 instance provided"),super.parseAsync(o,u);await this._loadLibs();const _={...u};l&&(_.externalImagesInExtras=!0);const A=await new Promise((C,M)=>this.parse(o,C,M,_)),w=await super.parseAsync(A,_);if(!l)return w;try{if(!A)throw new Error("GLTFDracoExporter: gltf is null");let C=A;const M=C.byteLength||1/0,O=await(typeof C!="object"||C.byteLength?this._io.readBinary(new Uint8Array(C)):this._io.readJSON({json:C,resources:{}}));if(O.createExtension(index_modern_KHRDracoMeshCompression).setRequired(!0).setEncoderOptions({...this._encoderOptions,...c??{}}),_.exportExt==="glb")C=await this._io.writeBinary(O),isFinite(M)&&console.log("DRACO Compression ratio: "+(C.byteLength/M).toFixed(5));else{const ce=await this._io.writeJSON(O);C=ce.json,Object.values(ce.resources).filter(ue=>ue).length>0&&(console.warn("DRACOExporter: extra resources in resources not supported properly"),C.resources=ce.resources)}C.__isGLTFOutput=!0;const ne=await super.parseAsync(C,_);if(!ne)throw new Error("GLTFDracoExporter: blob is null");return ne.ext="glb",ne.__uncompressed=w,ne}catch(C){if(h)throw C;return console.error("Unable to compress glb with DRACO extension"),console.error(C),w}}addExtension(o){return this._io.registerExtensions([o]),this}createAndAddExtension(o,l){return this.addExtension(createGenericExtensionClass(o,l))}}function addGLTFDracoExporter(d,o,l){return addGLTFExporter(d,o,GLTFDracoExporter,c=>{const u=esm_browser_v4()+".drc",h=c;h.loader=l.registerFile(u),h.loader.setDecoderConfig({type:"js"}),h.loader.preload(!0,!0)})}class GLTFDracoExportPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.dependencies=[AssetManagerPlugin,AssetExporterPlugin]}async onAdded(o){await super.onAdded(o);const l=o.getManager().importer,c=o.getManager().exporter;if(!l)throw new Error("GLTFDracoExportPlugin: AssetImporter not found");addGLTFDracoExporter(c,o,l)}}GLTFDracoExportPlugin.PluginType="GLTFDracoExportPlugin";class WebGIViewerExtensionProperty extends index_modern_ExtensionProperty{constructor(){super(...arguments),this.extensionName=viewerGLTFExtension,this.parentTypes=[index_modern_PropertyType.SCENE],this.propertyType="ViewerJSON"}init(){}}class WebGIViewerExtension extends Extension{constructor(){super(...arguments),this.extensionName=viewerGLTFExtension,this._viewerConfig={},this._texturesRef=[],this.required=!0}read(o){var l;return this._viewerConfig={},(l=o.jsonDoc.json.scenes)===null||l===void 0||l.forEach((c,u)=>{if(c.extensions&&c.extensions[viewerGLTFExtension]){const h=new WebGIViewerExtensionProperty(this.document.getGraph());o.scenes[u].setExtension(viewerGLTFExtension,h),this._viewerConfig=c.extensions[viewerGLTFExtension]}}),this}write(o){return this.document.getRoot().listScenes().forEach(l=>{var c;if(l.getExtension(viewerGLTFExtension)){const u=(c=o.jsonDoc.json.scenes)===null||c===void 0?void 0:c[o.jsonDoc.json.scene||0];u&&Object.keys(this._viewerConfig).length>0&&(u.extensions=u.extensions||{},u.extensions[viewerGLTFExtension]=this._viewerConfig,this._texturesRef=[],this._viewerConfig={})}}),this}}WebGIViewerExtension.EXTENSION_NAME=viewerGLTFExtension;class GenericExtensionProperty extends index_modern_ExtensionProperty{addTexture(o,l,c,u=4369){this.setRef(o,c,{channels:u}),this.textures[o]=[l,c]}constructor(o,l,c){super(o,l),this.parentTypes=[index_modern_PropertyType.MATERIAL,index_modern_PropertyType.MESH,index_modern_PropertyType.NODE,index_modern_PropertyType.SCENE],this.propertyType="GenericExtension",this.textures={},this.extensionName=c}init(){}}class GenericExtension extends Extension{constructor(){super(...arguments),this.textureChannels={}}read(o){const l=o.jsonDoc,c=l.json.materials||[],u=l.json.textures||[];return c.forEach((h,_)=>{var A,w;if(h.extensions&&h.extensions[this.extensionName]){const C=new GenericExtensionProperty(this.document.getGraph(),"",this.extensionName);o.materials[_].setExtension(this.extensionName,C);const M={...h.extensions[this.extensionName]};for(const[O,ne]of Object.entries(M))if(typeof(ne==null?void 0:ne.index)=="number"){const ce=ne,ue=(A=u[ce.index])===null||A===void 0?void 0:A.source;if(typeof ue!="number"){console.warn("GLTF Pipeline: source texture not found for texture info",ce);continue}const ye=o.textures[ue],Oe=new index_modern_TextureInfo(this.document.getGraph()),ke=(w=this.textureChannels[O])!==null&&w!==void 0?w:4369;C.addTexture(O,Oe,ye,ke),o.setTextureInfo(Oe,ce),delete M[O]}C.setExtras(M)}}),(l.json.meshes||[]).forEach((h,_)=>{if(h.extensions&&h.extensions[this.extensionName]){const A=new GenericExtensionProperty(this.document.getGraph(),"",this.extensionName);o.meshes[_].setExtension(this.extensionName,A);const w=h.extensions[this.extensionName];A.setExtras(w)}}),(l.json.nodes||[]).forEach((h,_)=>{if(h.extensions&&h.extensions[this.extensionName]){const A=new GenericExtensionProperty(this.document.getGraph(),"",this.extensionName);o.nodes[_].setExtension(this.extensionName,A);const w=h.extensions[this.extensionName];A.setExtras(w)}}),(l.json.scenes||[]).forEach((h,_)=>{if(h.extensions&&h.extensions[this.extensionName]){const A=new GenericExtensionProperty(this.document.getGraph(),"",this.extensionName);o.scenes[_].setExtension(this.extensionName,A);const w=h.extensions[this.extensionName];A.setExtras(w)}}),this}write(o){const l=o.jsonDoc;return this.document.getRoot().listMaterials().forEach(c=>{const u=c.getExtension(this.extensionName);if(u){const h=o.materialIndexMap.get(c),_=l.json.materials[h];_.extensions=_.extensions||{};const A={...u.getExtras()};for(const[w,C]of Object.entries(u.textures)){const M=C[0],O=C[1];O&&(A[w]=o.createTextureInfoDef(O,M))}_.extensions[this.extensionName]=A}}),this.document.getRoot().listMeshes().forEach(c=>{const u=c.getExtension(this.extensionName);if(u){const h=o.meshIndexMap.get(c),_=l.json.meshes[h];_.extensions=_.extensions||{},_.extensions[this.extensionName]=u.getExtras()}}),this.document.getRoot().listNodes().forEach(c=>{const u=c.getExtension(this.extensionName);if(u){const h=o.nodeIndexMap.get(c),_=l.json.nodes[h];_.extensions=_.extensions||{},_.extensions[this.extensionName]=u.getExtras()}}),this.document.getRoot().listScenes().forEach(c=>{const u=c.getExtension(this.extensionName);if(u){const h=o.jsonDoc.json.scene||0,_=l.json.scenes[h];if(!_)return;_.extensions=_.extensions||{},_.extensions[this.extensionName]=u.getExtras()}}),this}}function stringToChannel(d){let o=0;return d.includes("R")&&(o|=index_modern_TextureChannel.R),d.includes("G")&&(o|=index_modern_TextureChannel.G),d.includes("B")&&(o|=index_modern_TextureChannel.B),d.includes("A")&&(o|=index_modern_TextureChannel.A),o}function createGenericExtensionClass(d,o){var l;return l=class extends GenericExtension{constructor(){super(...arguments),this.extensionName=d,this.textureChannels=o?Object.fromEntries(Object.entries(o).map(([c,u])=>[c,typeof u=="number"?u:stringToChannel(u)])):{}}},l.EXTENSION_NAME=d,l}class BumpMapMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=BumpMapMaterialExtension.EXTENSION_NAME,this.textureChannels={bumpTexture:index_modern_TextureChannel.R}}}BumpMapMaterialExtension.EXTENSION_NAME=GLTFMaterialsBumpMapExtensionName;class LightMapMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=LightMapMaterialExtension.EXTENSION_NAME,this.textureChannels={lightMapTexture:index_modern_TextureChannel.R|index_modern_TextureChannel.G|index_modern_TextureChannel.B}}}LightMapMaterialExtension.EXTENSION_NAME=GLTFMaterialsLightMapExtensionName;class AlphaMapMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=AlphaMapMaterialExtension.EXTENSION_NAME,this.textureChannels={alphaTexture:index_modern_TextureChannel.G}}}AlphaMapMaterialExtension.EXTENSION_NAME=GLTFMaterialsAlphaMapExtensionName;class DisplacementMapMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=DisplacementMapMaterialExtension.EXTENSION_NAME,this.textureChannels={displacementTexture:index_modern_TextureChannel.R}}}DisplacementMapMaterialExtension.EXTENSION_NAME=GLTFMaterialsDisplacementMapExtensionName;class DiamondMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=DiamondMaterialExtension.EXTENSION_NAME}}DiamondMaterialExtension.EXTENSION_NAME=DiamondPlugin.DIAMOND_GLTF_EXTENSION;class AnimationMarkersExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=AnimationMarkersExtension.EXTENSION_NAME}}AnimationMarkersExtension.EXTENSION_NAME=GLTFAnimationPlugin.AnimationMarkersExtension;class AnisotropyMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=AnisotropyMaterialExtension.EXTENSION_NAME,this.textureChannels={anisotropyDirection:index_modern_TextureChannel.R|index_modern_TextureChannel.G|index_modern_TextureChannel.B}}}AnisotropyMaterialExtension.EXTENSION_NAME=AnisotropyPlugin.ANISOTROPY_GLTF_EXTENSION;class CustomBumpMapMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=CustomBumpMapMaterialExtension.EXTENSION_NAME,this.textureChannels={customBumpMap:index_modern_TextureChannel.R|index_modern_TextureChannel.G|index_modern_TextureChannel.B}}}CustomBumpMapMaterialExtension.EXTENSION_NAME=CustomBumpMapPlugin.CUSTOM_BUMP_MAP_GLTF_EXTENSION;class LightExtrasExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=LightExtrasExtension.EXTENSION_NAME}}LightExtrasExtension.EXTENSION_NAME=webgiLightExtrasExtension;class Object3DExtrasExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=Object3DExtrasExtension.EXTENSION_NAME}}Object3DExtrasExtension.EXTENSION_NAME=webgiObject3DExtrasExtension;class MaterialExtrasExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=MaterialExtrasExtension.EXTENSION_NAME}}MaterialExtrasExtension.EXTENSION_NAME=webgiMaterialExtrasExtension;class ClearcoatTintMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=ClearcoatTintMaterialExtension.EXTENSION_NAME}}ClearcoatTintMaterialExtension.EXTENSION_NAME=ClearcoatTintPlugin.CLEARCOAT_TINT_GLTF_EXTENSION;class ThinFilmLayerMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=ThinFilmLayerMaterialExtension.EXTENSION_NAME}}ThinFilmLayerMaterialExtension.EXTENSION_NAME=ThinFilmLayerPlugin.THIN_FILM_LAYER_GLTF_EXTENSION;class TriplanarMappingMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=TriplanarMappingMaterialExtension.EXTENSION_NAME}}TriplanarMappingMaterialExtension.EXTENSION_NAME=TriplanarUVMappingPlugin.TRIPLANAR_GLTF_EXTENSION;class LayeredMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=LayeredMaterialExtension.EXTENSION_NAME}}LayeredMaterialExtension.EXTENSION_NAME=LayeredMaterialPlugin.LAYERED_MATERIAL_GLTF_EXTENSION;class SSBevelMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=SSBevelMaterialExtension.EXTENSION_NAME}}SSBevelMaterialExtension.EXTENSION_NAME=SSBevelPlugin.SSBEVEL_GLTF_EXTENSION;class NoiseBumpMaterialExtension extends GenericExtension{constructor(){super(...arguments),this.extensionName=NoiseBumpMaterialExtension.EXTENSION_NAME}}NoiseBumpMaterialExtension.EXTENSION_NAME=NoiseBumpMaterialPlugin.NOISE_BUMP_MATERIAL_GLTF_EXTENSION;const ALL_WEBGI_EXTENSIONS=[WebGIViewerExtension,DiamondMaterialExtension,BumpMapMaterialExtension,LightMapMaterialExtension,AlphaMapMaterialExtension,AnimationMarkersExtension,AnisotropyMaterialExtension,CustomBumpMapMaterialExtension,LightExtrasExtension,Object3DExtrasExtension,MaterialExtrasExtension,ClearcoatTintMaterialExtension,ThinFilmLayerMaterialExtension,SSBevelMaterialExtension,TriplanarMappingMaterialExtension,NoiseBumpMaterialExtension,DisplacementMapMaterialExtension,LayeredMaterialExtension];class PMREMGeneratorPlugin extends I{constructor(){super(...arguments),this.processor={forAssetType:"texture",process:(o,l)=>o}}async onAdded(o){}async onDispose(o){}async onRemove(o){this._pmrem=void 0}}PMREMGeneratorPlugin.PluginType="PMREMGenerator";const _position=new three_module.Pq0,_quaternion=new three_module.PTz,_scale=new three_module.Pq0;class CSS3DObject extends three_module.B69{constructor(o=document.createElement("div")){super(),this.isCSS3DObject=!0,this.element=o,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.addEventListener("removed",function(){this.traverse(function(l){l.element instanceof Element&&l.element.parentNode!==null&&l.element.parentNode.removeChild(l.element)})})}copy(o,l){return super.copy(o,l),this.element=o.element.cloneNode(!0),this}}const _matrix=new three_module.kn4,_matrix2=new three_module.kn4;class CSS3DRenderer{constructor(o={}){const l=this;let c,u,h,_;const A={camera:{fov:0,style:""},objects:new WeakMap},w=o.element!==void 0?o.element:document.createElement("div");w.style.overflow="hidden",this.domElement=w;const C=document.createElement("div");C.style.transformOrigin="0 0",C.style.pointerEvents="none",w.appendChild(C);const M=document.createElement("div");function O(ye){return Math.abs(ye)<1e-10?0:ye}function ne(ye){const Oe=ye.elements;return"matrix3d("+O(Oe[0])+","+O(-Oe[1])+","+O(Oe[2])+","+O(Oe[3])+","+O(Oe[4])+","+O(-Oe[5])+","+O(Oe[6])+","+O(Oe[7])+","+O(Oe[8])+","+O(-Oe[9])+","+O(Oe[10])+","+O(Oe[11])+","+O(Oe[12])+","+O(-Oe[13])+","+O(Oe[14])+","+O(Oe[15])+")"}function ce(ye){const Oe=ye.elements;return"translate(-50%,-50%)matrix3d("+O(Oe[0])+","+O(Oe[1])+","+O(Oe[2])+","+O(Oe[3])+","+O(-Oe[4])+","+O(-Oe[5])+","+O(-Oe[6])+","+O(-Oe[7])+","+O(Oe[8])+","+O(Oe[9])+","+O(Oe[10])+","+O(Oe[11])+","+O(Oe[12])+","+O(Oe[13])+","+O(Oe[14])+","+O(Oe[15])+")"}function ue(ye,Oe,ke,Ve){if(ye.isCSS3DObject){const tt=ye.visible===!0&&ye.layers.test(ke.layers)===!0;if(ye.element.style.display=tt===!0?"":"none",tt===!0){let ht;ye.onBeforeRender(l,Oe,ke),ye.isCSS3DSprite?(_matrix.copy(ke.matrixWorldInverse),_matrix.transpose(),ye.rotation2D!==0&&_matrix.multiply(_matrix2.makeRotationZ(ye.rotation2D)),ye.matrixWorld.decompose(_position,_quaternion,_scale),_matrix.setPosition(_position),_matrix.scale(_scale),_matrix.elements[3]=0,_matrix.elements[7]=0,_matrix.elements[11]=0,_matrix.elements[15]=1,ht=ce(_matrix)):ht=ce(ye.matrixWorld);const ut=ye.element,_t=A.objects.get(ye);if(_t===void 0||_t.style!==ht){ut.style.transform=ht;const at={style:ht};A.objects.set(ye,at)}ut.parentNode!==M&&M.appendChild(ut),ye.onAfterRender(l,Oe,ke)}}for(let tt=0,ht=ye.children.length;tt<ht;tt++)ue(ye.children[tt],Oe,ke)}M.style.transformStyle="preserve-3d",C.appendChild(M),this.getSize=function(){return{width:c,height:u}},this.render=function(ye,Oe){const ke=Oe.projectionMatrix.elements[5]*_;let Ve,tt;A.camera.fov!==ke&&(C.style.perspective=Oe.isPerspectiveCamera?ke+"px":"",A.camera.fov=ke),Oe.view&&Oe.view.enabled?(C.style.transform=`translate( ${-Oe.view.offsetX*(c/Oe.view.width)}px, ${-Oe.view.offsetY*(u/Oe.view.height)}px )`,C.style.transform+=`scale( ${Oe.view.fullWidth/Oe.view.width}, ${Oe.view.fullHeight/Oe.view.height} )`):C.style.transform="",ye.matrixWorldAutoUpdate===!0&&ye.updateMatrixWorld(),Oe.parent===null&&Oe.matrixWorldAutoUpdate===!0&&Oe.updateMatrixWorld(),Oe.isOrthographicCamera&&(Ve=-(Oe.right+Oe.left)/2,tt=(Oe.top+Oe.bottom)/2);const ht=Oe.view&&Oe.view.enabled?Oe.view.height/Oe.view.fullHeight:1,ut=Oe.isOrthographicCamera?`scale( ${ht} )scale(`+ke+")translate("+O(Ve)+"px,"+O(tt)+"px)"+ne(Oe.matrixWorldInverse):`scale( ${ht} )translateZ(`+ke+"px)"+ne(Oe.matrixWorldInverse),_t=ut+"translate("+h+"px,"+_+"px)";A.camera.style!==_t&&(M.style.transform=_t,A.camera.style=_t),ue(ye,ye,Oe)},this.setSize=function(ye,Oe){c=ye,u=Oe,h=c/2,_=u/2,w.style.width=ye+"px",w.style.height=Oe+"px",C.style.width=ye+"px",C.style.height=Oe+"px",M.style.width=ye+"px",M.style.height=Oe+"px"}}}var CSS3DRendererPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let CSS3DRendererPlugin=class extends AViewerPlugin{constructor(d=!0){super(),this._scene=new three_module.Z58,this.overCanvas=!0,this._trackers=[],this.attachIFrameToSelected=async()=>{var o,l,c,u,h;const _=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();if(!(_!=null&&_.geometry))return void await((c=this._viewer)===null||c===void 0?void 0:c.alert("No Geometry: Selected object must have a geometry to apply the iframe to"));const A=await((u=this._viewer)===null||u===void 0?void 0:u.prompt("URL: Enter the url for the webpage. (Make sure its allowed to be embedded in an iframe.)","https://webgi.xyz/",!1))||"https://webgi.pixotronics.com/";if(!A)return;const w=await((h=this._viewer)===null||h===void 0?void 0:h.prompt("Width: Enter the width for the object.","512",!1))||"512";w&&this.attachIFrame(_,A,parseInt(w))},this._resizeObserver=new ResizeObserver(()=>{var o;this.enabled&&((o=this._viewer)===null||o===void 0||o.scene.setDirty({sceneUpdate:!0}))}),this.enabled=d,this._refreshCanvasInDOM=this._refreshCanvasInDOM.bind(this),this._refreshEnabled=this._refreshEnabled.bind(this)}_refreshEnabled(){}_refreshCanvasInDOM(){const d=this._viewer;d&&this._renderer&&(d.canvas.remove(),this.overCanvas?this._renderer.domElement.insertAdjacentElement("afterbegin",d.canvas):this._renderer.domElement.appendChild(d.canvas))}_initialize(){if(this._renderer||!this._viewer)return;this._renderer=new CSS3DRenderer;const d=this._viewer.renderer.rendererObject.getSize(new three_module.I9Y);this._renderer.setSize(d.width,d.height);const o=document.createElement("div");o.style.position="absolute",o.style.top="0",o.style.zIndex="0",o.appendChild(this._renderer.domElement),this._viewer.canvas.style.position="absolute",this._viewer.canvas.style.top="0",this._viewer.canvas.style.left="0",this._viewer.canvas.style.zIndex="0",this._viewer.container.appendChild(o),this._refreshCanvasInDOM(),this._viewer.renderer.addEventListener("resize",()=>{if(!this._viewer||!this._renderer)return;const l=this._viewer.renderer.rendererObject.getSize(new three_module.I9Y);this._renderer.setSize(l.width,l.height)})}async onAdded(d){await super.onAdded(d);let o=!0,l=!0;d.addEventListener("postFrame",h=>{var _,A;o&&this.enabled&&(this._renderer||this._initialize(),this._renderer&&(l&&this._trackers.forEach(w=>{var C,M;let O=!0;const ne=w.modelObj.material.side;if(ne!==three_module.$EB){const ce=new three_module.Pq0(0,0,1).applyQuaternion(w.cssObj.quaternion),ue=(M=(C=this._viewer)===null||C===void 0?void 0:C.scene.activeCamera)===null||M===void 0?void 0:M.cameraObject,ye=ce.dot(ue.getWorldDirection(new three_module.Pq0));O=ne===three_module.hsX?ye>0:ye<0}w.cssObj.element.style.visibility=O?"visible":"hidden"}),this._trackers.filter(w=>w.dirty).forEach(w=>this._syncProperties(w)),(_=this._renderer)===null||_===void 0||_.render(this._scene,(A=d.scene.activeCamera)===null||A===void 0?void 0:A.cameraObject),o=!1))}),d.addEventListener("update",h=>{this.enabled&&(o=this._trackers.length>0)}),d.scene.addEventListener("sceneUpdate",h=>{this.enabled&&(this._trackers.forEach(_=>_.dirty=!0),o=this._trackers.length>0)}),d.scene.addEventListener("activeCameraUpdate",h=>{this.enabled&&(o=this._trackers.length>0,l=!0)});let c=!1;const u=new three_module.tBo;d.container.addEventListener("mousemove",h=>{if(!this.enabled||!this._viewer||this.overCanvas)return;const _=this._viewer.canvas.getBoundingClientRect(),A=(h.clientX-_.x)/_.width*2-1,w=-(h.clientY-_.y)/_.height*2+1;u.setFromCamera({x:A,y:w},this._viewer.scene.activeCamera.cameraObject);const C=this._trackers.map(O=>O.modelObj),M=u.intersectObjects(C,!1);if(console.log(M),M.length)return this._viewer.canvas.style.pointerEvents="none",c=!0,void console.log(this._viewer.canvas.style.pointerEvents);c&&(this._viewer.canvas.style.pointerEvents="auto",c=!1)})}attachIFrame(d,o,l){const c=computeGeometrySize(d.modelObject),u=createIFrameCSS3DObject(o,l,l*c.y/c.x,()=>{var h;return(h=d.setDirty)===null||h===void 0?void 0:h.call(d)});return this.attachCSS3DObject(u,d),u}attachCSS3DObject(d,o){var l,c,u,h,_;if(this._trackers.push({cssObj:d,modelObj:o.modelObject,dirty:!0}),d.element&&(this._resizeObserver.observe(d.element),d.element.__isCSS3DObjectElement=!0,console.log(d.element,d.element.__isCSS3DObjectElement)),o.userData.__oldMaterial=o.material,!o.setMaterial)throw"model not processed?";const A=(l=this._viewer)===null||l===void 0?void 0:l.createMaterial("basic",{opacity:0,color:new three_module.Q1f("black"),blending:three_module.XIg,side:three_module.hB5});if(!A)throw"cannot create mat";A.userData.forcedLinearDepth=0,(c=o.setMaterial)===null||c===void 0||c.call(o,A),computeAverageGeometryNormal(o.modelObject),computeGeometryCenter(o.modelObject),computeGeometrySize(o.modelObject),this._scene.add(d),(h=(u=this.uiConfig)===null||u===void 0?void 0:u.uiRefresh)===null||h===void 0||h.call(u),(_=o.setDirty)===null||_===void 0||_.call(o)}_syncProperties(d){const o=d.modelObj,l=d.cssObj;o.updateMatrixWorld();const c=d.cssObj.element.clientWidth<1.5?0:(d.cssObj.element.clientWidth-1.5)/computeGeometrySize(o).x,u=computeAverageGeometryNormal(o);l.quaternion.setFromUnitVectors(new three_module.Pq0(0,0,1),u),l.position.copy(computeGeometryCenter(o)),l.scale.set(1,1,1).multiplyScalar(1/c),l.updateMatrixWorld(),l.applyMatrix4(o.matrixWorld),d.dirty=!1}async onDispose(d){return this._resizeObserver.disconnect(),super.onDispose(d)}};function createIFrameCSS3DObject(d,o,l,c){const u=document.createElement("div");u.style.width=o.toString()+"px",u.style.height=l.toString()+"px",u.style.backgroundColor="transparent";const h=document.createElement("iframe",{is:"x-frame-bypass"});h.style.width="100%",h.style.height="100%",h.style.border="0px";const _=()=>{var A,w;try{h.contentWindow.name}catch(C){(typeof C=="string"?C:(w=(A=C==null?void 0:C.toString)===null||A===void 0?void 0:A.call(C))!==null&&w!==void 0?w:"").includes("cross-origin")?console.warn("Trying to load cross-origin scripts, Install chrome extension if not able to load: https://chrome.google.com/webstore/detail/ignore-x-frame-headers/gleekbfjekiniecknbkamfmkohkpodhe"):console.error(C)}c(),h.removeEventListener("load",_)};return h.addEventListener("load",_),h.src=d,u.appendChild(h),new CSS3DObject(u)}function computeAverageGeometryNormal(d){if(d.geometry.userData.geometryNormal)return d.geometry.userData.geometryNormal;const o=d.geometry.attributes.normal,l=new three_module.Pq0,c=new three_module.Pq0;for(let u=0,h=o.count;u<h;u++)l.fromBufferAttribute(o,u),c.add(l);return c.normalize(),d.geometry.userData.geometryNormal=c,c}function computeGeometryCenter(d){if(d.geometry.userData.geometryCenter)return d.geometry.userData.geometryCenter;const o=d.geometry;if(!o)return new three_module.Pq0(0,0,0);o.boundingBox||o.computeBoundingBox();const l=o.boundingBox.getCenter(new three_module.Pq0);return d.geometry.userData.geometryCenter=l,l}function computeGeometrySize(d,o=new three_module.Pq0(0,0,1)){if(d.geometry.userData.geometrySize)return d.geometry.userData.geometrySize;const l=d.geometry;if(!l)return new three_module.Pq0(0,0,0);const c=l.clone();c.applyMatrix4(new three_module.kn4().makeRotationFromQuaternion(new three_module.PTz().setFromUnitVectors(o,computeAverageGeometryNormal(d)).invert())),c.computeBoundingBox();const u=c.boundingBox.getSize(new three_module.Pq0);return d.geometry.userData.geometrySize=u,c.dispose(),u}CSS3DRendererPlugin.PluginType="CSS3DRenderer",CSS3DRendererPlugin_decorate([uiToggle("Enabled"),x(CSS3DRendererPlugin.prototype._refreshEnabled),serialize()],CSS3DRendererPlugin.prototype,"enabled",void 0),CSS3DRendererPlugin_decorate([uiToggle("Over canvas"),x(CSS3DRendererPlugin.prototype._refreshCanvasInDOM),serialize()],CSS3DRendererPlugin.prototype,"overCanvas",void 0),CSS3DRendererPlugin_decorate([uiButton("Attach iframe")],CSS3DRendererPlugin.prototype,"attachIFrameToSelected",void 0),CSS3DRendererPlugin=CSS3DRendererPlugin_decorate([uiFolder("CSS3D Renderer")],CSS3DRendererPlugin);var outline=`uniform sampler2D outlineBuffer;uniform vec2 tDiffuseSize;uniform vec3 outlineColor;uniform float outlineThickness;uniform float outlineIntensity;uniform float highlightTransparency;uniform bool enableHighlight;uniform float dpr;float isSelected(vec2 uv){return 1.-texture2D(outlineBuffer,uv).b;}vec4 outline(in vec4 color){vec2 invSize=1./tDiffuseSize;
#if DEBUG_OUTLINE > 0
color=vec4(0.,0.,0.,1.);
#endif
vec3 finalColor=color.rgb;float c=isSelected(vUv);if(c>0.){vec4 uvOffset=1.5*dpr*outlineThickness*vec4(1.,0.,-1.,1.)*vec4(invSize,invSize);float c1=isSelected(vUv+uvOffset.xy);float c2=isSelected(vUv-uvOffset.xy);float c3=isSelected(vUv+uvOffset.yw);float c4=isSelected(vUv-uvOffset.yw);float diff1=(c1-c2)*0.5;float diff2=(c3-c4)*0.5;float d=length(vec2(diff1,diff2));vec4 highlightColor=enableHighlight?vec4(c*outlineColor,(1.-highlightTransparency)*c):vec4(0.);vec4 edgeColor=vec4(outlineColor,1.)*vec4(d);float gbufferDepth=getDepth(vUv);float outlineDepth=unpack16(texture2D(outlineBuffer,vUv).xy);outlineDepth*=outlineDepth;outlineDepth-=0.005;if(gbufferDepth<outlineDepth){highlightColor.rgb=highlightColor.rgb*0.3;edgeColor.rgb=edgeColor.rgb*0.5;}vec4 outColor=edgeColor+highlightColor*(1.-d);finalColor=mix(color.rgb,outlineIntensity*outColor.rgb,outColor.a);}else{finalColor.rgb=color.rgb;}return vec4(finalColor.rgb,color.a);}`;class OutlineRenderPass extends RenderPass{constructor(o,l,c,u=new three_module.Q1f(1,1,1),h=1){super(void 0,void 0,c,u,h),this._getSelectedObjectOrMaterial=o,this.target=l}render(o,l,c,u,h){const _=o.getRenderTarget(),A=o.getActiveCubeFace(),w=o.getActiveMipmapLevel(),C=this._getSelectedObjectOrMaterial();if(C)this._renderSelectedObject(o,C,l,u,h);else{o.setRenderTarget(this.target);const M=new three_module.Q1f;o.getClearColor(M),o.setClearColor(new three_module.Q1f(16777215)),o.clear(!0,!0),o.setClearColor(M)}o.setRenderTarget(_,A,w)}_renderSelectedObject(o,l,c,u,h){if(!this.camera)return;const _=(Array.isArray(l)?l:[l]).map(C=>C.isMaterial?[...C.userData.__appliedMeshes.values()]:C).flat();_.forEach(C=>C.traverse(M=>{M.layers.enable(6)}));const A=this.camera.layers.mask;this.camera.layers.set(6);const w=o.userData;w||console.error("threejs is not patched?"),w.transmissionRenderTarget=c,setThreeRendererMode(o,{shadowMapRender:!1,backgroundRender:!1,opaqueRender:!0,transparentRender:!0,transmissionRender:!0,mainRenderPass:!1},()=>super.render(o,c,this.target,u,h)),w.transmissionRenderTarget=void 0,_.forEach(C=>C.traverse(M=>{M.layers.disable(6)})),this.camera.layers.mask=A}}var outlineDepthVert=`#ifdef USE_ALPHAMAP
#define USE_UV 
#endif
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec3 vViewPosition;void main(){
#include <skinbase_vertex>
#include <begin_vertex>
#include <morphtarget_vertex>
#include <skinning_vertex>
#include <displacementmap_vertex>
#include <project_vertex>
#include <logdepthbuf_vertex>
#include <clipping_planes_vertex>
vViewPosition=-mvPosition.xyz;}`,outlineDepthFrag="uniform vec2 cameraNearFar;varying vec3 vViewPosition;vec2 pack16(float value){float sMax=65535.;int v=int(clamp(value,0.,1.)*sMax+0.5);int digit0=v/256;int digit1=v-digit0*256;return vec2(float(digit0)/255.,float(digit1)/255.);}float linstep(float edge0,float edge1,float value){return clamp((value-edge0)/(edge1-edge0),0.,1.);}void main(){float linearZ=linstep(-cameraNearFar.x,-cameraNearFar.y,-vViewPosition.z);vec2 packedZ=pack16(pow(max(0.,linearZ),0.5));gl_FragColor=vec4(packedZ.x,packedZ.y,0.,0.);}",OutlinePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let OutlineExtension=class{constructor(d,o){this.enabled=!0,this.enableHighlight=!1,this.enableDynamicSelection=!0,this.outlineIntensity=2,this.highlightTransparency=.84,this.outlineColor=new three_module.Q1f(15305317),this.debugOutline=!1,this.highlightSelectedMaterials=!1,this.highlightMaterialSameNames=!1,this.transparency=0,this._outlineThickness=2,this.extraUniforms={outlineIntensity:{value:1},tDiffuseSize:{value:new three_module.I9Y(1,1)},outlineThickness:{value:2},highlightTransparency:{value:1},outlineColor:{value:new three_module.Q1f(15305317)},enableHighlight:{value:!0},outlineBuffer:{value:null},dpr:{value:1}},this.extraDefines={DEBUG_OUTLINE:"0"},this.parsFragmentSnippet=(l,c)=>this.enabled?fe`
            ${unpackGbuffer}
            ${outline}
        `:"",this._combinedPostPlugin=d.getPlugin(CombinedPostPlugin),this._pickingPlugin=d.getPluginByType("Picking"),this._setDirty=this._setDirty.bind(this),o&&(this.extraUniforms.outlineBuffer.value=o.texture),this._enable()}shaderExtender(d,o,l){this.enabled&&(d.fragmentShader=shaderReplaceString(d.fragmentShader,"#glMarker",` 
            gl_FragColor = outline(gl_FragColor);
            #glMarker
        `))}getUiConfig(){return this.uiConfig}computeCacheKey(d){return this.enabled?"1":"0"}isCompatible(d){return!0}_setDirty(){this._combinedPostPlugin&&this._combinedPostPlugin.reRender(),this.extraDefines&&(this.extraDefines.DEBUG_OUTLINE=this.debugOutline?"1":"0"),this.extraUniforms&&(this.extraUniforms.outlineIntensity.value=this.outlineIntensity,this.extraUniforms.outlineColor.value.copy(this.outlineColor),this.extraUniforms.outlineThickness.value=this._outlineThickness,this.extraUniforms.enableHighlight.value=this.enableHighlight,this.extraUniforms.highlightTransparency.value=this.transparency)}setDirty(){var d;(d=this.__setDirty)===null||d===void 0||d.call(this),this._setDirty()}_enable(){var d;(d=this._pickingPlugin)===null||d===void 0||d.enableWidget(!this.enabled),this._setDirty()}};OutlineExtension.PluginType="Outline",OutlinePlugin_decorate([x(OutlineExtension.prototype._enable),uiToggle("Enable"),serialize()],OutlineExtension.prototype,"enabled",void 0),OutlinePlugin_decorate([x(OutlineExtension.prototype._setDirty),uiToggle("Highlight"),serialize()],OutlineExtension.prototype,"enableHighlight",void 0),OutlinePlugin_decorate([x(OutlineExtension.prototype._setDirty),uiToggle("DynamicSelection"),serialize()],OutlineExtension.prototype,"enableDynamicSelection",void 0),OutlinePlugin_decorate([x(OutlineExtension.prototype._setDirty),uiSlider("Intensity",[0,2],.001,{limitedUi:!0}),serialize()],OutlineExtension.prototype,"outlineIntensity",void 0),OutlinePlugin_decorate([x(OutlineExtension.prototype._setDirty),uiSlider("Transparency",[0,1],.01,{limitedUi:!0}),serialize()],OutlineExtension.prototype,"highlightTransparency",void 0),OutlinePlugin_decorate([x(OutlineExtension.prototype._setDirty),uiColor("Color"),serialize()],OutlineExtension.prototype,"outlineColor",void 0),OutlinePlugin_decorate([x(OutlineExtension.prototype._setDirty),uiToggle("Debug")],OutlineExtension.prototype,"debugOutline",void 0),OutlinePlugin_decorate([x(OutlineExtension.prototype._setDirty),uiToggle("Highlight Selected Materials")],OutlineExtension.prototype,"highlightSelectedMaterials",void 0),OutlinePlugin_decorate([x(OutlineExtension.prototype._setDirty),uiToggle("Highlight Materials (same name)")],OutlineExtension.prototype,"highlightMaterialSameNames",void 0),OutlineExtension=OutlinePlugin_decorate([uiFolder("Outline")],OutlineExtension);class OutlinePlugin extends GenericExtensionPlugin{constructor(){super(),this._state="in",this.mouseInOutAnimationEnabled=!0}generateExtension(o){return new OutlineExtension(o,this._outlineTarget)}async onAdded(o){this._outlineTarget=o.renderer.createTarget({sizeMultiplier:1}),await super.onAdded(o);const l=o==null?void 0:o.getPluginByType("Picking");l||console.error("OutlinePlugin requires PickingPlugin to be added to the viewer"),o.addEventListener("preRender",()=>{this._extension.extraUniforms.dpr.value=o.renderer.displayCanvasScaling});const c=new three_module.BKk({uniforms:{cameraNearFar:{value:new three_module.I9Y(.1,100)}},vertexShader:outlineDepthVert,fragmentShader:outlineDepthFrag,side:three_module.$EB}),u=makeFilter(o,{passId:"outline",after:["gbuffer"],before:["render"],passObject:new OutlineRenderPass(()=>{var h,_;if(!((h=this._extension)===null||h===void 0)&&h.highlightSelectedMaterials){const A=(_=l==null?void 0:l.getSelectedObject())===null||_===void 0?void 0:_.material;if(this._extension.highlightMaterialSameNames&&A){const w=Array.isArray(A)?A.map(M=>M.name):[A.name],C=new Set;return w.forEach(M=>{var O,ne;const ce=(ne=(O=o.assetManager)===null||O===void 0?void 0:O.materials)===null||ne===void 0?void 0:ne.findMaterialsByName(M);ce==null||ce.forEach(ue=>C.add(ue))}),[...C]}return A}return l==null?void 0:l.getSelectedObject()},this._outlineTarget,c),update(){o.scene.renderCamera.updateShaderProperties(this.passObject.overrideMaterial),u.passObject.scene=o.scene.modelObject,u.passObject.camera=o.scene.renderCamera.cameraObject}});o.renderer.registerPass(u),l==null||l.addEventListener("selectedObjectChanged",()=>{!this._animationCallBack&&this._extension&&(l!=null&&l.getSelectedObject()?this._extension.enableDynamicSelection?(this._extension.transparency=1,this._animationCallBack=this._startTransparencyAnimation(1,this._extension.highlightTransparency,400)):this._extension.transparency=this._extension.highlightTransparency:this._extension.transparency=1)}),document.addEventListener("mousemove",h=>{if(!this._extension||!this.mouseInOutAnimationEnabled)return;const _=l==null?void 0:l.getSelectedObject();_&&this._extension.enableDynamicSelection?h.target!==o.canvas?this._animationCallBack||this._state!=="in"||(this._animationCallBack=this._startTransparencyAnimation(this._extension.highlightTransparency,1,600),this._state="out"):this._animationCallBack||this._state!=="out"||(this._animationCallBack=this._startTransparencyAnimation(1,this._extension.highlightTransparency,600),this._state="in"):this._extension.transparency=_?this._extension.highlightTransparency:1})}async _startTransparencyAnimation(o,l,c){return animateTarget(this._extension,"transparency",{from:o,to:l,duration:c,onComplete:()=>{this._animationCallBack=null}})}}OutlinePlugin.PluginType="Outline";const RADIUS=.2,LINE_WIDTH=.03,MAX_OPACITY=.75,SEGMENTS=12,DELTA_PHI=Math.PI/(2*SEGMENTS),vector2=new three_module.I9Y,addCorner=(d,o,l)=>{let c=o>0?l>0?0:-Math.PI/2:l>0?Math.PI/2:Math.PI;for(let u=0;u<=SEGMENTS;++u)d.push(o+(RADIUS-LINE_WIDTH)*Math.cos(c),l+(RADIUS-LINE_WIDTH)*Math.sin(c),0,o+RADIUS*Math.cos(c),l+RADIUS*Math.sin(c),0),c+=DELTA_PHI},makeARBoxGeometry=(d,o)=>{const l=new three_module.LoY,c=[],u=[],h=d.getSize(new three_module.Pq0),_=h.x/2,A=(o?h.y:h.z)/2;addCorner(u,_,A),addCorner(u,-_,A),addCorner(u,-_,-A),addCorner(u,_,-A);const w=u.length/3;for(let M=0;M<w-2;M+=2)c.push(M,M+1,M+3,M,M+3,M+2);const C=w-2;return c.push(C,C+1,1,C,1,0),l.setAttribute("position",new three_module.qtW(u,3)),l.setIndex(c),l};class ARPlacementBox extends three_module.eaF{constructor(o,l,c=!1){super(makeARBoxGeometry(o,c)),this.boundingSize=new three_module.Pq0,this._raycaster=new three_module.tBo,this._camera=l,this._placeOnWall=c;const u=this.material;u.side=three_module.hB5,u.color=new three_module.Q1f(16711935),u.opacity=0,this.userData.bboxVisible=!1;const h=o.getSize(this.boundingSize),_=h.x/2,A=(c?h.y:h.z)/2;this.hitPlane=new three_module.eaF(new three_module.bdM(2*(_+RADIUS),2*(A+RADIUS))),this.hitPlane.visible=!1,this.add(this.hitPlane),o.getCenter(this.position),c?(this.shadowHeight=o.min.z,this.position.z=this.shadowHeight):(this.rotateX(-Math.PI/2),this.shadowHeight=o.min.y,this.position.y=this.shadowHeight),this.offsetHeight=0}getHit(o,l,c){vector2.set(l,-c),this.hitPlane.visible=!0;const u=this._positionAndNormalFromPoint(vector2,this.hitPlane);return this.hitPlane.visible=!1,u==null?null:u.position}getExpandedHit(o,l,c){this.hitPlane.scale.set(1e3,1e3,1e3);const u=this.getHit(o,l,c);return this.hitPlane.scale.set(1,1,1),u}set offsetHeight(o){o-=.001,this._placeOnWall?this.position.z=this.shadowHeight+o:this.position.y=this.shadowHeight+o}get offsetHeight(){return this._placeOnWall?this.position.z-this.shadowHeight:this.position.y-this.shadowHeight}set show(o){this.material.opacity=o?MAX_OPACITY:0}get show(){return this.material.opacity>.01}updateOpacity(o){const l=this.material;this.visible=l.opacity>0}dispose(){var o;const{geometry:l,material:c}=this.hitPlane;l.dispose(),c.dispose(),this.geometry.dispose(),this.material.dispose(),(o=this.parent)===null||o===void 0||o.remove(this)}_positionAndNormalFromPoint(o,l){if(!this._camera)return null;this._raycaster.setFromCamera(o,this._camera);const c=this._raycaster.intersectObject(l,!0);if(c.length===0)return null;const u=c[0];return u.face==null?null:u.uv==null?{position:u.point,normal:u.face.normal,uv:null}:(u.face.normal.applyNormalMatrix(new three_module.dwI().getNormalMatrix(u.object.matrixWorld)),{position:u.point,normal:u.face.normal,uv:u.uv})}}const ROTATION_RATE=1.5,SCALE_SNAP_HIGH=1.3,SCALE_SNAP_LOW=1/SCALE_SNAP_HIGH,MAX_DISTANCE=10,vector3=new three_module.Pq0;class ARTouchInputHelper{constructor(){this.inputSource=null,this.isTranslating=!1,this.isRotating=!1,this.isTwoFingering=!1,this.lastDragPosition=new three_module.Pq0,this.firstRatio=0,this.lastAngle=0,this.goalPosition=new three_module.Pq0,this.goalYaw=0,this.goalScale=1,this.presentedScene=null,this.placementBox=null,this.placeOnWall=!1,this.placementComplete=!1,this.xr=null,this.session=null,this._hitPosition=new three_module.Pq0,this._hitMatrix=new three_module.kn4,this.xDamper=new k,this.yDamper=new k,this.zDamper=new k,this.yawDamper=new k,this.scaleDamper=new k,this.onSelectStart=o=>{const l=this.transientHitTestSource;if(l==null)return;const c=this.frame.getHitTestResultsForTransientInput(l),u=this.presentedScene,h=this.placementBox;if(c.length===1){this.inputSource=o.inputSource;const{axes:_}=this.inputSource.gamepad||{axes:[0,0]},A=h.getHit(u,_[0],_[1]);h.show=!0,A!=null?(this.isTranslating=!0,this.lastDragPosition.copy(A),this.presentedScene&&(this.presentedScene.visible=!0)):this.placeOnWall||(this.isRotating=!0,this.lastAngle=_[0]*ROTATION_RATE)}else if(c.length===2){h.show=!0,this.isTwoFingering=!0;const{separation:_}=this.fingerPolar(c);this.firstRatio=_/u.scale.x}},this.onSelectEnd=()=>{this.isTranslating=!1,this.isRotating=!1,this.isTwoFingering=!1,this.inputSource=null,this.goalPosition.y+=this.placementBox.offsetHeight*this.presentedScene.scale.x,this.placementBox.show=!1}}async setSession(o,l,c){var u;this.transientHitTestSource=await((u=o.requestHitTestSourceForTransientInput)===null||u===void 0?void 0:u.call(o,{profile:"generic-touchscreen"})),this.presentedScene=l,this.placementBox=c,this.session=o,this.placementComplete=!1,this.goalPosition.copy(l.position),this.goalYaw=l.rotation.y,this.goalScale=l.scale.x,o.addEventListener("selectstart",this.onSelectStart),o.addEventListener("selectend",this.onSelectEnd)}cancel(){this.transientHitTestSource&&(this.transientHitTestSource.cancel(),this.transientHitTestSource=void 0),this.presentedScene=null,this.placeOnWall=!1,this.frame=void 0,this.xr=null,this.placementBox&&(this.placementBox.show=!1,this.placementBox=null),this.session&&(this.session.removeEventListener("selectstart",this.onSelectStart),this.session.removeEventListener("selectend",this.onSelectEnd),this.session=null)}getHitPoint(o){var l;const c=(l=this.xr)===null||l===void 0?void 0:l.getReferenceSpace(),u=c?o.getPose(c):null;return u?(this._hitMatrix.fromArray(u.transform.matrix),this.placeOnWall&&(this.goalYaw=Math.atan2(this._hitMatrix.elements[4],this._hitMatrix.elements[6])),this._hitMatrix.elements[5]>.75!==this.placeOnWall?this._hitPosition.setFromMatrixPosition(this._hitMatrix):null):null}moveScene(o){if(!this.session)return;const l=this.presentedScene,c=l.position,u=l.rotation.y,h=this.placementBox,_=Math.max(h.boundingSize.x,h.boundingSize.y,h.boundingSize.z)/2,A=this.goalPosition,w=l.scale.x;if(!A.equals(c)||this.goalScale!==w){let{x:C,y:M,z:O}=c;C=this.xDamper.update(C,A.x,o,_),M=this.yDamper.update(M,A.y,o,_),O=this.zDamper.update(O,A.z,o,_),c.set(C,M,O);const ne=this.scaleDamper.update(w,this.goalScale,o,1);if(l.scale.set(ne,ne,ne),!this.isTranslating){const ce=A.y-M;this.placementComplete&&!this.placeOnWall?h.offsetHeight=ce/ne:ce===0&&(this.placementComplete=!0,h.show=!1)}}h.updateOpacity(o),l.rotation.y=this.yawDamper.update(u,this.goalYaw,o,Math.PI)}processInput(o){var l;this.frame=o;const c=this.transientHitTestSource;if(!c||!this.isTranslating&&!this.isTwoFingering&&!this.isRotating)return;const u=o.getHitTestResultsForTransientInput(c),h=this.presentedScene,_=h.scale.x;if(this.isTwoFingering)if(u.length<2)this.isTwoFingering=!1;else{const{separation:A,deltaYaw:w}=this.fingerPolar(u);if(this.placeOnWall||(this.goalYaw+=w),!h.userData.__scaleDisabled){const C=A/this.firstRatio;this.goalScale=C<SCALE_SNAP_HIGH&&C>SCALE_SNAP_LOW?1:C}}else if(u.length!==2)if(this.isRotating&&(!((l=this.inputSource)===null||l===void 0)&&l.gamepad)){const A=this.inputSource.gamepad.axes[0]*ROTATION_RATE;this.goalYaw+=A-this.lastAngle,this.lastAngle=A}else this.isTranslating&&(console.log("translating"),u.forEach(A=>{if(A.inputSource!==this.inputSource)return;let w=null;if(A.results.length>0&&(w=this.getHitPoint(A.results[0])),w==null&&(w=this.getTouchLocation()),w!=null){if(this.goalPosition.sub(this.lastDragPosition),!this.placeOnWall){const C=w.y-this.lastDragPosition.y;if(C<0){this.placementBox.offsetHeight=C/_;const M=vector3.copy(this.xr.getCamera().position),O=-C/(M.y-w.y);M.multiplyScalar(O),w.multiplyScalar(1-O).add(M)}}this.goalPosition.add(w),this.lastDragPosition.copy(w)}}));else{this.isTranslating=!1,this.isRotating=!1,this.isTwoFingering=!0;const{separation:A}=this.fingerPolar(u);this.firstRatio=A/_}}getTouchLocation(){var o,l;const{axes:c}=(o=this.inputSource.gamepad)!==null&&o!==void 0?o:{axes:[0,0]},u=this.placementBox.getExpandedHit(this.presentedScene,c[0],c[1]);return u!=null&&(vector3.copy(u).sub((l=this.xr)===null||l===void 0?void 0:l.getCamera().position),vector3.length()>MAX_DISTANCE)?null:u}fingerPolar(o){var l,c,u,h,_,A;const w=(u=(c=(l=o[0].inputSource)===null||l===void 0?void 0:l.gamepad)===null||c===void 0?void 0:c.axes)!==null&&u!==void 0?u:[0,0],C=(A=(_=(h=o[1].inputSource)===null||h===void 0?void 0:h.gamepad)===null||_===void 0?void 0:_.axes)!==null&&A!==void 0?A:[0,0],M=C[0]-w[0],O=C[1]-w[1],ne=Math.atan2(O,M);let ce=this.lastAngle-ne;return ce>Math.PI?ce-=2*Math.PI:ce<-Math.PI&&(ce+=2*Math.PI),this.lastAngle=ne,{separation:Math.sqrt(M*M+O*O),deltaYaw:ce}}}class SessionLightProbe{constructor(o,l,c,u,h){this.xrLight=o,this.renderer=l,this.lightProbe=c,this.xrWebGLBinding=null,this.estimationStartCallback=h,this.frameCallback=this.onXRFrame.bind(this);const _=l.xr.getSession();if(u&&"XRWebGLBinding"in window){const A=new three_module.o6l(16);o.environment=A.texture;const w=l.getContext();switch(_.preferredReflectionFormat){case"srgba8":w.getExtension("EXT_sRGB");break;case"rgba16f":w.getExtension("OES_texture_half_float")}this.xrWebGLBinding=new XRWebGLBinding(_,w),this.lightProbe.addEventListener("reflectionchange",()=>{this.updateReflection()})}_.requestAnimationFrame(this.frameCallback)}updateReflection(){const o=this.renderer.properties.get(this.xrLight.environment);if(o){const l=this.xrWebGLBinding.getReflectionCubeMap(this.lightProbe);l&&(o.__webglTexture=l,this.xrLight.environment.needsPMREMUpdate=!0)}}onXRFrame(o,l){if(!this.xrLight)return;l.session.requestAnimationFrame(this.frameCallback);const c=l.getLightEstimate(this.lightProbe);if(c){this.xrLight.lightProbe.sh.fromArray(c.sphericalHarmonicsCoefficients),this.xrLight.lightProbe.intensity=1;const u=Math.max(1,Math.max(c.primaryLightIntensity.x,Math.max(c.primaryLightIntensity.y,c.primaryLightIntensity.z)));this.xrLight.directionalLight.color.setRGB(c.primaryLightIntensity.x/u,c.primaryLightIntensity.y/u,c.primaryLightIntensity.z/u),this.xrLight.directionalLight.intensity=u,this.xrLight.directionalLight.position.copy(c.primaryLightDirection),this.estimationStartCallback&&(this.estimationStartCallback(),this.estimationStartCallback=null)}}dispose(){this.xrLight=null,this.renderer=null,this.lightProbe=null,this.xrWebGLBinding=null}}class XREstimatedLight extends three_module.YJl{constructor(o,l=!0){super(),this.lightProbe=new three_module.FZo,this.lightProbe.intensity=0,this.add(this.lightProbe),this.directionalLight=new three_module.ZyN,this.directionalLight.intensity=0,this.add(this.directionalLight),this.environment=null;let c=null,u=!1;o.xr.addEventListener("sessionstart",()=>{const h=o.xr.getSession();"requestLightProbe"in h&&h.requestLightProbe({reflectionFormat:h.preferredReflectionFormat}).then(_=>{c=new SessionLightProbe(this,o,_,l,()=>{u=!0,this.dispatchEvent({type:"estimationstart"})})})}),o.xr.addEventListener("sessionend",()=>{c&&(c.dispose(),c=null),u&&this.dispatchEvent({type:"estimationend"})}),this.dispose=()=>{c&&(c.dispose(),c=null),this.remove(this.lightProbe),this.lightProbe=null,this.remove(this.directionalLight),this.directionalLight=null,this.environment=null}}}var ARPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},ARPlugin_1;const HIT_ANGLE_DEG=20;let ARPlugin=ARPlugin_1=class extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this._touchInputHelper=new ARTouchInputHelper,this.dependencies=[GBufferPlugin],this.estimateLighting=!1,this.placeOnWall=!1,this.xrResolutionScale=1,this.toJSON=void 0,this.enterAR=()=>{var d;this.enabled&&this._viewer&&(navigator&&navigator.xr?this._xrSession?console.warn("Already in AR"):this._xrManager?(this._xrManager.enabled=!0,(d=this._xrManager)===null||d===void 0||d.setFramebufferScaleFactor(this.xrResolutionScale),navigator.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test"],optionalFeatures:["dom-overlay","light-estimation"],domOverlay:this.domOverlay}).then(this._onSessionStarted)):console.error("XR manager not found"):console.error("XR not supported"))},this.exitAR=()=>{this._xrSession&&this._xrSession.end()},this._preRender=()=>{var d;if(!(this._dirty&&this._viewer&&this._xrManager&&this._xrSession))return;this._viewer.renderer.defaultRenderToScreen=!1,this._xrManager.enabled=!1;const o=this._xrManager.getCamera(),l=((d=o.cameras)===null||d===void 0?void 0:d[0])||o,c=this._viewer.scene.activeCamera;c.cameraObject.projectionMatrix.copy(l.projectionMatrix),c.cameraObject.projectionMatrixInverse.copy(c.cameraObject.projectionMatrix).invert()},this._postRender=()=>{var d,o;if(!this._dirty||!this._viewer||!this._xrSession)return;this._viewer.scene.activeCamera.cameraObject.updateProjectionMatrix();const l=this._viewer.renderer,c=(o=(d=this._xrManager)===null||d===void 0?void 0:d.getCamera())===null||o===void 0?void 0:o.cameras[0].viewport;c?l.rendererObject.setViewport(c):console.warn("no viewport for ar camera"),this._viewer.getPlugin(GBufferPlugin).updateShaderProperties(arCopyPass.material),arCopyPass.uniforms.tTransparentMap.value=this._viewer.renderFilter.passObject.transparentTarget.texture,setThreeRendererMode(l.rendererObject,{sceneRender:!0,opaqueRender:!0,shadowMapRender:!1,backgroundRender:!1,transparentRender:!1,transmissionRender:!1,screenSpaceRendering:!1},()=>{arCopyPass.render(l.rendererObject,null,l.composer.readBuffer,0,!1)}),this._xrManager.enabled=!0,this._viewer.renderer.defaultRenderToScreen=!0},this._frameCount=0,this._isPresenting=!1,this._interactionsDisabled=!1,this._preFrame=({xrFrame:d,deltaTime:o})=>{var l,c;if(this.dirty=!!d&&((l=this._xrManager)===null||l===void 0?void 0:l.isPresenting)||!1,(this._dirty||this._interactionsDisabled)&&(this._viewer.scene.activeCamera.setInteractions(!this._dirty,ARPlugin_1.PluginType),this._viewer.scene.activeCamera.autoLookAtTarget=!this._dirty,this._interactionsDisabled=this._dirty),!this._dirty||!d)return void(this._isPresenting&&this._xrRenderingEnd());if(!this._xrSession)return console.error("no xr session found, shouldn't happen"),void(this.dirty=!1);this._isPresenting||console.log("webxr: AR session init"),this._frameCount++;const u=this._xrManager.getReferenceSpace(),h=d.getViewerPose(u);if(h==null&&this._frameCount,h==null||((c=this._viewer)===null||c===void 0?void 0:c.scene.modelRoot.children.length)===0)return this.dirty=!1,void console.warn("no pose or no model");this._isPresenting||(this._isPresenting=!0,this._frameCount=0,this._savePreXRState(),this._preSetupModel(),this._xrRenderingBegin());const _=this._viewer.scene.activeCamera;this._xrManager.updateCamera(_.cameraObject),_.setDirty(),this.moveToFloor(d),this._touchInputHelper.processInput(d),this._touchInputHelper.moveScene(o),this._updateShadow()},this._preXRState={viewerBg:null,viewerBgColor:void 0,modelScale:new three_module.Pq0(1,1,1),modelPosition:new three_module.Pq0,modelRotation:new three_module.PTz,cameraPosition:new three_module.Pq0(0,0,5),cameraTarget:new three_module.Pq0,cameraUp:new three_module.Pq0(0,1,0),cameraAspect:1,cameraFov:50,cameraZoom:1,cameraNear:.01,cameraFar:100,cameraProjectionMatrix:new three_module.kn4,cameraAutoNearFar:void 0,groundOffset:new three_module.Pq0,groundScale:1,groundRotation:0,groundRenderToDepth:!1,groundShadowBaker:!1,viewport:new three_module.I9Y,environment:void 0,preserveTransparentTarget:!0},this._savePreXRState=()=>{var d;if(!this._viewer)return;this._preXRState.viewport.copy(this._viewer.renderer.renderSize),this._preXRState.viewerBg=this._viewer.scene.background,this._preXRState.viewerBgColor=(d=this._viewer.scene.backgroundColor)===null||d===void 0?void 0:d.getHex();const o=this._viewer.scene.modelRoot,l=this._viewer.scene.activeCamera;o.updateMatrix(),o.updateMatrixWorld(!0),this._preXRState.modelScale.copy(o.scale),this._preXRState.modelPosition.copy(o.position),this._preXRState.modelRotation.copy(o.quaternion),this._preXRState.cameraPosition.copy(l.position),this._preXRState.cameraTarget.copy(l.target),this._preXRState.cameraUp.copy(l.cameraObject.up),l.cameraObject.isPerspectiveCamera&&(this._preXRState.cameraFov=l.cameraObject.fov,this._preXRState.cameraAspect=l.cameraObject.aspect),this._preXRState.cameraZoom=l.cameraObject.zoom,this._preXRState.cameraNear=l.cameraObject.near,this._preXRState.cameraFar=l.cameraObject.far,this._preXRState.cameraAutoNearFar=l.cameraObject.userData.autoNearFar,this._preXRState.cameraProjectionMatrix.copy(l.cameraObject.projectionMatrix);const c=this._viewer.getPluginByType("Ground");c!=null&&c.mesh&&(this._preXRState.groundOffset.subVectors(o.position,c.mesh.modelObject.position),this._preXRState.groundScale=c.mesh.modelObject.scale.x,this._preXRState.groundRotation=c.mesh.modelObject.rotation.z,this._preXRState.groundRenderToDepth=c.renderToDepth,this._preXRState.groundShadowBaker=c.shadowBaker.enabled),this._preXRState.environment||(this._preXRState.environment=this._viewer.scene.getEnvironment()),this._preXRState.preserveTransparentTarget=this._viewer.renderFilter.passObject.preserveTransparentTarget},this._xrRenderingBegin=()=>{if(!this._xrSession||!this._viewer)return;console.log("webxr: AR session start");const d=HIT_ANGLE_DEG*Math.PI/180,o=this.placeOnWall?void 0:new window.XRRay(new DOMPoint(0,0,0),{x:0,y:-Math.sin(d),z:-Math.cos(d)});this._viewer.renderer.useTotalFrameCount=!0,this._viewer.resize(),(async()=>{var l,c;if(this._xrSession){this._touchInputHelper.placeOnWall=this.placeOnWall,await this._touchInputHelper.setSession(this._xrSession,this._viewer.scene.modelRoot,this._placementBox);const u=await this._xrSession.requestReferenceSpace("viewer");this._hitTestSource=await((c=(l=this._xrSession).requestHitTestSource)===null||c===void 0?void 0:c.call(l,{space:u,offsetRay:o}))}})()},this._xrRenderingEnd=()=>{console.log("webxr: AR session end"),this._xrManager&&(this._xrManager.enabled=!1),this._isPresenting=!1,this._frameCount=0,this._xrSession=void 0,this._removePlacementBox(),this._cancelHitSources(),this._viewer&&(this._viewer.renderer.stableNoise=!1),this._restorePreXRState()},this._onSessionStarted=async d=>{d.addEventListener("end",this._onSessionEnded),this.estimateLighting&&(this._xrLight=new XREstimatedLight(this._viewer.renderer.rendererObject),this._xrLight.addEventListener("estimationstart",()=>{this._xrSession&&this._xrLight&&(this._viewer.scene.modelRoot.add(this._xrLight),this._preXRState.environment||(this._preXRState.environment=this._viewer.scene.getEnvironment()),this._viewer.scene.setEnvironment(this._xrLight.environment))})),this._xrManager.setReferenceSpaceType("local"),await this._xrManager.setSession(d),this._xrSession=d},this._onSessionEnded=()=>{this._xrSession&&(this._xrSession.removeEventListener("end",this._onSessionEnded),this._xrLight&&(this._xrLight.removeFromParent(),this._xrLight.dispose(),this._xrLight=void 0))}}async onAdded(d){await super.onAdded(d);const o=d.renderer.rendererObject.xr;if(o.cameraAutoUpdate=!1,this._xrManager=o,this._touchInputHelper.xr=o,!this.domOverlay){const l=document.getElementById("tweakpaneUiContainer");this.domOverlay=l?{root:l}:void 0}if(d.addEventListener("preRender",this._preRender),d.addEventListener("postRender",this._postRender),d.addEventListener("preFrame",this._preFrame),!window.isSecureContext)return d.console.error("XR not supported in insecure context, try https://"),void(this.enabled=!1);navigator&&"xr"in navigator&&navigator.xr?navigator.xr.isSessionSupported("immersive-ar").then(l=>{if(!l)throw new Error("AR not supported")}).catch(l=>{d.console.error("AR not supported:",l),o.enabled=!1,this.enabled=!1}):(o.enabled=!1,this.enabled=!1)}_updateShadow(){var d,o;if(!this._viewer)return;const l=this._viewer.scene.modelRoot,c=(o=(d=this._viewer.getPluginByType("Ground"))===null||d===void 0?void 0:d.mesh)===null||o===void 0?void 0:o.modelObject;c&&(c.rotation.z=this._viewer.scene.modelRoot.rotation.y,c.position.copy(this._preXRState.groundOffset).multiplyScalar(l.modelObject.scale.x).sub(l.modelObject.position).negate(),c.scale.setScalar(l.modelObject.scale.x*this._preXRState.groundScale))}moveToFloor(d){if(!this._dirty||!this._hitTestSource||!this._xrManager)return;const o=d.getHitTestResults(this._hitTestSource);if(!o.length)return;const l=o[0];this._touchInputHelper.placeOnWall=this.placeOnWall;const c=this._touchInputHelper.getHitPoint(l);if(!c)return;this._placementBox.show=!0;const u=this._viewer.scene.modelRoot;this._touchInputHelper.goalPosition.copy(c),u.position.copy(c),this._viewer.scene.modelRoot.visible=!0,this._hitTestSource.cancel(),this._hitTestSource=void 0}_removePlacementBox(){this._placementBox&&(this._placementBox.removeFromParent(),this._placementBox=void 0)}_preSetupModel(){var d,o;const l=this._viewer.scene.modelRoot,c=this._viewer.scene.activeCamera,u=(d=this._xrManager)===null||d===void 0?void 0:d.getCamera(),h=u.cameras[0]||u;this._removePlacementBox();const _=this._viewer.scene.getBounds(!0,!0);_.getSize(new three_module.Pq0).length()>.01&&(this._placementBox=new ARPlacementBox(_,u,this.placeOnWall),l.add(this._placementBox),this._placementBox.show=!1);const A=u.getWorldDirection(new three_module.Pq0);l.rotation.y=Math.atan2(-A.x,-A.z)-0,c.cameraObject.zoom=h.zoom,c.cameraObject.near=h.near,c.cameraObject.far=h.far,c.cameraObject.userData.autoNearFar=!1,c.cameraObject.isPerspectiveCamera?(c.cameraObject.fov=h.fov,c.cameraObject.aspect=h.viewport.width/h.viewport.height):console.warn("Perspective camera required."),c.cameraObject.updateProjectionMatrix();const w=l.userData.arScale||1;l.scale.set(w,w,w),l.position.copy(u.position).add(A.multiplyScalar(5)),l.visible=!0;const C=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("Ground");C!=null&&C.mesh&&(C.shadowBaker.enabled=!1,C.renderToDepth=!1)}_restorePreXRState(){var d;if(!this._viewer)return;this._viewer.renderer.rendererObject.setSize(this._preXRState.viewport.x,this._preXRState.viewport.y),this._viewer.resize(),this._viewer.scene.activeCamera.setInteractions(!0,ARPlugin_1.PluginType),this._viewer.scene.activeCamera.autoLookAtTarget=!0,this._viewer.scene.background=this._preXRState.viewerBg,this._preXRState.viewerBgColor!==void 0&&((d=this._viewer.scene.backgroundColor)===null||d===void 0||d.set(this._preXRState.viewerBgColor)),this._preXRState.viewerBg=null;const o=this._viewer.scene.modelRoot;o.scale.copy(this._preXRState.modelScale),o.position.copy(this._preXRState.modelPosition),o.quaternion.copy(this._preXRState.modelRotation),o.updateMatrix(),o.updateMatrixWorld(!0),o.visible=!0;const l=this._viewer.scene.activeCamera;l.position.copy(this._preXRState.cameraPosition),l.target.copy(this._preXRState.cameraTarget),l.cameraObject.up.copy(this._preXRState.cameraUp),l.cameraObject.near=this._preXRState.cameraNear,l.cameraObject.far=this._preXRState.cameraFar,l.cameraObject.userData.autoNearFar=this._preXRState.cameraAutoNearFar,l.cameraObject.isPerspectiveCamera&&(this._preXRState.cameraFov!==void 0&&(l.cameraObject.fov=this._preXRState.cameraFov),this._preXRState.cameraAspect!==void 0&&(l.cameraObject.aspect=this._preXRState.cameraAspect)),l.positionUpdated(!1),l.targetUpdated(!0),l.cameraObject.projectionMatrix.copy(this._preXRState.cameraProjectionMatrix),l.cameraObject.projectionMatrixInverse.copy(this._preXRState.cameraProjectionMatrix).invert(),l.cameraObject.updateMatrixWorld(!0),l.cameraObject.updateProjectionMatrix();const c=this._viewer.getPluginByType("Ground");c!=null&&c.mesh&&(c.mesh.modelObject.position.subVectors(o.position,this._preXRState.groundOffset),c.mesh.modelObject.scale.setScalar(this._preXRState.groundScale),c.mesh.modelObject.rotation.z=this._preXRState.groundRotation,c.renderToDepth=this._preXRState.groundRenderToDepth,c.shadowBaker.enabled=this._preXRState.groundShadowBaker,c.refreshTransform()),this._viewer.scene.setEnvironment(this._preXRState.environment),this._preXRState.environment=void 0,this._viewer.renderFilter.passObject.preserveTransparentTarget=this._preXRState.preserveTransparentTarget}_cancelHitSources(){this._hitTestSource&&(this._hitTestSource.cancel(),this._hitTestSource=void 0),this._touchInputHelper.cancel()}};ARPlugin.PluginType="WEBXR_ARPlugin",ARPlugin_decorate([uiToggle("Light Estimate")],ARPlugin.prototype,"estimateLighting",void 0),ARPlugin_decorate([uiToggle("Place on Wall")],ARPlugin.prototype,"placeOnWall",void 0),ARPlugin_decorate([uiSlider("Resilution scale",[.1,1],.1)],ARPlugin.prototype,"xrResolutionScale",void 0),ARPlugin_decorate([uiButton("Enter AR")],ARPlugin.prototype,"enterAR",void 0),ARPlugin_decorate([uiButton("Exit AR")],ARPlugin.prototype,"exitAR",void 0),ARPlugin=ARPlugin_1=ARPlugin_decorate([uiFolder("WebXR AR")],ARPlugin);const arCopyPass=new ShaderPass2({vertexShader:CopyShader.vertexShader,fragmentShader:`
        ${unpackGbuffer}
        
        uniform float opacity;

		uniform sampler2D tDiffuse;
		uniform sampler2D tTransparentMap;

		varying vec2 vUv;

		void main() {
		
            float depth = getDepth(vUv);
            vec4 texel;
            if(depth>0.9999) {
			    texel = texture2D( tTransparentMap, vUv );
                if(texel.a < 0.01) discard; // background
                // transparent objects with render to depth = false
            }else {
                texel = texture2D( tDiffuse, vUv );
			}
            gl_FragColor = texel;
            
		}
		`,uniforms:{...CopyShader.uniforms,tNormalDepth:{value:null},tTransparentMap:{value:null}}});arCopyPass.renderToScreen=!1,arCopyPass.useExistingRenderTarget=!0,arCopyPass.clear=!1;var VRPluginBasic_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},VRPluginBasic_1;let VRPluginBasic=VRPluginBasic_1=class extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.dependencies=[GBufferPlugin],this.xrResolutionScale=1,this.toJSON=void 0,this.enterVR=()=>{var d;this.enabled&&this._viewer&&(navigator&&navigator.xr?this._xrSession?console.warn("Already inVR"):this._xrManager?(this._xrManager.enabled=!0,(d=this._xrManager)===null||d===void 0||d.setFramebufferScaleFactor(this.xrResolutionScale),navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]}).then(this._onSessionStarted)):console.error("XR manager not found"):console.error("XR not supported"))},this.exitVR=()=>{this._xrSession&&this._xrSession.end()},this._currentCameraIndex=0,this._preRender=()=>{var d;if(!(this._dirty&&this._viewer&&this._xrManager&&this._xrSession))return;this._viewer.renderer.defaultRenderToScreen=!1,this._xrManager.enabled=!1;const o=this._xrManager.getCamera(),l=((d=o.cameras)===null||d===void 0?void 0:d[this._currentCameraIndex])||o,c=this._viewer.scene.activeCamera;c.cameraObject.zoom=l.zoom,c.cameraObject.near=l.near,c.cameraObject.far=l.far,c.cameraObject.userData.autoNearFar=!1,c.cameraObject.isPerspectiveCamera?(c.cameraObject.fov=l.fov,c.cameraObject.aspect=l.viewport.width/l.viewport.height):console.warn("Perspective camera required."),c.cameraObject.position.copy(l.position),c.cameraObject.rotation.copy(l.rotation),c.cameraObject.updateMatrix(),c.cameraObject.updateProjectionMatrix(),c.cameraObject.projectionMatrix.copy(l.projectionMatrix),c.cameraObject.projectionMatrixInverse.copy(c.cameraObject.projectionMatrix).invert()},this._currentRt=null,this._postRender=()=>{var d,o,l,c;if(!this._dirty||!this._viewer||!this._xrSession)return;this._viewer.scene.activeCamera.cameraObject.updateProjectionMatrix();const u=this._viewer.renderer,h=(u.rendererObject.getViewport(new three_module.IUQ),(l=(o=(d=this._xrManager)===null||d===void 0?void 0:d.getCamera())===null||o===void 0?void 0:o.cameras)!==null&&l!==void 0?l:[]),_=u.rendererObject.getRenderTarget(),A=(c=h[this._currentCameraIndex])===null||c===void 0?void 0:c.viewport;A?_&&u.rendererObject.setViewport(A):console.warn("no viewport for vr camera index",this._currentCameraIndex),this._viewer.getPlugin(GBufferPlugin).updateShaderProperties(VRPluginBasic_arCopyPass.material),VRPluginBasic_arCopyPass.uniforms.tTransparentMap.value=this._viewer.renderFilter.passObject.transparentTarget.texture,setThreeRendererMode(u.rendererObject,{sceneRender:!0,opaqueRender:!0,shadowMapRender:!1,backgroundRender:!1,transparentRender:!1,transmissionRender:!1,screenSpaceRendering:!1},()=>{VRPluginBasic_arCopyPass.render(u.rendererObject,null,u.composer.readBuffer,0,!1)}),this._xrManager.enabled=!0,this._viewer.renderer.defaultRenderToScreen=!0,_&&u.rendererObject.setViewport(_.viewport),this._currentCameraIndex++,this._currentCameraIndex>=h.length&&(this._currentCameraIndex=0)},this._frameCount=0,this._isPresenting=!1,this._interactionsDisabled=!1,this._preFrame=({xrFrame:d,deltaTime:o})=>{var l,c;if(this.dirty=!!d&&((l=this._xrManager)===null||l===void 0?void 0:l.isPresenting)||!1,(this._dirty||this._interactionsDisabled)&&(this._viewer.scene.activeCamera.setInteractions(!this._dirty,VRPluginBasic_1.PluginType),this._viewer.scene.activeCamera.autoLookAtTarget=!this._dirty,this._interactionsDisabled=this._dirty),!this._dirty||!d)return void(this._isPresenting&&this._xrRenderingEnd());if(!this._xrSession)return console.error("no xr session found, shouldn't happen"),void(this.dirty=!1);this._isPresenting||console.log("webxr: VR session init"),this._frameCount++;const u=this._xrManager.getReferenceSpace(),h=d.getViewerPose(u);if(h==null&&this._frameCount,h==null||((c=this._viewer)===null||c===void 0?void 0:c.scene.modelRoot.children.length)===0)return this.dirty=!1,void console.warn("no pose or no model");this._isPresenting||(this._isPresenting=!0,this._frameCount=0,this._savePreXRState(),this._preSetupModel(),this._xrRenderingBegin());const _=this._viewer.scene.activeCamera;this._xrManager.updateCamera(_.cameraObject),_.setDirty(),this._viewer.rendersPerFrame=h?h.views.length:1,this._updateShadow()},this._preXRState={viewerBg:null,viewerBgColor:void 0,modelScale:new three_module.Pq0(1,1,1),modelPosition:new three_module.Pq0,modelRotation:new three_module.PTz,cameraPosition:new three_module.Pq0(0,0,5),cameraTarget:new three_module.Pq0,cameraUp:new three_module.Pq0(0,1,0),cameraAspect:1,cameraFov:50,cameraZoom:1,cameraNear:.01,cameraFar:100,cameraProjectioMatrix:new three_module.kn4,cameraAutoNearFar:void 0,groundOffset:new three_module.Pq0,groundScale:1,groundRotation:0,groundRenderToDepth:!1,groundShadowBaker:!1,viewport:new three_module.I9Y,environment:void 0,preserveTransparentTarget:!0},this._savePreXRState=()=>{var d;if(!this._viewer)return;this._preXRState.viewport.copy(this._viewer.renderer.renderSize),this._preXRState.viewerBg=this._viewer.scene.background,this._preXRState.viewerBgColor=(d=this._viewer.scene.backgroundColor)===null||d===void 0?void 0:d.getHex();const o=this._viewer.scene.modelRoot,l=this._viewer.scene.activeCamera;o.updateMatrix(),o.updateMatrixWorld(!0),this._preXRState.modelScale.copy(o.scale),this._preXRState.modelPosition.copy(o.position),this._preXRState.modelRotation.copy(o.quaternion),this._preXRState.cameraPosition.copy(l.position),this._preXRState.cameraTarget.copy(l.target),this._preXRState.cameraUp.copy(l.cameraObject.up),l.cameraObject.isPerspectiveCamera&&(this._preXRState.cameraFov=l.cameraObject.fov,this._preXRState.cameraAspect=l.cameraObject.aspect),this._preXRState.cameraZoom=l.cameraObject.zoom,this._preXRState.cameraNear=l.cameraObject.near,this._preXRState.cameraFar=l.cameraObject.far,this._preXRState.cameraAutoNearFar=l.cameraObject.userData.autoNearFar,this._preXRState.cameraProjectioMatrix.copy(l.cameraObject.projectionMatrix);const c=this._viewer.getPluginByType("Ground");c!=null&&c.mesh&&(this._preXRState.groundOffset.subVectors(o.position,c.mesh.modelObject.position),this._preXRState.groundScale=c.mesh.modelObject.scale.x,this._preXRState.groundRotation=c.mesh.modelObject.rotation.z,this._preXRState.groundRenderToDepth=c.renderToDepth,this._preXRState.groundShadowBaker=c.shadowBaker.enabled),this._preXRState.environment||(this._preXRState.environment=this._viewer.scene.environment),this._preXRState.preserveTransparentTarget=this._viewer.renderFilter.passObject.preserveTransparentTarget},this._xrRenderingBegin=()=>{this._xrSession&&this._viewer&&(console.log("webxr: VR session start"),this._viewer.renderer.stableNoise=!0,this._viewer.resize())},this._xrRenderingEnd=()=>{console.log("webxr: VR session end"),this._xrManager&&(this._xrManager.enabled=!1),this._isPresenting=!1,this._frameCount=0,this._xrSession=void 0,this._cancelHitSources(),this._viewer&&(this._viewer.renderer.stableNoise=!1),this._restorePreXRState()},this._onSessionStarted=async d=>{d.addEventListener("end",this._onSessionEnded),this._xrManager.setReferenceSpaceType("local"),await this._xrManager.setSession(d),this._xrSession=d},this._onSessionEnded=()=>{this._xrSession&&this._xrSession.removeEventListener("end",this._onSessionEnded)}}async onAdded(d){await super.onAdded(d);const o=d.renderer.rendererObject.xr;if(o.cameraAutoUpdate=!1,this._xrManager=o,!this.domOverlay){const l=document.getElementById("tweakpaneUiContainer");this.domOverlay=l?{root:l}:void 0}if(d.addEventListener("preRender",this._preRender),d.addEventListener("postRender",this._postRender),d.addEventListener("preFrame",this._preFrame),!window.isSecureContext)return d.console.error("XR not supported in insecure context, try https://"),void(this.enabled=!1);navigator&&"xr"in navigator&&navigator.xr?navigator.xr.isSessionSupported("immersive-vr").then(l=>{if(!l)throw new Error("VR not supported")}).catch(l=>{d.console.error("VR not supported:",l),o.enabled=!1,this.enabled=!1}):(o.enabled=!1,this.enabled=!1)}_updateShadow(){var d,o;if(!this._viewer)return;const l=this._viewer.scene.modelRoot,c=(o=(d=this._viewer.getPluginByType("Ground"))===null||d===void 0?void 0:d.mesh)===null||o===void 0?void 0:o.modelObject;c&&(c.rotation.z=this._viewer.scene.modelRoot.rotation.y,c.position.copy(this._preXRState.groundOffset).multiplyScalar(l.modelObject.scale.x).sub(l.modelObject.position).negate(),c.scale.setScalar(l.modelObject.scale.x*this._preXRState.groundScale))}_preSetupModel(){var d;const o=this._viewer.scene.modelRoot,l=o.userData.arScale||1;o.scale.set(l,l,l),o.visible=!0;const c=(d=this._viewer)===null||d===void 0?void 0:d.getPluginByType("Ground");c!=null&&c.mesh&&(c.shadowBaker.enabled=!1,c.renderToDepth=!1)}_restorePreXRState(){var d;if(!this._viewer)return;this._viewer.renderer.rendererObject.setSize(this._preXRState.viewport.x,this._preXRState.viewport.y),this._viewer.resize(),this._viewer.scene.activeCamera.setInteractions(!0,VRPluginBasic_1.PluginType),this._viewer.scene.activeCamera.autoLookAtTarget=!0,this._viewer.scene.background=this._preXRState.viewerBg,this._preXRState.viewerBgColor!==void 0&&((d=this._viewer.scene.backgroundColor)===null||d===void 0||d.set(this._preXRState.viewerBgColor)),this._preXRState.viewerBg=null;const o=this._viewer.scene.modelRoot;o.scale.copy(this._preXRState.modelScale),o.position.copy(this._preXRState.modelPosition),o.quaternion.copy(this._preXRState.modelRotation),o.updateMatrix(),o.updateMatrixWorld(!0),o.visible=!0;const l=this._viewer.scene.activeCamera;l.position.copy(this._preXRState.cameraPosition),l.target.copy(this._preXRState.cameraTarget),l.cameraObject.up.copy(this._preXRState.cameraUp),l.cameraObject.near=this._preXRState.cameraNear,l.cameraObject.far=this._preXRState.cameraFar,l.cameraObject.userData.autoNearFar=this._preXRState.cameraAutoNearFar,l.cameraObject.isPerspectiveCamera&&(this._preXRState.cameraFov!==void 0&&(l.cameraObject.fov=this._preXRState.cameraFov),this._preXRState.cameraAspect!==void 0&&(l.cameraObject.aspect=this._preXRState.cameraAspect)),l.positionUpdated(!1),l.targetUpdated(!0),l.cameraObject.projectionMatrix.copy(this._preXRState.cameraProjectioMatrix),l.cameraObject.projectionMatrixInverse.copy(this._preXRState.cameraProjectioMatrix).invert(),l.cameraObject.updateMatrixWorld(!0),l.cameraObject.updateProjectionMatrix();const c=this._viewer.getPluginByType("Ground");c!=null&&c.mesh&&(c.mesh.modelObject.position.subVectors(o.position,this._preXRState.groundOffset),c.mesh.modelObject.scale.setScalar(this._preXRState.groundScale),c.mesh.modelObject.rotation.z=this._preXRState.groundRotation,c.renderToDepth=this._preXRState.groundRenderToDepth,c.shadowBaker.enabled=this._preXRState.groundShadowBaker,c.refreshTransform()),this._viewer.scene.environment=this._preXRState.environment,this._preXRState.environment=void 0,this._viewer.renderFilter.passObject.preserveTransparentTarget=this._preXRState.preserveTransparentTarget}_cancelHitSources(){}};VRPluginBasic.PluginType="WEBXR_VRPluginBasic",VRPluginBasic_decorate([uiSlider("Resolution scale",[.1,1],.1)],VRPluginBasic.prototype,"xrResolutionScale",void 0),VRPluginBasic_decorate([uiButton("Enter VR")],VRPluginBasic.prototype,"enterVR",void 0),VRPluginBasic_decorate([uiButton("Exit VR")],VRPluginBasic.prototype,"exitVR",void 0),VRPluginBasic=VRPluginBasic_1=VRPluginBasic_decorate([uiFolder("WebXR VR")],VRPluginBasic);const VRPluginBasic_arCopyPass=new ShaderPass2({vertexShader:CopyShader.vertexShader,fragmentShader:`
        ${unpackGbuffer}
        
        uniform float opacity;

		uniform sampler2D tDiffuse;
		uniform sampler2D tTransparentMap;

		varying vec2 vUv;

		void main() {
		
            float depth = getDepth(vUv);
            vec4 texel;
            if(depth>0.9999) {
			    texel = texture2D( tTransparentMap, vUv );
                if(texel.a < 0.01) discard; // background
                // transparent objects with render to depth = false
            }else {
                texel = texture2D( tDiffuse, vUv );
			}
            gl_FragColor = texel;
            
		}
		`,uniforms:{...CopyShader.uniforms,tNormalDepth:{value:null},tTransparentMap:{value:null}}});VRPluginBasic_arCopyPass.renderToScreen=!1,VRPluginBasic_arCopyPass.useExistingRenderTarget=!0,VRPluginBasic_arCopyPass.clear=!1;class ACanvasRecorder extends I{get state(){return this._state}setState(o,l){this._state=o,this.dispatchEvent({type:o,...l})}_setOptions(o){Object.assign(this.options,o)}setOptions(o){this._setOptions(o)}constructor(o,l){super(),this._state="stopped",this._console=console,this._currentRecording=[],this._frameCount=0,this._ondataavailable=c=>{c.data&&c.data.size>0&&this._currentRecording.push(c.data)},this._canvas=o,l==null||l.mimeType,this.options={mimeType:"auto",frameRate:30,stepMode:!1},this._setOptions(l||this.options)}isRecording(){return this._state==="recording"}requestFrame(){return this._state==="recording"&&(this._frameCount++,!0)}dispose(){(this.isRecording()||this._state==="paused")&&this.stop(o=>{this._console.warn("disposed with blob",o),this.dispose()})}}class ImageSequenceRecorder extends ACanvasRecorder{constructor(){super(...arguments),this._currentImages=[],this._onstop=o=>{this._currentImages.length>0&&(this._writeImages([...this._currentImages]),this._currentImages=[]),this.setState("stopped")},this._onerror=o=>{this.setState("error",{error:o}),this._console.error(o)}}start(){if(this.state!=="recording"){if(this.state==="error"&&this._console.warn("Resetting from error state."),this.state==="paused")return this.setState("starting"),void this.setState("recording");this._currentRecording=[],this._currentImages=[],this._frameCount=0,this.setState("starting"),window&&window.showDirectoryPicker&&window.showDirectoryPicker().then(async o=>{const l=await(o==null?void 0:o.getDirectoryHandle("i-"+Math.floor(Date.now()),{create:!0}));this._imgDirectory=l,this._frameCount=0,this.setState("recording")}).catch(o=>{this._onerror({detail:o})})}else this._console.log("Already recording canvas")}requestFrame(){if(!super.requestFrame())return!1;const o=this.options.mimeType;return this._canvas.toBlob(l=>{this._currentImages.push(["frame_"+String(this._frameCount).padStart(5,"0")+(o.includes("png")?".png":".jpg"),l])},o,90),this._currentImages.length>60&&(this._writeImages([...this._currentImages]),this._currentImages=[]),!0}pause(){this.state!=="paused"&&this.state!=="stopped"&&this.setState("paused")}stop(o){this.state!=="stopped"&&(this.state!=="error"?(this._recordingCallback=o,this.setState("stopping"),this._onstop({})):this._console.error("Recorder in error state, cannot stop, call start again."))}async _writeImages(o){if(!this._imgDirectory)return;const l=[];for(const c of o){const u=await this._imgDirectory.getFileHandle(c[0],{create:!0});l.push($e(u,c[1]))}await Promise.all(l)}}class CanvasMediaRecorder extends ACanvasRecorder{_setOptions(o){var l,c;super._setOptions(o),this.options.mimeType&&this.options.mimeType!=="auto"||(this.options.mimeType=(l=CanvasMediaRecorder.GetSupportedMimeTypes([],["h264"],!0))!==null&&l!==void 0?l:CanvasMediaRecorder.GetSupportedMimeTypes(void 0,void 0,!0)),this.options.mimeType&&!(!((c=this.options.mimeType)===null||c===void 0)&&c.startsWith("video/"))||window.MediaRecorder||(this._console.warn("MediaRecorder is not supported, switching to png"),this.options.mimeType="image/png"),this.options.mimeType||console.warn(new Error("No supported mimetype found"))}setOptions(o){this._setOptions(o)}constructor(o,l){super(o,l),this._resumeSyncTime=0,this._onstop=c=>{var u;if(this._recorder&&this._currentRecording.length>0){const h=new Blob(this._currentRecording,{type:this.options.mimeType});(u=this._recordingCallback)===null||u===void 0||u.call(this,h)}this._recorder=void 0,this.setState("stopped")},this._onstart=c=>{var u;this._frameCount=0,this.options.stepMode&&((u=this._recorder)===null||u===void 0||u.pause()),this.setState("recording")},this._onresume=c=>{if(this.state!=="paused"&&this.state!=="starting"&&this.state!=="stopped"||this.setState("recording"),!this.options.stepMode)return;const u=()=>{var _;this.state==="recording"&&((_=this._recorder)===null||_===void 0||_.pause())},h=Math.min(this._resumeSyncTime-g(),0)+1e3/this.options.frameRate;h>0?X(h).then(u):u()},this._onerror=c=>{this.setState("error",{error:c}),this._console.error(c),this._recorder=void 0}}start(){var o,l,c;if(this.state==="recording")return void this._console.log("Already recording canvas");if(this.state==="error"&&(this._recorder=void 0,this._console.warn("Resetting from error state.")),this._recorder)return this.state==="paused"?(this.setState("starting"),void this._recorder.resume()):void this._console.warn("Canvas recorder unknown state",this.state);const u={mimeType:this.options.mimeType,videoBitsPerSecond:this.options.videoBitsPerSecond};if(this._currentRecording=[],this._frameCount=0,(o=u.mimeType)===null||o===void 0?void 0:o.startsWith("video")){if(!window.MediaRecorder)return this._console.error("MediaRecorder not supported, use image sequence"),void this.setState("error",{error:new Error("MediaRecorder not supported")});{const h=this._canvas.captureStream(this.options.stepMode?0:this.options.frameRate),_=(l=h.getVideoTracks())===null||l===void 0?void 0:l[0];this._track=_,this._recorder=new window.MediaRecorder(h,u),this._recorder.onstop=this._onstop,this._recorder.ondataavailable=this._ondataavailable,this._recorder.onerror=this._onerror,this._recorder.onresume=this._onresume,this._recorder.onstart=this._onstart}}this.setState("starting"),this._recorder&&((c=this._recorder)===null||c===void 0||c.start())}requestFrame(){return!(!this._recorder||!super.requestFrame()||this._track&&this.options.stepMode&&(this._resumeSyncTime=g(),this._track.requestFrame(),this._recorder.resume(),0))}pause(){this.state!=="paused"&&this.state!=="stopped"&&(this.options.stepMode?console.error("Pause not supported in stepMode"):this._recorder&&(this._recorder.pause(),this.setState("paused")))}stop(o){this.state!=="stopped"&&(this.state!=="error"?(this._recordingCallback=o,this.setState("stopping"),this._recorder&&this._recorder.stop()):this._console.error("Recorder in error state, cannot stop, call start again."))}dispose(){this._recorder&&(super.dispose(),this._recorder=void 0)}static GetSupportedMimeTypes(o,l,c=!1){if(!window.MediaRecorder)return c?void 0:[];const u=["webm","ogg","mp4","x-matroska"].filter(A=>!o||o.length<1||o.includes(A)),h=["vp9","vp9.0","vp8","vp8.0","avc1","av1","h265","h.265","h264","h.264","opus"].filter(A=>!l||l.length<1||l.includes(A)),_=[];return u.forEach(A=>{const w=`video/${A}`;h.forEach(C=>{[`${w};codecs=${C}`,`${w};codecs:${C}`,`${w};codecs=${C.toUpperCase()}`,`${w};codecs:${C.toUpperCase()}`,`${w}`].forEach(M=>{MediaRecorder.isTypeSupported(M)&&_.push(M)})})}),c?_.length>0?_[0]:void 0:_}}class FFMPEGRecorder extends ACanvasRecorder{constructor(o,l){super(o,l),this._workerRunning=!1,this.ffmpegOptions={imageType:"jpeg",bitrate:"10M",crf:17,pixFmt:"yuv420p",preset:"ultrafast",colorTrc:"bt709",colorSpace:"bt709"},this.worker=new Worker(ct(FFMPEGRecorder.LIBRARY_PATH+"ffmpeg-worker-mp4.js",FFMPEGRecorder.LIBRARY_PATH+"ffmpeg-worker-mp4.wasm")),this.worker.onmessage=c=>{var u;const h=c.data;switch(h.type){case"stdout":case"stderr":if(h.data.indexOf("frame=")===0){const _=parseInt(h.data.split("frame=")[1].split("fps")[0].trim()),A=this._frameCount,w=Math.round(_/A*100);this.dispatchEvent({type:"encode-progress",progress:w,frame:_,totalFrames:A})}console.log(h.data+`
`);break;case"exit":console.log("Process exited with code "+h.data),parseInt(h.data);break;case"done":if(h.data.MEMFS[0].data===void 0)return void console.log("video processing failed");this._workerRunning=!1,(u=this._recordingCallback)===null||u===void 0||u.call(this,new Blob([h.data.MEMFS[0].data],{type:"video/mp4"})),console.timeEnd("ffmpeg-record"),this.setState("stopped")}}}start(){this.state!=="recording"?(this.state==="error"&&console.warn("Resetting from error state."),this.state!=="paused"&&(this._frameCount=0),this.setState("starting"),this.setState("recording")):console.log("Already recording canvas")}stop(o){this.state!=="stopped"&&(this.state!=="error"?(this._recordingCallback=o,this.setState("stopping"),this._lastCanvasCapturePromise?this._lastCanvasCapturePromise.then(()=>this._onStop()):this._onStop()):console.error("FFMPEGRecorder: Recorder in error state, cannot stop, call start again."))}_onStop(){var o,l,c,u;const h=this._canvas.width%2==0?this._canvas.width:this._canvas.width-1;this._workerRunning=!0,console.time("ffmpeg-record");const _=this.options.frameRate.toString(),A=this.options.frameRate.toString(),w=["-r",_,"-an","-i",`img%06d.${this._mime}`,"-frames:v",this._frameCount.toString(),"-c:v","libx264","-crf",Math.min(28,Math.max(1,(o=this.ffmpegOptions.crf)!==null&&o!==void 0?o:17)).toString(),"-filter:v",`scale=${h}:-2`,"-pix_fmt",(l=this.ffmpegOptions.pixFmt)!==null&&l!==void 0?l:"yuv420p","-b:v",(c=this.ffmpegOptions.bitrate)!==null&&c!==void 0?c:"10M","-preset",(u=this.ffmpegOptions.preset)!==null&&u!==void 0?u:"ultrafast","-r",A];this.ffmpegOptions.colorSpace&&w.push("-colorspace",this.ffmpegOptions.colorSpace),this.ffmpegOptions.colorTrc&&w.push("-color_trc",this.ffmpegOptions.colorTrc),w.push("out.mp4"),console.log(w),this.worker.postMessage({type:"run",arguments:w})}requestFrame(){return!!super.requestFrame()&&(this.sendBlobToWorker(this._frameCount-1),!0)}get _mime(){var o;let l=(o=this.ffmpegOptions.imageType)!==null&&o!==void 0?o:"jpeg";return l&&["png","jpeg","webp"].includes(l)||(console.warn("FFMPEGRecorder: Unsupported mime type",this.ffmpegOptions.imageType),l="jpeg"),l}sendBlobToWorker(o){this._lastCanvasCapturePromise&&console.warn("FFMPEGRecorder: Previous frame capture not complete",o-1);const l=this._mime;this._lastCanvasCapturePromise=new Promise(c=>{this._canvas.toBlob(u=>{this.worker.postMessage({type:"image",file:{name:`img${o.toString().padStart(6,"0")}.${l}`,data:u}}),this._lastCanvasCapturePromise=void 0,c()},`image/${l}`,90)})}pad(o,l){return(o+="").length>=l?o:new Array(l-o.length+1).join("0")+o}pause(){this.state!=="paused"&&this.state!=="stopped"&&this.setState("paused")}setOptions(o){super.setOptions(o)}}FFMPEGRecorder.LIBRARY_PATH="https://cdn.jsdelivr.net/npm/@repalash/ffmpeg.js@4.2.9005/dist/";var CanvasRecorderPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class CanvasRecorderPlugin extends AViewerPlugin{get recorder(){return this._recorder}constructor(){super(),this.enabled=!0,this.convergeMode=!0,this.mimeType="video/mp4",this.videoFrameRate=30,this._recorders={},this._renderToScreenDisabled=!1,this._preRender=()=>{var o,l,c;if(this.convergeMode&&(!((o=this._recorder)===null||o===void 0)&&o.isRecording())){const u=this._viewer.renderer.composer.renderToScreen;this._viewer.renderer.composer.renderToScreen=((c=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("Progressive"))===null||c===void 0?void 0:c.isConverged())||!1,u&&!this._viewer.renderer.composer.renderToScreen&&(this._renderToScreenDisabled=!0)}},this._postRender=()=>{var o,l,c;if(!((o=this._recorder)===null||o===void 0)&&o.isRecording()&&(!this.convergeMode||!((c=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("Progressive"))===null||c===void 0)&&c.isConverged(!0))){const u=()=>{var h;return(h=this._recorder)===null||h===void 0?void 0:h.requestFrame()};this.convergeMode?X(1).then(u):u()}this._renderToScreenDisabled&&(this._viewer.renderer.composer.renderToScreen=!0)},this._refreshUi=()=>{var o;(o=this.uiConfig.children)===null||o===void 0||o.map(l=>Ee(l)).flat(2).forEach(l=>{var c;return(c=l==null?void 0:l.uiRefresh)===null||c===void 0?void 0:c.call(l)})},this.endPaddingMs=500,this._turntableAnimationAngle=360,this._turntableAnimationDuration=5,this._turntableAnimationEasing="linear",this.uiConfig={type:"folder",label:"Video Export",children:[{type:"slider",label:"Frame Rate",bounds:[1,60],stepSize:1,property:[this,"videoFrameRate"]},{type:"checkbox",property:[this,"convergeMode"],onChange:()=>{var o,l;return(l=(o=this.uiConfig).uiRefresh)===null||l===void 0?void 0:l.call(o,"postFrame",!0)}},{type:"dropdown",label:"Mime type",property:[this,"mimeType"],children:[["Auto Video (x264)","auto"],["PNG sequence","image/png"],["JPEG sequence","image/jpeg"],["WEBP sequence","image/webp"],["MP4 Video (ffmpeg)","video/mp4"]].map(o=>({label:o[0],value:o[1]}))},generateUiFolder("FFmpeg Options (Advanced)",()=>this._recorder.ffmpegOptions,{},"folder",!0),{type:"input",disabled:!0,label:"State",getValue:()=>{var o,l;return(l=(o=this.recorder)===null||o===void 0?void 0:o.state)!==null&&l!==void 0?l:"not initialized"}},{type:"button",label:()=>this.isRecording()?"Stop Recording":"Start Recording",hidden:()=>!this.isRecording()&&this.convergeMode,value:()=>{this.isRecording()?this.stopRecording().then(async o=>{if(o){const l=o.type.split(";")[0].split("/").pop()||"mp4";await this._downloadBlob(o,l)}}):this.startRecording()}},{type:"button",label:"Record Camera Views",hidden:()=>{var o;return this.isRecording()||!(!((o=this._viewer)===null||o===void 0)&&o.getPluginByType("CameraViews"))},value:()=>{var o,l;(l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("CameraViews"))===null||l===void 0||l.recordAllViews()}},{type:"button",label:"Record Camera Views + GLTF Anim",hidden:()=>{var o,l,c;return this.isRecording()||!(!((o=this._viewer)===null||o===void 0)&&o.getPluginByType("CameraViews"))||!(!((c=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("GLTFAnimation"))===null||c===void 0)&&c.animations.length)},value:()=>{var o,l,c,u;const h=((l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("GLTFAnimation"))===null||l===void 0?void 0:l.animationState)==="playing";(u=(c=this._viewer)===null||c===void 0?void 0:c.getPluginByType("CameraViews"))===null||u===void 0||u.recordAllViews(()=>{var _,A;(A=(_=this._viewer)===null||_===void 0?void 0:_.getPluginByType("GLTFAnimation"))===null||A===void 0||A.playAnimation()}).then(()=>{var _,A;h||(A=(_=this._viewer)===null||_===void 0?void 0:_.getPluginByType("GLTFAnimation"))===null||A===void 0||A.stopAnimation()})}},{type:"button",label:"Record GLTF Anim",hidden:()=>{var o,l;return this.isRecording()||!(!((l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("GLTFAnimation"))===null||l===void 0)&&l.animations.length)},value:async()=>{var o;if(this.isRecording())return;const l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("GLTFAnimation");if(!l)return;let c=!1;l.loopAnimations&&(c=!0),c&&(l.loopAnimations=!1);const u=await this.record(async()=>l.playAnimation());if(c&&(l.loopAnimations=!0),u){const h=u.type.split(";")[0].split("/").pop()||"mp4";await this._downloadBlob(u,h)}}},{type:"number",label:"Turntable animation angle",disabled:()=>this.isRecording(),property:[this,"_turntableAnimationAngle"]},{type:"number",label:"Turntable animation time (sec)",disabled:()=>this.isRecording(),property:[this,"_turntableAnimationDuration"]},{type:"dropdown",label:"Turntable animation ease",children:Object.keys(EasingFunctions$1).map(o=>({label:o})),disabled:()=>this.isRecording(),property:[this,"_turntableAnimationEasing"]},{type:"button",label:"Record turntable animation",hidden:()=>this.isRecording(),value:async()=>this.download360Recording(this._turntableAnimationDuration,!1,this._turntableAnimationAngle,EasingFunctions$1[this._turntableAnimationEasing])},{type:"button",label:"Record turntable animation (CCW)",hidden:()=>this.isRecording(),value:async()=>this.download360Recording(this._turntableAnimationDuration,!0,this._turntableAnimationAngle,EasingFunctions$1[this._turntableAnimationEasing])},{type:"number",label:"After recording wait time (ms)",disabled:()=>this.isRecording(),property:[this,"endPaddingMs"]}]},this.refreshRecorderOptions=this.refreshRecorderOptions.bind(this)}isRecording(){var o,l;return(l=(o=this._recorder)===null||o===void 0?void 0:o.isRecording())!==null&&l!==void 0&&l}refreshRecorderOptions(){var o,l;if(!this._viewer)return;let c="image";this.mimeType==="video/mp4"?c="ffmpeg.js":this.mimeType==="auto"?c="canvas-media":this.mimeType.startsWith("image")&&(c="image"),this._recorder=this._getRecorder(c),this._recorder&&(this._recorder.setOptions({frameRate:this.videoFrameRate,mimeType:this.mimeType,stepMode:this.convergeMode,internalMimeType:this.internalMimeType}),(l=(o=this.uiConfig).uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0))}async onAdded(o){var l;await super.onAdded(o),o.addEventListener("preRender",this._preRender),o.addEventListener("postRender",this._postRender),o.scene.addEventListener("addSceneObject",this._refreshUi),this._recordIndicator=document.createElement("div"),this._recordIndicator.style.width="20px",this._recordIndicator.style.height="20px",this._recordIndicator.style.backgroundColor="red",this._recordIndicator.style.top="10px",this._recordIndicator.style.left="10px",this._recordIndicator.style.position="absolute",this._recordIndicator.style.borderRadius="100%",this._recordIndicator.style.visibility="hidden",(l=o.canvas.parentElement)===null||l===void 0||l.appendChild(this._recordIndicator),this.refreshRecorderOptions()}_stateChange(o){var l,c;this.dirty=o,(l=this._viewer)===null||l===void 0||l.setDirty(),(c=this.uiConfig.children)===null||c===void 0||c.map(u=>Ee(u)).flat(2).forEach(u=>{var h;return(h=u==null?void 0:u.uiRefresh)===null||h===void 0?void 0:h.call(u)})}async onRemove(o){var l;return o.removeEventListener("preRender",this._preRender),o.removeEventListener("preRender",this._postRender),o.scene.removeEventListener("addSceneObject",this._refreshUi),(l=this._recorder)===null||l===void 0||l.dispose(),Object.values(this._recorders).forEach(c=>{c==null||c.dispose()}),super.onRemove(o)}async record(o,l){var c,u;if(!this.enabled||!((c=this._recorder)===null||c===void 0)&&c.isRecording())return;const h=(u=this._viewer)===null||u===void 0?void 0:u.getPluginByType("Progressive"),_=h==null?void 0:h.maxFrameCount;h&&this.convergeMode&&(h.maxFrameCount=Math.min(16,_??16)),await new Promise((w,C)=>{const M=()=>{this.removeEventListener("start",O),this.removeEventListener("stop",M),this.removeEventListener("error",ne)},O=async()=>{M(),l==null||l(),await o(),w()},ne=async()=>{M(),C()};this.addEventListener("start",O),this.addEventListener("stop",M),this.addEventListener("error",ne),this.startRecording()});const A=await this.stopRecording();return h&&this.convergeMode&&(h.maxFrameCount=_??16),A}startRecording(){var o;return!!this.enabled&&((o=this.recorder)===null||o===void 0?void 0:o.isRecording())===!1&&(this.recorder.options.stepMode=this.convergeMode,this.recorder.start(),!0)}async stopRecording(){var o,l;if(!((o=this.recorder)===null||o===void 0)&&o.isRecording()&&this._viewer){if(await this._viewer.doOnce("postFrame"),this.convergeMode){const c=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("Progressive");if(c)for(let h=0;h<10&&!c.isConverged(!0);h++)await this._viewer.doOnce("postFrame")}return this.endPaddingMs&&await X(this.endPaddingMs),new Promise((c,u)=>{var h;return(h=this.recorder)===null||h===void 0?void 0:h.stop(c)})}}async _downloadBlob(o,l){var c,u,h;const _=await((c=this._viewer)===null||c===void 0?void 0:c.prompt("Canvas Recorder: Save file as","recording.mp4",!1)),A=(u=this._viewer)===null||u===void 0?void 0:u.getPluginByType("FileTransferPlugin");A?await A.exportFile(o,_||"recording.mp4"):(h=this._viewer)===null||h===void 0||h.console.error("FileTransferPlugin required to export/download file")}async download360Recording(o=null,l=!1,c=360,u){var h;if(!((h=this.recorder)===null||h===void 0)&&h.isRecording()||!this._viewer)return;const _=o||await this._viewer.prompt("Enter duration in seconds","5",!0);if(_===null)return;const A=parseFloat(_||"5");if(!isFinite(A)||A<=0)return;const w=await this.recordCamera360(A,l,c,u);if(w){const C=w.type.split(";")[0].split("/").pop()||"mp4";await this._downloadBlob(w,C)}}async recordCamera360(o,l=!1,c=360,u){var h;if(!((h=this.recorder)===null||h===void 0)&&h.isRecording()||!this._viewer)return;const _=this._viewer.scene.activeCamera;let A=_.interactionsEnabled,w=0;for(;!(A||(this._viewer.setDirty(),await this._viewer.doOnce("postFrame"),w%30==0&&this._viewer.console.warn("CanvasRecorderPlugin: interactions are already disabled by something, waiting..."),A=_.interactionsEnabled,w>5e3/30));)w++;_.setInteractions(!1,CanvasRecorderPlugin.PluginType);const C=_.target.clone(),M=_.position.clone().sub(C),O=await this._viewer.getPluginByType("PopmotionPlugin");if(!O)return void console.error("Popmotion plugin not found");const ne=new three_module.YHV().setFromVector3(M);_.position.setFromSpherical(ne).add(C),_.positionUpdated(!0);const ce=_.autoLookAtTarget;_.autoLookAtTarget=!0;const ue=ne.theta,ye=await this.record(async()=>O.animate({from:ue,to:ue+(l?-1:1)*c*Math.PI/180,duration:1e3*o,ease:u??EasingFunctions$1.linear,onUpdate:Oe=>{ne.theta=Oe,_.position.setFromSpherical(ne).add(C),_.positionUpdated(!0)},onComplete:async()=>{ne.theta=ue,_.position.setFromSpherical(ne).add(C),_.positionUpdated(!0)}}).promise);return _.autoLookAtTarget=ce,_.position.copy(M).add(C),_.positionUpdated(!0),_.setInteractions(!0,CanvasRecorderPlugin.PluginType),ye}_getRecorder(o){if(!this._viewer)throw new Error("No viewer");if(this._recorders[o])return this._recorders[o];let l;return l=o==="canvas-media"?new CanvasMediaRecorder(this._viewer.canvas,{frameRate:this.videoFrameRate,mimeType:this.mimeType}):o==="ffmpeg.js"?new FFMPEGRecorder(this._viewer.canvas,{frameRate:this.videoFrameRate,mimeType:this.mimeType}):new ImageSequenceRecorder(this._viewer.canvas,{frameRate:this.videoFrameRate,mimeType:this.mimeType}),l.addEventListener("starting",()=>this._stateChange(!1)),l.addEventListener("recording",()=>{this._recordIndicator.style.visibility="visible",this._recordIndicator.style.backgroundColor="red",this.dispatchEvent({type:"start"}),this._stateChange(!this.convergeMode)}),l.addEventListener("error",()=>{this.dispatchEvent({type:"error"})}),l.addEventListener("paused",()=>this._stateChange(!1)),l.addEventListener("stopped",()=>{this._recordIndicator.style.visibility="hidden",this.dispatchEvent({type:"stop"}),this._stateChange(!1)}),l.addEventListener("encode-progress",c=>{this.dispatchEvent({...c})}),this._recorders[o]=l,l}}function isSafari(){return navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}CanvasRecorderPlugin.PluginType="CanvasRecorder",CanvasRecorderPlugin_decorate([x(CanvasRecorderPlugin.prototype.refreshRecorderOptions),serialize()],CanvasRecorderPlugin.prototype,"convergeMode",void 0),CanvasRecorderPlugin_decorate([x(CanvasRecorderPlugin.prototype.refreshRecorderOptions),serialize()],CanvasRecorderPlugin.prototype,"mimeType",void 0),CanvasRecorderPlugin_decorate([x(CanvasRecorderPlugin.prototype.refreshRecorderOptions),serialize()],CanvasRecorderPlugin.prototype,"videoFrameRate",void 0),CanvasRecorderPlugin_decorate([uiSlider("End padding (MS)",[0,1e3],1)],CanvasRecorderPlugin.prototype,"endPaddingMs",void 0);class CanvasSnipper{static async GetClonedCanvas(o,{rect:l={x:0,y:0,width:o.width,height:o.height,assumeClientRect:!1,normalized:!1},displayPixelRatio:c=1,scale:u=1}){var h,_,A;l={...l};const w=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");l.normalized?(l.x=Math.floor(l.x*o.width),l.y=Math.floor(l.y*o.height),l.width=Math.floor(l.width*o.width),l.height=Math.floor(l.height*o.height),l.assumeClientRect&&console.warn("CanvasSnipper: rect.assumeClientRect is ignored when rect is normalized")):l.assumeClientRect&&(l.x=Math.floor(l.x*o.width/(c*o.clientWidth)),l.y=Math.floor(l.y*o.height/(c*o.clientHeight)),l.width=Math.floor(l.width*o.width/(c*o.clientWidth)),l.height=Math.floor(l.height*o.height/(c*o.clientHeight))),w.width=Math.floor(l.width*u*c),w.height=Math.floor(l.height*u*c);const C=w.getContext("2d");if(!C)return console.error("snapshot: cannot create context"),w;const M=o.style.background||((h=o.parentElement)===null||h===void 0?void 0:h.style.background)||"";if(M.includes("url")){const O=(_=/url\("(.*)"\)/gi.exec(M))===null||_===void 0?void 0:_[1];if(O){const ne=new Image;ne.src=O,await new Promise((ce,ue)=>{ne.onload=()=>ce(),ne.onerror=()=>ue(),ne.complete&&ce()}),C.drawImage(ne,Math.floor(ne.width*l.x*c/o.width),Math.floor(ne.height*l.y*c/o.height),Math.floor(ne.width*l.width*c/o.width),Math.floor(ne.height*l.height*c/o.height),0,0,w.width,w.height)}}else C.fillStyle=o.style.background||((A=o.parentElement)===null||A===void 0?void 0:A.style.backgroundColor)||"#00000000",C.fillRect(0,0,w.width,w.height);return C==null||C.drawImage(o,Math.floor(l.x*c),Math.floor(l.y*c),Math.floor(l.width*c),Math.floor(l.height*c),0,0,w.width,w.height),this.Debug&&(document.body.appendChild(w),w.style.position="absolute",w.style.top="0",w.style.left="0",w.style.borderWidth="2px",w.style.borderColor="#ff00ff",setTimeout(()=>w.remove(),5e3)),w}static async GetDataUrl(o,{mimeType:l="image/png",...c}){const u=isSafari()||c.cloneCanvas||c.rect||c.scale||c.displayPixelRatio;!u&&(c.rect||c.scale||c.displayPixelRatio)&&console.warn("rect, scale and displayPixelRatio are ignored when cloneCanvas is false");const h=u?await this.GetClonedCanvas(o,c):o,_=h.toDataURL(l);return this.Debug||h===o||h.remove(),_}static async GetImage(o,{mimeType:l="image/png",...c}={}){const u=await this.GetDataUrl(o,c);return new Promise((h,_)=>{const A=new Image;A.onload=()=>{h(A)},A.src=u})}static async GetBlob(o,l={}){const c=isSafari()||l.cloneCanvas||l.rect||l.scale||l.displayPixelRatio;!c&&(l.rect||l.scale||l.displayPixelRatio)&&console.warn("rect, scale and displayPixelRatio are ignored when cloneCanvas is false");const u=c?await this.GetClonedCanvas(o,l):o,h=await new Promise((_,A)=>{var w;u.toBlob(C=>{C?_(C):A("Unable to export")},(w=l.mimeType)!==null&&w!==void 0?w:"image/png")});return this.Debug||u===o||u.remove(),h}static async GetFile(o,l="image",c={}){var u,h,_;const A=l+"."+((h=(u=c.mimeType)===null||u===void 0?void 0:u.split("/")[1])!==null&&h!==void 0?h:"png");return c.getDataUrl?await this.GetDataUrl(o,c):new File([await this.GetBlob(o,c)],A,{type:(_=c.mimeType)!==null&&_!==void 0?_:"image/png",lastModified:g()})}static async GetTiledFiles(o,l="image",c=2,u=2,h={}){var _,A,w;const C=(_=h.rect)!==null&&_!==void 0?_:{x:0,y:0,width:1,height:1,assumeClientRect:!1,normalized:!0},M=[];for(let O=0;O<u;O++)for(let ne=0;ne<c;ne++){const ce=(w=(A=h.mimeType)===null||A===void 0?void 0:A.split("/")[1])!==null&&w!==void 0?w:"png",ue=await this.GetFile(o,`${l}_${O}_${ne}.${ce}`,{rect:{x:C.x+O*C.width/u,y:C.y+ne*C.height/c,width:C.width/u,height:C.height/c,assumeClientRect:C.assumeClientRect,normalized:C.normalized}}).catch(ye=>(console.error(`Error exporting file ${O}, ${ne}`,ye),null));ue&&M.push(ue)}return M}}CanvasSnipper.Debug=!1;var CanvasSnipperPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},CanvasSnipperPlugin_1;let CanvasSnipperPlugin=CanvasSnipperPlugin_1=class extends AViewerPlugin{constructor(){super(),this.enabled=!0,this.filename="snapshot",this.progressiveFrames=64,this.tileRows=1,this.tileColumns=1,this.rect=new three_module.IUQ(0,0,1,1),this._downloading=!1,this.downloadSnapshot=this.downloadSnapshot.bind(this)}async getFile(d,o={waitForProgressive:!0}){return o.getDataUrl=!1,await this._getFile(d||this.filename,o)}async getDataUrl(d={}){var o;return d.getDataUrl=!0,(o=await this._getFile("",d))!==null&&o!==void 0?o:""}async _getFile(d,o={}){var l,c,u,h,_,A,w,C,M,O,ne,ce;const ue=(l=this._viewer)===null||l===void 0?void 0:l.canvas;if(ue){(c=this.viewer)===null||c===void 0||c.scene.activeCamera.setInteractions(!1,CanvasSnipperPlugin_1.PluginType);const ye=this._viewer.renderer.displayCanvasScaling;o.displayPixelRatio!==void 0&&o.displayPixelRatio!==ye&&(this._viewer.renderer.displayCanvasScaling=o.displayPixelRatio);const Oe=(u=this._viewer)===null||u===void 0?void 0:u.getPlugin(ProgressivePlugin);let ke=(h=o.waitForProgressive)!==null&&h!==void 0?h:!!Oe;ke&&!Oe&&(console.warn("CanvasSnipperPlugin: ProgressivePlugin required to wait for progressive rendering"),ke=!1),o.progressiveFrames&&!ke&&console.warn("CanvasSnipperPlugin: waitForProgressive must be true to use progressiveFrames");const Ve=Oe==null?void 0:Oe.maxFrameCount;if(ke&&Oe)for(Oe.maxFrameCount=Math.max((_=o.progressiveFrames)!==null&&_!==void 0?_:64,Oe.maxFrameCount),(A=this.viewer)===null||A===void 0||A.setDirty(),await((w=this.viewer)===null||w===void 0?void 0:w.doOnce("postFrame"));!Oe.isConverged(!0);)await((C=this.viewer)===null||C===void 0?void 0:C.doOnce("postFrame"));let tt;if(!o.timeout&&ke||((M=this.viewer)===null||M===void 0||M.setDirty(),await((O=this.viewer)===null||O===void 0?void 0:O.doOnce("postFrame")),await X((ne=o.timeout)!==null&&ne!==void 0?ne:200)),o.displayPixelRatio=1,o.tileRows&&o.tileRows>1||o.tileColumns&&o.tileColumns>1){const ht=await CanvasSnipper.GetTiledFiles(ue,d,Math.max(1,o.tileRows||1),Math.max(1,o.tileColumns||1),o);if(Array.isArray(ht))if(ht.length===1)tt=ht[0];else if(ht.length===0)tt=void 0;else if(o.getDataUrl)tt=ht;else{const ut={};for(const at of ht)ut[at.name]=new Uint8Array(await at.arrayBuffer());const _t=zipSync(ut);tt=new File([_t],d+".zip",{type:"application/zip",lastModified:Date.now()})}else tt=ht}else tt=await CanvasSnipper.GetFile(ue,d,o);return o.displayPixelRatio=this._viewer.renderer.displayCanvasScaling,this._viewer.renderer.displayCanvasScaling=ye,Oe&&Ve!==void 0&&(Oe.maxFrameCount=Ve),(ce=this.viewer)===null||ce===void 0||ce.scene.activeCamera.setInteractions(!0,CanvasSnipperPlugin_1.PluginType),tt}}async downloadSnapshot(d,o){for(;this._downloading;)console.warn("CanvasSnipperPlugin: Another rendering already in progress, waiting..."),await X(200);this._downloading=!0;const l=await this.getFile(d,{progressiveFrames:this.progressiveFrames,waitForProgressive:!0,tileRows:this.tileRows,tileColumns:this.tileColumns,rect:{x:this.rect.x,y:this.rect.y,width:this.rect.z,height:this.rect.w,normalized:!0,assumeClientRect:!1},...o}).catch(c=>{var u;return(u=this._viewer)===null||u===void 0||u.console.error("Error exporting file",c),null});l&&await this._downloadBlob(l,l.name),this._downloading=!1}async _downloadJpeg(){return this.downloadSnapshot(void 0,{mimeType:"image/jpeg"})}async _downloadWebp(){return this.downloadSnapshot(void 0,{mimeType:"image/webp"})}async _downloadBlob(d,o){var l,c;const u=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("FileTransferPlugin");u?await u.exportFile(d,o):(c=this._viewer)===null||c===void 0||c.console.error("FileTransferPlugin required to export/download file")}};CanvasSnipperPlugin.PluginType="CanvasSnipper",CanvasSnipperPlugin_decorate([uiInput("Filename"),serialize()],CanvasSnipperPlugin.prototype,"filename",void 0),CanvasSnipperPlugin_decorate([uiInput("Frame Count"),serialize()],CanvasSnipperPlugin.prototype,"progressiveFrames",void 0),CanvasSnipperPlugin_decorate([uiInput("Tile Rows"),serialize()],CanvasSnipperPlugin.prototype,"tileRows",void 0),CanvasSnipperPlugin_decorate([uiInput("Tile Columns"),serialize()],CanvasSnipperPlugin.prototype,"tileColumns",void 0),CanvasSnipperPlugin_decorate([uiVector("Crop Rect (x, y, w, h)",[0,1],.001),serialize()],CanvasSnipperPlugin.prototype,"rect",void 0),CanvasSnipperPlugin_decorate([uiButton("Download .png",{limitedUi:!0})],CanvasSnipperPlugin.prototype,"downloadSnapshot",null),CanvasSnipperPlugin_decorate([uiButton("Download .jpeg")],CanvasSnipperPlugin.prototype,"_downloadJpeg",null),CanvasSnipperPlugin_decorate([uiButton("Download .webp")],CanvasSnipperPlugin.prototype,"_downloadWebp",null),CanvasSnipperPlugin=CanvasSnipperPlugin_1=CanvasSnipperPlugin_decorate([uiFolder("Image Export")],CanvasSnipperPlugin);const HorizontalBlurShader={name:"HorizontalBlurShader",uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform float h;

		varying vec2 vUv;

		void main() {

			vec4 sum = vec4( 0.0 );

			sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
			sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
			sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

			gl_FragColor = sum;

		}`},VerticalBlurShader={name:"VerticalBlurShader",uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform float v;

		varying vec2 vUv;

		void main() {

			vec4 sum = vec4( 0.0 );

			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
			sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

			gl_FragColor = sum;

		}`};var ContactShadowGroundPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const horizontalBlurMaterial=new three_module.BKk(HorizontalBlurShader);horizontalBlurMaterial.depthTest=!1;const verticalBlurMaterial=new three_module.BKk(VerticalBlurShader);verticalBlurMaterial.depthTest=!1;class ContactShadowGroundPlugin extends BaseGroundPlugin{constructor(o={},l=!1){super(o),this.contactShadows=!0,this.blurAmount=1,this.shadowScale=1,this.shadowHeight=5,this.shadowCamera=new three_module.qUd(-1,1,1,-1,.001,this.shadowHeight),this._refreshShadowCameraFrustum=this._refreshShadowCameraFrustum.bind(this),this.refreshOptions=this.refreshOptions.bind(this),this._showDebug=l,l&&this.dependencies.push(DebugPlugin)}async onAdded(o){const l=o.renderer.createTarget({type:three_module.OUM,format:three_module.GWd,colorSpace:three_module.jf0,size:{width:512,height:512},generateMipmaps:!1,depthBuffer:!0,minFilter:three_module.k6q,magFilter:three_module.k6q});l.texture.name="groundContactDepthTexture";const c=new three_module.CSG({depthPacking:three_module.Rkk});c.onBeforeCompile=function(h){h.uniforms.opacity.value=1,h.fragmentShader=`
						${h.fragmentShader.replace("gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );","gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), 1.0 );")}
					`};const u=new GBufferRenderPass(l,c,new three_module.Q1f(0,0,0),0);this._depthPass=u,await super.onAdded(o)}_postFrame(){super._postFrame(),this._viewer}_preRender(){if(super._preRender(),!this._viewer||!this._depthPass)return;this._depthPass.scene=this._viewer.scene.modelObject,this._depthPass.camera=this.shadowCamera,this._depthPass.render(this._viewer.renderer.rendererObject,null);const o=this._viewer.renderer.getTempTarget({type:three_module.OUM,format:three_module.GWd,colorSpace:three_module.jf0,size:{width:1024,height:1024},generateMipmaps:!1,depthBuffer:!1,minFilter:three_module.k6q,magFilter:three_module.k6q});this._blurShadow(o),this._blurShadow(o,.4),this._viewer.renderer.releaseTempTarget(o)}_blurShadow(o,l=1){this._viewer&&this._depthPass&&(horizontalBlurMaterial.uniforms.h.value=l*this.blurAmount/256,verticalBlurMaterial.uniforms.v.value=l*this.blurAmount/256,this._viewer.renderer.blit(this._depthPass.target.texture,o,{material:horizontalBlurMaterial,clear:!0}),this._viewer.renderer.blit(o.texture,this._depthPass.target,{material:verticalBlurMaterial,clear:!0}))}async onDispose(o){return super.onDispose(o)}async onRemove(o){var l,c,u;const h=(l=this._depthPass)===null||l===void 0?void 0:l.target;return h&&((c=this._viewer)===null||c===void 0||c.renderer.disposeTarget(h)),(u=this._depthPass)===null||u===void 0||u.dispose(),this._depthPass=void 0,super.onRemove(o)}_refreshTransform(){super._refreshTransform(),this._mesh&&this._viewer&&(this.shadowCamera.position.copy(this._mesh.getWorldPosition(new three_module.Pq0)),this.shadowCamera.setRotationFromEuler(new three_module.O9p(Math.PI/2,0,0)),this.shadowCamera.updateMatrixWorld(),this._refreshShadowCameraFrustum(),this._mesh.scale.y=-this.size)}_refreshShadowCameraFrustum(){this.shadowCamera&&(this.shadowCamera.left=-this.size/(2*this.shadowScale),this.shadowCamera.right=this.size/(2*this.shadowScale),this.shadowCamera.top=this.size/(2*this.shadowScale),this.shadowCamera.bottom=-this.size/(2*this.shadowScale),this.shadowCamera.far=this.shadowHeight,this.shadowCamera.updateProjectionMatrix(),this._setDirty())}_setDirty(){var o;(o=this._viewer)===null||o===void 0||o.setDirty()}_removeMaterial(){this._material&&super._removeMaterial()}refreshOptions(){this._viewer&&super.refreshOptions()}_refreshMaterial(){var o;if(!this._viewer)return!1;const l=super._refreshMaterial();return this._material&&(this._material.alphaMap=((o=this._depthPass)===null||o===void 0?void 0:o.target.texture)||null,l&&(this._material.roughness=1,this._material.metalness=0,this._material.color.set(1118481),this._material.transparent=!0,this._material.materialObject.userData.ssreflDisabled=!0,this._material.materialObject.userData.ssreflNonPhysical=!1)),l}_extraUiConfig(){return[{label:"Contact Shadows",type:"checkbox",property:[this,"contactShadows"]},{label:"Shadow Scale",type:"slider",bounds:[0,2],property:[this,"shadowScale"]},{label:"Shadow Height",type:"slider",bounds:[0,20],property:[this,"shadowHeight"]},{label:"Blur Amount",type:"slider",bounds:[0,10],property:[this,"blurAmount"]},...super._extraUiConfig()]}}function objectBeforeRender(d,o){var l;o&&(!((l=o.map)===null||l===void 0)&&l.isTexture)&&(o.extraUniformsToUpload||(o.extraUniformsToUpload={}),o.extraUniformsToUpload.uvTransform||(o.extraUniformsToUpload.uvTransform={value:new three_module.dwI}),o.extraUniformsToUpload.uvTransform.value.setUvTransform(o.map.offset.x*o.map.repeat.x*d.userData.cloneRotI/(d.userData.rotationCount||1),o.map.offset.y*o.map.repeat.y*d.userData.cloneRotI/(d.userData.rotationCount||1),o.map.repeat.x,o.map.repeat.y,o.map.rotation,o.map.center.x,o.map.center.y))}function setRotI(d,o,l,c){d.traverse(u=>{u&&(u.userData.cloneRotI=o,u.userData.rotationCount=l,u.userData.rotationAxis=c,u.addEventListener("beforeRender",h=>objectBeforeRender(u,h.material)))})}function rotateDuplicatedMesh(d,o,l,c="x"){var u;if(d.userData.rotationCount>1&&!d.userData.rotationRoot)return d;const h=d.parent;if(!h)throw new Error("No parent");if(d.userData.cloneParent){const A=d.userData.cloneParent;if(d=h.children.find(w=>A===w.uuid),!d)return console.error("Couldn't find clone root, cannot rotate. maybe a serialization issue?",A,h),d}let _=h.children.filter(A=>{var w;return((w=A.userData)===null||w===void 0?void 0:w.cloneParent)===d.uuid}).sort((A,w)=>A.userData.cloneRotI-w.userData.cloneRotI);if(d.userData.rotationCount===o&&o===_.length&&l===void 0&&d.userData.rotationAxis===c)return d;if(l==null&&(l=(u=d.userData.rotationSkips)!==null&&u!==void 0?u:[]),l!==d.userData.rotationSkips&&(d.userData.rotationSkips=[...l]),setRotI(d,0,o,c),d.userData.rotationRoot=!0,d.visible=!0,o<=_.length){for(let A=o-1;A<_.length;A++)h.remove(_[A]),_[A].traverse(w=>w.userData={__disposed:!0});_=_.slice(0,o)}for(let A=1;A<o;A++){const w=A<=_.length?_[A-1]:d.clone();w.rotation.copy(d.rotation),w.rotation[c]+=A/o*Math.PI*2,setRotI(w,A,o,c),A>_.length&&h.add(w),w.visible=!l.includes(A)}return d.visible=!l.includes(0),d}ContactShadowGroundPlugin.PluginType="ContactShadowGroundPlugin",ContactShadowGroundPlugin_decorate([x(ContactShadowGroundPlugin.prototype.refreshOptions),serialize()],ContactShadowGroundPlugin.prototype,"contactShadows",void 0),ContactShadowGroundPlugin_decorate([serialize(),x(ContactShadowGroundPlugin.prototype._setDirty)],ContactShadowGroundPlugin.prototype,"blurAmount",void 0),ContactShadowGroundPlugin_decorate([serialize(),x(ContactShadowGroundPlugin.prototype._refreshShadowCameraFrustum)],ContactShadowGroundPlugin.prototype,"shadowScale",void 0),ContactShadowGroundPlugin_decorate([serialize(),x(ContactShadowGroundPlugin.prototype._refreshShadowCameraFrustum)],ContactShadowGroundPlugin.prototype,"shadowHeight",void 0);var ObjectRotationPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let ObjectRotationPlugin=class extends AViewerPlugin{async onAdded(d){var o;await super.onAdded(d),(o=d.getPluginByType("Picking"))===null||o===void 0||o.addEventListener("selectedObjectChanged",this._selectedObjectChanged)}constructor(d=!0){super(),this.rotations=1,this.axis="x",this.skips="",this._selectedObjectChanged=this._selectedObjectChanged.bind(this),this.enabled=d}_selectedObjectChanged(){var d,o,l,c,u,h,_,A,w;if(!this.enabled)return;const C=(o=(d=this._viewer)===null||d===void 0?void 0:d.getPluginByType("Picking"))===null||o===void 0?void 0:o.getSelectedObject();if(!C)return void((c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0));const M=C.userData.rotationRoot&&(u=C.userData.rotationCount)!==null&&u!==void 0?u:1;this.rotations=M,this.skips=(_=(h=C.userData.rotationSkips)===null||h===void 0?void 0:h.join(","))!==null&&_!==void 0?_:"",this.axis=C.userData.rotationAxis||"x",(w=(A=this.uiConfig).uiRefresh)===null||w===void 0||w.call(A,"postFrame",!0)}_paramsChanged(){var d,o,l,c,u,h;if(!this.enabled)return;const _=(o=(d=this._viewer)===null||d===void 0?void 0:d.getPluginByType("Picking"))===null||o===void 0?void 0:o.getSelectedObject();if(_){if(this.rotations>1||_.userData.rotationCount){const A=_.userData.rotationCount,w=rotateDuplicatedMesh(_,this.rotations,this.skips.split(",").map(M=>parseInt(M)).filter(M=>isFinite(M)),this.axis),C=w==null?void 0:w.userData.rotationCount;if(C&&C!==A){const M=[];w==null||w.traverseAncestors(O=>{M.push(O)});for(const O of M)if(O.userData.autoScaled){autoScaleObject3D(O),(l=this._viewer)===null||l===void 0||l.resetCamera({rootObject:O,centerOffset:new three_module.Pq0(4,4,4)});break}}_.parent&&!_.userData.__disposed||(u=(c=this._viewer)===null||c===void 0?void 0:c.getPluginByType("Picking"))===null||u===void 0||u.setSelectedObject(w,!0)}(h=this._viewer)===null||h===void 0||h.scene.setDirty({frameFade:!1,sceneUpdate:!0})}}};ObjectRotationPlugin.PluginType="ObjectRotationPlugin",ObjectRotationPlugin_decorate([serialize(),uiToggle("Enabled"),x(ObjectRotationPlugin.prototype._paramsChanged)],ObjectRotationPlugin.prototype,"enabled",void 0),ObjectRotationPlugin_decorate([uiSlider("Rotation Count",[1,100],1,d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPluginByType("Picking"))===null||l===void 0)&&l.getSelectedObject())||!d.rotations}})),x(ObjectRotationPlugin.prototype._paramsChanged)],ObjectRotationPlugin.prototype,"rotations",void 0),ObjectRotationPlugin_decorate([uiDropdown("Axis",["x","y","z"].map(d=>({label:d})),d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPluginByType("Picking"))===null||l===void 0)&&l.getSelectedObject())||!d.rotations}})),x(ObjectRotationPlugin.prototype._paramsChanged)],ObjectRotationPlugin.prototype,"axis",void 0),ObjectRotationPlugin_decorate([uiInput("Rotation Skips",d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPluginByType("Picking"))===null||l===void 0)&&l.getSelectedObject())||!d.rotations}})),x(ObjectRotationPlugin.prototype._paramsChanged)],ObjectRotationPlugin.prototype,"skips",void 0),ObjectRotationPlugin=ObjectRotationPlugin_decorate([uiFolder("Object Rotations")],ObjectRotationPlugin);var reliefParallax=`#ifdef USE_BUMPMAP
mat3 mat3_inverse(mat3 A){mat3 M_t=mat3(vec3(A[0][0],A[1][0],A[2][0]),vec3(A[0][1],A[1][1],A[2][1]),vec3(A[0][2],A[1][2],A[2][2]));float det=dot(cross(M_t[0],M_t[1]),M_t[2]);mat3 adjugate=mat3(cross(M_t[1],M_t[2]),cross(M_t[2],M_t[0]),cross(M_t[0],M_t[1]));return adjugate/det;}float CalculateHeight(in vec2 texCoords){float height=texture2D(bumpMap,texCoords).x;return clamp(height,0.,1.);}const vec2 bumpMapSize=vec2(512,512);vec3 CalculateNormal(in vec2 texCoords){
#if defined( TANGENTSPACE_NORMALMAP ) && 0 
vec3 mapN=texture2D(normalMap,texCoords).xyz;mapN.xy*=normalScale;return normalize(mapN);
#else
vec2 texOffs=1./bumpMapSize;
#if PARALLAX_NORMAL_MAP_QUALITY > 0
float hx[9];hx[0]=texture2D(bumpMap,texCoords.st+texOffs*vec2(-1.,-1.)).r;hx[1]=texture2D(bumpMap,texCoords.st+texOffs*vec2(0.,-1.)).r;hx[2]=texture2D(bumpMap,texCoords.st+texOffs*vec2(1.,-1.)).r;hx[3]=texture2D(bumpMap,texCoords.st+texOffs*vec2(-1.,0.)).r;hx[4]=texture2D(bumpMap,texCoords.st).r;hx[5]=texture2D(bumpMap,texCoords.st+texOffs*vec2(1.,0.)).r;hx[6]=texture2D(bumpMap,texCoords.st+texOffs*vec2(-1.,1.)).r;hx[7]=texture2D(bumpMap,texCoords.st+texOffs*vec2(0.,1.)).r;hx[8]=texture2D(bumpMap,texCoords.st+texOffs*vec2(1.,1.)).r;vec2 deltaH=vec2(hx[0]-hx[2]+2.*(hx[3]-hx[5])+hx[6]-hx[8],hx[0]-hx[6]+2.*(hx[1]-hx[7])+hx[2]-hx[8]);
#else
float h_xa=texture2D(bumpMap,texCoords.st+texOffs*vec2(-1.,0.)).r;float h_xb=texture2D(bumpMap,texCoords.st+texOffs*vec2(1.,0.)).r;float h_ya=texture2D(bumpMap,texCoords.st+texOffs*vec2(0.,-1.)).r;float h_yb=texture2D(bumpMap,texCoords.st+texOffs*vec2(0.,1.)).r;vec2 deltaH=vec2(h_xa-h_xb,h_ya-h_yb);
#endif
return normalize(vec3(deltaH/texOffs,1.));
#endif
}vec3 ReliefParallax(in float frontFace,in vec3 texDir3D,in vec2 texCoord){float surf_sign=frontFace;float back_face=step(0.,-surf_sign);vec2 texStep=surf_sign*texDir3D.xy/abs(texDir3D.z);vec2 texC=texCoord.st+surf_sign*texStep+back_face*texStep.xy;float mapHeight=1.;float bumpHeightStep=1./float(PARALLAX_MAP_STEPS);float bestBumpHeight=mapHeight+bumpHeightStep;
#pragma unroll_loop_start
for(int i=0;i<PARALLAX_MAP_STEPS;i++){if(mapHeight<bestBumpHeight){bestBumpHeight-=bumpHeightStep;mapHeight=back_face+surf_sign*CalculateHeight(texC.xy-bestBumpHeight*texStep.xy);}}
#pragma unroll_loop_end
bestBumpHeight+=bumpHeightStep;
#pragma unroll_loop_start
for(int i=0;i<PARALLAX_MAP_B_STEPS;i++){bumpHeightStep*=0.5;bestBumpHeight-=bumpHeightStep;mapHeight=back_face+surf_sign*CalculateHeight(texC.xy-bestBumpHeight*texStep.xy);bestBumpHeight+=(bestBumpHeight<mapHeight)?bumpHeightStep:0.;}
#pragma unroll_loop_end
bestBumpHeight-=bumpHeightStep*clamp((bestBumpHeight-mapHeight)/bumpHeightStep,0.,1.);mapHeight=bestBumpHeight;texC-=mapHeight*texStep;return vec3(texC.xy,mapHeight);}vec3 reliefParallaxPerturbNormal(in float faceDirection,inout vec3 normal){if(abs(bumpScale)<0.001)return vec3(vBumpMapUv,0.);float parallaxHeight;vec2 texCoords=vBumpMapUv;float face_sign=sign(dot(normal,vViewPosition));vec3 N=normalize(normal);vec3 dp1=dFdx(-vViewPosition);vec3 dp2=dFdy(-vViewPosition);vec2 duv1=dFdx(vBumpMapUv);vec2 duv2=dFdy(vBumpMapUv);vec3 dp2perp=cross(dp2,N);vec3 dp1perp=cross(N,dp1);vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(T,T),dot(B,B)));mat3 tbnMat=mat3(T*invmax,B*invmax,N*bumpScale);vec3 tangentPos=normalize(mat3_inverse(tbnMat)*-vViewPosition);vec3 parallaxUv=ReliefParallax(face_sign,tangentPos,vBumpMapUv);tbnMat[2]=face_sign*N/bumpScale;normal=normalize(tbnMat*CalculateNormal(parallaxUv.xy).xyz);
#ifdef FLIP_SIDED
normal=-normal;
#endif
return parallaxUv;}
#endif 
`,ParallaxMappingPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let ParallaxMappingPlugin=class extends AViewerPlugin{constructor(d=!0){super(),this.enabled=!0,this.debugNormals=!1,this.debugHitHeight=!1,this._defines={PARALLAX_NORMAL_MAP_QUALITY:0},this.stepCount=12,this.binaryStepCount=3,this._bumpMapExtension={shaderExtender:(o,l,c)=>{if(l.materialObject.bumpMap&&this.enabled){o.fragmentShader=o.fragmentShader.replace("#include <normal_fragment_begin>",""),o.fragmentShader=o.fragmentShader.replace("#include <normal_fragment_maps>",""),o.fragmentShader=o.fragmentShader.replace("#include <map_fragment>",`#include <normal_fragment_begin>
#include <normal_fragment_maps>
#include <map_fragment>`);for(const u of["map_fragment","alphamap_fragment","roughnessmap_fragment","metalnessmap_fragment","emissivemap_fragment","transmission_fragment"])o.fragmentShader=shaderReplaceString(o.fragmentShader,`#include <${u}>`,three_module.vxI[u].replace(/\bv\w+Uv\b/g,"parallaxUv.xy",{replaceAll:!0}));(this.debugNormals||this.debugHitHeight)&&(o.fragmentShader=shaderReplaceString(o.fragmentShader,"texture2D( map, parallaxUv.xy )",this.debugNormals?"vec4(normal, 1.); normal = nonPerturbedNormal":"vec4(parallaxUv.z,0., 0., 1.)")),o.fragmentShader=shaderReplaceString(o.fragmentShader,"#include <normal_fragment_maps>",shaderReplaceString(shaderReplaceString(three_module.vxI.normal_fragment_maps,"#elif defined( USE_NORMALMAP_TANGENTSPACE )","#elif defined( USE_NORMALMAP_TANGENTSPACE ) && !defined( USE_BUMPMAP )"),"normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );","vec3 parallaxUv = reliefParallaxPerturbNormal(faceDirection, normal);"))}},parsFragmentSnippet:()=>this.enabled?(reliefParallax+`
`).replaceAll("PARALLAX_MAP_STEPS",this._defines.PARALLAX_MAP_STEPS).replaceAll("PARALLAX_MAP_B_STEPS",this._defines.PARALLAX_MAP_B_STEPS):"",isCompatible:o=>o.isMeshStandardMaterial2,computeCacheKey:o=>{var l;return this.enabled+" "+((l=o.materialObject.bumpMap)===null||l===void 0?void 0:l.uuid)+" "+this.debugNormals+" "+this.debugHitHeight+"  "},onObjectRender:(o,{materialObject:l},c)=>{if(this.enabled)for(const[u,h]of Object.entries(this._defines)){const _=typeof h=="number"?h:h?1:0;l.defines[u]!==_&&(l.defines[u]=_,l.needsUpdate=!0)}}},this.dependencies=[AssetManagerPlugin],this.enabled=d,this._updateExtension=this._updateExtension.bind(this)}_updateExtension(){var d,o,l;(o=(d=this._bumpMapExtension)===null||d===void 0?void 0:d.setDirty)===null||o===void 0||o.call(d),(l=this._viewer)===null||l===void 0||l.setDirty()}async onAdded(d){var o,l;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.registerMaterialExtension(this._bumpMapExtension),super.onAdded(d)}async onRemove(d){var o,l;return(l=(o=d.getPlugin(AssetManagerPlugin))===null||o===void 0?void 0:o.materials)===null||l===void 0||l.unregisterMaterialExtension(this._bumpMapExtension),super.onRemove(d)}};ParallaxMappingPlugin.PluginType="ReliefParallaxMapping",ParallaxMappingPlugin_decorate([x(ParallaxMappingPlugin.prototype._updateExtension),serialize(),uiToggle("Enabled")],ParallaxMappingPlugin.prototype,"enabled",void 0),ParallaxMappingPlugin_decorate([x(ParallaxMappingPlugin.prototype._updateExtension),uiToggle("Debug Normals")],ParallaxMappingPlugin.prototype,"debugNormals",void 0),ParallaxMappingPlugin_decorate([x(ParallaxMappingPlugin.prototype._updateExtension),uiToggle("Debug Hit Height")],ParallaxMappingPlugin.prototype,"debugHitHeight",void 0),ParallaxMappingPlugin_decorate([matDefine("PARALLAX_MAP_STEPS",void 0,!0,ParallaxMappingPlugin.prototype._updateExtension),uiSlider("Step count",[1,32],1),serialize()],ParallaxMappingPlugin.prototype,"stepCount",void 0),ParallaxMappingPlugin_decorate([matDefine("PARALLAX_MAP_B_STEPS",void 0,!0,ParallaxMappingPlugin.prototype._updateExtension),uiSlider("Binary search steps",[1,8],1),serialize()],ParallaxMappingPlugin.prototype,"binaryStepCount",void 0),ParallaxMappingPlugin=ParallaxMappingPlugin_decorate([uiFolder("Parallax Mapping")],ParallaxMappingPlugin);class TubeShapeGeometry extends three_module.LoY{constructor(o,l,c=32,u=64,h=!1,_=new three_module.I9Y(1,1),A="shape"){super(),this.type="TubeShapeGeometry",this.parameters={path:l,shape:o,shapeSegments:c,tubularSegments:u,closed:h,primary:A,shapeScale:_.clone()};const w=l.computeFrenetFrames(u,h);this.frames=w;const C=new three_module.Pq0,M=new three_module.Pq0,O=new three_module.Pq0,ne=new three_module.I9Y;let ce=new three_module.Pq0;const ue=[],ye=[],Oe=[],ke=o.getSpacedPoints(c);for(const ht of ke)ht.multiply(_);(function(){for(let ht=0;ht<u;ht++)tt(ht);tt(h===!1?u:0),function(){for(let ht=0;ht<=u;ht++)for(let ut=0;ut<=c;ut++)ne.x=ht/u,ne.y=ut/c,ye.push(ne.x,ne.y)}(),function(){const ht=A==="shape",ut=ht?c:u,_t=ht?u:c;for(let at=1;at<=ut;at++)for(let lt=1;lt<=_t;lt++){const[pt,xt]=ht?[lt,at]:[at,lt],Tt=(c+1)*(pt-1)+(xt-1),Pt=(c+1)*pt+(xt-1),Lt=(c+1)*pt+xt,Bt=(c+1)*(pt-1)+xt;Oe.push(Tt,Pt,Bt),Oe.push(Pt,Lt,Bt)}}()})(),this.setIndex(Oe),this.setAttribute("position",new three_module.qtW(ue,3)),this.setAttribute("uv",new three_module.qtW(ye,2)),this.computeVertexNormals();const Ve=this.attributes.normal;function tt(ht){ce=l.getPointAt(ht/u,ce);const ut=w.normals[ht],_t=w.binormals[ht];for(let at=0;at<=c;at++){const lt=ke[at%c];M.set(0,0,0).addScaledVector(ut,lt.x).addScaledVector(_t,lt.y),C.copy(ce).add(M),ue.push(C.x,C.y,C.z)}}(function(){for(let ut=1;ut<c;ut++){const _t=ut+u*(c+1);M.fromBufferAttribute(Ve,ut),O.fromBufferAttribute(Ve,_t),M.add(O).normalize(),Ve.setXYZ(ut,M.x,M.y,M.z),Ve.setXYZ(_t,M.x,M.y,M.z)}for(let ut=1;ut<u;ut++){const _t=ut*(c+1),at=_t+c;M.fromBufferAttribute(Ve,_t),O.fromBufferAttribute(Ve,at),M.add(O).normalize(),Ve.setXYZ(_t,M.x,M.y,M.z),Ve.setXYZ(at,M.x,M.y,M.z)}M.fromBufferAttribute(Ve,0),O.fromBufferAttribute(Ve,c),M.add(O);const ht=u*(c+1);O.fromBufferAttribute(Ve,ht),M.add(O),O.fromBufferAttribute(Ve,ht+c),M.add(O),M.normalize(),Ve.setXYZ(0,M.x,M.y,M.z),Ve.setXYZ(c,M.x,M.y,M.z),Ve.setXYZ(ht,M.x,M.y,M.z),Ve.setXYZ(ht+c,M.x,M.y,M.z),Ve.needsUpdate=!0})()}createSplits(o){this.clearGroups();const l=this.parameters.primary==="shape"?this.parameters.shapeSegments:this.parameters.tubularSegments,c=this.index.count,u=[...o,1].sort((A,w)=>A-w);let h=0,_=0;for(const A of u){const w=Math.round(l*A)*c/l;this.addGroup(h,w-h,_++),h=w}return this.groups.length}toJSON(){const o=super.toJSON();return o.path=this.parameters.path.toJSON(),o.shape=this.parameters.shape.toJSON(),o}}var ShapeTubeExtrudePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},ShapeTubeExtrudePlugin_1;let ShapeTubeExtrudePlugin=ShapeTubeExtrudePlugin_1=class extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.shapeSegments=32,this.tubularSegments=32,this.shapeScale=new three_module.I9Y(1,1),this.materialSplits="0.3, 0.6",this.horizontalSplits=!0,this.extrudeCirceTube=async()=>{var d,o;const l=(o=(d=this._viewer)===null||d===void 0?void 0:d.getPlugin(PickingPlugin))===null||o===void 0?void 0:o.getSelectedObject();if(!l)return;let c=this._viewer.prompt("Radius: Radius for the circle","1",!0);if(!c)return;c=parseFloat(c);const u=new EllipseCurve3D(0,0,c,c,0,2*Math.PI,!0,0);await this.extrudeObject(l,u)}}async onAdded(d){await super.onAdded(d)}static CreateCurve(d,o){var l,c;if(d==="circle")return new EllipseCurve3D(0,0,(l=o.radius)!==null&&l!==void 0?l:1,(c=o.radius)!==null&&c!==void 0?c:1,0,2*Math.PI,!0,0);throw new Error("Unknown curve type")}async extrudeObject(d,o,l=this.shapeSegments,c=this.tubularSegments,u=this.shapeScale,h=this.materialSplits.split(",").map(A=>parseFloat(A.trim())),_=this.horizontalSplits){var A,w,C,M,O,ne,ce,ue;if(d.userData.isExtrudedTube,d.userData._extrudeSource){const ht=d.userData._extrudeSource;if(d=(A=d.parent)===null||A===void 0?void 0:A.children.find(ut=>ht===ut.uuid),!d)return void console.warn("Could not find extrude source with uuid",ht)}if(d.userData.extrudedObject){const ht=d.userData.extrudedObject,ut=(w=d.parent)===null||w===void 0?void 0:w.children.find(_t=>ht===_t.uuid);ut&&(ut.removeFromParent(),ut.geometry.dispose(),ut.geometry=null,ut.material=null),delete d.userData.extrudedObject}const ye=d.geometry;if(!ye)return void((C=this._viewer)===null||C===void 0||C.alert("Extrude: No geometry to extrude"));const Oe=[d.material];let ke;try{const ht=ShapeTubeExtrudePlugin_1.ConvertGeometryToFlatShape(ye);ke=new TubeShapeGeometry(ht,o,l,c,!0,u,_?"shape":"path"),ke.computeBoundingBox(),ke.createSplits(h)}catch(ht){return void((M=this._viewer)===null||M===void 0||M.alert(typeof ht=="string"?ht:ht==null?void 0:ht.message))}Oe[0].color.set(16777215);for(let ht=Oe.length;ht<ke.groups.length;ht++){const ut=Oe[0].clone();Oe.push(ut),ut.color.set(16777215*Math.random())}const Ve=new three_module.eaF(ke,Oe);Ve.userData._extrudeSource=d.uuid,Ve.userData.isExtrudedTube=!0,d.visible=!1,d.userData.bboxVisible=!1,Ve.name=d.name+"_extruded";const tt=await((ce=(ne=(O=this._viewer)===null||O===void 0?void 0:O.getManager())===null||ne===void 0?void 0:ne.importer)===null||ce===void 0?void 0:ce.processImportedSingle(Ve,{autoCenter:!1,autoScale:!1}));tt&&((ue=d.parent)===null||ue===void 0||ue.add(tt.modelObject),d.userData.extrudedObject=tt.modelObject.uuid,tt.dispatchEvent({type:"select",ui:!0,value:tt}))}static ExtrudeShape(d,o,l,c,u,h,_,A){const w=new TubeShapeGeometry(d,c,o,l,!0,new three_module.I9Y(u,h),A?"shape":"path");w.computeBoundingBox(),w.createSplits(_);const C=new three_module.eaF(w,[]);return C.userData.isExtrudedTube=!0,C}static ConvertGeometryToFlatShape(d,o=!0){if(d.userData.__planarShape)return d.userData.__planarShape;let l=d.attributes.position;if(!l)throw"no position attribute";if(l.count>500)throw"too large to extrude";const c=d;l=c.attributes.position,c.boundingBox||c.computeBoundingBox();const u=c.boundingBox.getSize(new three_module.Pq0),h=u.x<.001?"x":u.y<.001?"y":u.z<.001?"z":null;if(!h)throw"geometry is not axis aligned not planar";let _=[];for(let w=0;w<l.count;w++){const C=new three_module.I9Y;h==="x"?C.set(l.getY(w),l.getZ(w)):h==="y"?C.set(l.getX(w),l.getZ(w)):C.set(l.getX(w),l.getY(w)),_.push(C)}if(o){let w=0;for(let C=0;C<_.length;C++)(_[C].x<_[w].x||_[C].x===_[w].x&&_[C].y<_[w].y)&&(w=C);w!==0&&(_=_.slice(w).concat(_.slice(0,w)))}const A=new three_module.ypk(_);return d.userData.__planarShape=A,A}};ShapeTubeExtrudePlugin.PluginType="ShapeTubeExtrudePlugin",ShapeTubeExtrudePlugin_decorate([uiToggle("Enabled")],ShapeTubeExtrudePlugin.prototype,"enabled",void 0),ShapeTubeExtrudePlugin_decorate([uiSlider("Shape Segments (X)",[1,100],1,d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0)&&l.getSelectedObject())}}))],ShapeTubeExtrudePlugin.prototype,"shapeSegments",void 0),ShapeTubeExtrudePlugin_decorate([uiSlider("Tube Segments (Y)",[1,100],1,d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0)&&l.getSelectedObject())}}))],ShapeTubeExtrudePlugin.prototype,"tubularSegments",void 0),ShapeTubeExtrudePlugin_decorate([uiVector("Shape scale",[.01,10],.01,d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0)&&l.getSelectedObject())}}))],ShapeTubeExtrudePlugin.prototype,"shapeScale",void 0),ShapeTubeExtrudePlugin_decorate([uiInput("Material Splits",d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0)&&l.getSelectedObject())}}))],ShapeTubeExtrudePlugin.prototype,"materialSplits",void 0),ShapeTubeExtrudePlugin_decorate([uiToggle("Horizontal Splits",d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0)&&l.getSelectedObject())}}))],ShapeTubeExtrudePlugin.prototype,"horizontalSplits",void 0),ShapeTubeExtrudePlugin_decorate([uiButton("Extrude Circle Tube",d=>({hidden:()=>{var o,l;return!(!((l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0)&&l.getSelectedObject())}}))],ShapeTubeExtrudePlugin.prototype,"extrudeCirceTube",void 0),ShapeTubeExtrudePlugin=ShapeTubeExtrudePlugin_1=ShapeTubeExtrudePlugin_decorate([uiFolder("Extrude Tube Shapes")],ShapeTubeExtrudePlugin);class EllipseCurve3D extends three_module.S20{getPoint(o,l){return super.getPoint(o,l||new three_module.Pq0)}}class PopmotionPlugin extends AViewerPlugin{constructor(o=!0){super(),this.enabled=!0,this.toJSON=void 0,this.fromJSON=void 0,this._lastFrameTime=0,this._updaters=[],this.dependencies=[],this._fadeDisabled=!1,this.disableFrameFade=!0,this._postFrame=()=>{var l,c;if(!this._viewer)return;if(!this.enabled||Object.keys(this.animations).length<1)return this._lastFrameTime=0,void(this._fadeDisabled&&((l=this._viewer.getPluginByType("FrameFade"))===null||l===void 0||l.enable(PopmotionPlugin.PluginType),this._fadeDisabled=!1));const u=g()/1e3;this._lastFrameTime<1&&(this._lastFrameTime=u-1/60);let h=u-this._lastFrameTime;this._lastFrameTime=u;const _=(c=this._viewer.getPluginByType("Progressive"))===null||c===void 0?void 0:c.postFrameConvergedRecordingDelta();if(_&&_>0&&(h=_),_!==0&&(h*=1e3,!(h<=.001)&&(this._updaters.forEach(A=>{let w=h;A.time+w<0&&(w=-A.time),A.time+=w,Math.abs(w)>.001&&A.u(w)}),!this._fadeDisabled&&this.disableFrameFade))){const A=this._viewer.getPluginByType("FrameFade");A&&(A.disable(PopmotionPlugin.PluginType),this._fadeDisabled=!0)}},this.defaultDriver=l=>({start:()=>this._updaters.push({u:l,time:0}),stop:()=>this._updaters.splice(this._updaters.findIndex(c=>c.u===l),1)}),this.animations={},this.enabled=o,this._postFrame=this._postFrame.bind(this)}async onAdded(o){await super.onAdded(o),o.addEventListener("postFrame",this._postFrame)}async onRemove(o){return o.removeEventListener("postFrame",this._postFrame),super.onRemove(o)}animate(o){const l=esm_browser_v4(),c={id:l,options:o,stop:()=>{var u,h,_;!((u=this.animations[l])===null||u===void 0)&&u._stop?(_=(h=this.animations[l])===null||h===void 0?void 0:h._stop)===null||_===void 0||_.call(h):console.warn("Animation not started")}};return this.animations[l]=c,c.promise=new Promise((u,h)=>{const _={driver:this.defaultDriver,...o,onComplete:async()=>{var w;try{await((w=o.onComplete)===null||w===void 0?void 0:w.call(o))}catch(C){return void h(C)}u()},onStop:async()=>{var w;try{await((w=o.onStop)===null||w===void 0?void 0:w.call(o))}catch(C){return void h(C)}u()}},A=animate(_);this.animations[l]._stop=A.stop,this.animations[l].options=_}).then(()=>(delete this.animations[l],l)),this.animations[l]}async animateAsync(o){return this.animate(o).promise}}PopmotionPlugin.PluginType="PopmotionPlugin";var SimpleTextPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},TextSVGOptions_1,SimpleTextPlugin_1;const onOpsChange=d=>({onChange:o=>{o.last&&d.onChange()}});let TextSVGOptions=TextSVGOptions_1=class{constructor(){this.text="Custom Text",this.fontSize=100,this.width=1024,this.height=1024,this.xOffset=0,this.yOffset=0,this.boxWidth=1024,this.boxHeight=1024,this.textAnchor="middle",this.fontFamily="",this.fontPath="",this.maskText=!1,this.innerShadow=!1,this.textColor="#000000",this.bgFillColor="#ffffff",this.svgBackground="#ffffff",this.onChange=()=>{}}set(d){Object.assign(this,d)}reset(){const d=this.onChange;Object.assign(this,new TextSVGOptions_1),this.onChange=d}toJSON(){return{text:this.text,fontFamily:this.fontFamily,fontPath:this.fontPath,svgBackground:this.svgBackground,width:this.width,height:this.height,xOffset:this.xOffset,yOffset:this.yOffset,boxWidth:this.boxWidth,boxHeight:this.boxHeight,fontSize:this.fontSize,maskText:this.maskText,innerShadow:this.innerShadow,bgFillColor:this.bgFillColor,textColor:this.textColor,textAnchor:this.textAnchor}}};SimpleTextPlugin_decorate([uiInput("Text",onOpsChange)],TextSVGOptions.prototype,"text",void 0),SimpleTextPlugin_decorate([uiSlider("Font Size",[2,400],1,onOpsChange)],TextSVGOptions.prototype,"fontSize",void 0),SimpleTextPlugin_decorate([uiSlider("Width",[2,4096],1,onOpsChange)],TextSVGOptions.prototype,"width",void 0),SimpleTextPlugin_decorate([uiSlider("Height",[2,4096],1,onOpsChange)],TextSVGOptions.prototype,"height",void 0),SimpleTextPlugin_decorate([uiSlider("X Offset",[-1024,1024],1,onOpsChange)],TextSVGOptions.prototype,"xOffset",void 0),SimpleTextPlugin_decorate([uiSlider("Y Offset",[-1024,1024],1,onOpsChange)],TextSVGOptions.prototype,"yOffset",void 0),SimpleTextPlugin_decorate([uiSlider("V-Width",[2,4096],1,onOpsChange)],TextSVGOptions.prototype,"boxWidth",void 0),SimpleTextPlugin_decorate([uiSlider("V-Height",[2,4096],1,onOpsChange)],TextSVGOptions.prototype,"boxHeight",void 0),SimpleTextPlugin_decorate([uiDropdown("Text Anchor",["start","middle","end"].map(d=>({label:d})),onOpsChange)],TextSVGOptions.prototype,"textAnchor",void 0),SimpleTextPlugin_decorate([uiInput("Font",onOpsChange)],TextSVGOptions.prototype,"fontFamily",void 0),SimpleTextPlugin_decorate([uiInput("Font Url",onOpsChange)],TextSVGOptions.prototype,"fontPath",void 0),SimpleTextPlugin_decorate([uiToggle("Mask Text",onOpsChange)],TextSVGOptions.prototype,"maskText",void 0),SimpleTextPlugin_decorate([uiToggle("Inner Shadow",onOpsChange)],TextSVGOptions.prototype,"innerShadow",void 0),SimpleTextPlugin_decorate([uiColor("Text Color",onOpsChange)],TextSVGOptions.prototype,"textColor",void 0),SimpleTextPlugin_decorate([uiColor("BG Fill",onOpsChange)],TextSVGOptions.prototype,"bgFillColor",void 0),SimpleTextPlugin_decorate([uiColor("SVG BG",onOpsChange)],TextSVGOptions.prototype,"svgBackground",void 0),TextSVGOptions=TextSVGOptions_1=SimpleTextPlugin_decorate([uiFolder("Text SVG Options")],TextSVGOptions);const fontFormatExtensionMap={woff:"woff",woff2:"woff2",ttf:"truetype",otf:"opentype",eot:"embedded-opentype"},inputHiddenParams=d=>({hidden:()=>{const o=d.getSelected();return!o||!o.userData[SimpleTextPlugin.PluginType]}});let SimpleTextPlugin=SimpleTextPlugin_1=class extends AViewerPlugin{async onAdded(d){var o;await super.onAdded(d),(o=d.getPluginByType("Picking"))===null||o===void 0||o.addEventListener("selectedObjectChanged",this._selectedObjectChanged)}constructor(){super(),this.enabled=!0,this.getSelected=()=>{var d,o;return(o=(d=this._viewer)===null||d===void 0?void 0:d.getPluginByType("Picking"))===null||o===void 0?void 0:o.getSelectedObject()},this.options=new TextSVGOptions,this.applyToMap=!0,this.applyToBumpMap=!1,this.applyToAlphaMap=!0,this.inverseAlphaMap=!1,this._lastMeta=void 0,this.fonts={roboto:"https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2"},this._assetLoadOptions=void 0,this._selectedObjectChanged=this._selectedObjectChanged.bind(this),this.addTextToSelected=this.addTextToSelected.bind(this),this._paramsChanged=this._paramsChanged.bind(this),this.options.onChange=this._paramsChanged}_selectedObjectChanged(){var d,o,l,c,u,h;if(!this.enabled)return;const _=this.getSelected();if(!_)return void((o=(d=this.uiConfig).uiRefresh)===null||o===void 0||o.call(d,"postFrame",!0));const A=_.userData[SimpleTextPlugin_1.PluginType];if(!A)return this.options.reset(),this._lastMeta=void 0,void((c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0));this._lastMeta!==A&&(this.options.set(A),this._lastMeta=A),(h=(u=this.uiConfig).uiRefresh)===null||h===void 0||h.call(u,"postFrame",!0)}_paramsChanged(){if(!this.enabled)return;const d=this.getSelected();d&&d.isMesh&&d.userData[SimpleTextPlugin_1.PluginType]&&this.updateText(d,this.options.toJSON())}async addTextToSelected(){var d;const o=this.getSelected();o&&o.isMesh?o.material?(o.userData[SimpleTextPlugin_1.PluginType]||!o.material.map||await((d=this._viewer)===null||d===void 0?void 0:d.confirm("Add Text: This mesh already has a texture. Adding text will replace the texture. Continue?")))&&await this.addText(o):console.error("no material on mesh"):console.error("no mesh is selected")}async addText(d,o){return this.updateText(d,Object.assign(this.options.toJSON(),o))}async updateText(d,o){var l,c;if(!d.isMesh)return;if(!d.material)return void console.error("updateText: no material on mesh");let u=d.userData[SimpleTextPlugin_1.PluginType];u||(d.userData[SimpleTextPlugin_1.PluginType]=u={}),Object.assign(u,o);const h=d.material;h.map&&(h.map._isSimpleTextTexture&&h.map.dispose(),h.map=void 0),h.alphaMap&&(h.alphaMap._isSimpleTextTexture&&h.alphaMap.dispose(),h.alphaMap=void 0),h.bumpMap&&(h.bumpMap._isSimpleTextTexture&&h.bumpMap.dispose(),h.bumpMap=void 0);const _=await this.makeTextSvg(u);this.applyToMap&&(h.map=_),this.applyToAlphaMap&&(h.alphaMap=_,h.transparent=!0),this.applyToBumpMap&&(h.bumpMap=_),h.userData.inverseAlphaMap=this.inverseAlphaMap,h.setDirty(),h.needsUpdate=!0,(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0)}async makeTextSvg(d){const o=d.fontFamily||"Arial",l=d.fontPath||this.fonts[o]||"";let c=d.style;if(l.length>0){const _=l.split("?")[0].split(".").pop()||"woff";c+=`
`+(l.length>0?`
            @font-face {
                font-family: ${o};
                src: url(${l}) format(${fontFormatExtensionMap[_]||_});
            }`:"")}let u=buildTextSvg({...d,fontFamily:o,style:c});u=await Ze(u,async _=>this._getAssetData(_)),u=B(u);const h=await this._viewer.getManager().importer.importSinglePath(u,{generateMipmaps:!1,minFilter:three_module.k6q});return h._isSimpleTextTexture=!0,h.flipY=!1,h.needsUpdate=!0,h}async _getAssetData(d){var o,l;if(d.startsWith("http://www.w3.org"))return d;const c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getManager())===null||l===void 0?void 0:l.importer;if(!c)throw new Error("no importer");this._assetLoadOptions=this._assetLoadOptions||{fileHandler:new DataUrlLoader(c.loadingManager),processImported:!1};try{return await c.importPath(d,this._assetLoadOptions)}catch(u){return console.error(u),""}}};function buildTextSvg({text:d="Custom Text",svgBackground:o="#ffffff",xOffset:l=0,yOffset:c=0,width:u=1024,height:h=1024,boxWidth:_=1024,boxHeight:A=1024,fontFamily:w="",fontSize:C=32,maskText:M=!0,innerShadow:O=!0,bgFillColor:ne="#000000",textColor:ce="#ffffff",textAnchor:ue="middle",style:ye=""}){return`
<svg style="background-color:${o}" width="${u}" height="${h}" viewBox="0 0 ${_} ${A}"
 xmlns="http://www.w3.org/2000/svg"
 xmlns:xlink="http://www.w3.org/1999/xlink">
     <defs>
        <style>
        ${ye}
        </style>
    </defs>

    <g style="overflow:hidden; text-anchor: ${ue}; font-size: ${C}px; font-family: ${w||"Arial"}">
        <defs>

`+(M?`
<mask id="textMask">
<text style="fill:white; font-size: ${C}px;" x="${l+_/2}" y="${A/2+c+C/4}" > ${d} </text>
</mask>
`:"")+`

`+(O?`
<filter id="innerShadow" x="-20%" y="-20%" width="140%" height="140%">
<feGaussianBlur in="SourceGraphic" stdDeviation="0.5" result="blur"/>
<feOffset in="blur" dx="1.5" dy="1.5"/>
</filter>
`:"")+`

        </defs>

`+(M?`
        <g mask="url(#textMask)">
`:"")+`

        <rect x="0" y="0" width="${_}" height="${A}" style="fill:${ne}"/>
        <text style="${O?"filter: url(#innerShadow);":""} fill:${ce};" x="${l+_/2}" y="${A/2+c+C/4}"> ${d} </text>

`+(M?`
        </g>
`:"")+`

    </g>
</svg>
`}SimpleTextPlugin.PluginType="SimpleTextPlugin",SimpleTextPlugin_decorate([uiConfig(void 0,{params:inputHiddenParams})],SimpleTextPlugin.prototype,"options",void 0),SimpleTextPlugin_decorate([uiToggle("Apply Map",inputHiddenParams),x(SimpleTextPlugin.prototype._paramsChanged),serialize()],SimpleTextPlugin.prototype,"applyToMap",void 0),SimpleTextPlugin_decorate([uiToggle("Apply Bump Map",inputHiddenParams),x(SimpleTextPlugin.prototype._paramsChanged),serialize()],SimpleTextPlugin.prototype,"applyToBumpMap",void 0),SimpleTextPlugin_decorate([uiToggle("Apply Alpha Map",inputHiddenParams),x(SimpleTextPlugin.prototype._paramsChanged),serialize()],SimpleTextPlugin.prototype,"applyToAlphaMap",void 0),SimpleTextPlugin_decorate([uiToggle("Invert Alpha Map",inputHiddenParams),x(SimpleTextPlugin.prototype._paramsChanged),serialize()],SimpleTextPlugin.prototype,"inverseAlphaMap",void 0),SimpleTextPlugin_decorate([uiButton("Add Text",d=>({hidden:()=>!d.getSelected()}))],SimpleTextPlugin.prototype,"addTextToSelected",null),SimpleTextPlugin=SimpleTextPlugin_1=SimpleTextPlugin_decorate([uiFolder("Simple Text")],SimpleTextPlugin);var SceneLoopPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let SceneLoopPlugin=class extends AViewerPlugin{constructor(){super(),this.enabled=!0,this.dependencies=[AssetManagerPlugin],this.scenes=[],this.assets={},this.toJSON=void 0,this._isPlaying=!1,this._isPlayingLoop=!1,this._options={},this.minSceneTime=2e3,this.loadScenes=this.loadScenes.bind(this),this.play=this.play.bind(this),this.stop=this.stop.bind(this),this.downloadScenes=this.downloadScenes.bind(this),this.promptLoadScenes=this.promptLoadScenes.bind(this)}get loadedScenes(){return this.scenes.length}async promptLoadScenes(){const d=await ge(!0,!1,"model/gltf");await this.loadScenes(d)}async loadScenes(d){var o,l;const c=await Promise.all(d.map(async u=>await u.arrayBuffer()));for(let u=0;u<d.length;u++){const h=d[u];this.scenes.push({[h.name]:new Uint8Array(c[u])}),this.assets[h.name]={path:h.name,file:h}}(l=(o=this.uiConfig)===null||o===void 0?void 0:o.uiRefresh)===null||l===void 0||l.call(o)}async play(){var d,o;if(!this._viewer||this._isPlaying||this._isPlayingLoop)return;this._isPlaying=!0,this._isPlayingLoop=!0;const l=(d=this._viewer.getPluginByType("AssetManagerBasicPopupPlugin"))!==null&&d!==void 0?d:this._viewer.getPluginByType("LoadingScreenPlugin");l==null||l.enabled,l&&(l.enabled=!1);const c=this._viewer.getPluginByType("FrameFade"),u=this._viewer.getPluginByType("GLTFAnimation"),h=this._viewer.getPluginByType("CameraViews");for(;this._isPlaying;)for(const _ of this.scenes){if(!this._isPlaying)break;const A=Object.keys(_);u==null||u.stopAnimation(!1),await(h==null?void 0:h.stopAllAnimations()),this._viewer.scene.removeSceneModels(),this._viewer.renderEnabled=!1;for(const C of A){let M=this.assets[C];M||(M={path:C,file:new File([_[C]],C)},this.assets[C]=M),await((o=this._viewer.getManager())===null||o===void 0?void 0:o.addAssetSingle(M,this._options))}if(!this._isPlaying)break;this._viewer.renderEnabled=!0,l&&(l.enabled=!1),c&&(c.enabled=!0,await c.startTransition(1e3));const w=[X(this.minSceneTime)];u&&w.push(u.playAnimation()),h&&w.push(h.animateAllViews()),await Promise.all(w)}this._isPlayingLoop=!1}stop(){this._isPlaying=!1}async downloadScenes(){const d={};for(const l of this.scenes)for(const c of Object.keys(l)){const u=d[c]?c+"_":c;d[u]=l[u]}const o=zipSync(d);N(new Blob([o],{type:"application/zip"}),"scenes.glbloop")}async onAdded(d){var o,l;await super.onAdded(d);const c=this;(l=(o=d.getManager())===null||o===void 0?void 0:o.importer)===null||l===void 0||l.Importers.push(new Importer(class extends ZipLoader{load(u,h,_,A){super.load(u,w=>{c.loadScenes([...w.values()]),h==null||h(null),X(100).then(c.play)},_,A)}},["glbloop"],!0))}};SceneLoopPlugin.PluginType="SceneLoopPlugin",SceneLoopPlugin_decorate([uiMonitor("Loaded scenes")],SceneLoopPlugin.prototype,"loadedScenes",null),SceneLoopPlugin_decorate([uiButton("Load Scenes")],SceneLoopPlugin.prototype,"promptLoadScenes",null),SceneLoopPlugin_decorate([uiMonitor("Playing")],SceneLoopPlugin.prototype,"_isPlaying",void 0),SceneLoopPlugin_decorate([uiInput("Min Scene Time")],SceneLoopPlugin.prototype,"minSceneTime",void 0),SceneLoopPlugin_decorate([uiButton("Play")],SceneLoopPlugin.prototype,"play",null),SceneLoopPlugin_decorate([uiButton("Stop")],SceneLoopPlugin.prototype,"stop",null),SceneLoopPlugin_decorate([uiButton("Download Scenes")],SceneLoopPlugin.prototype,"downloadScenes",null),SceneLoopPlugin=SceneLoopPlugin_decorate([uiFolder("Scene Loop")],SceneLoopPlugin);class NBuf3{constructor(o){this.top=0,this.array=new Float32Array(o)}write(o){this.array[this.top++]=o.x,this.array[this.top++]=o.y,this.array[this.top++]=o.z}}class NBuf2{constructor(o){this.top=0,this.array=new Float32Array(o)}write(o){this.array[this.top++]=o.x,this.array[this.top++]=o.y}}class Node_Node{constructor(o){this.plane=null,this.front=null,this.back=null,this.polygons=[],o&&this.build(o)}clone(){const o=new Node_Node;return o.plane=this.plane&&this.plane.clone(),o.front=this.front&&this.front.clone(),o.back=this.back&&this.back.clone(),o.polygons=this.polygons.map(l=>l.clone()),o}invert(){for(let l=0;l<this.polygons.length;l++)this.polygons[l].flip();this.plane&&this.plane.flip(),this.front&&this.front.invert(),this.back&&this.back.invert();const o=this.front;this.front=this.back,this.back=o}clipPolygons(o){if(!this.plane)return o.slice();let l=new Array,c=new Array;for(let u=0;u<o.length;u++)this.plane.splitPolygon(o[u],l,c,l,c);return this.front&&(l=this.front.clipPolygons(l)),c=this.back?this.back.clipPolygons(c):[],l.concat(c)}clipTo(o){this.polygons=o.clipPolygons(this.polygons),this.front&&this.front.clipTo(o),this.back&&this.back.clipTo(o)}allPolygons(){let o=this.polygons.slice();return this.front&&(o=o.concat(this.front.allPolygons())),this.back&&(o=o.concat(this.back.allPolygons())),o}build(o){if(!o.length)return;this.plane||(this.plane=o[0].plane.clone());const l=[],c=[];for(let u=0;u<o.length;u++)this.plane.splitPolygon(o[u],this.polygons,this.polygons,l,c);l.length&&(this.front||(this.front=new Node_Node),this.front.build(l)),c.length&&(this.back||(this.back=new Node_Node),this.back.build(c))}}class Vector{constructor(o=0,l=0,c=0){this.x=o,this.y=l,this.z=c}copy(o){return this.x=o.x,this.y=o.y,this.z=o.z,this}clone(){return new Vector(this.x,this.y,this.z)}negate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}add(o){return this.x+=o.x,this.y+=o.y,this.z+=o.z,this}sub(o){return this.x-=o.x,this.y-=o.y,this.z-=o.z,this}times(o){return this.x*=o,this.y*=o,this.z*=o,this}dividedBy(o){return this.x/=o,this.y/=o,this.z/=o,this}lerp(o,l){return this.add(new Vector().copy(o).sub(this).times(l))}unit(){return this.dividedBy(this.length())}length(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2)+Math.pow(this.z,2))}normalize(){return this.unit()}cross(o){const l=this.clone(),c=l.x,u=l.y,h=l.z,_=o.x,A=o.y,w=o.z;return this.x=u*w-h*A,this.y=h*_-c*w,this.z=c*A-u*_,this}dot(o){return this.x*o.x+this.y*o.y+this.z*o.z}toVector3(){return new three_module.Pq0(this.x,this.y,this.z)}}class Plane{constructor(o,l){this.normal=o,this.w=l,this.normal=o,this.w=l}clone(){return new Plane(this.normal.clone(),this.w)}flip(){this.normal.negate(),this.w=-this.w}splitPolygon(o,l,c,u,h){let _=0;const A=[];for(let w=0;w<o.vertices.length;w++){const C=this.normal.dot(o.vertices[w].pos)-this.w,M=C<-Plane.EPSILON?2:C>Plane.EPSILON?1:0;_|=M,A.push(M)}switch(_){case 0:(this.normal.dot(o.plane.normal)>0?l:c).push(o);break;case 1:u.push(o);break;case 2:h.push(o);break;case 3:{const w=[],C=[];for(let M=0;M<o.vertices.length;M++){const O=(M+1)%o.vertices.length,ne=A[M],ce=A[O],ue=o.vertices[M],ye=o.vertices[O];if(ne!=2&&w.push(ue),ne!=1&&C.push(ne!=2?ue.clone():ue),(ne|ce)==3){const Oe=(this.w-this.normal.dot(ue.pos))/this.normal.dot(new Vector().copy(ye.pos).sub(ue.pos)),ke=ue.interpolate(ye,Oe);w.push(ke),C.push(ke.clone())}}w.length>=3&&u.push(new Polygon(w,o.shared)),C.length>=3&&h.push(new Polygon(C,o.shared));break}}}static fromPoints(o,l,c){const u=new Vector().copy(l).sub(o).cross(new Vector().copy(c).sub(o)).normalize();return new Plane(u.clone(),u.dot(o))}}Plane.EPSILON=1e-5;class Polygon{constructor(o,l){this.vertices=o,this.shared=l,this.plane=Plane.fromPoints(o[0].pos,o[1].pos,o[2].pos)}clone(){return new Polygon(this.vertices.map(o=>o.clone()),this.shared)}flip(){this.vertices.reverse().map(o=>o.flip()),this.plane.flip()}}class Vertex{constructor(o,l,c,u){this.pos=new Vector().copy(o),this.normal=new Vector().copy(l),this.uv=new Vector().copy(c),this.uv.z=0,u&&(this.color=new Vector().copy(u))}clone(){return new Vertex(this.pos,this.normal,this.uv,this.color)}flip(){this.normal.negate()}interpolate(o,l){return new Vertex(this.pos.clone().lerp(o.pos,l),this.normal.clone().lerp(o.normal,l),this.uv.clone().lerp(o.uv,l),this.color&&o.color&&this.color.clone().lerp(o.color,l))}}class CSG{constructor(){this.polygons=new Array}static fromPolygons(o){const l=new CSG;return l.polygons=o,l}static fromGeometry(o,l){let c=[];const u=o.attributes.position,h=o.attributes.normal,_=o.attributes.uv,A=o.attributes.color,w=o.groups;let C;if(o.index)C=o.index.array;else{C=new Array(u.array.length/u.itemSize|0);for(let O=0;O<C.length;O++)C[O]=O}const M=C.length/3|0;c=new Array(M);for(let O=0,ne=0,ce=C.length;O<ce;O+=3,ne++){const ue=new Array(3);for(let ye=0;ye<3;ye++){const Oe=C[O+ye],ke=3*Oe,Ve=2*Oe,tt=u.array[ke],ht=u.array[ke+1],ut=u.array[ke+2],_t=h.array[ke],at=h.array[ke+1],lt=h.array[ke+2],pt=_==null?void 0:_.array[Ve],xt=_==null?void 0:_.array[Ve+1];ue[ye]=new Vertex(new Vector(tt,ht,ut),new Vector(_t,at,lt),new Vector(pt,xt,0),A&&new Vector(A.array[Ve],A.array[Ve+1],A.array[Ve+2]))}if(l===void 0&&w&&w.length>0)for(const ye of w)O>=ye.start&&O<ye.start+ye.count&&(c[ne]=new Polygon(ue,ye.materialIndex));else c[ne]=new Polygon(ue,l)}return CSG.fromPolygons(c.filter(O=>!isNaN(O.plane.normal.x)))}static toGeometry(o,l){let c=0;const u=o.polygons;for(const ce of u)c+=ce.vertices.length-2;const h=new three_module.LoY,_=new NBuf3(3*c*3),A=new NBuf3(3*c*3),w=new NBuf2(2*c*3);let C;const M=[],O=[];for(const ce of u){const ue=ce.vertices,ye=ue.length;ce.shared!==void 0&&(M[ce.shared]||(M[ce.shared]=[])),ye&&ue[0].color!==void 0&&(C||(C=new NBuf3(3*c*3)));for(let Oe=3;Oe<=ye;Oe++)(ce.shared===void 0?O:M[ce.shared]).push(_.top/3,_.top/3+1,_.top/3+2),_.write(ue[0].pos),_.write(ue[Oe-2].pos),_.write(ue[Oe-1].pos),A.write(ue[0].normal),A.write(ue[Oe-2].normal),A.write(ue[Oe-1].normal),w&&(w.write(ue[0].uv),w.write(ue[Oe-2].uv),w.write(ue[Oe-1].uv)),C&&(C.write(ue[0].color),C.write(ue[Oe-2].color),C.write(ue[Oe-1].color))}h.setAttribute("position",new three_module.THS(_.array,3)),h.setAttribute("normal",new three_module.THS(A.array,3)),w&&h.setAttribute("uv",new three_module.THS(w.array,2)),C&&h.setAttribute("color",new three_module.THS(C.array,3));for(let ce=0;ce<M.length;ce++)M[ce]===void 0&&(M[ce]=[]);if(M.length){let ce=[],ue=0;for(let ye=0;ye<M.length;ye++)h.addGroup(ue,M[ye].length,ye),ue+=M[ye].length,ce=ce.concat(M[ye]);h.addGroup(ue,O.length,M.length),ce=ce.concat(O),h.setIndex(ce)}const ne=new three_module.kn4().copy(l).invert();return h.applyMatrix4(ne),h.computeBoundingSphere(),h.computeBoundingBox(),h}static fromMesh(o,l){const c=CSG.fromGeometry(o.geometry,l),u=new three_module.Pq0,h=new three_module.dwI;h.getNormalMatrix(o.matrix);for(let _=0;_<c.polygons.length;_++){const A=c.polygons[_];for(let w=0;w<A.vertices.length;w++){const C=A.vertices[w];C.pos.copy(u.copy(C.pos.toVector3()).applyMatrix4(o.matrix)),C.normal.copy(u.copy(C.normal.toVector3()).applyMatrix3(h))}}return c}static toMesh(o,l,c){const u=CSG.toGeometry(o,l),h=new three_module.eaF(u,c);return h.matrix.copy(l),h.matrix.decompose(h.position,h.quaternion,h.scale),h.rotation.setFromQuaternion(h.quaternion),h.updateMatrixWorld(),h.castShadow=h.receiveShadow=!0,h}static union(o,l){const c=CSG.fromMesh(o),u=CSG.fromMesh(l);return CSG.toMesh(c.union(u),o.matrix,o.material)}static subtract(o,l){const c=CSG.fromMesh(o),u=CSG.fromMesh(l);return CSG.toMesh(c.subtract(u),o.matrix,o.material)}static intersect(o,l){const c=CSG.fromMesh(o),u=CSG.fromMesh(l);return CSG.toMesh(c.intersect(u),o.matrix,o.material)}clone(){const o=new CSG;return o.polygons=this.polygons.map(l=>l.clone()).filter(l=>Number.isFinite(l.plane.w)),o}toPolygons(){return this.polygons}union(o){const l=new Node_Node(this.clone().polygons),c=new Node_Node(o.clone().polygons);return l.clipTo(c),c.clipTo(l),c.invert(),c.clipTo(l),c.invert(),l.build(c.allPolygons()),CSG.fromPolygons(l.allPolygons())}subtract(o){const l=new Node_Node(this.clone().polygons),c=new Node_Node(o.clone().polygons);return l.invert(),l.clipTo(c),c.clipTo(l),c.invert(),c.clipTo(l),c.invert(),l.build(c.allPolygons()),l.invert(),CSG.fromPolygons(l.allPolygons())}intersect(o){const l=new Node_Node(this.clone().polygons),c=new Node_Node(o.clone().polygons);return l.invert(),c.clipTo(l),c.invert(),l.clipTo(c),c.clipTo(l),l.build(c.allPolygons()),l.invert(),CSG.fromPolygons(l.allPolygons())}inverse(){const o=this.clone();for(const l of o.polygons)l.flip();return o}toMesh(o,l){return CSG.toMesh(this,o,l)}toGeometry(o){return CSG.toGeometry(this,o)}}var CSGPluginBase_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const csgOperations=["union","subtract","intersect"];class CSGPluginBase extends AViewerPlugin{constructor(){super(),this.enabled=!0,this.toJSON=void 0,this.dependencies=[PickingPlugin],this.rootMesh=new three_module.eaF,this.showResult=!1,this.csgSelectedEnabled=!1,this.csgSelectedOperation="union",this._csgNeedsUpdate=!1,this._csgVisible=!1,this._sceneUpdate=this._sceneUpdate.bind(this),this._preFrame=this._preFrame.bind(this),this.makeSelectedCSGBrush=this.makeSelectedCSGBrush.bind(this),this.refreshCSG=this.refreshCSG.bind(this),this._selectedObjectChanged=this._selectedObjectChanged.bind(this),this._updateSelectedProperties=this._updateSelectedProperties.bind(this),this.downloadObject=this.downloadObject.bind(this),this.exportObject=this.exportObject.bind(this)}async onAdded(o){var l;await super.onAdded(o),this.rootObject=await o.createObject3D(),this.rootObject.modelObject.add(this.rootMesh),o.scene.addEventListener("sceneUpdate",this._sceneUpdate),o.addEventListener("preFrame",this._preFrame),(l=o.getPlugin(PickingPlugin))===null||l===void 0||l.addEventListener("selectedObjectChanged",this._selectedObjectChanged)}async makeSelectedCSGBrush(){var o,l;const c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();c&&c.geometry&&(c.userData._isCSGMesh||(c.userData.csgBrush||(c.userData.csgBrush={enabled:!0,operation:"union"}),this._selectedObjectChanged()))}refreshCSG(){this._sceneUpdate()}async downloadObject(){const o=await this.exportObject();o&&N(o,"csg."+o.ext)}async exportObject(){var o,l;const c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("AssetExporterPlugin"))===null||l===void 0?void 0:l.exporter;if(!c||!this.rootObject)return;const u=this.rootMesh.visible;this.rootMesh.visible=!0;const h=await c.exportObject(this.rootObject.modelObject,{});return this.rootMesh.visible=u,h}_updateSelectedProperties(){var o,l;const c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();c&&c.userData.csgBrush&&(c.userData.csgBrush.enabled=this.csgSelectedEnabled,c.userData.csgBrush.operation=this.csgSelectedOperation)}_selectedObjectChanged(){var o,l,c,u,h,_,A,w;const C=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();C&&(this.csgSelectedEnabled=(u=(c=C.userData.csgBrush)===null||c===void 0?void 0:c.enabled)!==null&&u!==void 0&&u,this.csgSelectedOperation=(_=(h=C.userData.csgBrush)===null||h===void 0?void 0:h.operation)!==null&&_!==void 0?_:"union"),(w=(A=this.uiConfig)===null||A===void 0?void 0:A.uiRefresh)===null||w===void 0||w.call(A,"postFrame",!0)}_preFrame(){var o,l,c;if(!this.rootObject||!this._csgNeedsUpdate&&this._csgVisible===this.showResult)return;const u=this._findCSGMeshes();this._csgNeedsUpdate&&(this._csgNeedsUpdate=!1,(o=this.rootObject)===null||o===void 0||o.modelObject.updateMatrixWorld(!0),((l=this.rootMesh.userData.dispose)!==null&&l!==void 0?l:this.rootMesh.removeFromParent)(),this.rootMesh=this._buildCSGMesh(u)),this.rootMesh&&!this.rootMesh.parent&&((c=this.rootObject)===null||c===void 0||c.modelObject.add(this.rootMesh)),this.showResult?(u.forEach(h=>{h[0].visible=!1}),this.rootObject.visible=!0,this._csgVisible=!0,this.rootObject.setDirty()):(u.forEach(h=>{h[0].visible=!0}),this.rootObject.visible=!1,this._csgVisible=!1,this.rootObject.setDirty())}_findCSGMeshes(){var o;const l=[];return(o=this._viewer)===null||o===void 0||o.scene.traverse(c=>{var u;c.isMesh&&c.geometry&&(!((u=c.userData.csgBrush)===null||u===void 0)&&u.enabled)&&l.push([c,c.userData.csgBrush.operation])}),l}_sceneUpdate(o){var l,c;!((c=(l=o==null?void 0:o.object)===null||l===void 0?void 0:l.userData)===null||c===void 0)&&c._isCSGMesh||(this._csgNeedsUpdate=!0)}}CSGPluginBase_decorate([uiToggle("Show Result",d=>({onChange:()=>{var o;return(o=d._viewer)===null||o===void 0?void 0:o.setDirty()}}))],CSGPluginBase.prototype,"showResult",void 0),CSGPluginBase_decorate([uiButton("Make CSG Brush",d=>({hidden:()=>{var o,l;const c=(l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();return!(c!=null&&c.userData)||!!c.userData.csgBrush||c.userData._isCSGMesh}}))],CSGPluginBase.prototype,"makeSelectedCSGBrush",null),CSGPluginBase_decorate([uiToggle("Enabled",d=>({hidden:()=>{var o,l;const c=(l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();return!c||!c.userData.csgBrush},onChange:d._updateSelectedProperties}))],CSGPluginBase.prototype,"csgSelectedEnabled",void 0),CSGPluginBase_decorate([uiDropdown("Operation",csgOperations.map(d=>({label:d})),d=>({hidden:()=>{var o,l;const c=(l=(o=d._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();return!c||!c.userData.csgBrush},onChange:d._updateSelectedProperties}))],CSGPluginBase.prototype,"csgSelectedOperation",void 0),CSGPluginBase_decorate([uiButton("Refresh CSG")],CSGPluginBase.prototype,"refreshCSG",null),CSGPluginBase_decorate([uiButton("Export Result",d=>({hidden:()=>{var o;return!(!((o=d._viewer)===null||o===void 0)&&o.getPluginByType("AssetExporterPlugin"))}}))],CSGPluginBase.prototype,"downloadObject",null);var CSGPluginBSP_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};function buildCSGMeshBSP(d,o){let l=new CSG;const c=d.map(h=>h[0].material).flatMap(h=>h);d.forEach(([h,_])=>{if(!csgOperations.includes(_))return void console.error(`Unknown operation ${_}`);h.updateMatrix(),h.updateMatrixWorld();const A=h.matrix;h.matrix=h.matrixWorld;let w=0;w=Array.isArray(h.material)?void 0:c.indexOf(h.material),l=l[_](CSG.fromMesh(h,w)),h.matrix=A});const u=l.toMesh(o??new three_module.kn4().identity(),c);return u.userData._isCSGMesh=!0,u.geometry.groups=u.geometry.groups.filter(h=>h.count>0),u}let CSGPluginBSP=class extends CSGPluginBase{_buildCSGMesh(d){return buildCSGMeshBSP(d)}};CSGPluginBSP.PluginType="CSGPluginBSP",CSGPluginBSP=CSGPluginBSP_decorate([uiFolder("CSG Plugin (BSP)")],CSGPluginBSP);const ADDITION=0,SUBTRACTION=1,REVERSE_SUBTRACTION=2,INTERSECTION=3,DIFFERENCE=4,HOLLOW_SUBTRACTION=5,HOLLOW_INTERSECTION=6;class SeparatingAxisBounds{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(o,l){let c=1/0,u=-1/0;for(let h=0,_=o.length;h<_;h++){const A=o[h][l];c=A<c?A:c,u=A>u?A:u}this.min=c,this.max=u}setFromPoints(o,l){let c=1/0,u=-1/0;for(let h=0,_=l.length;h<_;h++){const A=l[h],w=o.dot(A);c=w<c?w:c,u=w>u?w:u}this.min=c,this.max=u}isSeparated(o){return this.min>o.max||o.min>this.max}}SeparatingAxisBounds.prototype.setFromBox=function(){const d=new three_module.Pq0;return function(o,l){const c=l.min,u=l.max;let h=1/0,_=-1/0;for(let A=0;A<=1;A++)for(let w=0;w<=1;w++)for(let C=0;C<=1;C++){d.x=c.x*A+u.x*(1-A),d.y=c.y*w+u.y*(1-w),d.z=c.z*C+u.z*(1-C);const M=o.dot(d);h=Math.min(M,h),_=Math.max(M,_)}this.min=h,this.max=_}}();const closestPointLineToLine=function(){const d=new three_module.Pq0,o=new three_module.Pq0,l=new three_module.Pq0;return function(c,u,h){const _=c.start,A=d,w=u.start,C=o;l.subVectors(_,w),d.subVectors(c.end,c.start),o.subVectors(u.end,u.start);const M=l.dot(C),O=C.dot(A),ne=C.dot(C),ce=l.dot(A),ue=A.dot(A)*ne-O*O;let ye,Oe;ye=ue!==0?(M*O-ce*ne)/ue:0,Oe=(M+ye*O)/ne,h.x=ye,h.y=Oe}}(),closestPointsSegmentToSegment=function(){const d=new three_module.I9Y,o=new three_module.Pq0,l=new three_module.Pq0;return function(c,u,h,_){closestPointLineToLine(c,u,d);let A=d.x,w=d.y;if(A>=0&&A<=1&&w>=0&&w<=1)return c.at(A,h),void u.at(w,_);if(A>=0&&A<=1)return w<0?u.at(0,_):u.at(1,_),void c.closestPointToPoint(_,!0,h);if(w>=0&&w<=1)return A<0?c.at(0,h):c.at(1,h),void u.closestPointToPoint(h,!0,_);{let C,M;C=A<0?c.start:c.end,M=w<0?u.start:u.end;const O=o,ne=l;return c.closestPointToPoint(M,!0,o),u.closestPointToPoint(C,!0,l),O.distanceToSquared(M)<=ne.distanceToSquared(C)?(h.copy(O),void _.copy(M)):(h.copy(C),void _.copy(ne))}}}(),sphereIntersectTriangle=function(){const d=new three_module.Pq0,o=new three_module.Pq0,l=new three_module.Zcv,c=new three_module.cZY;return function(u,h){const{radius:_,center:A}=u,{a:w,b:C,c:M}=h;if(c.start=w,c.end=C,c.closestPointToPoint(A,!0,d).distanceTo(A)<=_||(c.start=w,c.end=M,c.closestPointToPoint(A,!0,d).distanceTo(A)<=_)||(c.start=C,c.end=M,c.closestPointToPoint(A,!0,d).distanceTo(A)<=_))return!0;const O=h.getPlane(l);if(Math.abs(O.distanceToPoint(A))<=_){const ne=O.projectPoint(A,o);if(h.containsPoint(ne))return!0}return!1}}(),ZERO_EPSILON=1e-15;function isNearZero(d){return Math.abs(d)<ZERO_EPSILON}class ExtendedTriangle extends three_module.lMl{constructor(...o){super(...o),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new three_module.Pq0),this.satBounds=new Array(4).fill().map(()=>new SeparatingAxisBounds),this.points=[this.a,this.b,this.c],this.sphere=new three_module.iyt,this.plane=new three_module.Zcv,this.needsUpdate=!0}intersectsSphere(o){return sphereIntersectTriangle(o,this)}update(){const o=this.a,l=this.b,c=this.c,u=this.points,h=this.satAxes,_=this.satBounds,A=h[0],w=_[0];this.getNormal(A),w.setFromPoints(A,u);const C=h[1],M=_[1];C.subVectors(o,l),M.setFromPoints(C,u);const O=h[2],ne=_[2];O.subVectors(l,c),ne.setFromPoints(O,u);const ce=h[3],ue=_[3];ce.subVectors(c,o),ue.setFromPoints(ce,u),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(A,o),this.needsUpdate=!1}}ExtendedTriangle.prototype.closestPointToSegment=function(){const d=new three_module.Pq0,o=new three_module.Pq0,l=new three_module.cZY;return function(c,u=null,h=null){const{start:_,end:A}=c,w=this.points;let C,M=1/0;for(let O=0;O<3;O++){const ne=(O+1)%3;l.start.copy(w[O]),l.end.copy(w[ne]),closestPointsSegmentToSegment(l,c,d,o),C=d.distanceToSquared(o),C<M&&(M=C,u&&u.copy(d),h&&h.copy(o))}return this.closestPointToPoint(_,d),C=_.distanceToSquared(d),C<M&&(M=C,u&&u.copy(d),h&&h.copy(_)),this.closestPointToPoint(A,d),C=A.distanceToSquared(d),C<M&&(M=C,u&&u.copy(d),h&&h.copy(A)),Math.sqrt(M)}}(),ExtendedTriangle.prototype.intersectsTriangle=function(){const d=new ExtendedTriangle,o=new Array(3),l=new Array(3),c=new SeparatingAxisBounds,u=new SeparatingAxisBounds,h=new three_module.Pq0,_=new three_module.Pq0,A=new three_module.Pq0,w=new three_module.Pq0,C=new three_module.Pq0,M=new three_module.cZY,O=new three_module.cZY,ne=new three_module.cZY,ce=new three_module.Pq0;function ue(ye,Oe,ke){const Ve=ye.points;let tt=0,ht=-1;for(let ut=0;ut<3;ut++){const{start:_t,end:at}=M;_t.copy(Ve[ut]),at.copy(Ve[(ut+1)%3]),M.delta(_);const lt=isNearZero(Oe.distanceToPoint(_t));if(isNearZero(Oe.normal.dot(_))&&lt){ke.copy(M),tt=2;break}const pt=Oe.intersectLine(M,ce);if(!pt&&lt&&ce.copy(_t),(pt||lt)&&!isNearZero(ce.distanceTo(at))){if(tt<=1)(tt===1?ke.start:ke.end).copy(ce),lt&&(ht=tt);else if(tt>=2){(ht===1?ke.start:ke.end).copy(ce),tt=2;break}if(tt++,tt===2&&ht===-1)break}}return tt}return function(ye,Oe=null,ke=!1){this.needsUpdate&&this.update(),ye.isExtendedTriangle?ye.needsUpdate&&ye.update():(d.copy(ye),d.update(),ye=d);const Ve=this.plane,tt=ye.plane;if(Math.abs(Ve.normal.dot(tt.normal))>1-1e-10){const ht=this.satBounds,ut=this.satAxes;l[0]=ye.a,l[1]=ye.b,l[2]=ye.c;for(let lt=0;lt<4;lt++){const pt=ht[lt],xt=ut[lt];if(c.setFromPoints(xt,l),pt.isSeparated(c))return!1}const _t=ye.satBounds,at=ye.satAxes;o[0]=this.a,o[1]=this.b,o[2]=this.c;for(let lt=0;lt<4;lt++){const pt=_t[lt],xt=at[lt];if(c.setFromPoints(xt,o),pt.isSeparated(c))return!1}for(let lt=0;lt<4;lt++){const pt=ut[lt];for(let xt=0;xt<4;xt++){const Tt=at[xt];if(h.crossVectors(pt,Tt),c.setFromPoints(h,o),u.setFromPoints(h,l),c.isSeparated(u))return!1}}return Oe&&(ke||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),Oe.start.set(0,0,0),Oe.end.set(0,0,0)),!0}{const ht=ue(this,tt,O);if(ht===1&&ye.containsPoint(O.end))return Oe&&(Oe.start.copy(O.end),Oe.end.copy(O.end)),!0;if(ht!==2)return!1;const ut=ue(ye,Ve,ne);if(ut===1&&this.containsPoint(ne.end))return Oe&&(Oe.start.copy(ne.end),Oe.end.copy(ne.end)),!0;if(ut!==2)return!1;if(O.delta(A),ne.delta(w),A.dot(w)<0){let xt=ne.start;ne.start=ne.end,ne.end=xt}const _t=O.start.dot(A),at=O.end.dot(A),lt=ne.start.dot(A),pt=ne.end.dot(A);return(_t===pt||lt===at||at<lt!=_t<pt)&&(Oe&&(C.subVectors(O.start,ne.start),C.dot(A)>0?Oe.start.copy(O.start):Oe.start.copy(ne.start),C.subVectors(O.end,ne.end),C.dot(A)<0?Oe.end.copy(O.end):Oe.end.copy(ne.end)),!0)}}}(),ExtendedTriangle.prototype.distanceToPoint=function(){const d=new three_module.Pq0;return function(o){return this.closestPointToPoint(o,d),o.distanceTo(d)}}(),ExtendedTriangle.prototype.distanceToTriangle=function(){const d=new three_module.Pq0,o=new three_module.Pq0,l=["a","b","c"],c=new three_module.cZY,u=new three_module.cZY;return function(h,_=null,A=null){const w=_||A?c:null;if(this.intersectsTriangle(h,w))return(_||A)&&(_&&w.getCenter(_),A&&w.getCenter(A)),0;let C=1/0;for(let M=0;M<3;M++){let O;const ne=l[M],ce=h[ne];this.closestPointToPoint(ce,d),O=ce.distanceToSquared(d),O<C&&(C=O,_&&_.copy(d),A&&A.copy(ce));const ue=this[ne];h.closestPointToPoint(ue,d),O=ue.distanceToSquared(d),O<C&&(C=O,_&&_.copy(ue),A&&A.copy(d))}for(let M=0;M<3;M++){const O=l[M],ne=l[(M+1)%3];c.set(this[O],this[ne]);for(let ce=0;ce<3;ce++){const ue=l[ce],ye=l[(ce+1)%3];u.set(h[ue],h[ye]),closestPointsSegmentToSegment(c,u,d,o);const Oe=d.distanceToSquared(o);Oe<C&&(C=Oe,_&&_.copy(d),A&&A.copy(o))}}return Math.sqrt(C)}}();const EPSILON=1e-14,_AB=new three_module.Pq0,_AC=new three_module.Pq0,_CB=new three_module.Pq0;function isTriDegenerate(d,o=EPSILON){_AB.subVectors(d.b,d.a),_AC.subVectors(d.c,d.a),_CB.subVectors(d.b,d.c);const l=_AB.angleTo(_AC),c=_AB.angleTo(_CB),u=Math.PI-l-c;return Math.abs(l)<o||Math.abs(c)<o||Math.abs(u)<o||d.a.distanceToSquared(d.b)<o||d.a.distanceToSquared(d.c)<o||d.b.distanceToSquared(d.c)<o}const TriangleSplitter_EPSILON=1e-10,COPLANAR_EPSILON=1e-10,PARALLEL_EPSILON=1e-10,_edge=new three_module.cZY,_foundEdge=new three_module.cZY,_vec=new three_module.Pq0,_triangleNormal=new three_module.Pq0,_planeNormal=new three_module.Pq0,TriangleSplitter_plane=new three_module.Zcv,_splittingTriangle=new ExtendedTriangle;class TrianglePool{constructor(){this._pool=[],this._index=0}getTriangle(){return this._index>=this._pool.length&&this._pool.push(new three_module.lMl),this._pool[this._index++]}clear(){this._index=0}reset(){this._pool.length=0,this._index=0}}class TriangleSplitter{constructor(){this.trianglePool=new TrianglePool,this.triangles=[],this.normal=new three_module.Pq0,this.coplanarTriangleUsed=!1}initialize(o){this.reset();const{triangles:l,trianglePool:c,normal:u}=this;if(Array.isArray(o))for(let h=0,_=o.length;h<_;h++){const A=o[h];if(h===0)A.getNormal(u);else if(Math.abs(1-A.getNormal(_vec).dot(u))>TriangleSplitter_EPSILON)throw new Error("Triangle Splitter: Cannot initialize with triangles that have different normals.");const w=c.getTriangle();w.copy(A),l.push(w)}else{o.getNormal(u);const h=c.getTriangle();h.copy(o),l.push(h)}}splitByTriangle(o){const{normal:l,triangles:c}=this;if(o.getNormal(_triangleNormal).normalize(),Math.abs(1-Math.abs(_triangleNormal.dot(l)))<PARALLEL_EPSILON){this.coplanarTriangleUsed=!0;for(let h=0,_=c.length;h<_;h++)c[h].coplanarCount=0;const u=[o.a,o.b,o.c];for(let h=0;h<3;h++){const _=(h+1)%3,A=u[h],w=u[_];_vec.subVectors(w,A).normalize(),_planeNormal.crossVectors(_triangleNormal,_vec),TriangleSplitter_plane.setFromNormalAndCoplanarPoint(_planeNormal,A),this.splitByPlane(TriangleSplitter_plane,o)}}else o.getPlane(TriangleSplitter_plane),this.splitByPlane(TriangleSplitter_plane,o)}splitByPlane(o,l){const{triangles:c,trianglePool:u}=this;_splittingTriangle.copy(l),_splittingTriangle.needsUpdate=!0;for(let h=0,_=c.length;h<_;h++){const A=c[h];if(!_splittingTriangle.intersectsTriangle(A,_edge,!0))continue;const{a:w,b:C,c:M}=A;let O=0,ne=-1,ce=!1,ue=[],ye=[];const Oe=[w,C,M];for(let ke=0;ke<3;ke++){const Ve=(ke+1)%3;_edge.start.copy(Oe[ke]),_edge.end.copy(Oe[Ve]);const tt=o.distanceToPoint(_edge.start),ht=o.distanceToPoint(_edge.end);if(Math.abs(tt)<COPLANAR_EPSILON&&Math.abs(ht)<COPLANAR_EPSILON){ce=!0;break}if(tt>0?ue.push(ke):ye.push(ke),Math.abs(tt)<COPLANAR_EPSILON)continue;let ut=!!o.intersectLine(_edge,_vec);!ut&&Math.abs(ht)<COPLANAR_EPSILON&&(_vec.copy(_edge.end),ut=!0),!ut||_vec.distanceTo(_edge.start)<TriangleSplitter_EPSILON||(_vec.distanceTo(_edge.end)<TriangleSplitter_EPSILON&&(ne=ke),O===0?_foundEdge.start.copy(_vec):_foundEdge.end.copy(_vec),O++)}if(!ce&&O===2&&_foundEdge.distance()>COPLANAR_EPSILON)if(ne!==-1){ne=(ne+1)%3;let ke=0;ke===ne&&(ke=(ke+1)%3);let Ve=ke+1;Ve===ne&&(Ve=(Ve+1)%3);const tt=u.getTriangle();tt.a.copy(Oe[Ve]),tt.b.copy(_foundEdge.end),tt.c.copy(_foundEdge.start),isTriDegenerate(tt)||c.push(tt),A.a.copy(Oe[ke]),A.b.copy(_foundEdge.start),A.c.copy(_foundEdge.end),isTriDegenerate(A)&&(c.splice(h,1),h--,_--)}else{const ke=ue.length>=2?ye[0]:ue[0];if(ke===0){let _t=_foundEdge.start;_foundEdge.start=_foundEdge.end,_foundEdge.end=_t}const Ve=(ke+1)%3,tt=(ke+2)%3,ht=u.getTriangle(),ut=u.getTriangle();Oe[Ve].distanceToSquared(_foundEdge.start)<Oe[tt].distanceToSquared(_foundEdge.end)?(ht.a.copy(Oe[Ve]),ht.b.copy(_foundEdge.start),ht.c.copy(_foundEdge.end),ut.a.copy(Oe[Ve]),ut.b.copy(Oe[tt]),ut.c.copy(_foundEdge.start)):(ht.a.copy(Oe[tt]),ht.b.copy(_foundEdge.start),ht.c.copy(_foundEdge.end),ut.a.copy(Oe[Ve]),ut.b.copy(Oe[tt]),ut.c.copy(_foundEdge.end)),A.a.copy(Oe[ke]),A.b.copy(_foundEdge.end),A.c.copy(_foundEdge.start),isTriDegenerate(ht)||c.push(ht),isTriDegenerate(ut)||c.push(ut),isTriDegenerate(A)&&(c.splice(h,1),h--,_--)}else O===3&&console.warn("TriangleClipper: Coplanar clip not handled")}}reset(){this.triangles.length=0,this.trianglePool.clear(),this.coplanarTriangleUsed=!1}}function areSharedArrayBuffersSupported(){return typeof SharedArrayBuffer<"u"}function convertToSharedArrayBuffer(d){if(d.buffer instanceof SharedArrayBuffer)return d;const o=d.constructor,l=d.buffer,c=new SharedArrayBuffer(l.byteLength),u=new Uint8Array(l);return new Uint8Array(c).set(u,0),new o(c)}function getIndexArray(d,o=ArrayBuffer){return d>65535?new Uint32Array(new o(4*d)):new Uint16Array(new o(2*d))}function ensureIndex(d,o){if(!d.index){const l=d.attributes.position.count,c=getIndexArray(l,o.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);d.setIndex(new three_module.THS(c,1));for(let u=0;u<l;u++)c[u]=u}}function getVertexCount(d){return d.index?d.index.count:d.attributes.position.count}function getTriCount(d){return getVertexCount(d)/3}function ceilToFourByteStride(d){return 4+(d=~~d)-d%4}class TypeBackedArray{constructor(o,l=500){this.expansionFactor=1.5,this.type=o,this.length=0,this.array=null,this.setSize(l)}setType(o){if(this.length!==0)throw new Error("TypeBackedArray: Cannot change the type while there is used data in the buffer.");const l=this.array.buffer;this.array=new o(l),this.type=o}setSize(o){if(this.array&&o===this.array.length)return;const l=this.type,c=new l(new(areSharedArrayBuffersSupported()?SharedArrayBuffer:ArrayBuffer)(ceilToFourByteStride(o*l.BYTES_PER_ELEMENT)));this.array&&c.set(this.array,0),this.array=c}expand(){const{array:o,expansionFactor:l}=this;this.setSize(o.length*l)}push(...o){let{array:l,length:c}=this;c+o.length>l.length&&(this.expand(),l=this.array);for(let u=0,h=o.length;u<h;u++)l[c+u]=o[u];this.length+=o.length}clear(){this.length=0}}class TypedAttributeData{constructor(){this.groupAttributes=[{}],this.groupCount=0}getType(o){return this.groupAttributes[0][o].type}getItemSize(o){return this.groupAttributes[0][o].itemSize}getNormalized(o){return this.groupAttributes[0][o].normalized}getCount(o){if(this.groupCount<=o)return 0;const l=this.getGroupAttrArray("position",o);return l.length/l.itemSize}getTotalLength(o){const{groupCount:l,groupAttributes:c}=this;let u=0;for(let h=0;h<l;h++)u+=c[h][o].length;return u}getGroupAttrSet(o=0){const{groupAttributes:l}=this;if(l[o])return this.groupCount=Math.max(this.groupCount,o+1),l[o];const c=l[0];for(this.groupCount=Math.max(this.groupCount,o+1);o>=l.length;){const u={};l.push(u);for(const h in c){const _=c[h],A=new TypeBackedArray(_.type);A.itemSize=_.itemSize,A.normalized=_.normalized,u[h]=A}}return l[o]}getGroupAttrArray(o,l=0){const{groupAttributes:c}=this;if(!c[0][o])throw new Error(`TypedAttributeData: Attribute with "${o}" has not been initialized`);return this.getGroupAttrSet(l)[o]}initializeArray(o,l,c,u){const{groupAttributes:h}=this,_=h[0][o];if(_){if(_.type!==l)for(let A=0,w=h.length;A<w;A++){const C=h[A][o];C.setType(l),C.itemSize=c,C.normalized=u}}else for(let A=0,w=h.length;A<w;A++){const C=new TypeBackedArray(l);C.itemSize=c,C.normalized=u,h[A][o]=C}}clear(){this.groupCount=0;const{groupAttributes:o}=this;o.forEach(l=>{for(const c in l)l[c].clear()})}delete(o){this.groupAttributes.forEach(l=>{delete l[o]})}reset(){this.groupAttributes=[],this.groupCount=0}}class IntersectionMap{constructor(){this.intersectionSet={},this.ids=[]}add(o,l){const{intersectionSet:c,ids:u}=this;c[o]||(c[o]=[],u.push(o)),c[o].push(l)}}const operationsUtils_ray=new three_module.RlV,operationsUtils_matrix=new three_module.kn4,_tri=new three_module.lMl,_vec3=new three_module.Pq0,_vec4a=new three_module.IUQ,_vec4b=new three_module.IUQ,_vec4c=new three_module.IUQ,_vec4_0=new three_module.IUQ,_vec4_1=new three_module.IUQ,_vec4_2=new three_module.IUQ,operationsUtils_edge=new three_module.cZY,_normal=new three_module.Pq0,JITTER_EPSILON=1e-8,OFFSET_EPSILON=1e-15,BACK_SIDE=-1,FRONT_SIDE=1,COPLANAR_OPPOSITE=-2,COPLANAR_ALIGNED=2,INVERT_TRI=0,ADD_TRI=1,SKIP_TRI=2,FLOATING_COPLANAR_EPSILON=1e-14;let _debugContext=null;function setDebugContext(d){_debugContext=d}function getHitSide(d,o){d.getMidpoint(operationsUtils_ray.origin),d.getNormal(operationsUtils_ray.direction);const l=o.raycastFirst(operationsUtils_ray,three_module.$EB);return l&&operationsUtils_ray.direction.dot(l.face.normal)>0?BACK_SIDE:FRONT_SIDE}function getHitSideWithCoplanarCheck(d,o){function l(){return Math.random()-.5}d.getNormal(_normal),operationsUtils_ray.direction.copy(_normal),d.getMidpoint(operationsUtils_ray.origin);let c=0,u=1/0;for(let h=0;h<3;h++){operationsUtils_ray.direction.x+=l()*JITTER_EPSILON,operationsUtils_ray.direction.y+=l()*JITTER_EPSILON,operationsUtils_ray.direction.z+=l()*JITTER_EPSILON,operationsUtils_ray.direction.multiplyScalar(-1);const _=o.raycastFirst(operationsUtils_ray,three_module.$EB);if(_&&operationsUtils_ray.direction.dot(_.face.normal)>0&&c++,_!==null&&(u=Math.min(u,_.distance)),u<=OFFSET_EPSILON)return _.face.normal.dot(_normal)>0?COPLANAR_ALIGNED:COPLANAR_OPPOSITE;if(c/3>.5||(h-c+1)/3>.5)break}return c/3>.5?BACK_SIDE:FRONT_SIDE}function collectIntersectingTriangles(d,o){const l=new IntersectionMap,c=new IntersectionMap;return operationsUtils_matrix.copy(d.matrixWorld).invert().multiply(o.matrixWorld),d.geometry.boundsTree.bvhcast(o.geometry.boundsTree,operationsUtils_matrix,{intersectsTriangles(u,h,_,A){if(!isTriDegenerate(u)&&!isTriDegenerate(h)){let w=u.intersectsTriangle(h,operationsUtils_edge,!0);if(!w){const C=u.plane,M=h.plane,O=C.normal,ne=M.normal;O.dot(ne)===1&&Math.abs(C.constant-M.constant)<FLOATING_COPLANAR_EPSILON&&(w=!0)}if(w){let C=d.geometry.boundsTree.resolveTriangleIndex(_),M=o.geometry.boundsTree.resolveTriangleIndex(A);l.add(C,M),c.add(M,C),_debugContext&&(_debugContext.addEdge(operationsUtils_edge),_debugContext.addIntersectingTriangles(_,u,A,h))}}return!1}}),{aIntersections:l,bIntersections:c}}function appendAttributeFromTriangle(d,o,l,c,u,h,_=!1){const A=l.attributes,w=l.index,C=3*d,M=w.getX(C+0),O=w.getX(C+1),ne=w.getX(C+2);for(const ce in h){const ue=A[ce],ye=h[ce];if(!(ce in A))throw new Error(`CSG Operations: Attribute ${ce} not available on geometry.`);const Oe=ue.itemSize;ce==="position"?(_tri.a.fromBufferAttribute(ue,M).applyMatrix4(c),_tri.b.fromBufferAttribute(ue,O).applyMatrix4(c),_tri.c.fromBufferAttribute(ue,ne).applyMatrix4(c),pushBarycoordInterpolatedValues(_tri.a,_tri.b,_tri.c,o,3,ye,_)):ce==="normal"?(_tri.a.fromBufferAttribute(ue,M).applyNormalMatrix(u),_tri.b.fromBufferAttribute(ue,O).applyNormalMatrix(u),_tri.c.fromBufferAttribute(ue,ne).applyNormalMatrix(u),_&&(_tri.a.multiplyScalar(-1),_tri.b.multiplyScalar(-1),_tri.c.multiplyScalar(-1)),pushBarycoordInterpolatedValues(_tri.a,_tri.b,_tri.c,o,3,ye,_,!0)):(_vec4a.fromBufferAttribute(ue,M),_vec4b.fromBufferAttribute(ue,O),_vec4c.fromBufferAttribute(ue,ne),pushBarycoordInterpolatedValues(_vec4a,_vec4b,_vec4c,o,Oe,ye,_))}}function appendAttributesFromIndices(d,o,l,c,u,h,_,A=!1){appendAttributeFromIndex(d,c,u,h,_,A),appendAttributeFromIndex(A?l:o,c,u,h,_,A),appendAttributeFromIndex(A?o:l,c,u,h,_,A)}function getOperationAction(d,o,l=!1){switch(d){case ADDITION:if(o===FRONT_SIDE||o===COPLANAR_ALIGNED&&!l)return ADD_TRI;break;case SUBTRACTION:if(l){if(o===BACK_SIDE)return INVERT_TRI}else if(o===FRONT_SIDE||o===COPLANAR_OPPOSITE)return ADD_TRI;break;case REVERSE_SUBTRACTION:if(l){if(o===FRONT_SIDE||o===COPLANAR_OPPOSITE)return ADD_TRI}else if(o===BACK_SIDE)return INVERT_TRI;break;case DIFFERENCE:if(o===BACK_SIDE)return INVERT_TRI;if(o===FRONT_SIDE)return ADD_TRI;break;case INTERSECTION:if(o===BACK_SIDE||o===COPLANAR_ALIGNED&&!l)return ADD_TRI;break;case HOLLOW_SUBTRACTION:if(!l&&(o===FRONT_SIDE||o===COPLANAR_OPPOSITE))return ADD_TRI;break;case HOLLOW_INTERSECTION:if(!l&&(o===BACK_SIDE||o===COPLANAR_ALIGNED))return ADD_TRI;break;default:throw new Error(`Unrecognized CSG operation enum "${d}".`)}return SKIP_TRI}function pushBarycoordInterpolatedValues(d,o,l,c,u,h,_=!1,A=!1){const w=C=>{h.push(C.x),u>1&&h.push(C.y),u>2&&h.push(C.z),u>3&&h.push(C.w)};_vec4_0.set(0,0,0,0).addScaledVector(d,c.a.x).addScaledVector(o,c.a.y).addScaledVector(l,c.a.z),_vec4_1.set(0,0,0,0).addScaledVector(d,c.b.x).addScaledVector(o,c.b.y).addScaledVector(l,c.b.z),_vec4_2.set(0,0,0,0).addScaledVector(d,c.c.x).addScaledVector(o,c.c.y).addScaledVector(l,c.c.z),A&&(_vec4_0.normalize(),_vec4_1.normalize(),_vec4_2.normalize()),w(_vec4_0),_?(w(_vec4_2),w(_vec4_1)):(w(_vec4_1),w(_vec4_2))}function appendAttributeFromIndex(d,o,l,c,u,h=!1){for(const _ in u){const A=o[_],w=u[_];if(!(_ in o))throw new Error(`CSG Operations: Attribute ${_} no available on geometry.`);const C=A.itemSize;_==="position"?(_vec3.fromBufferAttribute(A,d).applyMatrix4(l),w.push(_vec3.x,_vec3.y,_vec3.z)):_==="normal"?(_vec3.fromBufferAttribute(A,d).applyNormalMatrix(c),h&&_vec3.multiplyScalar(-1),w.push(_vec3.x,_vec3.y,_vec3.z)):(w.push(A.getX(d)),C>1&&w.push(A.getY(d)),C>2&&w.push(A.getZ(d)),C>3&&w.push(A.getW(d)))}}class TriangleIntersectData{constructor(o){this.triangle=new three_module.lMl().copy(o),this.intersects={}}addTriangle(o,l){this.intersects[o]=new three_module.lMl().copy(l)}getIntersectArray(){const o=[],{intersects:l}=this;for(const c in l)o.push(l[c]);return o}}class TriangleIntersectionSets{constructor(){this.data={}}addTriangleIntersection(o,l,c,u){const{data:h}=this;h[o]||(h[o]=new TriangleIntersectData(l)),h[o].addTriangle(c,u)}getTrianglesAsArray(o=null){const{data:l}=this,c=[];if(o!==null)o in l&&c.push(l[o].triangle);else for(const u in l)c.push(l[u].triangle);return c}getTriangleIndices(){return Object.keys(this.data).map(o=>parseInt(o))}getIntersectionIndices(o){const{data:l}=this;return l[o]?Object.keys(l[o].intersects).map(c=>parseInt(c)):[]}getIntersectionsAsArray(o=null,l=null){const{data:c}=this,u=new Set,h=[],_=A=>{if(c[A])if(l!==null)c[A].intersects[l]&&h.push(c[A].intersects[l]);else{const w=c[A].intersects;for(const C in w)u.has(C)||(u.add(C),h.push(w[C]))}};if(o!==null)_(o);else for(const A in c)_(A);return h}reset(){this.data={}}}class OperationDebugData{constructor(){this.enabled=!1,this.triangleIntersectsA=new TriangleIntersectionSets,this.triangleIntersectsB=new TriangleIntersectionSets,this.intersectionEdges=[]}addIntersectingTriangles(o,l,c,u){const{triangleIntersectsA:h,triangleIntersectsB:_}=this;h.addTriangleIntersection(o,l,c,u),_.addTriangleIntersection(c,u,o,l)}addEdge(o){this.intersectionEdges.push(o.clone())}reset(){this.triangleIntersectsA.reset(),this.triangleIntersectsB.reset(),this.intersectionEdges=[]}init(){this.enabled&&(this.reset(),setDebugContext(this))}complete(){this.enabled&&setDebugContext(null)}}const operations_matrix=new three_module.kn4,_normalMatrix=new three_module.dwI,_triA=new three_module.lMl,_triB=new three_module.lMl,operations_tri=new three_module.lMl,_barycoordTri=new three_module.lMl,_attr=[],_actions=[];function getFirstIdFromSet(d){for(const o of d)return o}function performOperation(d,o,l,c,u,h={}){const{useGroups:_=!0}=h,{aIntersections:A,bIntersections:w}=collectIntersectingTriangles(d,o);let C;return C=_?0:-1,performSplitTriangleOperations(d,o,A,l,!1,c,u,C),performWholeTriangleOperations(d,o,A,l,!1,u,C),l.findIndex(M=>M!==HOLLOW_INTERSECTION&&M!==HOLLOW_SUBTRACTION)!==-1&&(C=_?d.geometry.groups.length||1:-1,performSplitTriangleOperations(o,d,w,l,!0,c,u,C),performWholeTriangleOperations(o,d,w,l,!0,u,C)),_attr.length=0,_actions.length=0,{groups:[],materials:null}}function performSplitTriangleOperations(d,o,l,c,u,h,_,A=0){const w=d.matrixWorld.determinant()<0;operations_matrix.copy(o.matrixWorld).invert().multiply(d.matrixWorld),_normalMatrix.getNormalMatrix(d.matrixWorld).multiplyScalar(w?-1:1);const C=d.geometry.groupIndices,M=d.geometry.index,O=d.geometry.attributes.position,ne=o.geometry.boundsTree,ce=o.geometry.index,ue=o.geometry.attributes.position,ye=l.ids,Oe=l.intersectionSet;for(let ke=0,Ve=ye.length;ke<Ve;ke++){const tt=ye[ke],ht=A===-1?0:C[tt]+A,ut=3*tt,_t=M.getX(ut+0),at=M.getX(ut+1),lt=M.getX(ut+2);_triA.a.fromBufferAttribute(O,_t).applyMatrix4(operations_matrix),_triA.b.fromBufferAttribute(O,at).applyMatrix4(operations_matrix),_triA.c.fromBufferAttribute(O,lt).applyMatrix4(operations_matrix),h.reset(),h.initialize(_triA);const pt=Oe[tt];for(let Tt=0,Pt=pt.length;Tt<Pt;Tt++){const Lt=3*pt[Tt],Bt=ce.getX(Lt+0),Ut=ce.getX(Lt+1),kt=ce.getX(Lt+2);_triB.a.fromBufferAttribute(ue,Bt),_triB.b.fromBufferAttribute(ue,Ut),_triB.c.fromBufferAttribute(ue,kt),h.splitByTriangle(_triB)}const xt=h.triangles;for(let Tt=0,Pt=xt.length;Tt<Pt;Tt++){const Lt=xt[Tt],Bt=h.coplanarTriangleUsed?getHitSideWithCoplanarCheck(Lt,ne):getHitSide(Lt,ne);_attr.length=0,_actions.length=0;for(let Ut=0,kt=c.length;Ut<kt;Ut++){const Vt=getOperationAction(c[Ut],Bt,u);Vt!==SKIP_TRI&&(_actions.push(Vt),_attr.push(_[Ut].getGroupAttrSet(ht)))}if(_attr.length!==0){_triA.getBarycoord(Lt.a,_barycoordTri.a),_triA.getBarycoord(Lt.b,_barycoordTri.b),_triA.getBarycoord(Lt.c,_barycoordTri.c);for(let Ut=0,kt=_attr.length;Ut<kt;Ut++){const Vt=_attr[Ut],si=_actions[Ut]===INVERT_TRI;appendAttributeFromTriangle(tt,_barycoordTri,d.geometry,d.matrixWorld,_normalMatrix,Vt,w!==si)}}}}return ye.length}function performWholeTriangleOperations(d,o,l,c,u,h,_=0){const A=d.matrixWorld.determinant()<0;operations_matrix.copy(o.matrixWorld).invert().multiply(d.matrixWorld),_normalMatrix.getNormalMatrix(d.matrixWorld).multiplyScalar(A?-1:1);const w=o.geometry.boundsTree,C=d.geometry.groupIndices,M=d.geometry.index,O=d.geometry.attributes,ne=O.position,ce=[],ue=d.geometry.halfEdges,ye=new Set;for(let Oe=0,ke=getTriCount(d.geometry);Oe<ke;Oe++)Oe in l.intersectionSet||ye.add(Oe);for(;ye.size>0;){const Oe=getFirstIdFromSet(ye);ye.delete(Oe),ce.push(Oe);const ke=3*Oe,Ve=M.getX(ke+0),tt=M.getX(ke+1),ht=M.getX(ke+2);operations_tri.a.fromBufferAttribute(ne,Ve).applyMatrix4(operations_matrix),operations_tri.b.fromBufferAttribute(ne,tt).applyMatrix4(operations_matrix),operations_tri.c.fromBufferAttribute(ne,ht).applyMatrix4(operations_matrix);const ut=getHitSide(operations_tri,w);_actions.length=0,_attr.length=0;for(let _t=0,at=c.length;_t<at;_t++){const lt=getOperationAction(c[_t],ut,u);lt!==SKIP_TRI&&(_actions.push(lt),_attr.push(h[_t]))}for(;ce.length>0;){const _t=ce.pop();for(let at=0;at<3;at++){const lt=ue.getSiblingTriangleIndex(_t,at);lt!==-1&&ye.has(lt)&&(ce.push(lt),ye.delete(lt))}if(_attr.length!==0){const at=3*_t,lt=M.getX(at+0),pt=M.getX(at+1),xt=M.getX(at+2),Tt=_===-1?0:C[_t]+_;if(operations_tri.a.fromBufferAttribute(ne,lt),operations_tri.b.fromBufferAttribute(ne,pt),operations_tri.c.fromBufferAttribute(ne,xt),!isTriDegenerate(operations_tri))for(let Pt=0,Lt=_attr.length;Pt<Lt;Pt++){const Bt=_actions[Pt],Ut=_attr[Pt].getGroupAttrSet(Tt),kt=Bt===INVERT_TRI;appendAttributesFromIndices(lt,pt,xt,O,d.matrixWorld,_normalMatrix,Ut,kt!==A)}}}}}const CENTER=0,AVERAGE=1,SAH=2,CONTAINED=2,TRIANGLE_INTERSECT_COST=1.25,TRAVERSAL_COST=1,BYTES_PER_NODE=32,IS_LEAFNODE_FLAG=65535,FLOAT32_EPSILON=Math.pow(2,-24),SKIP_GENERATION=Symbol("SKIP_GENERATION");function geometryUtils_getVertexCount(d){return d.index?d.index.count:d.attributes.position.count}function geometryUtils_getTriCount(d){return geometryUtils_getVertexCount(d)/3}function geometryUtils_getIndexArray(d,o=ArrayBuffer){return d>65535?new Uint32Array(new o(4*d)):new Uint16Array(new o(2*d))}function geometryUtils_ensureIndex(d,o){if(!d.index){const l=d.attributes.position.count,c=geometryUtils_getIndexArray(l,o.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);d.setIndex(new three_module.THS(c,1));for(let u=0;u<l;u++)c[u]=u}}function getFullGeometryRange(d){const o=geometryUtils_getTriCount(d),l=d.drawRange,c=l.start/3,u=(l.start+l.count)/3,h=Math.max(0,c),_=Math.min(o,u)-h;return[{offset:Math.floor(h),count:Math.floor(_)}]}function getRootIndexRanges(d){if(!d.groups||!d.groups.length)return getFullGeometryRange(d);const o=[],l=new Set,c=d.drawRange,u=c.start/3,h=(c.start+c.count)/3;for(const A of d.groups){const w=A.start/3,C=(A.start+A.count)/3;l.add(Math.max(u,w)),l.add(Math.min(h,C))}const _=Array.from(l.values()).sort((A,w)=>A-w);for(let A=0;A<_.length-1;A++){const w=_[A],C=_[A+1];o.push({offset:Math.floor(w),count:Math.floor(C-w)})}return o}function hasGroupGaps(d){if(d.groups.length===0)return!1;const o=geometryUtils_getTriCount(d),l=getRootIndexRanges(d).sort((h,_)=>h.offset-_.offset),c=l[l.length-1];c.count=Math.min(o-c.offset,c.count);let u=0;return l.forEach(({count:h})=>u+=h),o!==u}function arrayToBox(d,o,l){return l.min.x=o[d],l.min.y=o[d+1],l.min.z=o[d+2],l.max.x=o[d+3],l.max.y=o[d+4],l.max.z=o[d+5],l}function makeEmptyBounds(d){d[0]=d[1]=d[2]=1/0,d[3]=d[4]=d[5]=-1/0}function getLongestEdgeIndex(d){let o=-1,l=-1/0;for(let c=0;c<3;c++){const u=d[c+3]-d[c];u>l&&(l=u,o=c)}return o}function copyBounds(d,o){o.set(d)}function unionBounds(d,o,l){let c,u;for(let h=0;h<3;h++){const _=h+3;c=d[h],u=o[h],l[h]=c<u?c:u,c=d[_],u=o[_],l[_]=c>u?c:u}}function expandByTriangleBounds(d,o,l){for(let c=0;c<3;c++){const u=o[d+2*c],h=o[d+2*c+1],_=u-h,A=u+h;_<l[c]&&(l[c]=_),A>l[c+3]&&(l[c+3]=A)}}function computeSurfaceArea(d){const o=d[3]-d[0],l=d[4]-d[1],c=d[5]-d[2];return 2*(o*l+l*c+c*o)}function computeBoundsUtils_getBounds(d,o,l,c,u=null){let h=1/0,_=1/0,A=1/0,w=-1/0,C=-1/0,M=-1/0,O=1/0,ne=1/0,ce=1/0,ue=-1/0,ye=-1/0,Oe=-1/0;const ke=u!==null;for(let Ve=6*o,tt=6*(o+l);Ve<tt;Ve+=6){const ht=d[Ve+0],ut=d[Ve+1],_t=ht-ut,at=ht+ut;_t<h&&(h=_t),at>w&&(w=at),ke&&ht<O&&(O=ht),ke&&ht>ue&&(ue=ht);const lt=d[Ve+2],pt=d[Ve+3],xt=lt-pt,Tt=lt+pt;xt<_&&(_=xt),Tt>C&&(C=Tt),ke&&lt<ne&&(ne=lt),ke&&lt>ye&&(ye=lt);const Pt=d[Ve+4],Lt=d[Ve+5],Bt=Pt-Lt,Ut=Pt+Lt;Bt<A&&(A=Bt),Ut>M&&(M=Ut),ke&&Pt<ce&&(ce=Pt),ke&&Pt>Oe&&(Oe=Pt)}c[0]=h,c[1]=_,c[2]=A,c[3]=w,c[4]=C,c[5]=M,ke&&(u[0]=O,u[1]=ne,u[2]=ce,u[3]=ue,u[4]=ye,u[5]=Oe)}function getCentroidBounds(d,o,l,c){let u=1/0,h=1/0,_=1/0,A=-1/0,w=-1/0,C=-1/0;for(let M=6*o,O=6*(o+l);M<O;M+=6){const ne=d[M+0];ne<u&&(u=ne),ne>A&&(A=ne);const ce=d[M+2];ce<h&&(h=ce),ce>w&&(w=ce);const ue=d[M+4];ue<_&&(_=ue),ue>C&&(C=ue)}c[0]=u,c[1]=h,c[2]=_,c[3]=A,c[4]=w,c[5]=C}function computeTriangleBounds(d,o){makeEmptyBounds(o);const l=d.attributes.position,c=d.index?d.index.array:null,u=geometryUtils_getTriCount(d),h=new Float32Array(6*u),_=l.normalized,A=l.array,w=l.offset||0;let C=3;l.isInterleavedBufferAttribute&&(C=l.data.stride);const M=["getX","getY","getZ"];for(let O=0;O<u;O++){const ne=3*O,ce=6*O;let ue=ne+0,ye=ne+1,Oe=ne+2;c&&(ue=c[ue],ye=c[ye],Oe=c[Oe]),_||(ue=ue*C+w,ye=ye*C+w,Oe=Oe*C+w);for(let ke=0;ke<3;ke++){let Ve,tt,ht;_?(Ve=l[M[ke]](ue),tt=l[M[ke]](ye),ht=l[M[ke]](Oe)):(Ve=A[ue+ke],tt=A[ye+ke],ht=A[Oe+ke]);let ut=Ve;tt<ut&&(ut=tt),ht<ut&&(ut=ht);let _t=Ve;tt>_t&&(_t=tt),ht>_t&&(_t=ht);const at=(_t-ut)/2,lt=2*ke;h[ce+lt+0]=ut+at,h[ce+lt+1]=at+(Math.abs(ut)+at)*FLOAT32_EPSILON,ut<o[ke]&&(o[ke]=ut),_t>o[ke+3]&&(o[ke+3]=_t)}}return h}const BIN_COUNT=32,binsSort=(d,o)=>d.candidate-o.candidate,sahBins=new Array(BIN_COUNT).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),leftBounds=new Float32Array(6);function getOptimalSplit(d,o,l,c,u,h){let _=-1,A=0;if(h===CENTER)_=getLongestEdgeIndex(o),_!==-1&&(A=(o[_]+o[_+3])/2);else if(h===AVERAGE)_=getLongestEdgeIndex(d),_!==-1&&(A=getAverage(l,c,u,_));else if(h===SAH){const w=computeSurfaceArea(d);let C=TRIANGLE_INTERSECT_COST*u;const M=6*c,O=6*(c+u);for(let ne=0;ne<3;ne++){const ce=o[ne],ue=(o[ne+3]-ce)/BIN_COUNT;if(u<BIN_COUNT/4){const ye=[...sahBins];ye.length=u;let Oe=0;for(let Ve=M;Ve<O;Ve+=6,Oe++){const tt=ye[Oe];tt.candidate=l[Ve+2*ne],tt.count=0;const{bounds:ht,leftCacheBounds:ut,rightCacheBounds:_t}=tt;for(let at=0;at<3;at++)_t[at]=1/0,_t[at+3]=-1/0,ut[at]=1/0,ut[at+3]=-1/0,ht[at]=1/0,ht[at+3]=-1/0;expandByTriangleBounds(Ve,l,ht)}ye.sort(binsSort);let ke=u;for(let Ve=0;Ve<ke;Ve++){const tt=ye[Ve];for(;Ve+1<ke&&ye[Ve+1].candidate===tt.candidate;)ye.splice(Ve+1,1),ke--}for(let Ve=M;Ve<O;Ve+=6){const tt=l[Ve+2*ne];for(let ht=0;ht<ke;ht++){const ut=ye[ht];tt>=ut.candidate?expandByTriangleBounds(Ve,l,ut.rightCacheBounds):(expandByTriangleBounds(Ve,l,ut.leftCacheBounds),ut.count++)}}for(let Ve=0;Ve<ke;Ve++){const tt=ye[Ve],ht=tt.count,ut=u-tt.count,_t=tt.leftCacheBounds,at=tt.rightCacheBounds;let lt=0;ht!==0&&(lt=computeSurfaceArea(_t)/w);let pt=0;ut!==0&&(pt=computeSurfaceArea(at)/w);const xt=TRAVERSAL_COST+TRIANGLE_INTERSECT_COST*(lt*ht+pt*ut);xt<C&&(_=ne,C=xt,A=tt.candidate)}}else{for(let ke=0;ke<BIN_COUNT;ke++){const Ve=sahBins[ke];Ve.count=0,Ve.candidate=ce+ue+ke*ue;const tt=Ve.bounds;for(let ht=0;ht<3;ht++)tt[ht]=1/0,tt[ht+3]=-1/0}for(let ke=M;ke<O;ke+=6){let Ve=~~((l[ke+2*ne]-ce)/ue);Ve>=BIN_COUNT&&(Ve=BIN_COUNT-1);const tt=sahBins[Ve];tt.count++,expandByTriangleBounds(ke,l,tt.bounds)}const ye=sahBins[BIN_COUNT-1];copyBounds(ye.bounds,ye.rightCacheBounds);for(let ke=BIN_COUNT-2;ke>=0;ke--){const Ve=sahBins[ke],tt=sahBins[ke+1];unionBounds(Ve.bounds,tt.rightCacheBounds,Ve.rightCacheBounds)}let Oe=0;for(let ke=0;ke<BIN_COUNT-1;ke++){const Ve=sahBins[ke],tt=Ve.count,ht=Ve.bounds,ut=sahBins[ke+1].rightCacheBounds;tt!==0&&(Oe===0?copyBounds(ht,leftBounds):unionBounds(ht,leftBounds,leftBounds)),Oe+=tt;let _t=0,at=0;Oe!==0&&(_t=computeSurfaceArea(leftBounds)/w);const lt=u-Oe;lt!==0&&(at=computeSurfaceArea(ut)/w);const pt=TRAVERSAL_COST+TRIANGLE_INTERSECT_COST*(_t*Oe+at*lt);pt<C&&(_=ne,C=pt,A=Ve.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${h} used.`);return{axis:_,pos:A}}function getAverage(d,o,l,c){let u=0;for(let h=o,_=o+l;h<_;h++)u+=d[6*h+2*c];return u/l}class MeshBVHNode{constructor(){}}function partition(d,o,l,c,u,h){let _=c,A=c+u-1;const w=h.pos,C=2*h.axis;for(;;){for(;_<=A&&l[6*_+C]<w;)_++;for(;_<=A&&l[6*A+C]>=w;)A--;if(!(_<A))return _;for(let M=0;M<3;M++){let O=o[3*_+M];o[3*_+M]=o[3*A+M],o[3*A+M]=O}for(let M=0;M<6;M++){let O=l[6*_+M];l[6*_+M]=l[6*A+M],l[6*A+M]=O}_++,A--}}function partition_indirect(d,o,l,c,u,h){let _=c,A=c+u-1;const w=h.pos,C=2*h.axis;for(;;){for(;_<=A&&l[6*_+C]<w;)_++;for(;_<=A&&l[6*A+C]>=w;)A--;if(!(_<A))return _;{let M=d[_];d[_]=d[A],d[A]=M;for(let O=0;O<6;O++){let ne=l[6*_+O];l[6*_+O]=l[6*A+O],l[6*A+O]=ne}_++,A--}}}function generateIndirectBuffer(d,o){const l=(d.index?d.index.count:d.attributes.position.count)/3,c=l>65536,u=c?4:2,h=o?new SharedArrayBuffer(l*u):new ArrayBuffer(l*u),_=c?new Uint32Array(h):new Uint16Array(h);for(let A=0,w=_.length;A<w;A++)_[A]=A;return _}function buildTree(d,o){const l=d.geometry,c=l.index?l.index.array:null,u=o.maxDepth,h=o.verbose,_=o.maxLeafTris,A=o.strategy,w=o.onProgress,C=geometryUtils_getTriCount(l),M=d._indirectBuffer;let O=!1;const ne=new Float32Array(6),ce=new Float32Array(6),ue=computeTriangleBounds(l,ne),ye=o.indirect?partition_indirect:partition,Oe=[],ke=o.indirect?getFullGeometryRange(l):getRootIndexRanges(l);if(ke.length===1){const ht=ke[0],ut=new MeshBVHNode;ut.boundingData=ne,getCentroidBounds(ue,ht.offset,ht.count,ce),tt(ut,ht.offset,ht.count,ce),Oe.push(ut)}else for(let ht of ke){const ut=new MeshBVHNode;ut.boundingData=new Float32Array(6),computeBoundsUtils_getBounds(ue,ht.offset,ht.count,ut.boundingData,ce),tt(ut,ht.offset,ht.count,ce),Oe.push(ut)}return Oe;function Ve(ht){w&&w(ht/C)}function tt(ht,ut,_t,at=null,lt=0){if(!O&&lt>=u&&(O=!0,h&&(console.warn(`MeshBVH: Max depth of ${u} reached when generating BVH. Consider increasing maxDepth.`),console.warn(l))),_t<=_||lt>=u)return Ve(ut+_t),ht.offset=ut,ht.count=_t,ht;const pt=getOptimalSplit(ht.boundingData,at,ue,ut,_t,A);if(pt.axis===-1)return Ve(ut+_t),ht.offset=ut,ht.count=_t,ht;const xt=ye(M,c,ue,ut,_t,pt);if(xt===ut||xt===ut+_t)Ve(ut+_t),ht.offset=ut,ht.count=_t;else{ht.splitAxis=pt.axis;const Tt=new MeshBVHNode,Pt=ut,Lt=xt-ut;ht.left=Tt,Tt.boundingData=new Float32Array(6),computeBoundsUtils_getBounds(ue,Pt,Lt,Tt.boundingData,ce),tt(Tt,Pt,Lt,ce,lt+1);const Bt=new MeshBVHNode,Ut=xt,kt=_t-Lt;ht.right=Bt,Bt.boundingData=new Float32Array(6),computeBoundsUtils_getBounds(ue,Ut,kt,Bt.boundingData,ce),tt(Bt,Ut,kt,ce,lt+1)}return ht}}function buildPackedTree(d,o){const l=d.geometry;o.indirect&&(d._indirectBuffer=generateIndirectBuffer(l,o.useSharedArrayBuffer),hasGroupGaps(l)&&!o.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),d._indirectBuffer||geometryUtils_ensureIndex(l,o);const c=buildTree(d,o);let u,h,_;const A=[],w=o.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let O=0;O<c.length;O++){const ne=c[O];let ce=C(ne);const ue=new w(BYTES_PER_NODE*ce);u=new Float32Array(ue),h=new Uint32Array(ue),_=new Uint16Array(ue),M(0,ne),A.push(ue)}return void(d._roots=A);function C(O){return O.count?1:1+C(O.left)+C(O.right)}function M(O,ne){const ce=O/4,ue=O/2,ye=!!ne.count,Oe=ne.boundingData;for(let ke=0;ke<6;ke++)u[ce+ke]=Oe[ke];if(ye){const ke=ne.offset,Ve=ne.count;return h[ce+6]=ke,_[ue+14]=Ve,_[ue+15]=IS_LEAFNODE_FLAG,O+BYTES_PER_NODE}{const ke=ne.left,Ve=ne.right,tt=ne.splitAxis;let ht;if(ht=M(O+BYTES_PER_NODE,ke),ht/4>Math.pow(2,32))throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return h[ce+6]=ht/4,ht=M(ht,Ve),h[ce+7]=tt,ht}}}class OrientedBox{constructor(o,l,c){this.isOrientedBox=!0,this.min=new three_module.Pq0,this.max=new three_module.Pq0,this.matrix=new three_module.kn4,this.invMatrix=new three_module.kn4,this.points=new Array(8).fill().map(()=>new three_module.Pq0),this.satAxes=new Array(3).fill().map(()=>new three_module.Pq0),this.satBounds=new Array(3).fill().map(()=>new SeparatingAxisBounds),this.alignedSatBounds=new Array(3).fill().map(()=>new SeparatingAxisBounds),this.needsUpdate=!1,o&&this.min.copy(o),l&&this.max.copy(l),c&&this.matrix.copy(c)}set(o,l,c){this.min.copy(o),this.max.copy(l),this.matrix.copy(c),this.needsUpdate=!0}copy(o){this.min.copy(o.min),this.max.copy(o.max),this.matrix.copy(o.matrix),this.needsUpdate=!0}}OrientedBox.prototype.update=function(){const d=this.matrix,o=this.min,l=this.max,c=this.points;for(let w=0;w<=1;w++)for(let C=0;C<=1;C++)for(let M=0;M<=1;M++){const O=c[1*w|2*C|4*M];O.x=w?l.x:o.x,O.y=C?l.y:o.y,O.z=M?l.z:o.z,O.applyMatrix4(d)}const u=this.satBounds,h=this.satAxes,_=c[0];for(let w=0;w<3;w++){const C=h[w],M=u[w],O=c[1<<w];C.subVectors(_,O),M.setFromPoints(C,c)}const A=this.alignedSatBounds;A[0].setFromPointsField(c,"x"),A[1].setFromPointsField(c,"y"),A[2].setFromPointsField(c,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},OrientedBox.prototype.intersectsBox=function(){const d=new SeparatingAxisBounds;return function(o){this.needsUpdate&&this.update();const l=o.min,c=o.max,u=this.satBounds,h=this.satAxes,_=this.alignedSatBounds;if(d.min=l.x,d.max=c.x,_[0].isSeparated(d)||(d.min=l.y,d.max=c.y,_[1].isSeparated(d))||(d.min=l.z,d.max=c.z,_[2].isSeparated(d)))return!1;for(let A=0;A<3;A++){const w=h[A],C=u[A];if(d.setFromBox(w,o),C.isSeparated(d))return!1}return!0}}(),OrientedBox.prototype.intersectsTriangle=function(){const d=new ExtendedTriangle,o=new Array(3),l=new SeparatingAxisBounds,c=new SeparatingAxisBounds,u=new three_module.Pq0;return function(h){this.needsUpdate&&this.update(),h.isExtendedTriangle?h.needsUpdate&&h.update():(d.copy(h),d.update(),h=d);const _=this.satBounds,A=this.satAxes;o[0]=h.a,o[1]=h.b,o[2]=h.c;for(let O=0;O<3;O++){const ne=_[O],ce=A[O];if(l.setFromPoints(ce,o),ne.isSeparated(l))return!1}const w=h.satBounds,C=h.satAxes,M=this.points;for(let O=0;O<3;O++){const ne=w[O],ce=C[O];if(l.setFromPoints(ce,M),ne.isSeparated(l))return!1}for(let O=0;O<3;O++){const ne=A[O];for(let ce=0;ce<4;ce++){const ue=C[ce];if(u.crossVectors(ne,ue),l.setFromPoints(u,o),c.setFromPoints(u,M),l.isSeparated(c))return!1}}return!0}}(),OrientedBox.prototype.closestPointToPoint=function(d,o){return this.needsUpdate&&this.update(),o.copy(d).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),o},OrientedBox.prototype.distanceToPoint=function(){const d=new three_module.Pq0;return function(o){return this.closestPointToPoint(o,d),o.distanceTo(d)}}(),OrientedBox.prototype.distanceToBox=function(){const d=["x","y","z"],o=new Array(12).fill().map(()=>new three_module.cZY),l=new Array(12).fill().map(()=>new three_module.cZY),c=new three_module.Pq0,u=new three_module.Pq0;return function(h,_=0,A=null,w=null){if(this.needsUpdate&&this.update(),this.intersectsBox(h))return(A||w)&&(h.getCenter(u),this.closestPointToPoint(u,c),h.closestPointToPoint(c,u),A&&A.copy(c),w&&w.copy(u)),0;const C=_*_,M=h.min,O=h.max,ne=this.points;let ce=1/0;for(let ye=0;ye<8;ye++){const Oe=ne[ye];u.copy(Oe).clamp(M,O);const ke=Oe.distanceToSquared(u);if(ke<ce&&(ce=ke,A&&A.copy(Oe),w&&w.copy(u),ke<C))return Math.sqrt(ke)}let ue=0;for(let ye=0;ye<3;ye++)for(let Oe=0;Oe<=1;Oe++)for(let ke=0;ke<=1;ke++){const Ve=(ye+1)%3,tt=(ye+2)%3,ht=1<<ye|Oe<<Ve|ke<<tt,ut=ne[Oe<<Ve|ke<<tt],_t=ne[ht];o[ue].set(ut,_t);const at=d[ye],lt=d[Ve],pt=d[tt],xt=l[ue],Tt=xt.start,Pt=xt.end;Tt[at]=M[at],Tt[lt]=Oe?M[lt]:O[lt],Tt[pt]=ke?M[pt]:O[lt],Pt[at]=O[at],Pt[lt]=Oe?M[lt]:O[lt],Pt[pt]=ke?M[pt]:O[lt],ue++}for(let ye=0;ye<=1;ye++)for(let Oe=0;Oe<=1;Oe++)for(let ke=0;ke<=1;ke++){u.x=ye?O.x:M.x,u.y=Oe?O.y:M.y,u.z=ke?O.z:M.z,this.closestPointToPoint(u,c);const Ve=u.distanceToSquared(c);if(Ve<ce&&(ce=Ve,A&&A.copy(c),w&&w.copy(u),Ve<C))return Math.sqrt(Ve)}for(let ye=0;ye<12;ye++){const Oe=o[ye];for(let ke=0;ke<12;ke++){const Ve=l[ke];closestPointsSegmentToSegment(Oe,Ve,c,u);const tt=c.distanceToSquared(u);if(tt<ce&&(ce=tt,A&&A.copy(c),w&&w.copy(u),tt<C))return Math.sqrt(tt)}}return Math.sqrt(ce)}}();class PrimitivePool{constructor(o){this._getNewPrimitive=o,this._primitives=[]}getPrimitive(){const o=this._primitives;return o.length===0?this._getNewPrimitive():o.pop()}releasePrimitive(o){this._primitives.push(o)}}class ExtendedTrianglePoolBase extends PrimitivePool{constructor(){super(()=>new ExtendedTriangle)}}const ExtendedTrianglePool=new ExtendedTrianglePoolBase;function IS_LEAF(d,o){return o[d+15]===65535}function OFFSET(d,o){return o[d+6]}function COUNT(d,o){return o[d+14]}function LEFT_NODE(d){return d+8}function RIGHT_NODE(d,o){return o[d+6]}function SPLIT_AXIS(d,o){return o[d+7]}function BOUNDING_DATA_INDEX(d){return d}class _BufferStack{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const o=[];let l=null;this.setBuffer=c=>{l&&o.push(l),l=c,this.float32Array=new Float32Array(c),this.uint16Array=new Uint16Array(c),this.uint32Array=new Uint32Array(c)},this.clearBuffer=()=>{l=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,o.length!==0&&this.setBuffer(o.pop())}}}const BufferStack=new _BufferStack;let _box1,_box2;const boxStack=[],boxPool=new PrimitivePool(()=>new three_module.NRn);function shapecast(d,o,l,c,u,h){_box1=boxPool.getPrimitive(),_box2=boxPool.getPrimitive(),boxStack.push(_box1,_box2),BufferStack.setBuffer(d._roots[o]);const _=shapecastTraverse(0,d.geometry,l,c,u,h);BufferStack.clearBuffer(),boxPool.releasePrimitive(_box1),boxPool.releasePrimitive(_box2),boxStack.pop(),boxStack.pop();const A=boxStack.length;return A>0&&(_box2=boxStack[A-1],_box1=boxStack[A-2]),_}function shapecastTraverse(d,o,l,c,u=null,h=0,_=0){const{float32Array:A,uint16Array:w,uint32Array:C}=BufferStack;let M=2*d;if(IS_LEAF(M,w)){const O=OFFSET(d,C),ne=COUNT(M,w);return arrayToBox(d,A,_box1),c(O,ne,!1,_,h+d,_box1)}{let at=function(pt){const{uint16Array:xt,uint32Array:Tt}=BufferStack;let Pt=2*pt;for(;!IS_LEAF(Pt,xt);)Pt=2*(pt=LEFT_NODE(pt));return OFFSET(pt,Tt)},lt=function(pt){const{uint16Array:xt,uint32Array:Tt}=BufferStack;let Pt=2*pt;for(;!IS_LEAF(Pt,xt);)Pt=2*(pt=RIGHT_NODE(pt,Tt));return OFFSET(pt,Tt)+COUNT(Pt,xt)};const O=LEFT_NODE(d),ne=RIGHT_NODE(d,C);let ce,ue,ye,Oe,ke=O,Ve=ne;if(u&&(ye=_box1,Oe=_box2,arrayToBox(ke,A,ye),arrayToBox(Ve,A,Oe),ce=u(ye),ue=u(Oe),ue<ce)){ke=ne,Ve=O;const pt=ce;ce=ue,ue=pt,ye=Oe}ye||(ye=_box1,arrayToBox(ke,A,ye));const tt=l(ye,IS_LEAF(2*ke,w),ce,_+1,h+ke);let ht;if(tt===CONTAINED){const pt=at(ke);ht=c(pt,lt(ke)-pt,!0,_+1,h+ke,ye)}else ht=tt&&shapecastTraverse(ke,o,l,c,u,h,_+1);if(ht)return!0;Oe=_box2,arrayToBox(Ve,A,Oe);const ut=l(Oe,IS_LEAF(2*Ve,w),ue,_+1,h+Ve);let _t;if(ut===CONTAINED){const pt=at(Ve);_t=c(pt,lt(Ve)-pt,!0,_+1,h+Ve,Oe)}else _t=ut&&shapecastTraverse(Ve,o,l,c,u,h,_+1);return!!_t}}const temp=new three_module.Pq0,temp1=new three_module.Pq0;function closestPointToPoint(d,o,l={},c=0,u=1/0){const h=c*c,_=u*u;let A=1/0,w=null;if(d.shapecast({boundsTraverseOrder:M=>(temp.copy(o).clamp(M.min,M.max),temp.distanceToSquared(o)),intersectsBounds:(M,O,ne)=>ne<A&&ne<_,intersectsTriangle:(M,O)=>{M.closestPointToPoint(o,temp);const ne=o.distanceToSquared(temp);return ne<A&&(temp1.copy(temp),A=ne,w=O),ne<h}}),A===1/0)return null;const C=Math.sqrt(A);return l.point?l.point.copy(temp1):l.point=temp1.clone(),l.distance=C,l.faceIndex=w,l}const ThreeRayIntersectUtilities_vA=new three_module.Pq0,ThreeRayIntersectUtilities_vB=new three_module.Pq0,ThreeRayIntersectUtilities_vC=new three_module.Pq0,_uvA=new three_module.I9Y,_uvB=new three_module.I9Y,_uvC=new three_module.I9Y,_normalA=new three_module.Pq0,_normalB=new three_module.Pq0,_normalC=new three_module.Pq0,_intersectionPoint=new three_module.Pq0;function checkIntersection(d,o,l,c,u,h){let _;return _=h===three_module.hsX?d.intersectTriangle(c,l,o,!0,u):d.intersectTriangle(o,l,c,h!==three_module.$EB,u),_===null?null:{distance:d.origin.distanceTo(u),point:u.clone()}}function checkBufferGeometryIntersection(d,o,l,c,u,h,_,A,w){ThreeRayIntersectUtilities_vA.fromBufferAttribute(o,h),ThreeRayIntersectUtilities_vB.fromBufferAttribute(o,_),ThreeRayIntersectUtilities_vC.fromBufferAttribute(o,A);const C=checkIntersection(d,ThreeRayIntersectUtilities_vA,ThreeRayIntersectUtilities_vB,ThreeRayIntersectUtilities_vC,_intersectionPoint,w);if(C){c&&(_uvA.fromBufferAttribute(c,h),_uvB.fromBufferAttribute(c,_),_uvC.fromBufferAttribute(c,A),C.uv=three_module.lMl.getInterpolation(_intersectionPoint,ThreeRayIntersectUtilities_vA,ThreeRayIntersectUtilities_vB,ThreeRayIntersectUtilities_vC,_uvA,_uvB,_uvC,new three_module.I9Y)),u&&(_uvA.fromBufferAttribute(u,h),_uvB.fromBufferAttribute(u,_),_uvC.fromBufferAttribute(u,A),C.uv1=three_module.lMl.getInterpolation(_intersectionPoint,ThreeRayIntersectUtilities_vA,ThreeRayIntersectUtilities_vB,ThreeRayIntersectUtilities_vC,_uvA,_uvB,_uvC,new three_module.I9Y)),l&&(_normalA.fromBufferAttribute(l,h),_normalB.fromBufferAttribute(l,_),_normalC.fromBufferAttribute(l,A),C.normal=three_module.lMl.getInterpolation(_intersectionPoint,ThreeRayIntersectUtilities_vA,ThreeRayIntersectUtilities_vB,ThreeRayIntersectUtilities_vC,_normalA,_normalB,_normalC,new three_module.Pq0),C.normal.dot(d.direction)>0&&C.normal.multiplyScalar(-1));const M={a:h,b:_,c:A,normal:new three_module.Pq0,materialIndex:0};three_module.lMl.getNormal(ThreeRayIntersectUtilities_vA,ThreeRayIntersectUtilities_vB,ThreeRayIntersectUtilities_vC,M.normal),C.face=M,C.faceIndex=h}return C}function intersectTri(d,o,l,c,u){const h=3*c;let _=h+0,A=h+1,w=h+2;const C=d.index;d.index&&(_=C.getX(_),A=C.getX(A),w=C.getX(w));const{position:M,normal:O,uv:ne,uv1:ce}=d.attributes,ue=checkBufferGeometryIntersection(l,M,O,ne,ce,_,A,w,o);return ue?(ue.faceIndex=c,u&&u.push(ue),ue):null}function setTriangle(d,o,l,c){const u=d.a,h=d.b,_=d.c;let A=o,w=o+1,C=o+2;l&&(A=l.getX(A),w=l.getX(w),C=l.getX(C)),u.x=c.getX(A),u.y=c.getY(A),u.z=c.getZ(A),h.x=c.getX(w),h.y=c.getY(w),h.z=c.getZ(w),_.x=c.getX(C),_.y=c.getY(C),_.z=c.getZ(C)}new three_module.Pq0;new three_module.Pq0;new three_module.Pq0;new three_module.I9Y;new three_module.I9Y;new three_module.I9Y;function intersectTris(d,o,l,c,u,h){const{geometry:_,_indirectBuffer:A}=d;for(let w=c,C=c+u;w<C;w++)intersectTri(_,o,l,w,h)}function intersectClosestTri(d,o,l,c,u){const{geometry:h,_indirectBuffer:_}=d;let A=1/0,w=null;for(let C=c,M=c+u;C<M;C++){let O;O=intersectTri(h,o,l,C),O&&O.distance<A&&(w=O,A=O.distance)}return w}function iterateOverTriangles(d,o,l,c,u,h,_){const{geometry:A}=l,{index:w}=A,C=A.attributes.position;for(let M=d,O=o+d;M<O;M++){let ne;if(ne=M,setTriangle(_,3*ne,w,C),_.needsUpdate=!0,c(_,ne,u,h))return!0}return!1}function refit(d,o=null){o&&Array.isArray(o)&&(o=new Set(o));const l=d.geometry,c=l.index?l.index.array:null,u=l.attributes.position;let h,_,A,w,C=0;const M=d._roots;for(let ne=0,ce=M.length;ne<ce;ne++)h=M[ne],_=new Uint32Array(h),A=new Uint16Array(h),w=new Float32Array(h),O(0,C),C+=h.byteLength;function O(ne,ce,ue=!1){const ye=2*ne;if(A[ye+15]===IS_LEAFNODE_FLAG){const Oe=_[ne+6];let ke=1/0,Ve=1/0,tt=1/0,ht=-1/0,ut=-1/0,_t=-1/0;for(let at=3*Oe,lt=3*(Oe+A[ye+14]);at<lt;at++){let pt=c[at];const xt=u.getX(pt),Tt=u.getY(pt),Pt=u.getZ(pt);xt<ke&&(ke=xt),xt>ht&&(ht=xt),Tt<Ve&&(Ve=Tt),Tt>ut&&(ut=Tt),Pt<tt&&(tt=Pt),Pt>_t&&(_t=Pt)}return(w[ne+0]!==ke||w[ne+1]!==Ve||w[ne+2]!==tt||w[ne+3]!==ht||w[ne+4]!==ut||w[ne+5]!==_t)&&(w[ne+0]=ke,w[ne+1]=Ve,w[ne+2]=tt,w[ne+3]=ht,w[ne+4]=ut,w[ne+5]=_t,!0)}{const Oe=ne+8,ke=_[ne+6],Ve=Oe+ce,tt=ke+ce;let ht=ue,ut=!1,_t=!1;o?ht||(ut=o.has(Ve),_t=o.has(tt),ht=!ut&&!_t):(ut=!0,_t=!0);const at=ht||_t;let lt=!1;(ht||ut)&&(lt=O(Oe,ce,ht));let pt=!1;at&&(pt=O(ke,ce,ht));const xt=lt||pt;if(xt)for(let Tt=0;Tt<3;Tt++){const Pt=Oe+Tt,Lt=ke+Tt,Bt=w[Pt],Ut=w[Pt+3],kt=w[Lt],Vt=w[Lt+3];w[ne+Tt]=Bt<kt?Bt:kt,w[ne+Tt+3]=Ut>Vt?Ut:Vt}return xt}}}const _boundingBox=new three_module.NRn;function intersectRay(d,o,l,c){return arrayToBox(d,o,_boundingBox),l.intersectBox(_boundingBox,c)}const _boxIntersection=new three_module.Pq0;function raycast(d,o,l,c,u){BufferStack.setBuffer(d._roots[o]),_raycast(0,d,l,c,u),BufferStack.clearBuffer()}function _raycast(d,o,l,c,u){const{float32Array:h,uint16Array:_,uint32Array:A}=BufferStack,w=2*d;if(IS_LEAF(w,_))intersectTris(o,l,c,OFFSET(d,A),COUNT(w,_),u);else{const C=LEFT_NODE(d);intersectRay(C,h,c,_boxIntersection)&&_raycast(C,o,l,c,u);const M=RIGHT_NODE(d,A);intersectRay(M,h,c,_boxIntersection)&&_raycast(M,o,l,c,u)}}const raycastFirst_generated_boxIntersection=new three_module.Pq0,_xyzFields=["x","y","z"];function raycastFirst(d,o,l,c){BufferStack.setBuffer(d._roots[o]);const u=_raycastFirst(0,d,l,c);return BufferStack.clearBuffer(),u}function _raycastFirst(d,o,l,c){const{float32Array:u,uint16Array:h,uint32Array:_}=BufferStack;let A=2*d;if(IS_LEAF(A,h))return intersectClosestTri(o,l,c,OFFSET(d,_),COUNT(A,h));{const w=SPLIT_AXIS(d,_),C=_xyzFields[w],M=c.direction[C]>=0;let O,ne;M?(O=LEFT_NODE(d),ne=RIGHT_NODE(d,_)):(O=RIGHT_NODE(d,_),ne=LEFT_NODE(d));const ce=intersectRay(O,u,c,raycastFirst_generated_boxIntersection)?_raycastFirst(O,o,l,c):null;if(ce){const ye=ce.point[C];if(M?ye<=u[ne+w]:ye>=u[ne+w+3])return ce}const ue=intersectRay(ne,u,c,raycastFirst_generated_boxIntersection)?_raycastFirst(ne,o,l,c):null;return ce&&ue?ce.distance<=ue.distance?ce:ue:ce||ue||null}}const boundingBox=new three_module.NRn,triangle=new ExtendedTriangle,triangle2=new ExtendedTriangle,invertedMat=new three_module.kn4,obb=new OrientedBox,obb2=new OrientedBox;function intersectsGeometry(d,o,l,c){BufferStack.setBuffer(d._roots[o]);const u=_intersectsGeometry(0,d,l,c);return BufferStack.clearBuffer(),u}function _intersectsGeometry(d,o,l,c,u=null){const{float32Array:h,uint16Array:_,uint32Array:A}=BufferStack;let w=2*d;if(u===null&&(l.boundingBox||l.computeBoundingBox(),obb.set(l.boundingBox.min,l.boundingBox.max,c),u=obb),!IS_LEAF(w,_)){const C=d+8,M=A[d+6];return arrayToBox(C,h,boundingBox),u.intersectsBox(boundingBox)&&_intersectsGeometry(C,o,l,c,u)?!0:(arrayToBox(M,h,boundingBox),!(!u.intersectsBox(boundingBox)||!_intersectsGeometry(M,o,l,c,u)))}{const C=o.geometry,M=C.index,O=C.attributes.position,ne=l.index,ce=l.attributes.position,ue=OFFSET(d,A),ye=COUNT(w,_);if(invertedMat.copy(c).invert(),l.boundsTree)return arrayToBox(d,h,obb2),obb2.matrix.copy(invertedMat),obb2.needsUpdate=!0,l.boundsTree.shapecast({intersectsBounds:ke=>obb2.intersectsBox(ke),intersectsTriangle:ke=>{ke.a.applyMatrix4(c),ke.b.applyMatrix4(c),ke.c.applyMatrix4(c),ke.needsUpdate=!0;for(let Ve=3*ue,tt=3*(ye+ue);Ve<tt;Ve+=3)if(setTriangle(triangle2,Ve,M,O),triangle2.needsUpdate=!0,ke.intersectsTriangle(triangle2))return!0;return!1}});for(let Oe=3*ue,ke=3*(ye+ue);Oe<ke;Oe+=3){setTriangle(triangle,Oe,M,O),triangle.a.applyMatrix4(invertedMat),triangle.b.applyMatrix4(invertedMat),triangle.c.applyMatrix4(invertedMat),triangle.needsUpdate=!0;for(let Ve=0,tt=ne.count;Ve<tt;Ve+=3)if(setTriangle(triangle2,Ve,ne,ce),triangle2.needsUpdate=!0,triangle.intersectsTriangle(triangle2))return!0}}}const tempMatrix=new three_module.kn4,closestPointToGeometry_generated_obb=new OrientedBox,closestPointToGeometry_generated_obb2=new OrientedBox,closestPointToGeometry_generated_temp1=new three_module.Pq0,temp2=new three_module.Pq0,temp3=new three_module.Pq0,temp4=new three_module.Pq0;function closestPointToGeometry(d,o,l,c={},u={},h=0,_=1/0){o.boundingBox||o.computeBoundingBox(),closestPointToGeometry_generated_obb.set(o.boundingBox.min,o.boundingBox.max,l),closestPointToGeometry_generated_obb.needsUpdate=!0;const A=d.geometry,w=A.attributes.position,C=A.index,M=o.attributes.position,O=o.index,ne=ExtendedTrianglePool.getPrimitive(),ce=ExtendedTrianglePool.getPrimitive();let ue=closestPointToGeometry_generated_temp1,ye=temp2,Oe=null,ke=null;u&&(Oe=temp3,ke=temp4);let Ve=1/0,tt=null,ht=null;return tempMatrix.copy(l).invert(),closestPointToGeometry_generated_obb2.matrix.copy(tempMatrix),d.shapecast({boundsTraverseOrder:ut=>closestPointToGeometry_generated_obb.distanceToBox(ut),intersectsBounds:(ut,_t,at)=>at<Ve&&at<_&&(_t&&(closestPointToGeometry_generated_obb2.min.copy(ut.min),closestPointToGeometry_generated_obb2.max.copy(ut.max),closestPointToGeometry_generated_obb2.needsUpdate=!0),!0),intersectsRange:(ut,_t)=>{if(o.boundsTree)return o.boundsTree.shapecast({boundsTraverseOrder:at=>closestPointToGeometry_generated_obb2.distanceToBox(at),intersectsBounds:(at,lt,pt)=>pt<Ve&&pt<_,intersectsRange:(at,lt)=>{for(let pt=at,xt=at+lt;pt<xt;pt++){setTriangle(ce,3*pt,O,M),ce.a.applyMatrix4(l),ce.b.applyMatrix4(l),ce.c.applyMatrix4(l),ce.needsUpdate=!0;for(let Tt=ut,Pt=ut+_t;Tt<Pt;Tt++){setTriangle(ne,3*Tt,C,w),ne.needsUpdate=!0;const Lt=ne.distanceToTriangle(ce,ue,Oe);if(Lt<Ve&&(ye.copy(ue),ke&&ke.copy(Oe),Ve=Lt,tt=Tt,ht=pt),Lt<h)return!0}}}});for(let at=0,lt=geometryUtils_getTriCount(o);at<lt;at++){setTriangle(ce,3*at,O,M),ce.a.applyMatrix4(l),ce.b.applyMatrix4(l),ce.c.applyMatrix4(l),ce.needsUpdate=!0;for(let pt=ut,xt=ut+_t;pt<xt;pt++){setTriangle(ne,3*pt,C,w),ne.needsUpdate=!0;const Tt=ne.distanceToTriangle(ce,ue,Oe);if(Tt<Ve&&(ye.copy(ue),ke&&ke.copy(Oe),Ve=Tt,tt=pt,ht=at),Tt<h)return!0}}}}),ExtendedTrianglePool.releasePrimitive(ne),ExtendedTrianglePool.releasePrimitive(ce),Ve===1/0?null:(c.point?c.point.copy(ye):c.point=ye.clone(),c.distance=Ve,c.faceIndex=tt,u&&(u.point?u.point.copy(ke):u.point=ke.clone(),u.point.applyMatrix4(tempMatrix),ye.applyMatrix4(tempMatrix),u.distance=ye.sub(u.point).length(),u.faceIndex=ht),c)}function intersectTris_indirect(d,o,l,c,u,h){const{geometry:_,_indirectBuffer:A}=d;for(let w=c,C=c+u;w<C;w++)intersectTri(_,o,l,A?A[w]:w,h)}function intersectClosestTri_indirect(d,o,l,c,u){const{geometry:h,_indirectBuffer:_}=d;let A=1/0,w=null;for(let C=c,M=c+u;C<M;C++){let O;O=intersectTri(h,o,l,_?_[C]:C),O&&O.distance<A&&(w=O,A=O.distance)}return w}function iterateOverTriangles_indirect(d,o,l,c,u,h,_){const{geometry:A}=l,{index:w}=A,C=A.attributes.position;for(let M=d,O=o+d;M<O;M++){let ne;if(ne=l.resolveTriangleIndex(M),setTriangle(_,3*ne,w,C),_.needsUpdate=!0,c(_,ne,u,h))return!0}return!1}function refit_indirect(d,o=null){o&&Array.isArray(o)&&(o=new Set(o));const l=d.geometry,c=l.index?l.index.array:null,u=l.attributes.position;let h,_,A,w,C=0;const M=d._roots;for(let ne=0,ce=M.length;ne<ce;ne++)h=M[ne],_=new Uint32Array(h),A=new Uint16Array(h),w=new Float32Array(h),O(0,C),C+=h.byteLength;function O(ne,ce,ue=!1){const ye=2*ne;if(A[ye+15]===IS_LEAFNODE_FLAG){const Oe=_[ne+6];let ke=1/0,Ve=1/0,tt=1/0,ht=-1/0,ut=-1/0,_t=-1/0;for(let at=Oe,lt=Oe+A[ye+14];at<lt;at++){const pt=3*d.resolveTriangleIndex(at);for(let xt=0;xt<3;xt++){let Tt=pt+xt;Tt=c?c[Tt]:Tt;const Pt=u.getX(Tt),Lt=u.getY(Tt),Bt=u.getZ(Tt);Pt<ke&&(ke=Pt),Pt>ht&&(ht=Pt),Lt<Ve&&(Ve=Lt),Lt>ut&&(ut=Lt),Bt<tt&&(tt=Bt),Bt>_t&&(_t=Bt)}}return(w[ne+0]!==ke||w[ne+1]!==Ve||w[ne+2]!==tt||w[ne+3]!==ht||w[ne+4]!==ut||w[ne+5]!==_t)&&(w[ne+0]=ke,w[ne+1]=Ve,w[ne+2]=tt,w[ne+3]=ht,w[ne+4]=ut,w[ne+5]=_t,!0)}{const Oe=ne+8,ke=_[ne+6],Ve=Oe+ce,tt=ke+ce;let ht=ue,ut=!1,_t=!1;o?ht||(ut=o.has(Ve),_t=o.has(tt),ht=!ut&&!_t):(ut=!0,_t=!0);const at=ht||_t;let lt=!1;(ht||ut)&&(lt=O(Oe,ce,ht));let pt=!1;at&&(pt=O(ke,ce,ht));const xt=lt||pt;if(xt)for(let Tt=0;Tt<3;Tt++){const Pt=Oe+Tt,Lt=ke+Tt,Bt=w[Pt],Ut=w[Pt+3],kt=w[Lt],Vt=w[Lt+3];w[ne+Tt]=Bt<kt?Bt:kt,w[ne+Tt+3]=Ut>Vt?Ut:Vt}return xt}}}const raycast_indirect_generated_boxIntersection=new three_module.Pq0;function raycast_indirect(d,o,l,c,u){BufferStack.setBuffer(d._roots[o]),raycast_indirect_generated_raycast(0,d,l,c,u),BufferStack.clearBuffer()}function raycast_indirect_generated_raycast(d,o,l,c,u){const{float32Array:h,uint16Array:_,uint32Array:A}=BufferStack,w=2*d;if(IS_LEAF(w,_))intersectTris_indirect(o,l,c,OFFSET(d,A),COUNT(w,_),u);else{const C=LEFT_NODE(d);intersectRay(C,h,c,raycast_indirect_generated_boxIntersection)&&raycast_indirect_generated_raycast(C,o,l,c,u);const M=RIGHT_NODE(d,A);intersectRay(M,h,c,raycast_indirect_generated_boxIntersection)&&raycast_indirect_generated_raycast(M,o,l,c,u)}}const raycastFirst_indirect_generated_boxIntersection=new three_module.Pq0,raycastFirst_indirect_generated_xyzFields=["x","y","z"];function raycastFirst_indirect(d,o,l,c){BufferStack.setBuffer(d._roots[o]);const u=raycastFirst_indirect_generated_raycastFirst(0,d,l,c);return BufferStack.clearBuffer(),u}function raycastFirst_indirect_generated_raycastFirst(d,o,l,c){const{float32Array:u,uint16Array:h,uint32Array:_}=BufferStack;let A=2*d;if(IS_LEAF(A,h))return intersectClosestTri_indirect(o,l,c,OFFSET(d,_),COUNT(A,h));{const w=SPLIT_AXIS(d,_),C=raycastFirst_indirect_generated_xyzFields[w],M=c.direction[C]>=0;let O,ne;M?(O=LEFT_NODE(d),ne=RIGHT_NODE(d,_)):(O=RIGHT_NODE(d,_),ne=LEFT_NODE(d));const ce=intersectRay(O,u,c,raycastFirst_indirect_generated_boxIntersection)?raycastFirst_indirect_generated_raycastFirst(O,o,l,c):null;if(ce){const ye=ce.point[C];if(M?ye<=u[ne+w]:ye>=u[ne+w+3])return ce}const ue=intersectRay(ne,u,c,raycastFirst_indirect_generated_boxIntersection)?raycastFirst_indirect_generated_raycastFirst(ne,o,l,c):null;return ce&&ue?ce.distance<=ue.distance?ce:ue:ce||ue||null}}const intersectsGeometry_indirect_generated_boundingBox=new three_module.NRn,intersectsGeometry_indirect_generated_triangle=new ExtendedTriangle,intersectsGeometry_indirect_generated_triangle2=new ExtendedTriangle,intersectsGeometry_indirect_generated_invertedMat=new three_module.kn4,intersectsGeometry_indirect_generated_obb=new OrientedBox,intersectsGeometry_indirect_generated_obb2=new OrientedBox;function intersectsGeometry_indirect(d,o,l,c){BufferStack.setBuffer(d._roots[o]);const u=intersectsGeometry_indirect_generated_intersectsGeometry(0,d,l,c);return BufferStack.clearBuffer(),u}function intersectsGeometry_indirect_generated_intersectsGeometry(d,o,l,c,u=null){const{float32Array:h,uint16Array:_,uint32Array:A}=BufferStack;let w=2*d;if(u===null&&(l.boundingBox||l.computeBoundingBox(),intersectsGeometry_indirect_generated_obb.set(l.boundingBox.min,l.boundingBox.max,c),u=intersectsGeometry_indirect_generated_obb),!IS_LEAF(w,_)){const C=d+8,M=A[d+6];return arrayToBox(C,h,intersectsGeometry_indirect_generated_boundingBox),u.intersectsBox(intersectsGeometry_indirect_generated_boundingBox)&&intersectsGeometry_indirect_generated_intersectsGeometry(C,o,l,c,u)?!0:(arrayToBox(M,h,intersectsGeometry_indirect_generated_boundingBox),!(!u.intersectsBox(intersectsGeometry_indirect_generated_boundingBox)||!intersectsGeometry_indirect_generated_intersectsGeometry(M,o,l,c,u)))}{const C=o.geometry,M=C.index,O=C.attributes.position,ne=l.index,ce=l.attributes.position,ue=OFFSET(d,A),ye=COUNT(w,_);if(intersectsGeometry_indirect_generated_invertedMat.copy(c).invert(),l.boundsTree)return arrayToBox(d,h,intersectsGeometry_indirect_generated_obb2),intersectsGeometry_indirect_generated_obb2.matrix.copy(intersectsGeometry_indirect_generated_invertedMat),intersectsGeometry_indirect_generated_obb2.needsUpdate=!0,l.boundsTree.shapecast({intersectsBounds:ke=>intersectsGeometry_indirect_generated_obb2.intersectsBox(ke),intersectsTriangle:ke=>{ke.a.applyMatrix4(c),ke.b.applyMatrix4(c),ke.c.applyMatrix4(c),ke.needsUpdate=!0;for(let Ve=ue,tt=ye+ue;Ve<tt;Ve++)if(setTriangle(intersectsGeometry_indirect_generated_triangle2,3*o.resolveTriangleIndex(Ve),M,O),intersectsGeometry_indirect_generated_triangle2.needsUpdate=!0,ke.intersectsTriangle(intersectsGeometry_indirect_generated_triangle2))return!0;return!1}});for(let Oe=ue,ke=ye+ue;Oe<ke;Oe++){const Ve=o.resolveTriangleIndex(Oe);setTriangle(intersectsGeometry_indirect_generated_triangle,3*Ve,M,O),intersectsGeometry_indirect_generated_triangle.a.applyMatrix4(intersectsGeometry_indirect_generated_invertedMat),intersectsGeometry_indirect_generated_triangle.b.applyMatrix4(intersectsGeometry_indirect_generated_invertedMat),intersectsGeometry_indirect_generated_triangle.c.applyMatrix4(intersectsGeometry_indirect_generated_invertedMat),intersectsGeometry_indirect_generated_triangle.needsUpdate=!0;for(let tt=0,ht=ne.count;tt<ht;tt+=3)if(setTriangle(intersectsGeometry_indirect_generated_triangle2,tt,ne,ce),intersectsGeometry_indirect_generated_triangle2.needsUpdate=!0,intersectsGeometry_indirect_generated_triangle.intersectsTriangle(intersectsGeometry_indirect_generated_triangle2))return!0}}}const closestPointToGeometry_indirect_generated_tempMatrix=new three_module.kn4,closestPointToGeometry_indirect_generated_obb=new OrientedBox,closestPointToGeometry_indirect_generated_obb2=new OrientedBox,closestPointToGeometry_indirect_generated_temp1=new three_module.Pq0,closestPointToGeometry_indirect_generated_temp2=new three_module.Pq0,closestPointToGeometry_indirect_generated_temp3=new three_module.Pq0,closestPointToGeometry_indirect_generated_temp4=new three_module.Pq0;function closestPointToGeometry_indirect(d,o,l,c={},u={},h=0,_=1/0){o.boundingBox||o.computeBoundingBox(),closestPointToGeometry_indirect_generated_obb.set(o.boundingBox.min,o.boundingBox.max,l),closestPointToGeometry_indirect_generated_obb.needsUpdate=!0;const A=d.geometry,w=A.attributes.position,C=A.index,M=o.attributes.position,O=o.index,ne=ExtendedTrianglePool.getPrimitive(),ce=ExtendedTrianglePool.getPrimitive();let ue=closestPointToGeometry_indirect_generated_temp1,ye=closestPointToGeometry_indirect_generated_temp2,Oe=null,ke=null;u&&(Oe=closestPointToGeometry_indirect_generated_temp3,ke=closestPointToGeometry_indirect_generated_temp4);let Ve=1/0,tt=null,ht=null;return closestPointToGeometry_indirect_generated_tempMatrix.copy(l).invert(),closestPointToGeometry_indirect_generated_obb2.matrix.copy(closestPointToGeometry_indirect_generated_tempMatrix),d.shapecast({boundsTraverseOrder:ut=>closestPointToGeometry_indirect_generated_obb.distanceToBox(ut),intersectsBounds:(ut,_t,at)=>at<Ve&&at<_&&(_t&&(closestPointToGeometry_indirect_generated_obb2.min.copy(ut.min),closestPointToGeometry_indirect_generated_obb2.max.copy(ut.max),closestPointToGeometry_indirect_generated_obb2.needsUpdate=!0),!0),intersectsRange:(ut,_t)=>{if(o.boundsTree){const at=o.boundsTree;return at.shapecast({boundsTraverseOrder:lt=>closestPointToGeometry_indirect_generated_obb2.distanceToBox(lt),intersectsBounds:(lt,pt,xt)=>xt<Ve&&xt<_,intersectsRange:(lt,pt)=>{for(let xt=lt,Tt=lt+pt;xt<Tt;xt++){const Pt=at.resolveTriangleIndex(xt);setTriangle(ce,3*Pt,O,M),ce.a.applyMatrix4(l),ce.b.applyMatrix4(l),ce.c.applyMatrix4(l),ce.needsUpdate=!0;for(let Lt=ut,Bt=ut+_t;Lt<Bt;Lt++){const Ut=d.resolveTriangleIndex(Lt);setTriangle(ne,3*Ut,C,w),ne.needsUpdate=!0;const kt=ne.distanceToTriangle(ce,ue,Oe);if(kt<Ve&&(ye.copy(ue),ke&&ke.copy(Oe),Ve=kt,tt=Lt,ht=xt),kt<h)return!0}}}})}for(let at=0,lt=geometryUtils_getTriCount(o);at<lt;at++){setTriangle(ce,3*at,O,M),ce.a.applyMatrix4(l),ce.b.applyMatrix4(l),ce.c.applyMatrix4(l),ce.needsUpdate=!0;for(let pt=ut,xt=ut+_t;pt<xt;pt++){const Tt=d.resolveTriangleIndex(pt);setTriangle(ne,3*Tt,C,w),ne.needsUpdate=!0;const Pt=ne.distanceToTriangle(ce,ue,Oe);if(Pt<Ve&&(ye.copy(ue),ke&&ke.copy(Oe),Ve=Pt,tt=pt,ht=at),Pt<h)return!0}}}}),ExtendedTrianglePool.releasePrimitive(ne),ExtendedTrianglePool.releasePrimitive(ce),Ve===1/0?null:(c.point?c.point.copy(ye):c.point=ye.clone(),c.distance=Ve,c.faceIndex=tt,u&&(u.point?u.point.copy(ke):u.point=ke.clone(),u.point.applyMatrix4(closestPointToGeometry_indirect_generated_tempMatrix),ye.applyMatrix4(closestPointToGeometry_indirect_generated_tempMatrix),u.distance=ye.sub(u.point).length(),u.faceIndex=ht),c)}function isSharedArrayBufferSupported(){return typeof SharedArrayBuffer<"u"}const _bufferStack1=new BufferStack.constructor,_bufferStack2=new BufferStack.constructor,_boxPool=new PrimitivePool(()=>new three_module.NRn),_leftBox1=new three_module.NRn,_rightBox1=new three_module.NRn,_leftBox2=new three_module.NRn,_rightBox2=new three_module.NRn;let _active=!1;function bvhcast(d,o,l,c){if(_active)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");_active=!0;const u=d._roots,h=o._roots;let _,A=0,w=0;const C=new three_module.kn4().copy(l).invert();for(let M=0,O=u.length;M<O;M++){_bufferStack1.setBuffer(u[M]),w=0;const ne=_boxPool.getPrimitive();arrayToBox(0,_bufferStack1.float32Array,ne),ne.applyMatrix4(C);for(let ce=0,ue=h.length;ce<ue&&(_bufferStack2.setBuffer(h[M]),_=_traverse(0,0,l,C,c,A,w,0,0,ne),_bufferStack2.clearBuffer(),w+=h[ce].length,!_);ce++);if(_boxPool.releasePrimitive(ne),_bufferStack1.clearBuffer(),A+=u[M].length,_)break}return _active=!1,_}function _traverse(d,o,l,c,u,h=0,_=0,A=0,w=0,C=null,M=!1){let O,ne;M?(O=_bufferStack2,ne=_bufferStack1):(O=_bufferStack1,ne=_bufferStack2);const ce=O.float32Array,ue=O.uint32Array,ye=O.uint16Array,Oe=ne.float32Array,ke=ne.uint32Array,Ve=ne.uint16Array,tt=2*o,ht=IS_LEAF(2*d,ye),ut=IS_LEAF(tt,Ve);let _t=!1;if(ut&&ht)_t=M?u(OFFSET(o,ke),COUNT(2*o,Ve),OFFSET(d,ue),COUNT(2*d,ye),w,_+o,A,h+d):u(OFFSET(d,ue),COUNT(2*d,ye),OFFSET(o,ke),COUNT(2*o,Ve),A,h+d,w,_+o);else if(ut){const at=_boxPool.getPrimitive();arrayToBox(o,Oe,at),at.applyMatrix4(l);const lt=LEFT_NODE(d),pt=RIGHT_NODE(d,ue);arrayToBox(lt,ce,_leftBox1),arrayToBox(pt,ce,_rightBox1);const xt=at.intersectsBox(_leftBox1),Tt=at.intersectsBox(_rightBox1);_t=xt&&_traverse(o,lt,c,l,u,_,h,w,A+1,at,!M)||Tt&&_traverse(o,pt,c,l,u,_,h,w,A+1,at,!M),_boxPool.releasePrimitive(at)}else{const at=LEFT_NODE(o),lt=RIGHT_NODE(o,ke);arrayToBox(at,Oe,_leftBox2),arrayToBox(lt,Oe,_rightBox2);const pt=C.intersectsBox(_leftBox2),xt=C.intersectsBox(_rightBox2);if(pt&&xt)_t=_traverse(d,at,l,c,u,h,_,A,w+1,C,M)||_traverse(d,lt,l,c,u,h,_,A,w+1,C,M);else if(pt)if(ht)_t=_traverse(d,at,l,c,u,h,_,A,w+1,C,M);else{const Tt=_boxPool.getPrimitive();Tt.copy(_leftBox2).applyMatrix4(l);const Pt=LEFT_NODE(d),Lt=RIGHT_NODE(d,ue);arrayToBox(Pt,ce,_leftBox1),arrayToBox(Lt,ce,_rightBox1);const Bt=Tt.intersectsBox(_leftBox1),Ut=Tt.intersectsBox(_rightBox1);_t=Bt&&_traverse(at,Pt,c,l,u,_,h,w,A+1,Tt,!M)||Ut&&_traverse(at,Lt,c,l,u,_,h,w,A+1,Tt,!M),_boxPool.releasePrimitive(Tt)}else if(xt)if(ht)_t=_traverse(d,lt,l,c,u,h,_,A,w+1,C,M);else{const Tt=_boxPool.getPrimitive();Tt.copy(_rightBox2).applyMatrix4(l);const Pt=LEFT_NODE(d),Lt=RIGHT_NODE(d,ue);arrayToBox(Pt,ce,_leftBox1),arrayToBox(Lt,ce,_rightBox1);const Bt=Tt.intersectsBox(_leftBox1),Ut=Tt.intersectsBox(_rightBox1);_t=Bt&&_traverse(lt,Pt,c,l,u,_,h,w,A+1,Tt,!M)||Ut&&_traverse(lt,Lt,c,l,u,_,h,w,A+1,Tt,!M),_boxPool.releasePrimitive(Tt)}}return _t}const MeshBVH_obb=new OrientedBox,tempBox=new three_module.NRn;class MeshBVH{static serialize(o,l={}){l={cloneBuffers:!0,...l};const c=o.geometry,u=o._roots,h=o._indirectBuffer,_=c.getIndex();let A;return A=l.cloneBuffers?{roots:u.map(w=>w.slice()),index:_.array.slice(),indirectBuffer:h?h.slice():null}:{roots:u,index:_.array,indirectBuffer:h},A}static deserialize(o,l,c={}){c={setIndex:!0,indirect:!!o.indirectBuffer,...c};const{index:u,roots:h,indirectBuffer:_}=o,A=new MeshBVH(l,{...c,[SKIP_GENERATION]:!0});if(A._roots=h,A._indirectBuffer=_||null,c.setIndex){const w=l.getIndex();if(w===null){const C=new three_module.THS(o.index,1,!1);l.setIndex(C)}else w.array!==u&&(w.array.set(u),w.needsUpdate=!0)}return A}get indirect(){return!!this._indirectBuffer}constructor(o,l={}){if(!o.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(o.index&&o.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((l=Object.assign({strategy:CENTER,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[SKIP_GENERATION]:!1},l)).useSharedArrayBuffer&&!isSharedArrayBufferSupported())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=o,this._roots=null,this._indirectBuffer=null,l[SKIP_GENERATION]||(buildPackedTree(this,l),!o.boundingBox&&l.setBoundingBox&&(o.boundingBox=this.getBoundingBox(new three_module.NRn)));const{_indirectBuffer:c}=this;this.resolveTriangleIndex=l.indirect?u=>c[u]:u=>u}refit(o=null){return(this.indirect?refit_indirect:refit)(this,o)}traverse(o,l=0){const c=this._roots[l],u=new Uint32Array(c),h=new Uint16Array(c);(function _(A,w=0){const C=2*A,M=h[C+15]===IS_LEAFNODE_FLAG;if(M){const O=u[A+6],ne=h[C+14];o(w,M,new Float32Array(c,4*A,6),O,ne)}else{const O=A+BYTES_PER_NODE/4,ne=u[A+6],ce=u[A+7];o(w,M,new Float32Array(c,4*A,6),ce)||(_(O,w+1),_(ne,w+1))}})(0)}raycast(o,l=three_module.hB5){const c=this._roots,u=this.geometry,h=[],_=l.isMaterial,A=Array.isArray(l),w=u.groups,C=_?l.side:l,M=this.indirect?raycast_indirect:raycast;for(let O=0,ne=c.length;O<ne;O++){const ce=A?l[w[O].materialIndex].side:C,ue=h.length;if(M(this,O,ce,o,h),A){const ye=w[O].materialIndex;for(let Oe=ue,ke=h.length;Oe<ke;Oe++)h[Oe].face.materialIndex=ye}}return h}raycastFirst(o,l=three_module.hB5){const c=this._roots,u=this.geometry,h=l.isMaterial,_=Array.isArray(l);let A=null;const w=u.groups,C=h?l.side:l,M=this.indirect?raycastFirst_indirect:raycastFirst;for(let O=0,ne=c.length;O<ne;O++){const ce=M(this,O,_?l[w[O].materialIndex].side:C,o);ce!=null&&(A==null||ce.distance<A.distance)&&(A=ce,_&&(ce.face.materialIndex=w[O].materialIndex))}return A}intersectsGeometry(o,l){let c=!1;const u=this._roots,h=this.indirect?intersectsGeometry_indirect:intersectsGeometry;for(let _=0,A=u.length;_<A&&(c=h(this,_,o,l),!c);_++);return c}shapecast(o){const l=ExtendedTrianglePool.getPrimitive(),c=this.indirect?iterateOverTriangles_indirect:iterateOverTriangles;let{boundsTraverseOrder:u,intersectsBounds:h,intersectsRange:_,intersectsTriangle:A}=o;if(_&&A){const O=_;_=(ne,ce,ue,ye,Oe)=>!!O(ne,ce,ue,ye,Oe)||c(ne,ce,this,A,ue,ye,l)}else _||(_=A?(O,ne,ce,ue)=>c(O,ne,this,A,ce,ue,l):(O,ne,ce)=>ce);let w=!1,C=0;const M=this._roots;for(let O=0,ne=M.length;O<ne;O++){const ce=M[O];if(w=shapecast(this,O,h,_,u,C),w)break;C+=ce.byteLength}return ExtendedTrianglePool.releasePrimitive(l),w}bvhcast(o,l,c){let{intersectsRanges:u,intersectsTriangles:h}=c;const _=ExtendedTrianglePool.getPrimitive(),A=this.geometry.index,w=this.geometry.attributes.position,C=this.indirect?ue=>{const ye=this.resolveTriangleIndex(ue);setTriangle(_,3*ye,A,w)}:ue=>{setTriangle(_,3*ue,A,w)},M=ExtendedTrianglePool.getPrimitive(),O=o.geometry.index,ne=o.geometry.attributes.position,ce=o.indirect?ue=>{const ye=o.resolveTriangleIndex(ue);setTriangle(M,3*ye,O,ne)}:ue=>{setTriangle(M,3*ue,O,ne)};if(h){const ue=(ye,Oe,ke,Ve,tt,ht,ut,_t)=>{for(let at=ke,lt=ke+Ve;at<lt;at++){ce(at),M.a.applyMatrix4(l),M.b.applyMatrix4(l),M.c.applyMatrix4(l),M.needsUpdate=!0;for(let pt=ye,xt=ye+Oe;pt<xt;pt++)if(C(pt),_.needsUpdate=!0,h(_,M,pt,at,tt,ht,ut,_t))return!0}return!1};if(u){const ye=u;u=function(Oe,ke,Ve,tt,ht,ut,_t,at){return!!ye(Oe,ke,Ve,tt,ht,ut,_t,at)||ue(Oe,ke,Ve,tt,ht,ut,_t,at)}}else u=ue}return bvhcast(this,o,l,u)}intersectsBox(o,l){return MeshBVH_obb.set(o.min,o.max,l),MeshBVH_obb.needsUpdate=!0,this.shapecast({intersectsBounds:c=>MeshBVH_obb.intersectsBox(c),intersectsTriangle:c=>MeshBVH_obb.intersectsTriangle(c)})}intersectsSphere(o){return this.shapecast({intersectsBounds:l=>o.intersectsBox(l),intersectsTriangle:l=>l.intersectsSphere(o)})}closestPointToGeometry(o,l,c={},u={},h=0,_=1/0){return(this.indirect?closestPointToGeometry_indirect:closestPointToGeometry)(this,o,l,c,u,h,_)}closestPointToPoint(o,l={},c=0,u=1/0){return closestPointToPoint(this,o,l,c,u)}getBoundingBox(o){return o.makeEmpty(),this._roots.forEach(l=>{arrayToBox(0,new Float32Array(l),tempBox),o.union(tempBox)}),o}}const HASH_WIDTH=1e-6,HASH_HALF_WIDTH=.5*HASH_WIDTH,HASH_MULTIPLIER=Math.pow(10,-Math.log10(HASH_WIDTH)),HASH_ADDITION=HASH_HALF_WIDTH*HASH_MULTIPLIER;function hashNumber(d){return~~(d*HASH_MULTIPLIER+HASH_ADDITION)}function hashVertex2(d){return`${hashNumber(d.x)},${hashNumber(d.y)}`}function hashVertex3(d){return`${hashNumber(d.x)},${hashNumber(d.y)},${hashNumber(d.z)}`}function hashVertex4(d){return`${hashNumber(d.x)},${hashNumber(d.y)},${hashNumber(d.z)},${hashNumber(d.w)}`}function toNormalizedRay(d,o,l){l.direction.subVectors(o,d).normalize();const c=d.dot(l.direction);return l.origin.copy(d).addScaledVector(l.direction,-c),l}const DEGENERATE_EPSILON=1e-8,_tempVec=new three_module.Pq0;function toTriIndex(d){return~~(d/3)}function toEdgeIndex(d){return d%3}function sortEdgeFunc(d,o){return d.start-o.start}function getProjectedDistance(d,o){return _tempVec.subVectors(o,d.origin).dot(d.direction)}function matchEdges(d,o,l,c=DEGENERATE_EPSILON){d.sort(sortEdgeFunc),o.sort(sortEdgeFunc);for(let A=0;A<d.length;A++){const w=d[A];for(let C=0;C<o.length;C++){const M=o[C];if(!(M.start>w.end)){if(w.end<M.start||M.end<w.start)continue;if(w.start<=M.start&&w.end>=M.end)h(M.end,w.end)||d.splice(A+1,0,{start:M.end,end:w.end,index:w.index}),w.end=M.start,M.start=0,M.end=0;else if(w.start>=M.start&&w.end<=M.end)h(w.end,M.end)||o.splice(C+1,0,{start:w.end,end:M.end,index:M.index}),M.end=w.start,w.start=0,w.end=0;else if(w.start<=M.start&&w.end<=M.end){const O=w.end;w.end=M.start,M.start=O}else{if(!(w.start>=M.start&&w.end>=M.end))throw new Error;{const O=M.end;M.end=w.start,w.start=O}}}if(l.has(w.index)||l.set(w.index,[]),l.has(M.index)||l.set(M.index,[]),l.get(w.index).push(M.index),l.get(M.index).push(w.index),_(M)&&(o.splice(C,1),C--),_(w)){d.splice(A,1),A--;break}}}function u(A){for(let w=0;w<A.length;w++)_(A[w])&&(A.splice(w,1),w--)}function h(A,w){return Math.abs(w-A)<c}function _(A){return Math.abs(A.end-A.start)<c}u(d),u(o)}const DIST_EPSILON=1e-5,ANGLE_EPSILON=1e-4;class RaySet{constructor(){this._rays=[]}addRay(o){this._rays.push(o)}findClosestRay(o){const l=this._rays,c=o.clone();c.direction.multiplyScalar(-1);let u=1/0,h=null;for(let w=0,C=l.length;w<C;w++){const M=l[w];if(_(M,o)&&_(M,c))continue;const O=A(M,o),ne=A(M,c),ce=Math.min(O,ne);ce<u&&(u=ce,h=M)}return h;function _(w,C){const M=w.origin.distanceTo(C.origin)>DIST_EPSILON;return w.direction.angleTo(C.direction)>ANGLE_EPSILON||M}function A(w,C){const M=w.origin.distanceTo(C.origin),O=w.direction.angleTo(C.direction);return M/DIST_EPSILON+O/ANGLE_EPSILON}}}const _v0=new three_module.Pq0,_v1=new three_module.Pq0,computeDisjointEdges_ray=new three_module.RlV;function computeDisjointEdges(d,o,l){const c=d.attributes,u=d.index,h=c.position,_=new Map,A=new Map,w=Array.from(o),C=new RaySet;for(let M=0,O=w.length;M<O;M++){const ne=w[M],ce=toTriIndex(ne),ue=toEdgeIndex(ne);let ye,Oe=3*ce+ue,ke=3*ce+(ue+1)%3;u&&(Oe=u.getX(Oe),ke=u.getX(ke)),_v0.fromBufferAttribute(h,Oe),_v1.fromBufferAttribute(h,ke),toNormalizedRay(_v0,_v1,computeDisjointEdges_ray);let Ve=C.findClosestRay(computeDisjointEdges_ray);Ve===null&&(Ve=computeDisjointEdges_ray.clone(),C.addRay(Ve)),A.has(Ve)||A.set(Ve,{forward:[],reverse:[],ray:Ve}),ye=A.get(Ve);let tt=getProjectedDistance(Ve,_v0),ht=getProjectedDistance(Ve,_v1);tt>ht&&([tt,ht]=[ht,tt]),computeDisjointEdges_ray.direction.dot(Ve.direction)<0?ye.reverse.push({start:tt,end:ht,index:ne}):ye.forward.push({start:tt,end:ht,index:ne})}return A.forEach(({forward:M,reverse:O},ne)=>{matchEdges(M,O,_,l),M.length===0&&O.length===0&&A.delete(ne)}),{disjointConnectivityMap:_,fragmentMap:A}}const _vec2=new three_module.I9Y,HalfEdgeMap_vec3=new three_module.Pq0,_vec4=new three_module.IUQ,_hashes=["","",""];class HalfEdgeMap{constructor(o=null){this.data=null,this.disjointConnections=null,this.unmatchedDisjointEdges=null,this.unmatchedEdges=-1,this.matchedEdges=-1,this.useDrawRange=!0,this.useAllAttributes=!1,this.matchDisjointEdges=!1,this.degenerateEpsilon=1e-8,o&&this.updateFrom(o)}getSiblingTriangleIndex(o,l){const c=this.data[3*o+l];return c===-1?-1:~~(c/3)}getSiblingEdgeIndex(o,l){const c=this.data[3*o+l];return c===-1?-1:c%3}getDisjointSiblingTriangleIndices(o,l){const c=3*o+l,u=this.disjointConnections.get(c);return u?u.map(h=>~~(h/3)):[]}getDisjointSiblingEdgeIndices(o,l){const c=3*o+l,u=this.disjointConnections.get(c);return u?u.map(h=>h%3):[]}isFullyConnected(){return this.unmatchedEdges===0}updateFrom(o){const{useAllAttributes:l,useDrawRange:c,matchDisjointEdges:u,degenerateEpsilon:h}=this,_=l?function(Ve){let tt="";for(let ht=0,ut=C.length;ht<ut;ht++){const _t=w[C[ht]];let at;switch(_t.itemSize){case 1:at=hashNumber(_t.getX(Ve));break;case 2:at=hashVertex2(_vec2.fromBufferAttribute(_t,Ve));break;case 3:at=hashVertex3(HalfEdgeMap_vec3.fromBufferAttribute(_t,Ve));break;case 4:at=hashVertex4(_vec4.fromBufferAttribute(_t,Ve))}tt!==""&&(tt+="|"),tt+=at}return tt}:function(Ve){return HalfEdgeMap_vec3.fromBufferAttribute(O,Ve),hashVertex3(HalfEdgeMap_vec3)},A=new Map,{attributes:w}=o,C=l?Object.keys(w):null,M=o.index,O=w.position;let ne=getTriCount(o);const ce=ne;let ue=0;c&&(ue=o.drawRange.start,o.drawRange.count!==1/0&&(ne=~~(o.drawRange.count/3)));let ye=this.data;(!ye||ye.length<3*ce)&&(ye=new Int32Array(3*ce)),ye.fill(-1);let Oe=0,ke=new Set;for(let Ve=ue,tt=3*ne+ue;Ve<tt;Ve+=3){const ht=Ve;for(let ut=0;ut<3;ut++){let _t=ht+ut;M&&(_t=M.getX(_t)),_hashes[ut]=_(_t)}for(let ut=0;ut<3;ut++){const _t=(ut+1)%3,at=_hashes[ut],lt=_hashes[_t],pt=`${lt}_${at}`;if(A.has(pt)){const xt=ht+ut,Tt=A.get(pt);ye[xt]=Tt,ye[Tt]=xt,A.delete(pt),Oe+=2,ke.delete(Tt)}else{const xt=`${at}_${lt}`,Tt=ht+ut;A.set(xt,Tt),ke.add(Tt)}}}if(u){const{fragmentMap:Ve,disjointConnectivityMap:tt}=computeDisjointEdges(o,ke,h);ke.clear(),Ve.forEach(({forward:ht,reverse:ut})=>{ht.forEach(({index:_t})=>ke.add(_t)),ut.forEach(({index:_t})=>ke.add(_t))}),this.unmatchedDisjointEdges=Ve,this.disjointConnections=tt,Oe=3*ne-ke.size}this.matchedEdges=Oe,this.unmatchedEdges=ke.size,this.data=ye}}class Brush extends three_module.eaF{constructor(...o){super(...o),this.isBrush=!0,this._previousMatrix=new three_module.kn4,this._previousMatrix.elements.fill(0)}markUpdated(){this._previousMatrix.copy(this.matrix)}isDirty(){const{matrix:o,_previousMatrix:l}=this,c=o.elements,u=l.elements;for(let h=0;h<16;h++)if(c[h]!==u[h])return!0;return!1}prepareGeometry(){const o=this.geometry,l=o.attributes,c=areSharedArrayBuffersSupported();if(c)for(const u in l){const h=l[u];if(h.isInterleavedBufferAttribute)throw new Error("Brush: InterleavedBufferAttributes are not supported.");h.array=convertToSharedArrayBuffer(h.array)}if(o.boundsTree||(ensureIndex(o,{useSharedArrayBuffer:c}),o.boundsTree=new MeshBVH(o,{maxLeafTris:3,indirect:!0,useSharedArrayBuffer:c})),o.halfEdges||(o.halfEdges=new HalfEdgeMap(o)),!o.groupIndices){const u=getTriCount(o),h=new Uint16Array(u),_=o.groups;for(let A=0,w=_.length;A<w;A++){const{start:C,count:M}=_[A];for(let O=C/3,ne=(C+M)/3;O<ne;O++)h[O]=A}o.groupIndices=h}}disposeCacheData(){const{geometry:o}=this;o.halfEdges=null,o.boundsTree=null,o.groupIndices=null}}function joinGroups(d){for(let o=0;o<d.length-1;o++){const l=d[o],c=d[o+1];if(l.materialIndex===c.materialIndex){const u=l.start,h=c.start+c.count;c.start=u,c.count=h-u,d.splice(o,1),o--}}}function prepareAttributesData(d,o,l,c){l.clear();const u=d.attributes;for(let h=0,_=c.length;h<_;h++){const A=c[h],w=u[A];l.initializeArray(A,w.array.constructor,w.itemSize,w.normalized)}for(const h in l.attributes)c.includes(h)||l.delete(h);for(const h in o.attributes)c.includes(h)||(o.deleteAttribute(h),o.dispose())}function assignBufferData(d,o,l){let c=!1,u=-1;const h=d.attributes,_=o.groupAttributes[0];for(const w in _){const C=o.getTotalLength(w),M=o.getType(w),O=o.getItemSize(w),ne=o.getNormalized(w);let ce=h[w];(!ce||ce.array.length<C)&&(ce=new three_module.THS(new M(C),O,ne),d.setAttribute(w,ce),c=!0);let ue=0;for(let ye=0,Oe=Math.min(l.length,o.groupCount);ye<Oe;ye++){const ke=l[ye].index,{array:Ve,type:tt,length:ht}=o.groupAttributes[ke][w],ut=new tt(Ve.buffer,0,ht);ce.array.set(ut,ue),ue+=ut.length}ce.needsUpdate=!0,u=C/ce.itemSize}if(d.index){const w=d.index.array;if(w.length<u)d.index=null,c=!0;else for(let C=0,M=w.length;C<M;C++)w[C]=C}let A=0;d.clearGroups();for(let w=0,C=Math.min(l.length,o.groupCount);w<C;w++){const{index:M,materialIndex:O}=l[w],ne=o.getCount(M);ne!==0&&(d.addGroup(A,ne,O),A+=ne)}d.setDrawRange(0,u),d.boundsTree=null,c&&d.dispose()}function getMaterialList(d,o){let l=o;return Array.isArray(o)||(l=[],d.forEach(c=>{l[c.materialIndex]=o})),l}class Evaluator{constructor(){this.triangleSplitter=new TriangleSplitter,this.attributeData=[],this.attributes=["position","uv","normal"],this.useGroups=!0,this.consolidateGroups=!0,this.debug=new OperationDebugData}getGroupRanges(o){return this.useGroups&&o.groups.length!==0?o.groups.map(l=>({...l})):[{start:0,count:1/0,materialIndex:0}]}evaluate(o,l,c,u=new Brush){let h=!0;if(Array.isArray(c)||(c=[c]),Array.isArray(u)||(u=[u],h=!1),u.length!==c.length)throw new Error("Evaluator: operations and target array passed as different sizes.");o.prepareGeometry(),l.prepareGeometry();const{triangleSplitter:_,attributeData:A,attributes:w,useGroups:C,consolidateGroups:M,debug:O}=this;for(;A.length<u.length;)A.push(new TypedAttributeData);u.forEach((ke,Ve)=>{prepareAttributesData(o.geometry,ke.geometry,A[Ve],w)}),O.init(),performOperation(o,l,c,_,A,{useGroups:C}),O.complete();const ne=this.getGroupRanges(o.geometry),ce=getMaterialList(ne,o.material),ue=this.getGroupRanges(l.geometry),ye=getMaterialList(ue,l.material);ue.forEach(ke=>ke.materialIndex+=ce.length);let Oe=[...ne,...ue].map((ke,Ve)=>({...ke,index:Ve}));if(C){const ke=[...ce,...ye];M&&(Oe=Oe.map(tt=>{const ht=ke[tt.materialIndex];return tt.materialIndex=ke.indexOf(ht),tt}).sort((tt,ht)=>tt.materialIndex-ht.materialIndex));const Ve=[];for(let tt=0,ht=ke.length;tt<ht;tt++){let ut=!1;for(let _t=0,at=Oe.length;_t<at;_t++){const lt=Oe[_t];lt.materialIndex===tt&&(ut=!0,lt.materialIndex=Ve.length)}ut&&Ve.push(ke[tt])}u.forEach(tt=>{tt.material=Ve})}else Oe=[{start:0,count:1/0,index:0,materialIndex:0}],u.forEach(ke=>{ke.material=ce[0]});return u.forEach((ke,Ve)=>{const tt=ke.geometry;assignBufferData(tt,A[Ve],Oe),M&&joinGroups(tt.groups)}),h?u:u[0]}evaluateHierarchy(o,l=new Brush){o.updateMatrixWorld(!0);const c=(h,_)=>{const A=h.children;for(let w=0,C=A.length;w<C;w++){const M=A[w];M.isOperationGroup?c(M,_):_(M)}},u=h=>{const _=h.children;let A=!1;for(let C=0,M=_.length;C<M;C++){const O=_[C];A=u(O)||A}const w=h.isDirty();if(w&&h.markUpdated(),A&&!h.isOperationGroup){let C;return c(h,M=>{C=C?this.evaluate(C,M,M.operation):this.evaluate(h,M,M.operation)}),h._cachedGeometry=C.geometry,h._cachedMaterials=C.material,!0}return A||w};return u(o),l.geometry=o._cachedGeometry,l.material=o._cachedMaterials,l}reset(){this.triangleSplitter.reset()}}var CSGPluginBVH_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const operations={union:ADDITION,subtract:SUBTRACTION,intersect:INTERSECTION,difference:DIFFERENCE};function buildCSGMeshBVH(d,o){const l=new Evaluator;l.useGroups=!0,l.attributes=["position","normal","uv"],d.forEach(h=>{for(const _ of[...l.attributes])h[0].geometry.getAttribute(_)||l.attributes.splice(l.attributes.indexOf(_),1)});let c=new Brush(new three_module.bdM(.01,.01,2,2));d.forEach(([h,_])=>{if(!Object.keys(operations).includes(_))return void console.error(`Unknown operation ${_}`);h.updateMatrix(),h.updateMatrixWorld();const A=new Brush;A.geometry=h.geometry,A.material=h.material,h.matrixWorld.decompose(A.position,A.quaternion,A.scale),A.updateMatrix(),A.updateMatrixWorld(),c=l.evaluate(c,A,operations[_])});const u=c;return u.userData._isCSGMesh=!0,u}let CSGPluginBVH=class extends CSGPluginBase{_buildCSGMesh(d){return buildCSGMeshBVH(d)}};CSGPluginBVH.PluginType="CSGPluginBVH",CSGPluginBVH=CSGPluginBVH_decorate([uiFolder("CSG Plugin (BVH)")],CSGPluginBVH);class ACameraControlsPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.toJSON=void 0,this._cameraChanged=o=>{var l,c,u,h;(c=(l=o.lastCamera)===null||l===void 0?void 0:l.removeControlsCtor)===null||c===void 0||c.call(l,this.controlsKey),(h=(u=o.camera)===null||u===void 0?void 0:u.setControlsCtor)===null||h===void 0||h.call(u,this.controlsKey,this._controlsCtor)}}async onAdded(o){await super.onAdded(o),this._cameraChanged({camera:o.scene.activeCamera}),o.scene.addEventListener("activeCameraChange",this._cameraChanged)}async onRemove(o){return this._cameraChanged({lastCamera:o.scene.activeCamera}),o.scene.removeEventListener("activeCameraChange",this._cameraChanged),super.onRemove(o)}}var DeviceOrientationControl_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const _zee=new three_module.Pq0(0,0,1),_euler=new three_module.O9p,_q0=new three_module.PTz,_q1=new three_module.PTz(-Math.sqrt(.5),0,0,Math.sqrt(.5)),_q2=new three_module.PTz,DeviceOrientationControl_changeEvent={type:"change"},EPS=1e-6;let DeviceOrientationControls2=class extends three_module.Qev{constructor(d){super(),this.enabled=!1,this.lastOrder="XYZ",this.dampingFactor=.05,this.lastQuaternion=new three_module.PTz,this.onDeviceOrientationChangeEvent=o=>{this.deviceOrientation=o},this.onScreenOrientationChangeEvent=()=>{this.screenOrientation=screen.orientation},this._initQuaternion=new three_module.PTz,this._initQuaternionInvert=new three_module.PTz,this._initQuaternionDest=new three_module.PTz,this._lastTime=-1,window.isSecureContext===!1&&console.error("DeviceOrientationControls2: DeviceOrientationEvent is only available in secure contexts (https)"),this.object=d,this.lastOrder=this.object.rotation.order,this.object.rotation.reorder("YXZ"),this.connect()}connect(){this.onScreenOrientationChangeEvent(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(d=>{d=="granted"&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent))}).catch(d=>{console.error("DeviceOrientationControls2: Unable to use DeviceOrientation API:",d)}):(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent)),this.enabled=!0,this._initQuaternion.copy(this.object.quaternion),this._initQuaternionInvert.copy(this.object.quaternion).invert()}disconnect(){window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this._initQuaternion.identity(),this._initQuaternionInvert.identity(),this._initQuaternionDest=new three_module.PTz,this.object.rotation.reorder(this.lastOrder),this.lastOrder="XYZ",this.enabled=!1}update(){if(!this.enabled)return;const d=this.deviceOrientation;if(d){const o=d.alpha!==null?three_module.cj9.degToRad(d.alpha):0,l=d.beta!==null?three_module.cj9.degToRad(d.beta):0,c=d.gamma!==null?three_module.cj9.degToRad(d.gamma):0,u=this.screenOrientation?three_module.cj9.degToRad(this.screenOrientation.angle):0;this.setObjectQuaternion(o,l,c,u),8*(1-this.lastQuaternion.dot(this.object.quaternion))>EPS&&(this.lastQuaternion.copy(this.object.quaternion),this.dispatchEvent(DeviceOrientationControl_changeEvent))}}dispose(){this.disconnect()}setObjectQuaternion(d,o,l,c){const u=g()/1e3;_euler.set(o,d,-l,"YXZ"),_q2.setFromEuler(_euler),_q2.multiply(_q1),_q2.multiply(_q0.setFromAxisAngle(_zee,-c)),this._initQuaternionDest.__init||(this._initQuaternionDest.copy(_q2).invert(),this._initQuaternionDest.__init=!0),_q2.premultiply(this._initQuaternionDest),this.object.quaternion.slerp(_q2,this.dampingFactor/(Math.min(1,u-this._lastTime)/(1/60))),this._lastTime=u}};DeviceOrientationControl_decorate([serialize(),uiSlider("Damping",[0,1],.01)],DeviceOrientationControls2.prototype,"dampingFactor",void 0),DeviceOrientationControls2=DeviceOrientationControl_decorate([uiPanel("Device Orientation Controls")],DeviceOrientationControls2);class DeviceOrientationControlsPlugin extends ACameraControlsPlugin{constructor(){super(...arguments),this.controlsKey="deviceOrientation",this._controlsCtor=(o,l)=>new DeviceOrientationControls2(o)}}DeviceOrientationControlsPlugin.PluginType="DeviceOrientationControlsPlugin";var FirstPersonControls2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const _lookDirection=new three_module.Pq0,_spherical=new three_module.YHV,_target=new three_module.Pq0,FirstPersonControls2_changeEvent={type:"change"};let FirstPersonControls2=class extends three_module.Qev{constructor(d,o){super(),this.enabled=!0,this.enableKeys=!0,this.movementSpeed=1,this.lookSpeed=.005,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!0,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.mouseDragOn=!1,this.autoSpeedFactor=0,this.pointerX=0,this.pointerY=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.moveUp=!1,this.moveDown=!1,this.viewHalfX=0,this.viewHalfY=0,this.lat=0,this.lon=0,this.targetPosition=new three_module.Pq0,this._lastTime=-1,this.object=d,this.domElement=o,this.onPointerMove=this.onPointerMove.bind(this),this.onPointerDown=this.onPointerDown.bind(this),this.onPointerUp=this.onPointerUp.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.domElement.addEventListener("contextmenu",this.onContextMenu),this.domElement.addEventListener("pointermove",this.onPointerMove),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointerup",this.onPointerUp),window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.handleResize(),this.setOrientation()}setOrientation(){const d=this.object.quaternion;_lookDirection.set(0,0,-1).applyQuaternion(d),_spherical.setFromVector3(_lookDirection),this.lat=90-three_module.cj9.radToDeg(_spherical.phi),this.lon=three_module.cj9.radToDeg(_spherical.theta)}handleResize(){this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)}onPointerDown(d){if(this.domElement!==document&&this.domElement.focus(),this.activeLook)switch(d.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseDragOn=!0}onPointerUp(d){if(this.activeLook)switch(d.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1}onPointerMove(d){this.domElement===document?(this.pointerX=d.pageX-this.viewHalfX,this.pointerY=d.pageY-this.viewHalfY):(this.pointerX=d.pageX-this.domElement.offsetLeft-this.viewHalfX,this.pointerY=d.pageY-this.domElement.offsetTop-this.viewHalfY)}onKeyDown(d){if(this.enableKeys)switch(d.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"KeyR":this.moveUp=!0;break;case"KeyF":this.moveDown=!0}}onKeyUp(d){if(this.enableKeys)switch(d.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"KeyR":this.moveUp=!1;break;case"KeyF":this.moveDown=!1}}lookAt(d,o,l){return d.isVector3?_target.copy(d):o===void 0||l===void 0?console.error("FirstPersonControls2.lookAt: y and z parameters are required"):_target.set(d,o,l),this.object.lookAt(_target),this.setOrientation(),this}update(){const d=g(),o=(this._lastTime<0?16:Math.min(d-this._lastTime,1e3))/1e3;if(this._lastTime=d,!this.enabled)return;if(this.heightSpeed){const w=three_module.cj9.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=o*(w*this.heightCoef)}else this.autoSpeedFactor=0;const l=o*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(l+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(l),this.moveLeft&&this.object.translateX(-l),this.moveRight&&this.object.translateX(l),this.moveUp&&this.object.translateY(l),this.moveDown&&this.object.translateY(-l);let c=o*this.lookSpeed;this.activeLook||(c=0);let u=1;this.constrainVertical&&(u=Math.PI/(this.verticalMax-this.verticalMin)),this.lon-=this.pointerX*c,this.lookVertical&&(this.lat-=this.pointerY*c*u),this.lat=Math.max(-85,Math.min(85,this.lat));let h=three_module.cj9.degToRad(90-this.lat);const _=three_module.cj9.degToRad(this.lon);this.constrainVertical&&(h=three_module.cj9.mapLinear(h,0,Math.PI,this.verticalMin,this.verticalMax));const A=this.object.position;this.targetPosition.setFromSphericalCoords(1,h,_).add(A),this.object.lookAt(this.targetPosition),this.dispatchEvent(FirstPersonControls2_changeEvent)}dispose(){this.domElement.removeEventListener("contextmenu",this.onContextMenu),this.domElement.removeEventListener("pointerdown",this.onPointerDown),this.domElement.removeEventListener("pointermove",this.onPointerMove),this.domElement.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}onContextMenu(d){this.enableKeys&&d.preventDefault()}};FirstPersonControls2_decorate([serialize(),uiToggle()],FirstPersonControls2.prototype,"enabled",void 0),FirstPersonControls2_decorate([serialize(),uiToggle()],FirstPersonControls2.prototype,"enableKeys",void 0),FirstPersonControls2_decorate([serialize(),uiInput()],FirstPersonControls2.prototype,"movementSpeed",void 0),FirstPersonControls2_decorate([serialize(),uiInput()],FirstPersonControls2.prototype,"lookSpeed",void 0),FirstPersonControls2_decorate([serialize(),uiToggle()],FirstPersonControls2.prototype,"lookVertical",void 0),FirstPersonControls2_decorate([serialize(),uiToggle()],FirstPersonControls2.prototype,"autoForward",void 0),FirstPersonControls2_decorate([serialize(),uiToggle()],FirstPersonControls2.prototype,"activeLook",void 0),FirstPersonControls2_decorate([serialize(),uiToggle()],FirstPersonControls2.prototype,"heightSpeed",void 0),FirstPersonControls2_decorate([serialize(),uiInput()],FirstPersonControls2.prototype,"heightCoef",void 0),FirstPersonControls2_decorate([serialize(),uiInput()],FirstPersonControls2.prototype,"heightMin",void 0),FirstPersonControls2_decorate([serialize(),uiInput()],FirstPersonControls2.prototype,"heightMax",void 0),FirstPersonControls2_decorate([serialize(),uiToggle()],FirstPersonControls2.prototype,"constrainVertical",void 0),FirstPersonControls2_decorate([serialize(),uiInput()],FirstPersonControls2.prototype,"verticalMin",void 0),FirstPersonControls2_decorate([serialize(),uiInput()],FirstPersonControls2.prototype,"verticalMax",void 0),FirstPersonControls2_decorate([serialize(),uiToggle()],FirstPersonControls2.prototype,"mouseDragOn",void 0),FirstPersonControls2=FirstPersonControls2_decorate([uiFolder("First Person Controls")],FirstPersonControls2);class FirstPersonControlsPlugin extends ACameraControlsPlugin{constructor(){super(...arguments),this.controlsKey="firstPerson",this._controlsCtor=(o,l)=>new FirstPersonControls2(o,l)}}FirstPersonControlsPlugin.PluginType="FirstPersonControlsPlugin";var PointerLockControls2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};const PointerLockControls2_euler=new three_module.O9p(0,0,0,"YXZ"),PointerLockControls2_vector=new three_module.Pq0,PointerLockControls2_changeEvent={type:"change"},_lockEvent={type:"lock"},_unlockEvent={type:"unlock"},_PI_2=Math.PI/2;let PointerLockControls2=class extends three_module.Qev{constructor(d,o){super(),this.isLocked=!1,this.enabled=!0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this.autoLockOnClick=!0,this._movementX=0,this._movementY=0,this._forwardDirection=new three_module.Pq0(0,0,-1),this.domElement=o,this.object=d,this.onElementClick=this.onElementClick.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onPointerlockChange=this.onPointerlockChange.bind(this),this.onPointerlockError=this.onPointerlockError.bind(this),this.connect()}onElementClick(d){this.isLocked||this.autoLockOnClick&&(d.preventDefault(),this.lock())}onMouseMove(d){this.isLocked&&(this._movementX+=d.movementX||d.mozMovementX||d.webkitMovementX||0,this._movementY+=d.movementY||d.mozMovementY||d.webkitMovementY||0)}onPointerlockChange(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(_lockEvent),this.isLocked=!0):(this.dispatchEvent(_unlockEvent),this.isLocked=!1)}onPointerlockError(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this.onPointerlockError),this.domElement.addEventListener("click",this.onElementClick)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this.onPointerlockError),this.domElement.removeEventListener("click",this.onElementClick)}dispose(){this.disconnect()}getDirection(d){return d.copy(this._forwardDirection).applyQuaternion(this.object.quaternion)}moveForward(d){PointerLockControls2_vector.setFromMatrixColumn(this.object.matrix,0),PointerLockControls2_vector.crossVectors(this.object.up,PointerLockControls2_vector),this.object.position.addScaledVector(PointerLockControls2_vector,d)}moveRight(d){PointerLockControls2_vector.setFromMatrixColumn(this.object.matrix,0),this.object.position.addScaledVector(PointerLockControls2_vector,d)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}update(){Math.abs(this._movementX)<1e-4&&Math.abs(this._movementY)<1e-4||(PointerLockControls2_euler.setFromQuaternion(this.object.quaternion),PointerLockControls2_euler.y-=.002*this._movementX*this.pointerSpeed,PointerLockControls2_euler.x-=.002*this._movementY*this.pointerSpeed,this._movementX=0,this._movementY=0,PointerLockControls2_euler.x=Math.max(_PI_2-this.maxPolarAngle,Math.min(_PI_2-this.minPolarAngle,PointerLockControls2_euler.x)),this.object.quaternion.setFromEuler(PointerLockControls2_euler),this.dispatchEvent(PointerLockControls2_changeEvent))}};PointerLockControls2_decorate([uiToggle(),serialize()],PointerLockControls2.prototype,"enabled",void 0),PointerLockControls2_decorate([uiInput(),serialize()],PointerLockControls2.prototype,"minPolarAngle",void 0),PointerLockControls2_decorate([uiInput(),serialize()],PointerLockControls2.prototype,"maxPolarAngle",void 0),PointerLockControls2_decorate([uiInput(),serialize()],PointerLockControls2.prototype,"pointerSpeed",void 0),PointerLockControls2_decorate([uiToggle(),serialize()],PointerLockControls2.prototype,"autoLockOnClick",void 0),PointerLockControls2=PointerLockControls2_decorate([uiPanel("Pointer Lock Controls")],PointerLockControls2);class PointerLockControlsPlugin extends ACameraControlsPlugin{constructor(){super(...arguments),this.controlsKey="pointerLock",this._controlsCtor=(o,l)=>new PointerLockControls2(o,l.ownerDocument?l:l.documentElement)}}PointerLockControlsPlugin.PluginType="PointerLockControlsPlugin";const TrackballControls_changeEvent={type:"change"},TrackballControls_startEvent={type:"start"},TrackballControls_endEvent={type:"end"};class TrackballControls extends three_module.Qev{constructor(o,l){super();const c=this,u=-1;this.object=o,this.domElement=l,this.domElement.style.touchAction="none",this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.keys=["KeyA","KeyS","KeyD"],this.mouseButtons={LEFT:three_module.kBv.ROTATE,MIDDLE:three_module.kBv.DOLLY,RIGHT:three_module.kBv.PAN},this.target=new three_module.Pq0;const h=1e-6,_=new three_module.Pq0;let A=1,w=u,C=u,M=0,O=0,ne=0;const ce=new three_module.Pq0,ue=new three_module.I9Y,ye=new three_module.I9Y,Oe=new three_module.Pq0,ke=new three_module.I9Y,Ve=new three_module.I9Y,tt=new three_module.I9Y,ht=new three_module.I9Y,ut=[],_t={};this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,this.handleResize=function(){const Jt=c.domElement.getBoundingClientRect(),Wt=c.domElement.ownerDocument.documentElement;c.screen.left=Jt.left+window.pageXOffset-Wt.clientLeft,c.screen.top=Jt.top+window.pageYOffset-Wt.clientTop,c.screen.width=Jt.width,c.screen.height=Jt.height};const at=function(){const Jt=new three_module.I9Y;return function(Wt,Zt){return Jt.set((Wt-c.screen.left)/c.screen.width,(Zt-c.screen.top)/c.screen.height),Jt}}(),lt=function(){const Jt=new three_module.I9Y;return function(Wt,Zt){return Jt.set((Wt-.5*c.screen.width-c.screen.left)/(.5*c.screen.width),(c.screen.height+2*(c.screen.top-Zt))/c.screen.width),Jt}}();function pt(Jt){c.enabled!==!1&&(ut.length===0&&(c.domElement.setPointerCapture(Jt.pointerId),c.domElement.addEventListener("pointermove",xt),c.domElement.addEventListener("pointerup",Tt)),function(Wt){ut.push(Wt)}(Jt),Jt.pointerType==="touch"?function(Wt){if(si(Wt),ut.length===1)w=3,ye.copy(lt(ut[0].pageX,ut[0].pageY)),ue.copy(ye);else{w=4;const Zt=ut[0].pageX-ut[1].pageX,ti=ut[0].pageY-ut[1].pageY;O=M=Math.sqrt(Zt*Zt+ti*ti);const ci=(ut[0].pageX+ut[1].pageX)/2,ri=(ut[0].pageY+ut[1].pageY)/2;tt.copy(at(ci,ri)),ht.copy(tt)}c.dispatchEvent(TrackballControls_startEvent)}(Jt):function(Wt){if(w===u)switch(Wt.button){case c.mouseButtons.LEFT:w=0;break;case c.mouseButtons.MIDDLE:w=1;break;case c.mouseButtons.RIGHT:w=2}const Zt=C!==u?C:w;Zt!==0||c.noRotate?Zt!==1||c.noZoom?Zt!==2||c.noPan||(tt.copy(at(Wt.pageX,Wt.pageY)),ht.copy(tt)):(ke.copy(at(Wt.pageX,Wt.pageY)),Ve.copy(ke)):(ye.copy(lt(Wt.pageX,Wt.pageY)),ue.copy(ye)),c.dispatchEvent(TrackballControls_startEvent)}(Jt))}function xt(Jt){c.enabled!==!1&&(Jt.pointerType==="touch"?function(Wt){if(si(Wt),ut.length===1)ue.copy(ye),ye.copy(lt(Wt.pageX,Wt.pageY));else{const Zt=function(Ht){const qt=Ht.pointerId===ut[0].pointerId?ut[1]:ut[0];return _t[qt.pointerId]}(Wt),ti=Wt.pageX-Zt.x,ci=Wt.pageY-Zt.y;O=Math.sqrt(ti*ti+ci*ci);const ri=(Wt.pageX+Zt.x)/2,Ct=(Wt.pageY+Zt.y)/2;ht.copy(at(ri,Ct))}}(Jt):function(Wt){const Zt=C!==u?C:w;Zt!==0||c.noRotate?Zt!==1||c.noZoom?Zt!==2||c.noPan||ht.copy(at(Wt.pageX,Wt.pageY)):Ve.copy(at(Wt.pageX,Wt.pageY)):(ue.copy(ye),ye.copy(lt(Wt.pageX,Wt.pageY)))}(Jt))}function Tt(Jt){c.enabled!==!1&&(Jt.pointerType==="touch"?function(Wt){switch(ut.length){case 0:w=u;break;case 1:w=3,ye.copy(lt(Wt.pageX,Wt.pageY)),ue.copy(ye);break;case 2:w=4;for(let Zt=0;Zt<ut.length;Zt++)if(ut[Zt].pointerId!==Wt.pointerId){const ti=_t[ut[Zt].pointerId];ye.copy(lt(ti.x,ti.y)),ue.copy(ye);break}}c.dispatchEvent(TrackballControls_endEvent)}(Jt):(w=u,c.dispatchEvent(TrackballControls_endEvent)),Vt(Jt),ut.length===0&&(c.domElement.releasePointerCapture(Jt.pointerId),c.domElement.removeEventListener("pointermove",xt),c.domElement.removeEventListener("pointerup",Tt)))}function Pt(Jt){Vt(Jt)}function Lt(Jt){c.enabled!==!1&&(window.removeEventListener("keydown",Lt),C===u&&(Jt.code!==c.keys[0]||c.noRotate?Jt.code!==c.keys[1]||c.noZoom?Jt.code!==c.keys[2]||c.noPan||(C=2):C=1:C=0))}function Bt(){c.enabled!==!1&&(C=u,window.addEventListener("keydown",Lt))}function Ut(Jt){if(c.enabled!==!1&&c.noZoom!==!0){switch(Jt.preventDefault(),Jt.deltaMode){case 2:ke.y-=.025*Jt.deltaY;break;case 1:ke.y-=.01*Jt.deltaY;break;default:ke.y-=25e-5*Jt.deltaY}c.dispatchEvent(TrackballControls_startEvent),c.dispatchEvent(TrackballControls_endEvent)}}function kt(Jt){c.enabled!==!1&&Jt.preventDefault()}function Vt(Jt){delete _t[Jt.pointerId];for(let Wt=0;Wt<ut.length;Wt++)if(ut[Wt].pointerId==Jt.pointerId)return void ut.splice(Wt,1)}function si(Jt){let Wt=_t[Jt.pointerId];Wt===void 0&&(Wt=new three_module.I9Y,_t[Jt.pointerId]=Wt),Wt.set(Jt.pageX,Jt.pageY)}this.rotateCamera=function(){const Jt=new three_module.Pq0,Wt=new three_module.PTz,Zt=new three_module.Pq0,ti=new three_module.Pq0,ci=new three_module.Pq0,ri=new three_module.Pq0;return function(){ri.set(ye.x-ue.x,ye.y-ue.y,0);let Ct=ri.length();Ct?(ce.copy(c.object.position).sub(c.target),Zt.copy(ce).normalize(),ti.copy(c.object.up).normalize(),ci.crossVectors(ti,Zt).normalize(),ti.setLength(ye.y-ue.y),ci.setLength(ye.x-ue.x),ri.copy(ti.add(ci)),Jt.crossVectors(ri,ce).normalize(),Ct*=c.rotateSpeed,Wt.setFromAxisAngle(Jt,Ct),ce.applyQuaternion(Wt),c.object.up.applyQuaternion(Wt),Oe.copy(Jt),ne=Ct):!c.staticMoving&&ne&&(ne*=Math.sqrt(1-c.dynamicDampingFactor),ce.copy(c.object.position).sub(c.target),Wt.setFromAxisAngle(Oe,ne),ce.applyQuaternion(Wt),c.object.up.applyQuaternion(Wt)),ue.copy(ye)}}(),this.zoomCamera=function(){let Jt;w===4?(Jt=M/O,M=O,c.object.isPerspectiveCamera?ce.multiplyScalar(Jt):c.object.isOrthographicCamera?(c.object.zoom=three_module.cj9.clamp(c.object.zoom/Jt,c.minZoom,c.maxZoom),A!==c.object.zoom&&c.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")):(Jt=1+(Ve.y-ke.y)*c.zoomSpeed,Jt!==1&&Jt>0&&(c.object.isPerspectiveCamera?ce.multiplyScalar(Jt):c.object.isOrthographicCamera?(c.object.zoom=three_module.cj9.clamp(c.object.zoom/Jt,c.minZoom,c.maxZoom),A!==c.object.zoom&&c.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")),c.staticMoving?ke.copy(Ve):ke.y+=(Ve.y-ke.y)*this.dynamicDampingFactor)},this.panCamera=function(){const Jt=new three_module.I9Y,Wt=new three_module.Pq0,Zt=new three_module.Pq0;return function(){if(Jt.copy(ht).sub(tt),Jt.lengthSq()){if(c.object.isOrthographicCamera){const ti=(c.object.right-c.object.left)/c.object.zoom/c.domElement.clientWidth,ci=(c.object.top-c.object.bottom)/c.object.zoom/c.domElement.clientWidth;Jt.x*=ti,Jt.y*=ci}Jt.multiplyScalar(ce.length()*c.panSpeed),Zt.copy(ce).cross(c.object.up).setLength(Jt.x),Zt.add(Wt.copy(c.object.up).setLength(Jt.y)),c.object.position.add(Zt),c.target.add(Zt),c.staticMoving?tt.copy(ht):tt.add(Jt.subVectors(ht,tt).multiplyScalar(c.dynamicDampingFactor))}}}(),this.checkDistances=function(){c.noZoom&&c.noPan||(ce.lengthSq()>c.maxDistance*c.maxDistance&&(c.object.position.addVectors(c.target,ce.setLength(c.maxDistance)),ke.copy(Ve)),ce.lengthSq()<c.minDistance*c.minDistance&&(c.object.position.addVectors(c.target,ce.setLength(c.minDistance)),ke.copy(Ve)))},this.update=function(){ce.subVectors(c.object.position,c.target),c.noRotate||c.rotateCamera(),c.noZoom||c.zoomCamera(),c.noPan||c.panCamera(),c.object.position.addVectors(c.target,ce),c.object.isPerspectiveCamera?(c.checkDistances(),c.object.lookAt(c.target),_.distanceToSquared(c.object.position)>h&&(c.dispatchEvent(TrackballControls_changeEvent),_.copy(c.object.position))):c.object.isOrthographicCamera?(c.object.lookAt(c.target),(_.distanceToSquared(c.object.position)>h||A!==c.object.zoom)&&(c.dispatchEvent(TrackballControls_changeEvent),_.copy(c.object.position),A=c.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")},this.reset=function(){w=u,C=u,c.target.copy(c.target0),c.object.position.copy(c.position0),c.object.up.copy(c.up0),c.object.zoom=c.zoom0,c.object.updateProjectionMatrix(),ce.subVectors(c.object.position,c.target),c.object.lookAt(c.target),c.dispatchEvent(TrackballControls_changeEvent),_.copy(c.object.position),A=c.object.zoom},this.dispose=function(){c.domElement.removeEventListener("contextmenu",kt),c.domElement.removeEventListener("pointerdown",pt),c.domElement.removeEventListener("pointercancel",Pt),c.domElement.removeEventListener("wheel",Ut),c.domElement.removeEventListener("pointermove",xt),c.domElement.removeEventListener("pointerup",Tt),window.removeEventListener("keydown",Lt),window.removeEventListener("keyup",Bt)},this.domElement.addEventListener("contextmenu",kt),this.domElement.addEventListener("pointerdown",pt),this.domElement.addEventListener("pointercancel",Pt),this.domElement.addEventListener("wheel",Ut,{passive:!1}),window.addEventListener("keydown",Lt),window.addEventListener("keyup",Bt),this.handleResize(),this.update()}}var TrackballControls2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let TrackballControls2=class extends TrackballControls{constructor(d,o){super(d,o),this.type="TrackballControls",this.enabled=!0,this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=999999,this.minZoom=0,this.maxZoom=999999,this.object=d}};TrackballControls2_decorate([serialize()],TrackballControls2.prototype,"type",void 0),TrackballControls2_decorate([uiToggle()],TrackballControls2.prototype,"enabled",void 0),TrackballControls2_decorate([uiInput(),serialize()],TrackballControls2.prototype,"rotateSpeed",void 0),TrackballControls2_decorate([uiInput(),serialize()],TrackballControls2.prototype,"zoomSpeed",void 0),TrackballControls2_decorate([uiInput(),serialize()],TrackballControls2.prototype,"panSpeed",void 0),TrackballControls2_decorate([uiToggle(),serialize()],TrackballControls2.prototype,"noRotate",void 0),TrackballControls2_decorate([uiToggle(),serialize()],TrackballControls2.prototype,"noZoom",void 0),TrackballControls2_decorate([uiToggle(),serialize()],TrackballControls2.prototype,"noPan",void 0),TrackballControls2_decorate([uiToggle(),serialize()],TrackballControls2.prototype,"noRoll",void 0),TrackballControls2_decorate([uiToggle(),serialize()],TrackballControls2.prototype,"staticMoving",void 0),TrackballControls2_decorate([uiInput(),serialize()],TrackballControls2.prototype,"dynamicDampingFactor",void 0),TrackballControls2_decorate([uiInput(),serialize()],TrackballControls2.prototype,"minDistance",void 0),TrackballControls2_decorate([uiInput(),serialize()],TrackballControls2.prototype,"maxDistance",void 0),TrackballControls2_decorate([uiInput(),serialize()],TrackballControls2.prototype,"minZoom",void 0),TrackballControls2_decorate([uiInput(),serialize()],TrackballControls2.prototype,"maxZoom",void 0),TrackballControls2=TrackballControls2_decorate([uiPanel("Track Ball")],TrackballControls2);class TrackballControlsPlugin extends ACameraControlsPlugin{constructor(){super(...arguments),this.controlsKey="trackball",this._controlsCtor=(o,l)=>new TrackballControls2(o,l.ownerDocument?l:l.documentElement)}}TrackballControlsPlugin.PluginType="TrackballControlsPlugin";var SimplifyModifierPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class SimplifyModifierPlugin extends AViewerPlugin{constructor(){super(),this.enabled=!0,this.toJSON=void 0,this.simplifyFactor=.5}get initialized(){return!0}async initialize(){}async onAdded(o){await super.onAdded(o),this._pickingPlugin=o.getPlugin(PickingPlugin)}simplifyGeometries(o,l){var c;if(!o){const h=(c=this._pickingPlugin)===null||c===void 0?void 0:c.getSelectedObject(),_=[];if(h==null||h.traverse(A=>{A.geometry&&!_.includes(A.geometry)&&_.push(A.geometry)}),!(o=_)||!o.length)return}Array.isArray(o)||(o=[o]);const u=[];for(const h of o)u.push(this.simplifyGeometry(h,l));return u}simplifyGeometry(o,{factor:l,count:c,replace:u=!0,disposeOnReplace:h=!1}={}){var _,A,w;if(!o){const ke=(_=this._pickingPlugin)===null||_===void 0?void 0:_.getSelectedObject();if(!(o=ke==null?void 0:ke.geometry))return}if(!o.attributes.position)return(A=this._viewer)===null||A===void 0||A.console.error("SimplifyModifierPlugin: Geometry does not have position attribute",o),o;l=l||this.simplifyFactor,c=c||o.attributes.position.count*l,o.boundingBox||o.computeBoundingBox();const C=this._simplify(o,c);C.computeBoundingBox(),C.computeBoundingSphere(),C.computeVertexNormals();const M=C.boundingBox,O=M.getSize(new three_module.Pq0);if(!isFinite(O.x)||!isFinite(O.y)||!isFinite(O.z))return(w=this._viewer)===null||w===void 0||w.console.error("SimplifyModifierPlugin: Unable to simplify",o,C,O),o;const ne=o.boundingBox,ce=ne.getSize(new three_module.Pq0),ue=O.clone().sub(ce),ye=ue.clone().divide(ce);if(ye.lengthSq()>.001&&console.warn("Simplify",o,C,M,ne,O,ce,ue,ye),!u)return C;const Oe=o.userData.__appliedMeshes;if(!Oe)return console.error("No meshes found for geometry, cannot replace",o),C;for(const ke of Oe)ke.setGeometry?ke.setGeometry(C):ke.geometry=C;return h&&o.dispose(!0),C}async simplifyAll(o,l){var c;if(!o&&this._viewer&&(o=this._viewer.scene.modelRoot),!o)return void console.error("SimplifyModifierPlugin: No root found");if(!this.initialized&&(await this.initialize(),!this.initialized))return void((c=this._viewer)===null||c===void 0||c.console.error("SimplifyModifierPlugin cannot be initialized"));const u=[];if(o.modelObject.traverse(h=>{h.geometry&&!u.includes(h.geometry)&&u.push(h.geometry)}),u.length)return this.simplifyGeometries(u,l);console.error("SimplifyModifierPlugin: No geometries found")}async simplifySelected(){var o;if(!this._viewer)return;if(!this.initialized&&(await this.initialize(),!this.initialized))return void await this._viewer.alert("Simplify: SimplifyModifierPlugin cannot be initialized");const l=(o=this._pickingPlugin)===null||o===void 0?void 0:o.getSelectedObject();if(!l)return void await this._viewer.alert("Simplify: Nothing Selected");let c=!1;l.geometry?l.children.length===0&&(c=!0):c=!0,c||await this._viewer.confirm("Simplify: Simplify all in hierarchy?")&&(c=!0),c?this.simplifyGeometries():this.simplifyGeometry(l.geometry)}}SimplifyModifierPlugin.PluginType="SimplifyModifierPlugin",SimplifyModifierPlugin_decorate([uiSlider("Simplify Factor",[0,1])],SimplifyModifierPlugin.prototype,"simplifyFactor",void 0),SimplifyModifierPlugin_decorate([uiButton("Simplify All",{sendArgs:!1})],SimplifyModifierPlugin.prototype,"simplifyAll",null),SimplifyModifierPlugin_decorate([uiButton("Simplify Selected")],SimplifyModifierPlugin.prototype,"simplifySelected",null);var MeshOptSimplifyModifierPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},MeshOptSimplifyModifierPlugin_1;let MeshOptSimplifyModifierPlugin=MeshOptSimplifyModifierPlugin_1=class extends SimplifyModifierPlugin{constructor(d=!0,o=document.head){super(),this.rootNode=o,this._initializing=void 0,this.errorThreshold=.5,this.lockBorder=!1,d&&this.initialize()}get initialized(){return!!window.MeshoptSimplifier}async initialize(){if(this.initialized)return;if(this._initializing)return await this._initializing;const d=document.createElement("script");d.type="module";const o=Math.random().toString(36).substring(7);return d.innerHTML=`
import { MeshoptSimplifier } from '${MeshOptSimplifyModifierPlugin_1.SIMPLIFIER_URL}';
MeshoptSimplifier.ready.then(() => {
window.MeshoptSimplifier = MeshoptSimplifier;
window.dispatchEvent(new CustomEvent('${o}'))
});
`,this._initializing=new Promise(l=>{window.addEventListener(o,()=>l(),{once:!0}),this.rootNode.appendChild(d),this._script=d}),await this._initializing}dispose(){this._script&&(this._script.remove(),delete window.MeshoptSimplifier),this._script=void 0}_simplify(d,o){if(!this.initialized)throw new Error("MeshOptSimplifyModifierPlugin not initialized");const l=(d=d.index?d.clone():toIndexedGeometry(d)).index.array,c=d.attributes.position.array,u=o/d.attributes.position.count,h=3*Math.floor(u*l.length/3),[_,A]=window.MeshoptSimplifier.simplify(l,c,3,h,this.errorThreshold,this.lockBorder?["LockBorder"]:[]);return console.log("srcCount",l.length/3,"destCount",_.length/3),A&&console.log("Simplify error",A),d.setIndex(new three_module.THS(new Uint32Array(_),1)),d}};MeshOptSimplifyModifierPlugin.PluginType="MeshOptSimplifyModifierPlugin",MeshOptSimplifyModifierPlugin.SIMPLIFIER_URL="https://unpkg.com/meshoptimizer@0.20.0/meshopt_simplifier.module.js",MeshOptSimplifyModifierPlugin_decorate([uiInput()],MeshOptSimplifyModifierPlugin.prototype,"errorThreshold",void 0),MeshOptSimplifyModifierPlugin_decorate([uiToggle()],MeshOptSimplifyModifierPlugin.prototype,"lockBorder",void 0),MeshOptSimplifyModifierPlugin=MeshOptSimplifyModifierPlugin_1=MeshOptSimplifyModifierPlugin_decorate([uiFolder("Simplify Modifier (meshopt)")],MeshOptSimplifyModifierPlugin);class CustomAnimationHelper{constructor(){this._animations=[],this._playingAnimations=new Set,this._clock=new three_module.zD7}loadModel(o){this._model=o,this.mixer=new three_module.Iw4(o),o&&(this._animations=[...o.animations])}get getMixer(){return this.mixer}get getAnimationClips(){return this._animations}async playAllAnimations(o){var l;const c=[];(l=this._animations)===null||l===void 0||l.forEach(u=>{c.push(this.playClip(u,o))}),await Promise.all(c)}async reverseAllAnimation(o){var l;const c=[];(l=this._animations)===null||l===void 0||l.forEach(u=>{c.push(this.playClip(u,o,1,!0))}),await Promise.all(c)}async playClip(o,l,c=1,u=!1,h=!1){if(!this.mixer)return;const _=this.mixer.clipAction(o);return this._playingAnimations.has(_)&&this.mixer.dispatchEvent({type:"canceled",action:_}),h&&(this.mixer.setTime(0),this.mixer.stopAllAction()),u?(_.paused=!1,_.timeScale=-c):(_.reset(),_.timeScale=c),_.loop=l?three_module.aMy:three_module.G3T,_.clampWhenFinished=!0,new Promise(A=>{const w=async C=>{C.action===_&&(this.mixer.removeEventListener("finished",w),this.mixer.removeEventListener("canceled",w),this._playingAnimations.delete(_),A())};this.mixer.addEventListener("finished",w),this.mixer.addEventListener("canceled",w),this._playingAnimations.add(_),_.play()})}playClipByName(o,l,c=1,u=!1){let h;this._animations.forEach(_=>{_.name===o&&(h=_)}),h&&this.playClip(h,l,c,u)}update(){const o=this._clock.getDelta();return this._playingAnimations.size>0&&(this.mixer.update(o),!0)}}class CustomAnimationHelperPlugin extends AViewerPlugin{constructor(){super(),this.helperIdentities=new Map}async onAdded(o){var l;await super.onAdded(o),(l=this._viewer)===null||l===void 0||l.addEventListener("postFrame",()=>{this.helperIdentities.forEach(c=>{var u;c.update()&&((u=this._viewer)===null||u===void 0||u.setDirty())})})}createHelper(o,l){var c;if(this.helperIdentities.has(o))(c=this._viewer)===null||c===void 0||c.console.warn("Helper with this id already exists");else{const u=new CustomAnimationHelper;u.loadModel(l),this.helperIdentities.set(o,u)}}getAnimationClips(o){if(this.helperIdentities.has(o))return this.helperIdentities.get(o).getAnimationClips}async playClip(o,l,c,u=1,h=!1,_=!1){this.helperIdentities.has(o)&&await this.helperIdentities.get(o).playClip(l,c,u,h,_)}async playAllAnimations(o,l){this.helperIdentities.has(o)&&await this.helperIdentities.get(o).playAllAnimations(l)}async playAllAnimationsInReverse(o,l){this.helperIdentities.has(o)&&await this.helperIdentities.get(o).reverseAllAnimation(l)}async playAnimationByName(o,l,c,u=1,h=!1){this.helperIdentities.has(o)&&await this.helperIdentities.get(o).playClipByName(l,c,u,h)}}CustomAnimationHelperPlugin.PluginType="AnimationHelperPlugin";class FileTransferPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.toJSON=void 0,this.defaultActions={exportFile:async(o,l,c)=>{N(o,l)}},this.actions={...this.defaultActions}}async exportFile(o,l){l=l||o.name||"file_export",this.dispatchEvent({type:"transferFile",path:l,state:"exporting"}),await this.actions.exportFile(o,l,({state:c,progress:u})=>{this.dispatchEvent({type:"transferFile",path:l,state:c??"exporting",progress:u})}),this.dispatchEvent({type:"transferFile",path:l,state:"done"})}}FileTransferPlugin.PluginType="FileTransferPlugin";var CameraViewControlPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class CameraViewControlPlugin extends AViewerPlugin{_onEnabledChanged1(){this._onEnabledChanged()}_onEnabledChanged(){this._viewer&&(this._viewer.scene.activeCamera.interactionsEnabled=!this.enabled);const o=this._cameraViews.length;this._oldState=o<2?0:three_module.cj9.clamp(this._currentState,0,o-1.001),this.enabled&&this._animateCameraToView(),this.dispatchEvent({type:"enableChanged",enabled:this.enabled})}constructor(o=!0){super(),this.enabled=!0,this.animEase="easeInOutSine",this.interpolateMode="spherical",this.enableDamping=!0,this.damping=.04,this.initAnimationTime=1,this.dependencies=[CameraViewPlugin],this._currentState=0,this._oldState=0,this._overrideTime=0,this._preFrame1=l=>{this._preFrame(l)},this.enabled=o,this._onEnabledChanged1=this._onEnabledChanged1.bind(this)}get _cameraViews(){var o,l,c;return(c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(CameraViewPlugin))===null||l===void 0?void 0:l.camViews)!==null&&c!==void 0?c:[]}setState(o){this._currentState=o}async onAdded(o){await super.onAdded(o),this.enabled&&this._onEnabledChanged(),o.addEventListener("preFrame",this._preFrame1)}async onRemove(o){return o.removeEventListener("preFrame",this._preFrame1),this.enabled=!1,super.onRemove(o)}_preFrame(o){var l;if(!this.enabled)return;const c=this._cameraViews;if(c.length<=1||!this._overrideStartView&&Math.abs(this._currentState-this._oldState)<.001)return;this.enableDamping?this._oldState=three_module.cj9.lerp(this._oldState,this._currentState,this.damping):this._oldState=this._currentState,this._oldState=three_module.cj9.clamp(this._oldState,0,c.length-1.001);const u=Math.floor(this._oldState),h=this._overrideStartView||c[u],_=this._overrideEndView||c[u+1];let A,w=this._overrideStartView?this._overrideTime:this._oldState-u;w=EasingFunctions$1[this.animEase](w),A=this.interpolateMode==="spherical"?this._lerpViewsSpherical(h,_,w):this._lerpViewsLinear(h,_,w);const C=(l=this._viewer)===null||l===void 0?void 0:l.scene.activeCamera;C&&(C.position.copy(A[0]),C.target.copy(A[1]),C.positionTargetUpdated(!0)),this._overrideStartView&&(this._overrideTime+=o.deltaTime/1e3,this._overrideTime>=this.initAnimationTime&&(this._overrideTime=0,this._overrideStartView=void 0,this._overrideEndView=void 0))}_lerpViewsLinear(o,l,c){const u=new three_module.Pq0,h=new three_module.Pq0;return h.lerpVectors(o.position,l.position,c),u.lerpVectors(o.target,l.target,c),[h,u]}_lerpViewsSpherical(o,l,c){const u=o.target.clone(),h=new three_module.Pq0,_=new three_module.Pq0,A=sphericalFromObject(o,o.target),w=sphericalFromObject(l,l.target),C=new three_module.YHV;return C.phi=lerpAngle(A.phi,w.phi,c),C.theta=lerpAngle(A.theta,w.theta,c),C.radius=three_module.cj9.lerp(A.radius,w.radius,c),h.copy(u).lerp(l.target,c),_.setFromSpherical(C),_.add(h),[_,h]}_animateCameraToView(){const o=this._cameraViews;if(!this._viewer||o.length<2||!this.enabled)return;this._overrideStartView=new CameraView(this._viewer.scene.activeCamera.position,this._viewer.scene.activeCamera.target);const l=Math.floor(this._oldState),c=this._oldState-l;let u;u=this.interpolateMode==="spherical"?this._lerpViewsSpherical(o[l],o[l+1],c):this._lerpViewsLinear(o[l],o[l+1],c),this._overrideEndView=new CameraView(u[0],u[1]),this._overrideTime=0}}CameraViewControlPlugin.PluginType="CameraViewControlPlugin",CameraViewControlPlugin_decorate([uiToggle("Enabled"),x(CameraViewControlPlugin.prototype._onEnabledChanged1),serialize()],CameraViewControlPlugin.prototype,"enabled",void 0),CameraViewControlPlugin_decorate([serialize(),uiDropdown("Ease",Object.keys(EasingFunctions$1).map(d=>({label:d})))],CameraViewControlPlugin.prototype,"animEase",void 0),CameraViewControlPlugin_decorate([serialize(),uiDropdown("Interpolation",["spherical","linear"].map(d=>({label:d})))],CameraViewControlPlugin.prototype,"interpolateMode",void 0),CameraViewControlPlugin_decorate([uiToggle("Enable Damping"),serialize()],CameraViewControlPlugin.prototype,"enableDamping",void 0),CameraViewControlPlugin_decorate([uiSlider("Damping",[.01,1],.001),serialize()],CameraViewControlPlugin.prototype,"damping",void 0),CameraViewControlPlugin_decorate([uiSlider("Init Anim Time",[.01,5],.001),serialize()],CameraViewControlPlugin.prototype,"initAnimationTime",void 0);class ScrollableCameraViewPlugin extends CameraViewControlPlugin{constructor(o=document.body,l=!0){super(l),this.wrapper=document.createElement("div"),this.toJSON=void 0,this.uiConfig={type:"folder",label:"Scrollable Camera Views",children:[...generateUiConfig(this)]},typeof o=="string"?(this.parent=document.getElementById(o),this.parent||(console.error("parent doesn't exist"),this.parent=document.body)):this.parent=o}_preFrame(o){var l;if(this.enabled&&!(this._cameraViews.length<=1))try{const c=this._findActiveView(),u=this._getScroll(c);this.setState(u+c),super._preFrame(o)}catch(c){return void(((l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("Debug"))&&console.error(c))}}_getScroll(o){var l,c;if(o>=this._cameraViews.length-1)return 0;const u=(l=this.parent.querySelector(this._cameraViews[o].name))!==null&&l!==void 0?l:this.parent.getElementsByTagName("section")[o],h=(c=this.parent.querySelector(this._cameraViews[o+1].name))!==null&&c!==void 0?c:this.parent.getElementsByTagName("section")[o+1],_=this.parent.getBoundingClientRect();if(!u||!h)return 0;const A=u.getBoundingClientRect(),w=h.getBoundingClientRect(),C=this.parent===document.body?0:_.top;return three_module.cj9.clamp((C-A.top)/Math.max(w.top-A.top,1e-4),0,1)}_findActiveView(){var o,l;for(let c=this._cameraViews.length-1;c>=0;c--){const u=(o=this.parent.querySelector(this._cameraViews[c].name))!==null&&o!==void 0?o:this.parent.getElementsByTagName("section")[c],h=this.parent.getBoundingClientRect();if(u){if(u.getBoundingClientRect().top<(this.parent===document.body?0:h.top))return c}else!((l=this._cameraViews[c].name)===null||l===void 0)&&l.startsWith("#")&&console.error("section with id "+this._cameraViews[c].name+" doesn't exist!")}return 0}}ScrollableCameraViewPlugin.PluginType="ScrollableCameraViewPlugin";var ScrollableCameraViewPreviewPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let ScrollableCameraViewPreviewPlugin=class extends ScrollableCameraViewPlugin{generateCode(){var d;const o=document.createElement("div");o.style.position="absolute",o.style.top="0",o.style.width="100%",o.style.height="100%",o.style.display="flex",o.style.flexDirection="column",o.style.justifyContent="center",o.style.alignItems="center",o.style.zIndex="200";const l=document.createElement("textarea");l.rows=20,l.style.border="3px solid #27223a",l.style.borderRadius="5px",l.style.width="30%",l.style.padding="5px",l.style.zIndex="1000";const c=document.createElement("div");c.textContent="X",c.style.color="red",c.style.width="20px",c.style.height="20px",c.style.padding="2",c.style.textAlign="center",c.style.backgroundColor="white",c.style.borderRadius="100%",c.style.border="2px solid #27223a",c.style.cursor="pointer",c.addEventListener("click",()=>{var h;(h=this._viewer)===null||h===void 0||h.container.removeChild(o)});const u=document.createElement("div");u.textContent="Update",u.style.marginTop="10px",u.style.color="white",u.style.padding="4px 10px 4px 10px",u.style.justifyContent="center",u.style.alignItems="center",u.style.backgroundColor="green",u.style.borderRadius="10px",u.style.border="2px solid #fff",u.style.cursor="pointer",u.addEventListener("click",()=>{var h,_;const A=this.parent.innerHTML;this.parent.innerHTML=l.value;let w=0;for(;w<this._cameraViews.length;w++){let C;try{C=(h=this.parent.querySelector(this._cameraViews[w].name))!==null&&h!==void 0?h:this.parent.getElementsByTagName("section")[w]}catch{C=null}if(!C&&w<2){alert("you need to add 2 sections at least");break}if(!C){const M=((_=this._cameraViews[w].name)===null||_===void 0||_.startsWith("#"),this._cameraViews[w].name.replace(/^#/,""));l.value+=M,l.value=this._format(l.value)}}w<2?this.parent.innerHTML=A:setInnerHTMLWithScripts(this.parent,l.value)}),o.appendChild(c),o.appendChild(l),o.appendChild(u),l.value=this._format(this.parent.innerHTML),(d=this._viewer)===null||d===void 0||d.container.appendChild(o)}_onEnabledChanged(){super._onEnabledChanged(),this._togglePreview()}_togglePreview(){this.wrapper&&(this.wrapper.style.zIndex=this.canvasUp?"-100":"100",this.wrapper.style.visibility=this.enabled?"visible":"hidden",this._viewer&&(this._viewer.canvas.style.pointerEvents=this.enabled&&this.canvasUp?"none":"auto"))}constructor(d=document.body,o=!1){super(d,o),this.canvasUp=!1,this._togglePreview=this._togglePreview.bind(this),this.generateCode=this.generateCode.bind(this)}async onAdded(d){var o,l,c,u,h,_;this.parent=this.wrapper,await super.onAdded(d),this._addWrapper(),this._togglePreview(),this.deserialize=this.deserialize.bind(this),this.addView=this.addView.bind(this),this.deleteView=this.deleteView.bind(this),(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(CameraViewPlugin))===null||l===void 0||l.addEventListener("viewDelete",this.deleteView),(u=(c=this._viewer)===null||c===void 0?void 0:c.getPlugin(CameraViewPlugin))===null||u===void 0||u.addEventListener("deserialize",this.deserialize),(_=(h=this._viewer)===null||h===void 0?void 0:h.getPlugin(CameraViewPlugin))===null||_===void 0||_.addEventListener("viewAdd",this.addView)}deserialize(d){this._cameraViews.forEach(o=>{this._createSection(o.name)})}_addWrapper(){var d;this.wrapper.style.width="100%",this.wrapper.style.height="100%",this.wrapper.style.zIndex="-100",this.wrapper.style.position="absolute",this.wrapper.style.top="0",this.wrapper.id="parentWrapper",this.wrapper.style.borderRadius="10px",this.wrapper.style.overflowY="scroll",this.wrapper.style.overflowX="hidden",(d=this._viewer)===null||d===void 0||d.container.appendChild(this.wrapper)}_createSection(d){const o=document.createElement("section");o.style.width="100%",o.style.height="100%",o.style.opacity="50%",o.style.backgroundColor="black",o.style.zIndex="100",o.style.top="0",o.textContent=d,o.style.color="white",o.style.fontSize="100px",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.id=d,this.parent.appendChild(o)}addView(d){this._cameraViews.forEach((o,l)=>{var c,u;let h;try{h=(c=this.parent.querySelector(o.name))!==null&&c!==void 0?c:this.parent.getElementsByTagName("section")[l]}catch{h=null}if(!h){const _=`<section id="${!((u=o.name)===null||u===void 0)&&u.startsWith("#")?o.name.replace(/^#/,""):""}" style="width: 100%; height: 100%; opacity: 0.5; background-color: black; z-index: 100; top: 0px; color: white; font-size: 100px; display: flex; align-items: center; justify-content: center;">
                    ${o.name}
                    </section>`;this.parent.innerHTML+=_}})}deleteView(d){var o;try{const l=(o=this.parent.querySelector(d.view.name))!==null&&o!==void 0?o:this.parent.getElementsByTagName("section").namedItem(d.view.name);l==null||l.remove()}catch{return}}_format(d){let o="",l="";return d.split(/>\s*</).forEach(function(c){c.match(/^\/\w/)&&(l=l.substring(1)),o+=l+"<"+c+`>\r
`,c.match(/^<?\w[^>]*[^/]$/)&&!c.startsWith("input")&&(l+="	")}),o.substring(1,o.length-3)}};ScrollableCameraViewPreviewPlugin_decorate([uiButton("Show/Edit Code")],ScrollableCameraViewPreviewPlugin.prototype,"generateCode",null),ScrollableCameraViewPreviewPlugin_decorate([uiToggle("Canvas on top"),x(ScrollableCameraViewPreviewPlugin.prototype._togglePreview)],ScrollableCameraViewPreviewPlugin.prototype,"canvasUp",void 0),ScrollableCameraViewPreviewPlugin=ScrollableCameraViewPreviewPlugin_decorate([uiFolder("Scrollable Camera View Preview (Dev)")],ScrollableCameraViewPreviewPlugin);var build_e={d:(d,o)=>{for(var l in o)build_e.o(o,l)&&!build_e.o(d,l)&&Object.defineProperty(d,l,{enumerable:!0,get:o[l]})},o:(d,o)=>Object.prototype.hasOwnProperty.call(d,o)},build_t={};build_e.d(build_t,{e:()=>build_R});var build_n=function(d,o,l,c){return new(l||(l=Promise))(function(u,h){function _(C){try{w(c.next(C))}catch(M){h(M)}}function A(C){try{w(c.throw(C))}catch(M){h(M)}}function w(C){var M;C.done?u(C.value):(M=C.value,M instanceof l?M:new l(function(O){O(M)})).then(_,A)}w((c=c.apply(d,o||[])).next())})};class build_r{constructor(o,l={resolution:2048},c={},u=!1,h=!1,_=!1){this.THREE=o,this.packOptions=l,this.chartOptions=c,this.useNormals=u,this.timeUnwrap=h,this.logProgress=_,this._libraryLoaded=!1,this._isUnwrapping=!1,this.xAtlas=this._createXAtlas()}loadLibrary(o,l,c){return build_n(this,void 0,void 0,function*(){if(!this._libraryLoaded){for(yield new Promise((u,h)=>{try{this.xAtlas.init(u,o,l,c)}catch(_){h(_)}});!this.xAtlas.api||!(yield this.xAtlas.api.loaded);)yield new Promise(u=>setTimeout(u,100));this._libraryLoaded=!0}})}packAtlas(o,l="uv2",c="uv"){return build_n(this,void 0,void 0,function*(){if(!this._libraryLoaded)throw new Error("xatlas-three: library not loaded");if(!o)throw new Error("xatlas-three: nodeList argument not provided");if(o.length<1)throw new Error("xatlas-three: nodeList must have non-zero length");const u=this.chartOptions.useInputMeshUvs;for(;this._isUnwrapping;)console.log("xatlas-three: unwrapping another mesh, waiting 100 ms"),yield new Promise(C=>setTimeout(C,100));this._isUnwrapping=!0,yield this.xAtlas.api.setProgressLogging(this.logProgress),yield this.xAtlas.api.createAtlas();let h=[],_="";for(let C of o){let{uuid:M,index:O,attributes:ne}=C;const ce=C.userData.worldScale||1;h.push(M),O&&ne.position&&ne.position.itemSize===3?(_="Mesh"+h.length+" added to atlas: "+M,this.timeUnwrap&&console.time(_),yield this.xAtlas.api.addMesh(O.array,ne.position.array,ne.normal?ne.normal.array:void 0,ne.uv?ne.uv.array:void 0,M,this.useNormals,u,ce),this.timeUnwrap&&console.timeEnd(_)):console.warn("xatlas-three: Geometry not supported: ",C)}_="Generated atlas with "+h.length+" meshes",this.timeUnwrap&&console.time(_);const A=yield this.xAtlas.api.generateAtlas(this.chartOptions,this.packOptions,!0);this.timeUnwrap&&console.timeEnd(_);let w=[];for(let C of A.meshes){let M=o.find(ce=>ce.uuid===C.mesh);if(!M){console.error("xatlas-three: Geometry not found: ",C.mesh);continue}C.vertex.vertices&&M.setAttribute("position",new this.THREE.BufferAttribute(C.vertex.vertices,3,!1)),C.vertex.normals&&M.setAttribute("normal",new this.THREE.BufferAttribute(C.vertex.normals,3,!0)),C.vertex.coords1&&M.setAttribute(l,new this.THREE.BufferAttribute(C.vertex.coords1,2,!1)),C.vertex.coords&&l!==c&&M.setAttribute(c,new this.THREE.BufferAttribute(C.vertex.coords,2,!1)),C.index&&M.setIndex(new this.THREE.BufferAttribute(C.index,1,!1)),C.subMeshes&&(M.userData.xAtlasSubMeshes=structuredClone(C.subMeshes));const O=C.oldIndexes,ne=M.attributes;for(const ce in ne){if(ce==="position"||ce==="normal"||ce===l||ce===c)continue;const ue=ne[ce],ye=ue.array.constructor,Oe=ue.itemSize,ke=ue.array,Ve=new ye(O.length*Oe),tt=new this.THREE.BufferAttribute(Ve,Oe,ue.normalized);tt.gpuType=ue.gpuType;for(let ht=0,ut=O.length;ht<ut;ht++){const _t=O[ht];for(let at=0;at<Oe;at++)Ve[ht*Oe+at]=ke[_t*Oe+at]}M.setAttribute(ce,tt)}w.push(M)}return yield this.xAtlas.api.destroyAtlas(),this._isUnwrapping=!1,{width:A.width,height:A.height,atlasCount:A.atlasCount,meshCount:A.meshCount,texelsPerUnit:A.texelsPerUnit,geometries:w,meshes:A.meshes}})}unwrapGeometry(o,l="uv",c="uv2"){return build_n(this,void 0,void 0,function*(){return this.packAtlas([o],l,c)})}}class build_s{}const build_i=Symbol("Comlink.proxy"),build_a=Symbol("Comlink.endpoint"),build_o=Symbol("Comlink.releaseProxy"),build_l=Symbol("Comlink.finalizer"),build_u=Symbol("Comlink.thrown"),build_c=d=>typeof d=="object"&&d!==null||typeof d=="function",build_h=new Map([["proxy",{canHandle:d=>build_c(d)&&d[build_i],serialize(d){const{port1:o,port2:l}=new MessageChannel;return build_p(d,o),[l,[l]]},deserialize:d=>(d.start(),build_f(d))}],["throw",{canHandle:d=>build_c(d)&&build_u in d,serialize({value:d}){let o;return o=d instanceof Error?{isError:!0,value:{message:d.message,name:d.name,stack:d.stack}}:{isError:!1,value:d},[o,[]]},deserialize(d){throw d.isError?Object.assign(new Error(d.value.message),d.value):d.value}}]]);function build_p(d,o=globalThis,l=["*"]){o.addEventListener("message",function c(u){if(!u||!u.data)return;if(!function(M,O){for(const ne of M)if(O===ne||ne==="*"||ne instanceof RegExp&&ne.test(O))return!0;return!1}(l,u.origin))return void console.warn(`Invalid origin '${u.origin}' for comlink proxy`);const{id:h,type:_,path:A}=Object.assign({path:[]},u.data),w=(u.data.argumentList||[]).map(build_L);let C;try{const M=A.slice(0,-1).reduce((ne,ce)=>ne[ce],d),O=A.reduce((ne,ce)=>ne[ce],d);switch(_){case"GET":C=O;break;case"SET":M[A.slice(-1)[0]]=build_L(u.data.value),C=!0;break;case"APPLY":C=O.apply(M,w);break;case"CONSTRUCT":C=build_x(new O(...w));break;case"ENDPOINT":{const{port1:ne,port2:ce}=new MessageChannel;build_p(d,ce),C=function(ue,ye){return build_E.set(ue,ye),ue}(ne,[ne])}break;case"RELEASE":C=void 0;break;default:return}}catch(M){C={value:M,[build_u]:0}}Promise.resolve(C).catch(M=>({value:M,[build_u]:0})).then(M=>{const[O,ne]=build_A(M);o.postMessage(Object.assign(Object.assign({},O),{id:h}),ne),_==="RELEASE"&&(o.removeEventListener("message",c),build_d(o),build_l in d&&typeof d[build_l]=="function"&&d[build_l]())}).catch(M=>{const[O,ne]=build_A({value:new TypeError("Unserializable return value"),[build_u]:0});o.postMessage(Object.assign(Object.assign({},O),{id:h}),ne)})}),o.start&&o.start()}function build_d(d){(function(o){return o.constructor.name==="MessagePort"})(d)&&d.close()}function build_f(d,o){return build_v(d,[],o)}function build_m(d){if(d)throw new Error("Proxy has been released and is not useable")}function build_g(d){return build_P(d,{type:"RELEASE"}).then(()=>{build_d(d)})}const build_y=new WeakMap,build_w="FinalizationRegistry"in globalThis&&new FinalizationRegistry(d=>{const o=(build_y.get(d)||0)-1;build_y.set(d,o),o===0&&build_g(d)});function build_v(d,o=[],l=function(){}){let c=!1;const u=new Proxy(l,{get(h,_){if(build_m(c),_===build_o)return()=>{(function(A){build_w&&build_w.unregister(A)})(u),build_g(d),c=!0};if(_==="then"){if(o.length===0)return{then:()=>u};const A=build_P(d,{type:"GET",path:o.map(w=>w.toString())}).then(build_L);return A.then.bind(A)}return build_v(d,[...o,_])},set(h,_,A){build_m(c);const[w,C]=build_A(A);return build_P(d,{type:"SET",path:[...o,_].map(M=>M.toString()),value:w},C).then(build_L)},apply(h,_,A){build_m(c);const w=o[o.length-1];if(w===build_a)return build_P(d,{type:"ENDPOINT"}).then(build_L);if(w==="bind")return build_v(d,o.slice(0,-1));const[C,M]=build_b(A);return build_P(d,{type:"APPLY",path:o.map(O=>O.toString()),argumentList:C},M).then(build_L)},construct(h,_){build_m(c);const[A,w]=build_b(_);return build_P(d,{type:"CONSTRUCT",path:o.map(C=>C.toString()),argumentList:A},w).then(build_L)}});return function(h,_){const A=(build_y.get(_)||0)+1;build_y.set(_,A),build_w&&build_w.register(h,_,h)}(u,d),u}function build_b(d){const o=d.map(build_A);return[o.map(c=>c[0]),(l=o.map(c=>c[1]),Array.prototype.concat.apply([],l))];var l}const build_E=new WeakMap;function build_x(d){return Object.assign(d,{[build_i]:!0})}function build_A(d){for(const[o,l]of build_h)if(l.canHandle(d)){const[c,u]=l.serialize(d);return[{type:"HANDLER",name:o,value:c},u]}return[{type:"RAW",value:d},build_E.get(d)||[]]}function build_L(d){switch(d.type){case"HANDLER":return build_h.get(d.name).deserialize(d.value);case"RAW":return d.value}}function build_P(d,o,l){return new Promise(c=>{const u=new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-");d.addEventListener("message",function h(_){_.data&&_.data.id&&_.data.id===u&&(d.removeEventListener("message",h),c(_.data))}),d.start&&d.start(),d.postMessage(Object.assign({id:u},o),l)})}class build_T extends build_s{init(o,l,c,u){if(!this.api){if(!u)throw new Error("workerFilePath is required");(()=>{var h,_,A;h=this,A=function*(){const w=yield fetch(u).then(O=>O.blob()),C=URL.createObjectURL(w),M=new Worker(C,{type:"module"});this.api=yield new(build_f(M))(build_x(()=>{o(),URL.revokeObjectURL(C)}),build_x((O,ne)=>O==="xatlas.wasm"?c:O+ne),build_x(l))},new((_=void 0)||(_=Promise))(function(w,C){function M(ce){try{ne(A.next(ce))}catch(ue){C(ue)}}function O(ce){try{ne(A.throw(ce))}catch(ue){C(ue)}}function ne(ce){var ue;ce.done?w(ce.value):(ue=ce.value,ue instanceof _?ue:new _(function(ye){ye(ue)})).then(M,O)}ne((A=A.apply(h,[])).next())})})()}}}class build_R extends build_r{_createXAtlas(){return new build_T}}var build_k=build_t.e,XAtlasPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},XAtlasPlugin_1;let UChartOptions=class{constructor(){this.fixWinding=!1,this.maxBoundaryLength=0,this.maxChartArea=0,this.maxCost=2,this.maxIterations=1,this.normalDeviationWeight=2,this.normalSeamWeight=4,this.roundnessWeight=.009999999776482582,this.straightnessWeight=6,this.textureSeamWeight=.5,this.useInputMeshUvs=!1}};XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"fixWinding",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"maxBoundaryLength",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"maxChartArea",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"maxCost",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"maxIterations",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"normalDeviationWeight",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"normalSeamWeight",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"roundnessWeight",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"straightnessWeight",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"textureSeamWeight",void 0),XAtlasPlugin_decorate([serialize()],UChartOptions.prototype,"useInputMeshUvs",void 0),UChartOptions=XAtlasPlugin_decorate([uiFolder("Chart Options"),serializable("UChartOptions")],UChartOptions);let UPackOptions=class{constructor(){this.bilinear=!0,this.blockAlign=!1,this.bruteForce=!1,this.createImage=!1,this.maxChartSize=0,this.padding=0,this.resolution=0,this.rotateCharts=!0,this.rotateChartsToAxis=!0,this.texelsPerUnit=0}};XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"bilinear",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"blockAlign",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"bruteForce",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"createImage",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"maxChartSize",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"padding",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"resolution",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"rotateCharts",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"rotateChartsToAxis",void 0),XAtlasPlugin_decorate([serialize()],UPackOptions.prototype,"texelsPerUnit",void 0),UPackOptions=XAtlasPlugin_decorate([uiFolder("Pack Options"),serializable("UPackOptions")],UPackOptions);let XAtlasPlugin=XAtlasPlugin_1=class extends AViewerPlugin{constructor(d=!1){super(),this.enabled=!0,this.useNormals=!0,this.chartOptions=new UChartOptions,this.packOptions=new UPackOptions,this._loaded=!1,this._unwrapProgress=(o,l)=>{console.log("Unwrapping",o,l)},this.unwrapSelected=async()=>{var o,l,c,u,h;const _=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.getSelectedObject();if(_)if(_.geometry){if(_.geometry.attributes.uv&&!await((h=this._viewer)===null||h===void 0?void 0:h.confirm("Unwrap: Geometry already has UVs. Overwrite?")))return;await this.unwrapGeometry(_.geometry)}else(u=this._viewer)===null||u===void 0||u.alert("Unwrap: Selected object has no geometry");else(c=this._viewer)===null||c===void 0||c.alert("Unwrap: No object selected")},d&&this.loadLibrary()}async loadLibrary(){if(this._unwrapper)for(;!this._loaded;)await X(100);else this._unwrapper=new build_k({BufferAttribute:three_module.THS},this.packOptions,this.chartOptions,this.useNormals),await this._unwrapper.loadLibrary(this._unwrapProgress,XAtlasPlugin_1.LIBRARY_PATH+"xatlas.wasm",XAtlasPlugin_1.LIBRARY_PATH+"xatlas.js"),console.log("xatlas loaded"),this._loaded=!0}async unwrapGeometry(d,o="uv",l="uv"){var c;await this.loadLibrary(),await((c=this._unwrapper)===null||c===void 0?void 0:c.unwrapGeometry(d,o,l))}async packAtlas(d,o=!0,l="uv2",c="uv"){var u;await this.loadLibrary(),Array.isArray(d)||(d=[d]);const h=[];o?d.forEach(_=>_.traverse(A=>{A.geometry&&h.push(A.geometry)})):d.forEach(_=>{_.geometry&&h.push(_.geometry)}),await((u=this._unwrapper)===null||u===void 0?void 0:u.packAtlas(h,l,c))}_useNormalsChanged(){this._unwrapper&&(this._unwrapper.useNormals=this.useNormals)}};XAtlasPlugin.PluginType="XAtlasPlugin",XAtlasPlugin.LIBRARY_PATH="https://cdn.jsdelivr.net/npm/xatlasjs@0.1.0/dist/",XAtlasPlugin_decorate([x(XAtlasPlugin.prototype._useNormalsChanged),serialize()],XAtlasPlugin.prototype,"useNormals",void 0),XAtlasPlugin_decorate([serialize()],XAtlasPlugin.prototype,"chartOptions",void 0),XAtlasPlugin_decorate([serialize()],XAtlasPlugin.prototype,"packOptions",void 0),XAtlasPlugin_decorate([uiButton("Unwrap Selected Geometry")],XAtlasPlugin.prototype,"unwrapSelected",void 0),XAtlasPlugin=XAtlasPlugin_1=XAtlasPlugin_decorate([uiFolder("UV Unwrapping (xAtlas)")],XAtlasPlugin);class VariationConfiguratorPlugin extends AViewerPlugin{constructor(){super(...arguments),this.dependencies=[AssetManagerPlugin],this.enabled=!0,this.serializeWithViewer=!1,this.baseUrl="",this.variations={objects:[],materials:[]},this.autoDispose=!0,this._ty=["objects","materials"],this._extForType={objects:["glb","fbx","obj","gltf","stl","3dm","json","vjson"],materials:["pmat","dmat"],images:["png","jpg","jpeg","gif","bmp","webp","svg"]},this.utils={getName:o=>o.name||o.prefix.replace(/^\//,"").replace(/\/$/,"").replaceAll("/","_"),getTitle:o=>o.title||this.utils.getName(o),getIcon:(o,l)=>{let c=o.icon;return(c&&/^(\w+)\(([^)]*)\)/.exec(c)||/^#([A-Fa-f\d]+)$/.exec(c))&&(c=Je(c)),c&&c.startsWith("http")&&c.startsWith("data:")||(c=this.utils.pathToIcon(this.baseUrl+l+"/"+o.prefix+(c||""))),c},getItemIcon:(o,l,c)=>{const u=o.iconFiles[l];if(u)return URL.createObjectURL(u);let h=o.icons[l];return(h&&/^(\w+)\(([^)]*)\)/.exec(h)||/^#([A-Fa-f\d]+)$/.exec(h))&&(h=Je(h)),h||(h=this.utils.pathToIcon(o.items[l])),!h||h.startsWith("http")||h.startsWith("data:")||(h=this.baseUrl+c+"/"+o.prefix+h),h},getItemTitle:(o,l)=>o.titles[l]||this.utils.pathToTitle(o.items[l]),getItemPath:(o,l,c)=>o.items[l].startsWith("http")?o.items[l]:`${this.baseUrl}${c}/${o.prefix}${o.items[l]}`,pathToTitle:o=>o.split("/").pop().replace(/\.[^.]*$/,""),pathToIcon:o=>o.replace(/\/$/,"").replace(/\.[^/.]+$/,"")+".webp"},this.toJSON=void 0}_getVariationId(o){return this.utils.getName(o)}async applyVariation(o,l,c,u=!1){var h,_;if(!this._viewer)return;const A=this._getVariationId(o);typeof l=="number"&&(l=o.items[l]);const w=o.items.indexOf(l);if(w===-1)return void this._viewer.console.warn(`Item ${l} not found`);const C=o.itemFiles[w],M=o.selected;if(!u&&M===w)return;o.selected=w;const O=this._viewer.getManager(),ne=this.utils.getItemPath(o,w,c);if(c==="objects"){let ce=this._viewer.scene.findObjectsByName(A).map(Ve=>Ve.modelObject);ce.length===0&&(ce=[(await this._viewer.createObject3D()).modelObject],ce[0].name=A),this._viewer.renderEnabled=!1;for(const Ve of ce)[...Ve.children].forEach(tt=>tt.dispose&&this.autoDispose?tt.dispose():tt.removeFromParent());const ue=await this._loadObject(ne,C);if(!ue.length)return void(ne.endsWith("json")||this._viewer.console.warn(`Object ${ne} not found`));let ye=!1;for(const Ve of ce){[...Ve.children].forEach(tt=>tt.dispose&&this.autoDispose?tt.dispose():tt.removeFromParent());for(const tt of ue)ye?Ve.add(tt.modelObject.clone()):Ve.add(tt.modelObject);ye=!0}const Oe=[],ke=this.variations.materials.filter(Ve=>Ve&&typeof Ve.selected=="number");for(const Ve of ke)Oe.push(this.applyVariation(Ve,Ve.selected,"materials",!0));await Promise.all(Oe),this._viewer.renderEnabled=!0}if(c==="materials"){const ce=await this._loadMaterial(ne,C);if(!ce)return void this._viewer.console.warn(`Material ${ne} not found`);ce.userData.__isVariation=!0;const ue=this._viewer.scene.findObjectsByName(A),ye=Oe=>{var ke,Ve,tt,ht;Oe.material&&(!((ke=o.data)===null||ke===void 0)&&ke.matType)&&(Array.isArray(Oe.material)?Oe.material.length!==0&&((Ve=o.data)===null||Ve===void 0?void 0:Ve.matType)!==Oe.material[0].typeSlug:((tt=o.data)===null||tt===void 0?void 0:tt.matType)!==Oe.material.typeSlug)||(ht=Oe==null?void 0:Oe.setMaterial)===null||ht===void 0||ht.call(Oe,ce)};for(const Oe of ue)!((h=o.data)===null||h===void 0)&&h.traverse?Oe.traverse(ye):ye(Oe);(_=O.materials)===null||_===void 0||_.applyMaterial(ce,A)}}clearVariations(){const o=this.variations.objects;if(this.variations.materials,this.variations={objects:[],materials:[]},this._viewer)for(const l of o){const c=this._getVariationId(l),u=this._viewer.scene.findObjectsByName(c);for(const h of u)[...h.children].forEach(_=>{var A;return((A=_.dispose)!==null&&A!==void 0?A:_.removeFromParent)()})}}async _loadMaterial(o,l){var c,u,h;return(h=(u=(c=this._viewer)===null||c===void 0?void 0:c.getManager())===null||u===void 0?void 0:u.importer)===null||h===void 0?void 0:h.importSinglePath(o,{importedFile:l})}async _loadObject(o,l){var c,u,h;return(h=(u=(c=this._viewer)===null||c===void 0?void 0:c.getManager())===null||u===void 0?void 0:u.importer)===null||h===void 0?void 0:h.importPath(o,{importedFile:l,reimportDisposed:!0})}importConfig(o,l){var c,u;typeof o=="string"&&(o=JSON.parse(o)),o.baseUrl!==void 0&&(this.baseUrl=o.baseUrl),!l&&o.folder&&(l=typeof o.folder=="object"?o.folder:typeof o.folder=="string"?unzipSync(strToU8(o.folder)):unzipSync(o.folder));for(const h of this._ty)if(o[h])for(const _ of o[h]){const A={items:_.items,prefix:_.prefix,name:_.name,title:_.title||"",icon:_.icon||"",icons:(c=_.icons)!==null&&c!==void 0?c:_.items.map(()=>""),titles:(u=_.titles)!==null&&u!==void 0?u:_.items.map(()=>""),itemFiles:[],iconFiles:[],data:{..._.data}};if(l)for(let w=0;w<_.items.length;w++){const C=_.items[w],M=l[h+"/"+_.prefix+C];A.itemFiles[w]=M?new File([M],C):void 0;const O=_.icons[w];if(!O)continue;const ne=l[h+"/"+_.prefix+O];A.iconFiles[w]=ne?new File([ne],O):void 0}this.variations[h].push(A)}}async importPath(o){var l,c;if(o.endsWith(".json")){const u=await((c=(l=this._viewer)===null||l===void 0?void 0:l.getManager().importer)===null||c===void 0?void 0:c.importSinglePath(o,{processImported:!1})),h=o.split("?")[0];return this.baseUrl||(this.baseUrl=h.substring(0,h.lastIndexOf("/")+1)),this.importConfig(u)}o.endsWith(".zip")?alert("not implemented"):alert("not supported")}getMaterials(o){var l;return((l=this.variations.materials.find(c=>this.utils.getName(c)===o))===null||l===void 0?void 0:l.items)||[]}getObjects(o){var l;return((l=this.variations.objects.find(c=>this.utils.getName(c)===o))===null||l===void 0?void 0:l.items)||[]}getMaterialVariations(){return this.variations.materials.map(o=>this.utils.getName(o))}getObjectVariations(){return this.variations.objects.map(o=>this.utils.getName(o))}async onRemove(o){return super.onRemove(o)}fromJSON(o){return super.fromJSON(o)?(this.importConfig(o),this):null}async _exportConfiguratorState(){var o;let l={objects:{},materials:{}};const c={objects:[],materials:[],type:VariationConfiguratorPlugin.PluginType};this.baseUrl&&(c.baseUrl=this.baseUrl);let u=!1;for(const h of this._ty)for(const _ of this.variations[h]){const A={..._};A.data={...A.data},delete A.itemFiles,delete A.iconFiles,c[h].push(A);const w=_.prefix.replace(/^\//,""),C=w.trimEnd().endsWith("/")?"":w.split("/").pop()||"",M=w.replace(C,"").trimEnd().replace(/\/$/,""),O={};let ne=!1;for(let ye=0;ye<_.items.length;ye++){const Oe=_.items[ye],ke=_.itemFiles[ye],Ve=_.iconFiles[ye],tt=_.icons[ye];ke?(O[C+Oe]=new Uint8Array(await ke.arrayBuffer()),Ve&&!tt&&((o=this._viewer)===null||o===void 0||o.console.error("Icon file without icon name")),Ve&&tt&&(O[C+tt]=new Uint8Array(await Ve.arrayBuffer())),ne=!0):Ve&&alert("Icon file without model/material file not supported")}if(!ne)continue;u=!0;const ce=M.split("/");let ue=l[h];for(const ye of ce){ue[ye]||(ue[ye]={});const Oe=ue[ye];if(typeof Oe!="object")throw new Error("Invalid prefix: "+_.prefix);ue=Oe}Object.assign(ue,O)}return u||(l=void 0),{folder:l,config:c}}}VariationConfiguratorPlugin.PluginType="VariationConfiguratorPlugin";class VariationConfiguratorGridUiPlugin extends VariationConfiguratorPlugin{constructor(){super(),this._uiNeedRefresh=!1,this._refreshUi=this._refreshUi.bind(this)}async onAdded(o){await super.onAdded(o),o.addEventListener("preFrame",this._refreshUi)}async onRemove(o){return o.removeEventListener("preFrame",this._refreshUi),super.onRemove(o)}refreshUi(){this.enabled&&(this._uiNeedRefresh=!0)}async _refreshUi(){if(!this.enabled||!this._viewer||!this._uiNeedRefresh)return!1;this._uiNeedRefresh=!1,CustomContextGrid.RemoveAll(VariationConfiguratorGridUiPlugin.PluginType);for(const o of["objects","materials"])for(const l of this.variations[o])CustomContextGrid.Create(VariationConfiguratorGridUiPlugin.PluginType,this.utils.getTitle(l),5,20,0,l.items.map((c,u)=>({id:c,image:this.utils.getItemIcon(l,u,o),onClick:async h=>this.applyVariation(l,h,o,!1),tooltip:this.utils.getItemTitle(l,u)})),(c,u)=>tippy_esm(c,{placement:"bottom",content:u.tooltip}));return CustomContextGrid.RebuildUi(this._viewer.container),!0}}VariationConfiguratorGridUiPlugin.PluginType="VariationConfiguratorPlugin";class VariationConfiguratorEditorUiPlugin extends VariationConfiguratorGridUiPlugin{constructor(){super(...arguments),this._uiExpandedState={},this.uiConfig={type:"folder",label:"Configurator",children:[{type:"input",label:"Base URL",property:[this,"baseUrl"]},...this._ty.map(o=>({type:"folder",expanded:this._uiExpandedState["__/"+o],onExpand:()=>this._uiExpandedState["__/"+o]=!0,onCollapse:()=>this._uiExpandedState["__/"+o]=!1,label:o,children:[()=>this.variations[o].map(l=>({type:"folder",expanded:this._uiExpandedState[l.name],onExpand:()=>this._uiExpandedState[l.name]=!0,onCollapse:()=>this._uiExpandedState[l.name]=!1,label:()=>this.utils.getName(l),children:[{type:"input",placeholder:()=>this.utils.getName(l),property:[l,"name"]},{type:"input",property:[l,"prefix"]},{type:"input",placeholder:()=>this.utils.pathToTitle(this.utils.getName(l)),property:[l,"title"]},{type:"input",placeholder:()=>this.utils.pathToIcon(this.baseUrl+l.prefix),property:[l,"icon"]},{type:"folder",label:"items",children:l.items.map((c,u)=>({type:"folder",label:()=>l.items[u],children:[{type:"input",label:"File/URL",isMonitor:!l.itemFiles[u],getValue:()=>l.items[u],setValue:h=>{l.items[u]=h}},{type:"input",label:"Icon/Image",placeholder:this.utils.pathToIcon(l.items[u]),getValue:()=>l.icons[u],setValue:h=>{l.icons[u]=h}},{type:"input",label:"Title",placeholder:this.utils.pathToTitle(l.items[u]),getValue:()=>l.titles[u],setValue:h=>{l.titles[u]=h}},{type:"button",label:"Apply",value:async()=>this.applyVariation(l,u,o)},l.itemFiles[u]?[{type:"button",label:"Remove",value:()=>{l.items.splice(u,1),l.itemFiles.splice(u,1),this.refreshUi()}},{type:"button",label:"Replace",value:async()=>{const h=await ge(!1,!1);h.length!==0&&(l.itemFiles[u]=h[0],l.items[u]=h[0].name,this.refreshUi())}},{type:"button",label:"Download",value:async()=>{const h=l.itemFiles[u];N(h,h.name)}}]:{}]}))},{type:"button",label:"Add item (local)",value:async()=>{var c,u,h;const _=await ge(!0,!1);if(_.length!==0){for(const A of _){if(!this._extForType[o].includes((c=A.name.split(".").pop())!==null&&c!==void 0?c:"")){await((u=this._viewer)===null||u===void 0?void 0:u.alert(`Invalid file: ${A.name} is not a valid ${o} file`));continue}if(l.items.includes(A.name)){await((h=this._viewer)===null||h===void 0?void 0:h.alert(`Already exists: Item with name ${A.name} already exists`));continue}const w=l.items.push(A.name)-1;l.icons[w]="",l.titles[w]="",l.itemFiles[w]=A}this.refreshUi()}}},{type:"button",label:"Add item (url)",value:async()=>{var c,u,h,_,A;const w=await((c=this._viewer)===null||c===void 0?void 0:c.prompt("URL: Enter the url of the object/material"));if(!w)return;if(!w.startsWith("http")&&!this.baseUrl.startsWith("http"))return void await((u=this._viewer)===null||u===void 0?void 0:u.alert(`Invalid url: ${w} should be a valid HTTP(S) url. If you are passing a relative path, set the baseURL first`));if(!this._extForType[o].includes((h=w.split(".").pop())!==null&&h!==void 0?h:""))return void await((_=this._viewer)===null||_===void 0?void 0:_.alert(`Invalid url: ${w} should be of a material ending with mat`));l.items.includes(w)&&await((A=this._viewer)===null||A===void 0?void 0:A.alert(`Already exists: Item with url ${w} already exists`)),l.items.push(w);const C=l.items.length-1;l.icons[C]="",l.titles[C]="",this.refreshUi()}},{type:"button",label:()=>"Remove "+this.utils.getName(l),value:async()=>{var c;await((c=this._viewer)===null||c===void 0?void 0:c.confirm(`Delete Group: Are you sure you want to remove ${this.utils.getName(l)}?`))&&(this.variations[o].splice(this.variations[o].indexOf(l),1),this.refreshUi())}}]})),{type:"button",label:`Add ${o} group (empty)`,value:async()=>{var l;const c=await((l=this._viewer)===null||l===void 0?void 0:l.prompt("Name: Enter the name of the object/material"));c&&(this.variations[o].push({items:[],itemFiles:[],icons:[],iconFiles:[],titles:[],prefix:c+"/",name:c,icon:"",title:""}),this.refreshUi())}},{type:"button",label:`Add ${o} group (local folder)`,value:async()=>{var l,c,u,h;const _=await ge(!1,!0);if(_.length===0)return;const A=[],w=[],C=[],M=[];for(const ye of _){if(ye.name.startsWith("."))continue;const Oe=(l=ye.name.split(".").pop())!==null&&l!==void 0?l:"";Oe?this._extForType[o].includes(Oe)?(A.push(ye.webkitRelativePath.replace(/^\//,"")),w.push(ye)):this._extForType.images.includes(Oe)?(C.push(ye.webkitRelativePath.replace(/^\//,"")),M.push(ye)):await((u=this._viewer)===null||u===void 0?void 0:u.alert(`Invalid file: ${ye.name} is not a valid ${o} file`)):await((c=this._viewer)===null||c===void 0?void 0:c.alert(`Invalid file: ${ye.name} has no extension`))}const O=he(A),ne=this.utils.getName({prefix:O});let ce=await((h=this._viewer)===null||h===void 0?void 0:h.prompt("Name: Enter the name of the object/material",ne,!0));if(ce===null)return;ce=ce||ne;const ue=A.map(ye=>{var Oe;const ke=ye.replace(O,""),Ve=(Oe=ke.split(".").pop())!==null&&Oe!==void 0?Oe:"",tt=ke.replace("."+Ve,"")+".",ht=C.findIndex(ut=>ut.replace(O,"").startsWith(tt));return ht<0?["",void 0]:[C[ht].replace(O,""),M[ht]||void 0]});this.variations[o].push({items:A.map(ye=>ye.replace(O,"")),icons:ue.map(ye=>ye[0]),iconFiles:ue.map(ye=>ye[1]),titles:A.map(()=>""),itemFiles:w,prefix:O,name:ce,icon:"",title:""}),this.refreshUi()}}]})),{type:"button",label:"Download JSON/Zip",value:async()=>{var o,l;try{const{folder:c,config:u}=await this._exportConfiguratorState(),h=JSON.stringify(u,null,4);if(c){c["config.json"]=strToU8(h);const _=await zipSync(c);N(new Blob([_],{type:"application/zip"}),"configurator.zip")}else N(new Blob([h],{type:"application/json"}),"config.json")}catch(c){return(o=this._viewer)===null||o===void 0||o.console.error(c),void await((l=this._viewer)===null||l===void 0?void 0:l.alert("Error: "+((c==null?void 0:c.message)||c)))}}},{type:"button",label:"Load JSON/Zip",value:async()=>{var o,l,c;const u=await ge(!1,!1,"application/zip,application/json");if(u.length===0)return;const h=u[0];if(h.name.endsWith(".zip")){const _=unzipSync(new Uint8Array(await h.arrayBuffer()));if(!_["config.json"])return void await((o=this._viewer)===null||o===void 0?void 0:o.alert("Invalid zip: config.json not found"));const A=JSON.parse(strFromU8(_["config.json"]));this.importConfig(A,_)}else{if(!h.name.endsWith(".json"))return void await((l=this._viewer)===null||l===void 0?void 0:l.alert("Invalid file: "+h.name));{const _=JSON.parse(await h.text());this.importConfig(_)}}await((c=this._viewer)===null||c===void 0?void 0:c.alert("Imported successfully")),this.refreshUi()}},{type:"button",label:"Import Path",value:async()=>{var o,l;const c=await((o=this._viewer)===null||o===void 0?void 0:o.prompt("URL: Enter the url of the json file."));c&&(await this.importPath(c),await((l=this._viewer)===null||l===void 0?void 0:l.alert("Imported successfully")),this.refreshUi())}},{type:"button",label:"Refresh UI",value:()=>{this.refreshUi()}},{type:"button",label:"Clear All",value:async()=>{var o;await((o=this._viewer)===null||o===void 0?void 0:o.confirm("Clear: Are you sure you want to clear the configuration ?"))&&(this.variations.objects=[],this.variations.materials=[],this.refreshUi())}}]}}_refreshUiConfig(){var o,l;(l=(o=this.uiConfig)===null||o===void 0?void 0:o.uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0)}refreshUi(){this._refreshUiConfig(),super.refreshUi()}async _loadObject(o,l){const c=await super._loadObject(o,l);for(const u of c)(u.modelObject||u).userData.excludeFromExport=!0;return c}}VariationConfiguratorEditorUiPlugin.PluginType="VariationConfiguratorPlugin";class TransformAnimationPlugin extends AViewerPlugin{constructor(){super(),this.toJSON=void 0,this.enabled=!0,this._addSceneObject=o=>{const l=o.object;l!=null&&l.traverse&&l.traverse(c=>{var u,h;if(c.isWidget)return;c.userData[TransformAnimationPlugin.PluginType]===void 0&&(c.userData[TransformAnimationPlugin.PluginType]={transforms:[]});const _={type:"folder",label:"Transform Animation",children:[{type:"button",label:"Add Current Transform",value:()=>{var A;this.addTransform(c),(A=_==null?void 0:_.uiRefresh)===null||A===void 0||A.call(_)}},()=>{var A;return(A=c.userData[TransformAnimationPlugin.PluginType])===null||A===void 0?void 0:A.transforms.map((w,C)=>({type:"folder",label:`Transform ${C}`,children:[{type:"vec3",label:"Position",property:[w,"position"]},{type:"vec3",label:"Quaternion",property:[w,"quaternion"]},{type:"vec3",label:"Scale",property:[w,"scale"]},{type:"button",label:"Set",value:()=>{this.setTransform(c,w)}},{type:"button",label:"Animate",value:()=>{this.animateTransform(c,w)}}]}))}]};(h=(u=c.uiConfig)===null||u===void 0?void 0:u.children)===null||h===void 0||h.push(_)})}}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("addSceneObject",this._addSceneObject)}async onRemove(o){return o.scene.removeEventListener("addSceneObject",this._addSceneObject),super.onRemove(o)}addTransform(o){o.userData[TransformAnimationPlugin.PluginType].transforms.push({position:o.position.clone(),quaternion:o.quaternion.clone(),scale:o.scale.clone()})}setTransform(o,l){var c,u,h,_;o.position.copy(l.position),o.quaternion.copy(l.quaternion),o.scale.copy(l.scale),(u=(c=o.userData).setDirty)===null||u===void 0||u.call(c),(_=(h=o.uiConfig)===null||h===void 0?void 0:h.uiRefresh)===null||_===void 0||_.call(h)}animateTransform(o,l,c=2e3){var u,h;const _=(u=this._viewer)===null||u===void 0?void 0:u.getPluginByType("PopmotionPlugin");_||(h=this._viewer)===null||h===void 0||h.console.error("PopmotionPlugin required for animation");const A=typeof l=="number"?o.userData[TransformAnimationPlugin.PluginType].transforms[l]:l,w=new three_module.Pq0,C=new three_module.PTz,M=new three_module.Pq0,O=o.position.clone(),ne=o.quaternion.clone(),ce=o.scale.clone(),ue=A.position,ye=A.quaternion,Oe=A.scale;return _==null?void 0:_.animate({from:0,to:1,duration:c,onUpdate:ke=>{var Ve,tt;w.lerpVectors(O,ue,ke),C.slerpQuaternions(ne,ye,ke),M.lerpVectors(ce,Oe,ke),o.position.copy(w),o.quaternion.copy(C),o.scale.copy(M),(Ve=this._viewer)===null||Ve===void 0||Ve.setDirty(),(tt=this._viewer)===null||tt===void 0||tt.renderer.resetShadows()},onStop:()=>{var ke,Ve,tt,ht;o.position.copy(A.position),o.quaternion.copy(A.quaternion),o.scale.copy(A.scale),(Ve=(ke=o.userData).setDirty)===null||Ve===void 0||Ve.call(ke),(ht=(tt=o.uiConfig)===null||tt===void 0?void 0:tt.uiRefresh)===null||ht===void 0||ht.call(tt)}})}}TransformAnimationPlugin.PluginType="TransformAnimationPlugin";var VirtualCamerasPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let VirtualCamerasPlugin=class extends AViewerPlugin{constructor(d=!0){super(),this.enabled=!0,this.toJSON=void 0,this.cameras=[],this._preRender=()=>{if(this.enabled&&this._viewer)for(const o of this.cameras){if(!o.enabled)continue;const l=this._viewer,c=o.camera;try{this.dispatchEvent({type:"preRenderCamera",camera:o}),l.scene.renderCamera=c,l.renderer.render(!1);const u=l.renderer.composer.readBuffer;this.dispatchEvent({type:"preBlitCamera",camera:o,readBuffer:u}),l.renderer.blit(u.texture,o.target),this.dispatchEvent({type:"postRenderCamera",camera:o})}catch(u){console.error(u),o.enabled=!1}}},this.enabled=d}async onAdded(d){await super.onAdded(d),d.addEventListener("preRender",this._preRender)}addCamera(d){if(!this._viewer)throw"Plugin not added to viewer";const o={camera:d,target:this._viewer.renderer.composerTarget.clone(!0),enabled:!0};return this.cameras.push(o),o}};function updateAttribute(d,o,l,c,u){const h=d.getAttribute(o),_=c.length/l;return h&&h.count===_?(h.set(c),h.needsUpdate=!0):d.setAttribute(o,new(u??three_module.qtW)(c,l)),h}function updateIndices(d,o){const l=d.index;l&&l.count===o.length?(l.set(o),l.needsUpdate=!0):d.setIndex(o)}function updateUi(d,o){var l,c,u;if(!d.uiConfig)return;let h=(l=d.uiConfig.children)===null||l===void 0?void 0:l.find(_=>{var A;return(A=_.tags)===null||A===void 0?void 0:A.includes("generatedGeometry")});h||(h={type:"folder",label:"Generation Params",tags:["generatedGeometry"],children:[]},(c=d.uiConfig.children)===null||c===void 0||c.push(h)),d.userData.__generationParamsUiType!==d.userData.generationParams.type&&(h.children=o(),d.userData.__generationParamsUiType=d.userData.generationParams.type,(u=h.uiRefresh)===null||u===void 0||u.call(h,"postFrame",!0))}VirtualCamerasPlugin.PluginType="VirtualCamerasPlugin",VirtualCamerasPlugin_decorate([uiToggle()],VirtualCamerasPlugin.prototype,"enabled",void 0),VirtualCamerasPlugin=VirtualCamerasPlugin_decorate([uiFolder("Virtual Cameras")],VirtualCamerasPlugin);class AGeometryGenerator{constructor(o){this.type=o}createUiConfig(o){const l=generateUiConfig(o.userData.generationParams).filter(c=>{var u;return((u=Ee(c.property))===null||u===void 0?void 0:u[1])!=="type"});return l.forEach(c=>{c.onChange=()=>this.generate(o)}),l}generate(o,l={}){const c=o??new three_module.LoY;if(c.userData.generationParams||(c.userData.generationParams={type:this.type}),c.userData.generationParams.type=this.type,l.type)return console.error("Cannot set type parameter here, use the plugin instead"),c;const u={...this.defaultParams,...c.userData.generationParams,...l},{indices:h,vertices:_,normals:A,uvs:w,groups:C}=this._generateData(u);if(updateIndices(c,h),updateAttribute(c,"position",3,_),updateAttribute(c,"normal",3,A),updateAttribute(c,"uv",2,w),C){c.clearGroups();for(const M of C)c.addGroup(M.start,M.count,M.materialIndex)}return c.computeBoundingBox(),c.computeBoundingSphere(),Object.assign(c.userData.generationParams,u),updateUi(c,()=>this.createUiConfig(c)),c.dispatchEvent({type:"geometryUpdate"}),c}}class SphereGeometryGenerator extends AGeometryGenerator{constructor(){super(...arguments),this.defaultParams={radius:1,widthSegments:32,heightSegments:16,phiStart:0,phiLength:2*Math.PI,thetaStart:0,thetaLength:Math.PI}}_generateData(o){const{radius:l,phiStart:c,phiLength:u,thetaStart:h,thetaLength:_}=o;let{widthSegments:A,heightSegments:w}=o;A=Math.max(3,Math.floor(A)),w=Math.max(2,Math.floor(w));const C=Math.min(h+_,Math.PI);let M=0;const O=[],ne=new three_module.Pq0,ce=new three_module.Pq0,ue=[],ye=[],Oe=[],ke=[];for(let Ve=0;Ve<=w;Ve++){const tt=[],ht=Ve/w;let ut=0;Ve===0&&h===0?ut=.5/A:Ve===w&&C===Math.PI&&(ut=-.5/A);for(let _t=0;_t<=A;_t++){const at=_t/A;ne.x=-l*Math.cos(c+at*u)*Math.sin(h+ht*_),ne.y=l*Math.cos(h+ht*_),ne.z=l*Math.sin(c+at*u)*Math.sin(h+ht*_),ye.push(ne.x,ne.y,ne.z),ce.copy(ne).normalize(),Oe.push(ce.x,ce.y,ce.z),ke.push(at+ut,1-ht),tt.push(M++)}O.push(tt)}for(let Ve=0;Ve<w;Ve++)for(let tt=0;tt<A;tt++){const ht=O[Ve][tt+1],ut=O[Ve][tt],_t=O[Ve+1][tt],at=O[Ve+1][tt+1];(Ve!==0||h>0)&&ue.push(ht,ut,at),(Ve!==w-1||C<Math.PI)&&ue.push(ut,_t,at)}return{indices:ue,vertices:ye,normals:Oe,uvs:ke}}}class PlaneGeometryGenerator extends AGeometryGenerator{constructor(){super(...arguments),this.defaultParams={width:1,height:1,widthSegments:2,heightSegments:2}}_generateData(o){const l=o.width/2,c=o.height/2,u=Math.floor(o.widthSegments),h=Math.floor(o.heightSegments),_=u+1,A=h+1,w=o.width/u,C=o.height/h,M=[],O=[],ne=[],ce=[];for(let ue=0;ue<A;ue++){const ye=ue*C-c;for(let Oe=0;Oe<_;Oe++){const ke=Oe*w-l;O.push(ke,-ye,0),ne.push(0,0,1),ce.push(Oe/u),ce.push(1-ue/h)}}for(let ue=0;ue<h;ue++)for(let ye=0;ye<u;ye++){const Oe=ye+_*ue,ke=ye+_*(ue+1),Ve=ye+1+_*(ue+1),tt=ye+1+_*ue;M.push(Oe,ke,tt),M.push(ke,Ve,tt)}return{indices:M,vertices:O,normals:ne,uvs:ce}}}class CircleGeometryGenerator extends AGeometryGenerator{constructor(){super(...arguments),this.defaultParams={radius:1,segments:32,thetaStart:0,thetaLength:2*Math.PI}}_generateData(o){const{radius:l,thetaStart:c,thetaLength:u}=o,h=Math.max(3,o.segments),_=[],A=[],w=[],C=[],M=new three_module.Pq0,O=new three_module.I9Y;A.push(0,0,0),w.push(0,0,1),C.push(.5,.5);for(let ne=0,ce=3;ne<=h;ne++,ce+=3){const ue=c+ne/h*u;M.x=l*Math.cos(ue),M.y=l*Math.sin(ue),A.push(M.x,M.y,M.z),w.push(0,0,1),O.x=(A[ce]/l+1)/2,O.y=(A[ce+1]/l+1)/2,C.push(O.x,O.y)}for(let ne=1;ne<=h;ne++)_.push(ne,ne+1,0);return{indices:_,vertices:A,normals:w,uvs:C}}}class TorusGeometryGenerator extends AGeometryGenerator{constructor(){super(...arguments),this.defaultParams={radius:1,tube:.4,radialSegments:12,tubularSegments:48,arc:2*Math.PI}}_generateData(o){const{radius:l,tube:c,arc:u}=o;let{radialSegments:h,tubularSegments:_}=o;h=Math.floor(h),_=Math.floor(_);const A=[],w=[],C=[],M=[],O=new three_module.Pq0,ne=new three_module.Pq0,ce=new three_module.Pq0;for(let ue=0;ue<=h;ue++)for(let ye=0;ye<=_;ye++){const Oe=ye/_*u,ke=ue/h*Math.PI*2;ne.x=(l+c*Math.cos(ke))*Math.cos(Oe),ne.y=(l+c*Math.cos(ke))*Math.sin(Oe),ne.z=c*Math.sin(ke),w.push(ne.x,ne.y,ne.z),O.x=l*Math.cos(Oe),O.y=l*Math.sin(Oe),ce.subVectors(ne,O).normalize(),C.push(ce.x,ce.y,ce.z),M.push(ye/_),M.push(ue/h)}for(let ue=1;ue<=h;ue++)for(let ye=1;ye<=_;ye++){const Oe=(_+1)*ue+ye-1,ke=(_+1)*(ue-1)+ye-1,Ve=(_+1)*(ue-1)+ye,tt=(_+1)*ue+ye;A.push(Oe,ke,tt),A.push(ke,Ve,tt)}return{indices:A,vertices:w,normals:C,uvs:M}}}class CylinderGeometryGenerator extends AGeometryGenerator{constructor(){super(...arguments),this.defaultParams={radiusTop:1,radiusBottom:1,height:1,radialSegments:32,heightSegments:1,openEnded:!1,thetaStart:0,thetaLength:2*Math.PI}}_generateTorso(o){const{radiusTop:l,radiusBottom:c,height:u,radialSegments:h,heightSegments:_,thetaStart:A,thetaLength:w,indexArray:C,indices:M,groups:O,vertices:ne,normals:ce,uvs:ue,groupStart:ye,halfHeight:Oe}=o,ke=new three_module.Pq0,Ve=new three_module.Pq0;let tt=0;const ht=(c-l)/u;for(let ut=0;ut<=_;ut++){const _t=[],at=ut/_,lt=at*(c-l)+l;for(let pt=0;pt<=h;pt++){const xt=pt/h,Tt=xt*w+A,Pt=Math.sin(Tt),Lt=Math.cos(Tt);Ve.x=lt*Pt,Ve.y=-at*u+Oe,Ve.z=lt*Lt,ne.push(Ve.x,Ve.y,Ve.z),ke.set(Pt,ht,Lt).normalize(),ce.push(ke.x,ke.y,ke.z),ue.push(xt,1-at),_t.push(o.index++)}C.push(_t)}for(let ut=0;ut<h;ut++)for(let _t=0;_t<_;_t++){const at=C[_t][ut],lt=C[_t+1][ut],pt=C[_t+1][ut+1],xt=C[_t][ut+1];M.push(at,lt,xt),M.push(lt,pt,xt),tt+=6}O.push({start:ye,count:tt,materialIndex:0}),o.groupStart+=tt}_generateCap(o,l){const{radiusTop:c,radiusBottom:u,radialSegments:h,thetaStart:_,thetaLength:A,indices:w,groups:C,vertices:M,normals:O,uvs:ne,groupStart:ce,halfHeight:ue}=o,ye=o.index,Oe=new three_module.I9Y,ke=new three_module.Pq0;let Ve=0;const tt=l===!0?c:u,ht=l===!0?1:-1;for(let _t=1;_t<=h;_t++)M.push(0,ue*ht,0),O.push(0,ht,0),ne.push(.5,.5),o.index++;const ut=o.index;for(let _t=0;_t<=h;_t++){const at=_t/h*A+_,lt=Math.cos(at),pt=Math.sin(at);ke.x=tt*pt,ke.y=ue*ht,ke.z=tt*lt,M.push(ke.x,ke.y,ke.z),O.push(0,ht,0),Oe.x=.5*lt+.5,Oe.y=.5*pt*ht+.5,ne.push(Oe.x,Oe.y),o.index++}for(let _t=0;_t<h;_t++){const at=ye+_t,lt=ut+_t;l===!0?w.push(lt,lt+1,at):w.push(lt+1,lt,at),Ve+=3}C.push({start:ce,count:Ve,materialIndex:l===!0?1:2}),o.groupStart+=Ve}_generateData(o){let{radialSegments:l,heightSegments:c}=o;l=Math.floor(l),c=Math.floor(c);const u={indices:[],vertices:[],normals:[],uvs:[],numberOfVertices:0,groupStart:0,groups:[],index:0,indexArray:[],halfHeight:o.height/2,...o,radialSegments:l,heightSegments:c};return this._generateTorso(u),o.openEnded===!1&&(o.radiusTop>0&&this._generateCap(u,!0),o.radiusBottom>0&&this._generateCap(u,!1)),u}}class BoxGeometryGenerator extends AGeometryGenerator{constructor(){super(...arguments),this.defaultParams={width:1,height:1,depth:1,widthSegments:1,heightSegments:1,depthSegments:1}}_buildPlane(o,l,c,u,h,_,A,w,C,M,O,ne){const{indices:ce,vertices:ue,normals:ye,uvs:Oe,numberOfVertices:ke,groupStart:Ve,groups:tt}=o,ht=A/M,ut=w/O,_t=A/2,at=w/2,lt=C/2,pt=M+1,xt=O+1;let Tt=0,Pt=0;const Lt=new three_module.Pq0;for(let Bt=0;Bt<xt;Bt++){const Ut=Bt*ut-at;for(let kt=0;kt<pt;kt++){const Vt=kt*ht-_t;Lt[l]=Vt*h,Lt[c]=Ut*_,Lt[u]=lt,ue.push(Lt.x,Lt.y,Lt.z),Lt[l]=0,Lt[c]=0,Lt[u]=C>0?1:-1,ye.push(Lt.x,Lt.y,Lt.z),Oe.push(kt/M),Oe.push(1-Bt/O),Tt+=1}}for(let Bt=0;Bt<O;Bt++)for(let Ut=0;Ut<M;Ut++){const kt=ke+Ut+pt*Bt,Vt=ke+Ut+pt*(Bt+1),si=ke+(Ut+1)+pt*(Bt+1),Jt=ke+(Ut+1)+pt*Bt;ce.push(kt,Vt,Jt),ce.push(Vt,si,Jt),Pt+=6}tt.push({start:Ve,count:Pt,materialIndex:ne}),o.groupStart+=Pt,o.numberOfVertices+=Tt}_generateData(o){const{width:l,height:c,depth:u}=o;let{widthSegments:h,heightSegments:_,depthSegments:A}=o;h=Math.floor(h),_=Math.floor(_),A=Math.floor(A);const w={indices:[],vertices:[],normals:[],uvs:[],numberOfVertices:0,groupStart:0,groups:[]};return this._buildPlane(w,"z","y","x",-1,-1,u,c,l,A,_,0),this._buildPlane(w,"z","y","x",1,-1,u,c,-l,A,_,1),this._buildPlane(w,"x","z","y",1,1,l,u,c,h,A,2),this._buildPlane(w,"x","z","y",1,-1,l,u,-c,h,A,3),this._buildPlane(w,"x","y","z",1,-1,l,c,u,h,_,4),this._buildPlane(w,"x","y","z",-1,-1,l,c,-u,h,_,5),w}}class GeometryGeneratorPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.toJSON=void 0,this.generators={plane:new PlaneGeometryGenerator("plane"),sphere:new SphereGeometryGenerator("sphere"),box:new BoxGeometryGenerator("box"),circle:new CircleGeometryGenerator("circle"),torus:new TorusGeometryGenerator("torus"),cylinder:new CylinderGeometryGenerator("cylinder")},this._sceneUpdate=o=>{var l;if(o.hierarchyChanged){const c=o.object||((l=this._viewer)===null||l===void 0?void 0:l.scene.modelRoot);c&&c.traverse(u=>{var h,_,A;const w=(A=(_=(h=u.geometry)===null||h===void 0?void 0:h.userData)===null||_===void 0?void 0:_.generationParams)===null||A===void 0?void 0:A.type;w&&updateUi(u.geometry,()=>{var C;const M=this.generators[w];return M!=null&&M.createUiConfig&&(C=M.createUiConfig(u.geometry))!==null&&C!==void 0?C:[]})})}},this.uiConfig={type:"folder",label:"Generate Geometry",children:[()=>Object.keys(this.generators).map(o=>({type:"button",label:"Generate "+o,value:async()=>{(await this.generateObject(o)).name=o}}))]}}async generateObject(o){var l,c;const u=this.generators[o];if(!u)throw new Error("Unknown generator type: "+o);const h=await((c=(l=this._viewer)===null||l===void 0?void 0:l.getManager())===null||c===void 0?void 0:c.addImportedSingle(new three_module.eaF(new three_module.LoY,new MeshStandardMaterial2({color:16711680})),{autoScale:!1,autoCenter:!1}));return u.generate(h.modelObject.geometry),h.name=o,h.geometry.name="Generated "+o,h.modelObject}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("sceneUpdate",this._sceneUpdate)}}GeometryGeneratorPlugin.PluginType="GeometryGeneratorPlugin";var MaterialPresetPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class MaterialPresetPlugin extends AViewerPlugin{constructor(){super(...arguments),this.serializeWithViewer=!1,this.enabled=!0,this.mapping=[],this.presets={},this.getMaterialPresetByName=o=>this.presets&&this.presets.length!=0?this.presets[o.type].find(l=>l.path.split("/").pop()==o.name):null,this.applyOnLoad=!0,this.replaceMaterial=!0}async onAdded(o){await super.onAdded(o)}loadPresets(o,l){this.presets=o,this.basePath=l,this.dispatchEvent({type:"loadPresets"})}async fromJSON(o,l){return o&&o.materials&&!o.mapping&&(o.mapping=o.materials,delete o.materials),super.fromJSON(o,l)?(this.applyOnLoad&&await this.applyAll(),this):null}async applyAll(){var o;const l=[];for(const c of this.mapping)l.push(this._apply(c.name,c.path,(o=c.regex)===null||o===void 0||o));await Promise.all(l)}async _apply(o,l,c=!0){var u,h,_,A,w;const C=(u=this._viewer)===null||u===void 0?void 0:u.getManager();if(!l||!o||!C)return;l=(h=(l=(l!=null&&l.startsWith("https://")?"":this.basePath||"")+l)==null?void 0:l.replace)===null||h===void 0?void 0:h.call(l,/(https?:\/\/)|(\/)+/g,(ne,ce)=>ce||"/");let M=await((_=C.importer)===null||_===void 0?void 0:_.importSinglePath(l));if(!M)return void console.warn("MaterialPresetPlugin: Material not found",l);this.replaceMaterial&&(M=M.clone?M.clone():M),M.name=o;const O=new Set;(w=(A=this._viewer)===null||A===void 0?void 0:A.scene)===null||w===void 0||w.traverse(ne=>{ne.material&&(c?ne.material.name.match("^"+o+"$"):ne.material.name===o)&&O.add(ne)}),O.forEach(ne=>{var ce,ue,ye;if(this.replaceMaterial||!ne.material){const Oe=((ce=ne.material)===null||ce===void 0?void 0:ce.name)||ne.name;(ue=ne==null?void 0:ne.setMaterial)===null||ue===void 0||ue.call(ne,M),ne.material.name=Oe}else{const Oe=Array.isArray(ne.material)?ne.material:[ne.material];for(const ke of Oe)(ye=C.materials)===null||ye===void 0||ye.copyMaterialProps(ke,M)}})}async addMapping(o,l,c=!0){if(!o||!l)return;const u=this.mapping.findIndex(h=>h.name===o);return u!==-1?this.mapping[u]={name:o,path:l}:this.mapping.push({name:o,path:l}),c?this._apply(o,l):void 0}}MaterialPresetPlugin.PluginType="MaterialPresetPlugin",MaterialPresetPlugin_decorate([serialize()],MaterialPresetPlugin.prototype,"mapping",void 0);var TransfrSharePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let TransfrSharePlugin=class extends AViewerPlugin{constructor(){super(...arguments),this.toJSON=null,this.enabled=!0,this.dependencies=[AssetExporterPlugin],this._exporting=!1}async exportObject(d){var o,l;const c=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(AssetExporterPlugin);if(!c)throw new Error("AssetExporterPlugin not found");return d?(l=c.exporter)===null||l===void 0?void 0:l.exportObject(d,{format:"glb"}):c.exportScene(c.exportOptions)}async getLink(d){var o;const l=await this.exportObject(d);if(!l)throw new Error("Failed to export object or scene");const c=await fetch("https://bee.transfr.one/model.glb",{method:"PUT",body:l});if(c.status!==200)throw new Error("Failed to upload file");const u=(o=await c.text())===null||o===void 0?void 0:o.trim();console.log(u);try{new URL(u)}catch{throw new Error("Invalid URL "+u)}return u}async shareLink(d,o="m"){var l;if(this._exporting)return;this._exporting=!0;let c=await this.getLink().catch(u=>{var h,_;return(h=this._viewer)===null||h===void 0||h.console.error(u),(_=this._viewer)===null||_===void 0||_.alert(`Error: Failed to share scene: 
`+u.message),null});if(c){if(d){const h=typeof d=="string"?new URL(d):d;h.searchParams.set(o??"m",c),c=h.href}let u=!1;try{window&&window.navigator&&navigator.clipboard&&(await navigator.clipboard.writeText(c),u=!0)}catch(h){console.error("Failed to copy link",h)}(l=this._viewer)===null||l===void 0||l.alert("Link"+(u?" Copied: ":": "+c)+`

Note: File will be deleted in 7 days`)}return this._exporting=!1,c}async shareEditorLink(){const d=new URL(window.location.href);return this.shareLink(d)}async shareViewerLink(){const d=new URL(window.location.href);return d.pathname=d.pathname.replace(/editor\.html$/,"viewer.html"),this.shareLink(d)}};TransfrSharePlugin.PluginType="TransfrSharePlugin",TransfrSharePlugin_decorate([uiButton("Share editor link")],TransfrSharePlugin.prototype,"shareEditorLink",null),TransfrSharePlugin_decorate([uiButton("Share viewer link")],TransfrSharePlugin.prototype,"shareViewerLink",null),TransfrSharePlugin=TransfrSharePlugin_decorate([uiFolder("Share Link")],TransfrSharePlugin);var ndarray_ndarray=__webpackgi_require__(881),ndarray_ops=__webpackgi_require__(49);function getPixelsInternal(d,o){if(!(d instanceof Uint8Array))throw new Error("[ndarray-pixels] Input must be Uint8Array or Buffer.");const l=new Blob([d],{type:o}),c=URL.createObjectURL(l);return new Promise((u,h)=>{const _=new Image;_.crossOrigin="anonymous",_.onload=function(){URL.revokeObjectURL(c);const A=new OffscreenCanvas(_.width,_.height).getContext("2d");A.drawImage(_,0,0);const w=A.getImageData(0,0,_.width,_.height);u(ndarray_ndarray(new Uint8Array(w.data),[_.width,_.height,4],[4,4*_.width,1],0))},_.onerror=A=>{URL.revokeObjectURL(c),h(A)},_.src=c})}function putPixelData(d,o,l=-1){if(d.shape.length===4)return putPixelData(d.pick(l),o,0);if(d.shape.length===3)if(d.shape[2]===3)ndarray_ops.assign(ndarray_ndarray(o,[d.shape[0],d.shape[1],3],[4,4*d.shape[0],1]),d),ndarray_ops.assigns(ndarray_ndarray(o,[d.shape[0]*d.shape[1]],[4],3),255);else if(d.shape[2]===4)ndarray_ops.assign(ndarray_ndarray(o,[d.shape[0],d.shape[1],4],[4,4*d.shape[0],1]),d);else{if(d.shape[2]!==1)throw new Error("[ndarray-pixels] Incompatible array shape.");ndarray_ops.assign(ndarray_ndarray(o,[d.shape[0],d.shape[1],3],[4,4*d.shape[0],1]),ndarray_ndarray(d.data,[d.shape[0],d.shape[1],3],[d.stride[0],d.stride[1],0],d.offset)),ndarray_ops.assigns(ndarray_ndarray(o,[d.shape[0]*d.shape[1]],[4],3),255)}else{if(d.shape.length!==2)throw new Error("[ndarray-pixels] Incompatible array shape.");ndarray_ops.assign(ndarray_ndarray(o,[d.shape[0],d.shape[1],3],[4,4*d.shape[0],1]),ndarray_ndarray(d.data,[d.shape[0],d.shape[1],3],[d.stride[0],d.stride[1],0],d.offset)),ndarray_ops.assigns(ndarray_ndarray(o,[d.shape[0]*d.shape[1]],[4],3),255)}return o}async function savePixelsInternal(d,o){const l=new OffscreenCanvas(d.shape[0],d.shape[1]),c=l.getContext("2d"),u=c.getImageData(0,0,l.width,l.height);return putPixelData(d,u.data),c.putImageData(u,0,0),streamCanvas(l,o)}async function streamCanvas(d,o){const l=await d.convertToBlob(o),c=await l.arrayBuffer();return new Uint8Array(c)}async function ndarray_pixels_browser_modern_getPixels(d,o){return getPixelsInternal(d,o)}async function ndarray_pixels_browser_modern_savePixels(d,o){let l;return l=typeof o=="string"?{type:o,quality:void 0}:{type:o.type,quality:o.quality},savePixelsInternal(d,l)}function functions_modern_extends(){return functions_modern_extends=Object.assign?Object.assign.bind():function(d){for(var o=1;o<arguments.length;o++){var l=arguments[o];for(var c in l)({}).hasOwnProperty.call(l,c)&&(d[c]=l[c])}return d},functions_modern_extends.apply(null,arguments)}index_modern_Primitive.Mode;function createTransform(d,o){return Object.defineProperty(o,"name",{value:d}),o}async function rewriteTexture(d,o,l){if(!d)return null;const c=d.getImage();if(!c)return null;const u=await ndarray_pixels_browser_modern_getPixels(c,d.getMimeType());for(let _=0;_<u.shape[0];++_)for(let A=0;A<u.shape[1];++A)l(u,_,A);const h=await ndarray_pixels_browser_modern_savePixels(u,"image/png");return o.setImage(h).setMimeType("image/png")}var functions_modern_ARRAY_TYPE=typeof Float32Array<"u"?Float32Array:Array;function create$1(){var d=new functions_modern_ARRAY_TYPE(3);return functions_modern_ARRAY_TYPE!=Float32Array&&(d[0]=0,d[1]=0,d[2]=0),d}Math.hypot||(Math.hypot=function(){for(var d=0,o=arguments.length;o--;)d+=arguments[o]*arguments[o];return Math.sqrt(d)});create$1();index_modern_PropertyType.ACCESSOR,index_modern_PropertyType.MESH,index_modern_PropertyType.TEXTURE,index_modern_PropertyType.MATERIAL,index_modern_PropertyType.SKIN;function functions_modern_create(){var d=new functions_modern_ARRAY_TYPE(4);return functions_modern_ARRAY_TYPE!=Float32Array&&(d[0]=0,d[1]=0,d[2]=0,d[3]=0),d}functions_modern_create();index_modern_PropertyType.NODE,index_modern_PropertyType.SKIN,index_modern_PropertyType.MESH,index_modern_PropertyType.CAMERA,index_modern_PropertyType.PRIMITIVE,index_modern_PropertyType.PRIMITIVE_TARGET,index_modern_PropertyType.ANIMATION,index_modern_PropertyType.MATERIAL,index_modern_PropertyType.TEXTURE,index_modern_PropertyType.ACCESSOR,index_modern_PropertyType.BUFFER;var VertexCountMethod;(function(d){d.RENDER="render",d.RENDER_CACHED="render-cached",d.UPLOAD="upload",d.UPLOAD_NAIVE="upload-naive",d.DISTINCT="distinct",d.DISTINCT_POSITION="distinct-position",d.UNUSED="unused"})(VertexCountMethod||(VertexCountMethod={}));index_modern_Accessor.ComponentType;index_modern_Primitive.Mode;index_modern_Primitive.Mode;index_modern_AnimationChannel.TargetPath;const QUANTIZE_DEFAULTS={pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0,cleanup:!0};functions_modern_extends({level:"high"},QUANTIZE_DEFAULTS);const functions_modern_NAME$d="metalRough",METALROUGH_DEFAULTS={};function metalRough(d=METALROUGH_DEFAULTS){return createTransform(functions_modern_NAME$d,async o=>{const l=o.getLogger();if(!o.getRoot().listExtensionsUsed().map(A=>A.extensionName).includes("KHR_materials_pbrSpecularGlossiness"))return void l.warn(`${functions_modern_NAME$d}: KHR_materials_pbrSpecularGlossiness not found on document.`);const c=o.createExtension(KHRMaterialsIOR),u=o.createExtension(KHRMaterialsSpecular),h=o.createExtension(KHRMaterialsPBRSpecularGlossiness),_=new Set;for(const A of o.getRoot().listMaterials()){const w=A.getExtension("KHR_materials_pbrSpecularGlossiness");if(!w)continue;const C=u.createSpecular().setSpecularFactor(1).setSpecularColorFactor(w.getSpecularFactor());_.add(w.getSpecularGlossinessTexture()),_.add(A.getBaseColorTexture()),_.add(A.getMetallicRoughnessTexture()),A.setBaseColorFactor(w.getDiffuseFactor()).setMetallicFactor(0).setRoughnessFactor(1).setExtension("KHR_materials_ior",c.createIOR().setIOR(1e3)).setExtension("KHR_materials_specular",C);const M=w.getDiffuseTexture();M&&(A.setBaseColorTexture(M),A.getBaseColorTextureInfo().copy(w.getDiffuseTextureInfo()));const O=w.getSpecularGlossinessTexture();if(O){const ne=w.getSpecularGlossinessTextureInfo(),ce=o.createTexture();await rewriteTexture(O,ce,(Oe,ke,Ve)=>{Oe.set(ke,Ve,3,255)}),C.setSpecularTexture(ce),C.setSpecularColorTexture(ce),C.getSpecularTextureInfo().copy(ne),C.getSpecularColorTextureInfo().copy(ne);const ue=w.getGlossinessFactor(),ye=o.createTexture();await rewriteTexture(O,ye,(Oe,ke,Ve)=>{const tt=255-Math.round(Oe.get(ke,Ve,3)*ue);Oe.set(ke,Ve,0,0),Oe.set(ke,Ve,1,tt),Oe.set(ke,Ve,2,0),Oe.set(ke,Ve,3,255)}),A.setMetallicRoughnessTexture(ye),A.getMetallicRoughnessTextureInfo().copy(ne)}else C.setSpecularColorFactor(w.getSpecularFactor()),A.setRoughnessFactor(1-w.getGlossinessFactor());A.setExtension("KHR_materials_pbrSpecularGlossiness",null)}h.dispose();for(const A of _)A&&A.listParents().length===1&&A.dispose();l.debug(`${functions_modern_NAME$d}: Complete.`)})}var InterpolationInternal;(function(d){d[d.STEP=0]="STEP",d[d.LERP=1]="LERP",d[d.SLERP=2]="SLERP"})(InterpolationInternal||(InterpolationInternal={}));const functions_modern_EPSILON=1e-6;function resampleDebug(d,o,l,c=1e-4){const u=o.length/d.length,h=new Array(u).fill(0),_=new Array(u).fill(0),A=new Array(u).fill(0),w=new Array(u).fill(0),C=d.length-1;let M=1;for(let O=1;O<C;++O){const ne=d[M-1],ce=d[O],ue=d[O+1],ye=(ce-ne)/(ue-ne);let Oe=!1;if(ce!==ue&&(O!==1||ce!==d[0]))if(getElement(o,M-1,w),getElement(o,O,_),getElement(o,O+1,A),l==="slerp"){const ke=functions_modern_slerp(h,w,A,ye),Ve=getAngle(w,_)+getAngle(_,A);Oe=!eq(_,ke,c)||Ve+Number.EPSILON>=Math.PI}else l==="lerp"?Oe=!eq(_,vlerp(h,w,A,ye),c):l==="step"&&(Oe=!eq(_,w)||!eq(_,A));Oe&&(O!==M&&(d[M]=d[O],setElement(o,M,getElement(o,O,h))),M++)}return C>0&&(d[M]=d[C],setElement(o,M,getElement(o,C,h)),M++),M}function getElement(d,o,l){for(let c=0,u=l.length;c<u;c++)l[c]=d[o*u+c];return l}function setElement(d,o,l){for(let c=0,u=l.length;c<u;c++)d[o*u+c]=l[c]}function eq(d,o,l=0){if(d.length!==o.length)return!1;for(let c=0;c<d.length;c++)if(Math.abs(d[c]-o[c])>l)return!1;return!0}function lerp(d,o,l){return d*(1-l)+o*l}function vlerp(d,o,l,c){for(let u=0;u<o.length;u++)d[u]=lerp(o[u],l[u],c);return d}function functions_modern_slerp(d,o,l,c){let u,h,_,A,w,C=o[0],M=o[1],O=o[2],ne=o[3],ce=l[0],ue=l[1],ye=l[2],Oe=l[3];return h=C*ce+M*ue+O*ye+ne*Oe,h<0&&(h=-h,ce=-ce,ue=-ue,ye=-ye,Oe=-Oe),1-h>functions_modern_EPSILON?(u=Math.acos(h),_=Math.sin(u),A=Math.sin((1-c)*u)/_,w=Math.sin(c*u)/_):(A=1-c,w=c),d[0]=A*C+w*ce,d[1]=A*M+w*ue,d[2]=A*O+w*ye,d[3]=A*ne+w*Oe,d}function getAngle(d,o){const l=dot(d,o);return Math.acos(2*l*l-1)}function dot(d,o){return d[0]*o[0]+d[1]*o[1]+d[2]*o[2]+d[3]*o[3]}Promise.resolve();index_modern_Primitive.Mode;var TextureResizeFilter;(function(d){d.LANCZOS3="lanczos3",d.LANCZOS2="lanczos2"})(TextureResizeFilter||(TextureResizeFilter={}));TextureResizeFilter.LANCZOS3;const gltfKhrPbrSpecularGlossinessConverter=d=>o=>({name:"KHR_materials_pbrSpecularGlossiness",beforeRoot:async()=>{var l,c;try{if(!o.json.extensionsUsed.includes("KHR_materials_pbrSpecularGlossiness")||d&&!await d("Convert KHR_materials_pbrSpecularGlossiness to KHR_materials_pbrMetallicRoughness?"))return;const u=o.json,h=new WebIO().registerExtensions(ALL_EXTENSIONS).registerExtensions(ALL_WEBGI_EXTENSIONS);if(o.extensions.KHR_draco_mesh_compression){const C=o.extensions.KHR_draco_mesh_compression.dracoLoader;if(!C.isDRACOLoader2)return void console.error("DRACOLoader2 required for gltfKhrPbrSpecularGlossinessConverter");const M=await C.initDecoder();h.registerDependencies({"draco3d.decoder":M})}const _=await h.readJSON({json:u,resources:{"@glb.bin":new Uint8Array((l=o.extensions.KHR_binary_glTF)===null||l===void 0?void 0:l.body)}});await _.transform(metalRough()),o.extensions.KHR_draco_mesh_compression&&((c=_.getRoot().listExtensionsUsed().find(C=>C.extensionName==="KHR_draco_mesh_compression"))===null||c===void 0||c.dispose());const A=await h.writeBinary(_),w=new GLTFBinaryExtension(A.buffer);o.extensions.KHR_binary_glTF=w,o.json=JSON.parse(w.content)}catch(u){return void console.error(u)}}});class GLTFSpecGlossinessConverterPlugin extends AViewerPlugin{_loaderCreate({loader:o}){o.isGLTFLoader2&&o.register(gltfKhrPbrSpecularGlossinessConverter(async()=>{var l,c;return!!this.enabled&&((c=(l=this._viewer)===null||l===void 0?void 0:l.confirm("GLTF Load: This file includes specular glossiness materials, do you want to convert it to metallic roughness before load?"))===null||c===void 0||c)}))}constructor(){super(),this.enabled=!0,this.toJSON=void 0,this.dependencies=[AssetManagerPlugin],this._loaderCreate=this._loaderCreate.bind(this)}async onAdded(o){var l;await super.onAdded(o);const c=o.getPlugin(AssetManagerPlugin);(l=c==null?void 0:c.importer)===null||l===void 0||l.addEventListener("loaderCreate",this._loaderCreate)}async onRemove(o){var l,c;return(c=(l=o.getPlugin(AssetManagerPlugin))===null||l===void 0?void 0:l.importer)===null||c===void 0||c.removeEventListener("loaderCreate",this._loaderCreate),super.onRemove(o)}}GLTFSpecGlossinessConverterPlugin.PluginType="GLTFSpecGlossinessConverterPlugin";var RainbowDiamondPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let RainbowDiamondPlugin=class extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.toJSON=void 0,this.prefix="",this.count=50,this.loops=1,this.color=new three_module.Q1f().setHSL(0,.8,.5)}colorItems(){if(!this._viewer)return;const d=this._viewer.scene.modelRoot;let o=0;const l=this.color.getHSL({h:0,s:0,l:0});d.traverse(c=>{const u=c.material&&c.material.isDiamondMaterial,h=u&&c.name.startsWith(this.prefix);if(u&&console.log("Found Diamond, name = ",c.name,", coloring = ",h),h){let _=c.name.replace(this.prefix,"");_=parseFloat(_)/this.count;const A=new three_module.Q1f().setHSL((this.loops*_+l.h)%1,l.s,l.l);c.material=c.material.userData.isColoredClone?c.material:c.material.clone(),c.material.color.set(A),c.material.boostFactors.set(1,1,1),c.material.userData.isColoredClone=!0,o++}}),console.log("total",o),this._viewer.setDirty()}};RainbowDiamondPlugin.PluginType="RainbowDiamondPlugin",RainbowDiamondPlugin_decorate([uiInput("Object name prefix")],RainbowDiamondPlugin.prototype,"prefix",void 0),RainbowDiamondPlugin_decorate([uiInput("Count")],RainbowDiamondPlugin.prototype,"count",void 0),RainbowDiamondPlugin_decorate([uiInput("Loops")],RainbowDiamondPlugin.prototype,"loops",void 0),RainbowDiamondPlugin_decorate([uiColor("First Color")],RainbowDiamondPlugin.prototype,"color",void 0),RainbowDiamondPlugin_decorate([uiButton("Color All Items")],RainbowDiamondPlugin.prototype,"colorItems",null),RainbowDiamondPlugin=RainbowDiamondPlugin_decorate([uiFolder("Rainbow Diamond Coloring")],RainbowDiamondPlugin);class BeringRingAnimation extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.toJSON=null,this.ringSlots=[],this.dependencies=[AssetManagerPlugin,PopmotionPlugin],this._animating=!1,this._runningAnimations=[],this.uiConfig={type:"folder",label:"Bering Animation",children:[{label:"Play Animation",type:"button",value:()=>{this.startRingAnimation(!1)}},{label:"Record Animation",type:"button",value:async()=>{var o;const l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("CanvasRecorder");if(!l||l.isRecording())return;this.animating&&this.stopRingAnimation(!1),await X(500);const c=await l.record(async()=>{console.log("start"),await this.startRingAnimation(!1),console.log("finish")});c&&(console.log("recorded",c),N(c,"animation.mp4"))}}]}}get animating(){return this._animating}set animating(o){var l,c;if(this._animating===o)return;this._animating=o;const u=(l=this._viewer)===null||l===void 0?void 0:l.getPlugin(FrameFadePlugin);u&&(o?u.disable("bering"):u.enable("bering"));const h=(c=this._viewer)===null||c===void 0?void 0:c.getPlugin(TemporalAAPlugin);h&&(h.enabled=!o)}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("addSceneObject",l=>{var c,u,h,_,A;if(!(!((u=(c=l.options)===null||c===void 0?void 0:c.allImported)===null||u===void 0)&&u.length)||!l.object||!l.object.__importedViewerConfig&&!(!((h=l.object.modelObject)===null||h===void 0)&&h.__importedViewerConfig)||!(!((_=l.options)===null||_===void 0)&&_.allImported))return;let w=0;const C=(A=l.options)===null||A===void 0?void 0:A.allImported.filter(M=>!!(M&&M.modelObject&&M.name.endsWith("bmod"))).reverse();C.forEach(M=>{this.loadRingBMod(M,M.name,w,C.length-1),w++})})}loadRingBMod(o,l,c,u){var h,_,A;if(!l)return;if(!(!((h=this._viewer)===null||h===void 0)&&h.getPlugin(AssetManagerPlugin)))throw new Error("no asset manager");this._runningAnimations&&this.stopRingAnimation(),l.endsWith(".bmod")||(l+=".bmod");const w=o==null?void 0:o.modelObject;if(!w||!o)throw new Error("no model");w.userData.__ringSlot=c,this.ringSlots[c]=o;const C=[];w.traverse(O=>{O.userData.rotationCount>1&&C.push(O)}),new Box3B().expandByObjects(C,!0,!0),l.toLowerCase().includes("x3")||l.toLowerCase().includes("x4");const M=parseInt(l.split("-").pop().toLowerCase().replace("x","").replace(".bmod",""))+1;return w.userData.__ringWidth=M,w.userData.__ringTotalSlots=u,(A=(_=this._viewer)===null||_===void 0?void 0:_.scene)===null||A===void 0||A.setDirty({sceneUpdate:!0,frameFade:!1}),o}clearAllSlots(){this.ringSlots.forEach(o=>{o.modelObject.removeFromParent()}),this.ringSlots=[]}stopRingAnimation(o=!0){var l,c;if(this._runningAnimations.length!==0){for(const u of this._runningAnimations)u.stop();this._runningAnimations=[],o&&((c=(l=this._viewer)===null||l===void 0?void 0:l.getPlugin(FrameFadePlugin))===null||c===void 0||c.startTransition(1200))}}async startRingAnimation(o=!0){if(this.animating||!this._viewer)return;this.stopRingAnimation(),this.animating=!0;let l=0;const c=[];await new Promise(u=>{var h,_,A;if(!this._viewer)return;const w=()=>{l+=1,l<c.length||u()},C=2500,M=this._viewer.getPlugin(PopmotionPlugin),O=this.ringSlots[0];if(O){const ne=O.modelObject,ce={left:[],right:[],rem:[]};ne.traverse(Oe=>{const ke=(Oe==null?void 0:Oe.name.trim().toLowerCase().replace(/[0-9]/g,""))||"";ke.endsWith("-s")?ce.left.push(Oe):ke.endsWith("-l")?ce.right.push(Oe):ke.startsWith("testlogo")&&ce.rem.push(Oe)});const ue=[];for(const Oe of ce.left){const ke=((h=Oe.parent)===null||h===void 0?void 0:h.children)||[];ue.push(...ke)}for(const Oe of ce.right){const ke=((_=Oe.parent)===null||_===void 0?void 0:_.children)||[];ue.push(...ke)}for(const Oe of ue)ce.left.includes(Oe)||ce.right.includes(Oe)||ce.rem.includes(Oe)||ce.rem.push(Oe);for(const Oe of ce.rem)new Box3B().expandByObject(Oe,!1,!0).getCenter(new three_module.Pq0).x<=0?ce.left.push(Oe):ce.right.push(Oe);for(const Oe of[...ce.left,...ce.right])Oe.userData.__initX=Oe.position.x,Oe.userData.__initRotX=Oe.rotation.x;const ye=(A=this._viewer)===null||A===void 0?void 0:A.getPluginByType("Ground");if(ce.left.length>0&&ce.right.length>0){const Oe=Ve=>tt=>{var ht,ut,_t;for(const at of ce[Ve])at.position.x=tt+at.userData.__initX;(ut=(ht=this._viewer)===null||ht===void 0?void 0:ht.scene)===null||ut===void 0||ut.setDirty({sceneUpdate:!1,frameFade:!1}),o&&((_t=ye==null?void 0:ye.shadowBaker)===null||_t===void 0||_t.reset())},ke=Ve=>tt=>{var ht,ut;for(const _t of ce[Ve])_t.rotation.x=tt+_t.userData.__initRotX;(ut=(ht=this._viewer)===null||ht===void 0?void 0:ht.scene)===null||ut===void 0||ut.setDirty({sceneUpdate:!1,frameFade:!1})};c.push(M.animate({from:0,to:-.75,onUpdate:Oe("left"),onStop:()=>{Oe("left")(0),w()},onComplete:w,duration:C,ease:EasingFunctions$1.easeInOut,repeat:1,repeatDelay:250,repeatType:"mirror"})),c.push(M.animate({from:0,to:.75,onUpdate:Oe("right"),onStop:()=>{Oe("right")(0),w()},onComplete:w,duration:C,ease:EasingFunctions$1.easeInOut,repeat:1,repeatDelay:250,repeatType:"mirror"})),c.push(M.animate({from:0,to:1.5*-Math.PI,onUpdate:ke("left"),onStop:()=>{ke("left")(0),w()},onComplete:w,duration:1250,ease:EasingFunctions$1.easeInOut,repeat:1,repeatDelay:2750,repeatType:"mirror"}))}}this.ringSlots.forEach(ne=>{if(O===ne)return;const ce=ne.modelObject.userData.__ringSlot,ue=ne.modelObject.userData.__ringTotalSlots,ye=ne.modelObject.userData.__ringWidth,Oe=ne.modelObject.position.x;c.push(M.animate({from:Oe,to:Oe+.75-1.5*(1-(ce+1)/(ue+1+(2-ye))),onUpdate:ke=>{var Ve,tt;ne.modelObject.position.x=ke,(tt=(Ve=this._viewer)===null||Ve===void 0?void 0:Ve.scene)===null||tt===void 0||tt.setDirty({sceneUpdate:!1,frameFade:!1})},onStop:()=>{ne.modelObject.position.x=Oe,w()},onComplete:w,duration:C,ease:EasingFunctions$1.easeInOut,repeat:1,repeatDelay:250,repeatType:"mirror"}))}),c.length>0?this._runningAnimations=c:(this.animating=!1,u())}),this.animating=!1;for(const u of this._runningAnimations)u.stop();this._runningAnimations=[],console.log("animation end")}}BeringRingAnimation.PluginType="BeringRingAnimation";class Mat3{constructor(o){o===void 0&&(o=[0,0,0,0,0,0,0,0,0]),this.elements=o}identity(){const o=this.elements;o[0]=1,o[1]=0,o[2]=0,o[3]=0,o[4]=1,o[5]=0,o[6]=0,o[7]=0,o[8]=1}setZero(){const o=this.elements;o[0]=0,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=0,o[6]=0,o[7]=0,o[8]=0}setTrace(o){const l=this.elements;l[0]=o.x,l[4]=o.y,l[8]=o.z}getTrace(o){o===void 0&&(o=new Vec3);const l=this.elements;return o.x=l[0],o.y=l[4],o.z=l[8],o}vmult(o,l){l===void 0&&(l=new Vec3);const c=this.elements,u=o.x,h=o.y,_=o.z;return l.x=c[0]*u+c[1]*h+c[2]*_,l.y=c[3]*u+c[4]*h+c[5]*_,l.z=c[6]*u+c[7]*h+c[8]*_,l}smult(o){for(let l=0;l<this.elements.length;l++)this.elements[l]*=o}mmult(o,l){l===void 0&&(l=new Mat3);const c=this.elements,u=o.elements,h=l.elements,_=c[0],A=c[1],w=c[2],C=c[3],M=c[4],O=c[5],ne=c[6],ce=c[7],ue=c[8],ye=u[0],Oe=u[1],ke=u[2],Ve=u[3],tt=u[4],ht=u[5],ut=u[6],_t=u[7],at=u[8];return h[0]=_*ye+A*Ve+w*ut,h[1]=_*Oe+A*tt+w*_t,h[2]=_*ke+A*ht+w*at,h[3]=C*ye+M*Ve+O*ut,h[4]=C*Oe+M*tt+O*_t,h[5]=C*ke+M*ht+O*at,h[6]=ne*ye+ce*Ve+ue*ut,h[7]=ne*Oe+ce*tt+ue*_t,h[8]=ne*ke+ce*ht+ue*at,l}scale(o,l){l===void 0&&(l=new Mat3);const c=this.elements,u=l.elements;for(let h=0;h!==3;h++)u[3*h+0]=o.x*c[3*h+0],u[3*h+1]=o.y*c[3*h+1],u[3*h+2]=o.z*c[3*h+2];return l}solve(o,l){l===void 0&&(l=new Vec3);const c=[];let u,h;for(u=0;u<12;u++)c.push(0);for(u=0;u<3;u++)for(h=0;h<3;h++)c[u+4*h]=this.elements[u+3*h];c[3]=o.x,c[7]=o.y,c[11]=o.z;let _=3;const A=_;let w,C;do{if(u=A-_,c[u+4*u]===0){for(h=u+1;h<A;h++)if(c[u+4*h]!==0){w=4;do C=4-w,c[C+4*u]+=c[C+4*h];while(--w);break}}if(c[u+4*u]!==0)for(h=u+1;h<A;h++){const M=c[u+4*h]/c[u+4*u];w=4;do C=4-w,c[C+4*h]=C<=u?0:c[C+4*h]-c[C+4*u]*M;while(--w)}}while(--_);if(l.z=c[11]/c[10],l.y=(c[7]-c[6]*l.z)/c[5],l.x=(c[3]-c[2]*l.z-c[1]*l.y)/c[0],isNaN(l.x)||isNaN(l.y)||isNaN(l.z)||l.x===1/0||l.y===1/0||l.z===1/0)throw`Could not solve equation! Got x=[${l.toString()}], b=[${o.toString()}], A=[${this.toString()}]`;return l}e(o,l,c){if(c===void 0)return this.elements[l+3*o];this.elements[l+3*o]=c}copy(o){for(let l=0;l<o.elements.length;l++)this.elements[l]=o.elements[l];return this}toString(){let o="";for(let l=0;l<9;l++)o+=this.elements[l]+",";return o}reverse(o){o===void 0&&(o=new Mat3);const l=reverse_eqns;let c,u;for(c=0;c<3;c++)for(u=0;u<3;u++)l[c+6*u]=this.elements[c+3*u];l[3]=1,l[9]=0,l[15]=0,l[4]=0,l[10]=1,l[16]=0,l[5]=0,l[11]=0,l[17]=1;let h=3;const _=h;let A,w;do{if(c=_-h,l[c+6*c]===0){for(u=c+1;u<_;u++)if(l[c+6*u]!==0){A=6;do w=6-A,l[w+6*c]+=l[w+6*u];while(--A);break}}if(l[c+6*c]!==0)for(u=c+1;u<_;u++){const C=l[c+6*u]/l[c+6*c];A=6;do w=6-A,l[w+6*u]=w<=c?0:l[w+6*u]-l[w+6*c]*C;while(--A)}}while(--h);c=2;do{u=c-1;do{const C=l[c+6*u]/l[c+6*c];A=6;do w=6-A,l[w+6*u]=l[w+6*u]-l[w+6*c]*C;while(--A)}while(u--)}while(--c);c=2;do{const C=1/l[c+6*c];A=6;do w=6-A,l[w+6*c]=l[w+6*c]*C;while(--A)}while(c--);c=2;do{u=2;do{if(w=l[3+u+6*c],isNaN(w)||w===1/0)throw`Could not reverse! A=[${this.toString()}]`;o.e(c,u,w)}while(u--)}while(c--);return o}setRotationFromQuaternion(o){const l=o.x,c=o.y,u=o.z,h=o.w,_=l+l,A=c+c,w=u+u,C=l*_,M=l*A,O=l*w,ne=c*A,ce=c*w,ue=u*w,ye=h*_,Oe=h*A,ke=h*w,Ve=this.elements;return Ve[0]=1-(ne+ue),Ve[1]=M-ke,Ve[2]=O+Oe,Ve[3]=M+ke,Ve[4]=1-(C+ue),Ve[5]=ce-ye,Ve[6]=O-Oe,Ve[7]=ce+ye,Ve[8]=1-(C+ne),this}transpose(o){o===void 0&&(o=new Mat3);const l=this.elements,c=o.elements;let u;return c[0]=l[0],c[4]=l[4],c[8]=l[8],u=l[1],c[1]=l[3],c[3]=u,u=l[2],c[2]=l[6],c[6]=u,u=l[5],c[5]=l[7],c[7]=u,o}}const reverse_eqns=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class Vec3{constructor(o,l,c){o===void 0&&(o=0),l===void 0&&(l=0),c===void 0&&(c=0),this.x=o,this.y=l,this.z=c}cross(o,l){l===void 0&&(l=new Vec3);const c=o.x,u=o.y,h=o.z,_=this.x,A=this.y,w=this.z;return l.x=A*h-w*u,l.y=w*c-_*h,l.z=_*u-A*c,l}set(o,l,c){return this.x=o,this.y=l,this.z=c,this}setZero(){this.x=this.y=this.z=0}vadd(o,l){if(!l)return new Vec3(this.x+o.x,this.y+o.y,this.z+o.z);l.x=o.x+this.x,l.y=o.y+this.y,l.z=o.z+this.z}vsub(o,l){if(!l)return new Vec3(this.x-o.x,this.y-o.y,this.z-o.z);l.x=this.x-o.x,l.y=this.y-o.y,l.z=this.z-o.z}crossmat(){return new Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])}normalize(){const o=this.x,l=this.y,c=this.z,u=Math.sqrt(o*o+l*l+c*c);if(u>0){const h=1/u;this.x*=h,this.y*=h,this.z*=h}else this.x=0,this.y=0,this.z=0;return u}unit(o){o===void 0&&(o=new Vec3);const l=this.x,c=this.y,u=this.z;let h=Math.sqrt(l*l+c*c+u*u);return h>0?(h=1/h,o.x=l*h,o.y=c*h,o.z=u*h):(o.x=1,o.y=0,o.z=0),o}length(){const o=this.x,l=this.y,c=this.z;return Math.sqrt(o*o+l*l+c*c)}lengthSquared(){return this.dot(this)}distanceTo(o){const l=this.x,c=this.y,u=this.z,h=o.x,_=o.y,A=o.z;return Math.sqrt((h-l)*(h-l)+(_-c)*(_-c)+(A-u)*(A-u))}distanceSquared(o){const l=this.x,c=this.y,u=this.z,h=o.x,_=o.y,A=o.z;return(h-l)*(h-l)+(_-c)*(_-c)+(A-u)*(A-u)}scale(o,l){l===void 0&&(l=new Vec3);const c=this.x,u=this.y,h=this.z;return l.x=o*c,l.y=o*u,l.z=o*h,l}vmul(o,l){return l===void 0&&(l=new Vec3),l.x=o.x*this.x,l.y=o.y*this.y,l.z=o.z*this.z,l}addScaledVector(o,l,c){return c===void 0&&(c=new Vec3),c.x=this.x+o*l.x,c.y=this.y+o*l.y,c.z=this.z+o*l.z,c}dot(o){return this.x*o.x+this.y*o.y+this.z*o.z}isZero(){return this.x===0&&this.y===0&&this.z===0}negate(o){return o===void 0&&(o=new Vec3),o.x=-this.x,o.y=-this.y,o.z=-this.z,o}tangents(o,l){const c=this.length();if(c>0){const u=Vec3_tangents_n,h=1/c;u.set(this.x*h,this.y*h,this.z*h);const _=Vec3_tangents_randVec;Math.abs(u.x)<.9?(_.set(1,0,0),u.cross(_,o)):(_.set(0,1,0),u.cross(_,o)),u.cross(o,l)}else o.set(1,0,0),l.set(0,1,0)}toString(){return`${this.x},${this.y},${this.z}`}toArray(){return[this.x,this.y,this.z]}copy(o){return this.x=o.x,this.y=o.y,this.z=o.z,this}lerp(o,l,c){const u=this.x,h=this.y,_=this.z;c.x=u+(o.x-u)*l,c.y=h+(o.y-h)*l,c.z=_+(o.z-_)*l}almostEquals(o,l){return l===void 0&&(l=1e-6),!(Math.abs(this.x-o.x)>l||Math.abs(this.y-o.y)>l||Math.abs(this.z-o.z)>l)}almostZero(o){return o===void 0&&(o=1e-6),!(Math.abs(this.x)>o||Math.abs(this.y)>o||Math.abs(this.z)>o)}isAntiparallelTo(o,l){return this.negate(antip_neg),antip_neg.almostEquals(o,l)}clone(){return new Vec3(this.x,this.y,this.z)}}Vec3.ZERO=new Vec3(0,0,0),Vec3.UNIT_X=new Vec3(1,0,0),Vec3.UNIT_Y=new Vec3(0,1,0),Vec3.UNIT_Z=new Vec3(0,0,1);const Vec3_tangents_n=new Vec3,Vec3_tangents_randVec=new Vec3,antip_neg=new Vec3;class AABB{constructor(o){o===void 0&&(o={}),this.lowerBound=new Vec3,this.upperBound=new Vec3,o.lowerBound&&this.lowerBound.copy(o.lowerBound),o.upperBound&&this.upperBound.copy(o.upperBound)}setFromPoints(o,l,c,u){const h=this.lowerBound,_=this.upperBound,A=c;h.copy(o[0]),A&&A.vmult(h,h),_.copy(h);for(let w=1;w<o.length;w++){let C=o[w];A&&(A.vmult(C,tmp$1),C=tmp$1),C.x>_.x&&(_.x=C.x),C.x<h.x&&(h.x=C.x),C.y>_.y&&(_.y=C.y),C.y<h.y&&(h.y=C.y),C.z>_.z&&(_.z=C.z),C.z<h.z&&(h.z=C.z)}return l&&(l.vadd(h,h),l.vadd(_,_)),u&&(h.x-=u,h.y-=u,h.z-=u,_.x+=u,_.y+=u,_.z+=u),this}copy(o){return this.lowerBound.copy(o.lowerBound),this.upperBound.copy(o.upperBound),this}clone(){return new AABB().copy(this)}extend(o){this.lowerBound.x=Math.min(this.lowerBound.x,o.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,o.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,o.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,o.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,o.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,o.upperBound.z)}overlaps(o){const l=this.lowerBound,c=this.upperBound,u=o.lowerBound,h=o.upperBound,_=u.x<=c.x&&c.x<=h.x||l.x<=h.x&&h.x<=c.x,A=u.y<=c.y&&c.y<=h.y||l.y<=h.y&&h.y<=c.y,w=u.z<=c.z&&c.z<=h.z||l.z<=h.z&&h.z<=c.z;return _&&A&&w}volume(){const o=this.lowerBound,l=this.upperBound;return(l.x-o.x)*(l.y-o.y)*(l.z-o.z)}contains(o){const l=this.lowerBound,c=this.upperBound,u=o.lowerBound,h=o.upperBound;return l.x<=u.x&&c.x>=h.x&&l.y<=u.y&&c.y>=h.y&&l.z<=u.z&&c.z>=h.z}getCorners(o,l,c,u,h,_,A,w){const C=this.lowerBound,M=this.upperBound;o.copy(C),l.set(M.x,C.y,C.z),c.set(M.x,M.y,C.z),u.set(C.x,M.y,M.z),h.set(M.x,C.y,M.z),_.set(C.x,M.y,C.z),A.set(C.x,C.y,M.z),w.copy(M)}toLocalFrame(o,l){const c=transformIntoFrame_corners,u=c[0],h=c[1],_=c[2],A=c[3],w=c[4],C=c[5],M=c[6],O=c[7];this.getCorners(u,h,_,A,w,C,M,O);for(let ne=0;ne!==8;ne++){const ce=c[ne];o.pointToLocal(ce,ce)}return l.setFromPoints(c)}toWorldFrame(o,l){const c=transformIntoFrame_corners,u=c[0],h=c[1],_=c[2],A=c[3],w=c[4],C=c[5],M=c[6],O=c[7];this.getCorners(u,h,_,A,w,C,M,O);for(let ne=0;ne!==8;ne++){const ce=c[ne];o.pointToWorld(ce,ce)}return l.setFromPoints(c)}overlapsRay(o){const{direction:l,from:c}=o,u=1/l.x,h=1/l.y,_=1/l.z,A=(this.lowerBound.x-c.x)*u,w=(this.upperBound.x-c.x)*u,C=(this.lowerBound.y-c.y)*h,M=(this.upperBound.y-c.y)*h,O=(this.lowerBound.z-c.z)*_,ne=(this.upperBound.z-c.z)*_,ce=Math.max(Math.max(Math.min(A,w),Math.min(C,M)),Math.min(O,ne)),ue=Math.min(Math.min(Math.max(A,w),Math.max(C,M)),Math.max(O,ne));return!(ue<0||ce>ue)}}const tmp$1=new Vec3,transformIntoFrame_corners=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3];class ArrayCollisionMatrix{constructor(){this.matrix=[]}get(o,l){let{index:c}=o,{index:u}=l;if(u>c){const h=u;u=c,c=h}return this.matrix[(c*(c+1)>>1)+u-1]}set(o,l,c){let{index:u}=o,{index:h}=l;if(h>u){const _=h;h=u,u=_}this.matrix[(u*(u+1)>>1)+h-1]=c?1:0}reset(){for(let o=0,l=this.matrix.length;o!==l;o++)this.matrix[o]=0}setNumObjects(o){this.matrix.length=o*(o-1)>>1}}class EventTarget{addEventListener(o,l){this._listeners===void 0&&(this._listeners={});const c=this._listeners;return c[o]===void 0&&(c[o]=[]),c[o].includes(l)||c[o].push(l),this}hasEventListener(o,l){if(this._listeners===void 0)return!1;const c=this._listeners;return!(c[o]===void 0||!c[o].includes(l))}hasAnyEventListener(o){return this._listeners!==void 0&&this._listeners[o]!==void 0}removeEventListener(o,l){if(this._listeners===void 0)return this;const c=this._listeners;if(c[o]===void 0)return this;const u=c[o].indexOf(l);return u!==-1&&c[o].splice(u,1),this}dispatchEvent(o){if(this._listeners===void 0)return this;const l=this._listeners[o.type];if(l!==void 0){o.target=this;for(let c=0,u=l.length;c<u;c++)l[c].call(this,o)}return this}}class Quaternion{constructor(o,l,c,u){o===void 0&&(o=0),l===void 0&&(l=0),c===void 0&&(c=0),u===void 0&&(u=1),this.x=o,this.y=l,this.z=c,this.w=u}set(o,l,c,u){return this.x=o,this.y=l,this.z=c,this.w=u,this}toString(){return`${this.x},${this.y},${this.z},${this.w}`}toArray(){return[this.x,this.y,this.z,this.w]}setFromAxisAngle(o,l){const c=Math.sin(.5*l);return this.x=o.x*c,this.y=o.y*c,this.z=o.z*c,this.w=Math.cos(.5*l),this}toAxisAngle(o){o===void 0&&(o=new Vec3),this.normalize();const l=2*Math.acos(this.w),c=Math.sqrt(1-this.w*this.w);return c<.001?(o.x=this.x,o.y=this.y,o.z=this.z):(o.x=this.x/c,o.y=this.y/c,o.z=this.z/c),[o,l]}setFromVectors(o,l){if(o.isAntiparallelTo(l)){const c=sfv_t1,u=sfv_t2;o.tangents(c,u),this.setFromAxisAngle(c,Math.PI)}else{const c=o.cross(l);this.x=c.x,this.y=c.y,this.z=c.z,this.w=Math.sqrt(o.length()**2*l.length()**2)+o.dot(l),this.normalize()}return this}mult(o,l){l===void 0&&(l=new Quaternion);const c=this.x,u=this.y,h=this.z,_=this.w,A=o.x,w=o.y,C=o.z,M=o.w;return l.x=c*M+_*A+u*C-h*w,l.y=u*M+_*w+h*A-c*C,l.z=h*M+_*C+c*w-u*A,l.w=_*M-c*A-u*w-h*C,l}inverse(o){o===void 0&&(o=new Quaternion);const l=this.x,c=this.y,u=this.z,h=this.w;this.conjugate(o);const _=1/(l*l+c*c+u*u+h*h);return o.x*=_,o.y*=_,o.z*=_,o.w*=_,o}conjugate(o){return o===void 0&&(o=new Quaternion),o.x=-this.x,o.y=-this.y,o.z=-this.z,o.w=this.w,o}normalize(){let o=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return o===0?(this.x=0,this.y=0,this.z=0,this.w=0):(o=1/o,this.x*=o,this.y*=o,this.z*=o,this.w*=o),this}normalizeFast(){const o=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return o===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=o,this.y*=o,this.z*=o,this.w*=o),this}vmult(o,l){l===void 0&&(l=new Vec3);const c=o.x,u=o.y,h=o.z,_=this.x,A=this.y,w=this.z,C=this.w,M=C*c+A*h-w*u,O=C*u+w*c-_*h,ne=C*h+_*u-A*c,ce=-_*c-A*u-w*h;return l.x=M*C+ce*-_+O*-w-ne*-A,l.y=O*C+ce*-A+ne*-_-M*-w,l.z=ne*C+ce*-w+M*-A-O*-_,l}copy(o){return this.x=o.x,this.y=o.y,this.z=o.z,this.w=o.w,this}toEuler(o,l){let c,u,h;l===void 0&&(l="YZX");const _=this.x,A=this.y,w=this.z,C=this.w;if(l!=="YZX")throw new Error(`Euler order ${l} not supported yet.`);{const M=_*A+w*C;if(M>.499&&(c=2*Math.atan2(_,C),u=Math.PI/2,h=0),M<-.499&&(c=-2*Math.atan2(_,C),u=-Math.PI/2,h=0),c===void 0){const O=_*_,ne=A*A,ce=w*w;c=Math.atan2(2*A*C-2*_*w,1-2*ne-2*ce),u=Math.asin(2*M),h=Math.atan2(2*_*C-2*A*w,1-2*O-2*ce)}}o.y=c,o.z=u,o.x=h}setFromEuler(o,l,c,u){u===void 0&&(u="XYZ");const h=Math.cos(o/2),_=Math.cos(l/2),A=Math.cos(c/2),w=Math.sin(o/2),C=Math.sin(l/2),M=Math.sin(c/2);return u==="XYZ"?(this.x=w*_*A+h*C*M,this.y=h*C*A-w*_*M,this.z=h*_*M+w*C*A,this.w=h*_*A-w*C*M):u==="YXZ"?(this.x=w*_*A+h*C*M,this.y=h*C*A-w*_*M,this.z=h*_*M-w*C*A,this.w=h*_*A+w*C*M):u==="ZXY"?(this.x=w*_*A-h*C*M,this.y=h*C*A+w*_*M,this.z=h*_*M+w*C*A,this.w=h*_*A-w*C*M):u==="ZYX"?(this.x=w*_*A-h*C*M,this.y=h*C*A+w*_*M,this.z=h*_*M-w*C*A,this.w=h*_*A+w*C*M):u==="YZX"?(this.x=w*_*A+h*C*M,this.y=h*C*A+w*_*M,this.z=h*_*M-w*C*A,this.w=h*_*A-w*C*M):u==="XZY"&&(this.x=w*_*A-h*C*M,this.y=h*C*A-w*_*M,this.z=h*_*M+w*C*A,this.w=h*_*A+w*C*M),this}clone(){return new Quaternion(this.x,this.y,this.z,this.w)}slerp(o,l,c){c===void 0&&(c=new Quaternion);const u=this.x,h=this.y,_=this.z,A=this.w;let w,C,M,O,ne,ce=o.x,ue=o.y,ye=o.z,Oe=o.w;return C=u*ce+h*ue+_*ye+A*Oe,C<0&&(C=-C,ce=-ce,ue=-ue,ye=-ye,Oe=-Oe),1-C>1e-6?(w=Math.acos(C),M=Math.sin(w),O=Math.sin((1-l)*w)/M,ne=Math.sin(l*w)/M):(O=1-l,ne=l),c.x=O*u+ne*ce,c.y=O*h+ne*ue,c.z=O*_+ne*ye,c.w=O*A+ne*Oe,c}integrate(o,l,c,u){u===void 0&&(u=new Quaternion);const h=o.x*c.x,_=o.y*c.y,A=o.z*c.z,w=this.x,C=this.y,M=this.z,O=this.w,ne=.5*l;return u.x+=ne*(h*O+_*M-A*C),u.y+=ne*(_*O+A*w-h*M),u.z+=ne*(A*O+h*C-_*w),u.w+=ne*(-h*w-_*C-A*M),u}}const sfv_t1=new Vec3,sfv_t2=new Vec3,SHAPE_TYPES={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256};class Shape{constructor(o){o===void 0&&(o={}),this.id=Shape.idCounter++,this.type=o.type||0,this.boundingSphereRadius=0,this.collisionResponse=!o.collisionResponse||o.collisionResponse,this.collisionFilterGroup=o.collisionFilterGroup!==void 0?o.collisionFilterGroup:1,this.collisionFilterMask=o.collisionFilterMask!==void 0?o.collisionFilterMask:-1,this.material=o.material?o.material:null,this.body=null}updateBoundingSphereRadius(){throw`computeBoundingSphereRadius() not implemented for shape type ${this.type}`}volume(){throw`volume() not implemented for shape type ${this.type}`}calculateLocalInertia(o,l){throw`calculateLocalInertia() not implemented for shape type ${this.type}`}calculateWorldAABB(o,l,c,u){throw`calculateWorldAABB() not implemented for shape type ${this.type}`}}Shape.idCounter=0,Shape.types=SHAPE_TYPES;class cannon_es_Transform{constructor(o){o===void 0&&(o={}),this.position=new Vec3,this.quaternion=new Quaternion,o.position&&this.position.copy(o.position),o.quaternion&&this.quaternion.copy(o.quaternion)}pointToLocal(o,l){return cannon_es_Transform.pointToLocalFrame(this.position,this.quaternion,o,l)}pointToWorld(o,l){return cannon_es_Transform.pointToWorldFrame(this.position,this.quaternion,o,l)}vectorToWorldFrame(o,l){return l===void 0&&(l=new Vec3),this.quaternion.vmult(o,l),l}static pointToLocalFrame(o,l,c,u){return u===void 0&&(u=new Vec3),c.vsub(o,u),l.conjugate(tmpQuat$1),tmpQuat$1.vmult(u,u),u}static pointToWorldFrame(o,l,c,u){return u===void 0&&(u=new Vec3),l.vmult(c,u),u.vadd(o,u),u}static vectorToWorldFrame(o,l,c){return c===void 0&&(c=new Vec3),o.vmult(l,c),c}static vectorToLocalFrame(o,l,c,u){return u===void 0&&(u=new Vec3),l.w*=-1,l.vmult(c,u),l.w*=-1,u}}const tmpQuat$1=new Quaternion;class ConvexPolyhedron extends Shape{constructor(o){o===void 0&&(o={});const{vertices:l=[],faces:c=[],normals:u=[],axes:h,boundingSphereRadius:_}=o;super({type:Shape.types.CONVEXPOLYHEDRON}),this.vertices=l,this.faces=c,this.faceNormals=u,this.faceNormals.length===0&&this.computeNormals(),_?this.boundingSphereRadius=_:this.updateBoundingSphereRadius(),this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.worldFaceNormals=[],this.worldFaceNormalsNeedsUpdate=!0,this.uniqueAxes=h?h.slice():null,this.uniqueEdges=[],this.computeEdges()}computeEdges(){const o=this.faces,l=this.vertices,c=this.uniqueEdges;c.length=0;const u=new Vec3;for(let h=0;h!==o.length;h++){const _=o[h],A=_.length;for(let w=0;w!==A;w++){const C=(w+1)%A;l[_[w]].vsub(l[_[C]],u),u.normalize();let M=!1;for(let O=0;O!==c.length;O++)if(c[O].almostEquals(u)||c[O].almostEquals(u)){M=!0;break}M||c.push(u.clone())}}}computeNormals(){this.faceNormals.length=this.faces.length;for(let o=0;o<this.faces.length;o++){for(let u=0;u<this.faces[o].length;u++)if(!this.vertices[this.faces[o][u]])throw new Error(`Vertex ${this.faces[o][u]} not found!`);const l=this.faceNormals[o]||new Vec3;this.getFaceNormal(o,l),l.negate(l),this.faceNormals[o]=l;const c=this.vertices[this.faces[o][0]];if(l.dot(c)<0){console.error(`.faceNormals[${o}] = Vec3(${l.toString()}) looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.`);for(let u=0;u<this.faces[o].length;u++)console.warn(`.vertices[${this.faces[o][u]}] = Vec3(${this.vertices[this.faces[o][u]].toString()})`)}}}getFaceNormal(o,l){const c=this.faces[o],u=this.vertices[c[0]],h=this.vertices[c[1]],_=this.vertices[c[2]];ConvexPolyhedron.computeNormal(u,h,_,l)}static computeNormal(o,l,c,u){const h=new Vec3,_=new Vec3;l.vsub(o,_),c.vsub(l,h),h.cross(_,u),u.isZero()||u.normalize()}clipAgainstHull(o,l,c,u,h,_,A,w,C){const M=new Vec3;let O=-1,ne=-Number.MAX_VALUE;for(let ue=0;ue<c.faces.length;ue++){M.copy(c.faceNormals[ue]),h.vmult(M,M);const ye=M.dot(_);ye>ne&&(ne=ye,O=ue)}const ce=[];for(let ue=0;ue<c.faces[O].length;ue++){const ye=c.vertices[c.faces[O][ue]],Oe=new Vec3;Oe.copy(ye),h.vmult(Oe,Oe),u.vadd(Oe,Oe),ce.push(Oe)}O>=0&&this.clipFaceAgainstHull(_,o,l,ce,A,w,C)}findSeparatingAxis(o,l,c,u,h,_,A,w){const C=new Vec3,M=new Vec3,O=new Vec3,ne=new Vec3,ce=new Vec3,ue=new Vec3;let ye=Number.MAX_VALUE;const Oe=this;if(Oe.uniqueAxes)for(let ke=0;ke!==Oe.uniqueAxes.length;ke++){c.vmult(Oe.uniqueAxes[ke],C);const Ve=Oe.testSepAxis(C,o,l,c,u,h);if(Ve===!1)return!1;Ve<ye&&(ye=Ve,_.copy(C))}else{const ke=A?A.length:Oe.faces.length;for(let Ve=0;Ve<ke;Ve++){const tt=A?A[Ve]:Ve;C.copy(Oe.faceNormals[tt]),c.vmult(C,C);const ht=Oe.testSepAxis(C,o,l,c,u,h);if(ht===!1)return!1;ht<ye&&(ye=ht,_.copy(C))}}if(o.uniqueAxes)for(let ke=0;ke!==o.uniqueAxes.length;ke++){h.vmult(o.uniqueAxes[ke],M);const Ve=Oe.testSepAxis(M,o,l,c,u,h);if(Ve===!1)return!1;Ve<ye&&(ye=Ve,_.copy(M))}else{const ke=w?w.length:o.faces.length;for(let Ve=0;Ve<ke;Ve++){const tt=w?w[Ve]:Ve;M.copy(o.faceNormals[tt]),h.vmult(M,M);const ht=Oe.testSepAxis(M,o,l,c,u,h);if(ht===!1)return!1;ht<ye&&(ye=ht,_.copy(M))}}for(let ke=0;ke!==Oe.uniqueEdges.length;ke++){c.vmult(Oe.uniqueEdges[ke],ne);for(let Ve=0;Ve!==o.uniqueEdges.length;Ve++)if(h.vmult(o.uniqueEdges[Ve],ce),ne.cross(ce,ue),!ue.almostZero()){ue.normalize();const tt=Oe.testSepAxis(ue,o,l,c,u,h);if(tt===!1)return!1;tt<ye&&(ye=tt,_.copy(ue))}}return u.vsub(l,O),O.dot(_)>0&&_.negate(_),!0}testSepAxis(o,l,c,u,h,_){ConvexPolyhedron.project(this,o,c,u,maxminA),ConvexPolyhedron.project(l,o,h,_,maxminB);const A=maxminA[0],w=maxminA[1],C=maxminB[0],M=maxminB[1];if(A<M||C<w)return!1;const O=A-M,ne=C-w;return O<ne?O:ne}calculateLocalInertia(o,l){const c=new Vec3,u=new Vec3;this.computeLocalAABB(u,c);const h=c.x-u.x,_=c.y-u.y,A=c.z-u.z;l.x=1/12*o*(2*_*2*_+2*A*2*A),l.y=1/12*o*(2*h*2*h+2*A*2*A),l.z=1/12*o*(2*_*2*_+2*h*2*h)}getPlaneConstantOfFace(o){const l=this.faces[o],c=this.faceNormals[o],u=this.vertices[l[0]];return-c.dot(u)}clipFaceAgainstHull(o,l,c,u,h,_,A){const w=new Vec3,C=new Vec3,M=new Vec3,O=new Vec3,ne=new Vec3,ce=new Vec3,ue=new Vec3,ye=new Vec3,Oe=this,ke=u,Ve=[];let tt=-1,ht=Number.MAX_VALUE;for(let pt=0;pt<Oe.faces.length;pt++){w.copy(Oe.faceNormals[pt]),c.vmult(w,w);const xt=w.dot(o);xt<ht&&(ht=xt,tt=pt)}if(tt<0)return;const ut=Oe.faces[tt];ut.connectedFaces=[];for(let pt=0;pt<Oe.faces.length;pt++)for(let xt=0;xt<Oe.faces[pt].length;xt++)ut.indexOf(Oe.faces[pt][xt])!==-1&&pt!==tt&&ut.connectedFaces.indexOf(pt)===-1&&ut.connectedFaces.push(pt);const _t=ut.length;for(let pt=0;pt<_t;pt++){const xt=Oe.vertices[ut[pt]],Tt=Oe.vertices[ut[(pt+1)%_t]];xt.vsub(Tt,C),M.copy(C),c.vmult(M,M),l.vadd(M,M),O.copy(this.faceNormals[tt]),c.vmult(O,O),l.vadd(O,O),M.cross(O,ne),ne.negate(ne),ce.copy(xt),c.vmult(ce,ce),l.vadd(ce,ce);const Pt=ut.connectedFaces[pt];ue.copy(this.faceNormals[Pt]);const Lt=this.getPlaneConstantOfFace(Pt);ye.copy(ue),c.vmult(ye,ye);const Bt=Lt-ye.dot(l);for(this.clipFaceAgainstPlane(ke,Ve,ye,Bt);ke.length;)ke.shift();for(;Ve.length;)ke.push(Ve.shift())}ue.copy(this.faceNormals[tt]);const at=this.getPlaneConstantOfFace(tt);ye.copy(ue),c.vmult(ye,ye);const lt=at-ye.dot(l);for(let pt=0;pt<ke.length;pt++){let xt=ye.dot(ke[pt])+lt;if(xt<=h&&(console.log(`clamped: depth=${xt} to minDist=${h}`),xt=h),xt<=_){const Tt=ke[pt];if(xt<=1e-6){const Pt={point:Tt,normal:ye,depth:xt};A.push(Pt)}}}}clipFaceAgainstPlane(o,l,c,u){let h,_;const A=o.length;if(A<2)return l;let w=o[o.length-1],C=o[0];h=c.dot(w)+u;for(let M=0;M<A;M++){if(C=o[M],_=c.dot(C)+u,h<0)if(_<0){const O=new Vec3;O.copy(C),l.push(O)}else{const O=new Vec3;w.lerp(C,h/(h-_),O),l.push(O)}else if(_<0){const O=new Vec3;w.lerp(C,h/(h-_),O),l.push(O),l.push(C)}w=C,h=_}return l}computeWorldVertices(o,l){for(;this.worldVertices.length<this.vertices.length;)this.worldVertices.push(new Vec3);const c=this.vertices,u=this.worldVertices;for(let h=0;h!==this.vertices.length;h++)l.vmult(c[h],u[h]),o.vadd(u[h],u[h]);this.worldVerticesNeedsUpdate=!1}computeLocalAABB(o,l){const c=this.vertices;o.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),l.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let u=0;u<this.vertices.length;u++){const h=c[u];h.x<o.x?o.x=h.x:h.x>l.x&&(l.x=h.x),h.y<o.y?o.y=h.y:h.y>l.y&&(l.y=h.y),h.z<o.z?o.z=h.z:h.z>l.z&&(l.z=h.z)}}computeWorldFaceNormals(o){const l=this.faceNormals.length;for(;this.worldFaceNormals.length<l;)this.worldFaceNormals.push(new Vec3);const c=this.faceNormals,u=this.worldFaceNormals;for(let h=0;h!==l;h++)o.vmult(c[h],u[h]);this.worldFaceNormalsNeedsUpdate=!1}updateBoundingSphereRadius(){let o=0;const l=this.vertices;for(let c=0;c!==l.length;c++){const u=l[c].lengthSquared();u>o&&(o=u)}this.boundingSphereRadius=Math.sqrt(o)}calculateWorldAABB(o,l,c,u){const h=this.vertices;let _,A,w,C,M,O,ne=new Vec3;for(let ce=0;ce<h.length;ce++){ne.copy(h[ce]),l.vmult(ne,ne),o.vadd(ne,ne);const ue=ne;(_===void 0||ue.x<_)&&(_=ue.x),(C===void 0||ue.x>C)&&(C=ue.x),(A===void 0||ue.y<A)&&(A=ue.y),(M===void 0||ue.y>M)&&(M=ue.y),(w===void 0||ue.z<w)&&(w=ue.z),(O===void 0||ue.z>O)&&(O=ue.z)}c.set(_,A,w),u.set(C,M,O)}volume(){return 4*Math.PI*this.boundingSphereRadius/3}getAveragePointLocal(o){o===void 0&&(o=new Vec3);const l=this.vertices;for(let c=0;c<l.length;c++)o.vadd(l[c],o);return o.scale(1/l.length,o),o}transformAllPoints(o,l){const c=this.vertices.length,u=this.vertices;if(l){for(let h=0;h<c;h++){const _=u[h];l.vmult(_,_)}for(let h=0;h<this.faceNormals.length;h++){const _=this.faceNormals[h];l.vmult(_,_)}}if(o)for(let h=0;h<c;h++){const _=u[h];_.vadd(o,_)}}pointIsInside(o){const l=this.vertices,c=this.faces,u=this.faceNormals,h=new Vec3;this.getAveragePointLocal(h);for(let _=0;_<this.faces.length;_++){let A=u[_];const w=l[c[_][0]],C=new Vec3;o.vsub(w,C);const M=A.dot(C),O=new Vec3;h.vsub(w,O);const ne=A.dot(O);if(M<0&&ne>0||M>0&&ne<0)return!1}return-1}static project(o,l,c,u,h){const _=o.vertices.length,A=project_localAxis;let w=0,C=0;const M=project_localOrigin,O=o.vertices;M.setZero(),cannon_es_Transform.vectorToLocalFrame(c,u,l,A),cannon_es_Transform.pointToLocalFrame(c,u,M,M);const ne=M.dot(A);C=w=O[0].dot(A);for(let ce=1;ce<_;ce++){const ue=O[ce].dot(A);ue>w&&(w=ue),ue<C&&(C=ue)}if(C-=ne,w-=ne,C>w){const ce=C;C=w,w=ce}h[0]=w,h[1]=C}}const maxminA=[],maxminB=[];new Vec3;const project_localAxis=new Vec3,project_localOrigin=new Vec3;class Box extends Shape{constructor(o){super({type:Shape.types.BOX}),this.halfExtents=o,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}updateConvexPolyhedronRepresentation(){const o=this.halfExtents.x,l=this.halfExtents.y,c=this.halfExtents.z,u=Vec3,h=[new u(-o,-l,-c),new u(o,-l,-c),new u(o,l,-c),new u(-o,l,-c),new u(-o,-l,c),new u(o,-l,c),new u(o,l,c),new u(-o,l,c)],_=[new u(0,0,1),new u(0,1,0),new u(1,0,0)],A=new ConvexPolyhedron({vertices:h,faces:[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],axes:_});this.convexPolyhedronRepresentation=A,A.material=this.material}calculateLocalInertia(o,l){return l===void 0&&(l=new Vec3),Box.calculateInertia(this.halfExtents,o,l),l}static calculateInertia(o,l,c){const u=o;c.x=1/12*l*(2*u.y*2*u.y+2*u.z*2*u.z),c.y=1/12*l*(2*u.x*2*u.x+2*u.z*2*u.z),c.z=1/12*l*(2*u.y*2*u.y+2*u.x*2*u.x)}getSideNormals(o,l){const c=o,u=this.halfExtents;if(c[0].set(u.x,0,0),c[1].set(0,u.y,0),c[2].set(0,0,u.z),c[3].set(-u.x,0,0),c[4].set(0,-u.y,0),c[5].set(0,0,-u.z),l!==void 0)for(let h=0;h!==c.length;h++)l.vmult(c[h],c[h]);return c}volume(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z}updateBoundingSphereRadius(){this.boundingSphereRadius=this.halfExtents.length()}forEachWorldCorner(o,l,c){const u=this.halfExtents,h=[[u.x,u.y,u.z],[-u.x,u.y,u.z],[-u.x,-u.y,u.z],[-u.x,-u.y,-u.z],[u.x,-u.y,-u.z],[u.x,u.y,-u.z],[-u.x,u.y,-u.z],[u.x,-u.y,u.z]];for(let _=0;_<h.length;_++)worldCornerTempPos.set(h[_][0],h[_][1],h[_][2]),l.vmult(worldCornerTempPos,worldCornerTempPos),o.vadd(worldCornerTempPos,worldCornerTempPos),c(worldCornerTempPos.x,worldCornerTempPos.y,worldCornerTempPos.z)}calculateWorldAABB(o,l,c,u){const h=this.halfExtents;worldCornersTemp[0].set(h.x,h.y,h.z),worldCornersTemp[1].set(-h.x,h.y,h.z),worldCornersTemp[2].set(-h.x,-h.y,h.z),worldCornersTemp[3].set(-h.x,-h.y,-h.z),worldCornersTemp[4].set(h.x,-h.y,-h.z),worldCornersTemp[5].set(h.x,h.y,-h.z),worldCornersTemp[6].set(-h.x,h.y,-h.z),worldCornersTemp[7].set(h.x,-h.y,h.z);const _=worldCornersTemp[0];l.vmult(_,_),o.vadd(_,_),u.copy(_),c.copy(_);for(let A=1;A<8;A++){const w=worldCornersTemp[A];l.vmult(w,w),o.vadd(w,w);const C=w.x,M=w.y,O=w.z;C>u.x&&(u.x=C),M>u.y&&(u.y=M),O>u.z&&(u.z=O),C<c.x&&(c.x=C),M<c.y&&(c.y=M),O<c.z&&(c.z=O)}}}const worldCornerTempPos=new Vec3,worldCornersTemp=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3],BODY_TYPES={DYNAMIC:1,STATIC:2,KINEMATIC:4},BODY_SLEEP_STATES={AWAKE:0,SLEEPY:1,SLEEPING:2};class Body extends EventTarget{constructor(o){o===void 0&&(o={}),super(),this.id=Body.idCounter++,this.index=-1,this.world=null,this.vlambda=new Vec3,this.collisionFilterGroup=typeof o.collisionFilterGroup=="number"?o.collisionFilterGroup:1,this.collisionFilterMask=typeof o.collisionFilterMask=="number"?o.collisionFilterMask:-1,this.collisionResponse=typeof o.collisionResponse!="boolean"||o.collisionResponse,this.position=new Vec3,this.previousPosition=new Vec3,this.interpolatedPosition=new Vec3,this.initPosition=new Vec3,o.position&&(this.position.copy(o.position),this.previousPosition.copy(o.position),this.interpolatedPosition.copy(o.position),this.initPosition.copy(o.position)),this.velocity=new Vec3,o.velocity&&this.velocity.copy(o.velocity),this.initVelocity=new Vec3,this.force=new Vec3;const l=typeof o.mass=="number"?o.mass:0;this.mass=l,this.invMass=l>0?1/l:0,this.material=o.material||null,this.linearDamping=typeof o.linearDamping=="number"?o.linearDamping:.01,this.type=l<=0?Body.STATIC:Body.DYNAMIC,typeof o.type==typeof Body.STATIC&&(this.type=o.type),this.allowSleep=o.allowSleep===void 0||o.allowSleep,this.sleepState=Body.AWAKE,this.sleepSpeedLimit=o.sleepSpeedLimit!==void 0?o.sleepSpeedLimit:.1,this.sleepTimeLimit=o.sleepTimeLimit!==void 0?o.sleepTimeLimit:1,this.timeLastSleepy=0,this.wakeUpAfterNarrowphase=!1,this.torque=new Vec3,this.quaternion=new Quaternion,this.initQuaternion=new Quaternion,this.previousQuaternion=new Quaternion,this.interpolatedQuaternion=new Quaternion,o.quaternion&&(this.quaternion.copy(o.quaternion),this.initQuaternion.copy(o.quaternion),this.previousQuaternion.copy(o.quaternion),this.interpolatedQuaternion.copy(o.quaternion)),this.angularVelocity=new Vec3,o.angularVelocity&&this.angularVelocity.copy(o.angularVelocity),this.initAngularVelocity=new Vec3,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new Vec3,this.invInertia=new Vec3,this.invInertiaWorld=new Mat3,this.invMassSolve=0,this.invInertiaSolve=new Vec3,this.invInertiaWorldSolve=new Mat3,this.fixedRotation=o.fixedRotation!==void 0&&o.fixedRotation,this.angularDamping=o.angularDamping!==void 0?o.angularDamping:.01,this.linearFactor=new Vec3(1,1,1),o.linearFactor&&this.linearFactor.copy(o.linearFactor),this.angularFactor=new Vec3(1,1,1),o.angularFactor&&this.angularFactor.copy(o.angularFactor),this.aabb=new AABB,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new Vec3,this.isTrigger=!!o.isTrigger,o.shape&&this.addShape(o.shape),this.updateMassProperties()}wakeUp(){const o=this.sleepState;this.sleepState=Body.AWAKE,this.wakeUpAfterNarrowphase=!1,o===Body.SLEEPING&&this.dispatchEvent(Body.wakeupEvent)}sleep(){this.sleepState=Body.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this.wakeUpAfterNarrowphase=!1}sleepTick(o){if(this.allowSleep){const l=this.sleepState,c=this.velocity.lengthSquared()+this.angularVelocity.lengthSquared(),u=this.sleepSpeedLimit**2;l===Body.AWAKE&&c<u?(this.sleepState=Body.SLEEPY,this.timeLastSleepy=o,this.dispatchEvent(Body.sleepyEvent)):l===Body.SLEEPY&&c>u?this.wakeUp():l===Body.SLEEPY&&o-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(Body.sleepEvent))}}updateSolveMassProperties(){this.sleepState===Body.SLEEPING||this.type===Body.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))}pointToLocalFrame(o,l){return l===void 0&&(l=new Vec3),o.vsub(this.position,l),this.quaternion.conjugate().vmult(l,l),l}vectorToLocalFrame(o,l){return l===void 0&&(l=new Vec3),this.quaternion.conjugate().vmult(o,l),l}pointToWorldFrame(o,l){return l===void 0&&(l=new Vec3),this.quaternion.vmult(o,l),l.vadd(this.position,l),l}vectorToWorldFrame(o,l){return l===void 0&&(l=new Vec3),this.quaternion.vmult(o,l),l}addShape(o,l,c){const u=new Vec3,h=new Quaternion;return l&&u.copy(l),c&&h.copy(c),this.shapes.push(o),this.shapeOffsets.push(u),this.shapeOrientations.push(h),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,o.body=this,this}removeShape(o){const l=this.shapes.indexOf(o);return l===-1?(console.warn("Shape does not belong to the body"),this):(this.shapes.splice(l,1),this.shapeOffsets.splice(l,1),this.shapeOrientations.splice(l,1),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,o.body=null,this)}updateBoundingRadius(){const o=this.shapes,l=this.shapeOffsets,c=o.length;let u=0;for(let h=0;h!==c;h++){const _=o[h];_.updateBoundingSphereRadius();const A=l[h].length(),w=_.boundingSphereRadius;A+w>u&&(u=A+w)}this.boundingRadius=u}updateAABB(){const o=this.shapes,l=this.shapeOffsets,c=this.shapeOrientations,u=o.length,h=tmpVec,_=tmpQuat,A=this.quaternion,w=this.aabb,C=updateAABB_shapeAABB;for(let M=0;M!==u;M++){const O=o[M];A.vmult(l[M],h),h.vadd(this.position,h),A.mult(c[M],_),O.calculateWorldAABB(h,_,C.lowerBound,C.upperBound),M===0?w.copy(C):w.extend(C)}this.aabbNeedsUpdate=!1}updateInertiaWorld(o){const l=this.invInertia;if(l.x!==l.y||l.y!==l.z||o){const c=uiw_m1,u=uiw_m2;c.setRotationFromQuaternion(this.quaternion),c.transpose(u),c.scale(l,c),c.mmult(u,this.invInertiaWorld)}}applyForce(o,l){if(l===void 0&&(l=new Vec3),this.type!==Body.DYNAMIC)return;this.sleepState===Body.SLEEPING&&this.wakeUp();const c=Body_applyForce_rotForce;l.cross(o,c),this.force.vadd(o,this.force),this.torque.vadd(c,this.torque)}applyLocalForce(o,l){if(l===void 0&&(l=new Vec3),this.type!==Body.DYNAMIC)return;const c=Body_applyLocalForce_worldForce,u=Body_applyLocalForce_relativePointWorld;this.vectorToWorldFrame(o,c),this.vectorToWorldFrame(l,u),this.applyForce(c,u)}applyTorque(o){this.type===Body.DYNAMIC&&(this.sleepState===Body.SLEEPING&&this.wakeUp(),this.torque.vadd(o,this.torque))}applyImpulse(o,l){if(l===void 0&&(l=new Vec3),this.type!==Body.DYNAMIC)return;this.sleepState===Body.SLEEPING&&this.wakeUp();const c=l,u=Body_applyImpulse_velo;u.copy(o),u.scale(this.invMass,u),this.velocity.vadd(u,this.velocity);const h=Body_applyImpulse_rotVelo;c.cross(o,h),this.invInertiaWorld.vmult(h,h),this.angularVelocity.vadd(h,this.angularVelocity)}applyLocalImpulse(o,l){if(l===void 0&&(l=new Vec3),this.type!==Body.DYNAMIC)return;const c=Body_applyLocalImpulse_worldImpulse,u=Body_applyLocalImpulse_relativePoint;this.vectorToWorldFrame(o,c),this.vectorToWorldFrame(l,u),this.applyImpulse(c,u)}updateMassProperties(){const o=Body_updateMassProperties_halfExtents;this.invMass=this.mass>0?1/this.mass:0;const l=this.inertia,c=this.fixedRotation;this.updateAABB(),o.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),Box.calculateInertia(o,this.mass,l),this.invInertia.set(l.x>0&&!c?1/l.x:0,l.y>0&&!c?1/l.y:0,l.z>0&&!c?1/l.z:0),this.updateInertiaWorld(!0)}getVelocityAtWorldPoint(o,l){const c=new Vec3;return o.vsub(this.position,c),this.angularVelocity.cross(c,l),this.velocity.vadd(l,l),l}integrate(o,l,c){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),this.type!==Body.DYNAMIC&&this.type!==Body.KINEMATIC||this.sleepState===Body.SLEEPING)return;const u=this.velocity,h=this.angularVelocity,_=this.position,A=this.force,w=this.torque,C=this.quaternion,M=this.invMass,O=this.invInertiaWorld,ne=this.linearFactor,ce=M*o;u.x+=A.x*ce*ne.x,u.y+=A.y*ce*ne.y,u.z+=A.z*ce*ne.z;const ue=O.elements,ye=this.angularFactor,Oe=w.x*ye.x,ke=w.y*ye.y,Ve=w.z*ye.z;h.x+=o*(ue[0]*Oe+ue[1]*ke+ue[2]*Ve),h.y+=o*(ue[3]*Oe+ue[4]*ke+ue[5]*Ve),h.z+=o*(ue[6]*Oe+ue[7]*ke+ue[8]*Ve),_.x+=u.x*o,_.y+=u.y*o,_.z+=u.z*o,C.integrate(this.angularVelocity,o,this.angularFactor,C),l&&(c?C.normalizeFast():C.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}}Body.idCounter=0,Body.COLLIDE_EVENT_NAME="collide",Body.DYNAMIC=BODY_TYPES.DYNAMIC,Body.STATIC=BODY_TYPES.STATIC,Body.KINEMATIC=BODY_TYPES.KINEMATIC,Body.AWAKE=BODY_SLEEP_STATES.AWAKE,Body.SLEEPY=BODY_SLEEP_STATES.SLEEPY,Body.SLEEPING=BODY_SLEEP_STATES.SLEEPING,Body.wakeupEvent={type:"wakeup"},Body.sleepyEvent={type:"sleepy"},Body.sleepEvent={type:"sleep"};const tmpVec=new Vec3,tmpQuat=new Quaternion,updateAABB_shapeAABB=new AABB,uiw_m1=new Mat3,uiw_m2=new Mat3;new Mat3;const Body_applyForce_rotForce=new Vec3,Body_applyLocalForce_worldForce=new Vec3,Body_applyLocalForce_relativePointWorld=new Vec3,Body_applyImpulse_velo=new Vec3,Body_applyImpulse_rotVelo=new Vec3,Body_applyLocalImpulse_worldImpulse=new Vec3,Body_applyLocalImpulse_relativePoint=new Vec3,Body_updateMassProperties_halfExtents=new Vec3;class Broadphase{constructor(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}collisionPairs(o,l,c){throw new Error("collisionPairs not implemented for this BroadPhase class!")}needBroadphaseCollision(o,l){return!(!(o.collisionFilterGroup&l.collisionFilterMask&&l.collisionFilterGroup&o.collisionFilterMask)||(o.type&Body.STATIC||o.sleepState===Body.SLEEPING)&&(l.type&Body.STATIC||l.sleepState===Body.SLEEPING))}intersectionTest(o,l,c,u){this.useBoundingBoxes?this.doBoundingBoxBroadphase(o,l,c,u):this.doBoundingSphereBroadphase(o,l,c,u)}doBoundingSphereBroadphase(o,l,c,u){const h=Broadphase_collisionPairs_r;l.position.vsub(o.position,h);const _=(o.boundingRadius+l.boundingRadius)**2;h.lengthSquared()<_&&(c.push(o),u.push(l))}doBoundingBoxBroadphase(o,l,c,u){o.aabbNeedsUpdate&&o.updateAABB(),l.aabbNeedsUpdate&&l.updateAABB(),o.aabb.overlaps(l.aabb)&&(c.push(o),u.push(l))}makePairsUnique(o,l){const c=Broadphase_makePairsUnique_temp,u=Broadphase_makePairsUnique_p1,h=Broadphase_makePairsUnique_p2,_=o.length;for(let A=0;A!==_;A++)u[A]=o[A],h[A]=l[A];o.length=0,l.length=0;for(let A=0;A!==_;A++){const w=u[A].id,C=h[A].id,M=w<C?`${w},${C}`:`${C},${w}`;c[M]=A,c.keys.push(M)}for(let A=0;A!==c.keys.length;A++){const w=c.keys.pop(),C=c[w];o.push(u[C]),l.push(h[C]),delete c[w]}}setWorld(o){}static boundingSphereCheck(o,l){const c=new Vec3;o.position.vsub(l.position,c);const u=o.shapes[0],h=l.shapes[0];return Math.pow(u.boundingSphereRadius+h.boundingSphereRadius,2)>c.lengthSquared()}aabbQuery(o,l,c){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}}const Broadphase_collisionPairs_r=new Vec3;new Vec3,new Quaternion,new Vec3;const Broadphase_makePairsUnique_temp={keys:[]},Broadphase_makePairsUnique_p1=[],Broadphase_makePairsUnique_p2=[];new Vec3;new Vec3;new Vec3;class NaiveBroadphase extends Broadphase{constructor(){super()}collisionPairs(o,l,c){const u=o.bodies,h=u.length;let _,A;for(let w=0;w!==h;w++)for(let C=0;C!==w;C++)_=u[w],A=u[C],this.needBroadphaseCollision(_,A)&&this.intersectionTest(_,A,l,c)}aabbQuery(o,l,c){c===void 0&&(c=[]);for(let u=0;u<o.bodies.length;u++){const h=o.bodies[u];h.aabbNeedsUpdate&&h.updateAABB(),h.aabb.overlaps(l)&&c.push(h)}return c}}class RaycastResult{constructor(){this.rayFromWorld=new Vec3,this.rayToWorld=new Vec3,this.hitNormalWorld=new Vec3,this.hitPointWorld=new Vec3,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}reset(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this.shouldStop=!1}abort(){this.shouldStop=!0}set(o,l,c,u,h,_,A){this.rayFromWorld.copy(o),this.rayToWorld.copy(l),this.hitNormalWorld.copy(c),this.hitPointWorld.copy(u),this.shape=h,this.body=_,this.distance=A}}let _Shape$types$SPHERE,_Shape$types$PLANE,_Shape$types$BOX,_Shape$types$CYLINDER,_Shape$types$CONVEXPO,_Shape$types$HEIGHTFI,_Shape$types$TRIMESH;const RAY_MODES={CLOSEST:1,ANY:2,ALL:4};_Shape$types$SPHERE=Shape.types.SPHERE,_Shape$types$PLANE=Shape.types.PLANE,_Shape$types$BOX=Shape.types.BOX,_Shape$types$CYLINDER=Shape.types.CYLINDER,_Shape$types$CONVEXPO=Shape.types.CONVEXPOLYHEDRON,_Shape$types$HEIGHTFI=Shape.types.HEIGHTFIELD,_Shape$types$TRIMESH=Shape.types.TRIMESH;class Ray{get[_Shape$types$SPHERE](){return this._intersectSphere}get[_Shape$types$PLANE](){return this._intersectPlane}get[_Shape$types$BOX](){return this._intersectBox}get[_Shape$types$CYLINDER](){return this._intersectConvex}get[_Shape$types$CONVEXPO](){return this._intersectConvex}get[_Shape$types$HEIGHTFI](){return this._intersectHeightfield}get[_Shape$types$TRIMESH](){return this._intersectTrimesh}constructor(o,l){o===void 0&&(o=new Vec3),l===void 0&&(l=new Vec3),this.from=o.clone(),this.to=l.clone(),this.direction=new Vec3,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=Ray.ANY,this.result=new RaycastResult,this.hasHit=!1,this.callback=c=>{}}intersectWorld(o,l){return this.mode=l.mode||Ray.ANY,this.result=l.result||new RaycastResult,this.skipBackfaces=!!l.skipBackfaces,this.collisionFilterMask=l.collisionFilterMask!==void 0?l.collisionFilterMask:-1,this.collisionFilterGroup=l.collisionFilterGroup!==void 0?l.collisionFilterGroup:-1,this.checkCollisionResponse=l.checkCollisionResponse===void 0||l.checkCollisionResponse,l.from&&this.from.copy(l.from),l.to&&this.to.copy(l.to),this.callback=l.callback||(()=>{}),this.hasHit=!1,this.result.reset(),this.updateDirection(),this.getAABB(tmpAABB$1),tmpArray.length=0,o.broadphase.aabbQuery(o,tmpAABB$1,tmpArray),this.intersectBodies(tmpArray),this.hasHit}intersectBody(o,l){l&&(this.result=l,this.updateDirection());const c=this.checkCollisionResponse;if(c&&!o.collisionResponse||!(this.collisionFilterGroup&o.collisionFilterMask&&o.collisionFilterGroup&this.collisionFilterMask))return;const u=intersectBody_xi,h=intersectBody_qi;for(let _=0,A=o.shapes.length;_<A;_++){const w=o.shapes[_];if((!c||w.collisionResponse)&&(o.quaternion.mult(o.shapeOrientations[_],h),o.quaternion.vmult(o.shapeOffsets[_],u),u.vadd(o.position,u),this.intersectShape(w,h,u,o),this.result.shouldStop))break}}intersectBodies(o,l){l&&(this.result=l,this.updateDirection());for(let c=0,u=o.length;!this.result.shouldStop&&c<u;c++)this.intersectBody(o[c])}updateDirection(){this.to.vsub(this.from,this.direction),this.direction.normalize()}intersectShape(o,l,c,u){if(distanceFromIntersection(this.from,this.direction,c)>o.boundingSphereRadius)return;const h=this[o.type];h&&h.call(this,o,l,c,u,o)}_intersectBox(o,l,c,u,h){return this._intersectConvex(o.convexPolyhedronRepresentation,l,c,u,h)}_intersectPlane(o,l,c,u,h){const _=this.from,A=this.to,w=this.direction,C=new Vec3(0,0,1);l.vmult(C,C);const M=new Vec3;_.vsub(c,M);const O=M.dot(C);if(A.vsub(c,M),O*M.dot(C)>0||_.distanceTo(A)<O)return;const ne=C.dot(w);if(Math.abs(ne)<this.precision)return;const ce=new Vec3,ue=new Vec3,ye=new Vec3;_.vsub(c,ce);const Oe=-C.dot(ce)/ne;w.scale(Oe,ue),_.vadd(ue,ye),this.reportIntersection(C,ye,h,u,-1)}getAABB(o){const{lowerBound:l,upperBound:c}=o,u=this.to,h=this.from;l.x=Math.min(u.x,h.x),l.y=Math.min(u.y,h.y),l.z=Math.min(u.z,h.z),c.x=Math.max(u.x,h.x),c.y=Math.max(u.y,h.y),c.z=Math.max(u.z,h.z)}_intersectHeightfield(o,l,c,u,h){o.data,o.elementSize;const _=intersectHeightfield_localRay;_.from.copy(this.from),_.to.copy(this.to),cannon_es_Transform.pointToLocalFrame(c,l,_.from,_.from),cannon_es_Transform.pointToLocalFrame(c,l,_.to,_.to),_.updateDirection();const A=intersectHeightfield_index;let w,C,M,O;w=C=0,M=O=o.data.length-1;const ne=new AABB;_.getAABB(ne),o.getIndexOfPosition(ne.lowerBound.x,ne.lowerBound.y,A,!0),w=Math.max(w,A[0]),C=Math.max(C,A[1]),o.getIndexOfPosition(ne.upperBound.x,ne.upperBound.y,A,!0),M=Math.min(M,A[0]+1),O=Math.min(O,A[1]+1);for(let ce=w;ce<M;ce++)for(let ue=C;ue<O;ue++){if(this.result.shouldStop)return;if(o.getAabbAtIndex(ce,ue,ne),ne.overlapsRay(_)){if(o.getConvexTrianglePillar(ce,ue,!1),cannon_es_Transform.pointToWorldFrame(c,l,o.pillarOffset,worldPillarOffset),this._intersectConvex(o.pillarConvex,l,worldPillarOffset,u,h,intersectConvexOptions),this.result.shouldStop)return;o.getConvexTrianglePillar(ce,ue,!0),cannon_es_Transform.pointToWorldFrame(c,l,o.pillarOffset,worldPillarOffset),this._intersectConvex(o.pillarConvex,l,worldPillarOffset,u,h,intersectConvexOptions)}}}_intersectSphere(o,l,c,u,h){const _=this.from,A=this.to,w=o.radius,C=(A.x-_.x)**2+(A.y-_.y)**2+(A.z-_.z)**2,M=2*((A.x-_.x)*(_.x-c.x)+(A.y-_.y)*(_.y-c.y)+(A.z-_.z)*(_.z-c.z)),O=M**2-4*C*((_.x-c.x)**2+(_.y-c.y)**2+(_.z-c.z)**2-w**2),ne=Ray_intersectSphere_intersectionPoint,ce=Ray_intersectSphere_normal;if(!(O<0))if(O===0)_.lerp(A,O,ne),ne.vsub(c,ce),ce.normalize(),this.reportIntersection(ce,ne,h,u,-1);else{const ue=(-M-Math.sqrt(O))/(2*C),ye=(-M+Math.sqrt(O))/(2*C);if(ue>=0&&ue<=1&&(_.lerp(A,ue,ne),ne.vsub(c,ce),ce.normalize(),this.reportIntersection(ce,ne,h,u,-1)),this.result.shouldStop)return;ye>=0&&ye<=1&&(_.lerp(A,ye,ne),ne.vsub(c,ce),ce.normalize(),this.reportIntersection(ce,ne,h,u,-1))}}_intersectConvex(o,l,c,u,h,_){const A=intersectConvex_normal,w=intersectConvex_vector,C=_&&_.faceList||null,M=o.faces,O=o.vertices,ne=o.faceNormals,ce=this.direction,ue=this.from,ye=this.to,Oe=ue.distanceTo(ye),ke=C?C.length:M.length,Ve=this.result;for(let tt=0;!Ve.shouldStop&&tt<ke;tt++){const ht=C?C[tt]:tt,ut=M[ht],_t=ne[ht],at=l,lt=c;w.copy(O[ut[0]]),at.vmult(w,w),w.vadd(lt,w),w.vsub(ue,w),at.vmult(_t,A);const pt=ce.dot(A);if(Math.abs(pt)<this.precision)continue;const xt=A.dot(w)/pt;if(!(xt<0)){ce.scale(xt,intersectPoint),intersectPoint.vadd(ue,intersectPoint),cannon_es_a.copy(O[ut[0]]),at.vmult(cannon_es_a,cannon_es_a),lt.vadd(cannon_es_a,cannon_es_a);for(let Tt=1;!Ve.shouldStop&&Tt<ut.length-1;Tt++){cannon_es_b.copy(O[ut[Tt]]),cannon_es_c.copy(O[ut[Tt+1]]),at.vmult(cannon_es_b,cannon_es_b),at.vmult(cannon_es_c,cannon_es_c),lt.vadd(cannon_es_b,cannon_es_b),lt.vadd(cannon_es_c,cannon_es_c);const Pt=intersectPoint.distanceTo(ue);!Ray.pointInTriangle(intersectPoint,cannon_es_a,cannon_es_b,cannon_es_c)&&!Ray.pointInTriangle(intersectPoint,cannon_es_b,cannon_es_a,cannon_es_c)||Pt>Oe||this.reportIntersection(A,intersectPoint,h,u,ht)}}}}_intersectTrimesh(o,l,c,u,h,_){const A=intersectTrimesh_normal,w=intersectTrimesh_triangles,C=intersectTrimesh_treeTransform,M=intersectConvex_vector,O=intersectTrimesh_localDirection,ne=intersectTrimesh_localFrom,ce=intersectTrimesh_localTo,ue=intersectTrimesh_worldIntersectPoint,ye=intersectTrimesh_worldNormal,Oe=o.indices;o.vertices;const ke=this.from,Ve=this.to,tt=this.direction;C.position.copy(c),C.quaternion.copy(l),cannon_es_Transform.vectorToLocalFrame(c,l,tt,O),cannon_es_Transform.pointToLocalFrame(c,l,ke,ne),cannon_es_Transform.pointToLocalFrame(c,l,Ve,ce),ce.x*=o.scale.x,ce.y*=o.scale.y,ce.z*=o.scale.z,ne.x*=o.scale.x,ne.y*=o.scale.y,ne.z*=o.scale.z,ce.vsub(ne,O),O.normalize();const ht=ne.distanceSquared(ce);o.tree.rayQuery(this,C,w);for(let ut=0,_t=w.length;!this.result.shouldStop&&ut!==_t;ut++){const at=w[ut];o.getNormal(at,A),o.getVertex(Oe[3*at],cannon_es_a),cannon_es_a.vsub(ne,M);const lt=O.dot(A),pt=A.dot(M)/lt;if(pt<0)continue;O.scale(pt,intersectPoint),intersectPoint.vadd(ne,intersectPoint),o.getVertex(Oe[3*at+1],cannon_es_b),o.getVertex(Oe[3*at+2],cannon_es_c);const xt=intersectPoint.distanceSquared(ne);!Ray.pointInTriangle(intersectPoint,cannon_es_b,cannon_es_a,cannon_es_c)&&!Ray.pointInTriangle(intersectPoint,cannon_es_a,cannon_es_b,cannon_es_c)||xt>ht||(cannon_es_Transform.vectorToWorldFrame(l,A,ye),cannon_es_Transform.pointToWorldFrame(c,l,intersectPoint,ue),this.reportIntersection(ye,ue,h,u,at))}w.length=0}reportIntersection(o,l,c,u,h){const _=this.from,A=this.to,w=_.distanceTo(l),C=this.result;if(!(this.skipBackfaces&&o.dot(this.direction)>0))switch(C.hitFaceIndex=h!==void 0?h:-1,this.mode){case Ray.ALL:this.hasHit=!0,C.set(_,A,o,l,c,u,w),C.hasHit=!0,this.callback(C);break;case Ray.CLOSEST:(w<C.distance||!C.hasHit)&&(this.hasHit=!0,C.hasHit=!0,C.set(_,A,o,l,c,u,w));break;case Ray.ANY:this.hasHit=!0,C.hasHit=!0,C.set(_,A,o,l,c,u,w),C.shouldStop=!0}}static pointInTriangle(o,l,c,u){u.vsub(l,v0),c.vsub(l,v1),o.vsub(l,v2);const h=v0.dot(v0),_=v0.dot(v1),A=v0.dot(v2),w=v1.dot(v1),C=v1.dot(v2);let M,O;return(M=w*A-_*C)>=0&&(O=h*C-_*A)>=0&&M+O<h*w-_*_}}Ray.CLOSEST=RAY_MODES.CLOSEST,Ray.ANY=RAY_MODES.ANY,Ray.ALL=RAY_MODES.ALL;const tmpAABB$1=new AABB,tmpArray=[],v1=new Vec3,v2=new Vec3,intersectBody_xi=new Vec3,intersectBody_qi=new Quaternion,intersectPoint=new Vec3,cannon_es_a=new Vec3,cannon_es_b=new Vec3,cannon_es_c=new Vec3;new Vec3,new RaycastResult;const intersectConvexOptions={faceList:[0]},worldPillarOffset=new Vec3,intersectHeightfield_localRay=new Ray,intersectHeightfield_index=[],Ray_intersectSphere_intersectionPoint=new Vec3,Ray_intersectSphere_normal=new Vec3,intersectConvex_normal=new Vec3;new Vec3;new Vec3;const intersectConvex_vector=new Vec3,intersectTrimesh_normal=new Vec3,intersectTrimesh_localDirection=new Vec3,intersectTrimesh_localFrom=new Vec3,intersectTrimesh_localTo=new Vec3,intersectTrimesh_worldNormal=new Vec3,intersectTrimesh_worldIntersectPoint=new Vec3;new AABB;const intersectTrimesh_triangles=[],intersectTrimesh_treeTransform=new cannon_es_Transform,v0=new Vec3,intersect=new Vec3;function distanceFromIntersection(d,o,l){l.vsub(d,v0);const c=v0.dot(o);return o.scale(c,intersect),intersect.vadd(d,intersect),l.distanceTo(intersect)}class Utils{static defaults(o,l){o===void 0&&(o={});for(let c in l)c in o||(o[c]=l[c]);return o}}class Constraint{constructor(o,l,c){c===void 0&&(c={}),c=Utils.defaults(c,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=o,this.bodyB=l,this.id=Constraint.idCounter++,this.collideConnected=c.collideConnected,c.wakeUpBodies&&(o&&o.wakeUp(),l&&l.wakeUp())}update(){throw new Error("method update() not implmemented in this Constraint subclass!")}enable(){const o=this.equations;for(let l=0;l<o.length;l++)o[l].enabled=!0}disable(){const o=this.equations;for(let l=0;l<o.length;l++)o[l].enabled=!1}}Constraint.idCounter=0;class JacobianElement{constructor(){this.spatial=new Vec3,this.rotational=new Vec3}multiplyElement(o){return o.spatial.dot(this.spatial)+o.rotational.dot(this.rotational)}multiplyVectors(o,l){return o.dot(this.spatial)+l.dot(this.rotational)}}class Equation{constructor(o,l,c,u){c===void 0&&(c=-1e6),u===void 0&&(u=1e6),this.id=Equation.idCounter++,this.minForce=c,this.maxForce=u,this.bi=o,this.bj=l,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new JacobianElement,this.jacobianElementB=new JacobianElement,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}setSpookParams(o,l,c){const u=l,h=o,_=c;this.a=4/(_*(1+4*u)),this.b=4*u/(1+4*u),this.eps=4/(_*_*h*(1+4*u))}computeB(o,l,c){const u=this.computeGW();return-this.computeGq()*o-u*l-this.computeGiMf()*c}computeGq(){const o=this.jacobianElementA,l=this.jacobianElementB,c=this.bi,u=this.bj,h=c.position,_=u.position;return o.spatial.dot(h)+l.spatial.dot(_)}computeGW(){const o=this.jacobianElementA,l=this.jacobianElementB,c=this.bi,u=this.bj,h=c.velocity,_=u.velocity,A=c.angularVelocity,w=u.angularVelocity;return o.multiplyVectors(h,A)+l.multiplyVectors(_,w)}computeGWlambda(){const o=this.jacobianElementA,l=this.jacobianElementB,c=this.bi,u=this.bj,h=c.vlambda,_=u.vlambda,A=c.wlambda,w=u.wlambda;return o.multiplyVectors(h,A)+l.multiplyVectors(_,w)}computeGiMf(){const o=this.jacobianElementA,l=this.jacobianElementB,c=this.bi,u=this.bj,h=c.force,_=c.torque,A=u.force,w=u.torque,C=c.invMassSolve,M=u.invMassSolve;return h.scale(C,iMfi),A.scale(M,iMfj),c.invInertiaWorldSolve.vmult(_,invIi_vmult_taui),u.invInertiaWorldSolve.vmult(w,invIj_vmult_tauj),o.multiplyVectors(iMfi,invIi_vmult_taui)+l.multiplyVectors(iMfj,invIj_vmult_tauj)}computeGiMGt(){const o=this.jacobianElementA,l=this.jacobianElementB,c=this.bi,u=this.bj,h=c.invMassSolve,_=u.invMassSolve,A=c.invInertiaWorldSolve,w=u.invInertiaWorldSolve;let C=h+_;return A.vmult(o.rotational,tmp),C+=tmp.dot(o.rotational),w.vmult(l.rotational,tmp),C+=tmp.dot(l.rotational),C}addToWlambda(o){const l=this.jacobianElementA,c=this.jacobianElementB,u=this.bi,h=this.bj,_=addToWlambda_temp;u.vlambda.addScaledVector(u.invMassSolve*o,l.spatial,u.vlambda),h.vlambda.addScaledVector(h.invMassSolve*o,c.spatial,h.vlambda),u.invInertiaWorldSolve.vmult(l.rotational,_),u.wlambda.addScaledVector(o,_,u.wlambda),h.invInertiaWorldSolve.vmult(c.rotational,_),h.wlambda.addScaledVector(o,_,h.wlambda)}computeC(){return this.computeGiMGt()+this.eps}}Equation.idCounter=0;const iMfi=new Vec3,iMfj=new Vec3,invIi_vmult_taui=new Vec3,invIj_vmult_tauj=new Vec3,tmp=new Vec3,addToWlambda_temp=new Vec3;class ContactEquation extends Equation{constructor(o,l,c){c===void 0&&(c=1e6),super(o,l,0,c),this.restitution=0,this.ri=new Vec3,this.rj=new Vec3,this.ni=new Vec3}computeB(o){const l=this.a,c=this.b,u=this.bi,h=this.bj,_=this.ri,A=this.rj,w=ContactEquation_computeB_temp1,C=ContactEquation_computeB_temp2,M=u.velocity,O=u.angularVelocity;u.force,u.torque;const ne=h.velocity,ce=h.angularVelocity;h.force,h.torque;const ue=ContactEquation_computeB_temp3,ye=this.jacobianElementA,Oe=this.jacobianElementB,ke=this.ni;_.cross(ke,w),A.cross(ke,C),ke.negate(ye.spatial),w.negate(ye.rotational),Oe.spatial.copy(ke),Oe.rotational.copy(C),ue.copy(h.position),ue.vadd(A,ue),ue.vsub(u.position,ue),ue.vsub(_,ue);const Ve=ke.dot(ue),tt=this.restitution+1;return-Ve*l-(tt*ne.dot(ke)-tt*M.dot(ke)+ce.dot(C)-O.dot(w))*c-o*this.computeGiMf()}getImpactVelocityAlongNormal(){const o=ContactEquation_getImpactVelocityAlongNormal_vi,l=ContactEquation_getImpactVelocityAlongNormal_vj,c=ContactEquation_getImpactVelocityAlongNormal_xi,u=ContactEquation_getImpactVelocityAlongNormal_xj,h=ContactEquation_getImpactVelocityAlongNormal_relVel;return this.bi.position.vadd(this.ri,c),this.bj.position.vadd(this.rj,u),this.bi.getVelocityAtWorldPoint(c,o),this.bj.getVelocityAtWorldPoint(u,l),o.vsub(l,h),this.ni.dot(h)}}const ContactEquation_computeB_temp1=new Vec3,ContactEquation_computeB_temp2=new Vec3,ContactEquation_computeB_temp3=new Vec3,ContactEquation_getImpactVelocityAlongNormal_vi=new Vec3,ContactEquation_getImpactVelocityAlongNormal_vj=new Vec3,ContactEquation_getImpactVelocityAlongNormal_xi=new Vec3,ContactEquation_getImpactVelocityAlongNormal_xj=new Vec3,ContactEquation_getImpactVelocityAlongNormal_relVel=new Vec3;class PointToPointConstraint extends Constraint{constructor(o,l,c,u,h){l===void 0&&(l=new Vec3),u===void 0&&(u=new Vec3),h===void 0&&(h=1e6),super(o,c),this.pivotA=l.clone(),this.pivotB=u.clone();const _=this.equationX=new ContactEquation(o,c),A=this.equationY=new ContactEquation(o,c),w=this.equationZ=new ContactEquation(o,c);this.equations.push(_,A,w),_.minForce=A.minForce=w.minForce=-h,_.maxForce=A.maxForce=w.maxForce=h,_.ni.set(1,0,0),A.ni.set(0,1,0),w.ni.set(0,0,1)}update(){const o=this.bodyA,l=this.bodyB,c=this.equationX,u=this.equationY,h=this.equationZ;o.quaternion.vmult(this.pivotA,c.ri),l.quaternion.vmult(this.pivotB,c.rj),u.ri.copy(c.ri),u.rj.copy(c.rj),h.ri.copy(c.ri),h.rj.copy(c.rj)}}new Vec3;new Vec3;new Vec3;new Vec3;new Vec3,new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;class FrictionEquation extends Equation{constructor(o,l,c){super(o,l,-c,c),this.ri=new Vec3,this.rj=new Vec3,this.t=new Vec3}computeB(o){this.a;const l=this.b;this.bi,this.bj;const c=this.ri,u=this.rj,h=FrictionEquation_computeB_temp1,_=FrictionEquation_computeB_temp2,A=this.t;c.cross(A,h),u.cross(A,_);const w=this.jacobianElementA,C=this.jacobianElementB;return A.negate(w.spatial),h.negate(w.rotational),C.spatial.copy(A),C.rotational.copy(_),-this.computeGW()*l-o*this.computeGiMf()}}const FrictionEquation_computeB_temp1=new Vec3,FrictionEquation_computeB_temp2=new Vec3;class ContactMaterial{constructor(o,l,c){c=Utils.defaults(c,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=ContactMaterial.idCounter++,this.materials=[o,l],this.friction=c.friction,this.restitution=c.restitution,this.contactEquationStiffness=c.contactEquationStiffness,this.contactEquationRelaxation=c.contactEquationRelaxation,this.frictionEquationStiffness=c.frictionEquationStiffness,this.frictionEquationRelaxation=c.frictionEquationRelaxation}}ContactMaterial.idCounter=0;class cannon_es_Material{constructor(o){o===void 0&&(o={});let l="";typeof o=="string"&&(l=o,o={}),this.name=l,this.id=cannon_es_Material.idCounter++,this.friction=o.friction!==void 0?o.friction:-1,this.restitution=o.restitution!==void 0?o.restitution:-1}}cannon_es_Material.idCounter=0;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3,new Vec3,new Vec3;new Vec3;new Vec3;new Vec3;new Ray,new Vec3;new Vec3;new Vec3;new Vec3(1,0,0),new Vec3(0,1,0),new Vec3(0,0,1);new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;class Sphere extends Shape{constructor(o){if(super({type:Shape.types.SPHERE}),this.radius=o!==void 0?o:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}calculateLocalInertia(o,l){l===void 0&&(l=new Vec3);const c=2*o*this.radius*this.radius/5;return l.x=c,l.y=c,l.z=c,l}volume(){return 4*Math.PI*Math.pow(this.radius,3)/3}updateBoundingSphereRadius(){this.boundingSphereRadius=this.radius}calculateWorldAABB(o,l,c,u){const h=this.radius,_=["x","y","z"];for(let A=0;A<_.length;A++){const w=_[A];c[w]=o[w]-h,u[w]=o[w]+h}}}new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;class Cylinder extends ConvexPolyhedron{constructor(o,l,c,u){if(o===void 0&&(o=1),l===void 0&&(l=1),c===void 0&&(c=1),u===void 0&&(u=8),o<0)throw new Error("The cylinder radiusTop cannot be negative.");if(l<0)throw new Error("The cylinder radiusBottom cannot be negative.");const h=u,_=[],A=[],w=[],C=[],M=[],O=Math.cos,ne=Math.sin;_.push(new Vec3(-l*ne(0),.5*-c,l*O(0))),C.push(0),_.push(new Vec3(-o*ne(0),.5*c,o*O(0))),M.push(1);for(let ue=0;ue<h;ue++){const ye=2*Math.PI/h*(ue+1),Oe=2*Math.PI/h*(ue+.5);ue<h-1?(_.push(new Vec3(-l*ne(ye),.5*-c,l*O(ye))),C.push(2*ue+2),_.push(new Vec3(-o*ne(ye),.5*c,o*O(ye))),M.push(2*ue+3),w.push([2*ue,2*ue+1,2*ue+3,2*ue+2])):w.push([2*ue,2*ue+1,1,0]),(h%2==1||ue<h/2)&&A.push(new Vec3(-ne(Oe),0,O(Oe)))}w.push(C),A.push(new Vec3(0,1,0));const ce=[];for(let ue=0;ue<M.length;ue++)ce.push(M[M.length-ue-1]);w.push(ce),super({vertices:_,faces:w,axes:A}),this.type=Shape.types.CYLINDER,this.radiusTop=o,this.radiusBottom=l,this.height=c,this.numSegments=u}}class cannon_es_Plane extends Shape{constructor(){super({type:Shape.types.PLANE}),this.worldNormal=new Vec3,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}computeWorldNormal(o){const l=this.worldNormal;l.set(0,0,1),o.vmult(l,l),this.worldNormalNeedsUpdate=!1}calculateLocalInertia(o,l){return l===void 0&&(l=new Vec3),l}volume(){return Number.MAX_VALUE}calculateWorldAABB(o,l,c,u){tempNormal.set(0,0,1),l.vmult(tempNormal,tempNormal);const h=Number.MAX_VALUE;c.set(-h,-h,-h),u.set(h,h,h),tempNormal.x===1?u.x=o.x:tempNormal.x===-1&&(c.x=o.x),tempNormal.y===1?u.y=o.y:tempNormal.y===-1&&(c.y=o.y),tempNormal.z===1?u.z=o.z:tempNormal.z===-1&&(c.z=o.z)}updateBoundingSphereRadius(){this.boundingSphereRadius=Number.MAX_VALUE}}const tempNormal=new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;new Vec3;class OctreeNode{constructor(o){o===void 0&&(o={}),this.root=o.root||null,this.aabb=o.aabb?o.aabb.clone():new AABB,this.data=[],this.children=[]}reset(){this.children.length=this.data.length=0}insert(o,l,c){c===void 0&&(c=0);const u=this.data;if(!this.aabb.contains(o))return!1;const h=this.children;if(c<(this.maxDepth||this.root.maxDepth)){let _=!1;h.length||(this.subdivide(),_=!0);for(let A=0;A!==8;A++)if(h[A].insert(o,l,c+1))return!0;_&&(h.length=0)}return u.push(l),!0}subdivide(){const o=this.aabb,l=o.lowerBound,c=o.upperBound,u=this.children;u.push(new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,0,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,0,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,1,0)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,1,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,1,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,0,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(1,0,1)})}),new OctreeNode({aabb:new AABB({lowerBound:new Vec3(0,1,0)})})),c.vsub(l,halfDiagonal),halfDiagonal.scale(.5,halfDiagonal);const h=this.root||this;for(let _=0;_!==8;_++){const A=u[_];A.root=h;const w=A.aabb.lowerBound;w.x*=halfDiagonal.x,w.y*=halfDiagonal.y,w.z*=halfDiagonal.z,w.vadd(l,w),w.vadd(halfDiagonal,A.aabb.upperBound)}}aabbQuery(o,l){this.data,this.children;const c=[this];for(;c.length;){const u=c.pop();u.aabb.overlaps(o)&&Array.prototype.push.apply(l,u.data),Array.prototype.push.apply(c,u.children)}return l}rayQuery(o,l,c){return o.getAABB(tmpAABB),tmpAABB.toLocalFrame(l,tmpAABB),this.aabbQuery(tmpAABB,c),c}removeEmptyNodes(){for(let o=this.children.length-1;o>=0;o--)this.children[o].removeEmptyNodes(),this.children[o].children.length||this.children[o].data.length||this.children.splice(o,1)}}class Octree extends OctreeNode{constructor(o,l){l===void 0&&(l={}),super({root:null,aabb:o}),this.maxDepth=l.maxDepth!==void 0?l.maxDepth:8}}const halfDiagonal=new Vec3,tmpAABB=new AABB;class Trimesh extends Shape{constructor(o,l){super({type:Shape.types.TRIMESH}),this.vertices=new Float32Array(o),this.indices=new Int16Array(l),this.normals=new Float32Array(l.length),this.aabb=new AABB,this.edges=null,this.scale=new Vec3(1,1,1),this.tree=new Octree,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}updateTree(){const o=this.tree;o.reset(),o.aabb.copy(this.aabb);const l=this.scale;o.aabb.lowerBound.x*=1/l.x,o.aabb.lowerBound.y*=1/l.y,o.aabb.lowerBound.z*=1/l.z,o.aabb.upperBound.x*=1/l.x,o.aabb.upperBound.y*=1/l.y,o.aabb.upperBound.z*=1/l.z;const c=new AABB,u=new Vec3,h=new Vec3,_=new Vec3,A=[u,h,_];for(let w=0;w<this.indices.length/3;w++){const C=3*w;this._getUnscaledVertex(this.indices[C],u),this._getUnscaledVertex(this.indices[C+1],h),this._getUnscaledVertex(this.indices[C+2],_),c.setFromPoints(A),o.insert(c,w)}o.removeEmptyNodes()}getTrianglesInAABB(o,l){unscaledAABB.copy(o);const c=this.scale,u=c.x,h=c.y,_=c.z,A=unscaledAABB.lowerBound,w=unscaledAABB.upperBound;return A.x/=u,A.y/=h,A.z/=_,w.x/=u,w.y/=h,w.z/=_,this.tree.aabbQuery(unscaledAABB,l)}setScale(o){const l=this.scale.x===this.scale.y&&this.scale.y===this.scale.z,c=o.x===o.y&&o.y===o.z;l&&c||this.updateNormals(),this.scale.copy(o),this.updateAABB(),this.updateBoundingSphereRadius()}updateNormals(){const o=computeNormals_n,l=this.normals;for(let c=0;c<this.indices.length/3;c++){const u=3*c,h=this.indices[u],_=this.indices[u+1],A=this.indices[u+2];this.getVertex(h,va),this.getVertex(_,vb),this.getVertex(A,vc),Trimesh.computeNormal(vb,va,vc,o),l[u]=o.x,l[u+1]=o.y,l[u+2]=o.z}}updateEdges(){const o={},l=(u,h)=>{o[u<h?`${u}_${h}`:`${h}_${u}`]=!0};for(let u=0;u<this.indices.length/3;u++){const h=3*u,_=this.indices[h],A=this.indices[h+1],w=this.indices[h+2];l(_,A),l(A,w),l(w,_)}const c=Object.keys(o);this.edges=new Int16Array(2*c.length);for(let u=0;u<c.length;u++){const h=c[u].split("_");this.edges[2*u]=parseInt(h[0],10),this.edges[2*u+1]=parseInt(h[1],10)}}getEdgeVertex(o,l,c){const u=this.edges[2*o+(l?1:0)];this.getVertex(u,c)}getEdgeVector(o,l){const c=getEdgeVector_va,u=getEdgeVector_vb;this.getEdgeVertex(o,0,c),this.getEdgeVertex(o,1,u),u.vsub(c,l)}static computeNormal(o,l,c,u){l.vsub(o,ab),c.vsub(l,cannon_es_cb),cannon_es_cb.cross(ab,u),u.isZero()||u.normalize()}getVertex(o,l){const c=this.scale;return this._getUnscaledVertex(o,l),l.x*=c.x,l.y*=c.y,l.z*=c.z,l}_getUnscaledVertex(o,l){const c=3*o,u=this.vertices;return l.set(u[c],u[c+1],u[c+2])}getWorldVertex(o,l,c,u){return this.getVertex(o,u),cannon_es_Transform.pointToWorldFrame(l,c,u,u),u}getTriangleVertices(o,l,c,u){const h=3*o;this.getVertex(this.indices[h],l),this.getVertex(this.indices[h+1],c),this.getVertex(this.indices[h+2],u)}getNormal(o,l){const c=3*o;return l.set(this.normals[c],this.normals[c+1],this.normals[c+2])}calculateLocalInertia(o,l){this.computeLocalAABB(cli_aabb);const c=cli_aabb.upperBound.x-cli_aabb.lowerBound.x,u=cli_aabb.upperBound.y-cli_aabb.lowerBound.y,h=cli_aabb.upperBound.z-cli_aabb.lowerBound.z;return l.set(1/12*o*(2*u*2*u+2*h*2*h),1/12*o*(2*c*2*c+2*h*2*h),1/12*o*(2*u*2*u+2*c*2*c))}computeLocalAABB(o){const l=o.lowerBound,c=o.upperBound,u=this.vertices.length;this.vertices;const h=computeLocalAABB_worldVert;this.getVertex(0,h),l.copy(h),c.copy(h);for(let _=0;_!==u;_++)this.getVertex(_,h),h.x<l.x?l.x=h.x:h.x>c.x&&(c.x=h.x),h.y<l.y?l.y=h.y:h.y>c.y&&(c.y=h.y),h.z<l.z?l.z=h.z:h.z>c.z&&(c.z=h.z)}updateAABB(){this.computeLocalAABB(this.aabb)}updateBoundingSphereRadius(){let o=0;const l=this.vertices,c=new Vec3;for(let u=0,h=l.length/3;u!==h;u++){this.getVertex(u,c);const _=c.lengthSquared();_>o&&(o=_)}this.boundingSphereRadius=Math.sqrt(o)}calculateWorldAABB(o,l,c,u){const h=calculateWorldAABB_frame,_=calculateWorldAABB_aabb;h.position=o,h.quaternion=l,this.aabb.toWorldFrame(h,_),c.copy(_.lowerBound),u.copy(_.upperBound)}volume(){return 4*Math.PI*this.boundingSphereRadius/3}static createTorus(o,l,c,u,h){o===void 0&&(o=1),l===void 0&&(l=.5),c===void 0&&(c=8),u===void 0&&(u=6),h===void 0&&(h=2*Math.PI);const _=[],A=[];for(let w=0;w<=c;w++)for(let C=0;C<=u;C++){const M=C/u*h,O=w/c*Math.PI*2,ne=(o+l*Math.cos(O))*Math.cos(M),ce=(o+l*Math.cos(O))*Math.sin(M),ue=l*Math.sin(O);_.push(ne,ce,ue)}for(let w=1;w<=c;w++)for(let C=1;C<=u;C++){const M=(u+1)*w+C-1,O=(u+1)*(w-1)+C-1,ne=(u+1)*(w-1)+C,ce=(u+1)*w+C;A.push(M,O,ce),A.push(O,ne,ce)}return new Trimesh(_,A)}}const computeNormals_n=new Vec3,unscaledAABB=new AABB,getEdgeVector_va=new Vec3,getEdgeVector_vb=new Vec3,cannon_es_cb=new Vec3,ab=new Vec3,va=new Vec3,vb=new Vec3,vc=new Vec3,cli_aabb=new AABB,computeLocalAABB_worldVert=new Vec3,calculateWorldAABB_frame=new cannon_es_Transform,calculateWorldAABB_aabb=new AABB;class Solver{constructor(){this.equations=[]}solve(o,l){return 0}addEquation(o){!o.enabled||o.bi.isTrigger||o.bj.isTrigger||this.equations.push(o)}removeEquation(o){const l=this.equations,c=l.indexOf(o);c!==-1&&l.splice(c,1)}removeAllEquations(){this.equations.length=0}}class GSSolver extends Solver{constructor(){super(),this.iterations=10,this.tolerance=1e-7}solve(o,l){let c=0;const u=this.iterations,h=this.tolerance*this.tolerance,_=this.equations,A=_.length,w=l.bodies,C=w.length,M=o;let O,ne,ce,ue,ye,Oe;if(A!==0)for(let ht=0;ht!==C;ht++)w[ht].updateSolveMassProperties();const ke=GSSolver_solve_invCs,Ve=GSSolver_solve_Bs,tt=GSSolver_solve_lambda;ke.length=A,Ve.length=A,tt.length=A;for(let ht=0;ht!==A;ht++){const ut=_[ht];tt[ht]=0,Ve[ht]=ut.computeB(M),ke[ht]=1/ut.computeC()}if(A!==0){for(let _t=0;_t!==C;_t++){const at=w[_t],lt=at.vlambda,pt=at.wlambda;lt.set(0,0,0),pt.set(0,0,0)}for(c=0;c!==u;c++){ue=0;for(let _t=0;_t!==A;_t++){const at=_[_t];O=Ve[_t],ne=ke[_t],Oe=tt[_t],ye=at.computeGWlambda(),ce=ne*(O-ye-at.eps*Oe),Oe+ce<at.minForce?ce=at.minForce-Oe:Oe+ce>at.maxForce&&(ce=at.maxForce-Oe),tt[_t]+=ce,ue+=ce>0?ce:-ce,at.addToWlambda(ce)}if(ue*ue<h)break}for(let _t=0;_t!==C;_t++){const at=w[_t],lt=at.velocity,pt=at.angularVelocity;at.vlambda.vmul(at.linearFactor,at.vlambda),lt.vadd(at.vlambda,lt),at.wlambda.vmul(at.angularFactor,at.wlambda),pt.vadd(at.wlambda,pt)}let ht=_.length;const ut=1/M;for(;ht--;)_[ht].multiplier=tt[ht]*ut}return c}}const GSSolver_solve_lambda=[],GSSolver_solve_invCs=[],GSSolver_solve_Bs=[];Body.STATIC;class Pool{constructor(){this.objects=[],this.type=Object}release(){const o=arguments.length;for(let l=0;l!==o;l++)this.objects.push(l<0||arguments.length<=l?void 0:arguments[l]);return this}get(){return this.objects.length===0?this.constructObject():this.objects.pop()}constructObject(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}resize(o){const l=this.objects;for(;l.length>o;)l.pop();for(;l.length<o;)l.push(this.constructObject());return this}}class Vec3Pool extends Pool{constructor(){super(...arguments),this.type=Vec3}constructObject(){return new Vec3}}const COLLISION_TYPES={sphereSphere:Shape.types.SPHERE,spherePlane:Shape.types.SPHERE|Shape.types.PLANE,boxBox:Shape.types.BOX|Shape.types.BOX,sphereBox:Shape.types.SPHERE|Shape.types.BOX,planeBox:Shape.types.PLANE|Shape.types.BOX,convexConvex:Shape.types.CONVEXPOLYHEDRON,sphereConvex:Shape.types.SPHERE|Shape.types.CONVEXPOLYHEDRON,planeConvex:Shape.types.PLANE|Shape.types.CONVEXPOLYHEDRON,boxConvex:Shape.types.BOX|Shape.types.CONVEXPOLYHEDRON,sphereHeightfield:Shape.types.SPHERE|Shape.types.HEIGHTFIELD,boxHeightfield:Shape.types.BOX|Shape.types.HEIGHTFIELD,convexHeightfield:Shape.types.CONVEXPOLYHEDRON|Shape.types.HEIGHTFIELD,sphereParticle:Shape.types.PARTICLE|Shape.types.SPHERE,planeParticle:Shape.types.PLANE|Shape.types.PARTICLE,boxParticle:Shape.types.BOX|Shape.types.PARTICLE,convexParticle:Shape.types.PARTICLE|Shape.types.CONVEXPOLYHEDRON,cylinderCylinder:Shape.types.CYLINDER,sphereCylinder:Shape.types.SPHERE|Shape.types.CYLINDER,planeCylinder:Shape.types.PLANE|Shape.types.CYLINDER,boxCylinder:Shape.types.BOX|Shape.types.CYLINDER,convexCylinder:Shape.types.CONVEXPOLYHEDRON|Shape.types.CYLINDER,heightfieldCylinder:Shape.types.HEIGHTFIELD|Shape.types.CYLINDER,particleCylinder:Shape.types.PARTICLE|Shape.types.CYLINDER,sphereTrimesh:Shape.types.SPHERE|Shape.types.TRIMESH,planeTrimesh:Shape.types.PLANE|Shape.types.TRIMESH};class Narrowphase{get[COLLISION_TYPES.sphereSphere](){return this.sphereSphere}get[COLLISION_TYPES.spherePlane](){return this.spherePlane}get[COLLISION_TYPES.boxBox](){return this.boxBox}get[COLLISION_TYPES.sphereBox](){return this.sphereBox}get[COLLISION_TYPES.planeBox](){return this.planeBox}get[COLLISION_TYPES.convexConvex](){return this.convexConvex}get[COLLISION_TYPES.sphereConvex](){return this.sphereConvex}get[COLLISION_TYPES.planeConvex](){return this.planeConvex}get[COLLISION_TYPES.boxConvex](){return this.boxConvex}get[COLLISION_TYPES.sphereHeightfield](){return this.sphereHeightfield}get[COLLISION_TYPES.boxHeightfield](){return this.boxHeightfield}get[COLLISION_TYPES.convexHeightfield](){return this.convexHeightfield}get[COLLISION_TYPES.sphereParticle](){return this.sphereParticle}get[COLLISION_TYPES.planeParticle](){return this.planeParticle}get[COLLISION_TYPES.boxParticle](){return this.boxParticle}get[COLLISION_TYPES.convexParticle](){return this.convexParticle}get[COLLISION_TYPES.cylinderCylinder](){return this.convexConvex}get[COLLISION_TYPES.sphereCylinder](){return this.sphereConvex}get[COLLISION_TYPES.planeCylinder](){return this.planeConvex}get[COLLISION_TYPES.boxCylinder](){return this.boxConvex}get[COLLISION_TYPES.convexCylinder](){return this.convexConvex}get[COLLISION_TYPES.heightfieldCylinder](){return this.heightfieldCylinder}get[COLLISION_TYPES.particleCylinder](){return this.particleCylinder}get[COLLISION_TYPES.sphereTrimesh](){return this.sphereTrimesh}get[COLLISION_TYPES.planeTrimesh](){return this.planeTrimesh}constructor(o){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new Vec3Pool,this.world=o,this.currentContactMaterial=o.defaultContactMaterial,this.enableFrictionReduction=!1}createContactEquation(o,l,c,u,h,_){let A;this.contactPointPool.length?(A=this.contactPointPool.pop(),A.bi=o,A.bj=l):A=new ContactEquation(o,l),A.enabled=o.collisionResponse&&l.collisionResponse&&c.collisionResponse&&u.collisionResponse;const w=this.currentContactMaterial;A.restitution=w.restitution,A.setSpookParams(w.contactEquationStiffness,w.contactEquationRelaxation,this.world.dt);const C=c.material||o.material,M=u.material||l.material;return C&&M&&C.restitution>=0&&M.restitution>=0&&(A.restitution=C.restitution*M.restitution),A.si=h||c,A.sj=_||u,A}createFrictionEquationsFromContact(o,l){const c=o.bi,u=o.bj,h=o.si,_=o.sj,A=this.world,w=this.currentContactMaterial;let C=w.friction;const M=h.material||c.material,O=_.material||u.material;if(M&&O&&M.friction>=0&&O.friction>=0&&(C=M.friction*O.friction),C>0){const ne=C*A.gravity.length();let ce=c.invMass+u.invMass;ce>0&&(ce=1/ce);const ue=this.frictionEquationPool,ye=ue.length?ue.pop():new FrictionEquation(c,u,ne*ce),Oe=ue.length?ue.pop():new FrictionEquation(c,u,ne*ce);return ye.bi=Oe.bi=c,ye.bj=Oe.bj=u,ye.minForce=Oe.minForce=-ne*ce,ye.maxForce=Oe.maxForce=ne*ce,ye.ri.copy(o.ri),ye.rj.copy(o.rj),Oe.ri.copy(o.ri),Oe.rj.copy(o.rj),o.ni.tangents(ye.t,Oe.t),ye.setSpookParams(w.frictionEquationStiffness,w.frictionEquationRelaxation,A.dt),Oe.setSpookParams(w.frictionEquationStiffness,w.frictionEquationRelaxation,A.dt),ye.enabled=Oe.enabled=o.enabled,l.push(ye,Oe),!0}return!1}createFrictionFromAverage(o){let l=this.result[this.result.length-1];if(!this.createFrictionEquationsFromContact(l,this.frictionResult)||o===1)return;const c=this.frictionResult[this.frictionResult.length-2],u=this.frictionResult[this.frictionResult.length-1];averageNormal.setZero(),averageContactPointA.setZero(),averageContactPointB.setZero();const h=l.bi;l.bj;for(let A=0;A!==o;A++)l=this.result[this.result.length-1-A],l.bi!==h?(averageNormal.vadd(l.ni,averageNormal),averageContactPointA.vadd(l.ri,averageContactPointA),averageContactPointB.vadd(l.rj,averageContactPointB)):(averageNormal.vsub(l.ni,averageNormal),averageContactPointA.vadd(l.rj,averageContactPointA),averageContactPointB.vadd(l.ri,averageContactPointB));const _=1/o;averageContactPointA.scale(_,c.ri),averageContactPointB.scale(_,c.rj),u.ri.copy(c.ri),u.rj.copy(c.rj),averageNormal.normalize(),averageNormal.tangents(c.t,u.t)}getContacts(o,l,c,u,h,_,A){this.contactPointPool=h,this.frictionEquationPool=A,this.result=u,this.frictionResult=_;const w=tmpQuat1,C=tmpQuat2,M=tmpVec1,O=tmpVec2;for(let ne=0,ce=o.length;ne!==ce;ne++){const ue=o[ne],ye=l[ne];let Oe=null;ue.material&&ye.material&&(Oe=c.getContactMaterial(ue.material,ye.material)||null);const ke=ue.type&Body.KINEMATIC&&ye.type&Body.STATIC||ue.type&Body.STATIC&&ye.type&Body.KINEMATIC||ue.type&Body.KINEMATIC&&ye.type&Body.KINEMATIC;for(let Ve=0;Ve<ue.shapes.length;Ve++){ue.quaternion.mult(ue.shapeOrientations[Ve],w),ue.quaternion.vmult(ue.shapeOffsets[Ve],M),M.vadd(ue.position,M);const tt=ue.shapes[Ve];for(let ht=0;ht<ye.shapes.length;ht++){ye.quaternion.mult(ye.shapeOrientations[ht],C),ye.quaternion.vmult(ye.shapeOffsets[ht],O),O.vadd(ye.position,O);const ut=ye.shapes[ht];if(!(tt.collisionFilterMask&ut.collisionFilterGroup&&ut.collisionFilterMask&tt.collisionFilterGroup)||M.distanceTo(O)>tt.boundingSphereRadius+ut.boundingSphereRadius)continue;let _t=null;tt.material&&ut.material&&(_t=c.getContactMaterial(tt.material,ut.material)||null),this.currentContactMaterial=_t||Oe||c.defaultContactMaterial;const at=this[tt.type|ut.type];if(at){let lt=!1;lt=tt.type<ut.type?at.call(this,tt,ut,M,O,w,C,ue,ye,tt,ut,ke):at.call(this,ut,tt,O,M,C,w,ye,ue,tt,ut,ke),lt&&ke&&(c.shapeOverlapKeeper.set(tt.id,ut.id),c.bodyOverlapKeeper.set(ue.id,ye.id))}}}}}sphereSphere(o,l,c,u,h,_,A,w,C,M,O){if(O)return c.distanceSquared(u)<(o.radius+l.radius)**2;const ne=this.createContactEquation(A,w,o,l,C,M);u.vsub(c,ne.ni),ne.ni.normalize(),ne.ri.copy(ne.ni),ne.rj.copy(ne.ni),ne.ri.scale(o.radius,ne.ri),ne.rj.scale(-l.radius,ne.rj),ne.ri.vadd(c,ne.ri),ne.ri.vsub(A.position,ne.ri),ne.rj.vadd(u,ne.rj),ne.rj.vsub(w.position,ne.rj),this.result.push(ne),this.createFrictionEquationsFromContact(ne,this.frictionResult)}spherePlane(o,l,c,u,h,_,A,w,C,M,O){const ne=this.createContactEquation(A,w,o,l,C,M);if(ne.ni.set(0,0,1),_.vmult(ne.ni,ne.ni),ne.ni.negate(ne.ni),ne.ni.normalize(),ne.ni.scale(o.radius,ne.ri),c.vsub(u,point_on_plane_to_sphere),ne.ni.scale(ne.ni.dot(point_on_plane_to_sphere),plane_to_sphere_ortho),point_on_plane_to_sphere.vsub(plane_to_sphere_ortho,ne.rj),-point_on_plane_to_sphere.dot(ne.ni)<=o.radius){if(O)return!0;const ce=ne.ri,ue=ne.rj;ce.vadd(c,ce),ce.vsub(A.position,ce),ue.vadd(u,ue),ue.vsub(w.position,ue),this.result.push(ne),this.createFrictionEquationsFromContact(ne,this.frictionResult)}}boxBox(o,l,c,u,h,_,A,w,C,M,O){return o.convexPolyhedronRepresentation.material=o.material,l.convexPolyhedronRepresentation.material=l.material,o.convexPolyhedronRepresentation.collisionResponse=o.collisionResponse,l.convexPolyhedronRepresentation.collisionResponse=l.collisionResponse,this.convexConvex(o.convexPolyhedronRepresentation,l.convexPolyhedronRepresentation,c,u,h,_,A,w,o,l,O)}sphereBox(o,l,c,u,h,_,A,w,C,M,O){const ne=this.v3pool,ce=sphereBox_sides;c.vsub(u,box_to_sphere),l.getSideNormals(ce,_);const ue=o.radius;let ye=!1;const Oe=sphereBox_side_ns,ke=sphereBox_side_ns1,Ve=sphereBox_side_ns2;let tt=null,ht=0,ut=0,_t=0,at=null;for(let kt=0,Vt=ce.length;kt!==Vt&&ye===!1;kt++){const si=sphereBox_ns;si.copy(ce[kt]);const Jt=si.length();si.normalize();const Wt=box_to_sphere.dot(si);if(Wt<Jt+ue&&Wt>0){const Zt=sphereBox_ns1,ti=sphereBox_ns2;Zt.copy(ce[(kt+1)%3]),ti.copy(ce[(kt+2)%3]);const ci=Zt.length(),ri=ti.length();Zt.normalize(),ti.normalize();const Ct=box_to_sphere.dot(Zt),Ht=box_to_sphere.dot(ti);if(Ct<ci&&Ct>-ci&&Ht<ri&&Ht>-ri){const qt=Math.abs(Wt-Jt-ue);if((at===null||qt<at)&&(at=qt,ut=Ct,_t=Ht,tt=Jt,Oe.copy(si),ke.copy(Zt),Ve.copy(ti),ht++,O))return!0}}}if(ht){ye=!0;const kt=this.createContactEquation(A,w,o,l,C,M);Oe.scale(-ue,kt.ri),kt.ni.copy(Oe),kt.ni.negate(kt.ni),Oe.scale(tt,Oe),ke.scale(ut,ke),Oe.vadd(ke,Oe),Ve.scale(_t,Ve),Oe.vadd(Ve,kt.rj),kt.ri.vadd(c,kt.ri),kt.ri.vsub(A.position,kt.ri),kt.rj.vadd(u,kt.rj),kt.rj.vsub(w.position,kt.rj),this.result.push(kt),this.createFrictionEquationsFromContact(kt,this.frictionResult)}let lt=ne.get();const pt=sphereBox_sphere_to_corner;for(let kt=0;kt!==2&&!ye;kt++)for(let Vt=0;Vt!==2&&!ye;Vt++)for(let si=0;si!==2&&!ye;si++)if(lt.set(0,0,0),kt?lt.vadd(ce[0],lt):lt.vsub(ce[0],lt),Vt?lt.vadd(ce[1],lt):lt.vsub(ce[1],lt),si?lt.vadd(ce[2],lt):lt.vsub(ce[2],lt),u.vadd(lt,pt),pt.vsub(c,pt),pt.lengthSquared()<ue*ue){if(O)return!0;ye=!0;const Jt=this.createContactEquation(A,w,o,l,C,M);Jt.ri.copy(pt),Jt.ri.normalize(),Jt.ni.copy(Jt.ri),Jt.ri.scale(ue,Jt.ri),Jt.rj.copy(lt),Jt.ri.vadd(c,Jt.ri),Jt.ri.vsub(A.position,Jt.ri),Jt.rj.vadd(u,Jt.rj),Jt.rj.vsub(w.position,Jt.rj),this.result.push(Jt),this.createFrictionEquationsFromContact(Jt,this.frictionResult)}ne.release(lt),lt=null;const xt=ne.get(),Tt=ne.get(),Pt=ne.get(),Lt=ne.get(),Bt=ne.get(),Ut=ce.length;for(let kt=0;kt!==Ut&&!ye;kt++)for(let Vt=0;Vt!==Ut&&!ye;Vt++)if(kt%3!=Vt%3){ce[Vt].cross(ce[kt],xt),xt.normalize(),ce[kt].vadd(ce[Vt],Tt),Pt.copy(c),Pt.vsub(Tt,Pt),Pt.vsub(u,Pt);const si=Pt.dot(xt);xt.scale(si,Lt);let Jt=0;for(;Jt===kt%3||Jt===Vt%3;)Jt++;Bt.copy(c),Bt.vsub(Lt,Bt),Bt.vsub(Tt,Bt),Bt.vsub(u,Bt);const Wt=Math.abs(si),Zt=Bt.length();if(Wt<ce[Jt].length()&&Zt<ue){if(O)return!0;ye=!0;const ti=this.createContactEquation(A,w,o,l,C,M);Tt.vadd(Lt,ti.rj),ti.rj.copy(ti.rj),Bt.negate(ti.ni),ti.ni.normalize(),ti.ri.copy(ti.rj),ti.ri.vadd(u,ti.ri),ti.ri.vsub(c,ti.ri),ti.ri.normalize(),ti.ri.scale(ue,ti.ri),ti.ri.vadd(c,ti.ri),ti.ri.vsub(A.position,ti.ri),ti.rj.vadd(u,ti.rj),ti.rj.vsub(w.position,ti.rj),this.result.push(ti),this.createFrictionEquationsFromContact(ti,this.frictionResult)}}ne.release(xt,Tt,Pt,Lt,Bt)}planeBox(o,l,c,u,h,_,A,w,C,M,O){return l.convexPolyhedronRepresentation.material=l.material,l.convexPolyhedronRepresentation.collisionResponse=l.collisionResponse,l.convexPolyhedronRepresentation.id=l.id,this.planeConvex(o,l.convexPolyhedronRepresentation,c,u,h,_,A,w,o,l,O)}convexConvex(o,l,c,u,h,_,A,w,C,M,O,ne,ce){const ue=convexConvex_sepAxis;if(!(c.distanceTo(u)>o.boundingSphereRadius+l.boundingSphereRadius)&&o.findSeparatingAxis(l,c,h,u,_,ue,ne,ce)){const ye=[],Oe=convexConvex_q;o.clipAgainstHull(c,h,l,u,_,ue,-100,100,ye);let ke=0;for(let Ve=0;Ve!==ye.length;Ve++){if(O)return!0;const tt=this.createContactEquation(A,w,o,l,C,M),ht=tt.ri,ut=tt.rj;ue.negate(tt.ni),ye[Ve].normal.negate(Oe),Oe.scale(ye[Ve].depth,Oe),ye[Ve].point.vadd(Oe,ht),ut.copy(ye[Ve].point),ht.vsub(c,ht),ut.vsub(u,ut),ht.vadd(c,ht),ht.vsub(A.position,ht),ut.vadd(u,ut),ut.vsub(w.position,ut),this.result.push(tt),ke++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(tt,this.frictionResult)}this.enableFrictionReduction&&ke&&this.createFrictionFromAverage(ke)}}sphereConvex(o,l,c,u,h,_,A,w,C,M,O){const ne=this.v3pool;c.vsub(u,convex_to_sphere);const ce=l.faceNormals,ue=l.faces,ye=l.vertices,Oe=o.radius;let ke=!1;for(let Ve=0;Ve!==ye.length;Ve++){const tt=ye[Ve],ht=sphereConvex_worldCorner;_.vmult(tt,ht),u.vadd(ht,ht);const ut=sphereConvex_sphereToCorner;if(ht.vsub(c,ut),ut.lengthSquared()<Oe*Oe){if(O)return!0;ke=!0;const _t=this.createContactEquation(A,w,o,l,C,M);return _t.ri.copy(ut),_t.ri.normalize(),_t.ni.copy(_t.ri),_t.ri.scale(Oe,_t.ri),ht.vsub(u,_t.rj),_t.ri.vadd(c,_t.ri),_t.ri.vsub(A.position,_t.ri),_t.rj.vadd(u,_t.rj),_t.rj.vsub(w.position,_t.rj),this.result.push(_t),void this.createFrictionEquationsFromContact(_t,this.frictionResult)}}for(let Ve=0,tt=ue.length;Ve!==tt&&ke===!1;Ve++){const ht=ce[Ve],ut=ue[Ve],_t=sphereConvex_worldNormal;_.vmult(ht,_t);const at=sphereConvex_worldPoint;_.vmult(ye[ut[0]],at),at.vadd(u,at);const lt=sphereConvex_worldSpherePointClosestToPlane;_t.scale(-Oe,lt),c.vadd(lt,lt);const pt=sphereConvex_penetrationVec;lt.vsub(at,pt);const xt=pt.dot(_t),Tt=sphereConvex_sphereToWorldPoint;if(c.vsub(at,Tt),xt<0&&Tt.dot(_t)>0){const Pt=[];for(let Lt=0,Bt=ut.length;Lt!==Bt;Lt++){const Ut=ne.get();_.vmult(ye[ut[Lt]],Ut),u.vadd(Ut,Ut),Pt.push(Ut)}if(pointInPolygon(Pt,_t,c)){if(O)return!0;ke=!0;const Lt=this.createContactEquation(A,w,o,l,C,M);_t.scale(-Oe,Lt.ri),_t.negate(Lt.ni);const Bt=ne.get();_t.scale(-xt,Bt);const Ut=ne.get();_t.scale(-Oe,Ut),c.vsub(u,Lt.rj),Lt.rj.vadd(Ut,Lt.rj),Lt.rj.vadd(Bt,Lt.rj),Lt.rj.vadd(u,Lt.rj),Lt.rj.vsub(w.position,Lt.rj),Lt.ri.vadd(c,Lt.ri),Lt.ri.vsub(A.position,Lt.ri),ne.release(Bt),ne.release(Ut),this.result.push(Lt),this.createFrictionEquationsFromContact(Lt,this.frictionResult);for(let kt=0,Vt=Pt.length;kt!==Vt;kt++)ne.release(Pt[kt]);return}for(let Lt=0;Lt!==ut.length;Lt++){const Bt=ne.get(),Ut=ne.get();_.vmult(ye[ut[(Lt+1)%ut.length]],Bt),_.vmult(ye[ut[(Lt+2)%ut.length]],Ut),u.vadd(Bt,Bt),u.vadd(Ut,Ut);const kt=sphereConvex_edge;Ut.vsub(Bt,kt);const Vt=sphereConvex_edgeUnit;kt.unit(Vt);const si=ne.get(),Jt=ne.get();c.vsub(Bt,Jt);const Wt=Jt.dot(Vt);Vt.scale(Wt,si),si.vadd(Bt,si);const Zt=ne.get();if(si.vsub(c,Zt),Wt>0&&Wt*Wt<kt.lengthSquared()&&Zt.lengthSquared()<Oe*Oe){if(O)return!0;const ti=this.createContactEquation(A,w,o,l,C,M);si.vsub(u,ti.rj),si.vsub(c,ti.ni),ti.ni.normalize(),ti.ni.scale(Oe,ti.ri),ti.rj.vadd(u,ti.rj),ti.rj.vsub(w.position,ti.rj),ti.ri.vadd(c,ti.ri),ti.ri.vsub(A.position,ti.ri),this.result.push(ti),this.createFrictionEquationsFromContact(ti,this.frictionResult);for(let ci=0,ri=Pt.length;ci!==ri;ci++)ne.release(Pt[ci]);return ne.release(Bt),ne.release(Ut),ne.release(si),ne.release(Zt),void ne.release(Jt)}ne.release(Bt),ne.release(Ut),ne.release(si),ne.release(Zt),ne.release(Jt)}for(let Lt=0,Bt=Pt.length;Lt!==Bt;Lt++)ne.release(Pt[Lt])}}}planeConvex(o,l,c,u,h,_,A,w,C,M,O){const ne=planeConvex_v,ce=planeConvex_normal;ce.set(0,0,1),h.vmult(ce,ce);let ue=0;const ye=planeConvex_relpos;for(let Oe=0;Oe!==l.vertices.length;Oe++)if(ne.copy(l.vertices[Oe]),_.vmult(ne,ne),u.vadd(ne,ne),ne.vsub(c,ye),ce.dot(ye)<=0){if(O)return!0;const ke=this.createContactEquation(A,w,o,l,C,M),Ve=planeConvex_projected;ce.scale(ce.dot(ye),Ve),ne.vsub(Ve,Ve),Ve.vsub(c,ke.ri),ke.ni.copy(ce),ne.vsub(u,ke.rj),ke.ri.vadd(c,ke.ri),ke.ri.vsub(A.position,ke.ri),ke.rj.vadd(u,ke.rj),ke.rj.vsub(w.position,ke.rj),this.result.push(ke),ue++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(ke,this.frictionResult)}this.enableFrictionReduction&&ue&&this.createFrictionFromAverage(ue)}boxConvex(o,l,c,u,h,_,A,w,C,M,O){return o.convexPolyhedronRepresentation.material=o.material,o.convexPolyhedronRepresentation.collisionResponse=o.collisionResponse,this.convexConvex(o.convexPolyhedronRepresentation,l,c,u,h,_,A,w,o,l,O)}sphereHeightfield(o,l,c,u,h,_,A,w,C,M,O){const ne=l.data,ce=o.radius,ue=l.elementSize,ye=sphereHeightfield_tmp2,Oe=sphereHeightfield_tmp1;cannon_es_Transform.pointToLocalFrame(u,_,c,Oe);let ke=Math.floor((Oe.x-ce)/ue)-1,Ve=Math.ceil((Oe.x+ce)/ue)+1,tt=Math.floor((Oe.y-ce)/ue)-1,ht=Math.ceil((Oe.y+ce)/ue)+1;if(Ve<0||ht<0||ke>ne.length||tt>ne[0].length)return;ke<0&&(ke=0),Ve<0&&(Ve=0),tt<0&&(tt=0),ht<0&&(ht=0),ke>=ne.length&&(ke=ne.length-1),Ve>=ne.length&&(Ve=ne.length-1),ht>=ne[0].length&&(ht=ne[0].length-1),tt>=ne[0].length&&(tt=ne[0].length-1);const ut=[];l.getRectMinMax(ke,tt,Ve,ht,ut);const _t=ut[0],at=ut[1];if(Oe.z-ce>at||Oe.z+ce<_t)return;const lt=this.result;for(let pt=ke;pt<Ve;pt++)for(let xt=tt;xt<ht;xt++){const Tt=lt.length;let Pt=!1;if(l.getConvexTrianglePillar(pt,xt,!1),cannon_es_Transform.pointToWorldFrame(u,_,l.pillarOffset,ye),c.distanceTo(ye)<l.pillarConvex.boundingSphereRadius+o.boundingSphereRadius&&(Pt=this.sphereConvex(o,l.pillarConvex,c,ye,h,_,A,w,o,l,O)),O&&Pt||(l.getConvexTrianglePillar(pt,xt,!0),cannon_es_Transform.pointToWorldFrame(u,_,l.pillarOffset,ye),c.distanceTo(ye)<l.pillarConvex.boundingSphereRadius+o.boundingSphereRadius&&(Pt=this.sphereConvex(o,l.pillarConvex,c,ye,h,_,A,w,o,l,O)),O&&Pt))return!0;if(lt.length-Tt>2)return}}boxHeightfield(o,l,c,u,h,_,A,w,C,M,O){return o.convexPolyhedronRepresentation.material=o.material,o.convexPolyhedronRepresentation.collisionResponse=o.collisionResponse,this.convexHeightfield(o.convexPolyhedronRepresentation,l,c,u,h,_,A,w,o,l,O)}convexHeightfield(o,l,c,u,h,_,A,w,C,M,O){const ne=l.data,ce=l.elementSize,ue=o.boundingSphereRadius,ye=convexHeightfield_tmp2,Oe=convexHeightfield_faceList,ke=convexHeightfield_tmp1;cannon_es_Transform.pointToLocalFrame(u,_,c,ke);let Ve=Math.floor((ke.x-ue)/ce)-1,tt=Math.ceil((ke.x+ue)/ce)+1,ht=Math.floor((ke.y-ue)/ce)-1,ut=Math.ceil((ke.y+ue)/ce)+1;if(tt<0||ut<0||Ve>ne.length||ht>ne[0].length)return;Ve<0&&(Ve=0),tt<0&&(tt=0),ht<0&&(ht=0),ut<0&&(ut=0),Ve>=ne.length&&(Ve=ne.length-1),tt>=ne.length&&(tt=ne.length-1),ut>=ne[0].length&&(ut=ne[0].length-1),ht>=ne[0].length&&(ht=ne[0].length-1);const _t=[];l.getRectMinMax(Ve,ht,tt,ut,_t);const at=_t[0],lt=_t[1];if(!(ke.z-ue>lt||ke.z+ue<at))for(let pt=Ve;pt<tt;pt++)for(let xt=ht;xt<ut;xt++){let Tt=!1;if(l.getConvexTrianglePillar(pt,xt,!1),cannon_es_Transform.pointToWorldFrame(u,_,l.pillarOffset,ye),c.distanceTo(ye)<l.pillarConvex.boundingSphereRadius+o.boundingSphereRadius&&(Tt=this.convexConvex(o,l.pillarConvex,c,ye,h,_,A,w,null,null,O,Oe,null)),O&&Tt||(l.getConvexTrianglePillar(pt,xt,!0),cannon_es_Transform.pointToWorldFrame(u,_,l.pillarOffset,ye),c.distanceTo(ye)<l.pillarConvex.boundingSphereRadius+o.boundingSphereRadius&&(Tt=this.convexConvex(o,l.pillarConvex,c,ye,h,_,A,w,null,null,O,Oe,null)),O&&Tt))return!0}}sphereParticle(o,l,c,u,h,_,A,w,C,M,O){const ne=particleSphere_normal;if(ne.set(0,0,1),u.vsub(c,ne),ne.lengthSquared()<=o.radius*o.radius){if(O)return!0;const ce=this.createContactEquation(w,A,l,o,C,M);ne.normalize(),ce.rj.copy(ne),ce.rj.scale(o.radius,ce.rj),ce.ni.copy(ne),ce.ni.negate(ce.ni),ce.ri.set(0,0,0),this.result.push(ce),this.createFrictionEquationsFromContact(ce,this.frictionResult)}}planeParticle(o,l,c,u,h,_,A,w,C,M,O){const ne=particlePlane_normal;ne.set(0,0,1),A.quaternion.vmult(ne,ne);const ce=particlePlane_relpos;if(u.vsub(A.position,ce),ne.dot(ce)<=0){if(O)return!0;const ue=this.createContactEquation(w,A,l,o,C,M);ue.ni.copy(ne),ue.ni.negate(ue.ni),ue.ri.set(0,0,0);const ye=particlePlane_projected;ne.scale(ne.dot(u),ye),u.vsub(ye,ye),ue.rj.copy(ye),this.result.push(ue),this.createFrictionEquationsFromContact(ue,this.frictionResult)}}boxParticle(o,l,c,u,h,_,A,w,C,M,O){return o.convexPolyhedronRepresentation.material=o.material,o.convexPolyhedronRepresentation.collisionResponse=o.collisionResponse,this.convexParticle(o.convexPolyhedronRepresentation,l,c,u,h,_,A,w,o,l,O)}convexParticle(o,l,c,u,h,_,A,w,C,M,O){let ne=-1;const ce=convexParticle_penetratedFaceNormal,ue=convexParticle_worldPenetrationVec;let ye=null;const Oe=convexParticle_local;if(Oe.copy(u),Oe.vsub(c,Oe),h.conjugate(cqj),cqj.vmult(Oe,Oe),o.pointIsInside(Oe)){o.worldVerticesNeedsUpdate&&o.computeWorldVertices(c,h),o.worldFaceNormalsNeedsUpdate&&o.computeWorldFaceNormals(h);for(let ke=0,Ve=o.faces.length;ke!==Ve;ke++){const tt=[o.worldVertices[o.faces[ke][0]]],ht=o.worldFaceNormals[ke];u.vsub(tt[0],convexParticle_vertexToParticle);const ut=-ht.dot(convexParticle_vertexToParticle);if(ye===null||Math.abs(ut)<Math.abs(ye)){if(O)return!0;ye=ut,ne=ke,ce.copy(ht)}}if(ne!==-1){const ke=this.createContactEquation(w,A,l,o,C,M);ce.scale(ye,ue),ue.vadd(u,ue),ue.vsub(c,ue),ke.rj.copy(ue),ce.negate(ke.ni),ke.ri.set(0,0,0);const Ve=ke.ri,tt=ke.rj;Ve.vadd(u,Ve),Ve.vsub(w.position,Ve),tt.vadd(c,tt),tt.vsub(A.position,tt),this.result.push(ke),this.createFrictionEquationsFromContact(ke,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}}heightfieldCylinder(o,l,c,u,h,_,A,w,C,M,O){return this.convexHeightfield(l,o,u,c,_,h,w,A,C,M,O)}particleCylinder(o,l,c,u,h,_,A,w,C,M,O){return this.convexParticle(l,o,u,c,_,h,w,A,C,M,O)}sphereTrimesh(o,l,c,u,h,_,A,w,C,M,O){const ne=sphereTrimesh_edgeVertexA,ce=sphereTrimesh_edgeVertexB,ue=sphereTrimesh_edgeVector,ye=sphereTrimesh_edgeVectorUnit,Oe=sphereTrimesh_localSpherePos,ke=sphereTrimesh_tmp,Ve=sphereTrimesh_localSphereAABB,tt=sphereTrimesh_v2,ht=sphereTrimesh_relpos,ut=sphereTrimesh_triangles;cannon_es_Transform.pointToLocalFrame(u,_,c,Oe);const _t=o.radius;Ve.lowerBound.set(Oe.x-_t,Oe.y-_t,Oe.z-_t),Ve.upperBound.set(Oe.x+_t,Oe.y+_t,Oe.z+_t),l.getTrianglesInAABB(Ve,ut);const at=sphereTrimesh_v,lt=o.radius*o.radius;for(let Lt=0;Lt<ut.length;Lt++)for(let Bt=0;Bt<3;Bt++)if(l.getVertex(l.indices[3*ut[Lt]+Bt],at),at.vsub(Oe,ht),ht.lengthSquared()<=lt){if(tt.copy(at),cannon_es_Transform.pointToWorldFrame(u,_,tt,at),at.vsub(c,ht),O)return!0;let Ut=this.createContactEquation(A,w,o,l,C,M);Ut.ni.copy(ht),Ut.ni.normalize(),Ut.ri.copy(Ut.ni),Ut.ri.scale(o.radius,Ut.ri),Ut.ri.vadd(c,Ut.ri),Ut.ri.vsub(A.position,Ut.ri),Ut.rj.copy(at),Ut.rj.vsub(w.position,Ut.rj),this.result.push(Ut),this.createFrictionEquationsFromContact(Ut,this.frictionResult)}for(let Lt=0;Lt<ut.length;Lt++)for(let Bt=0;Bt<3;Bt++){l.getVertex(l.indices[3*ut[Lt]+Bt],ne),l.getVertex(l.indices[3*ut[Lt]+(Bt+1)%3],ce),ce.vsub(ne,ue),Oe.vsub(ce,ke);const Ut=ke.dot(ue);Oe.vsub(ne,ke);let kt=ke.dot(ue);if(kt>0&&Ut<0&&(Oe.vsub(ne,ke),ye.copy(ue),ye.normalize(),kt=ke.dot(ye),ye.scale(kt,ke),ke.vadd(ne,ke),ke.distanceTo(Oe)<o.radius)){if(O)return!0;const Vt=this.createContactEquation(A,w,o,l,C,M);ke.vsub(Oe,Vt.ni),Vt.ni.normalize(),Vt.ni.scale(o.radius,Vt.ri),Vt.ri.vadd(c,Vt.ri),Vt.ri.vsub(A.position,Vt.ri),cannon_es_Transform.pointToWorldFrame(u,_,ke,ke),ke.vsub(w.position,Vt.rj),cannon_es_Transform.vectorToWorldFrame(_,Vt.ni,Vt.ni),cannon_es_Transform.vectorToWorldFrame(_,Vt.ri,Vt.ri),this.result.push(Vt),this.createFrictionEquationsFromContact(Vt,this.frictionResult)}}const pt=sphereTrimesh_va,xt=sphereTrimesh_vb,Tt=sphereTrimesh_vc,Pt=sphereTrimesh_normal;for(let Lt=0,Bt=ut.length;Lt!==Bt;Lt++){l.getTriangleVertices(ut[Lt],pt,xt,Tt),l.getNormal(ut[Lt],Pt),Oe.vsub(pt,ke);let Ut=ke.dot(Pt);if(Pt.scale(Ut,ke),Oe.vsub(ke,ke),Ut=ke.distanceTo(Oe),Ray.pointInTriangle(ke,pt,xt,Tt)&&Ut<o.radius){if(O)return!0;let kt=this.createContactEquation(A,w,o,l,C,M);ke.vsub(Oe,kt.ni),kt.ni.normalize(),kt.ni.scale(o.radius,kt.ri),kt.ri.vadd(c,kt.ri),kt.ri.vsub(A.position,kt.ri),cannon_es_Transform.pointToWorldFrame(u,_,ke,ke),ke.vsub(w.position,kt.rj),cannon_es_Transform.vectorToWorldFrame(_,kt.ni,kt.ni),cannon_es_Transform.vectorToWorldFrame(_,kt.ri,kt.ri),this.result.push(kt),this.createFrictionEquationsFromContact(kt,this.frictionResult)}}ut.length=0}planeTrimesh(o,l,c,u,h,_,A,w,C,M,O){const ne=new Vec3,ce=planeTrimesh_normal;ce.set(0,0,1),h.vmult(ce,ce);for(let ue=0;ue<l.vertices.length/3;ue++){l.getVertex(ue,ne);const ye=new Vec3;ye.copy(ne),cannon_es_Transform.pointToWorldFrame(u,_,ye,ne);const Oe=planeTrimesh_relpos;if(ne.vsub(c,Oe),ce.dot(Oe)<=0){if(O)return!0;const ke=this.createContactEquation(A,w,o,l,C,M);ke.ni.copy(ce);const Ve=planeTrimesh_projected;ce.scale(Oe.dot(ce),Ve),ne.vsub(Ve,Ve),ke.ri.copy(Ve),ke.ri.vsub(A.position,ke.ri),ke.rj.copy(ne),ke.rj.vsub(w.position,ke.rj),this.result.push(ke),this.createFrictionEquationsFromContact(ke,this.frictionResult)}}}}const averageNormal=new Vec3,averageContactPointA=new Vec3,averageContactPointB=new Vec3,tmpVec1=new Vec3,tmpVec2=new Vec3,tmpQuat1=new Quaternion,tmpQuat2=new Quaternion,planeTrimesh_normal=new Vec3,planeTrimesh_relpos=new Vec3,planeTrimesh_projected=new Vec3,sphereTrimesh_normal=new Vec3,sphereTrimesh_relpos=new Vec3;new Vec3;const sphereTrimesh_v=new Vec3,sphereTrimesh_v2=new Vec3,sphereTrimesh_edgeVertexA=new Vec3,sphereTrimesh_edgeVertexB=new Vec3,sphereTrimesh_edgeVector=new Vec3,sphereTrimesh_edgeVectorUnit=new Vec3,sphereTrimesh_localSpherePos=new Vec3,sphereTrimesh_tmp=new Vec3,sphereTrimesh_va=new Vec3,sphereTrimesh_vb=new Vec3,sphereTrimesh_vc=new Vec3,sphereTrimesh_localSphereAABB=new AABB,sphereTrimesh_triangles=[],point_on_plane_to_sphere=new Vec3,plane_to_sphere_ortho=new Vec3,pointInPolygon_edge=new Vec3,pointInPolygon_edge_x_normal=new Vec3,pointInPolygon_vtp=new Vec3;function pointInPolygon(d,o,l){let c=null;const u=d.length;for(let h=0;h!==u;h++){const _=d[h],A=pointInPolygon_edge;d[(h+1)%u].vsub(_,A);const w=pointInPolygon_edge_x_normal;A.cross(o,w);const C=pointInPolygon_vtp;l.vsub(_,C);const M=w.dot(C);if(!(c===null||M>0&&c===!0||M<=0&&c===!1))return!1;c===null&&(c=M>0)}return!0}const box_to_sphere=new Vec3,sphereBox_ns=new Vec3,sphereBox_ns1=new Vec3,sphereBox_ns2=new Vec3,sphereBox_sides=[new Vec3,new Vec3,new Vec3,new Vec3,new Vec3,new Vec3],sphereBox_sphere_to_corner=new Vec3,sphereBox_side_ns=new Vec3,sphereBox_side_ns1=new Vec3,sphereBox_side_ns2=new Vec3,convex_to_sphere=new Vec3,sphereConvex_edge=new Vec3,sphereConvex_edgeUnit=new Vec3,sphereConvex_sphereToCorner=new Vec3,sphereConvex_worldCorner=new Vec3,sphereConvex_worldNormal=new Vec3,sphereConvex_worldPoint=new Vec3,sphereConvex_worldSpherePointClosestToPlane=new Vec3,sphereConvex_penetrationVec=new Vec3,sphereConvex_sphereToWorldPoint=new Vec3;new Vec3,new Vec3;const planeConvex_v=new Vec3,planeConvex_normal=new Vec3,planeConvex_relpos=new Vec3,planeConvex_projected=new Vec3,convexConvex_sepAxis=new Vec3,convexConvex_q=new Vec3,particlePlane_normal=new Vec3,particlePlane_relpos=new Vec3,particlePlane_projected=new Vec3,particleSphere_normal=new Vec3,cqj=new Quaternion,convexParticle_local=new Vec3;new Vec3;const convexParticle_penetratedFaceNormal=new Vec3,convexParticle_vertexToParticle=new Vec3,convexParticle_worldPenetrationVec=new Vec3,convexHeightfield_tmp1=new Vec3,convexHeightfield_tmp2=new Vec3,convexHeightfield_faceList=[0],sphereHeightfield_tmp1=new Vec3,sphereHeightfield_tmp2=new Vec3;class OverlapKeeper{constructor(){this.current=[],this.previous=[]}getKey(o,l){if(l<o){const c=l;l=o,o=c}return o<<16|l}set(o,l){const c=this.getKey(o,l),u=this.current;let h=0;for(;c>u[h];)h++;if(c!==u[h]){for(let _=u.length-1;_>=h;_--)u[_+1]=u[_];u[h]=c}}tick(){const o=this.current;this.current=this.previous,this.previous=o,this.current.length=0}getDiff(o,l){const c=this.current,u=this.previous,h=c.length,_=u.length;let A=0;for(let w=0;w<h;w++){let C=!1;const M=c[w];for(;M>u[A];)A++;C=M===u[A],C||unpackAndPush(o,M)}A=0;for(let w=0;w<_;w++){let C=!1;const M=u[w];for(;M>c[A];)A++;C=c[A]===M,C||unpackAndPush(l,M)}}}function unpackAndPush(d,o){d.push((4294901760&o)>>16,65535&o)}const getKey=(d,o)=>d<o?`${d}-${o}`:`${o}-${d}`;class TupleDictionary{constructor(){this.data={keys:[]}}get(o,l){const c=getKey(o,l);return this.data[c]}set(o,l,c){const u=getKey(o,l);this.get(o,l)||this.data.keys.push(u),this.data[u]=c}delete(o,l){const c=getKey(o,l),u=this.data.keys.indexOf(c);u!==-1&&this.data.keys.splice(u,1),delete this.data[c]}reset(){const o=this.data,l=o.keys;for(;l.length>0;)delete o[l.pop()]}}class World extends EventTarget{constructor(o){o===void 0&&(o={}),super(),this.dt=-1,this.allowSleep=!!o.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=o.quatNormalizeSkip!==void 0?o.quatNormalizeSkip:0,this.quatNormalizeFast=o.quatNormalizeFast!==void 0&&o.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new Vec3,o.gravity&&this.gravity.copy(o.gravity),this.broadphase=o.broadphase!==void 0?o.broadphase:new NaiveBroadphase,this.bodies=[],this.hasActiveBodies=!1,this.solver=o.solver!==void 0?o.solver:new GSSolver,this.constraints=[],this.narrowphase=new Narrowphase(this),this.collisionMatrix=new ArrayCollisionMatrix,this.collisionMatrixPrevious=new ArrayCollisionMatrix,this.bodyOverlapKeeper=new OverlapKeeper,this.shapeOverlapKeeper=new OverlapKeeper,this.contactmaterials=[],this.contactMaterialTable=new TupleDictionary,this.defaultMaterial=new cannon_es_Material("default"),this.defaultContactMaterial=new ContactMaterial(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this)}getContactMaterial(o,l){return this.contactMaterialTable.get(o.id,l.id)}collisionMatrixTick(){const o=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=o,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()}addConstraint(o){this.constraints.push(o)}removeConstraint(o){const l=this.constraints.indexOf(o);l!==-1&&this.constraints.splice(l,1)}rayTest(o,l,c){c instanceof RaycastResult?this.raycastClosest(o,l,{skipBackfaces:!0},c):this.raycastAll(o,l,{skipBackfaces:!0},c)}raycastAll(o,l,c,u){return c===void 0&&(c={}),c.mode=Ray.ALL,c.from=o,c.to=l,c.callback=u,tmpRay.intersectWorld(this,c)}raycastAny(o,l,c,u){return c===void 0&&(c={}),c.mode=Ray.ANY,c.from=o,c.to=l,c.result=u,tmpRay.intersectWorld(this,c)}raycastClosest(o,l,c,u){return c===void 0&&(c={}),c.mode=Ray.CLOSEST,c.from=o,c.to=l,c.result=u,tmpRay.intersectWorld(this,c)}addBody(o){this.bodies.includes(o)||(o.index=this.bodies.length,this.bodies.push(o),o.world=this,o.initPosition.copy(o.position),o.initVelocity.copy(o.velocity),o.timeLastSleepy=this.time,o instanceof Body&&(o.initAngularVelocity.copy(o.angularVelocity),o.initQuaternion.copy(o.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=o,this.idToBodyMap[o.id]=o,this.dispatchEvent(this.addBodyEvent))}removeBody(o){o.world=null;const l=this.bodies.length-1,c=this.bodies,u=c.indexOf(o);if(u!==-1){c.splice(u,1);for(let h=0;h!==c.length;h++)c[h].index=h;this.collisionMatrix.setNumObjects(l),this.removeBodyEvent.body=o,delete this.idToBodyMap[o.id],this.dispatchEvent(this.removeBodyEvent)}}getBodyById(o){return this.idToBodyMap[o]}getShapeById(o){const l=this.bodies;for(let c=0;c<l.length;c++){const u=l[c].shapes;for(let h=0;h<u.length;h++){const _=u[h];if(_.id===o)return _}}return null}addContactMaterial(o){this.contactmaterials.push(o),this.contactMaterialTable.set(o.materials[0].id,o.materials[1].id,o)}removeContactMaterial(o){const l=this.contactmaterials.indexOf(o);l!==-1&&(this.contactmaterials.splice(l,1),this.contactMaterialTable.delete(o.materials[0].id,o.materials[1].id))}fixedStep(o,l){o===void 0&&(o=1/60),l===void 0&&(l=10);const c=cannon_es_performance.now()/1e3;if(this.lastCallTime){const u=c-this.lastCallTime;this.step(o,u,l)}else this.step(o,void 0,l);this.lastCallTime=c}step(o,l,c){if(c===void 0&&(c=10),l===void 0)this.internalStep(o),this.time+=o;else{this.accumulator+=l;const u=cannon_es_performance.now();let h=0;for(;this.accumulator>=o&&h<c&&(this.internalStep(o),this.accumulator-=o,h++,!(cannon_es_performance.now()-u>1e3*o)););this.accumulator=this.accumulator%o;const _=this.accumulator/o;for(let A=0;A!==this.bodies.length;A++){const w=this.bodies[A];w.previousPosition.lerp(w.position,_,w.interpolatedPosition),w.previousQuaternion.slerp(w.quaternion,_,w.interpolatedQuaternion),w.previousQuaternion.normalize()}this.time+=l}}internalStep(o){this.dt=o;const l=this.contacts,c=World_step_p1,u=World_step_p2,h=this.bodies.length,_=this.bodies,A=this.solver,w=this.gravity,C=this.doProfiling,M=this.profile,O=Body.DYNAMIC;let ne=-1/0;const ce=this.constraints,ue=World_step_frictionEquationPool;w.length();const ye=w.x,Oe=w.y,ke=w.z;let Ve=0;for(C&&(ne=cannon_es_performance.now()),Ve=0;Ve!==h;Ve++){const Pt=_[Ve];if(Pt.type===O){const Lt=Pt.force,Bt=Pt.mass;Lt.x+=Bt*ye,Lt.y+=Bt*Oe,Lt.z+=Bt*ke}}for(let Pt=0,Lt=this.subsystems.length;Pt!==Lt;Pt++)this.subsystems[Pt].update();C&&(ne=cannon_es_performance.now()),c.length=0,u.length=0,this.broadphase.collisionPairs(this,c,u),C&&(M.broadphase=cannon_es_performance.now()-ne);let tt=ce.length;for(Ve=0;Ve!==tt;Ve++){const Pt=ce[Ve];if(!Pt.collideConnected)for(let Lt=c.length-1;Lt>=0;Lt-=1)(Pt.bodyA===c[Lt]&&Pt.bodyB===u[Lt]||Pt.bodyB===c[Lt]&&Pt.bodyA===u[Lt])&&(c.splice(Lt,1),u.splice(Lt,1))}this.collisionMatrixTick(),C&&(ne=cannon_es_performance.now());const ht=World_step_oldContacts,ut=l.length;for(Ve=0;Ve!==ut;Ve++)ht.push(l[Ve]);l.length=0;const _t=this.frictionEquations.length;for(Ve=0;Ve!==_t;Ve++)ue.push(this.frictionEquations[Ve]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(c,u,this,l,ht,this.frictionEquations,ue),C&&(M.narrowphase=cannon_es_performance.now()-ne),C&&(ne=cannon_es_performance.now()),Ve=0;Ve<this.frictionEquations.length;Ve++)A.addEquation(this.frictionEquations[Ve]);const at=l.length;for(let Pt=0;Pt!==at;Pt++){const Lt=l[Pt],Bt=Lt.bi,Ut=Lt.bj,kt=Lt.si,Vt=Lt.sj;let si;si=Bt.material&&Ut.material&&this.getContactMaterial(Bt.material,Ut.material)||this.defaultContactMaterial,si.friction,Bt.material&&Ut.material&&(Bt.material.friction>=0&&Ut.material.friction>=0&&(Bt.material.friction,Ut.material.friction),Bt.material.restitution>=0&&Ut.material.restitution>=0&&(Lt.restitution=Bt.material.restitution*Ut.material.restitution)),A.addEquation(Lt),Bt.allowSleep&&Bt.type===Body.DYNAMIC&&Bt.sleepState===Body.SLEEPING&&Ut.sleepState===Body.AWAKE&&Ut.type!==Body.STATIC&&Ut.velocity.lengthSquared()+Ut.angularVelocity.lengthSquared()>=2*Ut.sleepSpeedLimit**2&&(Bt.wakeUpAfterNarrowphase=!0),Ut.allowSleep&&Ut.type===Body.DYNAMIC&&Ut.sleepState===Body.SLEEPING&&Bt.sleepState===Body.AWAKE&&Bt.type!==Body.STATIC&&Bt.velocity.lengthSquared()+Bt.angularVelocity.lengthSquared()>=2*Bt.sleepSpeedLimit**2&&(Ut.wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(Bt,Ut,!0),this.collisionMatrixPrevious.get(Bt,Ut)||(World_step_collideEvent.body=Ut,World_step_collideEvent.contact=Lt,Bt.dispatchEvent(World_step_collideEvent),World_step_collideEvent.body=Bt,Ut.dispatchEvent(World_step_collideEvent)),this.bodyOverlapKeeper.set(Bt.id,Ut.id),this.shapeOverlapKeeper.set(kt.id,Vt.id)}for(this.emitContactEvents(),C&&(M.makeContactConstraints=cannon_es_performance.now()-ne,ne=cannon_es_performance.now()),Ve=0;Ve!==h;Ve++){const Pt=_[Ve];Pt.wakeUpAfterNarrowphase&&(Pt.wakeUp(),Pt.wakeUpAfterNarrowphase=!1)}for(tt=ce.length,Ve=0;Ve!==tt;Ve++){const Pt=ce[Ve];Pt.update();for(let Lt=0,Bt=Pt.equations.length;Lt!==Bt;Lt++){const Ut=Pt.equations[Lt];A.addEquation(Ut)}}A.solve(o,this),C&&(M.solve=cannon_es_performance.now()-ne),A.removeAllEquations();const lt=Math.pow;for(Ve=0;Ve!==h;Ve++){const Pt=_[Ve];if(Pt.type&O){const Lt=lt(1-Pt.linearDamping,o),Bt=Pt.velocity;Bt.scale(Lt,Bt);const Ut=Pt.angularVelocity;if(Ut){const kt=lt(1-Pt.angularDamping,o);Ut.scale(kt,Ut)}}}this.dispatchEvent(World_step_preStepEvent),C&&(ne=cannon_es_performance.now());const pt=this.stepnumber%(this.quatNormalizeSkip+1)==0,xt=this.quatNormalizeFast;for(Ve=0;Ve!==h;Ve++)_[Ve].integrate(o,pt,xt);this.clearForces(),this.broadphase.dirty=!0,C&&(M.integrate=cannon_es_performance.now()-ne),this.stepnumber+=1,this.dispatchEvent(World_step_postStepEvent);let Tt=!0;if(this.allowSleep)for(Tt=!1,Ve=0;Ve!==h;Ve++){const Pt=_[Ve];Pt.sleepTick(this.time),Pt.sleepState!==Body.SLEEPING&&(Tt=!0)}this.hasActiveBodies=Tt}emitContactEvents(){const o=this.hasAnyEventListener("beginContact"),l=this.hasAnyEventListener("endContact");if((o||l)&&this.bodyOverlapKeeper.getDiff(additions,removals),o){for(let h=0,_=additions.length;h<_;h+=2)beginContactEvent.bodyA=this.getBodyById(additions[h]),beginContactEvent.bodyB=this.getBodyById(additions[h+1]),this.dispatchEvent(beginContactEvent);beginContactEvent.bodyA=beginContactEvent.bodyB=null}if(l){for(let h=0,_=removals.length;h<_;h+=2)endContactEvent.bodyA=this.getBodyById(removals[h]),endContactEvent.bodyB=this.getBodyById(removals[h+1]),this.dispatchEvent(endContactEvent);endContactEvent.bodyA=endContactEvent.bodyB=null}additions.length=removals.length=0;const c=this.hasAnyEventListener("beginShapeContact"),u=this.hasAnyEventListener("endShapeContact");if((c||u)&&this.shapeOverlapKeeper.getDiff(additions,removals),c){for(let h=0,_=additions.length;h<_;h+=2){const A=this.getShapeById(additions[h]),w=this.getShapeById(additions[h+1]);beginShapeContactEvent.shapeA=A,beginShapeContactEvent.shapeB=w,A&&(beginShapeContactEvent.bodyA=A.body),w&&(beginShapeContactEvent.bodyB=w.body),this.dispatchEvent(beginShapeContactEvent)}beginShapeContactEvent.bodyA=beginShapeContactEvent.bodyB=beginShapeContactEvent.shapeA=beginShapeContactEvent.shapeB=null}if(u){for(let h=0,_=removals.length;h<_;h+=2){const A=this.getShapeById(removals[h]),w=this.getShapeById(removals[h+1]);endShapeContactEvent.shapeA=A,endShapeContactEvent.shapeB=w,A&&(endShapeContactEvent.bodyA=A.body),w&&(endShapeContactEvent.bodyB=w.body),this.dispatchEvent(endShapeContactEvent)}endShapeContactEvent.bodyA=endShapeContactEvent.bodyB=endShapeContactEvent.shapeA=endShapeContactEvent.shapeB=null}}clearForces(){const o=this.bodies,l=o.length;for(let c=0;c!==l;c++){const u=o[c];u.force,u.torque,u.force.set(0,0,0),u.torque.set(0,0,0)}}}new AABB;const tmpRay=new Ray,cannon_es_performance=globalThis.performance||{};if(!cannon_es_performance.now){let d=Date.now();cannon_es_performance.timing&&cannon_es_performance.timing.navigationStart&&(d=cannon_es_performance.timing.navigationStart),cannon_es_performance.now=()=>Date.now()-d}new Vec3;const World_step_postStepEvent={type:"postStep"},World_step_preStepEvent={type:"preStep"},World_step_collideEvent={type:Body.COLLIDE_EVENT_NAME,body:null,contact:null},World_step_oldContacts=[],World_step_frictionEquationPool=[],World_step_p1=[],World_step_p2=[],additions=[],removals=[],beginContactEvent={type:"beginContact",bodyA:null,bodyB:null},endContactEvent={type:"endContact",bodyA:null,bodyB:null},beginShapeContactEvent={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},endShapeContactEvent={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null};var ConvexHull=function(){var d,o,l,c=new three_module.Pq0;function u(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new w,this.unassigned=new w,this.vertices=[]}function h(){this.normal=new three_module.Pq0,this.midpoint=new three_module.Pq0,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}function _(C,M){this.vertex=C,this.prev=null,this.next=null,this.twin=null,this.face=M}function A(C,M){this.point=C,this.index=M,this.prev=null,this.next=null,this.face=null}function w(){this.head=null,this.tail=null}return Object.assign(u.prototype,{toJSON:function(){const C=this.faces.map(ue=>ue.toArray()),M=Array.from(new Set(C.flat())).sort(),O=[];for(let ue=0;ue<M.length;ue++)O.push(this.vertices[M[ue]].point.x,this.vertices[M[ue]].point.y,this.vertices[M[ue]].point.z);const ne=new Map;for(let ue=0;ue<M.length;ue++)ne.set(M[ue],ue);const ce=[];for(let ue=0;ue<C.length;ue++)ce.push([ne.get(C[ue][0]),ne.get(C[ue][1]),ne.get(C[ue][2])]);return[O,ce]},setFromPoints:function(C){Array.isArray(C)!==!0&&console.error("THREE.ConvexHull: Points parameter is not an array."),C.length<4&&console.error("THREE.ConvexHull: The algorithm needs at least four points."),this.makeEmpty();for(var M=0,O=C.length;M<O;M++)this.vertices.push(new A(C[M],M));return this.compute(),this},setFromObject:function(C){var M=[];return C.updateMatrixWorld(!0),C.traverse(function(O){var ne,ce,ue,ye=O.geometry;if(ye!==void 0&&(ye.isGeometry&&(ye=ye.toBufferGeometry?ye.toBufferGeometry():new BufferGeometry().fromGeometry(ye)),ye.isBufferGeometry)){var Oe=ye.attributes.position;if(Oe!==void 0)for(ne=0,ce=Oe.count;ne<ce;ne++)(ue=new three_module.Pq0).fromBufferAttribute(Oe,ne).applyMatrix4(O.matrixWorld),M.push(ue)}}),this.setFromPoints(M)},containsPoint:function(C){for(var M=this.faces,O=0,ne=M.length;O<ne;O++)if(M[O].distanceToPoint(C)>this.tolerance)return!1;return!0},intersectRay:function(C,M){for(var O=this.faces,ne=-1/0,ce=1/0,ue=0,ye=O.length;ue<ye;ue++){var Oe=O[ue],ke=Oe.distanceToPoint(C.origin),Ve=Oe.normal.dot(C.direction);if(ke>0&&Ve>=0)return null;var tt=Ve!==0?-ke/Ve:0;if(!(tt<=0)&&(Ve>0?ce=Math.min(tt,ce):ne=Math.max(tt,ne),ne>ce))return null}return ne!==-1/0?C.at(ne,M):C.at(ce,M),M},intersectsRay:function(C){return this.intersectRay(C,c)!==null},makeEmpty:function(){return this.faces=[],this.vertices=[],this},addVertexToFace:function(C,M){return C.face=M,M.outside===null?this.assigned.append(C):this.assigned.insertBefore(M.outside,C),M.outside=C,this},removeVertexFromFace:function(C,M){return C===M.outside&&(C.next!==null&&C.next.face===M?M.outside=C.next:M.outside=null),this.assigned.remove(C),this},removeAllVerticesFromFace:function(C){if(C.outside!==null){for(var M=C.outside,O=C.outside;O.next!==null&&O.next.face===C;)O=O.next;return this.assigned.removeSubList(M,O),M.prev=O.next=null,C.outside=null,M}},deleteFaceVertices:function(C,M){var O=this.removeAllVerticesFromFace(C);if(O!==void 0)if(M===void 0)this.unassigned.appendChain(O);else{var ne=O;do{var ce=ne.next;M.distanceToPoint(ne.point)>this.tolerance?this.addVertexToFace(ne,M):this.unassigned.append(ne),ne=ce}while(ne!==null)}return this},resolveUnassignedPoints:function(C){if(this.unassigned.isEmpty()===!1){var M=this.unassigned.first();do{for(var O=M.next,ne=this.tolerance,ce=null,ue=0;ue<C.length;ue++){var ye=C[ue];if(ye.mark===0){var Oe=ye.distanceToPoint(M.point);if(Oe>ne&&(ne=Oe,ce=ye),ne>1e3*this.tolerance)break}}ce!==null&&this.addVertexToFace(M,ce),M=O}while(M!==null)}return this},computeExtremes:function(){var C,M,O,ne=new three_module.Pq0,ce=new three_module.Pq0,ue=[],ye=[];for(C=0;C<3;C++)ue[C]=ye[C]=this.vertices[0];for(ne.copy(this.vertices[0].point),ce.copy(this.vertices[0].point),C=0,M=this.vertices.length;C<M;C++){var Oe=this.vertices[C],ke=Oe.point;for(O=0;O<3;O++)ke.getComponent(O)<ne.getComponent(O)&&(ne.setComponent(O,ke.getComponent(O)),ue[O]=Oe);for(O=0;O<3;O++)ke.getComponent(O)>ce.getComponent(O)&&(ce.setComponent(O,ke.getComponent(O)),ye[O]=Oe)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(ne.x),Math.abs(ce.x))+Math.max(Math.abs(ne.y),Math.abs(ce.y))+Math.max(Math.abs(ne.z),Math.abs(ce.z))),{min:ue,max:ye}},computeInitialHull:function(){d===void 0&&(d=new three_module.cZY,o=new three_module.Zcv,l=new three_module.Pq0);var C,M,O,ne,ce,ue,ye,Oe,ke,Ve=this.vertices,tt=this.computeExtremes(),ht=tt.min,ut=tt.max,_t=0,at=0;for(ue=0;ue<3;ue++)(ke=ut[ue].point.getComponent(ue)-ht[ue].point.getComponent(ue))>_t&&(_t=ke,at=ue);for(M=ht[at],O=ut[at],_t=0,d.set(M.point,O.point),ue=0,ye=this.vertices.length;ue<ye;ue++)(C=Ve[ue])!==M&&C!==O&&(d.closestPointToPoint(C.point,!0,l),(ke=l.distanceToSquared(C.point))>_t&&(_t=ke,ne=C));for(_t=-1,o.setFromCoplanarPoints(M.point,O.point,ne.point),ue=0,ye=this.vertices.length;ue<ye;ue++)(C=Ve[ue])!==M&&C!==O&&C!==ne&&(ke=Math.abs(o.distanceToPoint(C.point)))>_t&&(_t=ke,ce=C);var lt=[];if(o.distanceToPoint(ce.point)<0)for(lt.push(h.create(M,O,ne),h.create(ce,O,M),h.create(ce,ne,O),h.create(ce,M,ne)),ue=0;ue<3;ue++)Oe=(ue+1)%3,lt[ue+1].getEdge(2).setTwin(lt[0].getEdge(Oe)),lt[ue+1].getEdge(1).setTwin(lt[Oe+1].getEdge(0));else for(lt.push(h.create(M,ne,O),h.create(ce,M,O),h.create(ce,O,ne),h.create(ce,ne,M)),ue=0;ue<3;ue++)Oe=(ue+1)%3,lt[ue+1].getEdge(2).setTwin(lt[0].getEdge((3-ue)%3)),lt[ue+1].getEdge(0).setTwin(lt[Oe+1].getEdge(1));for(ue=0;ue<4;ue++)this.faces.push(lt[ue]);for(ue=0,ye=Ve.length;ue<ye;ue++)if((C=Ve[ue])!==M&&C!==O&&C!==ne&&C!==ce){_t=this.tolerance;var pt=null;for(Oe=0;Oe<4;Oe++)(ke=this.faces[Oe].distanceToPoint(C.point))>_t&&(_t=ke,pt=this.faces[Oe]);pt!==null&&this.addVertexToFace(C,pt)}return this},reindexFaces:function(){for(var C=[],M=0;M<this.faces.length;M++){var O=this.faces[M];O.mark===0&&C.push(O)}return this.faces=C,this},nextVertexToAdd:function(){if(this.assigned.isEmpty()===!1){var C,M=0,O=this.assigned.first().face,ne=O.outside;do{var ce=O.distanceToPoint(ne.point);ce>M&&(M=ce,C=ne),ne=ne.next}while(ne!==null&&ne.face===O);return C}},computeHorizon:function(C,M,O,ne){var ce;this.deleteFaceVertices(O),O.mark=1,ce=M===null?M=O.getEdge(0):M.next;do{var ue=ce.twin,ye=ue.face;ye.mark===0&&(ye.distanceToPoint(C)>this.tolerance?this.computeHorizon(C,ue,ye,ne):ne.push(ce)),ce=ce.next}while(ce!==M);return this},addAdjoiningFace:function(C,M){var O=h.create(C,M.tail(),M.head());return this.faces.push(O),O.getEdge(-1).setTwin(M.twin),O.getEdge(0)},addNewFaces:function(C,M){this.newFaces=[];for(var O=null,ne=null,ce=0;ce<M.length;ce++){var ue=M[ce],ye=this.addAdjoiningFace(C,ue);O===null?O=ye:ye.next.setTwin(ne),this.newFaces.push(ye.face),ne=ye}return O.next.setTwin(ne),this},addVertexToHull:function(C){var M=[];return this.unassigned.clear(),this.removeVertexFromFace(C,C.face),this.computeHorizon(C.point,null,C.face,M),this.addNewFaces(C,M),this.resolveUnassignedPoints(this.newFaces),this},cleanup:function(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this},compute:function(){var C;for(this.computeInitialHull();(C=this.nextVertexToAdd())!==void 0;)this.addVertexToHull(C);return this.reindexFaces(),this.cleanup(),this}}),Object.assign(h,{create:function(C,M,O){var ne=new h,ce=new _(C,ne),ue=new _(M,ne),ye=new _(O,ne);return ce.next=ye.prev=ue,ue.next=ce.prev=ye,ye.next=ue.prev=ce,ne.edge=ce,ne.compute()}}),Object.assign(h.prototype,{toArray:function(){const C=[];let M=this.edge;do C.push(M.head().index),M=M.next;while(M!==this.edge);return C},getEdge:function(C){for(var M=this.edge;C>0;)M=M.next,C--;for(;C<0;)M=M.prev,C++;return M},compute:function(){var C;return function(){C===void 0&&(C=new three_module.lMl);var M=this.edge.tail(),O=this.edge.head(),ne=this.edge.next.head();return C.set(M.point,O.point,ne.point),C.getNormal(this.normal),C.getMidpoint(this.midpoint),this.area=C.getArea(),this.constant=this.normal.dot(this.midpoint),this}}(),distanceToPoint:function(C){return this.normal.dot(C)-this.constant}}),Object.assign(_.prototype,{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var C=this.head(),M=this.tail();return M!==null?M.point.distanceTo(C.point):-1},lengthSquared:function(){var C=this.head(),M=this.tail();return M!==null?M.point.distanceToSquared(C.point):-1},setTwin:function(C){return this.twin=C,C.twin=this,this}}),Object.assign(w.prototype,{first:function(){return this.head},last:function(){return this.tail},clear:function(){return this.head=this.tail=null,this},insertBefore:function(C,M){return M.prev=C.prev,M.next=C,M.prev===null?this.head=M:M.prev.next=M,C.prev=M,this},insertAfter:function(C,M){return M.prev=C,M.next=C.next,M.next===null?this.tail=M:M.next.prev=M,C.next=M,this},append:function(C){return this.head===null?this.head=C:this.tail.next=C,C.prev=this.tail,C.next=null,this.tail=C,this},appendChain:function(C){for(this.head===null?this.head=C:this.tail.next=C,C.prev=this.tail;C.next!==null;)C=C.next;return this.tail=C,this},remove:function(C){return C.prev===null?this.head=C.next:C.prev.next=C.next,C.next===null?this.tail=C.prev:C.next.prev=C.prev,this},removeSubList:function(C,M){return C.prev===null?this.head=M.next:C.prev.next=M.next,M.next===null?this.tail=C.prev:M.next.prev=C.prev,this},isEmpty:function(){return this.head===null}}),u}();const three_to_cannon_modern_v1=new three_module.Pq0,_v2=new three_module.Pq0,three_to_cannon_modern_q1=new three_module.PTz;function getGeometry(d){const o=getMeshes(d);if(o.length===0)return null;if(o.length===1)return normalizeGeometry(o[0]);let l;const c=[];for(;l=o.pop();)c.push(simplifyGeometry(normalizeGeometry(l)));return three_to_cannon_modern_mergeBufferGeometries(c)}function normalizeGeometry(d){let o=d.geometry;return o=o.toBufferGeometry?o.toBufferGeometry():o.clone(),d.updateMatrixWorld(),d.matrixWorld.decompose(three_to_cannon_modern_v1,three_to_cannon_modern_q1,_v2),o.scale(_v2.x,_v2.y,_v2.z),o}function three_to_cannon_modern_mergeBufferGeometries(d){let o=0;for(let u=0;u<d.length;u++){const h=d[u].attributes.position;h&&h.itemSize===3&&(o+=h.count)}const l=new Float32Array(3*o);let c=0;for(let u=0;u<d.length;u++){const h=d[u].attributes.position;if(h&&h.itemSize===3)for(let _=0;_<h.count;_++)l[c++]=h.getX(_),l[c++]=h.getY(_),l[c++]=h.getZ(_)}return new three_module.LoY().setAttribute("position",new three_module.THS(l,3))}function getVertices(d){const o=d.attributes.position,l=new Float32Array(3*o.count);for(let c=0;c<o.count;c++)l[3*c]=o.getX(c),l[3*c+1]=o.getY(c),l[3*c+2]=o.getZ(c);return l}function getMeshes(d){const o=[];return d.traverse(function(l){l.isMesh&&o.push(l)}),o}function getComponent(d,o){switch(o){case"x":return d.x;case"y":return d.y;case"z":return d.z}throw new Error(`Unexpected component ${o}`)}function simplifyGeometry(d,o=1e-4){o=Math.max(o,Number.EPSILON);const l={},c=d.getIndex(),u=d.getAttribute("position"),h=c?c.count:u.count;let _=0;const A=[],w=[],C=Math.log10(1/o),M=Math.pow(10,C);for(let ce=0;ce<h;ce++){const ue=c?c.getX(ce):ce;let ye="";ye+=~~(u.getX(ue)*M)+",",ye+=~~(u.getY(ue)*M)+",",ye+=~~(u.getZ(ue)*M)+",",ye in l?A.push(l[ye]):(w.push(u.getX(ue)),w.push(u.getY(ue)),w.push(u.getZ(ue)),l[ye]=_,A.push(_),_++)}const O=new three_module.THS(new Float32Array(w),u.itemSize,u.normalized),ne=new three_module.LoY;return ne.setAttribute("position",O),ne.setIndex(A),ne}const PI_2=Math.PI/2;var ShapeType;(function(d){d.BOX="Box",d.CYLINDER="Cylinder",d.SPHERE="Sphere",d.HULL="ConvexPolyhedron",d.MESH="Trimesh"})(ShapeType||(ShapeType={}));const getShapeParameters=function(d,o={}){let l;if(o.type===ShapeType.BOX)return getBoundingBoxParameters(d);if(o.type===ShapeType.CYLINDER)return getBoundingCylinderParameters(d,o);if(o.type===ShapeType.SPHERE)return getBoundingSphereParameters(d,o);if(o.type===ShapeType.HULL)return getConvexPolyhedronParameters(d);if(o.type===ShapeType.MESH)return l=getGeometry(d),l?getTrimeshParameters(l):null;if(o.type)throw new Error(`[CANNON.getShapeParameters] Invalid type "${o.type}".`);if(l=getGeometry(d),!l)return null;switch(l.type){case"BoxGeometry":case"BoxBufferGeometry":return getBoxParameters(l);case"CylinderGeometry":case"CylinderBufferGeometry":return getCylinderParameters(l);case"PlaneGeometry":case"PlaneBufferGeometry":return getPlaneParameters(l);case"SphereGeometry":case"SphereBufferGeometry":return getSphereParameters(l);case"TubeGeometry":case"BufferGeometry":return getBoundingBoxParameters(d);default:return console.warn('Unrecognized geometry: "%s". Using bounding box as shape.',l.type),getBoxParameters(l)}},threeToCannon=function(d,o={}){const l=getShapeParameters(d,o);if(!l)return null;const{type:c,params:u,offset:h,orientation:_}=l;let A;return A=c===ShapeType.BOX?createBox(u):c===ShapeType.CYLINDER?createCylinder(u):c===ShapeType.SPHERE?createSphere(u):c===ShapeType.HULL?createConvexPolyhedron(u):createTrimesh(u),{shape:A,offset:h,orientation:_}};function createBox(d){const{x:o,y:l,z:c}=d;return new Box(new Vec3(o,l,c))}function createCylinder(d){const{radiusTop:o,radiusBottom:l,height:c,segments:u}=d,h=new Cylinder(o,l,c,u);return h.radiusTop=l,h.radiusBottom=l,h.height=c,h.numSegments=u,h}function createSphere(d){return new Sphere(d.radius)}function createConvexPolyhedron(d){const{faces:o,vertices:l}=d,c=[];for(let u=0;u<l.length;u+=3)c.push(new Vec3(l[u],l[u+1],l[u+2]));return new ConvexPolyhedron({faces:o,vertices:c})}function createTrimesh(d){const{vertices:o,indices:l}=d;return new Trimesh(o,l)}function getBoxParameters(d){if(!getVertices(d).length)return null;d.computeBoundingBox();const o=d.boundingBox;return{type:ShapeType.BOX,params:{x:(o.max.x-o.min.x)/2,y:(o.max.y-o.min.y)/2,z:(o.max.z-o.min.z)/2}}}function getBoundingBoxParameters(d){const o=d.clone();o.quaternion.set(0,0,0,1),o.updateMatrixWorld();const l=new three_module.NRn().setFromObject(o);if(!isFinite(l.min.lengthSq()))return null;const c=l.translate(o.position.negate()).getCenter(new three_module.Pq0);return{type:ShapeType.BOX,params:{x:(l.max.x-l.min.x)/2,y:(l.max.y-l.min.y)/2,z:(l.max.z-l.min.z)/2},offset:c.lengthSq()?new Vec3(c.x,c.y,c.z):void 0}}function getConvexPolyhedronParameters(d){const o=getGeometry(d);if(!o)return null;const l=1e-4;for(let h=0;h<o.attributes.position.count;h++)o.attributes.position.setXYZ(h,o.attributes.position.getX(h)+(Math.random()-.5)*l,o.attributes.position.getY(h)+(Math.random()-.5)*l,o.attributes.position.getZ(h)+(Math.random()-.5)*l);const[c,u]=new ConvexHull().setFromObject(new three_module.eaF(o)).toJSON();return{type:ShapeType.HULL,params:{vertices:new Float32Array(c),faces:u}}}function getCylinderParameters(d){const o=d.parameters;return{type:ShapeType.CYLINDER,params:{radiusTop:o.radiusTop,radiusBottom:o.radiusBottom,height:o.height,segments:o.radialSegments},orientation:new Quaternion().setFromEuler(three_module.cj9.degToRad(-90),0,0,"XYZ").normalize()}}function getBoundingCylinderParameters(d,o){const l=["x","y","z"],c=o.cylinderAxis||"y",u=l.splice(l.indexOf(c),1)&&l,h=new three_module.NRn().setFromObject(d);if(!isFinite(h.min.lengthSq()))return null;const _=h.max[c]-h.min[c],A=.5*Math.max(getComponent(h.max,u[0])-getComponent(h.min,u[0]),getComponent(h.max,u[1])-getComponent(h.min,u[1])),w=c==="y"?PI_2:0,C=c==="z"?PI_2:0;return{type:ShapeType.CYLINDER,params:{radiusTop:A,radiusBottom:A,height:_,segments:12},orientation:new Quaternion().setFromEuler(w,C,0,"XYZ").normalize()}}function getPlaneParameters(d){d.computeBoundingBox();const o=d.boundingBox;return{type:ShapeType.BOX,params:{x:(o.max.x-o.min.x)/2||.1,y:(o.max.y-o.min.y)/2||.1,z:(o.max.z-o.min.z)/2||.1}}}function getSphereParameters(d){return{type:ShapeType.SPHERE,params:{radius:d.parameters.radius}}}function getBoundingSphereParameters(d,o){if(o.sphereRadius)return{type:ShapeType.SPHERE,params:{radius:o.sphereRadius}};const l=getGeometry(d);return l?(l.computeBoundingSphere(),{type:ShapeType.SPHERE,params:{radius:l.boundingSphere.radius}}):null}function getTrimeshParameters(d){const o=getVertices(d);if(!o.length)return null;const l=new Uint32Array(o.length);for(let c=0;c<o.length;c++)l[c]=c;return{type:ShapeType.MESH,params:{vertices:o,indices:l}}}var CannonPhysicsPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},CannonPhysicsPlugin_1;let CannonPhysicsPlugin=CannonPhysicsPlugin_1=class extends AViewerPlugin{constructor(d=!1){super(),this._world=new World,this.enabled=!0,this.nextSteps=0,this.stepPhysics={stepCount:100,delta:.1,step:()=>{this.nextSteps=this.stepPhysics.stepCount}},this.makeRootBodies=()=>{var u;(u=this._viewer)===null||u===void 0||u.scene.modelRoot.children.forEach(h=>{this.makeBody(h)})},this._bodyMeshMap=new Map,this._movementPlane=new three_module.eaF(new three_module.bdM(100,100),new three_module.V9B({color:65280,side:three_module.$EB})),this.enabled=d,this._world.gravity.set(0,-9.81,0);const o=new cannon_es_Plane,l=new Body({mass:0,position:new Vec3(0,-2,0)});l.addShape(o),l.quaternion.setFromEuler(-Math.PI/2,0,0),this._ground=l,this._world.addBody(l);const c=new Sphere(.1);this._jointBody=new Body({mass:0}),this._jointBody.addShape(c),this._jointBody.collisionFilterGroup=0,this._jointBody.collisionFilterMask=0,this._world.addBody(this._jointBody)}async onAdded(d){await super.onAdded(d);const o=new three_module.Pq0,l=new three_module.Pq0,c=new three_module.Pq0,u=new three_module.PTz,h=new three_module.PTz,_=new three_module.kn4,A=new three_module.kn4;let w=!1,C=!1;function M(O){const ne=d.canvas.getBoundingClientRect(),ce=new three_module.I9Y;return ce.x=(O.clientX-ne.x)/ne.width*2-1,ce.y=-(O.clientY-ne.y)/ne.height*2+1,ce}d.addEventListener("preFrame",()=>{const O=d.getPlugin(GroundPlugin),ne=d.getPlugin(FrameFadePlugin);if(!this.enabled){if(!(this.nextSteps>0))return O&&w&&(O.enableRefreshTransform=!0,w=!1),ne&&C&&(ne.enable(CannonPhysicsPlugin_1.PluginType),C=!1),void(this._dirty=!1);this.enabled=!0}if(O&&O.enableRefreshTransform&&!w&&(O.enableRefreshTransform=!1,w=!0),ne&&!C&&ne.disable(CannonPhysicsPlugin_1.PluginType),this.nextSteps>0)for(let ue=0;ue<this.stepPhysics.stepCount;ue++)this._world.step(this.stepPhysics.delta);else this._world.fixedStep();this._dirty=!1;let ce=!1;for(const ue of this._world.bodies){if(ue.mass===0)continue;const ye=this._bodyMeshMap.get(ue);if(ye&&(ye.updateMatrixWorld(),ye.getWorldPosition(l),ye.getWorldQuaternion(h),ye.getWorldScale(c),l.manhattanDistanceTo(o.copy(ue.position))>0&&(ce=!0),h.angleTo(u.copy(ue.quaternion))>0&&(ce=!0),ce)){if(_.compose(o,u,c),!ye.parent)throw new Error("no parent");A.copy(ye.parent.matrixWorld).invert(),A.multiply(_),A.decompose(o,u,c),ye.position.copy(o),ye.quaternion.copy(u)}}this._dirty=ce,d.setDirty(),d.renderer.resetShadows(),O==null||O.bakeShadows(),this.nextSteps>0&&(this.enabled=!1,this.nextSteps=0)}),d.scene.addEventListener("update",O=>{this._bodyMeshMap.forEach((ne,ce)=>{ce.velocity.set(0,0,0),ce.angularVelocity.set(0,0,0)})}),d.scene.addEventListener("addSceneObject",O=>{var ne;const ce=(ne=O.object)===null||ne===void 0?void 0:ne.modelObject;ce&&ce.traverse(ue=>{const ye=ue.uiConfig;ye&&Array.isArray(ye.children)&&!ue.isWidget&&(ye.children.push({type:"folder",label:"Physics",children:[{type:"button",label:"Make Body",value:()=>this.makeBody(ue)},{type:"number",label:"Mass",hidden:()=>!ue._physicsBody,getValue:()=>{var Oe,ke;return(ke=(Oe=ue._physicsBody)===null||Oe===void 0?void 0:Oe.mass)!==null&&ke!==void 0?ke:0},setValue:Oe=>{ue._physicsBody&&(ue._physicsBody.mass=Oe)}}]}),ue.userData.physicsMass!==void 0&&this.makeBody(ue))})}),d.canvas.addEventListener("pointerdown",O=>{if(!this.enabled||!O.isPrimary)return;d.getPlugin(PickingPlugin)&&(d.getPlugin(PickingPlugin).enabled=!1);const ne=M(O),ce=new three_module.tBo;ce.setFromCamera(ne,d.scene.activeCamera.cameraObject);const ue=ce.intersectObjects([...this._bodyMeshMap.values()],!0);if(!ue.length)return;let ye,Oe=null,ke=ue[0];for(const ht of ue){for(Oe=ht.object,ke=ht;!(Oe==null||Oe.visible&&Oe.material);)Oe=Oe.parent;if(Oe)break}if(!Oe)return;for(;Oe.parent&&!ye;){for(const[ht,ut]of this._bodyMeshMap.entries())if(ut===Oe){ht.mass>0&&(ye=ht);break}Oe=Oe.parent}if(!ye)return;d.scene.activeCamera.setInteractions(!1,CannonPhysicsPlugin_1.PluginType),this._movementPlane.position.copy(ke.point),this._movementPlane.lookAt(d.scene.activeCamera.cameraObject.getWorldPosition(new three_module.Pq0));const Ve=new Vec3().copy(ke.point).vsub(ye.position),tt=ye.quaternion.inverse().vmult(Ve);this._jointBody.position.copy(ke.point),this._jointConstraint=new PointToPointConstraint(ye,tt,this._jointBody,new Vec3(0,0,0)),this._world.addConstraint(this._jointConstraint)}),d.canvas.addEventListener("pointermove",O=>{if(!this.enabled||!O.isPrimary||!this._jointConstraint)return;const ne=M(O),ce=new three_module.tBo;ce.setFromCamera(ne,d.scene.activeCamera.cameraObject);const ue=ce.intersectObject(this._movementPlane);if(!ue.length)return;const ye=ue[0];this._jointBody.position.copy(ye.point),this._jointConstraint.update()}),d.canvas.addEventListener("pointerup",O=>{this.enabled&&O.isPrimary&&(d.getPlugin(PickingPlugin)&&(d.getPlugin(PickingPlugin).enabled=!0),d.scene.activeCamera.setInteractions(!0,CannonPhysicsPlugin_1.PluginType),this._jointConstraint&&(this._world.removeConstraint(this._jointConstraint),this._jointConstraint=void 0))})}makeBody(d){if(d.isLight||d._physicsBody)return;const o=[];let l=0;if(d.updateMatrixWorld(),d.traverse(w=>{var C;const M=w;if(!M.isMesh||!M.material||!M.visible)return;if(M._physicsShape)return void o.push(M._physicsShape);if(l+=(C=M.userData.physicsMass)!==null&&C!==void 0?C:1,M.addEventListener("objectUpdate",()=>{M.userData.physicsMass===0&&(this._ground.position.y=M.position.y,this._bodyMeshMap.forEach((ne,ce)=>{ce.velocity.set(0,0,0),ce.angularVelocity.set(0,0,0),ce.force.set(0,0,0),ce.torque.set(0,0,0)}))}),M.userData.physicsMass===0)return;const O=threeToCannon(M,{type:ShapeType.HULL});O?(o.push([O.shape,M]),M._physicsShape=O.shape):console.warn("Failed to convert mesh to cannon shape",M)}),!o.length)return;const c=new Body({mass:l,angularVelocity:new Vec3(0,0,0),velocity:new Vec3(0,0,0)}),u=new three_module.Pq0,h=new three_module.PTz,_=new three_module.Pq0,A=new three_module.kn4;for(const[w,C]of o)C!==d?(C.updateMatrixWorld(),A.copy(d.matrixWorld).invert(),A.multiply(C.matrixWorld),A.decompose(u,h,_),c.addShape(w,new Vec3(...u.toArray()),new Quaternion(...h.toArray()))):c.addShape(w);c.position.set(...d.getWorldPosition(u).toArray()),c.quaternion.set(...d.getWorldQuaternion(h).toArray()),c.angularVelocity.set(0,0,0),c.velocity.set(0,0,0),d.addEventListener("objectUpdate",()=>{c.position.set(...d.getWorldPosition(u).toArray()),c.quaternion.set(...d.getWorldQuaternion(h).toArray()),c.angularVelocity.set(0,0,0),c.velocity.set(0,0,0)}),this._world.addBody(c),this._bodyMeshMap.set(c,d),d._physicsBody=c,d.setDirty({sceneUpdate:!0,updateGround:!1,frameFade:!1,refreshUi:!0})}};CannonPhysicsPlugin.PluginType="CannonPhysics",CannonPhysicsPlugin_decorate([uiToggle("Enabled",d=>({onChange:()=>{}})),serialize()],CannonPhysicsPlugin.prototype,"enabled",void 0),CannonPhysicsPlugin_decorate([uiConfig()],CannonPhysicsPlugin.prototype,"stepPhysics",void 0),CannonPhysicsPlugin_decorate([uiButton("Make Root Bodies")],CannonPhysicsPlugin.prototype,"makeRootBodies",void 0),CannonPhysicsPlugin=CannonPhysicsPlugin_1=CannonPhysicsPlugin_decorate([uiFolder("Physics (dev)")],CannonPhysicsPlugin);class SimplexNoise{constructor(o=Math){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(let l=0;l<256;l++)this.p[l]=Math.floor(256*o.random());this.perm=[];for(let l=0;l<512;l++)this.perm[l]=this.p[255&l];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(o,l,c){return o[0]*l+o[1]*c}dot3(o,l,c,u){return o[0]*l+o[1]*c+o[2]*u}dot4(o,l,c,u,h){return o[0]*l+o[1]*c+o[2]*u+o[3]*h}noise(o,l){let c,u,h;const _=(o+l)*(.5*(Math.sqrt(3)-1)),A=Math.floor(o+_),w=Math.floor(l+_),C=(3-Math.sqrt(3))/6,M=(A+w)*C,O=o-(A-M),ne=l-(w-M);let ce,ue;O>ne?(ce=1,ue=0):(ce=0,ue=1);const ye=O-ce+C,Oe=ne-ue+C,ke=O-1+2*C,Ve=ne-1+2*C,tt=255&A,ht=255&w,ut=this.perm[tt+this.perm[ht]]%12,_t=this.perm[tt+ce+this.perm[ht+ue]]%12,at=this.perm[tt+1+this.perm[ht+1]]%12;let lt=.5-O*O-ne*ne;lt<0?c=0:(lt*=lt,c=lt*lt*this.dot(this.grad3[ut],O,ne));let pt=.5-ye*ye-Oe*Oe;pt<0?u=0:(pt*=pt,u=pt*pt*this.dot(this.grad3[_t],ye,Oe));let xt=.5-ke*ke-Ve*Ve;return xt<0?h=0:(xt*=xt,h=xt*xt*this.dot(this.grad3[at],ke,Ve)),70*(c+u+h)}noise3d(o,l,c){let u,h,_,A;const w=(o+l+c)*.3333333333333333,C=Math.floor(o+w),M=Math.floor(l+w),O=Math.floor(c+w),ne=1/6,ce=(C+M+O)*ne,ue=o-(C-ce),ye=l-(M-ce),Oe=c-(O-ce);let ke,Ve,tt,ht,ut,_t;ue>=ye?ye>=Oe?(ke=1,Ve=0,tt=0,ht=1,ut=1,_t=0):ue>=Oe?(ke=1,Ve=0,tt=0,ht=1,ut=0,_t=1):(ke=0,Ve=0,tt=1,ht=1,ut=0,_t=1):ye<Oe?(ke=0,Ve=0,tt=1,ht=0,ut=1,_t=1):ue<Oe?(ke=0,Ve=1,tt=0,ht=0,ut=1,_t=1):(ke=0,Ve=1,tt=0,ht=1,ut=1,_t=0);const at=ue-ke+ne,lt=ye-Ve+ne,pt=Oe-tt+ne,xt=ue-ht+2*ne,Tt=ye-ut+2*ne,Pt=Oe-_t+2*ne,Lt=ue-1+.5,Bt=ye-1+.5,Ut=Oe-1+.5,kt=255&C,Vt=255&M,si=255&O,Jt=this.perm[kt+this.perm[Vt+this.perm[si]]]%12,Wt=this.perm[kt+ke+this.perm[Vt+Ve+this.perm[si+tt]]]%12,Zt=this.perm[kt+ht+this.perm[Vt+ut+this.perm[si+_t]]]%12,ti=this.perm[kt+1+this.perm[Vt+1+this.perm[si+1]]]%12;let ci=.6-ue*ue-ye*ye-Oe*Oe;ci<0?u=0:(ci*=ci,u=ci*ci*this.dot3(this.grad3[Jt],ue,ye,Oe));let ri=.6-at*at-lt*lt-pt*pt;ri<0?h=0:(ri*=ri,h=ri*ri*this.dot3(this.grad3[Wt],at,lt,pt));let Ct=.6-xt*xt-Tt*Tt-Pt*Pt;Ct<0?_=0:(Ct*=Ct,_=Ct*Ct*this.dot3(this.grad3[Zt],xt,Tt,Pt));let Ht=.6-Lt*Lt-Bt*Bt-Ut*Ut;return Ht<0?A=0:(Ht*=Ht,A=Ht*Ht*this.dot3(this.grad3[ti],Lt,Bt,Ut)),32*(u+h+_+A)}noise4d(o,l,c,u){const h=this.grad4,_=this.simplex,A=this.perm,w=(Math.sqrt(5)-1)/4,C=(5-Math.sqrt(5))/20;let M,O,ne,ce,ue;const ye=(o+l+c+u)*w,Oe=Math.floor(o+ye),ke=Math.floor(l+ye),Ve=Math.floor(c+ye),tt=Math.floor(u+ye),ht=(Oe+ke+Ve+tt)*C,ut=o-(Oe-ht),_t=l-(ke-ht),at=c-(Ve-ht),lt=u-(tt-ht),pt=(ut>_t?32:0)+(ut>at?16:0)+(_t>at?8:0)+(ut>lt?4:0)+(_t>lt?2:0)+(at>lt?1:0),xt=_[pt][0]>=3?1:0,Tt=_[pt][1]>=3?1:0,Pt=_[pt][2]>=3?1:0,Lt=_[pt][3]>=3?1:0,Bt=_[pt][0]>=2?1:0,Ut=_[pt][1]>=2?1:0,kt=_[pt][2]>=2?1:0,Vt=_[pt][3]>=2?1:0,si=_[pt][0]>=1?1:0,Jt=_[pt][1]>=1?1:0,Wt=_[pt][2]>=1?1:0,Zt=_[pt][3]>=1?1:0,ti=ut-xt+C,ci=_t-Tt+C,ri=at-Pt+C,Ct=lt-Lt+C,Ht=ut-Bt+2*C,qt=_t-Ut+2*C,Li=at-kt+2*C,Ui=lt-Vt+2*C,Xi=ut-si+3*C,An=_t-Jt+3*C,Ln=at-Wt+3*C,Nn=lt-Zt+3*C,Kn=ut-1+4*C,_i=_t-1+4*C,Gi=at-1+4*C,sn=lt-1+4*C,jt=255&Oe,Gt=255&ke,li=255&Ve,vi=255&tt,xi=A[jt+A[Gt+A[li+A[vi]]]]%32,mi=A[jt+xt+A[Gt+Tt+A[li+Pt+A[vi+Lt]]]]%32,Ri=A[jt+Bt+A[Gt+Ut+A[li+kt+A[vi+Vt]]]]%32,Zi=A[jt+si+A[Gt+Jt+A[li+Wt+A[vi+Zt]]]]%32,dn=A[jt+1+A[Gt+1+A[li+1+A[vi+1]]]]%32;let hn=.6-ut*ut-_t*_t-at*at-lt*lt;hn<0?M=0:(hn*=hn,M=hn*hn*this.dot4(h[xi],ut,_t,at,lt));let an=.6-ti*ti-ci*ci-ri*ri-Ct*Ct;an<0?O=0:(an*=an,O=an*an*this.dot4(h[mi],ti,ci,ri,Ct));let pn=.6-Ht*Ht-qt*qt-Li*Li-Ui*Ui;pn<0?ne=0:(pn*=pn,ne=pn*pn*this.dot4(h[Ri],Ht,qt,Li,Ui));let Yi=.6-Xi*Xi-An*An-Ln*Ln-Nn*Nn;Yi<0?ce=0:(Yi*=Yi,ce=Yi*Yi*this.dot4(h[Zi],Xi,An,Ln,Nn));let nn=.6-Kn*Kn-_i*_i-Gi*Gi-sn*sn;return nn<0?ue=0:(nn*=nn,ue=nn*nn*this.dot4(h[dn],Kn,_i,Gi,sn)),27*(M+O+ne+ce+ue)}}var WaveGroundPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},WaveGroundPlugin_1;let WaveGroundPlugin=WaveGroundPlugin_1=class extends AViewerPlugin{constructor(){super(),this.enabled=!1,this.noiseScale=1.8,this.amplitude=.5,this.paused=!1,this._preFrame=()=>{var c;this._viewer&&this.enabled&&(this.paused||(this._makeRoughGround(this._planeMesh.geometry,this.noiseScale,this.amplitude),(c=this._viewer)===null||c===void 0||c.setDirty()))},this._noise=new SimplexNoise;const d=new three_module.bdM(1,1,100,100),o=new MeshStandardMaterial2({color:16777215,side:three_module.$EB}),l=new three_module.eaF(d,o);l.receiveShadow=!0,l.rotation.x=-.5*Math.PI,l.position.x=0,l.position.y=-1,l.position.z=0,l.scale.setScalar(10),this._planeMesh=l,this.planeMesh=l}async onAdded(d){await super.onAdded(d),d.addEventListener("preFrame",this._preFrame),this.enabled&&await this.onEnable()}async onEnable(){var d,o;const l=this._viewer;if(!l)return;const c=l.getPluginByType("Ground"),u=l.getPlugin(FrameFadePlugin);if(!this.enabled)return this._planeMesh.visible=!1,u&&u.enable(WaveGroundPlugin_1.PluginType),(d=this._viewer)===null||d===void 0||d.setDirty(),void(c&&c.mesh&&c.setGeometry(void 0));if(u&&u.disable(WaveGroundPlugin_1.PluginType),c&&c.mesh)c.setGeometry(this._planeMesh.geometry),c.material&&(c.material.side=three_module.$EB,c.material.fog=!0),this.planeMesh=c.mesh.modelObject;else{const h=(o=l.scene.getObjectByName("WaveGroundPlugin_root"))!==null&&o!==void 0?o:(await l.createObject3D(void 0,!0)).modelObject;h.name="WaveGroundPlugin_root",h.clear(),this.planeMesh=this._planeMesh,h.add(this.planeMesh)}this.planeMesh.visible=!0}async onRemove(d){return d.removeEventListener("preFrame",this._preFrame),this.planeMesh=this._planeMesh,this._planeMesh.geometry.dispose(),this._planeMesh.removeFromParent(),super.onRemove(d)}_makeRoughGround(d,o=1,l=1){const c=Date.now(),u=30*o,h=.01*l,_=d.attributes.position,A=_.count;for(let w=0;w<A;w++){const C=_.getX(w),M=_.getY(w),O=_.getZ(w),ne=5*this._noise.noise3d(C*u*.1+3e-4*c,M*u*.1+3e-4*c,O*u*.1+3e-4*c)*h+4*this._noise.noise3d(C*u*.2+12e-5*c,M*u*.2+15e-5*c,O*u*.2+15e-5*c)*h+4*this._noise.noise3d(C*u*.09+15e-5*c,M*u*.12+9e-5*c,O*u*.15+15e-5*c)*h;_.setZ(w,ne/3)}_.needsUpdate=!0,d.computeVertexNormals()}};WaveGroundPlugin.PluginType="WaveGroundPlugin",WaveGroundPlugin_decorate([uiToggle(),serialize(),x(WaveGroundPlugin.prototype.onEnable)],WaveGroundPlugin.prototype,"enabled",void 0),WaveGroundPlugin_decorate([uiSlider("Noise scale",[0,2]),serialize()],WaveGroundPlugin.prototype,"noiseScale",void 0),WaveGroundPlugin_decorate([uiSlider("Amplitude",[0,2]),serialize()],WaveGroundPlugin.prototype,"amplitude",void 0),WaveGroundPlugin_decorate([uiToggle("Paused"),serialize()],WaveGroundPlugin.prototype,"paused",void 0),WaveGroundPlugin=WaveGroundPlugin_1=WaveGroundPlugin_decorate([uiFolder("Wave Ground")],WaveGroundPlugin);const Visible=0,Deleted=1,ConvexHull_v1=new three_module.Pq0,_line3=new three_module.cZY,ConvexHull_plane=new three_module.Zcv,ConvexHull_closestPoint=new three_module.Pq0,_triangle=new three_module.lMl;class ConvexHull_ConvexHull{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new VertexList,this.unassigned=new VertexList,this.vertices=[]}setFromPoints(o){if(o.length>=4){this.makeEmpty();for(let l=0,c=o.length;l<c;l++)this.vertices.push(new VertexNode(o[l]));this.compute()}return this}setFromObject(o){const l=[];return o.updateMatrixWorld(!0),o.traverse(function(c){const u=c.geometry;if(u!==void 0){const h=u.attributes.position;if(h!==void 0)for(let _=0,A=h.count;_<A;_++){const w=new three_module.Pq0;w.fromBufferAttribute(h,_).applyMatrix4(c.matrixWorld),l.push(w)}}}),this.setFromPoints(l)}containsPoint(o){const l=this.faces;for(let c=0,u=l.length;c<u;c++)if(l[c].distanceToPoint(o)>this.tolerance)return!1;return!0}intersectRay(o,l){const c=this.faces;let u=-1/0,h=1/0;for(let _=0,A=c.length;_<A;_++){const w=c[_],C=w.distanceToPoint(o.origin),M=w.normal.dot(o.direction);if(C>0&&M>=0)return null;const O=M!==0?-C/M:0;if(!(O<=0)&&(M>0?h=Math.min(O,h):u=Math.max(O,u),u>h))return null}return u!==-1/0?o.at(u,l):o.at(h,l),l}intersectsRay(o){return this.intersectRay(o,ConvexHull_v1)!==null}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(o,l){return o.face=l,l.outside===null?this.assigned.append(o):this.assigned.insertBefore(l.outside,o),l.outside=o,this}removeVertexFromFace(o,l){return o===l.outside&&(o.next!==null&&o.next.face===l?l.outside=o.next:l.outside=null),this.assigned.remove(o),this}removeAllVerticesFromFace(o){if(o.outside!==null){const l=o.outside;let c=o.outside;for(;c.next!==null&&c.next.face===o;)c=c.next;return this.assigned.removeSubList(l,c),l.prev=c.next=null,o.outside=null,l}}deleteFaceVertices(o,l){const c=this.removeAllVerticesFromFace(o);if(c!==void 0)if(l===void 0)this.unassigned.appendChain(c);else{let u=c;do{const h=u.next;l.distanceToPoint(u.point)>this.tolerance?this.addVertexToFace(u,l):this.unassigned.append(u),u=h}while(u!==null)}return this}resolveUnassignedPoints(o){if(this.unassigned.isEmpty()===!1){let l=this.unassigned.first();do{const c=l.next;let u=this.tolerance,h=null;for(let _=0;_<o.length;_++){const A=o[_];if(A.mark===Visible){const w=A.distanceToPoint(l.point);if(w>u&&(u=w,h=A),u>1e3*this.tolerance)break}}h!==null&&this.addVertexToFace(l,h),l=c}while(l!==null)}return this}computeExtremes(){const o=new three_module.Pq0,l=new three_module.Pq0,c=[],u=[];for(let h=0;h<3;h++)c[h]=u[h]=this.vertices[0];o.copy(this.vertices[0].point),l.copy(this.vertices[0].point);for(let h=0,_=this.vertices.length;h<_;h++){const A=this.vertices[h],w=A.point;for(let C=0;C<3;C++)w.getComponent(C)<o.getComponent(C)&&(o.setComponent(C,w.getComponent(C)),c[C]=A);for(let C=0;C<3;C++)w.getComponent(C)>l.getComponent(C)&&(l.setComponent(C,w.getComponent(C)),u[C]=A)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(o.x),Math.abs(l.x))+Math.max(Math.abs(o.y),Math.abs(l.y))+Math.max(Math.abs(o.z),Math.abs(l.z))),{min:c,max:u}}computeInitialHull(){const o=this.vertices,l=this.computeExtremes(),c=l.min,u=l.max;let h=0,_=0;for(let ne=0;ne<3;ne++){const ce=u[ne].point.getComponent(ne)-c[ne].point.getComponent(ne);ce>h&&(h=ce,_=ne)}const A=c[_],w=u[_];let C,M;h=0,_line3.set(A.point,w.point);for(let ne=0,ce=this.vertices.length;ne<ce;ne++){const ue=o[ne];if(ue!==A&&ue!==w){_line3.closestPointToPoint(ue.point,!0,ConvexHull_closestPoint);const ye=ConvexHull_closestPoint.distanceToSquared(ue.point);ye>h&&(h=ye,C=ue)}}h=-1,ConvexHull_plane.setFromCoplanarPoints(A.point,w.point,C.point);for(let ne=0,ce=this.vertices.length;ne<ce;ne++){const ue=o[ne];if(ue!==A&&ue!==w&&ue!==C){const ye=Math.abs(ConvexHull_plane.distanceToPoint(ue.point));ye>h&&(h=ye,M=ue)}}const O=[];if(ConvexHull_plane.distanceToPoint(M.point)<0){O.push(Face.create(A,w,C),Face.create(M,w,A),Face.create(M,C,w),Face.create(M,A,C));for(let ne=0;ne<3;ne++){const ce=(ne+1)%3;O[ne+1].getEdge(2).setTwin(O[0].getEdge(ce)),O[ne+1].getEdge(1).setTwin(O[ce+1].getEdge(0))}}else{O.push(Face.create(A,C,w),Face.create(M,A,w),Face.create(M,w,C),Face.create(M,C,A));for(let ne=0;ne<3;ne++){const ce=(ne+1)%3;O[ne+1].getEdge(2).setTwin(O[0].getEdge((3-ne)%3)),O[ne+1].getEdge(0).setTwin(O[ce+1].getEdge(1))}}for(let ne=0;ne<4;ne++)this.faces.push(O[ne]);for(let ne=0,ce=o.length;ne<ce;ne++){const ue=o[ne];if(ue!==A&&ue!==w&&ue!==C&&ue!==M){h=this.tolerance;let ye=null;for(let Oe=0;Oe<4;Oe++){const ke=this.faces[Oe].distanceToPoint(ue.point);ke>h&&(h=ke,ye=this.faces[Oe])}ye!==null&&this.addVertexToFace(ue,ye)}}return this}reindexFaces(){const o=[];for(let l=0;l<this.faces.length;l++){const c=this.faces[l];c.mark===Visible&&o.push(c)}return this.faces=o,this}nextVertexToAdd(){if(this.assigned.isEmpty()===!1){let o,l=0;const c=this.assigned.first().face;let u=c.outside;do{const h=c.distanceToPoint(u.point);h>l&&(l=h,o=u),u=u.next}while(u!==null&&u.face===c);return o}}computeHorizon(o,l,c,u){let h;this.deleteFaceVertices(c),c.mark=Deleted,h=l===null?l=c.getEdge(0):l.next;do{const _=h.twin,A=_.face;A.mark===Visible&&(A.distanceToPoint(o)>this.tolerance?this.computeHorizon(o,_,A,u):u.push(h)),h=h.next}while(h!==l);return this}addAdjoiningFace(o,l){const c=Face.create(o,l.tail(),l.head());return this.faces.push(c),c.getEdge(-1).setTwin(l.twin),c.getEdge(0)}addNewFaces(o,l){this.newFaces=[];let c=null,u=null;for(let h=0;h<l.length;h++){const _=l[h],A=this.addAdjoiningFace(o,_);c===null?c=A:A.next.setTwin(u),this.newFaces.push(A.face),u=A}return c.next.setTwin(u),this}addVertexToHull(o){const l=[];return this.unassigned.clear(),this.removeVertexFromFace(o,o.face),this.computeHorizon(o.point,null,o.face,l),this.addNewFaces(o,l),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let o;for(this.computeInitialHull();(o=this.nextVertexToAdd())!==void 0;)this.addVertexToHull(o);return this.reindexFaces(),this.cleanup(),this}}class Face{constructor(){this.normal=new three_module.Pq0,this.midpoint=new three_module.Pq0,this.area=0,this.constant=0,this.outside=null,this.mark=Visible,this.edge=null}static create(o,l,c){const u=new Face,h=new HalfEdge(o,u),_=new HalfEdge(l,u),A=new HalfEdge(c,u);return h.next=A.prev=_,_.next=h.prev=A,A.next=_.prev=h,u.edge=h,u.compute()}getEdge(o){let l=this.edge;for(;o>0;)l=l.next,o--;for(;o<0;)l=l.prev,o++;return l}compute(){const o=this.edge.tail(),l=this.edge.head(),c=this.edge.next.head();return _triangle.set(o.point,l.point,c.point),_triangle.getNormal(this.normal),_triangle.getMidpoint(this.midpoint),this.area=_triangle.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(o){return this.normal.dot(o)-this.constant}}class HalfEdge{constructor(o,l){this.vertex=o,this.prev=null,this.next=null,this.twin=null,this.face=l}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const o=this.head(),l=this.tail();return l!==null?l.point.distanceTo(o.point):-1}lengthSquared(){const o=this.head(),l=this.tail();return l!==null?l.point.distanceToSquared(o.point):-1}setTwin(o){return this.twin=o,o.twin=this,this}}class VertexNode{constructor(o){this.point=o,this.prev=null,this.next=null,this.face=null}}class VertexList{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(o,l){return l.prev=o.prev,l.next=o,l.prev===null?this.head=l:l.prev.next=l,o.prev=l,this}insertAfter(o,l){return l.prev=o,l.next=o.next,l.next===null?this.tail=l:l.next.prev=l,o.next=l,this}append(o){return this.head===null?this.head=o:this.tail.next=o,o.prev=this.tail,o.next=null,this.tail=o,this}appendChain(o){for(this.head===null?this.head=o:this.tail.next=o,o.prev=this.tail;o.next!==null;)o=o.next;return this.tail=o,this}remove(o){return o.prev===null?this.head=o.next:o.prev.next=o.next,o.next===null?this.tail=o.prev:o.next.prev=o.prev,this}removeSubList(o,l){return o.prev===null?this.head=l.next:o.prev.next=l.next,l.next===null?this.tail=o.prev:l.next.prev=o.prev,this}isEmpty(){return this.head===null}}class ConvexGeometry extends three_module.LoY{constructor(o=[]){super();const l=[],c=[],u=new ConvexHull_ConvexHull().setFromPoints(o).faces;for(let h=0;h<u.length;h++){const _=u[h];let A=_.edge;do{const w=A.head().point;l.push(w.x,w.y,w.z),c.push(_.normal.x,_.normal.y,_.normal.z),A=A.next}while(A!==_.edge)}this.setAttribute("position",new three_module.qtW(l,3)),this.setAttribute("normal",new three_module.qtW(c,3))}}var PosePlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let PosePlugin=class extends AViewerPlugin{constructor(){super(),this._debug=!1,this.enabled=!0,this.toJSON=void 0,this.autoUpdateGround=!0}computeStablePoses(d){var o,l;const c=new ConvexHull_ConvexHull().setFromObject(d),u=this._computeCOM(c),h=new three_module.Pq0,_=new three_module.Pq0,A=new three_module.Pq0,w=new three_module.Pq0,C=[];for(const M of c.faces){this._getFaceData(M,h,_,A,w);const O=new three_module.Pq0().copy(h),ne=this._project(u,h,_,A,w),ce=this._constructRotationTransform(u,ne,w),ue=new three_module.kn4().copy(ce).invert(),ye=new three_module.Pq0().copy(u);ye.applyMatrix4(ue),h.applyMatrix4(ue),_.applyMatrix4(ue),A.applyMatrix4(ue);const Oe=new three_module.I9Y(ye.x,ye.y),ke=new three_module.I9Y(h.x,h.y),Ve=new three_module.I9Y(_.x,_.y),tt=new three_module.I9Y(A.x,A.y),ht=this._pointInTriangle(Oe,ke,Ve,tt);if(ht>0){const ut=this._triArea(h,_,A),_t=this._getMaxEdgeData(h,_,A),at=this._constructRotationTransform(u,ne,w,_t.edgeVector);C.push({distance:ht,faceNormal:w,area:ut,face:M,maxEdgeLength:_t.maxEdgeLength,xform:at,edgePoint:O})}}return C.sort((M,O)=>O.maxEdgeLength-M.maxEdgeLength),this._debug&&this._createDebugMeshes(u,c),d._stablePoses=C,d._poseIndex=-1,(l=(o=d.uiConfig)===null||o===void 0?void 0:o.uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0),C}setMostStablePose(d){return this.setPose(d,0)}setVerticalPose(d){if(d._stablePoses||this.computeStablePoses(d),d._stablePoses)return this.setPose(d,d._stablePoses.length-1)}setNextPose(d){var o;return this.setPose(d,((o=d._poseIndex)!==null&&o!==void 0?o:-1)+1)}setPreviousPose(d){return this.setPose(d,(d._poseIndex||0)-1)}setOriginalPose(d){delete d._poseIndex,d._stablePoses||this.computeStablePoses(d),d._stablePoses&&this._syncPose(d,!0)}clearPoses(d){var o,l,c,u,h;delete d._stablePoses,delete d._poseIndex,delete d._originalXform,(u=(c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(PickingPlugin))===null||l===void 0?void 0:l.uiConfig)===null||c===void 0?void 0:c.uiRefresh)===null||u===void 0||u.call(c,"postFrame",!0),(h=this._viewer)===null||h===void 0||h.setDirty()}setPose(d,o){var l;if(d._stablePoses||this.computeStablePoses(d),!d._stablePoses)return;const c=(l=d._poseIndex)!==null&&l!==void 0?l:-1;return o<0&&(o=d._stablePoses.length-1),o>d._stablePoses.length-1&&(o=0),o!==c?(d._poseIndex=o,this._syncPose(d),()=>c<0?this.setOriginalPose(d):this.setPose(d,c)):void 0}async onAdded(d){await super.onAdded(d),d.scene.addEventListener("addSceneObject",o=>{var l;const c=(l=o.object)===null||l===void 0?void 0:l.modelObject;if(!c)return;const u=c.uiConfig;u&&Array.isArray(u.children)&&u.children.push({type:"folder",label:"Poses",children:[{type:"button",label:"Compute Poses",hidden:()=>!!c._stablePoses,value:()=>this.computeStablePoses(c)},{type:"button",label:"Original Pose",hidden:()=>!c._stablePoses,value:()=>this.setOriginalPose(c)},{type:"button",label:"Stable Pose",hidden:()=>!c._stablePoses,value:()=>this.setMostStablePose(c)},{type:"button",label:"Vertical Pose",hidden:()=>!c._stablePoses,value:()=>this.setVerticalPose(c)},{type:"button",label:"Next Pose",hidden:()=>!c._stablePoses,value:()=>this.setNextPose(c)},{type:"button",label:"Previous Pose",hidden:()=>!c._stablePoses,value:()=>this.setPreviousPose(c)},{type:"button",label:"Clear Poses",hidden:()=>!c._stablePoses,value:()=>this.clearPoses(c)}]})})}_getMaxEdgeData(d,o,l){const c=d.distanceTo(o),u=o.distanceTo(l),h=l.distanceTo(d);let _=c;const A=new three_module.Pq0;return c>u?c>h?(_=c,A.copy(o).sub(d).normalize()):(_=h,A.copy(d).sub(l).normalize()):u>h?(_=u,A.copy(l).sub(o).normalize()):(_=h,A.copy(d).sub(l).normalize()),{maxEdgeLength:_,edgeVector:A,edgePoint:new three_module.Pq0().copy(d)}}_getFaceData(d,o,l,c,u){let h=d.edge,_=h.head().point;o.set(_.x,_.y,_.z),h=h.next,_=h.head().point,l.set(_.x,_.y,_.z),h=h.next,_=h.head().point,c.set(_.x,_.y,_.z),u==null||u.copy(d.normal)}_computeCOM(d){const o=new three_module.Pq0,l=new three_module.Pq0,c=new three_module.Pq0,u=new three_module.Pq0,h=new three_module.Pq0;let _=0;for(const A of d.faces){this._getFaceData(A,l,c,u),h.set(0,0,0),h.add(l).add(c).add(u).multiplyScalar(1/3),c.sub(l),u.sub(l);const w=.5*c.cross(u).length();_+=w,h.multiplyScalar(w),o.add(h)}return o.multiplyScalar(1/_),o}_sign(d,o,l){return(d.x-l.x)*(o.y-l.y)-(o.x-l.x)*(d.y-l.y)}_shortestDistance(d,o,l){const c=new three_module.I9Y(o.y-l.y,l.x-o.x).normalize(),u=new three_module.I9Y().copy(o).sub(d);return Math.abs(u.dot(c))}_pointInTriangle(d,o,l,c){const u=this._sign(d,o,l),h=this._sign(d,l,c),_=this._sign(d,c,o);if(!(u<0||h<0||_<0)||!(u>0||h>0||_>0)){const A=this._shortestDistance(d,o,l),w=this._shortestDistance(d,l,c),C=this._shortestDistance(d,c,o);return Math.min(Math.min(A,w),C)}return-1}_project(d,o,l,c,u){const h=new three_module.Pq0().copy(u),_=new three_module.Pq0().copy(o).sub(d).dot(h);_<0&&h.negate();const A=Math.abs(_);return new three_module.Pq0().copy(d).addScaledVector(h,A)}_constructRotationTransform(d,o,l,c){const u=new three_module.Pq0().copy(l),h=new three_module.Pq0().copy(o).sub(d).dot(u);h>0&&u.negate();const _=new three_module.Pq0().copy(o).addScaledVector(u,Math.abs(h)),A=c===void 0?new three_module.Pq0(1,1,0):c;return new three_module.kn4().lookAt(o,_,A)}_triArea(d,o,l){const c=new three_module.Pq0().copy(o).sub(d),u=new three_module.Pq0().copy(l).sub(d);return .5*c.cross(u).length()}_createTriangleMesh(){const d=new three_module.LoY,o=new three_module.V9B({color:16711680,side:three_module.$EB});return new three_module.eaF(d,o)}_updateTriangleMesh(d){var o;this._triMesh.geometry.setAttribute("position",new three_module.THS(d,3)),(o=this._viewer)===null||o===void 0||o.setDirty()}_syncPose(d,o=!1){var l,c,u,h,_,A,w,C;if(d._stablePoses===void 0||d._stablePoses.length==0)return;const M=new three_module.kn4;if(!o){M.lookAt(new three_module.Pq0,new three_module.Pq0(0,1,0),new three_module.Pq0(0,0,1));const ne=d._stablePoses[d._poseIndex||0].xform,ce=new three_module.kn4().copy(ne).invert();M.multiply(ce)}if(d._originalXform){const ne=new three_module.Pq0,ce=new three_module.PTz,ue=new three_module.Pq0;d._originalXform.decompose(ne,ce,ue),d.position.copy(ne),d.quaternion.copy(ce),d.scale.copy(ue)}else d._originalXform=new three_module.kn4().copy(d.matrix);d.applyMatrix4(M);const O=(l=this._viewer)===null||l===void 0?void 0:l.getPlugin(GroundPlugin);if(this.autoUpdateGround)(c=this._viewer)===null||c===void 0||c.scene.setDirty({sceneUpdate:!0}),O.enableRefreshTransform=!0;else if(!o){const ne=d._stablePoses[d._poseIndex||0].edgePoint,ce=new three_module.Pq0().copy(ne);ce.applyMatrix4(M);const ue=ce.y-O.shadowBaker.attachedMesh.position.y;d.position.y-=ue}(u=this._viewer)===null||u===void 0||u.setDirty(),(h=this._viewer)===null||h===void 0||h.renderer.resetShadows(),O==null||O.bakeShadows(),(C=(A=(_=this._viewer)===null||_===void 0?void 0:_.getPlugin(PickingPlugin))===null||A===void 0?void 0:(w=A.uiConfig).uiRefresh)===null||C===void 0||C.call(w,"postFrame",!0)}async _createDebugMeshes(d,o){var l;const c=[];for(const M of o.vertices)c.push(new three_module.Pq0(M.point.x,M.point.y,M.point.z));const u=new ConvexGeometry(c),h=new three_module.XJ7(u),_=new three_module.DXC(h);_.material.opacity=.25,_.material.transparent=!0,this._triMesh=this._createTriangleMesh();const A=new three_module.Gu$(.025),w=new three_module.eaF(A,new three_module.uSd({color:16776960}));w.position.copy(d);const C=(await((l=this._viewer)===null||l===void 0?void 0:l.createObject3D(void 0,!0))).modelObject;return C.add(this._triMesh),C.add(_),C.add(w),C}};PosePlugin.PluginType="PosePlugin",PosePlugin_decorate([uiToggle()],PosePlugin.prototype,"autoUpdateGround",void 0),PosePlugin=PosePlugin_decorate([uiFolder("Pose Plugin")],PosePlugin);var tweakpane_image_plugin=__webpackgi_require__(282),tweakpane=__webpackgi_require__(578);const tweakpaneCheckParent=(d,o)=>o.controller_.rackController.rack===d.controller_.parent,tweakPaneMoveToParentIndex=(d,o,l)=>{var c,u;const h=d.controller_,_=(u=(c=h.parent)===null||c===void 0?void 0:c.children)===null||u===void 0?void 0:u.indexOf(h);return!(tweakpaneCheckParent(d,o)&&_===l||(o.add(d,l),0))},tpFolderGenerator=(d,o,l,c)=>{var u,h,_,A,w;let C=o.uiRef;C!=null&&C.controller_.viewProps.get("disposed")&&(C=void 0);const M=C==null?void 0:C.expanded;if(!C){const Oe=d.addFolder({title:""});C=Oe,C.on("fold",ke=>{var Ve,tt,ht,ut;let _t=Oe.expanded;S(o,"expanded",_t,!0),_t=(Ve=Ee(o.expanded))!==null&&Ve!==void 0?Ve:_t,_t!==Oe.expanded&&(Oe.expanded=_t),(tt=o.uiRefresh)===null||tt===void 0||tt.call(o,"postFrame",!0,10),_t?(ht=o.onExpand)===null||ht===void 0||ht.call(o,o):(ut=o.onCollapse)===null||ut===void 0||ut.call(o,o)})}if(!C)return C;C.expanded=(h=(u=Ee(o.expanded))!==null&&u!==void 0?u:M)!==null&&h!==void 0&&h;const O=((_=o.children)!==null&&_!==void 0?_:[]).map(Oe=>Oe&&Ee(Oe)).flat(2).filter(Oe=>Oe);let ne=0;for(const Oe of O){if(Array.isArray(Oe)||typeof Oe!="object"){console.error("child is not an object",Oe);continue}let ke=Oe.uiRef;ke&&ke.controller_.viewProps.get("disposed")&&(Oe.uiRef=void 0,Oe.uiRefresh=void 0),ke=Oe.uiRef,ke||(l.appendUiObject({uiConfig:Oe},C),ke=Oe.uiRef),ke&&tweakPaneMoveToParentIndex(ke,C,ne++)&&l.appendUiObject({uiConfig:Oe},C)}let ce=C.children;for(;ce.length>ne;){const Oe=ce[ce.length-1];C.remove(Oe),Oe.dispose(),ce=C.children}C.controller_.props.set("title",(A=Ee(o.label))!==null&&A!==void 0?A:"");const ue=C.controller_.view.containerElement,ye=Ee(o.domChildren,[]);if((ye==null?void 0:ye.length)!==void 0){const Oe=[];for(let ke=0;ke<ue.children.length;ke++){const Ve=ue.children[ke];!((w=Ve.dataset)===null||w===void 0)&&w.tpCustomDOM&&Oe.push(Ve)}for(const ke of Oe)ue.removeChild(ke);for(const ke of ye)ke.parentElement!==ue&&(ue.appendChild(ke),ke.dataset.tpCustomDOM="true");C.controller_.foldable.cleanUpTransition()}return C},tpButtonInputGenerator=(d,o,l,c)=>{var u,h;const[_,A]=(u=o.property)!==null&&u!==void 0?u:[void 0,void 0],w=(h=Ee(o.label))!==null&&h!==void 0?h:A;let C=o.uiRef;return C!=null&&C.controller_.viewProps.get("disposed")&&(C=void 0),C||(C=d.addButton({title:""}),C.on("click",async()=>{const M=[];o.prompt&&M.push(await l.prompt(...o.prompt));let O=_&&A?_[A]:void 0,ne=_;if(O||(O=o.value,ne=o),typeof O=="function"){const ce=()=>{var ue;l.removeEventListener("postFrame",ce);const ye=O.call(ne??o,...M);typeof ye=="function"&&((ue=l.undoManager)===null||ue===void 0||ue.record({undo:()=>{var Oe;ye.call(ne??o,...M),(Oe=o.uiRefresh)===null||Oe===void 0||Oe.call(o,void 0,!1)},redo:()=>{var Oe;O.call(ne??o,...M),(Oe=o.uiRefresh)===null||Oe===void 0||Oe.call(o,void 0,!1)}}))};l.addEventListener("postFrame",ce)}else console.warn("uiconfig.js: Invalid action type for button")})),C&&(C.title=(w??"click me")+""),C},tpDropdownInputGenerator=(d,o,l,c)=>{var u;const h=Object.fromEntries(((u=Ee(o.children))!==null&&u!==void 0?u:[]).map(_=>Ee(_)).flat(2).filter(_=>_).map(_=>{var A;const w=Ee(_.label);return[w,(A=_.value)!==null&&A!==void 0?A:w]}));return tpInputGenerator(d,o,l,{options:h,...c??{}})},tpSliderInputGenerator=(d,o,l,c)=>{var u,h;const _=Ee(o.bounds),A=((u=_==null?void 0:_.length)!==null&&u!==void 0?u:0)>=2?_[1]:1,w=((h=_==null?void 0:_.length)!==null&&h!==void 0?h:0)>=1?_[0]:0,C=o.stepSize||void 0;return tpInputGenerator(d,o,l,{min:w,max:A,step:C,...c??{}})},tpVecInputGenerator=(d,o,l,c)=>{var u,h,_;const A=Ee(o.bounds);if(!A||A.length<1)return tpInputGenerator(d,o,l,{...c??{}});const w=((u=A.length)!==null&&u!==void 0?u:0)>=2?A[1]:1,C=((h=A.length)!==null&&h!==void 0?h:0)>=1?A[0]:0,M={min:C,max:w,step:(_=o.stepSize)!==null&&_!==void 0?_:(w-C)/100},O={x:M,y:M};o.type!=="vec3"&&o.type!=="vec4"||(O.z=M),o.type==="vec4"&&(O.w=M);const ne=o.property;if(o.value===void 0&&ne&&ne[0]&&typeof ne[0]=="object"&&ne[0][ne[1]]&&Array.isArray(ne[0][ne[1]])){const[ce,ue]=ne,ye=ce[ue],Oe=ye.length,ke=new(Oe===2?three_module.I9Y:Oe===3?three_module.Pq0:three_module.IUQ)().fromArray(ye);o.value=ke,o.property=void 0,o.onChange=[()=>{ce[ue]=ke.toArray()},...Array.isArray(o.onChange)?o.onChange:[o.onChange]].filter(Ve=>Ve),o.label===void 0&&(o.label=ue)}return tpInputGenerator(d,o,l,{...O,...c??{}})},tpColorInputGenerator=(d,o,l,c)=>{var u;const h=o.property;if(o.value===void 0&&h&&typeof h[0]=="object"&&(!((u=h[0][h[1]])===null||u===void 0)&&u.isColor)){const[_,A]=h,w=three_module.er$;Object.defineProperty(o,"value",{get:()=>{const C=_[A];return C?new three_module.Q1f(C).getHex(w):0},set:C=>{const M=_[A],O=new three_module.Q1f().setHex(C,w);M.isColor?M.copy(O):typeof M=="number"?_[A]=O.getHex():typeof M=="string"&&(_[A]="#"+O.getHexString()),typeof(_==null?void 0:_.setDirty)=="function"&&_.setDirty()}}),o.property=void 0,o.onChange=[...Array.isArray(o.onChange)?o.onChange:[o.onChange]].filter(C=>C),o.label===void 0&&(o.label=A+"")}return(c=c??{}).view="color",Ee(o.inlinePicker)&&(c.picker="inline"),tpInputGenerator(d,o,l,c)},tpInputGenerator=(d,o,l,c)=>{var u,h,_,A,w,C,M;let O=Ee(o.property);if((o.getValue||o.setValue)&&O&&console.error("specify either property or value, or getValue and setValue",o),O)o.value&&console.warn("uiconfig.js: Both property and value are defined, value will be ignored",o);else if((Object.hasOwn?Object.hasOwn(o,"value"):o.hasOwnProperty("value"))||o.value!==void 0||!o.getValue&&!o.setValue||(Object.defineProperty(o,"value",{get:()=>{var ye;return(ye=o.getValue)===null||ye===void 0?void 0:ye.call(o)},set:ye=>{var Oe;return(Oe=o.setValue)===null||Oe===void 0?void 0:Oe.call(o,ye)}}),O=[o,"value"]),O||o.value===void 0||(O=[o,"value"]),!O)return void console.error("cannot determine property",o);c=c??{};const ne={label:(u=Ee(o.label))!==null&&u!==void 0?u:O[1],...c};let ce=o.uiRef;ce!=null&&ce.controller_.viewProps.get("disposed")&&(ce=void 0);let ue=!1;if(!ce&&typeof O[0]=="object"&&O[0]){const[ye,Oe]=O;try{if(o.isMonitor)ce=d.addMonitor(ye,Oe,ne);else{const ke={tar:ye,key:Oe,__v:cloneVar(ye[Oe])};ke.lastUndoVal=cloneVar(ke.__v),Object.defineProperty(ke,Oe,{get:()=>ke.__v,set:ht=>{ke.__v=ht}});const Ve=ht=>{var ut;[o.onChange].flat().forEach(_t=>typeof _t=="function"&&(_t==null?void 0:_t(ht))),typeof((ut=ke.tar)===null||ut===void 0?void 0:ut.setDirty)=="function"&&ke.tar.setDirty(ht)},tt=ht=>{var ut,_t;const at=ke.tar[ke.key];let lt=ke.__v;const pt=compare(at,lt);if((!pt||ht.last)&&(pt||(copyVal(ke.tar,ke.key,lt),Ve(ht)),ht.last)){let xt=ke.lastUndoVal,Tt=!1;if(typeof lt=="string"&&lt.length>1e5&&(Tt=!0),typeof xt=="string"&&xt.length>1e5&&(Tt=!0),!(Tt||lt instanceof HTMLImageElement)){const Pt=compare(xt,lt);!((ut=l.undoManager)===null||ut===void 0)&&ut.options.debug&&console.log("onchange",xt,lt,Pt),Pt||(lt=cloneVar(lt),xt=cloneVar(xt),(_t=l.undoManager)===null||_t===void 0||_t.record({undo:()=>{var Lt;copyVal(ke.tar,ke.key,xt),Ve({...ht,value:xt}),(Lt=o.uiRefresh)===null||Lt===void 0||Lt.call(o,void 0,!1)},redo:()=>{var Lt;copyVal(ke.tar,ke.key,lt),Ve(ht),(Lt=o.uiRefresh)===null||Lt===void 0||Lt.call(o,void 0,!1)}}),copyVal(ke,"lastUndoVal",lt))}}};ce=d.addInput(ke,Oe,ne).on("change",tt),ce.__proxy1=ke,ue=!0}}catch(ke){if(!ke.message.startsWith("No matching controller for"))throw ke;ce=void 0}}if(ce){for(const[ye,Oe]of Object.entries(ne)){const ke=ce.controller_;let Ve=ke.props.value(ye);if(Ve!==void 0)Ve.rawValue!==Oe&&ce.controller_.props.set(ye,Oe);else{const tt=ke.valueController;Ve=(_=(h=tt.props)===null||h===void 0?void 0:h.value)===null||_===void 0?void 0:_.call(h,ye);let ht=Oe;const ut=Ve==null?void 0:Ve.rawValue;let _t=!1;ye==="options"&&typeof ht=="object"&&!Array.isArray(ht)&&Array.isArray(ut)&&(ht=Object.entries(ht).map(([at,lt])=>({text:at,value:lt})),_t=!0),Ve===void 0||ut===ht||_t&&ce.__lastOptions===Oe||(tt.props.set(ye,ht),_t&&((w=(A=tt.view)===null||A===void 0?void 0:A.update_)===null||w===void 0||w.call(A),ce.__lastOptions=Oe))}}if(o.type==="slider"&&(ne.min!==void 0&&ce.controller_.valueController.sliderController.props.set("minValue",ne.min),ne.max!==void 0&&ce.controller_.valueController.sliderController.props.set("maxValue",ne.max)),(C=(ce==null?void 0:ce.controller_.valueController.view).inputElement)===null||C===void 0||C.setAttribute("placeholder",(M=Ee(o.placeholder))!==null&&M!==void 0?M:""),ce.__proxy1&&!ue){const ye=ce.__proxy1,[Oe,ke]=O;ye.tar=Oe,ye.key=ke;const Ve=Oe[ke];copyVal(ye,"__v",Ve),copyVal(ye,"lastUndoVal",Ve)}ce.refresh()}return ce};function compare(d,o){return typeof d==typeof o&&(typeof d=="object"||Array.isArray(d)?Array.isArray(d)?d.length===o.length&&d.every((l,c)=>compare(l,o[c])):typeof d.equals=="function"?!!d.equals(o):d.toArray&&o.toArray?compare(d.toArray(),o.toArray()):d===o:d===o)}function cloneVar(d){return typeof d=="object"&&d?Array.isArray(d)?[...d]:d.isObject3D||d.isMaterial?d:typeof d.clone=="function"?d.clone():d:d}function copyVal(d,o,l){typeof l.copy=="function"&&d[o]?d[o].copy(l):d[o]=cloneVar(l)}class TweakpaneWrapper extends I{constructor(o=!1,l=!1,c=!1,u=!0,h=document.body){super(),this._refreshQueue={preRender:[],postRender:[],preFrame:[],postFrame:[]},this._lastModeTime={preRender:0,postRender:0,preFrame:0,postFrame:0},this._typeGenerators={panel:tpFolderGenerator,folder:tpFolderGenerator,input:tpInputGenerator,number:tpInputGenerator,slider:tpSliderInputGenerator,dropdown:tpDropdownInputGenerator,checkbox:tpInputGenerator,color:tpColorInputGenerator,vec:tpVecInputGenerator,vec2:tpVecInputGenerator,vec3:tpVecInputGenerator,vec4:tpVecInputGenerator,button:tpButtonInputGenerator,monitor:(A,w,C,M)=>(w.isMonitor=!0,tpInputGenerator(A,w,C,M)),dummy:(A,w,C,M)=>tpInputGenerator(A,w,C,M)},this.undoManager=new Q({bindHotKeys:!0,limit:100,debug:!1}),this.alert=this.alert.bind(this),this.confirm=this.confirm.bind(this),this.prompt=this.prompt.bind(this),this._expand=o,this._limitedOptions=c;const _=this._createUiContainer();h.appendChild(_),this._container=h,this._pane=new tweakpane.Pane({title:"Configuration",container:_}),this._pane.expanded=this._expand,u&&(this.addEventListener("postFrame",()=>this.refreshQueue("postFrame")),setTimeout(()=>{this.dispatchEvent({type:"postFrame"})},32))}refreshQueue(o){const l=this._refreshQueue[o],c=[],u=g(),h=u-this._lastModeTime[o];l.forEach(_=>{_[2]>.001?(_[2]-=h,c.push(_)):this._refreshUiObject(_[0],_[1],_[2])}),this._refreshQueue[o]=c,this._lastModeTime[o]=u}addToRefreshQueue(o,l){var c;const u=(c=l[0])===null||c===void 0?void 0:c.uiConfig,h=u==null?void 0:u.uuid,_=this._refreshQueue[o],A=_.find(w=>w[3]===h);A?A[2]=Math.max(A[2],l[2]):_.push([...l,h]),this._refreshQueue[o]=_}dispose(){var o;(o=this._pane)===null||o===void 0||o.dispose(),this._pane=void 0}appendUiObject(o,l){o&&this._appendUiObject(o,l)}appendChild(o){this.appendUiObject({uiConfig:o})}_appendUiObject(o,l){var c,u,h,_;const{uiConfig:A}=o??{};if(A&&(!this._limitedOptions||A.limitedUi)&&(l=l??this._pane,A.type)){A.uuid||(A.uuid=esm_browser_v4()),A.uiRef&&A.uiRefType!==A.type&&this.removeUiConfig(A);const w=(u=(c=this._typeGenerators)[A.type])===null||u===void 0?void 0:u.call(c,l,A,this);w&&(w.hidden=(h=Ee(A.hidden))!==null&&h!==void 0&&h,w.disabled=(_=Ee(A.disabled))!==null&&_!==void 0&&_),A.uiRef=w,A.uiRefType=w?A.type:void 0,A.uiRefresh=(C="postFrame",M=!1,O=0)=>{var ne;return this._uiObjectRefresh(C,(ne=o==null?void 0:o.uiConfig)!==null&&ne!==void 0?ne:A,l,M,O)},w==null||w.controller_.viewProps.handleDispose(()=>{A.uiRef=void 0,A.uiRefType=void 0,A.uiRefresh=void 0})}}removeUiObject(o){this.removeUiConfig(o==null?void 0:o.uiConfig)}removeUiConfig(o){var l,c;o&&o.uiRef&&((c=(l=o.uiRef).dispose)===null||c===void 0||c.call(l),o.uiRef=void 0,o.uiRefType=void 0,o.uiRefresh=void 0)}_uiObjectRefresh(o,l,c,u,h){(u?flattenUiConfig(l,c):[{uiConfig:l,parentFolder:c}]).forEach(_=>{const A=[{uiConfig:_.uiConfig},_.parentFolder,h];o==="immediate"?this._refreshUiObject(...A):this.addToRefreshQueue(o,A)})}_refreshUiObject(o,l,c=0){this._appendUiObject(o,l),c>1e-4&&console.error("no support for immediate delay")}_createUiContainer(){const o=ee({id:"tweakpaneUiContainer",addToBody:!1});return P($`
          :root{
            --tweakpane-ui-container-width: 300px;
          }
          @media only screen and (min-width: 1500px) {
            :root{
              --tweakpane-ui-container-width: 300px;
            }
          }
          @media only screen and (min-width: 2500px) {
            :root{
              --tweakpane-ui-container-width: 500px;
            }
          }
          #tweakpaneUiContainer {
            position: fixed;
            top: 0px;
            padding-right: 4px;
            padding-bottom: 10px;
            right: 10px;
            width: var(--tweakpane-ui-container-width);
            height: auto;
            overflow-y: scroll;
            z-index: 100;
            pointer-events: auto;
            max-height: calc(100% - 6rem);
            border-radius: 0.5rem;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "system-ui", "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
          }
        `),o}async alert(o){return alert(o)}async confirm(o){return confirm(o)}async prompt(o,l,c=!0){return prompt(o,l)}}function flattenUiConfig(d,o,l){return l=l??[],d&&d.uiRef&&(l.push({uiConfig:d,parentFolder:o}),typeof d.children=="function"||[...d.children||[]].forEach(c=>{typeof c!="function"&&c&&(Array.isArray(c)?c.forEach(u=>l=flattenUiConfig(u,d.uiRef,l)):l=flattenUiConfig(c,d.uiRef,l))})),l}const tpImageInputGenerator=d=>(o,l,c,u)=>{let h=l.property||l.__property;const _="placeholder";l.value===void 0&&(l.getValue||l.setValue)&&(Object.defineProperty(l,"_value",{get:()=>{var C;return(C=l.getValue)===null||C===void 0?void 0:C.call(l)},set:C=>{var M;return(M=l.setValue)===null||M===void 0?void 0:M.call(l,C)}}),h=[l,"_value"]);const[A,w]=h&&typeof h[0]=="object"?h:[l,"value"];if((!(Object.hasOwn?Object.hasOwn(l,"value"):l.hasOwnProperty("value"))||l.value===void 0)&&h&&typeof h[0]=="object"){const C=Xe("Render Target"),M=Xe("Data Texture"),O=Xe("CUBE Texture"),ne=Xe("Compressed Texture"),ce={},ue={};Object.defineProperty(l,"value",{get:()=>{var ye;let Oe,ke=A[w];if(ke!=null&&ke.get&&(ke=ke.get()),!ke)return _;if(ke.isCompressedTexture&&ke.image&&!ke.image.tp_src&&(ke.image.tp_src=ne),ke.isTexture?(ke.image&&!ke.image.tp_src&&(ke.image instanceof ImageBitmap||ke.image instanceof HTMLImageElement||ke.image instanceof HTMLVideoElement)?ke.image.tp_src=Ne(ke.image,160):ke.image&&ke.isRenderTargetTexture&&!ke.image.tp_src?ke.__target&&(ke.tp_src=d.renderer.renderTargetToDataUrl(ke.__target,void 0,void 0,Array.isArray(ke.__target.texture)?ke.__target.texture.indexOf(ke):void 0)):ke.image&&!ke.image.tp_src&&(ke.image.tp_src=textureToCanvas(ke,160,!1).toDataURL("image/png",90)),!ke.isRenderTargetTexture||ke.image.tp_src||ke.tp_src||(ke.image.tp_src=C),ke.isDataTexture&&ke.image&&!ke.image.tp_src&&(ke.image.tp_src=M),ke.image&&(Oe=ke.image.tp_src_uuid,Oe=Oe?ce[Oe]:void 0,Oe||(Oe=ke.image.tp_src||ke.image.src)),ke.tp_src&&(Oe=ke.tp_src)):typeof ke=="string"?Oe=ke:ke.domainMin?(Oe=ke.texture,ke.texture.image&&!ke.texture.image.tp_src&&(ke.texture.image.tp_src=O),ke.texture.image&&(Oe=ke.texture.image.tp_src_uuid,Oe=Oe?ce[Oe]:void 0,Oe||(Oe=ke.texture.image.tp_src||ke.texture.image.src))):ke&&console.error("unknown value",ke),Oe||(Oe=_),ke.image&&!ke.image.tp_src_uuid){const Ve=esm_browser_v4();ke.image.tp_src_uuid=Ve,ue[Oe]=Ve}return typeof Oe=="string"&&(Oe=(ye=ce[Oe])!==null&&ye!==void 0?ye:Oe),Oe},set:ye=>{var Oe,ke,Ve,tt,ht,ut,_t,at,lt,pt,xt,Tt,Pt;const Lt=A[w],Bt=kt=>{var Vt;A[w]=kt,kt!=null&&kt.isTexture&&(kt.flipY=kt.isDataTexture?kt.flipY:(Vt=Lt==null?void 0:Lt.flipY)===null||Vt===void 0||Vt)};if(typeof ye=="string")return void(typeof Lt=="string"&&Bt(ye));if(!ye)return void(l.value=_);if(ye.isPlaceholder)return void(Lt&&(Bt(typeof Lt=="string"?"":null),typeof(A==null?void 0:A.setDirty)=="function"&&A.setDirty()));let Ut=ye.tp_src_uuid;if(Ut||(Ut=(Oe=ye.src)!==null&&Oe!==void 0?Oe:ye.tp_src,Ut=(ke=ue[Ut])!==null&&ke!==void 0?ke:Ut,delete ue[Ut],ye.tp_src_uuid=Ut),Ut&&(ce[Ut]=ye),typeof Lt!="string"){if(!((Lt==null?void 0:Lt.image)===ye||((Ve=Lt==null?void 0:Lt.image)===null||Ve===void 0?void 0:Ve.src)===ye.src||((tt=Lt==null?void 0:Lt.image)===null||tt===void 0?void 0:tt.tp_src)===ye.tp_src&&ye.tp_src!=null||((ht=Lt==null?void 0:Lt.image)===null||ht===void 0?void 0:ht.tp_src)===ye.src&&ye.src!=null||((ut=Lt==null?void 0:Lt.image)===null||ut===void 0?void 0:ut.src)===ye.tp_src&&ye.tp_src!=null))if(ye instanceof File){const kt=d==null?void 0:d.getPlugin(AssetManagerPlugin);if(!kt)throw"Viewer or AssetManagerPlugin not found";(_t=kt.importer)===null||_t===void 0||_t.importSingle({file:ye,path:ye.src}).then(Vt=>{var si,Jt,Wt,Zt;if(Vt){Vt.isDataTexture&&(Vt.needsUpdate=!0);const ti=(Wt=(Jt=(si=ye.src)===null||si===void 0?void 0:si.split("?"))===null||Jt===void 0?void 0:Jt[0])===null||Wt===void 0?void 0:Wt.split(".").pop();Vt.userData&&(Vt.userData.mimeType||(Vt.userData.mimeType="image/"+(["jpg","jpeg"].includes(ti)?"jpeg":"png"))),Bt(Vt),[l.onChange].flat().forEach(ci=>typeof ci=="function"&&(ci==null?void 0:ci())),typeof(A==null?void 0:A.setDirty)=="function"&&A.setDirty(),(Zt=l.uiRefresh)===null||Zt===void 0||Zt.call(l,"postFrame",!1)}})}else{if(SVGTextureLoader.USE_CANVAS_TEXTURE&&(!((at=ye.src)===null||at===void 0)&&at.endsWith(".svg")||!((lt=ye.src)===null||lt===void 0)&&lt.startsWith("data:image/svg"))){const Jt=document.createElement("canvas");SVGTextureLoader.CopyImageToCanvas(Jt,ye),ye=Jt}const kt=new three_module.gPd(ye);kt.assetType="texture",kt.needsUpdate=!0;const Vt=(Tt=(xt=(pt=ye.src)===null||pt===void 0?void 0:pt.split("?"))===null||xt===void 0?void 0:xt[0])===null||Tt===void 0?void 0:Tt.split(".").pop();kt.userData.mimeType||(kt.userData.mimeType="image/"+(["jpg","jpeg"].includes(Vt)?"jpeg":"png"));const si=["normalMap","aoMap","emissiveMap","roughnessMap","metalnessMap","displacementMap","bumpMap","alphaMap"].includes(w);kt.colorSpace=si?three_module.Zr2:three_module.er$,kt.wrapS=three_module.GJx,kt.wrapT=three_module.GJx,Bt(kt),[l.onChange].flat().forEach(Jt=>typeof Jt=="function"&&(Jt==null?void 0:Jt())),typeof(A==null?void 0:A.setDirty)=="function"&&A.setDirty(),(Pt=l.uiRefresh)===null||Pt===void 0||Pt.call(l,"postFrame",!1)}}else Bt(Ut)}}),l.__property=l.property,l.property=void 0,l.label===void 0&&(l.label=w)}return(u=u??{}).extensions=[".jpg",".png",".svg",".hdr",".exr",".jpeg",".bmp",".gif",".webp",".cube","ktx2"],u.imageFit===void 0&&(u.imageFit="contain"),u.clickCallback===void 0&&(u.clickCallback=(C,M)=>{var O;const ne=C==null?void 0:C.target,ce=ne==null?void 0:ne.getBoundingClientRect();if(!ce)return void M.click();const ue=l.uiRef.controller_.valueController.value.rawValue,ye=ue===_||ue!=null&&ue.isPlaceholder?{}:{"remove image":()=>{var ke;l.uiRef.controller_.valueController.value.setRawValue("");const Ve=typeof A[w]=="string";A[w]=Ve?"":null,[l.onChange].flat().forEach(tt=>typeof tt=="function"&&(tt==null?void 0:tt())),typeof(A==null?void 0:A.setDirty)=="function"&&A.setDirty(),(ke=l.uiRefresh)===null||ke===void 0||ke.call(l,"postFrame",!1),CustomContextMenu.Remove()},"download image":async()=>{var ke,Ve,tt;CustomContextMenu.Remove();const ht=A[w];if(!ht)return;const ut=(ke=ht==null?void 0:ht.image)!==null&&ke!==void 0?ke:l.uiRef.controller_.valueController.value.rawValue;let _t=ht.__rootBlob?ht.__rootBlob.objectUrl||URL.createObjectURL(ht.__rootBlob):((Ve=ht.userData)===null||Ve===void 0?void 0:Ve.rootPath)||(ut==null?void 0:ut.src);ut&&(ut instanceof ImageBitmap||ut instanceof HTMLImageElement||ut instanceof HTMLVideoElement)&&!_t&&(_t=Ne(ut));let at=ht.__rootBlob?ht.__rootBlob.name||"image."+(ht.__rootBlob.ext||"png"):null;if(!_t&&ht.isRenderTargetTexture){const pt=ht.__target;if(ht.type===three_module.OUM)_t=d.renderer.renderTargetToDataUrl(pt,"image/png",90,Array.isArray(ht.__target.texture)?ht.__target.texture.indexOf(ht):void 0),at="renderTarget.png";else{const xt=new EXRExporter2().parse(d.renderer.rendererObject,pt,{textureIndex:Array.isArray(ht.__target.texture)?ht.__target.texture.indexOf(ht):void 0}),Tt=new Blob([xt],{type:"image/x-exr"});if(!Tt)return void console.error("cannot export render target",ut,A[w],A,w,l);at="renderTarget.exr",_t=URL.createObjectURL(Tt)}}if(!_t&&ht.isDataTexture){const pt=new EXRExporter2().parse(void 0,ht),xt=new Blob([pt],{type:"image/x-exr"});if(!xt)return void console.error("cannot export data texture",ut,A[w],A,w,l);at="dataTexture.exr",_t=URL.createObjectURL(xt)}if(!_t)return void console.error("cannot export image",ut,A[w],A,w,l);const lt=document.createElement("a");document.body.appendChild(lt),lt.style.display="none",lt.href=_t,lt.download=at||(_t.startsWith("data:")?"image.png":(tt=_t.split("/").pop())!==null&&tt!==void 0?tt:"image.png"),lt.target="_blank",lt.click(),document.body.removeChild(lt)}},Oe=CustomContextMenu.Create({...ye,"set/replace image":()=>{M.click(),CustomContextMenu.Remove()},"from url":async()=>{var ke,Ve;let tt="";if(tt=await c.prompt("Load texture: Enter Image/Texture URL",tt,!0),!tt||!tt.startsWith("http")&&!tt.startsWith("data:image"))return tt!==null&&await c.alert("Loading Image: Invalid URL"),void CustomContextMenu.Remove();tt=tt.trim();const ht=A[w];if(typeof ht=="string")A[w]=tt,[l.onChange].flat().forEach(ut=>typeof ut=="function"&&(ut==null?void 0:ut())),typeof(A==null?void 0:A.setDirty)=="function"&&A.setDirty(),(ke=l.uiRefresh)===null||ke===void 0||ke.call(l,"postFrame",!1);else{const ut=d==null?void 0:d.getPlugin(AssetManagerPlugin);if(!ut)throw"Viewer or AssetManagerPlugin not found";(Ve=ut.importer)===null||Ve===void 0||Ve.importSinglePath(tt).then(_t=>{var at;if(_t){_t.isDataTexture?_t.needsUpdate=!0:_t&&(ht==null?void 0:ht.flipY)!==void 0&&(_t.flipY=ht.flipY);const lt=["normalMap","aoMap","emissiveMap","roughnessMap","metalnessMap","displacementMap","bumpMap","alphaMap"].includes(w);_t.colorSpace=lt?three_module.Zr2:three_module.er$,A[w]=_t,[l.onChange].flat().forEach(pt=>typeof pt=="function"&&(pt==null?void 0:pt())),typeof(A==null?void 0:A.setDirty)=="function"&&A.setDirty(),(at=l.uiRefresh)===null||at===void 0||at.call(l,"postFrame",!1)}else console.warn("uiconfig-tweakpane: Failed to load texture",tt)})}CustomContextMenu.Remove()},cancel:()=>{CustomContextMenu.Remove()}},2,ce.height+8);(O=ne.parentElement)===null||O===void 0||O.appendChild(Oe),ce.y>.7*document.body.clientHeight&&(Oe.style.top="auto",Oe.style.bottom=ce.height+8+"px")}),u.view="input-image",tpInputGenerator(o,l,c,u)};var tpTheme=__webpackgi_require__(367),tpTheme_exported={};tpTheme.A&&tpTheme.A.locals&&(tpTheme_exported.locals=tpTheme.A.locals);var tpTheme_refs=0,tpTheme_update,tpTheme_options={};tpTheme_options.styleTagTransform=styleTagTransform_default(),tpTheme_options.setAttributes=setAttributesWithoutAttributes_default(),tpTheme_options.insert=function(d,o){(o.target||document.head).appendChild(d)},tpTheme_options.domAPI=styleDomAPI_default(),tpTheme_options.insertStyleElement=insertStyleElement_default(),tpTheme_exported.use=function(d){return tpTheme_options.options=d||{},tpTheme_refs++||(tpTheme_update=injectStylesIntoStyleTag_default()(tpTheme.A,tpTheme_options)),tpTheme_exported},tpTheme_exported.unuse=function(){tpTheme_refs>0&&!--tpTheme_refs&&(tpTheme_update(),tpTheme_update=null)};var ui_tpTheme=tpTheme_exported,TweakpaneUiPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let TweakpaneUiPlugin$1=class extends TweakpaneWrapper{constructor(o=!1,l=!1,c=!1,u,h){var _,A;super(o,l,c,!1,(_=u??document.getElementById("tweakpaneMainPanelSlot"))!==null&&_!==void 0?_:document.body),this.dependencies=[AssetManagerPlugin],this._preRender=()=>this.refreshQueue("preRender"),this._postRender=()=>this.refreshQueue("postRender"),this._postFrame=w=>{this.dispatchEvent(w),this.refreshQueue("postFrame")},this._preFrame=()=>this.refreshQueue("preFrame"),this._plugins=[],this._pane.registerPlugin(tweakpane_image_plugin),ui_tpTheme.use({target:this._container}),this.colorMode=(A=h??(localStorage?localStorage.getItem("tpTheme"):"blue"))!==null&&A!==void 0?A:"blue"}async onAdded(o){this._viewer=o,this._typeGenerators.image=tpImageInputGenerator(this._viewer),o.addEventListener("preRender",this._preRender),o.addEventListener("postRender",this._postRender),o.addEventListener("preFrame",this._preFrame),o.addEventListener("postFrame",this._postFrame)}async onDispose(o){this.dispose()}async onRemove(o){this._viewer=void 0,o.removeEventListener("preRender",this._preRender),o.removeEventListener("postRender",this._postRender),o.removeEventListener("preFrame",this._preFrame),o.removeEventListener("postFrame",this._postFrame),this.dispose()}setupPluginUi(o){var l;const c=(l=this._viewer)===null||l===void 0?void 0:l.getPlugin(o);if(!c)return void console.warn("plugin not found:",o);this._plugins.push(c),c.uiConfig&&(c.uiConfig.limitedUi=!0),c.uiConfig&&c.uiConfig.hidden===void 0&&(c.uiConfig.hidden=!1),this._appendUiObject(c);const u=c.uiConfig;if(u!=null&&u.uiRef&&c.toJSON){const h=typeof c.toJSON=="function"?c.toJSON():null;c.resetDefaults=async()=>{var w,C;await((w=c.fromJSON)===null||w===void 0?void 0:w.call(c,h)),(C=u.uiRefresh)===null||C===void 0||C.call(u,"postFrame",!0)};const _=u.uiRef.controller_.view.element,A=ee({innerHTML:"&#8942;",classList:["pluginOptionsButton"],elementTag:"button"});A.onclick=w=>{const C={};typeof c.toJSON=="function"&&(C["download preset"]=async()=>{var O,ne;const ce=(ne=(O=this._viewer)===null||O===void 0?void 0:O.getPlugin(AssetManagerPlugin))===null||ne===void 0?void 0:ne.exportPluginPreset(c);await N(new Blob([JSON.stringify(ce,null,2)],{type:"application/json"}),"preset."+c.constructor.PluginType+".json"),CustomContextMenu.Remove()}),typeof c.fromJSON=="function"&&(C["upload preset"]=async()=>{var O,ne,ce;CustomContextMenu.Remove();const ue=await ge(!1,!1);if(ue.length===0)return;const ye=ue[0],Oe=await ye.text(),ke=JSON.parse(Oe);await((ne=(O=this._viewer)===null||O===void 0?void 0:O.getPlugin(AssetManagerPlugin))===null||ne===void 0?void 0:ne.importPluginPreset(ke,c)),(ce=u.uiRefresh)===null||ce===void 0||ce.call(u,"postFrame",!0)},h&&(C["reset defaults"]=async()=>{var O,ne;CustomContextMenu.Remove(),await((ne=(O=c).resetDefaults)===null||ne===void 0?void 0:ne.call(O))}));const M=CustomContextMenu.Create(C,_.clientWidth-120,12);_.append(M),w.preventDefault()},_.appendChild(A)}return u}setupPlugins(...o){o.forEach(l=>this.setupPluginUi(l))}refreshPluginsEnabled(){this._plugins.forEach(o=>{var l;const c=o.uiConfig;c&&(Ee(c.hidden)!==!0?(l=c.uiRefresh)===null||l===void 0||l.call(c,"postFrame",!0):c.uiRef&&(c.uiRef.hidden=!0))})}async alert(o){return this._viewer?this._viewer.alert(o):super.alert(o)}async confirm(o){return this._viewer?this._viewer.confirm(o):super.confirm(o)}async prompt(o,l,c=!0){return this._viewer?this._viewer.prompt(o,l,c):super.prompt(o,l,c)}_colorModeChanged(){document.body.classList.remove("tpTheme-black","tpTheme-white","tpTheme-blue"),document.body.classList.add("tpTheme-"+this.colorMode),localStorage&&localStorage.setItem("tpTheme",this.colorMode)}};TweakpaneUiPlugin$1.PluginType="TweakpaneUi",TweakpaneUiPlugin_decorate([x(TweakpaneUiPlugin$1.prototype._colorModeChanged)],TweakpaneUiPlugin$1.prototype,"colorMode",void 0);class SimpleBackgroundEnvUiPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.toJSON=void 0,this._savedBg=!1,this.lastBgVal=null,this.uiConfig={label:"Background / Environment",type:"folder",expanded:!1,limitedUi:!0,children:[{label:"Color",type:"color",inlinePicker:!0,property:[this,"sceneBackgroundColor"],limitedUi:!0},()=>({label:"Image",property:[this,"sceneBackground"],type:"image",limitedUi:!0}),{label:"EnvMap BG",type:"checkbox",property:[this,"envmapBg"]},()=>({type:"slider",label:"BG Intensity",getValue:()=>{var o,l;return(l=(o=this._viewer)===null||o===void 0?void 0:o.scene.backgroundIntensity)!==null&&l!==void 0?l:1},setValue:o=>{this._viewer&&(this._viewer.scene.backgroundIntensity=o)},bounds:[0,16]}),{label:"Set Transparent BG",type:"button",hidden:()=>!this._viewer||this._viewer.useRgbm,value:()=>{this._viewer&&(this._viewer.scene.background=null,this._viewer.scene.backgroundColor=null)}},()=>({label:"Environment",getValue:()=>{var o;return((o=this._viewer)===null||o===void 0?void 0:o.scene.environment)||null},setValue:o=>{this._viewer&&(this._viewer.scene.environment=o)},type:"image",limitedUi:!0}),{type:"slider",label:"Env Rotation",getValue:()=>{var o,l,c;return(c=(l=(o=this._viewer)===null||o===void 0?void 0:o.scene.environment)===null||l===void 0?void 0:l.rotation)!==null&&c!==void 0?c:0},setValue:o=>{var l,c;const u=(l=this._viewer)===null||l===void 0?void 0:l.scene.environment;u&&(u.rotation=o,(c=this._viewer)===null||c===void 0||c.scene.setDirty())},bounds:[0,2*Math.PI],limitedUi:!0},{type:"slider",label:"Env Intensity",getValue:()=>{var o,l;return(l=(o=this._viewer)===null||o===void 0?void 0:o.scene.envMapIntensity)!==null&&l!==void 0?l:1},setValue:o=>{var l;!((l=this._viewer)===null||l===void 0)&&l.scene&&(this._viewer.scene.envMapIntensity=o)},bounds:[0,4],limitedUi:!0},()=>({label:"Environment1",getValue:()=>{var o;return((o=this._viewer)===null||o===void 0?void 0:o.scene.textureSlots.environment1)||null},setValue:o=>{this._viewer&&(o.mapping===three_module.UTZ&&(o.mapping=three_module.wfO,o.needsUpdate=!0),this._viewer.scene.textureSlots.environment1=o)},type:"image"}),{type:"slider",label:"Env1 Rotation",hidden:()=>{var o;return!(!((o=this._viewer)===null||o===void 0)&&o.scene.textureSlots.environment1)},getValue:()=>{var o,l,c;return(c=(l=(o=this._viewer)===null||o===void 0?void 0:o.scene.textureSlots.environment1)===null||l===void 0?void 0:l.rotation)!==null&&c!==void 0?c:0},setValue:o=>{var l,c;const u=(l=this._viewer)===null||l===void 0?void 0:l.scene.textureSlots.environment1;u&&(u.rotation=o,(c=this._viewer)===null||c===void 0||c.scene.setDirty())},bounds:[0,2*Math.PI]},{type:"checkbox",label:"Fixed Env Direction",getValue:()=>{var o,l;return(l=(o=this._viewer)===null||o===void 0?void 0:o.scene.fixedEnvMapDirection)!==null&&l!==void 0&&l},setValue:o=>{this._viewer&&(this._viewer.scene.fixedEnvMapDirection=o)}}]}}get sceneBackgroundColor(){var o,l;const c=(l=(o=this._viewer)===null||o===void 0?void 0:o.scene.backgroundColor)===null||l===void 0?void 0:l.getHex(three_module.er$);return c!==void 0&&(this._savedBg=!0),c||0}set sceneBackgroundColor(o){this._viewer&&this._savedBg&&(this._viewer.scene.backgroundColor||(this._viewer.scene.backgroundColor=new three_module.Q1f),this._viewer.scene.backgroundColor.setHex(o),this._viewer.scene.setDirty())}get sceneBackground(){var o;const l=(o=this._viewer)===null||o===void 0?void 0:o.scene.background;return l&&(l.isTexture||l.assetType==="texture")?l:null}set sceneBackground(o){this._viewer&&(this._viewer.scene.background=o)}get envmapBg(){var o,l,c;return((o=this._viewer)===null||o===void 0?void 0:o.scene.background)==="environment"||((l=this._viewer)===null||l===void 0?void 0:l.scene.background)===((c=this._viewer)===null||c===void 0?void 0:c.scene.environment)}set envmapBg(o){if(this._viewer)if(o){const l=this._viewer.scene.background;l&&l!==this._viewer.scene.environment&&l!=="environment"&&(this.lastBgVal=l),this._viewer.scene.background="environment"}else this._viewer.scene.background!==this._viewer.scene.environment&&this._viewer.scene.background!=="environment"||(this._viewer.scene.background=this.lastBgVal)}async onAdded(o){await super.onAdded(o),this.lastBgVal=o.scene.background,o.scene.addEventListener("backgroundChanged",()=>{var l,c;(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0)}),o.scene.addEventListener("environmentChanged",()=>{var l,c;(c=(l=this.uiConfig).uiRefresh)===null||c===void 0||c.call(l,"postFrame",!0)})}}SimpleBackgroundEnvUiPlugin.PluginType="SimpleBackgroundEnvUiPlugin1";class SimpleViewerUi extends AViewerPlugin{constructor(){super(),this.enabled=!0,this.toJSON=void 0,this._uiConfig={type:"folder",label:"Scene",children:[],onExpand:()=>{var o,l;(l=(o=this._uiConfig).uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0)}},this._clearSceneButton={type:"button",label:"Clear Scene",value:()=>{var o;(o=this._viewer)===null||o===void 0||o.scene.disposeSceneModels()}},this._sceneUpdate=this._sceneUpdate.bind(this)}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("sceneUpdate",this._sceneUpdate)}async onRemove(o){return o.scene.removeEventListener("sceneUpdate",this._sceneUpdate),super.onRemove(o)}setDirty(){var o;(o=this._viewer)===null||o===void 0||o.setDirty()}get uiConfig(){return this._viewer?(this._uiConfig.children=[this._clearSceneButton],this._uiConfig):this._uiConfig}_sceneUpdate(){}}SimpleViewerUi.PluginType="SimpleUi";var tree=__webpackgi_require__(530),tree_default=__webpackgi_require__.n(tree),treejs=tree_default();class HierarchyUiPlugin extends AViewerPlugin{constructor(o=!0){super(),this.enabled=!0,this.toJSON=void 0,this.treeView=void 0,this.hierarchyDiv=ee({innerHTML:"",id:"tpHierarchyContainer",addToBody:!1}),this._resetting=!1,this._uiConfig={type:"folder",label:"Hierarchy",children:[]},this._buildData=(l,c)=>(l.push({text:c.name||"unnamed",id:c.uuid,children:c.children.reduce(this._buildData,[])}),l),this._findVisible=(l,c)=>(c.visible&&(c.children.length<1?l.push(c.uuid):l.push(...c.children.reduce(this._findVisible,[]))),l),this._setVisible=l=>{var c;(c=this._viewer)===null||c===void 0||c.doOnce("postFrame",()=>{var u,h,_;const A=(u=this._viewer)===null||u===void 0?void 0:u.scene.modelRoot;if(!A||l==null)return;const w=new Set;A.traverse(C=>{C!==A&&(C.visible=l.includes(C.uuid),C.visible&&C.traverseAncestors(M=>w.add(M)))}),w.forEach(C=>C.visible=!0),(_=(h=this._viewer)===null||h===void 0?void 0:h.scene)===null||_===void 0||_.setDirty({sceneUpdate:!0,fromHierarchyPlugin:!0,updateGround:!1})})},this.enabled=o,this.reset=this.reset.bind(this),P($`
#tpHierarchyContainer{
  width: 100%;
  height: auto;
  background-color: transparent;
  color: var(--tp-container-foreground-color, hsl(230, 7%, 75%));
  margin-top: 0;
}
.treejs .treejs-switcher:before {
    border-top: 6px solid var(--tp-container-foreground-color, hsl(230, 7%, 75%)) !important;
}
        `)}_reset(o){var l;if(o!=null&&o.fromHierarchyPlugin||o&&!o.hierarchyChanged)return;for(;this.hierarchyDiv.firstChild;)this.hierarchyDiv.firstChild.remove();const c=(l=this._viewer)===null||l===void 0?void 0:l.scene.modelRoot;if(!c)return;const u=c.children.reduce(this._buildData,[]),h=c.children.reduce(this._findVisible,[]);let _=!1;return new Promise((A,w)=>{this.treeView=new treejs(this.hierarchyDiv,{closeDepth:1,data:u,loaded:function(){this.values=h,A()},onChange:()=>{_?X(200).then(()=>{this.treeView&&this._setVisible(this.treeView.values)}):_=!0},onItemLabelClick:C=>{var M;const O=(M=this._viewer)===null||M===void 0?void 0:M.scene.modelRoot.modelObject.getObjectByProperty("uuid",C);O&&c.visible&&O.dispatchEvent({type:"select",value:O,ui:!0})}})})}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("sceneUpdate",this.reset),await this.reset()}async reset(o){this._resetting||(this._resetting=!0,await X(500),await this._reset(o),this._resetting=!1)}async onRemove(o){return o.scene.removeEventListener("sceneUpdate",this.reset),super.onRemove(o)}async onDispose(o){return super.onDispose(o)}get uiConfig(){return this._uiConfig.domChildren||(this._uiConfig.domChildren=[this.hierarchyDiv]),this._uiConfig}}HierarchyUiPlugin.PluginType="HierarchyUiPlugin";class LightsUiPlugin extends AViewerPlugin{constructor(){super(),this.toJSON=void 0,this.enabled=!0,this.uiConfig={type:"folder",label:"Lights",children:[{type:"button",label:"Add Directional Light",value:()=>{if(!this._viewer)return;const o=new DirectionalLight2;o.position.set(0,0,0),o.target.position.set(0,0,-1).normalize(),o.intensity=2,o.shadow.mapSize.set(1024,1024),this._viewer.scene.addLight(o)}},{type:"button",label:"Add Ambient Light",value:()=>{if(!this._viewer)return;const o=new AmbientLight2;o.intensity=2,this._viewer.scene.addLight(o)}},{type:"button",label:"Add Point Light",value:()=>{if(!this._viewer)return;const o=new PointLight2;o.position.set(3,3,3),o.shadow.mapSize.set(1024,1024),o.intensity=2,this._viewer.scene.addLight(o)}},{type:"button",label:"Add Spot Light",value:()=>{if(!this._viewer)return;const o=new SpotLight2;o.position.set(3,3,3),o.shadow.mapSize.set(1024,1024),o.intensity=2,o.lookAt(0,0,0),this._viewer.scene.addLight(o)}}],limitedUi:!0},this.dependencies=[AssetManagerPlugin],this._sceneUpdate=o=>{var l,c,u;if(!o.hierarchyChanged)return;const h=[];(l=this._viewer)===null||l===void 0||l.traverseSceneObjects(_=>{if(!_.lightObject)return;const A=_.uiConfig;A&&!h.includes(A)&&h.push(A)}),[...this.uiConfig.children].forEach(_=>{(_==null?void 0:_.type)==="button"||h.includes(_)||this.uiConfig.children.splice(this.uiConfig.children.indexOf(_),1)}),h.forEach(_=>{this.uiConfig.children.includes(_)||this.uiConfig.children.push(_)}),(u=(c=this.uiConfig).uiRefresh)===null||u===void 0||u.call(c,"postFrame",!0)}}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("sceneUpdate",this._sceneUpdate)}async onRemove(o){return o.scene.removeEventListener("sceneUpdate",this._sceneUpdate),super.onRemove(o)}}LightsUiPlugin.PluginType="SimpleLightsUi";class SceneCamerasUiPlugin extends AViewerPlugin{constructor(){super(),this.toJSON=void 0,this.enabled=!0,this.uiConfig={type:"folder",label:"Cameras (Loaded)",children:[{type:"button",label:"Add Camera",value:()=>{var o;if(!this._viewer)return;const l=this._viewer.createCamera(new three_module.ubm(45,1,.5,20));this._viewer.scene.modelRoot.add(l.cameraObject),l.setCameraOptions({controlsMode:"orbit"}),l.position.set(2,2,2),l.target.set(0,0,0),l.positionUpdated(!0),l.cameraObject.lookAt(0,0,0),l.setDirty();const c=this._viewer.getPluginByType("VirtualCamerasPlugin");if(c){const u=c.addCamera(l),h=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("debug");h&&h.addTexture("camera frame",()=>u.target.texture,[40,310,300,200])}}}],limitedUi:!0},this.dependencies=[AssetManagerPlugin],this._sceneUpdate=o=>{var l,c,u;if(!o.hierarchyChanged)return;const h=[];(l=this._viewer)===null||l===void 0||l.traverseSceneObjects(_=>{if(!_.cameraObject)return;const A=_.uiConfig;A&&!h.includes(A)&&h.push(A)}),[...this.uiConfig.children].forEach(_=>{(_==null?void 0:_.type)==="button"||h.includes(_)||this.uiConfig.children.splice(this.uiConfig.children.indexOf(_),1)}),h.forEach(_=>{this.uiConfig.children.includes(_)||this.uiConfig.children.push(_)}),(u=(c=this.uiConfig).uiRefresh)===null||u===void 0||u.call(c,"postFrame",!0)}}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("sceneUpdate",this._sceneUpdate)}async onRemove(o){return o.scene.removeEventListener("sceneUpdate",this._sceneUpdate),super.onRemove(o)}}SceneCamerasUiPlugin.PluginType="SimpleSceneCamerasUi";var RendererUiPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},RendererUiPlugin_1;let RendererUiPlugin=RendererUiPlugin_1=class extends AViewerPlugin{constructor(){super(),this.enabled=!0,this._serializeVersion=1,this.mode="full",this.width=0,this.height=0,this.scale=1,this._sizeChanged=this._sizeChanged.bind(this),this._refresh=this._refresh.bind(this),this.refreshSize=this.refreshSize.bind(this)}refreshSize(){var d;this._sizeChanged(),(d=this._viewer)===null||d===void 0||d.setDirty()}_sizeChanged(d=!0){if(!this._viewer)return;if(this.mode==="full")return this._viewer.setSize({}),this._setScale(this.scale),void this._refresh();const o={width:Math.floor(this.width),height:Math.floor(this.height)},l=this._viewer.container.getBoundingClientRect(),c={width:Math.floor(l.width),height:Math.floor(l.height)};let u=1;if(o.width>c.width){const h=o.width;o.width=c.width;const _=o.width/h;if(o.height=Math.floor(o.height*_),u/=_,u>RendererUiPlugin_1.MaxCanvasScale)return this.width=c.width*RendererUiPlugin_1.MaxCanvasScale,console.log("loop",this.width,c.width,u),void this._sizeChanged()}if(o.height>c.height){const h=o.height;o.height=c.height;const _=o.height/h;if(o.width=Math.floor(o.width*_),u/=_,u>RendererUiPlugin_1.MaxCanvasScale)return this.height=c.height*RendererUiPlugin_1.MaxCanvasScale,console.log("loop",this.width,c.width,this.height,c.height,u),void this._sizeChanged()}(o.width>=c.width||o.width<1)&&delete o.width,(o.height>=c.height||o.height<1)&&delete o.height,this._viewer.setSize(o),this._setScale(u),d&&(this.scale=u),this._refresh()}_setScale(d){this._viewer&&(this._viewer.renderer.displayCanvasScaling=d)}_scaleChanged(){if(!this._viewer)return;const d=this.scale;if(Math.abs(d-this._viewer.renderer.displayCanvasScaling)<.01)return;if(this.mode==="full")return void this._sizeChanged();const o=this.width/this.height,l=this._viewer.container.getBoundingClientRect(),c=Math.floor(l.width*d),u=Math.floor(c/o);this.width=c,this.height=u,this._sizeChanged(!1)}async onAdded(d){await super.onAdded(d);const o=d.canvas.clientWidth,l=d.canvas.clientHeight,c=d.renderer.displayCanvasScaling;this.width=o,this.height=l,this.scale=c,d.renderer.addEventListener("resize",this.refreshSize),this.addEventListener("deserialize",this.refreshSize),this._refresh()}async onRemove(d){return this.removeEventListener("deserialize",this.refreshSize),d.renderer.removeEventListener("resize",this.refreshSize),super.onRemove(d)}_refresh(){var d,o;(o=(d=this.uiConfig)===null||d===void 0?void 0:d.uiRefresh)===null||o===void 0||o.call(d,"postFrame",!0)}fromJSON(d,o){if(!d.mode)if(d.width||d.height){const l=this._viewer.container.getBoundingClientRect();d.width||(d.width=l.width),d.height||(d.height=l.height),d.scale&&(d.width*=d.scale,d.height*=d.scale,delete d.scale),d.width=Math.round(d.width),d.height=Math.round(d.height),d.mode="custom"}else d.mode="full";return super.fromJSON(d,o)}toJSON(d){const o=super.toJSON(d);return o.mode==="full"&&(delete o.width,delete o.height),o.mode==="custom"&&delete o.scale,o}};RendererUiPlugin.PluginType="RendererParamsUiPlugin",RendererUiPlugin.MaxCanvasScale=5,RendererUiPlugin_decorate([serialize("version")],RendererUiPlugin.prototype,"_serializeVersion",void 0),RendererUiPlugin_decorate([serialize(),uiDropdown("Mode",["full","custom"].map(d=>({label:d}))),ze(RendererUiPlugin.prototype._sizeChanged)],RendererUiPlugin.prototype,"mode",void 0),RendererUiPlugin_decorate([serialize(),uiSlider("Width",void 0,1,d=>({onChange:()=>d._sizeChanged(),hidden:()=>d.mode==="full",bounds:()=>{var o;return[10,Math.pow(2,Math.ceil(Math.log2(((o=d._viewer)===null||o===void 0?void 0:o.container.getBoundingClientRect().width)||1024)+2))]}}))],RendererUiPlugin.prototype,"width",void 0),RendererUiPlugin_decorate([serialize(),uiSlider("Height",void 0,1,d=>({onChange:()=>d._sizeChanged(),hidden:()=>d.mode==="full",bounds:()=>{var o;return[10,Math.pow(2,Math.ceil(Math.log2(((o=d._viewer)===null||o===void 0?void 0:o.container.getBoundingClientRect().height)||1024)+2))]}}))],RendererUiPlugin.prototype,"height",void 0),RendererUiPlugin_decorate([serialize(),x(RendererUiPlugin.prototype._scaleChanged),uiSlider("Scale",[.25,RendererUiPlugin.MaxCanvasScale],.001,d=>({disabled:()=>d.mode==="custom"}))],RendererUiPlugin.prototype,"scale",void 0),RendererUiPlugin=RendererUiPlugin_1=RendererUiPlugin_decorate([uiFolder("Renderer")],RendererUiPlugin);class CameraUiPlugin extends AViewerPlugin{async onAdded(o){await super.onAdded(o),o.scene.addEventListener("activeCameraChange",this._refresh),o.scene.addEventListener("sceneUpdate",this._refresh)}async onRemove(o){return o.scene.removeEventListener("activeCameraChange",this._refresh),o.scene.removeEventListener("sceneUpdate",this._refresh),super.onRemove(o)}constructor(){super(),this.enabled=!0,this.serializeWithViewer=!1,this._refresh=this._refresh.bind(this)}toJSON(o){var l;const c=super.toJSON(o);return c.activeCamera=(l=this._viewer)===null||l===void 0?void 0:l.scene.activeCamera.toJSON(),c}fromJSON(o,l){var c;return o.activeCamera&&((c=this._viewer)===null||c===void 0||c.scene.activeCamera.fromJSON(o.activeCamera),delete(o={...o}).activeCamera),super.fromJSON(o,l)}_refresh(){var o,l;this._viewer&&((l=(o=this.uiConfig).uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0))}get uiConfig(){var o;return((o=this._viewer)===null||o===void 0?void 0:o.scene.activeCamera.uiConfig)||{}}}CameraUiPlugin.PluginType="CameraUiPlugin";let Button={create:d=>{let o="button"+(d.type?" "+d.type:""),l=utility.createDiv(o,d.text);return l.addEventListener("click",d.onClick),l}};var js_button=Button;let Utility={createElement:(d,o,l,c)=>{let u=document.createElement(d);if(o&&(u.className=o),l&&(u.innerHTML=l),c)for(let h in c)u.setAttribute(h,c[h]);return u},createDiv:(d,o,l)=>Utility.createElement("div",d,o,l),createDomTree:d=>{if(!d||!d.hasOwnProperty("dom"))return d;let o=d.dom;if(d.children)for(let l in d.children)d.children[l]&&o.appendChild(Utility.createDomTree(d.children[l]));return o},removeElement:d=>{d!=null&&d.parentNode.removeChild(d)},appendToBody:d=>{document.body.appendChild(d)},makeIconHTML:d=>{let o="";return d=="ok"&&(o="#tick"),d=="error"&&(o="#cancel"),d=="info"&&(o="#info-button"),d=="caution"&&(o="#danger"),d=="min"&&(o="#line"),d=="close"&&(o="#close"),`<svg class="icon ${d}"><use xlink:href="${o}" /></svg>`},makeNftContent:d=>{let o=null;if(d.type){let l=null;l=typeof d.content=="string"?Utility.createDiv("inner-content",d.content):Utility.createDomTree({dom:Utility.createDiv("inner-content"),children:[d.content]}),o=d.type=="text"?Utility.createDomTree({dom:Utility.createDiv("content text"),children:[l]}):Utility.createDomTree({dom:Utility.createDiv("content"),children:[Utility.createDiv("state",Utility.makeIconHTML(d.type)),l]})}else typeof d.content=="string"&&(o=Utility.createDiv("content",d.content));return o},standardizeButtons:(d,o)=>{let l=[];if(o.buttons===void 0)return o.type!="caution"&&o.type!="info"||l.push({key:27,text:"Cancel",onClick:d.close.bind(d,"cancel")}),l.push({key:13,text:"OK",type:"main",onClick:d.close.bind(d,"ok")}),l;l=o.buttons,l.constructor!==Array&&(l=[l]);for(let c in l)!l[c].onClick&&(l[c].onClick=d.close.bind(d,l[c].id));return l},makeButtons:d=>{let o=[];if(d)for(let l in d)o.push(js_button.create({text:d[l].text?d[l].text:"OK",type:d[l].normal?null:"main",onClick:d[l].onClick}));return Utility.createDomTree({dom:Utility.createDiv("button-wrapper"),children:o})},bindButtonKeyEvents:d=>{let o=l=>{for(let c in d)if(d[c].key===l.keyCode)return void d[c].onClick()};return window.addEventListener("keydown",o),o},unbindButtonKeyEvents:d=>{window.removeEventListener("keydown",d)}};var utility=Utility,animator=__webpackgi_require__(333);let frames_frames={"wwise-overlay-in-1":{opacity:"0"},"wwise-overlay-in-2":{opacity:"1"},"wwise-overlay-out-1":{opacity:"0"},"wwise-pop-in-1":{transform:"scale(0.5, 0.5)","margin-top":"50px",opacity:".5"},"wwise-pop-in-2":{transform:"scale(1, 1)","margin-top":"0",opacity:"1"},"wwise-pop-in-3":{transform:"scale(1.05, 1.05)"},"wwise-pop-in-4":{transform:"scale(1, 1)"},"wwise-pop-out-1":{transform:"scale(0.25, 0.25)","margin-top":"50px",opacity:"0"},"wwise-flip-in-1":{transform:"rotateX(60deg) scaleX(.5)",opacity:".2"},"wwise-flip-in-2":{transform:"none",opacity:"1"},"wwise-flip-out-1":{transform:"rotateX(60deg) scaleX(.5)",opacity:"0"},"wwise-top-in-1":{transform:"translateY(-30vh)",opacity:".5"},"wwise-top-in-2":{transform:"none",opacity:"1"},"wwise-top-out-1":{transform:"translateY(-30vh)",opacity:"0"},"wwise-bottom-in-1":{transform:"translateY(30vh)",opacity:".5"},"wwise-bottom-in-2":{transform:"none",opacity:"1"},"wwise-bottom-out-1":{transform:"translateY(30vh)",opacity:"0"},"wwise-left-in-1":{transform:"translateX(-30vw)",opacity:".5"},"wwise-left-in-2":{transform:"none",opacity:"1"},"wwise-left-out-1":{transform:"translateX(-30vw)",opacity:"0"},"wwise-right-in-1":{transform:"translateX(30vw)",opacity:".5"},"wwise-right-in-2":{transform:"none",opacity:"1"},"wwise-right-out-1":{transform:"translateX(30vw)",opacity:"0"},"wwise-min-in-1":{"margin-top":"0",transform:"rotateX(-60deg) scale(0.2, 1.8) translateY(80vh)",opacity:".2"},"wwise-min-in-2":{transform:"none",opacity:"1"},"wwise-min-out-1":{"margin-top":"30vh",transform:"rotateX(-60deg) scale(0.05, 2) translateY(30vh)",opacity:"0"}};var js_frames=frames_frames;let animation_Animation={};animation_Animation.overlay_in=[new animator.Frame(js_frames["wwise-overlay-in-1"],0),new animator.Frame(js_frames["wwise-overlay-in-2"],400)],animation_Animation.overlay_out=[new animator.Frame(js_frames["wwise-overlay-out-1"],300)],animation_Animation.pop_in=[new animator.Frame(js_frames["wwise-pop-in-1"],0),new animator.Frame(js_frames["wwise-pop-in-2"],{duration:200,"timing-function":"ease-in"}),new animator.Frame(js_frames["wwise-pop-in-3"],{duration:100,"timing-function":"linear"}),new animator.Frame(js_frames["wwise-pop-in-4"],{duration:100,"timing-function":"linear"})],animation_Animation.pop_out=[new animator.Frame(js_frames["wwise-pop-out-1"],{duration:250,"timing-function":"ease-in"})],animation_Animation.flip_in=[new animator.Frame(js_frames["wwise-flip-in-1"],0),new animator.Frame(js_frames["wwise-flip-in-2"],500)],animation_Animation.flip_out=[new animator.Frame(js_frames["wwise-flip-out-1"],400)],animation_Animation.min_in=[new animator.Frame(js_frames["wwise-min-in-1"],0),new animator.Frame(js_frames["wwise-min-in-2"],350)],animation_Animation.min_out=[new animator.Frame(js_frames["wwise-min-out-1"],400)];let dirs=["top","bottom","left","right"];for(let d in dirs){let o=dirs[d];animation_Animation[o+"_in"]=[new animator.Frame(js_frames["wwise-"+o+"-in-1"],0),new animator.Frame(js_frames["wwise-"+o+"-in-2"],{duration:400,"timing-function":"ease-out"})],animation_Animation[o+"_out"]=[new animator.Frame(js_frames["wwise-"+o+"-out-1"],{duration:400,"timing-function":"ease-in"})]}var js_animation=animation_Animation;let defaultOptions={animation:"pop",topbar:{showClose:!0,showMin:!1},keepOverlay:!1,position:"center",overlay:!1,clickOverlayToClose:!0,removeBackground:!1,noRadius:!1,zIndex:null};class Window{static create(o,l){let c=o.getElementsByClassName("title")[0];c&&(c=c.innerHTML);let u=o.getElementsByClassName("content")[0];return u&&(u=u.innerHTML),utility.removeElement(o),l.title=c,l.content=u,new Window(l)}constructor(o){this.options=JSON.parse(JSON.stringify(defaultOptions));for(let w in o)o[w]!=null&&(this.options[w]=o[w]);let l=this.options.position;if(l.indexOf(" ")==-1&&(l=="left"||l=="right"?l+=" center":l=l=="top"||l=="bottom"?"center "+l:l+" "+l),this.options.position=l,this.options.overlay){let w=document.getElementsByClassName("wwise-overlay");w.length?(this.overlay=w[0],this.hasOverlay=!0):(this.overlay=utility.createDiv("wwise-overlay"),this.options.zIndex&&(this.overlay.style.zIndex=this.options.zIndex)),this.overlayClickHandler=this.close.bind(this,void 0)}else this.options.clickOverlayToClose=!1;let c="content";if(this.options.topbar){let w=[];this.options.topbar.showMin&&(w.push(utility.createDiv(null,utility.makeIconHTML("min"))),w[w.length-1].addEventListener("click",this.min.bind(this))),this.options.topbar.showClose&&(w.push(utility.createDiv(null,utility.makeIconHTML("close"))),w[w.length-1].addEventListener("click",this.close.bind(this,void 0)));let C=null;C=typeof this.options.title=="string"?utility.createDiv("title",this.options.title):utility.createDomTree({dom:utility.createDiv("title"),children:[this.options.title]}),this.topbar=utility.createDomTree({dom:utility.createDiv("topbar"),children:[{dom:utility.createDiv("control"),children:w.map(M=>({dom:M}))},{dom:C},{dom:utility.createDiv("clear")}]})}else c+=" no-topbar";typeof this.options.content=="string"?this.content=utility.createDomTree({dom:utility.createDiv(c,this.options.content)}):this.content=utility.createDomTree({dom:utility.createDiv(c),children:[this.options.content]}),this.options.removeBackground&&(this.content.style.background="initial"),this.window=utility.createDomTree({dom:utility.createDiv("wwise"+(this.options.noRadius?" no-radius":"")),children:[this.topbar,this.content]});let u=utility.createDiv("wwise-wrapper");this.options.zIndex&&(u.style.zIndex=this.options.zIndex),this.wrapper=utility.createDomTree({dom:u,children:[this.window]}),this.dom=utility.createDomTree({dom:utility.createDiv(),children:[this.wrapper]});let h=this.options.position.split(" "),_=-50,A=-50;if(h[0]=="left"?(_=0,this.wrapper.classList.add("left")):h[0]=="right"?(_=-100,this.wrapper.classList.add("right")):h[0]=="center"?this.wrapper.classList.add("h-center"):this.wrapper.style.left=h[0],h[1]=="top"?(A=0,this.wrapper.classList.add("top")):h[1]=="bottom"?(A=-100,this.wrapper.classList.add("bottom")):h[1]=="center"?this.wrapper.classList.add("v-center"):this.wrapper.style.top=l[1],this.window.style.transform=`translate(${_}%, ${A}%)`,this.options.style)for(let w in this.options.style)this.window.style[w]=this.options.style[w];this.options.margin&&(this.wrapper.style.margin=this.options.margin),this.options.draggable&&this.draggable()}open(o){if(this.opened)return;this.promise=new Promise(c=>{this.promiseResolve=c}),this.appendDoms(),this.opened=!0,this.options.clickOverlayToClose&&(this.overlay.addEventListener("click",this.overlayClickHandler),this.overlay.addEventListener("touchstart",this.overlayClickHandler));let l=o?"min":this.options.animation;if(l){l!="min"&&l!="flip"||this.dom.classList.add("wwise-perspective");let c=[new animator.Queue(this.wrapper,js_animation[l+"_in"],{instant:!0,applyOnEnd:!0}).getPromise()];return this.options.overlay&&!this.hasOverlay&&c.push(new animator.Queue(this.overlay,js_animation.overlay_in,{instant:!0,applyOnEnd:!0}).getPromise()),Promise.all(c).then(()=>{this.dom.classList.remove("wwise-perspective")})}return Promise.resolve()}close(o){if(!this.opened)return;this.opened=!1;let l=o?"min":this.options.animation;if(this.overlay&&(this.overlay.removeEventListener("click",this.overlayClickHandler),this.overlay.removeEventListener("touchstart",this.overlayClickHandler)),l){l!="min"&&l!="flip"||this.dom.classList.add("wwise-perspective");let c=[new animator.Queue(this.wrapper,js_animation[l+"_out"],{instant:!0,applyOnEnd:!0}).getPromise()];return this.options.overlay&&!this.options.keepOverlay&&c.push(new animator.Queue(this.overlay,js_animation.overlay_out,{instant:!0,applyOnEnd:!0}).getPromise()),Promise.all(c).then(()=>{this.removeDoms(),this.dom.classList.remove("wwise-perspective"),this.promiseResolve()})}return this.removeDoms(),this.promiseResolve(),Promise.resolve()}min(){return this.close(!0)}resume(){return this.open(!0)}getPromise(){return this.promise}appendDoms(){this.options.overlay&&!this.hasOverlay&&(utility.appendToBody(this.overlay),document.body.classList.add("wwise-no-scroll"),this.overlay.addEventListener("touchstart",o=>{o.preventDefault()})),utility.appendToBody(this.dom)}removeDoms(){utility.removeElement(this.dom),!this.options.keepOverlay&&this.overlay&&(utility.removeElement(this.overlay),document.body.classList.remove("wwise-no-scroll"))}draggable(o=!0){this.topbar&&(o?(this.draggableMouseMoveHandler=this.handleDraggableMouseMove.bind(this),this.draggableMouseDownHandler=this.handleDraggableMouseDown.bind(this),this.draggableMouseUpHandler=this.handleDraggableMouseUp.bind(this),this.draggableMouseOutHandler=this.handleDraggableMouseOut.bind(this),window.addEventListener("mousemove",this.draggableMouseMoveHandler),window.addEventListener("mouseout",this.draggableMouseOutHandler),this.topbar.addEventListener("mousedown",this.draggableMouseDownHandler),window.addEventListener("mouseup",this.draggableMouseUpHandler)):(window.removeEventListener("mousemove",this.draggableMouseMoveHandler),window.removeEventListener("mouseout",this.draggableMouseOutHandler),this.topbar.removeEventListener("mousedown",this.draggableMouseDownHandler),window.removeEventListener("mouseup",this.draggableMouseUpHandler)))}handleDraggableMouseMove(o){if(this.inDragging){let l={x:o.clientX-this.dragPrev.x,y:o.clientY-this.dragPrev.y},c=window.getComputedStyle(this.wrapper),u=this.options.draggable,h=parseFloat(c.left),_=parseFloat(c.top);if(c.left.indexOf("%")!=-1){h=c.left,h=h.substr(0,h.length-1),h=parseInt(h);let A=window,w=document,C=w.documentElement,M=w.getElementsByTagName("body")[0];h=h*(A.innerWidth||C.clientWidth||M.clientWidth)/100}if(c.top.indexOf("%")!=-1){_=c.top,_=_.substr(0,_.length-1),_=parseInt(_);let A=window,w=document,C=w.documentElement,M=w.getElementsByTagName("body")[0];_=_*(A.innerHeight||C.clientHeight||M.clientHeight)/100}u!=1&&u!="horizontal"||(this.wrapper.style.left=h+l.x+"px"),u!=1&&u!="vertical"||(this.wrapper.style.top=_+l.y+"px"),this.dragPrev={x:o.clientX,y:o.clientY}}}handleDraggableMouseDown(o){this.inDragging=!0,this.dragPrev={x:o.clientX,y:o.clientY}}handleDraggableMouseUp(o){this.inDragging=!1}handleDraggableMouseOut(o){let l=o.relatedTarget;l&&l.nodeName!="HTML"||(this.inDragging=!1)}}var js_window=Window;class Modal{constructor(o){let l=this.options=o;!l.type&&(l.type="ok");let c={topbar:!1};c.content=this.constructContent({type:l.type,title:l.title,text:l.text,content:l.content,buttons:l.buttons}),c.overlay=!0,c.keepOverlay=l.keepOverlay,c.clickOverlayToClose=!1,c.animation=l.animation,c.zIndex=l.zIndex,this.wwise=new js_window(c)}constructContent(o){let l=utility.createDiv("modal"),c=utility.createDomTree({dom:utility.createDiv("main "+o.type),children:[utility.createDiv(null,utility.makeIconHTML(o.type)),utility.createDiv("title",o.title),utility.createDiv("text",o.text)]});this.buttonArr=utility.standardizeButtons(this,o);let u=utility.makeButtons(this.buttonArr),h=null;o.content&&(h=typeof o.content=="string"?utility.createDiv(null,o.content):o.content);let _=null;return u.innerHTML&&(_=utility.createDomTree({dom:utility.createDiv("operation "+o.type),children:[u]})),h||_||c.classList.add("no-op"),utility.createDomTree({dom:l,children:[c,h,_]})}open(){if(this.wwise.opened)return;let o=this.wwise.open();return this.value=void 0,this.promise=new Promise(l=>{this.promiseResolve=l}),this.wwise.getPromise().then(this.handlePromiseResolve.bind(this)),this.keyHandler=utility.bindButtonKeyEvents(this.buttonArr),this.options.closeAfter&&window.setTimeout(()=>{this.close("timer")},this.options.closeAfter),o}close(o){if(this.wwise.opened)return this.value=o,utility.unbindButtonKeyEvents(this.keyHandler),this.wwise.close()}getPromise(){return this.promise}handlePromiseResolve(){this.promiseResolve(this.value)}}var js_modal=Modal;let input_defaultOptions={showCancel:!1,okText:"OK",cancelText:"Cancel",placeholder:"",validator:null},defaultWwiseOptions={type:"info",keepOverlay:!1,title:"Input",text:"",zIndex:null};class Input{constructor(o){this.options=JSON.parse(JSON.stringify(input_defaultOptions));for(let h in o)o[h]!=null&&(this.options[h]=o[h]);let l=this.options,c=JSON.parse(JSON.stringify(defaultWwiseOptions));for(let h in c)l.hasOwnProperty(h)&&(c[h]=l[h]);let u=[];l.showCancel&&u.push({key:27,text:l.cancelText,normal:!0,onClick:this.handleCancel.bind(this)}),u.push({key:13,text:l.okText,onClick:this.handleOk.bind(this)}),c.buttons=u,this.input=utility.createElement("input","input",null,{placeholder:l.placeholder}),this.error=utility.createDiv("error"),c.content=utility.createDomTree({dom:utility.createDiv("input-wrapper"),children:[this.input,this.error]}),this.modal=new js_modal(c)}handleCancel(){this.close().then(this.promiseReject.bind(this))}handleOk(){this.options.validator?this.options.validator(this.input.value).then(()=>{this.close().then(this.promiseResolve.bind(this,this.input.value))},o=>{this.error.innerText=o}):this.close().then(this.promiseResolve.bind(this,this.input.value))}open(){if(this.modal.wwise.opened)return;let o=this.modal.open();return this.input.value="",this.error.innerText="",this.input.focus(),this.promise=new Promise((l,c)=>{this.promiseResolve=l,this.promiseReject=c}),o}close(){if(this.modal.wwise.opened)return this.modal.close()}getPromise(){return this.promise}}var input=Input,windowise=__webpackgi_require__(160),windowise_exported={};windowise.A&&windowise.A.locals&&(windowise_exported.locals=windowise.A.locals);var windowise_refs=0,windowise_update,windowise_options={};windowise_options.styleTagTransform=styleTagTransform_default(),windowise_options.setAttributes=setAttributesWithoutAttributes_default(),windowise_options.insert=function(d,o){(o.target||document.head).appendChild(d)},windowise_options.domAPI=styleDomAPI_default(),windowise_options.insertStyleElement=insertStyleElement_default(),windowise_exported.use=function(d){return windowise_options.options=d||{},windowise_refs++||(windowise_update=injectStylesIntoStyleTag_default()(windowise.A,windowise_options)),windowise_exported},windowise_exported.unuse=function(){windowise_refs>0&&!--windowise_refs&&(windowise_update(),windowise_update=null)};var ui_windowise=windowise_exported;class WindowiseDialogPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.toJSON=void 0,this._previousMappings={}}async onAdded(o){await super.onAdded(o),this._previousMappings={alert:o.alert,confirm:o.confirm,prompt:o.prompt},utility.appendToBody=l=>{l.style.zIndex="350",o.container.appendChild(l)},utility.makeIconHTML=l=>"",ui_windowise.use({target:o.container}),o.alert=async l=>{const c=l==null?void 0:l.split(":")[0],u=new js_modal({type:"info",title:c??"&ndsp;",text:(l==null?void 0:l.replace(c+":","").replace(/(\r?\n)/gm,"<br>"))||"",buttons:[{key:13,text:"OK",type:"main",id:"ok"}],animation:"overlay"});return u.open(),u.getPromise()},o.confirm=async l=>{const c=l==null?void 0:l.split(":")[0],u=new js_modal({type:"info",title:c??"&ndsp;",text:(l==null?void 0:l.replace(c||"","").replace(":",""))||"",buttons:[{id:"no",key:27,text:"No",normal:!0},{id:"yes",key:13,text:"Yes"}],animation:"overlay"});return u.open(),await u.getPromise()==="yes"},o.prompt=async(l,c,u=!0)=>{const h=l==null?void 0:l.split(":")[0],_=new input({type:"info",title:h??"&ndsp;",placeholder:c??"",showCancel:u,animation:"overlay",text:(l==null?void 0:l.replace(h||"","").replace(":",""))||""});return _.open(),await _.getPromise().catch(async()=>null)}}async onRemove(o){return o.alert=this._previousMappings.alert,o.confirm=this._previousMappings.confirm,o.prompt=this._previousMappings.prompt,super.onRemove(o)}}WindowiseDialogPlugin.PluginType="WindowiseDialogPlugin";var editorModes=__webpackgi_require__(757),editorModes_exported={};editorModes.A&&editorModes.A.locals&&(editorModes_exported.locals=editorModes.A.locals);var editorModes_refs=0,editorModes_update,editorModes_options={};editorModes_options.styleTagTransform=styleTagTransform_default(),editorModes_options.setAttributes=setAttributesWithoutAttributes_default(),editorModes_options.insert=function(d,o){(o.target||document.head).appendChild(d)},editorModes_options.domAPI=styleDomAPI_default(),editorModes_options.insertStyleElement=insertStyleElement_default(),editorModes_exported.use=function(d){return editorModes_options.options=d||{},editorModes_refs++||(editorModes_update=injectStylesIntoStyleTag_default()(editorModes.A,editorModes_options)),editorModes_exported},editorModes_exported.unuse=function(){editorModes_refs>0&&!--editorModes_refs&&(editorModes_update(),editorModes_update=null)};var ui_editorModes=editorModes_exported;function setupModesStyles(){ui_editorModes.use(),tippy_js_dist_tippy.use()}async function setupModesUi(d,o=void 0,l=[]){var c,u;tippy_esm.setDefaultProps({theme:"editor",duration:300,arrow:!0,appendTo:()=>d.container});const h=ee({classList:["mode-buttons-container","button-bar"],addToBody:!0}),_=ee({innerHTML:"",id:"webgi-logo",addToBody:!1});rt("logo-img")&&(_.style.backgroundImage=`url(${rt("logo-img")})`),_.onclick=()=>{window.open(rt("logo-link")||"https://webgi.xyz","_blank")};const A=`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
</svg>`;d.container.appendChild(_),tippy_esm(_,{placement:"right",content:"Powered by WebGi SDK"});const w=ee({innerHTML:A,id:"fsToggle",classList:["round-button"],addToBody:!1});w.dataset.tippyContent="Full-Screen",(c=d.getPlugin(FullScreenPlugin))===null||c===void 0||c.addEventListener("enter",()=>{w.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path d="M9 19L9 15M9 15L5 15M9 15L4 20M15 15L20 20M15 15V19M15 15H19M15 5V9M15 9L19 9M15 9L20 4M9 5L9 9M9 9L5 9M9 9L4 4" stroke-linecap="round" stroke-linejoin="round"/>
</svg>`,w.dataset.tippyContent="Exit Full-Screen"}),(u=d.getPlugin(FullScreenPlugin))===null||u===void 0||u.addEventListener("exit",()=>{w.innerHTML=A,w.dataset.tippyContent="Full-Screen"}),w.onclick=()=>{var ke;(ke=d.getPlugin(FullScreenPlugin))===null||ke===void 0||ke.toggle(d.container)},d.container.appendChild(w),tippy_esm(w,{placement:"left"});const C=ee({classList:["button-bar","util-buttons-container"],addToBody:!1});d.container.appendChild(C);const M=[{id:"reset-settings",icon:`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="currentColor" viewBox="0 0 24 24">
 <path fill="currentColor" d="M19 8L15 12H18C18 15.31 15.31 18 12 18C11 18 10.03 17.75 9.2 17.3L7.74 18.76C8.97 19.54 10.43 20 12 20C16.42 20 20 16.42 20 12H23M6 12C6 8.69 8.69 6 12 6C13 6 13.97 6.25 14.8 6.7L16.26 5.24C15.03 4.46 13.57 4 12 4C7.58 4 4 7.58 4 12H1L5 16L9 12M14 12C14 13.11 13.11 14 12 14S10 13.11 10 12 10.9 10 12 10 14 10.9 14 12Z" />
</svg>`,tooltip:"Reset All Settings",onclick:async()=>{var ke;if(!await d.confirm("Reset settings: Are you sure you want to reset all plugin settings?"))return;const Ve=ye.map(tt=>d.getPlugin(tt));for(const tt of Ve)await((ke=tt==null?void 0:tt.resetDefaults)===null||ke===void 0?void 0:ke.call(tt))}},{id:"clear-scene",icon:`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
 <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
</svg>`,tooltip:"Clear Scene",onclick:async()=>{await d.confirm("Clear scene: Are you sure you want to clear the scene?")&&d.scene.disposeSceneModels()}},{id:"fit-scene",icon:`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
    <path fill="currentColor" d="M17 12C17 7.55 11.62 5.31 8.46 8.46C5.31 11.61 7.55 17 12 17C14.76 17 17 14.76 17 12M12 15C9.33 15 8 11.77 9.88 9.88C11.77 8 15 9.33 15 12C15 13.66 13.66 15 12 15M5 15H3V19C3 20.1 3.9 21 5 21H9V19H5M5 5H9V3H5C3.9 3 3 3.9 3 5V9H5M19 3H15V5H19V9H21V5C21 3.9 20.1 3 19 3M19 19H15V21H19C20.1 21 21 20.1 21 19V15H19" />
</svg>`,tooltip:"Fit Object/Scene",onclick:async()=>{var ke;await d.fitToView((ke=d.getPlugin(PickingPlugin))===null||ke===void 0?void 0:ke.getSelectedObject())}},{id:"loop-cam-views",icon:`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="currentColor" viewBox="0 0 24 24">
 <path fill="currentColor" d="M19 8L15 12H18C18 15.31 15.31 18 12 18C11 18 10.03 17.75 9.2 17.3L7.74 18.76C8.97 19.54 10.43 20 12 20C16.42 20 20 16.42 20 12H23M6 12C6 8.69 8.69 6 12 6C13 6 13.97 6.25 14.8 6.7L16.26 5.24C15.03 4.46 13.57 4 12 4C7.58 4 4 7.58 4 12H1L5 16L9 12M14 12C14 13.11 13.11 14 12 14S10 13.11 10 12 10.9 10 12 10 14 10.9 14 12Z" />
</svg>`,tooltip:"Loop Camera Views",toggle:!0,onclick:async()=>{d.getPlugin(CameraViewPlugin)&&(d.getPlugin(CameraViewPlugin).viewLooping=!d.getPlugin(CameraViewPlugin).viewLooping)}},{id:"play-gltf",icon:`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
  <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>`,tooltip:"GLTF Animations",toggle:!0,onclick:async()=>{var ke;(ke=d.getPlugin(GLTFAnimationPlugin))===null||ke===void 0||ke.playPauseAnimation()}},{id:"auto-rotate-cc",icon:`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="currentColor" viewBox="0 0 24 24">
 <path fill="currentColor" d="M10,12L14,16L10,20V16.9C5.44,16.44 2,14.42 2,12C2,9.58 5.44,7.56 10,7.1V9.09C6.55,9.43 4,10.6 4,12C4,13.4 6.55,14.57 10,14.91V12M20,12C20,10.6 17.45,9.43 14,9.09V7.1C18.56,7.56 22,9.58 22,12C22,14.16 19.26,16 15.42,16.7L16.12,16L14.92,14.79C17.89,14.36 20,13.27 20,12M11,2H13V13L11,11V2M11,22V21L13,19V22H11Z" />
</svg>`,tooltip:"Auto rotate",toggle:!0,onclick:async()=>{const ke=d.scene.activeCamera.controls;ke&&ke.autoRotate!==void 0&&(ke.autoRotate=!ke.autoRotate)}},{id:"snapshot",icon:`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
  <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
</svg>`,tooltip:"Capture Snapshot",onclick:async()=>{const ke=d.getPlugin(CanvasSnipperPlugin);ke?await ke.downloadSnapshot():d.console.error("CanvasSnipperPlugin not added")}},{id:"glb-export",icon:`<svg xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
</svg>`,tooltip:"Export GLB",onclick:async()=>{const ke=d.getPlugin(AssetExporterPlugin);ke?await(ke==null?void 0:ke.downloadSceneGlb()):d.console.error("AssetExporterPlugin not added")}}];for(const ke of M){const Ve=ee({innerHTML:ke.icon,id:ke.id,classList:["button-bar-button","util-button"],addToBody:!1});Ve.dataset.tippyContent=ke.tooltip,Ve.onclick=()=>{ke.toggle&&Ve.classList.toggle("button-bar-selected-box"),ke.onclick()},C.appendChild(Ve)}createSingleton(tippy_esm(".util-button"),{moveTransition:"transform 0.2s ease-out",placement:"top"});const O=d.getPlugin(PickingPlugin),ne=d.getPlugin(InteractionPromptPlugin);for(const[ke,Ve]of Object.entries(o??{})){const tt=l.find(ht=>ht.title===ke);tt?tt.plugins.push(...Ve):l.push({title:ke,plugins:[...Ve]})}let ce=l[2],ue=[];const ye=l.reduce((ke,Ve)=>ke.concat(Ve.plugins),[]);function Oe(ke,Ve=!0){var tt;ce=ke,O&&(O.enabled=!0),ne&&(["Plugins"].includes(ce.title)?ne.enable("modesUi"):ne.disable("modesUi")),ue=[];for(const ht of ye){const ut=d.getPlugin(ht);if(!(ut!=null&&ut.uiConfig))continue;const _t=ke.plugins.includes(ht);S(ut.uiConfig,"hidden",!_t,!0),_t&&ue.push(ut)}for(const ht of l)(tt=ht.div)===null||tt===void 0||tt.classList[ce!==ht?"remove":"add"]("mode-button-selected","button-bar-selected");d.getPlugin(TweakpaneUiPlugin$1).refreshPluginsEnabled(),Ve&&window.dispatchEvent(new CustomEvent("webgi_editorModeChanged",{detail:{mode:ke}}))}for(const ke of l){const Ve=ee({innerHTML:ke.title,classList:["mode-button","button-bar-button"]});Ve.onclick=()=>{Oe(ke)},ke.div=Ve,h.appendChild(Ve)}Oe(l[0]),window.webgi_setEditorMode=Oe,window.webgi_editorModes=l,O==null||O.addEventListener("selectedObjectChanged",()=>{O!=null&&O.getSelectedObject()&&!["Picking","Modifiers","Configurators"].includes(ce.title)&&Oe(l.find(ke=>ke.plugins.includes(PickingPlugin)))})}class ExtrasUiPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.toJSON=void 0,this.showColorScheme=!0,this.uiConfig={type:"folder",label:"Extras",limitedUi:!1,children:[()=>this.showColorScheme?{label:"Color Scheme",type:"dropdown",children:["black","white","blue"].map(o=>({label:o})),getValue:()=>{var o,l;return(l=(o=this._viewer)===null||o===void 0?void 0:o.getPluginByType("TweakpaneUi"))===null||l===void 0?void 0:l.colorMode},setValue:o=>{var l;const c=(l=this._viewer)===null||l===void 0?void 0:l.getPluginByType("TweakpaneUi");c&&(c.colorMode=o)}}:void 0,()=>({label:"Shadow type",type:"dropdown",children:[["Basic",three_module.bTm],["PCF",three_module.QP0],["PCFSoft",three_module.Wk7],["VSM",three_module.RyA]].map(o=>({label:o[0],value:o[1]})),getValue:()=>{var o;return(o=this._viewer)===null||o===void 0?void 0:o.renderer.rendererObject.shadowMap.type},setValue:o=>{var l;(l=this._viewer)===null||l===void 0||l.doOnce("postFrame",()=>{this._viewer&&(this._viewer.renderer.rendererObject.shadowMap.type=o,this._viewer.renderer.resetShadows(),this._viewer.renderer.reset(),this._viewer.scene.setDirty({sceneUpdate:!0,frameFade:!1}),this._viewer.setDirty())})}}),()=>{var o;return{label:(!((o=this._viewer)===null||o===void 0)&&o.useRgbm?"Disable":"Enable")+" RGBM",type:"button",value:async()=>{var l,c;await((l=this._viewer)===null||l===void 0?void 0:l.confirm("Edit Extras: This will reload the webpage. Are you sure?"))&&st("rgbm",!((c=this._viewer)===null||c===void 0)&&c.useRgbm?"no":"yes",!0)}}},()=>{var o;return{label:(!((o=this._viewer)===null||o===void 0)&&o.isAntialiased?"Disable":"Enable")+" MSAA",type:"button",value:async()=>{var l,c;await((l=this._viewer)===null||l===void 0?void 0:l.confirm("Edit Extras: This will reload the webpage. Are you sure?"))&&st("msaa",!((c=this._viewer)===null||c===void 0)&&c.isAntialiased?"no":"yes",!0)}}},()=>{var o;return{label:(!((o=this._viewer)===null||o===void 0)&&o.useGBufferDepth?"Disable":"Enable")+" Depth(z) Prepass",type:"button",value:async()=>{var l,c;await((l=this._viewer)===null||l===void 0?void 0:l.confirm("Edit Extras: This will reload the webpage. Are you sure?"))&&st("depthPrepass",!((c=this._viewer)===null||c===void 0)&&c.useGBufferDepth?"no":"yes",!0)}}},()=>{var o;return{label:(!((o=this._viewer)===null||o===void 0)&&o.getPluginByType("debug")?"Disable":"Enable")+" Debug",type:"button",value:async()=>{var l,c;await((l=this._viewer)===null||l===void 0?void 0:l.confirm("Edit Extras: This will reload the webpage. Are you sure?"))&&st("debug",!((c=this._viewer)===null||c===void 0)&&c.getPluginByType("debug")?null:"true",!0)}}},{label:"Clear local storage",type:"button",value:async()=>{var o;await((o=this._viewer)===null||o===void 0?void 0:o.confirm("Edit Extras: This will clear all local storage. Are you sure?"))&&localStorage.clear()}},{label:"Clear caches",type:"button",value:async()=>{var o,l;const c=(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(AssetManagerPlugin))===null||l===void 0?void 0:l.storage;if(c instanceof Storage)c.clear();else if(c instanceof Cache){const u=await c.keys();await Promise.all(u.map(async h=>c.delete(h)))}localStorage.clear()}},{label:"Auto GPU instance all",type:"button",value:()=>{var o;const l=new Set;(o=this._viewer)===null||o===void 0||o.scene.modelRoot.traverse(c=>c.geometry&&l.add(c.geometry)),l.forEach(c=>autoGPUInstanceMeshes(c))}},{label:"Auto Center All Geometries",type:"button",value:()=>{var o;const l=new Set;(o=this._viewer)===null||o===void 0||o.scene.modelRoot.traverse(c=>c.geometry&&l.add(c.geometry)),l.forEach(c=>{const u=new three_module.Pq0;c.center(u),u.negate();const h=c.userData.__appliedMeshes;h||console.error("No meshes found for geometry",c),h==null||h.forEach(_=>{_.updateMatrix(),_.position.copy(u).applyMatrix4(_.matrix),_.setDirty&&_.setDirty()})})}}]}}}ExtrasUiPlugin.PluginType="ExtrasUiPlugin1";var AHelperWidget_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class AHelperWidget extends three_module.B69{constructor(o){super(),this.modelObject=this,this.assetType="widget",this.visible=!0,this.uiConfig=generateUiFolder("Widget",this),this.object=o,this.object.updateMatrixWorld(),this.object.updateProjectionMatrix&&this.object.updateProjectionMatrix(),this.matrix=o.matrixWorld,this.matrixAutoUpdate=!1,this._objectUpdate=this._objectUpdate.bind(this),this.attach(o),this.traverse(l=>{l.userData.__keepShadowDef=!0,l.castShadow=!1,l.receiveShadow=!1})}dispose(){this.detach()}_objectUpdate(){this.object&&this.update()}attach(o){var l,c;return this.object&&this.detach(),this.object=o,this.object&&(this.update(),this.object.addEventListener("objectUpdate",this._objectUpdate),this.object.addEventListener("dispose",this.dispose),this.uiConfig&&((c=(l=this.object.uiConfig)===null||l===void 0?void 0:l.children)===null||c===void 0||c.push(this.uiConfig)),this.visible=!0),this}detach(){var o,l,c,u;if(this.object){if(this.object.removeEventListener("objectUpdate",this._objectUpdate),this.object.removeEventListener("dispose",this.dispose),this.uiConfig){const h=(l=(o=this.object.uiConfig)===null||o===void 0?void 0:o.children)===null||l===void 0?void 0:l.indexOf(this.uiConfig);h!==void 0&&h>=0&&((u=(c=this.object.uiConfig)===null||c===void 0?void 0:c.children)===null||u===void 0||u.splice(h,1))}this.object=void 0,this.visible=!1}return this}}AHelperWidget_decorate([uiToggle()],AHelperWidget.prototype,"visible",void 0);class ALightHelperWidget extends AHelperWidget{constructor(o){super(o),this.light=o,this.traverse(l=>{l.userData.__keepShadowDef=!0,l.castShadow=!1,l.receiveShadow=!1})}}var DirectionalLightHelper2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class DirectionalLightHelper2 extends ALightHelperWidget{constructor(o,l,c){super(o),this.lineWidth=5,this.size=.5,this._v1=new three_module.Pq0,this._v2=new three_module.Pq0,this._v3=new three_module.Pq0,this.color=c,l!==void 0&&(this.size=l);let u=new LineGeometry;this.material=new LineMaterial({color:16711680,linewidth:.005,vertexColors:!1,dashed:!1,alphaToCoverage:!0,toneMapped:!1,transparent:!0,depthTest:!1,depthWrite:!1}),this.lightPlane=new Line2(u,this.material),this.add(this.lightPlane),u=new LineGeometry,u.setPositions([0,0,0,0,0,1]),this.targetLine=new Line2(u,this.material),this.add(this.targetLine),this.update(),this.traverse(h=>{h.userData.__keepShadowDef=!0,h.castShadow=!1,h.receiveShadow=!1})}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose(),super.dispose()}update(){var o;this.light&&this.lightPlane&&(this._v1.setFromMatrixPosition(this.light.matrixWorld),this._v2.setFromMatrixPosition(this.light.target.matrixWorld),this._v3.subVectors(this._v2,this._v1),this.lightPlane.geometry.setPositions([-this.size,this.size,0,this.size,this.size,0,this.size,-this.size,0,-this.size,-this.size,0,-this.size,this.size,0]),this.lightPlane.lookAt(this._v2),this.lightPlane.material=this.material,this.targetLine.material=this.material,this.material.color.set((o=this.color)!==null&&o!==void 0?o:this.light.color),this.material.linewidth=.001*this.lineWidth,this.targetLine.lookAt(this._v2),this.targetLine.scale.z=this.light.intensity/3)}static Check(o){return o.isDirectionalLight}static Create(o){return new DirectionalLightHelper2(o)}}DirectionalLightHelper2_decorate([x(DirectionalLightHelper2.prototype.update)],DirectionalLightHelper2.prototype,"material",void 0),DirectionalLightHelper2_decorate([x(DirectionalLightHelper2.prototype.update),uiSlider(void 0,[.1,20],.01)],DirectionalLightHelper2.prototype,"lineWidth",void 0),DirectionalLightHelper2_decorate([x(DirectionalLightHelper2.prototype.update),uiSlider(void 0,[.01,10],.01)],DirectionalLightHelper2.prototype,"size",void 0);var PointLightHelper2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class PointLightHelper2 extends ALightHelperWidget{constructor(o,l,c){super(o),this.lineWidth=5,this.size=.5,this.color=c,l!==void 0&&(this.size=l);const u=new WireframeGeometry2(new three_module.Gu$(.5,4,2));this.material=new LineMaterial({color:16711680,linewidth:.005,vertexColors:!1,dashed:!1,alphaToCoverage:!0,toneMapped:!1,transparent:!0,depthTest:!1,depthWrite:!1}),this.lightSphere=new Wireframe(u,this.material),this.lightSphere.computeLineDistances(),this.add(this.lightSphere),this.update(),this.traverse(h=>{h.userData.__keepShadowDef=!0,h.castShadow=!1,h.receiveShadow=!1})}dispose(){this.lightSphere.geometry.dispose(),this.lightSphere.material.dispose(),super.dispose()}update(){var o;this.light&&this.lightSphere&&(this.material.color.set((o=this.color)!==null&&o!==void 0?o:this.light.color),this.material.linewidth=.001*this.lineWidth,this.lightSphere.scale.setScalar(this.size))}static Check(o){return o.isPointLight}static Create(o){return new PointLightHelper2(o)}}PointLightHelper2_decorate([x(PointLightHelper2.prototype.update)],PointLightHelper2.prototype,"material",void 0),PointLightHelper2_decorate([x(PointLightHelper2.prototype.update),uiSlider(void 0,[.1,20],.01)],PointLightHelper2.prototype,"lineWidth",void 0),PointLightHelper2_decorate([x(PointLightHelper2.prototype.update),uiSlider(void 0,[.01,10],.01)],PointLightHelper2.prototype,"size",void 0);var SpotLightHelper2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class SpotLightHelper2 extends ALightHelperWidget{constructor(o,l,c){super(o),this.lineWidth=5,this._v1=new three_module.Pq0,this.color=c;let u=new LineSegmentsGeometry;const h=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let _=0,A=1,w=32;_<w;_++,A++){const C=_/w*Math.PI*2,M=A/w*Math.PI*2;h.push(Math.cos(C),Math.sin(C),1,Math.cos(M),Math.sin(M),1)}u.setPositions(h),this.material=new LineMaterial({color:16711680,linewidth:.005,vertexColors:!1,dashed:!1,alphaToCoverage:!0,toneMapped:!1,transparent:!0,depthTest:!1,depthWrite:!1}),this.cone=new LineSegments2(u,this.material),this.add(this.cone),u=new LineGeometry,u.setPositions([0,0,0,0,0,1]),this.update(),this.traverse(_=>{_.userData.__keepShadowDef=!0,_.castShadow=!1,_.receiveShadow=!1})}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose(),super.dispose()}update(){var o;if(!this.light||!this.cone)return;this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1);const l=this.light.distance?this.light.distance:1e3,c=l*Math.tan(this.light.angle);this.cone.scale.set(c,c,l),this._v1.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(this._v1),this.material.color.set((o=this.color)!==null&&o!==void 0?o:this.light.color),this.material.linewidth=.001*this.lineWidth}static Check(o){return o.isSpotLight}static Create(o){return new SpotLightHelper2(o)}}SpotLightHelper2_decorate([x(SpotLightHelper2.prototype.update)],SpotLightHelper2.prototype,"material",void 0),SpotLightHelper2_decorate([x(SpotLightHelper2.prototype.update),uiSlider(void 0,[.1,20],.01)],SpotLightHelper2.prototype,"lineWidth",void 0);class ACameraHelperWidget extends AHelperWidget{constructor(o){super(o),this.camera=o,this.traverse(l=>{l.userData.__keepShadowDef=!0,l.castShadow=!1,l.receiveShadow=!1})}}class CameraHelper2 extends ACameraHelperWidget{constructor(o){super(o),this._vector=new three_module.Pq0,this._camera=new three_module.i7d;const l=new LineSegmentsGeometry,c=new LineMaterial({color:16777215,linewidth:.005,vertexColors:!0,dashed:!1,alphaToCoverage:!0,toneMapped:!1,transparent:!0,depthTest:!1,depthWrite:!1}),{vertices:u,colors:h,pointMap:_}=generateVertices();l.setPositions(u),l.setColors(h),this.line=new LineSegments2(l,c),this.line.frustumCulled=!1,this.add(this.line),this.pointMap=_,this.update();const A=new three_module.Q1f(16755200),w=new three_module.Q1f(16711680),C=new three_module.Q1f(43775),M=new three_module.Q1f(16777215),O=new three_module.Q1f(3355443);this.setColors(A,w,C,M,O)}setColors(o,l,c,u,h){const _=this.line.geometry,A=_.getAttribute("instanceColorStart"),w=_.getAttribute("instanceColorEnd");function C(M,O){A.setXYZ(M/2,O.r,O.g,O.b),w.setXYZ(M/2,O.r,O.g,O.b)}C(0,o),C(2,o),C(4,o),C(6,o),C(8,o),C(10,o),C(12,o),C(14,o),C(16,o),C(18,o),C(20,o),C(22,o),C(24,l),C(26,l),C(28,l),C(30,l),C(32,c),C(34,c),C(36,c),C(38,u),C(40,h),C(42,h),C(44,h),C(46,h),C(48,h),A.needsUpdate=!0,w.needsUpdate=!0}update(){if(!this.camera)return;const o=this.line.geometry,l=this.pointMap,{_camera:c,_vector:u}=this;c.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),setPoint("c",l,o,c,0,0,-1,u),setPoint("t",l,o,c,0,0,1,u),setPoint("n1",l,o,c,-1,-1,-1,u),setPoint("n2",l,o,c,1,-1,-1,u),setPoint("n3",l,o,c,-1,1,-1,u),setPoint("n4",l,o,c,1,1,-1,u),setPoint("f1",l,o,c,-1,-1,1,u),setPoint("f2",l,o,c,1,-1,1,u),setPoint("f3",l,o,c,-1,1,1,u),setPoint("f4",l,o,c,1,1,1,u),setPoint("u1",l,o,c,.7,1.1,-1,u),setPoint("u2",l,o,c,-.7,1.1,-1,u),setPoint("u3",l,o,c,0,2,-1,u),setPoint("cf1",l,o,c,-1,0,1,u),setPoint("cf2",l,o,c,1,0,1,u),setPoint("cf3",l,o,c,0,-1,1,u),setPoint("cf4",l,o,c,0,1,1,u),setPoint("cn1",l,o,c,-1,0,-1,u),setPoint("cn2",l,o,c,1,0,-1,u),setPoint("cn3",l,o,c,0,-1,-1,u),setPoint("cn4",l,o,c,0,1,-1,u),o.getAttribute("instanceStart").needsUpdate=!0,o.getAttribute("instanceEnd").needsUpdate=!0,o.computeBoundingBox(),o.computeBoundingSphere()}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),super.dispose()}static Check(o){return o.isCamera}static Create(o){return new CameraHelper2(o)}}function setPoint(d,o,l,c,u,h,_,A){A.set(u,h,_).unproject(c);const w=o[d];if(w!==void 0){const C=l.getAttribute("instanceStart"),M=l.getAttribute("instanceEnd");for(let O=0,ne=w.length;O<ne;O++){const ce=Math.floor(w[O]/2);(w[O]%2==0?C:M).setXYZ(ce,A.x,A.y,A.z)}}}function generateVertices(){const d=[],o=[],l={};function c(h,_){u(h),u(_)}function u(h){d.push(0,0,0),o.push(0,0,0),l[h]===void 0&&(l[h]=[]),l[h].push(d.length/3-1)}return c("n1","n2"),c("n2","n4"),c("n4","n3"),c("n3","n1"),c("f1","f2"),c("f2","f4"),c("f4","f3"),c("f3","f1"),c("n1","f1"),c("n2","f2"),c("n3","f3"),c("n4","f4"),c("p","n1"),c("p","n2"),c("p","n3"),c("p","n4"),c("u1","u2"),c("u2","u3"),c("u3","u1"),c("c","t"),c("p","c"),c("cn1","cn2"),c("cn3","cn4"),c("cf1","cf2"),c("cf3","cf4"),{vertices:d,colors:o,pointMap:l}}var Object3DWidgetsPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class Object3DWidgetsPlugin extends AViewerPlugin{setDirty(){var o,l;(o=this.widgets)===null||o===void 0||o.forEach(c=>c.visible=this.enabled),(l=this._viewer)===null||l===void 0||l.setDirty()}constructor(o=!0){super(),this.enabled=!0,this.helpers=[DirectionalLightHelper2,SpotLightHelper2,PointLightHelper2,CameraHelper2],this.toJSON=null,this._addSceneObject=l=>{const c=l.object;this._createWidgets(c==null?void 0:c.modelObject)},this.widgets=[],this.uiConfig={type:"folder",label:"Widgets",children:[{type:"checkbox",label:"Visible",property:[this,"enabled"]},{type:"button",label:"Refresh",value:()=>this.refresh()}]},this.enabled=o}async onAdded(o){await super.onAdded(o),o.scene.addEventListener("addSceneObject",this._addSceneObject)}async onRemove(o){return o.scene.removeEventListener("addSceneObject",this._addSceneObject),this.widgets.forEach(l=>l.dispose&&l.dispose()),this.widgets=[],super.onRemove(o)}refresh(){var o;this._createWidgets((o=this._viewer)===null||o===void 0?void 0:o.scene.modelRoot)}_createWidgets(o){o==null||o.traverse(l=>{const c=this.widgets.find(h=>h.object===l);if(c)return void(c.update&&c.update());this.helpers.filter(h=>h.Check(l)).forEach(h=>{var _;const A=h.Create(l);A.visible=this.enabled,this.widgets.push(A),(_=this._viewer)===null||_===void 0||_.scene.addWidget(A)})})}}Object3DWidgetsPlugin.PluginType="WidgetsPlugin",Object3DWidgetsPlugin_decorate([x(Object3DWidgetsPlugin.prototype.setDirty)],Object3DWidgetsPlugin.prototype,"enabled",void 0);var popper_lite_defaultModifiers=[eventListeners,modifiers_popperOffsets,modifiers_computeStyles,modifiers_applyStyles],popper_lite_createPopper=popperGenerator({defaultModifiers:popper_lite_defaultModifiers}),object_hash=__webpackgi_require__(516),object_hash_default=__webpackgi_require__.n(object_hash);function removeDuplicateGeometries(d){const o=[];d.traverse(u=>{u.geometry&&o.push(u)});const l={},c={};o.forEach(u=>{var h;if(!l[u.geometry.uuid]){const w=u.geometry.toJSON().data,C=w?object_hash_default()({a:w.attributes||{},b:w.index||[]}):"";l[u.geometry.uuid]=C}const _=l[u.geometry.uuid],A=(h=c[_])!==null&&h!==void 0?h:c[_]=[];A.includes(u)||A.push(u)}),Object.values(c).forEach(u=>{if(u.length<2)return;const h=u[0].geometry;u.forEach((_,A)=>{A<1||(_.geometry.dispose(),_.geometry=h)})})}const offset2=new three_module.Pq0,targetDeltaX=new three_module.Pq0,targetDeltaY=new three_module.Pq0,targetDeltaZ=new three_module.Pq0,targetDelta=new three_module.Pq0,panOffset2=new three_module.Pq0;let scaleOffset=1;const upVec=new three_module.Pq0(0,1,0);class OrbitControls2 extends OrbitControls{constructor(o,l){super(o,l),this.throttleUpdate=60,this.targetOffset=new three_module.Pq0(0,0,0);const c=this.update;this.update=()=>this._update(c)}_update(o){this.target.add(this.targetOffset),offset2.copy(this.object.position).sub(this.target),scaleOffset=offset2.length(),panOffset2.copy(this.target);const l=o();return panOffset2.sub(this.target),offset2.copy(this.object.position).sub(this.target),scaleOffset/=offset2.length(),this.target.add(panOffset2),this.object.position.copy(this.target).add(offset2),offset2.normalize(),targetDeltaX.crossVectors(upVec,offset2).normalize(),targetDeltaY.crossVectors(offset2,targetDeltaX).normalize(),targetDeltaZ.crossVectors(targetDeltaX,targetDeltaY).normalize().negate(),targetDeltaX.length()>.1&&this.object.up.crossVectors(offset2.clone().normalize(),targetDeltaX),this.enablePan&&(targetDelta.set(0,0,0).addScaledVector(targetDeltaX,panOffset2.x).addScaledVector(targetDeltaY,panOffset2.y).addScaledVector(targetDeltaZ,panOffset2.z),this.targetOffset.add(targetDelta),this.targetOffset.multiplyScalar(1/scaleOffset)),targetDelta.set(0,0,0).addScaledVector(targetDeltaX,-this.targetOffset.x).addScaledVector(targetDeltaY,-this.targetOffset.y).addScaledVector(targetDeltaZ,-this.targetOffset.z),this.object.lookAt(targetDelta.add(this.target)),this.object.updateMatrixWorld(),this.object.isCamera&&this.object.updateProjectionMatrix(),this.target.sub(this.targetOffset),l}}const _raycaster=new three_module.tBo,_tempVector=new three_module.Pq0,_tempVector2=new three_module.Pq0,_tempQuaternion=new three_module.PTz,_unit={X:new three_module.Pq0(1,0,0),Y:new three_module.Pq0(0,1,0),Z:new three_module.Pq0(0,0,1)},TransformControls_changeEvent={type:"change"},_mouseDownEvent={type:"mouseDown"},_mouseUpEvent={type:"mouseUp",mode:null},_objectChangeEvent={type:"objectChange"};class TransformControls extends three_module.B69{constructor(o,l){super(),l===void 0&&(console.warn('THREE.TransformControls: The second parameter "domElement" is now mandatory.'),l=document),this.isTransformControls=!0,this.visible=!1,this.domElement=l,this.domElement.style.touchAction="none";const c=new TransformControlsGizmo;this._gizmo=c,this.add(c);const u=new TransformControlsPlane;this._plane=u,this.add(u);const h=this;function _(ke,Ve){let tt=Ve;Object.defineProperty(h,ke,{get:function(){return tt!==void 0?tt:Ve},set:function(ht){tt!==ht&&(tt=ht,u[ke]=ht,c[ke]=ht,h.dispatchEvent({type:ke+"-changed",value:ht}),h.dispatchEvent(TransformControls_changeEvent))}}),h[ke]=Ve,u[ke]=Ve,c[ke]=Ve}_("camera",o),_("object",void 0),_("enabled",!0),_("axis",null),_("mode","translate"),_("translationSnap",null),_("rotationSnap",null),_("scaleSnap",null),_("space","world"),_("size",1),_("dragging",!1),_("showX",!0),_("showY",!0),_("showZ",!0);const A=new three_module.Pq0,w=new three_module.Pq0,C=new three_module.PTz,M=new three_module.PTz,O=new three_module.Pq0,ne=new three_module.PTz,ce=new three_module.Pq0,ue=new three_module.Pq0,ye=new three_module.Pq0,Oe=new three_module.Pq0;_("worldPosition",A),_("worldPositionStart",w),_("worldQuaternion",C),_("worldQuaternionStart",M),_("cameraPosition",O),_("cameraQuaternion",ne),_("pointStart",ce),_("pointEnd",ue),_("rotationAxis",ye),_("rotationAngle",0),_("eye",Oe),this._offset=new three_module.Pq0,this._startNorm=new three_module.Pq0,this._endNorm=new three_module.Pq0,this._cameraScale=new three_module.Pq0,this._parentPosition=new three_module.Pq0,this._parentQuaternion=new three_module.PTz,this._parentQuaternionInv=new three_module.PTz,this._parentScale=new three_module.Pq0,this._worldScaleStart=new three_module.Pq0,this._worldQuaternionInv=new three_module.PTz,this._worldScale=new three_module.Pq0,this._positionStart=new three_module.Pq0,this._quaternionStart=new three_module.PTz,this._scaleStart=new three_module.Pq0,this._getPointer=getPointer.bind(this),this._onPointerDown=onPointerDown.bind(this),this._onPointerHover=onPointerHover.bind(this),this._onPointerMove=onPointerMove.bind(this),this._onPointerUp=onPointerUp.bind(this),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointermove",this._onPointerHover),this.domElement.addEventListener("pointerup",this._onPointerUp)}updateMatrixWorld(){this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this._parentPosition,this._parentQuaternion,this._parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this._worldScale),this._parentQuaternionInv.copy(this._parentQuaternion).invert(),this._worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this._cameraScale),this.camera.isOrthographicCamera?this.camera.getWorldDirection(this.eye).negate():this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld(this)}pointerHover(o){if(this.object===void 0||this.dragging===!0||o.buttons)return;_raycaster.setFromCamera(o,this.camera);const l=intersectObjectWithRay(this._gizmo.picker[this.mode],_raycaster);this.axis=l?l.object.name:null}pointerDown(o){if(this.object!==void 0&&this.dragging!==!0&&o.button===0&&this.axis!==null){_raycaster.setFromCamera(o,this.camera);const l=intersectObjectWithRay(this._plane,_raycaster,!0);l&&(this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),this._positionStart.copy(this.object.position),this._quaternionStart.copy(this.object.quaternion),this._scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this._worldScaleStart),this.pointStart.copy(l.point).sub(this.worldPositionStart)),this.dragging=!0,_mouseDownEvent.mode=this.mode,this.dispatchEvent(_mouseDownEvent)}}pointerMove(o){const l=this.axis,c=this.mode,u=this.object;let h=this.space;if(c==="scale"?h="local":l!=="E"&&l!=="XYZE"&&l!=="XYZ"||(h="world"),u===void 0||l===null||this.dragging===!1||o.button!==-1)return;_raycaster.setFromCamera(o,this.camera);const _=intersectObjectWithRay(this._plane,_raycaster,!0);if(_){if(this.pointEnd.copy(_.point).sub(this.worldPositionStart),c==="translate")this._offset.copy(this.pointEnd).sub(this.pointStart),h==="local"&&l!=="XYZ"&&this._offset.applyQuaternion(this._worldQuaternionInv),l.indexOf("X")===-1&&(this._offset.x=0),l.indexOf("Y")===-1&&(this._offset.y=0),l.indexOf("Z")===-1&&(this._offset.z=0),h==="local"&&l!=="XYZ"?this._offset.applyQuaternion(this._quaternionStart).divide(this._parentScale):this._offset.applyQuaternion(this._parentQuaternionInv).divide(this._parentScale),u.position.copy(this._offset).add(this._positionStart),this.translationSnap&&(h==="local"&&(u.position.applyQuaternion(_tempQuaternion.copy(this._quaternionStart).invert()),l.search("X")!==-1&&(u.position.x=Math.round(u.position.x/this.translationSnap)*this.translationSnap),l.search("Y")!==-1&&(u.position.y=Math.round(u.position.y/this.translationSnap)*this.translationSnap),l.search("Z")!==-1&&(u.position.z=Math.round(u.position.z/this.translationSnap)*this.translationSnap),u.position.applyQuaternion(this._quaternionStart)),h==="world"&&(u.parent&&u.position.add(_tempVector.setFromMatrixPosition(u.parent.matrixWorld)),l.search("X")!==-1&&(u.position.x=Math.round(u.position.x/this.translationSnap)*this.translationSnap),l.search("Y")!==-1&&(u.position.y=Math.round(u.position.y/this.translationSnap)*this.translationSnap),l.search("Z")!==-1&&(u.position.z=Math.round(u.position.z/this.translationSnap)*this.translationSnap),u.parent&&u.position.sub(_tempVector.setFromMatrixPosition(u.parent.matrixWorld))));else if(c==="scale"){if(l.search("XYZ")!==-1){let A=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(A*=-1),_tempVector2.set(A,A,A)}else _tempVector.copy(this.pointStart),_tempVector2.copy(this.pointEnd),_tempVector.applyQuaternion(this._worldQuaternionInv),_tempVector2.applyQuaternion(this._worldQuaternionInv),_tempVector2.divide(_tempVector),l.search("X")===-1&&(_tempVector2.x=1),l.search("Y")===-1&&(_tempVector2.y=1),l.search("Z")===-1&&(_tempVector2.z=1);u.scale.copy(this._scaleStart).multiply(_tempVector2),this.scaleSnap&&(l.search("X")!==-1&&(u.scale.x=Math.round(u.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),l.search("Y")!==-1&&(u.scale.y=Math.round(u.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),l.search("Z")!==-1&&(u.scale.z=Math.round(u.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(c==="rotate"){this._offset.copy(this.pointEnd).sub(this.pointStart);const A=20/this.worldPosition.distanceTo(_tempVector.setFromMatrixPosition(this.camera.matrixWorld));let w=!1;l==="XYZE"?(this.rotationAxis.copy(this._offset).cross(this.eye).normalize(),this.rotationAngle=this._offset.dot(_tempVector.copy(this.rotationAxis).cross(this.eye))*A):l!=="X"&&l!=="Y"&&l!=="Z"||(this.rotationAxis.copy(_unit[l]),_tempVector.copy(_unit[l]),h==="local"&&_tempVector.applyQuaternion(this.worldQuaternion),_tempVector.cross(this.eye),_tempVector.length()===0?w=!0:this.rotationAngle=this._offset.dot(_tempVector.normalize())*A),(l==="E"||w)&&(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this._startNorm.copy(this.pointStart).normalize(),this._endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this._endNorm.cross(this._startNorm).dot(this.eye)<0?1:-1),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),h==="local"&&l!=="E"&&l!=="XYZE"?(u.quaternion.copy(this._quaternionStart),u.quaternion.multiply(_tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this._parentQuaternionInv),u.quaternion.copy(_tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),u.quaternion.multiply(this._quaternionStart).normalize())}this.dispatchEvent(TransformControls_changeEvent),this.dispatchEvent(_objectChangeEvent)}}pointerUp(o){o.button===0&&(this.dragging&&this.axis!==null&&(_mouseUpEvent.mode=this.mode,this.dispatchEvent(_mouseUpEvent)),this.dragging=!1,this.axis=null)}dispose(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerHover),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.traverse(function(o){o.geometry&&o.geometry.dispose(),o.material&&o.material.dispose()})}attach(o){return this.object=o,this.visible=!0,this}detach(){return this.object=void 0,this.visible=!1,this.axis=null,this}reset(){this.enabled&&this.dragging&&(this.object.position.copy(this._positionStart),this.object.quaternion.copy(this._quaternionStart),this.object.scale.copy(this._scaleStart),this.dispatchEvent(TransformControls_changeEvent),this.dispatchEvent(_objectChangeEvent),this.pointStart.copy(this.pointEnd))}getRaycaster(){return _raycaster}getMode(){return this.mode}setMode(o){this.mode=o}setTranslationSnap(o){this.translationSnap=o}setRotationSnap(o){this.rotationSnap=o}setScaleSnap(o){this.scaleSnap=o}setSize(o){this.size=o}setSpace(o){this.space=o}}function getPointer(d){if(this.domElement.ownerDocument.pointerLockElement)return{x:0,y:0,button:d.button,buttons:d.buttons};{const o=this.domElement.getBoundingClientRect();return{x:(d.clientX-o.left)/o.width*2-1,y:-(d.clientY-o.top)/o.height*2+1,button:d.button,buttons:d.buttons}}}function onPointerHover(d){if(this.enabled)switch(d.pointerType){case"mouse":case"pen":this.pointerHover(this._getPointer(d))}}function onPointerDown(d){this.enabled&&(document.pointerLockElement||this.domElement.setPointerCapture(d.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.pointerHover(this._getPointer(d)),this.pointerDown(this._getPointer(d)))}function onPointerMove(d){this.enabled&&this.pointerMove(this._getPointer(d))}function onPointerUp(d){this.enabled&&(this.domElement.releasePointerCapture(d.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.pointerUp(this._getPointer(d)))}function intersectObjectWithRay(d,o,l){const c=o.intersectObject(d,!0);for(let u=0;u<c.length;u++)if(c[u].object.visible||l)return c[u];return!1}TransformControls.ObjectConstructors={MeshBasicMaterial:three_module.V9B,LineBasicMaterial:three_module.mrM};const _tempEuler=new three_module.O9p,_alignVector=new three_module.Pq0(0,1,0),_zeroVector=new three_module.Pq0(0,0,0),_lookAtMatrix=new three_module.kn4,_tempQuaternion2=new three_module.PTz,_identityQuaternion=new three_module.PTz,_dirVector=new three_module.Pq0,_tempMatrix=new three_module.kn4,_unitX=new three_module.Pq0(1,0,0),_unitY=new three_module.Pq0(0,1,0),_unitZ=new three_module.Pq0(0,0,1),TransformControls_v1=new three_module.Pq0,TransformControls_v2=new three_module.Pq0,_v3=new three_module.Pq0;class TransformControlsGizmo extends three_module.B69{constructor(){super(),this.isTransformControlsGizmo=!0,this.type="TransformControlsGizmo";const o=new TransformControls.ObjectConstructors.MeshBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),l=new TransformControls.ObjectConstructors.LineBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1,toneMapped:!1,transparent:!0}),c=o.clone();c.opacity=.15;const u=l.clone();u.opacity=1;const h=o.clone();h.color.setHex(15663205),h.opacity=.95;const _=o.clone();_.color.setHex(2014720),_.opacity=.95;const A=o.clone();A.color.setHex(37885),A.opacity=.95;const w=o.clone();w.color.setHex(16618689),w.__color=h.color.getHex();const C=o.clone();C.color.setHex(12516474),C.__color=_.color.getHex();const M=o.clone();M.color.setHex(11397372),M.__color=A.color.getHex();const O=o.clone();O.color.setHex(15663205),O.opacity=.75;const ne=o.clone();ne.color.setHex(2014720),ne.opacity=.75;const ce=o.clone();ce.color.setHex(37885),ce.opacity=.75;const ue=o.clone();ue.color.setHex(12893629),ue.opacity=.75;const ye=o.clone();ye.color.setHex(16777051),ye.opacity=.25;const Oe=o.clone();Oe.color.setHex(7895160),Oe.opacity=.75;const ke=new three_module.Ho_(0,.04,.1,12);ke.translate(0,.05,0);const Ve=new three_module.iNn(.08,.08,.08);Ve.translate(0,.04,0);const tt=new three_module.LoY;tt.setAttribute("position",new three_module.qtW([0,0,0,1,0,0],3));const ht=new three_module.Ho_(.0075,.0075,.5,3);function ut(Vt,si){const Jt=new three_module.O3Y(Vt,.0075,3,64,si*Math.PI*2);return Jt.rotateY(Math.PI/2),Jt.rotateX(Math.PI/2),Jt}function _t(Vt,si){const Jt=new three_module.O3Y(Vt,.1,4,24,si*Math.PI*2);return Jt.rotateY(Math.PI/2),Jt.rotateX(Math.PI/2),Jt}ht.translate(0,.25,0);const at={X:[[new three_module.eaF(ke,w),[.5,0,0],[0,0,-Math.PI/2]],[new three_module.eaF(ht,h),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new three_module.eaF(ke,C),[0,.5,0]],[new three_module.eaF(ht,_)]],Z:[[new three_module.eaF(ke,M),[0,0,.5],[Math.PI/2,0,0]],[new three_module.eaF(ht,A),null,[Math.PI/2,0,0]]],XYZ:[[new three_module.eaF(new three_module.Ufg(.1,2),ue.clone()),[0,0,0]]],XY:[[new three_module.eaF(new three_module.iNn(.2,.2,.01),ce.clone()),[.2,.2,0]]],YZ:[[new three_module.eaF(new three_module.iNn(.2,.2,.01),O.clone()),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new three_module.eaF(new three_module.iNn(.2,.2,.01),ne.clone()),[.2,0,.2],[-Math.PI/2,0,0]]]},lt={X:[[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[.3,0,0],[0,0,-Math.PI/2]]],Y:[[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[0,.3,0]]],Z:[[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[0,0,.3],[Math.PI/2,0,0]]],XYZ:[[new three_module.eaF(new three_module.Ufg(.2,0),c)]],XY:[[new three_module.eaF(new three_module.iNn(.25,.25,.01),c),[.2,.2,0]]],YZ:[[new three_module.eaF(new three_module.iNn(.25,.25,.01),c),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new three_module.eaF(new three_module.iNn(.25,.25,.01),c),[.2,0,.2],[-Math.PI/2,0,0]]]},pt={START:[[new three_module.eaF(new three_module.Ufg(.01,2),u),null,null,null,"helper"]],END:[[new three_module.eaF(new three_module.Ufg(.01,2),u),null,null,null,"helper"]],DELTA:[[new three_module.N1A(function(){const Vt=new three_module.LoY;return Vt.setAttribute("position",new three_module.qtW([0,0,0,1,1,1],3)),Vt}(),u),null,null,null,"helper"]],X:[[new three_module.N1A(tt,u.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new three_module.N1A(tt,u.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new three_module.N1A(tt,u.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},xt={XYZE:[[new three_module.eaF(new three_module.Gu$(.1,10,8),ue)],[new three_module.eaF(ut(.5,1),Oe),null,[0,Math.PI/2,0]]],X:[[new three_module.eaF(ut(.5,.5),h)],[new three_module.eaF(ht,h),[0,0,0],[0,0,-Math.PI/2]],[new three_module.eaF(ke.clone().translate(.5,0,0),w),[0,0,0],[-Math.PI/2,-Math.PI/2,-Math.PI/2]]],Y:[[new three_module.eaF(ut(.5,.5),_),null,[0,0,-Math.PI/2]],[new three_module.eaF(ht,_)],[new three_module.eaF(ke.clone().rotateZ(-Math.PI/2).translate(0,.5,0),C),[0,0,0],[Math.PI/2,0,0]]],Z:[[new three_module.eaF(ut(.5,.5),A),null,[0,Math.PI/2,0]],[new three_module.eaF(ht,A),null,[Math.PI/2,0,0]],[new three_module.eaF(ke.clone().rotateZ(-Math.PI).translate(0,0,.5),M),[0,0,0],[0,Math.PI/2,0]]]},Tt={AXIS:[[new three_module.N1A(tt,u.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},Pt={XYZE:[[new three_module.eaF(new three_module.Gu$(.25,10,8),c)]],X:[[new three_module.eaF(_t(.5,.5),c)]],Y:[[new three_module.eaF(_t(.5,.5),c),[0,0,0],[0,0,-Math.PI/2]]],Z:[[new three_module.eaF(_t(.5,.5),c),[0,0,0],[0,Math.PI/2,0]]]},Lt={X:[[new three_module.eaF(Ve,w),[.5,0,0],[0,0,-Math.PI/2]],[new three_module.eaF(ht,h),[0,0,0],[0,0,-Math.PI/2]]],Y:[[new three_module.eaF(Ve,C),[0,.5,0]],[new three_module.eaF(ht,_)]],Z:[[new three_module.eaF(Ve,M),[0,0,.5],[Math.PI/2,0,0]],[new three_module.eaF(ht,A),[0,0,0],[Math.PI/2,0,0]]],XY:[[new three_module.eaF(new three_module.iNn(.15,.15,.01),ce),[.15,.15,0]]],YZ:[[new three_module.eaF(new three_module.iNn(.15,.15,.01),O),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new three_module.eaF(new three_module.iNn(.15,.15,.01),ne),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new three_module.eaF(new three_module.iNn(.1,.1,.1),ue.clone())]]},Bt={X:[[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[.3,0,0],[0,0,-Math.PI/2]],[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[-.3,0,0],[0,0,Math.PI/2]]],Y:[[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[0,.3,0]],[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[0,-.3,0],[0,0,Math.PI]]],Z:[[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[0,0,.3],[Math.PI/2,0,0]],[new three_module.eaF(new three_module.Ho_(.2,0,.6,4),c),[0,0,-.3],[-Math.PI/2,0,0]]],XY:[[new three_module.eaF(new three_module.iNn(.2,.2,.01),c),[.15,.15,0]]],YZ:[[new three_module.eaF(new three_module.iNn(.2,.2,.01),c),[0,.15,.15],[0,Math.PI/2,0]]],XZ:[[new three_module.eaF(new three_module.iNn(.2,.2,.01),c),[.15,0,.15],[-Math.PI/2,0,0]]],XYZ:[[new three_module.eaF(new three_module.iNn(.2,.2,.2),c),[0,0,0]]]},Ut={X:[[new three_module.N1A(tt,u.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new three_module.N1A(tt,u.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new three_module.N1A(tt,u.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]};function kt(Vt){const si=new three_module.B69;for(const Jt in Vt)for(let Wt=Vt[Jt].length;Wt--;){const Zt=Vt[Jt][Wt][0].clone(),ti=Vt[Jt][Wt][1],ci=Vt[Jt][Wt][2],ri=Vt[Jt][Wt][3],Ct=Vt[Jt][Wt][4];Zt.name=Jt,Zt.tag=Ct,ti&&Zt.position.set(ti[0],ti[1],ti[2]),ci&&Zt.rotation.set(ci[0],ci[1],ci[2]),ri&&Zt.scale.set(ri[0],ri[1],ri[2]),Zt.updateMatrix();const Ht=Zt.geometry.clone();Ht.applyMatrix4(Zt.matrix),Zt.geometry=Ht,Zt.renderOrder=1/0,Zt.position.set(0,0,0),Zt.rotation.set(0,0,0),Zt.scale.set(1,1,1),si.add(Zt)}return si}this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=kt(at)),this.add(this.gizmo.rotate=kt(xt)),this.add(this.gizmo.scale=kt(Lt)),this.add(this.picker.translate=kt(lt)),this.add(this.picker.rotate=kt(Pt)),this.add(this.picker.scale=kt(Bt)),this.add(this.helper.translate=kt(pt)),this.add(this.helper.rotate=kt(Tt)),this.add(this.helper.scale=kt(Ut)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}updateMatrixWorld(o){const l=(this.mode==="scale"?"local":this.space)==="local"?this.worldQuaternion:_identityQuaternion;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let c=[];c=c.concat(this.picker[this.mode].children),c=c.concat(this.gizmo[this.mode].children),c=c.concat(this.helper[this.mode].children);for(let u=0;u<c.length;u++){const h=c[u];let _;h.visible=!0,h.rotation.set(0,0,0),h.position.copy(this.worldPosition),_=this.camera.isOrthographicCamera?(this.camera.top-this.camera.bottom)/this.camera.zoom:this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),h.scale.set(1,1,1).multiplyScalar(_*this.size/4),h.tag!=="helper"?(h.quaternion.copy(l),this.mode==="translate"||this.mode==="scale"?(h.name==="X"&&Math.abs(_alignVector.copy(_unitX).applyQuaternion(l).dot(this.eye))>.99&&(h.scale.set(1e-10,1e-10,1e-10),h.visible=!1),h.name==="Y"&&Math.abs(_alignVector.copy(_unitY).applyQuaternion(l).dot(this.eye))>.99&&(h.scale.set(1e-10,1e-10,1e-10),h.visible=!1),h.name==="Z"&&Math.abs(_alignVector.copy(_unitZ).applyQuaternion(l).dot(this.eye))>.99&&(h.scale.set(1e-10,1e-10,1e-10),h.visible=!1),h.name==="XY"&&Math.abs(_alignVector.copy(_unitZ).applyQuaternion(l).dot(this.eye))<.2&&(h.scale.set(1e-10,1e-10,1e-10),h.visible=!1),h.name==="YZ"&&Math.abs(_alignVector.copy(_unitX).applyQuaternion(l).dot(this.eye))<.2&&(h.scale.set(1e-10,1e-10,1e-10),h.visible=!1),h.name==="XZ"&&Math.abs(_alignVector.copy(_unitY).applyQuaternion(l).dot(this.eye))<.2&&(h.scale.set(1e-10,1e-10,1e-10),h.visible=!1)):this.mode==="rotate"&&(_tempQuaternion2.copy(l),_alignVector.copy(this.eye).applyQuaternion(_tempQuaternion.copy(l).invert()),h.name.search("E")!==-1&&h.quaternion.setFromRotationMatrix(_lookAtMatrix.lookAt(this.eye,_zeroVector,_unitY)),h.name==="X"&&(_tempQuaternion.setFromAxisAngle(_unitX,Math.atan2(-_alignVector.y,_alignVector.z)),_tempQuaternion.multiplyQuaternions(_tempQuaternion2,_tempQuaternion),h.quaternion.copy(_tempQuaternion)),h.name==="Y"&&(_tempQuaternion.setFromAxisAngle(_unitY,Math.atan2(_alignVector.x,_alignVector.z)),_tempQuaternion.multiplyQuaternions(_tempQuaternion2,_tempQuaternion),h.quaternion.copy(_tempQuaternion)),h.name==="Z"&&(_tempQuaternion.setFromAxisAngle(_unitZ,Math.atan2(_alignVector.y,_alignVector.x)),_tempQuaternion.multiplyQuaternions(_tempQuaternion2,_tempQuaternion),h.quaternion.copy(_tempQuaternion))),h.visible=h.visible&&(h.name.indexOf("X")===-1||this.showX),h.visible=h.visible&&(h.name.indexOf("Y")===-1||this.showY),h.visible=h.visible&&(h.name.indexOf("Z")===-1||this.showZ),h.visible=h.visible&&(h.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),h.material._color=h.material._color||h.material.color.clone(),h.material._opacity=h.material._opacity||h.material.opacity,h.material.color.copy(h.material._color),h.material.opacity=h.material._opacity,this.enabled&&this.axis&&(h.name===this.axis||this.axis.split("").some(function(A){return h.name===A}))&&(h.material.__color&&h.material.color.setHex(h.material.__color),h.material.opacity=1)):(h.visible=!1,h.name==="AXIS"?(h.visible=!!this.axis,this.axis==="X"&&(_tempQuaternion.setFromEuler(_tempEuler.set(0,0,0)),h.quaternion.copy(l).multiply(_tempQuaternion),Math.abs(_alignVector.copy(_unitX).applyQuaternion(l).dot(this.eye))>.9&&(h.visible=!1)),this.axis==="Y"&&(_tempQuaternion.setFromEuler(_tempEuler.set(0,0,Math.PI/2)),h.quaternion.copy(l).multiply(_tempQuaternion),Math.abs(_alignVector.copy(_unitY).applyQuaternion(l).dot(this.eye))>.9&&(h.visible=!1)),this.axis==="Z"&&(_tempQuaternion.setFromEuler(_tempEuler.set(0,Math.PI/2,0)),h.quaternion.copy(l).multiply(_tempQuaternion),Math.abs(_alignVector.copy(_unitZ).applyQuaternion(l).dot(this.eye))>.9&&(h.visible=!1)),this.axis==="XYZE"&&(_tempQuaternion.setFromEuler(_tempEuler.set(0,Math.PI/2,0)),_alignVector.copy(this.rotationAxis),h.quaternion.setFromRotationMatrix(_lookAtMatrix.lookAt(_zeroVector,_alignVector,_unitY)),h.quaternion.multiply(_tempQuaternion),h.visible=this.dragging),this.axis==="E"&&(h.visible=!1)):h.name==="START"?(h.position.copy(this.worldPositionStart),h.visible=this.dragging):h.name==="END"?(h.position.copy(this.worldPosition),h.visible=this.dragging):h.name==="DELTA"?(h.position.copy(this.worldPositionStart),h.quaternion.copy(this.worldQuaternionStart),_tempVector.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),_tempVector.applyQuaternion(this.worldQuaternionStart.clone().invert()),h.scale.copy(_tempVector),h.visible=this.dragging):(h.quaternion.copy(l),this.dragging?h.position.copy(this.worldPositionStart):h.position.copy(this.worldPosition),this.axis&&(h.visible=this.axis.search(h.name)!==-1)))}super.updateMatrixWorld(o)}}class TransformControlsPlane extends three_module.eaF{constructor(){super(new three_module.bdM(1e5,1e5,2,2),new TransformControls.ObjectConstructors.MeshBasicMaterial({visible:!1,wireframe:!0,side:three_module.$EB,transparent:!0,opacity:.1,toneMapped:!1})),this.isTransformControlsPlane=!0,this.type="TransformControlsPlane"}updateMatrixWorld(o){let l=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(l="local"),TransformControls_v1.copy(_unitX).applyQuaternion(l==="local"?this.worldQuaternion:_identityQuaternion),TransformControls_v2.copy(_unitY).applyQuaternion(l==="local"?this.worldQuaternion:_identityQuaternion),_v3.copy(_unitZ).applyQuaternion(l==="local"?this.worldQuaternion:_identityQuaternion),_alignVector.copy(TransformControls_v2),this.mode){case"translate":case"scale":switch(this.axis){case"X":_alignVector.copy(this.eye).cross(TransformControls_v1),_dirVector.copy(TransformControls_v1).cross(_alignVector);break;case"Y":_alignVector.copy(this.eye).cross(TransformControls_v2),_dirVector.copy(TransformControls_v2).cross(_alignVector);break;case"Z":_alignVector.copy(this.eye).cross(_v3),_dirVector.copy(_v3).cross(_alignVector);break;case"XY":_dirVector.copy(_v3);break;case"YZ":_dirVector.copy(TransformControls_v1);break;case"XZ":_alignVector.copy(_v3),_dirVector.copy(TransformControls_v2);break;case"XYZ":case"E":_dirVector.set(0,0,0)}break;default:_dirVector.set(0,0,0)}_dirVector.length()===0?this.quaternion.copy(this.cameraQuaternion):(_tempMatrix.lookAt(_tempVector.set(0,0,0),_dirVector,_alignVector),this.quaternion.setFromRotationMatrix(_tempMatrix)),super.updateMatrixWorld(o)}}var TransformControls2_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let TransformControls2=class extends TransformControls{setDirty(d){this.dispatchEvent({...d,type:"objectUpdate",object:this})}refreshUi(){var d,o;(o=(d=this.uiConfig)===null||d===void 0?void 0:d.uiRefresh)===null||o===void 0||o.call(d,"postFrame",!0,1)}_keyDownListener(d){if(this.enabled&&this.object&&!d.metaKey&&!d.ctrlKey){switch(d.code){case"KeyQ":this.space=this.space==="local"?"world":"local";break;case"ShiftLeft":this.translationSnap=.5,this.rotationSnap=three_module.cj9.degToRad(15),this.scaleSnap=.25;break;case"KeyW":this.mode="translate";break;case"KeyE":this.mode="rotate";break;case"KeyR":this.mode="scale";break;case"Equal":case"NumpadAdd":case"Plus":this.size=this.size+.1;break;case"Minus":case"NumpadSubtract":case"Underscore":this.size=Math.max(this.size-.1,.1);break;case"KeyX":this.showX=!this.showX;break;case"KeyY":this.showY=!this.showY;break;case"KeyZ":this.showZ=!this.showZ;break;case"Space":this.enabled=!this.enabled;break;default:return}this.setDirty({refreshScene:!0,frameFade:!0})}}_keyUpListener(d){this.enabled&&(d.code==="ShiftLeft"&&(this.translationSnap=null,this.rotationSnap=null,this.scaleSnap=null),this.object&&d.code)}constructor(d,o){super(d,o),this.isWidget=!0,setupIModel(this),this.visible=!1,this.userData.bboxVisible=!1,this.size=2,this.addEventListener("objectChange",()=>{var l;(l=this.object)===null||l===void 0||l.setDirty({fadeFrame:!1})}),this.addEventListener("change",()=>{this.setDirty({fadeFrame:!1})}),this._keyUpListener=this._keyUpListener.bind(this),this._keyDownListener=this._keyDownListener.bind(this),window.addEventListener("keydown",this._keyDownListener),window.addEventListener("keyup",this._keyUpListener)}dispose(){window.removeEventListener("keydown",this._keyDownListener),window.removeEventListener("keyup",this._keyUpListener),super.dispose()}get modelObject(){return this}};TransformControls2_decorate([uiDropdown("Mode",["translate","rotate","scale"].map(d=>({label:d})))],TransformControls2.prototype,"mode",void 0),TransformControls2_decorate([uiDropdown("Space",["world","local"].map(d=>({label:d})))],TransformControls2.prototype,"space",void 0),TransformControls2_decorate([uiSlider("Size",[.1,10],.1)],TransformControls2.prototype,"size",void 0),TransformControls2_decorate([uiToggle("Show X")],TransformControls2.prototype,"showX",void 0),TransformControls2_decorate([uiToggle("Show Y")],TransformControls2.prototype,"showY",void 0),TransformControls2_decorate([uiToggle("Show Z")],TransformControls2.prototype,"showZ",void 0),TransformControls2=TransformControls2_decorate([uiFolder("Transform Controls")],TransformControls2);class CanvasRecorder extends I{_setOptions(o){var l,c;Object.assign(this._options,o),this._options.mimeType&&this._options.mimeType!=="auto"||(this._options.mimeType=(l=CanvasRecorder.GetSupportedMimeTypes([],["h264"],!0))!==null&&l!==void 0?l:CanvasRecorder.GetSupportedMimeTypes(void 0,void 0,!0)),this._options.mimeType&&!(!((c=this._options.mimeType)===null||c===void 0)&&c.startsWith("video/"))||window.MediaRecorder||(this._console.warn("MediaRecorder is not supported, switching to png"),this._options.mimeType="image/png"),this._options.mimeType||console.warn(new Error("No supported mimetype found"))}setOptions(o){this._setOptions(o)}constructor(o,l){super(),this._state="stopped",this._console=console,this._currentRecording=[],this._currentImages=[],this.stepMode=!1,this._resumeSyncTime=0,this._frameCount=0,this._onstop=u=>{var h;if(this._state="stopped",this._recorder&&this._currentRecording.length>0){const _=new Blob(this._currentRecording,{type:this._options.mimeType});(h=this._recordingCallback)===null||h===void 0||h.call(this,_)}else this._currentImages.length>0&&(this._writeImages([...this._currentImages]),this._currentImages=[]);this._recorder=void 0,this.dispatchEvent({type:"stop"})},this._onstart=u=>{var h;this._state="recording",this._frameCount=0,this.dispatchEvent({type:"start"}),this.stepMode&&((h=this._recorder)===null||h===void 0||h.pause())},this._onresume=u=>{if(!this.stepMode)return;const h=()=>{var A;this._state==="recording"&&((A=this._recorder)===null||A===void 0||A.pause())},_=Math.min(this._resumeSyncTime-g(),0)+1e3/this._options.frameRate;_>0?X(_).then(h):h()},this._onpause=u=>{},this._ondataavailable=u=>{u.data&&u.data.size>0&&this._currentRecording.push(u.data)},this._onerror=u=>{this._state="error",this._console.error(u),this.dispatchEvent({type:"error",error:u}),this._recorder=void 0},this._canvas=o;const c=l==null?void 0:l.mimeType;this._options={mimeType:c||"auto",frameRate:30,stepMode:!1},this._setOptions(l||this._options)}isRecording(){return this._state==="recording"}start(){var o,l,c;if(this._state==="recording")return void this._console.log("Already recording canvas");if(this._state==="error"&&(this._recorder=void 0,this._console.warn("Resetting from error state.")),this._recorder)return this._state==="paused"?(this.dispatchEvent({type:"starting"}),void this._recorder.resume()):void this._console.warn("Canvas recorder unknown state",this._state);if(this._state==="paused")return this.dispatchEvent({type:"starting"}),void(this._state="recording");const u={mimeType:this._options.mimeType,videoBitsPerSecond:this._options.videoBitsPerSecond};if(this._currentRecording=[],this._currentImages=[],this._frameCount=0,(o=u.mimeType)===null||o===void 0?void 0:o.startsWith("video")){if(!window.MediaRecorder)return this._console.error("MediaRecorder not supported, use image sequence"),void(this._state="error");{const h=this._canvas.captureStream(this.stepMode?0:this._options.frameRate),_=(l=h.getVideoTracks())===null||l===void 0?void 0:l[0];this._track=_,this._recorder=new window.MediaRecorder(h,u),this._recorder.onstop=this._onstop,this._recorder.ondataavailable=this._ondataavailable,this._recorder.onerror=this._onerror,this._recorder.onresume=this._onresume,this._recorder.onstart=this._onstart}}this.dispatchEvent({type:"starting"}),this._recorder?(this._state="recording",(c=this._recorder)===null||c===void 0||c.start()):window&&window.showDirectoryPicker&&window.showDirectoryPicker().then(async h=>{const _=await(h==null?void 0:h.getDirectoryHandle("i-"+Math.floor(Date.now()),{create:!0}));this._imgDirectory=_,this._state="recording",this._onstart({})}).catch(h=>{this._onerror({detail:h})})}async requestFrame(){if(this._state!=="recording")return;this._frameCount++;const o=this._options.mimeType;if(!this._recorder&&o.startsWith("image/")){const l=this._canvas.toDataURL(o,90);this._currentImages.push(["frame_"+String(this._frameCount).padStart(5,"0")+(o.includes("png")?".png":".jpg"),l]),this._currentImages.length>60&&(this._writeImages([...this._currentImages]),this._currentImages=[])}this._recorder&&this._track&&this.stepMode&&(this._resumeSyncTime=g(),this._track.requestFrame(),this._recorder.resume())}pause(){this._state!=="paused"&&this._state!=="stopped"&&(this._recorder?this._recorder.pause():this._state="paused")}stop(o){this._state!=="stopped"&&(this._state!=="error"?(this._recordingCallback=o,this.dispatchEvent({type:"stopping"}),this._recorder?this._recorder.stop():this._onstop({})):this._console.error("Recorder in error state, cannot stop, call start again."))}get state(){return this._state}dispose(){this._recorder&&this._state!=="error"?this.stop(o=>{this._console.warn("disposed with blob",o),this.dispose()}):this._recorder=void 0}async _writeImages(o){if(!this._imgDirectory)return;const l=await Promise.all(o.map(async([u,h])=>await(await fetch(h)).blob())),c=[];for(let u=0;u<o.length;u++){const h=await this._imgDirectory.getFileHandle(o[u][0],{create:!0});c.push($e(h,l[u]))}await Promise.all(c)}static GetSupportedMimeTypes(o,l,c=!1){if(!window.MediaRecorder)return c?void 0:[];const u=["webm","ogg","mp4","x-matroska"].filter(A=>!o||o.length<1||o.includes(A)),h=["vp9","vp9.0","vp8","vp8.0","avc1","av1","h265","h.265","h264","h.264","opus"].filter(A=>!l||l.length<1||l.includes(A)),_=[];return u.forEach(A=>{const w=`video/${A}`;h.forEach(C=>{[`${w};codecs=${C}`,`${w};codecs:${C}`,`${w};codecs=${C.toUpperCase()}`,`${w};codecs:${C.toUpperCase()}`,`${w}`].forEach(M=>{MediaRecorder.isTypeSupported(M)&&_.push(M)})})}),c?_.length>0?_[0]:void 0:_}}class SphereSelectionWidget extends SelectionWidget{constructor(){super(),this.boundingScaleMultiplier=1.2,this._initGeometry(new three_module.WBB(1,0))}}function deepAccessObject(d,o,l=!1){for(typeof d=="string"&&(d=d.split("."));d.length>0;){if(!o)return o;const c=d.splice(0,1)[0];if(!(c.length<1))if(Array.isArray(o))o=o[parseInt(c)];else{if(typeof o!="object"||!(c in o)){if(l)throw new Error("invalid access, check "+c+" in "+o);return}o=o[c]}}return o}function extractAnimationKey(d,o,l){var c,u;let h=Array.from(((c=d.access)!==null&&c!==void 0?c:"").split(".")),_=(u=d.targetObject)!==null&&u!==void 0?u:o;const A=h.pop();if(!A||A.length===0)return{key:void 0,tar:_};if((l=l??(o==null?void 0:o._animGetters))&&h[0]in l){const w=l[h[0]](h);w?(_=w.tar,h=h.slice(w.i+1)):_=w}return _=deepAccessObject(h,_),_&&!(A in _)?(console.error("invalid key",A,_,o,d),{key:void 0,tar:_}):{key:A,tar:_}}async function animateObject(d,o,l){var c,u,h,_;const{key:A,tar:w}=extractAnimationKey(o,d),C=o.animSet?[animateSet(d,o.animSet,l,(c=o.animSetParallel)!==null&&c!==void 0&&c)]:[];if(A&&w){const M=(_=o.updater)!==null&&_!==void 0?_:[],O=async()=>animateTarget(w,A,{from:o.from,to:o.to,ease:typeof o.ease=="string"?EasingFunctions$1[o.ease]:o.ease,duration:o.duration,...o.options,onUpdate:ne=>{var ce,ue;(ue=(ce=o.options).onUpdate)===null||ue===void 0||ue.call(ce,ne),M.forEach(ye=>{var Oe;return(Oe=l[ye])===null||Oe===void 0?void 0:Oe.call(l)})}},void 0,!1);o.delay?C.push(X(o.delay).then(O)):C.push(O())}else(o.duration||o.delay)&&C.push(X(((u=o.delay)!==null&&u!==void 0?u:0)+((h=o.duration)!==null&&h!==void 0?h:0)));return C.length===1?C[0]:Promise.all(C)}async function animationObject_animate(d,o,l){return typeof o.animate=="function"?o.animate():animateObject(d,o,l)}async function animateSet(d,o,l,c=!1){if(c)return Promise.all(o.map(async u=>animationObject_animate(d,u,l)));for(const u of o)await animationObject_animate(d,u,l)}const encoder=new TextEncoder,HOST_SERVICES={appstream2:"appstream",cloudhsmv2:"cloudhsm",email:"ses",marketplace:"aws-marketplace",mobile:"AWSMobileHubService",pinpoint:"mobiletargeting",queue:"sqs","git-codecommit":"codecommit","mturk-requester-sandbox":"mturk-requester","personalize-runtime":"personalize"},UNSIGNABLE_HEADERS=new Set(["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id","range","connection"]);class AwsClient{constructor({accessKeyId:o,secretAccessKey:l,sessionToken:c,service:u,region:h,cache:_,retries:A,initRetryMs:w}){if(o==null)throw new TypeError("accessKeyId is a required option");if(l==null)throw new TypeError("secretAccessKey is a required option");this.accessKeyId=o,this.secretAccessKey=l,this.sessionToken=c,this.service=u,this.region=h,this.cache=_||new Map,this.retries=A??10,this.initRetryMs=w||50}async sign(o,l){if(o instanceof Request){const{method:h,url:_,headers:A,body:w}=o;(l=Object.assign({method:h,url:_,headers:A},l)).body==null&&A.has("Content-Type")&&(l.body=w!=null&&A.has("X-Amz-Content-Sha256")?w:await o.clone().arrayBuffer()),o=_}const c=new AwsV4Signer(Object.assign({url:o.toString()},l,this,l&&l.aws)),u=Object.assign({},l,await c.sign());delete u.aws;try{return new Request(u.url.toString(),u)}catch(h){if(h instanceof TypeError)return new Request(u.url.toString(),Object.assign({duplex:"half"},u));throw h}}async fetch(o,l){for(let c=0;c<=this.retries;c++){const u=fetch(await this.sign(o,l));if(c===this.retries)return u;const h=await u;if(h.status<500&&h.status!==429)return h;await new Promise(_=>setTimeout(_,Math.random()*this.initRetryMs*Math.pow(2,c)))}throw new Error("An unknown error occurred, ensure retries is not negative")}}class AwsV4Signer{constructor({method:o,url:l,headers:c,body:u,accessKeyId:h,secretAccessKey:_,sessionToken:A,service:w,region:C,cache:M,datetime:O,signQuery:ne,appendSessionToken:ce,allHeaders:ue,singleEncode:ye}){if(l==null)throw new TypeError("url is a required option");if(h==null)throw new TypeError("accessKeyId is a required option");if(_==null)throw new TypeError("secretAccessKey is a required option");let Oe,ke;this.method=o||(u?"POST":"GET"),this.url=new URL(l),this.headers=new Headers(c||{}),this.body=u,this.accessKeyId=h,this.secretAccessKey=_,this.sessionToken=A,w&&C||([Oe,ke]=guessServiceRegion(this.url,this.headers)),this.service=w||Oe||"",this.region=C||ke||"us-east-1",this.cache=M||new Map,this.datetime=O||new Date().toISOString().replace(/[:-]|\.\d{3}/g,""),this.signQuery=ne,this.appendSessionToken=ce||this.service==="iotdevicegateway",this.headers.delete("Host"),this.service!=="s3"||this.signQuery||this.headers.has("X-Amz-Content-Sha256")||this.headers.set("X-Amz-Content-Sha256","UNSIGNED-PAYLOAD");const Ve=this.signQuery?this.url.searchParams:this.headers;if(Ve.set("X-Amz-Date",this.datetime),this.sessionToken&&!this.appendSessionToken&&Ve.set("X-Amz-Security-Token",this.sessionToken),this.signableHeaders=["host",...this.headers.keys()].filter(ht=>ue||!UNSIGNABLE_HEADERS.has(ht)).sort(),this.signedHeaders=this.signableHeaders.join(";"),this.canonicalHeaders=this.signableHeaders.map(ht=>ht+":"+(ht==="host"?this.url.host:(this.headers.get(ht)||"").replace(/\s+/g," "))).join(`
`),this.credentialString=[this.datetime.slice(0,8),this.region,this.service,"aws4_request"].join("/"),this.signQuery&&(this.service!=="s3"||Ve.has("X-Amz-Expires")||Ve.set("X-Amz-Expires","86400"),Ve.set("X-Amz-Algorithm","AWS4-HMAC-SHA256"),Ve.set("X-Amz-Credential",this.accessKeyId+"/"+this.credentialString),Ve.set("X-Amz-SignedHeaders",this.signedHeaders)),this.service==="s3")try{this.encodedPath=decodeURIComponent(this.url.pathname.replace(/\+/g," "))}catch{this.encodedPath=this.url.pathname}else this.encodedPath=this.url.pathname.replace(/\/+/g,"/");ye||(this.encodedPath=encodeURIComponent(this.encodedPath).replace(/%2F/g,"/")),this.encodedPath=encodeRfc3986(this.encodedPath);const tt=new Set;this.encodedSearch=[...this.url.searchParams].filter(([ht])=>{if(!ht)return!1;if(this.service==="s3"){if(tt.has(ht))return!1;tt.add(ht)}return!0}).map(ht=>ht.map(ut=>encodeRfc3986(encodeURIComponent(ut)))).sort(([ht,ut],[_t,at])=>ht<_t?-1:ht>_t?1:ut<at?-1:ut>at?1:0).map(ht=>ht.join("=")).join("&")}async sign(){return this.signQuery?(this.url.searchParams.set("X-Amz-Signature",await this.signature()),this.sessionToken&&this.appendSessionToken&&this.url.searchParams.set("X-Amz-Security-Token",this.sessionToken)):this.headers.set("Authorization",await this.authHeader()),{method:this.method,url:this.url,headers:this.headers,body:this.body}}async authHeader(){return["AWS4-HMAC-SHA256 Credential="+this.accessKeyId+"/"+this.credentialString,"SignedHeaders="+this.signedHeaders,"Signature="+await this.signature()].join(", ")}async signature(){const o=this.datetime.slice(0,8),l=[this.secretAccessKey,o,this.region,this.service].join();let c=this.cache.get(l);if(!c){const u=await hmac("AWS4"+this.secretAccessKey,o),h=await hmac(u,this.region),_=await hmac(h,this.service);c=await hmac(_,"aws4_request"),this.cache.set(l,c)}return buf2hex(await hmac(c,await this.stringToSign()))}async stringToSign(){return["AWS4-HMAC-SHA256",this.datetime,this.credentialString,buf2hex(await aws4fetch_esm_hash(await this.canonicalString()))].join(`
`)}async canonicalString(){return[this.method.toUpperCase(),this.encodedPath,this.encodedSearch,this.canonicalHeaders+`
`,this.signedHeaders,await this.hexBodyHash()].join(`
`)}async hexBodyHash(){let o=this.headers.get("X-Amz-Content-Sha256")||(this.service==="s3"&&this.signQuery?"UNSIGNED-PAYLOAD":null);if(o==null){if(this.body&&typeof this.body!="string"&&!("byteLength"in this.body))throw new Error("body must be a string, ArrayBuffer or ArrayBufferView, unless you include the X-Amz-Content-Sha256 header");o=buf2hex(await aws4fetch_esm_hash(this.body||""))}return o}}async function hmac(d,o){const l=await crypto.subtle.importKey("raw",typeof d=="string"?encoder.encode(d):d,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"]);return crypto.subtle.sign("HMAC",l,encoder.encode(o))}async function aws4fetch_esm_hash(d){return crypto.subtle.digest("SHA-256",typeof d=="string"?encoder.encode(d):d)}const HEX_CHARS=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function buf2hex(d){const o=new Uint8Array(d);let l="";for(let c=0;c<o.length;c++){const u=o[c];l+=HEX_CHARS[u>>>4&15],l+=HEX_CHARS[15&u]}return l}function encodeRfc3986(d){return d.replace(/[!'()*]/g,o=>"%"+o.charCodeAt(0).toString(16).toUpperCase())}function guessServiceRegion(d,o){const{hostname:l,pathname:c}=d;if(l.endsWith(".on.aws")){const A=l.match(/^[^.]{1,63}\.lambda-url\.([^.]{1,63})\.on\.aws$/);return A!=null?["lambda",A[1]||""]:["",""]}if(l.endsWith(".r2.cloudflarestorage.com"))return["s3","auto"];if(l.endsWith(".backblazeb2.com")){const A=l.match(/^(?:[^.]{1,63}\.)?s3\.([^.]{1,63})\.backblazeb2\.com$/);return A!=null?["s3",A[1]||""]:["",""]}const u=l.replace("dualstack.","").match(/([^.]{1,63})\.(?:([^.]{0,63})\.)?amazonaws\.com(?:\.cn)?$/);let h=u&&u[1]||"",_=u&&u[2];if(_==="us-gov")_="us-gov-west-1";else if(_==="s3"||_==="s3-accelerate")_="us-east-1",h="s3";else if(h==="iot")h=l.startsWith("iot.")?"execute-api":l.startsWith("data.jobs.iot.")?"iot-jobs-data":c==="/mqtt"?"iotdevicegateway":"iotdata";else if(h==="autoscaling"){const A=(o.get("X-Amz-Target")||"").split(".")[0];A==="AnyScaleFrontendService"?h="application-autoscaling":A==="AnyScaleScalingPlannerFrontendService"&&(h="autoscaling-plans")}else _==null&&h.startsWith("s3-")?(_=h.slice(3).replace(/^fips-|^external-1/,""),h="s3"):h.endsWith("-fips")?h=h.slice(0,-5):_&&/-\d$/.test(h)&&!/-\d$/.test(_)&&([h,_]=[_,h]);return[HOST_SERVICES[h]||h,_||""]}var AWSClientPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},AWSClientPlugin_1;let AWSClientPlugin=AWSClientPlugin_1=class extends AViewerPlugin{constructor(){super(),this.enabled=!0,this._connected=!1,this.dependencies=[FileTransferPlugin],this.accessKeyId="",this.accessKeySecret="",this.endpointURL="",this.pathPrefix="webgi",this.serializeSettings=!1,this.toggleConnection=()=>{this._connected?this.disconnect():this.connect()},this.serializeWithViewer=!1,this.fetchFunction=fetch}connect(){this._connected&&this.disconnect(),this._client=new AwsClient({accessKeyId:this.accessKeyId,secretAccessKey:this.accessKeySecret}),this._connected=!0,this.refreshUi()}refreshUi(){var d,o;(o=(d=this.uiConfig)===null||d===void 0?void 0:d.uiRefresh)===null||o===void 0||o.call(d,"postFrame",!0)}disconnect(){this._client=void 0,this._connected=!1,this.refreshUi()}get connected(){return this._connected}get client(){return this._client}toJSON(d){return this.serializeSettings?super.toJSON(d):{type:this.constructor.PluginType}}async onAdded(d){await super.onAdded(d);const o=d.getPlugin(FileTransferPlugin);o.actions.exportFile=async(l,c,u)=>{if(!this._connected)return void await o.defaultActions.exportFile(l,c);const h=ot([this.endpointURL,this.pathPrefix,c]),_=await this.fetch(h,{method:"PUT",body:l},u);if(!_.ok)return d.console.error("Error uploading file",_),void await o.defaultActions.exportFile(l,c);this.dispatchEvent({type:"fileUpload",name:c,blob:l,response:_,path:h}),d.console.log("File uploaded",_)}}async fetch(d,o,l){if(!this._client)throw new Error("Not connected");for(let c=0;c<=this._client.retries;c++){const u=await sign2(this._client,d,o);let h=u.url.toString();AWSClientPlugin_1.USE_PROXY&&h&&!h.includes(AWSClientPlugin_1.PROXY_URL)&&(h=AWSClientPlugin_1.PROXY_URL.replace("{path}",h));const _=(0,this.fetchFunction)(h,u);if(c===this._client.retries)return _;const A=await _;if(A.status<500&&A.status!==429)return A;await X(Math.random()*this._client.initRetryMs*Math.pow(2,c))}throw new Error("An unknown error occurred, ensure retries is not negative")}};async function sign2(d,o,l){if(o instanceof Request){const{method:h,url:_,headers:A,body:w}=o;(l=Object.assign({method:h,url:_,headers:A},l)).body==null&&A.has("Content-Type")&&(l.body=w!=null&&A.has("X-Amz-Content-Sha256")?w:await o.clone().arrayBuffer()),o=_,console.warn("WebGi AWSClientPlugin: There could be a bug in chrome with cloning Request objects, see https://bugs.chromium.org/p/chromium/issues/detail?id=1360943")}const c=new AwsV4Signer(Object.assign({url:o},l,d,l&&l.aws)),u=Object.assign({},l,await c.sign());return delete u.aws,u}AWSClientPlugin.PluginType="AWSClientPlugin1",AWSClientPlugin.USE_PROXY=!1,AWSClientPlugin.PROXY_URL="https://r2-s3-api.repalash.com/{path}",AWSClientPlugin_decorate([serialize(),uiInput("Access Key ID",d=>({disabled:()=>!d.enabled||d._connected}))],AWSClientPlugin.prototype,"accessKeyId",void 0),AWSClientPlugin_decorate([serialize(),uiInput("Access Key Secret",d=>({disabled:()=>!d.enabled||d._connected}))],AWSClientPlugin.prototype,"accessKeySecret",void 0),AWSClientPlugin_decorate([serialize(),uiInput("Endpoint URL",d=>({disabled:()=>!d.enabled||d._connected}))],AWSClientPlugin.prototype,"endpointURL",void 0),AWSClientPlugin_decorate([serialize(),uiInput("Path Prefix",d=>({disabled:()=>!d.enabled}))],AWSClientPlugin.prototype,"pathPrefix",void 0),AWSClientPlugin_decorate([serialize(),uiToggle("Remember",d=>({disabled:()=>!d.enabled||d._connected}))],AWSClientPlugin.prototype,"serializeSettings",void 0),AWSClientPlugin_decorate([uiButton(void 0,d=>({label:()=>d._connected?"Disconnect":"Connect"}))],AWSClientPlugin.prototype,"toggleConnection",void 0),AWSClientPlugin=AWSClientPlugin_1=AWSClientPlugin_decorate([uiFolder("S3 Connection")],AWSClientPlugin);const supportsRequestStreams=(()=>{let d=!1,o=!1;const l=typeof globalThis.ReadableStream=="function",c=typeof globalThis.Request=="function";return l&&c&&(o=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return d=!0,"half"}}).headers.has("Content-Type")),d&&!o})(),defaultPresets={Background:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/background",assets:["gradient-radial-dark-blue.svg","gradient-radial-grey.svg","gradient-radial-red.svg","gradient-radial-aqua.svg","gradient-radial-green.svg","gradient-radial-white.svg","gradient-radial-coral.svg","gradient-radial-fuchsia.svg","gradient-radial-blue.svg","gradient-radial-black.svg","gradient-radial-light-blue.svg","gradient-radial-gray.svg","gradient-radial-beige.svg","gradient-radial-antrasit.svg","gradient-linear-light-blue.svg","gradient-linear-gray.svg","gradient-linear-beige.svg","gradient-linear-antrasit.svg","bg-1.jpg","bg-2.png"].map(d=>({path:d}))}).assets,Environment:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/environment",assets:["env-metal-1.hdr","env-metal-2.hdr","env-metal-3.hdr","env-metal-4.hdr","env-metal-5.hdr","env-metal-6.hdr","env-metal-7.hdr","env-metal-8.hdr","env-metal-9.hdr","env-metal-10.hdr","env-metal-11.hdr","env-metal-12.hdr","env-metal-13.hdr","env-metal-14.exr","env-metal-gem-1.hdr","env-metal-gem-2.hdr","env-gem-1.hdr","env-gem-2.hdr","env-gem-3.exr","env-gem-4.exr","alps_field_1k.hdr","paul_lobe_haus_1k.hdr","derelict_highway_midday_1k.hdr","neon_photostudio_1k.hdr","studio_small_08_1k.hdr","evening_meadow_1k.hdr","st_peters_square_night_1k.hdr","studio_small_07_1k.hdr","moonless_golf_1k.hdr","satara_night_1k.hdr","venice_sunset_1k.hdr","umhlanga_sunrise_1k.hdr","studio_country_hall_1k.hdr"].map(d=>({path:d}))}).assets,GemEnvironment:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/environment",assets:["env-gem-1.hdr","env-gem-2.hdr","env-gem-3.exr","env-gem-4.exr","env-metal-gem-1.hdr","env-metal-gem-2.hdr"].map(d=>({path:d}))}).assets,GemEnvironment2:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/environment",assets:["env-gem-1.hdr","env-gem-2.hdr","env-gem-3.exr","env-gem-4.exr","env-metal-gem-1.hdr","env-metal-gem-2.hdr"].map(d=>({path:d}))}).assets,GemEnvironment3:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/environment",assets:["env-gem-1.hdr","env-gem-2.hdr","env-gem-3.exr","env-gem-4.exr","env-metal-gem-1.hdr","env-metal-gem-2.hdr"].map(d=>({path:d}))}).assets,Ground:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/ground",assets:["ground-1.json","ground-2.json","ground-3.json","g-1.json","g-2.json","g-3.json","g-4.json","g-5.json"].map(d=>({path:d}))}).assets,CameraViews:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/views",assets:["views-1.json","views-2.json"].map(d=>({path:d}))}).assets,MaterialConfiguration:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/material-conf",assets:["gold-ceramic.json","gold.json","metal-diamond.json"].map(d=>({path:d}))}).assets,MaterialLibraries:new SimpleAssetList({basePath:"https://demo-assets.pixotronics.com/pixo/presets/material-lib",assets:["metal.zip","gem.zip"].map(d=>({path:d}))}).assets};function velocityPerSecond(d,o){return o?d*(1e3/o):0}function inertia(d){var o,l=d.from,c=l===void 0?0:l,u=d.velocity,h=u===void 0?0:u,_=d.min,A=d.max,w=d.power,C=w===void 0?.8:w,M=d.timeConstant,O=M===void 0?750:M,ne=d.bounceStiffness,ce=ne===void 0?500:ne,ue=d.bounceDamping,ye=ue===void 0?10:ue,Oe=d.restDelta,ke=Oe===void 0?1:Oe,Ve=d.modifyTarget,tt=d.driver,ht=d.onUpdate,ut=d.onComplete,_t=d.onStop;function at(kt){return _!==void 0&&kt<_||A!==void 0&&kt>A}function lt(kt){return _===void 0?A:A===void 0||Math.abs(_-kt)<Math.abs(A-kt)?_:A}function pt(kt){o==null||o.stop(),o=animate(__assign(__assign({},kt),{driver:tt,onUpdate:function(Vt){var si;ht==null||ht(Vt),(si=kt.onUpdate)===null||si===void 0||si.call(kt,Vt)},onComplete:ut,onStop:_t}))}function xt(kt){pt(__assign({type:"spring",stiffness:ce,damping:ye,restDelta:ke},kt))}if(at(c))xt({from:c,velocity:h,to:lt(c)});else{var Tt=C*h+c;Ve!==void 0&&(Tt=Ve(Tt));var Pt,Lt,Bt=lt(Tt),Ut=Bt===_?-1:1;pt({type:"decay",from:c,velocity:h,timeConstant:O,power:C,restDelta:ke,modifyTarget:Ve,onUpdate:at(Tt)?function(kt){Pt=Lt,Lt=kt,h=velocityPerSecond(kt-Pt,getFrameData().delta),(Ut===1&&kt>Bt||Ut===-1&&kt<Bt)&&xt({from:kt,to:Bt,velocity:h})}:void 0})}return{stop:function(){return o==null?void 0:o.stop()}}}var radiansToDegrees=function(d){return 180*d/Math.PI},angle=function(d,o){return o===void 0&&(o=zeroPoint),radiansToDegrees(Math.atan2(o.y-d.y,o.x-d.x))},applyOffset=function(d,o){var l=!0;return o===void 0&&(o=d,l=!1),function(c){return l?c-d+o:(d=c,l=!0,o)}},identity=function(d){return d},createAttractor=function(d){return d===void 0&&(d=identity),function(o,l,c){var u=l-c,h=-(0-o+1)*(0-d(Math.abs(u)));return u<=0?l+h:l-h}},attract=createAttractor(),attractExpo=createAttractor(Math.sqrt),degreesToRadians=function(d){return d*Math.PI/180},isPoint=function(d){return d.hasOwnProperty("x")&&d.hasOwnProperty("y")},isPoint3D=function(d){return isPoint(d)&&d.hasOwnProperty("z")},distance1D=function(d,o){return Math.abs(d-o)};function distance(d,o){if(isNum(d)&&isNum(o))return distance1D(d,o);if(isPoint(d)&&isPoint(o)){var l=distance1D(d.x,o.x),c=distance1D(d.y,o.y),u=isPoint3D(d)&&isPoint3D(o)?distance1D(d.z,o.z):0;return Math.sqrt(Math.pow(l,2)+Math.pow(c,2)+Math.pow(u,2))}}var pointFromVector=function(d,o,l){return o=degreesToRadians(o),{x:l*Math.cos(o)+d.x,y:l*Math.sin(o)+d.y}},toDecimal=function(d,o){return o===void 0&&(o=2),o=Math.pow(10,o),Math.round(d*o)/o},smoothFrame=function(d,o,l,c){return c===void 0&&(c=0),toDecimal(d+l*(o-d)/Math.max(c,l))},smooth=function(d){d===void 0&&(d=50);var o=0,l=0;return function(c){var u=getFrameData().timestamp,h=u!==l?u-l:0,_=h?smoothFrame(o,c,h,d):o;return l=u,o=_,_}},snap=function(d){if(typeof d=="number")return function(c){return Math.round(c/d)*d};var o=0,l=d.length;return function(c){var u=Math.abs(d[0]-c);for(o=1;o<l;o++){var h=d[o],_=Math.abs(h-c);if(_===0)return h;if(_>u)return d[o-1];if(o===l-1)return h;u=_}}};function velocityPerFrame(d,o){return d/(1e3/o)}var wrap=function(d,o,l){var c=o-d;return((l-d)%c+c)%c+d},cubic_bezier_a=function(d,o){return 1-3*o+3*d},cubic_bezier_b=function(d,o){return 3*o-6*d},cubic_bezier_c=function(d){return 3*d},calcBezier=function(d,o,l){return((cubic_bezier_a(o,l)*d+cubic_bezier_b(o,l))*d+cubic_bezier_c(o))*d},getSlope=function(d,o,l){return 3*cubic_bezier_a(o,l)*d*d+2*cubic_bezier_b(o,l)*d+cubic_bezier_c(o)},subdivisionPrecision=1e-7,subdivisionMaxIterations=10;function binarySubdivide(d,o,l,c,u){var h,_,A=0;do(h=calcBezier(_=o+(l-o)/2,c,u)-d)>0?l=_:o=_;while(Math.abs(h)>subdivisionPrecision&&++A<subdivisionMaxIterations);return _}var newtonIterations=8,newtonMinSlope=.001;function newtonRaphsonIterate(d,o,l,c){for(var u=0;u<newtonIterations;++u){var h=getSlope(o,l,c);if(h===0)return o;o-=(calcBezier(o,l,c)-d)/h}return o}var kSplineTableSize=11,kSampleStepSize=1/(kSplineTableSize-1);function cubicBezier(d,o,l,c){if(d===o&&l===c)return linear;for(var u=new Float32Array(kSplineTableSize),h=0;h<kSplineTableSize;++h)u[h]=calcBezier(h*kSampleStepSize,d,l);return function(_){return _===0||_===1?_:calcBezier(function(A){for(var w=0,C=1,M=kSplineTableSize-1;C!==M&&u[C]<=A;++C)w+=kSampleStepSize;--C;var O=w+(A-u[C])/(u[C+1]-u[C])*kSampleStepSize,ne=getSlope(O,d,l);return ne>=newtonMinSlope?newtonRaphsonIterate(A,O,d,l):ne===0?O:binarySubdivide(A,w,w+kSampleStepSize,d,l)}(_),o,c)}}var steps_steps=function(d,o){return o===void 0&&(o="end"),function(l){var c=(l=o==="end"?Math.min(l,.999):Math.max(l,.001))*d,u=o==="end"?Math.floor(c):Math.ceil(c);return clamp(0,1,u/d)}};const _lut=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];function generateUUID(){const d=4294967295*Math.random()|0,o=4294967295*Math.random()|0,l=4294967295*Math.random()|0,c=4294967295*Math.random()|0;return(_lut[255&d]+_lut[d>>8&255]+_lut[d>>16&255]+_lut[d>>24&255]+"-"+_lut[255&o]+_lut[o>>8&255]+"-"+_lut[o>>16&15|64]+_lut[o>>24&255]+"-"+_lut[63&l|128]+_lut[l>>8&255]+"-"+_lut[l>>16&255]+_lut[l>>24&255]+_lut[255&c]+_lut[c>>8&255]+_lut[c>>16&255]+_lut[c>>24&255]).toLowerCase()}var AnimationObjectPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_},AnimationObject_1;class AnimationObjectPlugin extends AViewerPlugin{constructor(){super(...arguments),this.enabled=!0,this.animation=new AnimationObject(()=>this._viewer),this.uiConfig=this.animation.uiConfig}async onAdded(o){function l(c){let u="",h=1;for(;h<c.length&&(u+=c[h],c[h].endsWith("\\"));h++)u=u.slice(0,-1),u+=".";return[u,h]}await super.onAdded(o),o._animGetters={objects:c=>{if(c.length<2||!o)return;const[u,h]=l(c);return{tar:o.scene.getObjectByName(u),i:h}},materials:c=>{var u,h,_;if(c.length<2||!o)return;const[A,w]=l(c);return{tar:(_=(h=(u=o.assetManager)===null||u===void 0?void 0:u.materials)===null||h===void 0?void 0:h.findMaterialsByName(A))===null||_===void 0?void 0:_[0],i:w}}}}}AnimationObjectPlugin.PluginType="AnimationObjectPlugin",AnimationObjectPlugin_decorate([serialize(),uiConfig()],AnimationObjectPlugin.prototype,"animation",void 0);let AnimationObject=AnimationObject_1=class{constructor(d){this.target=d,this.uuid=generateUUID(),this.name="",this.access="",this.options={},this.duration=1e3,this.delay=0,this.repeat=1,this.repeatType="mirror",this.ease="easeInOutSine",this.updater=[],this.updateScene=!1,this.updateCamera=!1,this.updateViewer=!1,this.animSetParallel=!1,this.animSet=[],this.uiConfig=generateUiFolder("Animation Object",this,void 0,"folder",!0)}_onAccessChanged(){const d=Ee(this.target),{key:o,tar:l}=extractAnimationKey(this,d);if(this.from=void 0,this.to=void 0,!o||!l)return void this.refreshUi();const c=l[o];if(c==null)return void this.refreshUi();const u=()=>{if(!c)return c;if(c.isColor)return"#"+c.getHexString();const h=typeof c.clone=="function"?c.clone():typeof c=="object"?{...c}:c;return console.log(h),h};this.from=u(),this.to=u(),this.refreshUi()}refreshUi(){var d,o;(o=(d=this.uiConfig)===null||d===void 0?void 0:d.uiRefresh)===null||o===void 0||o.call(d,"postFrame",!0,1)}add(d){this.animSet.push(d),d.parent=this,this.refreshUi()}remove(d){const o=this.animSet.indexOf(d);o>=0&&(this.animSet.splice(o,1),d.parent=void 0,this.refreshUi())}async animate(d=!1){typeof d!="boolean"&&(d=!1);const o=Ee(this.target);if(!o)return void console.warn("AnimationObject: No viewer");d&&(this.options.to=this.from,this.options.from=this.to),this.options.repeatType=this.repeatType,this.options.repeat=this.repeat,this.updater=[],this.updateScene&&this.updater.push("scene"),this.updateCamera&&this.updater.push("camera"),this.updateViewer&&this.updater.push("viewer"),this.animSet.forEach(c=>c.target=this.target),await animateObject(o,this,{viewer:()=>o.setDirty(),renderer:()=>o.renderer.reset(),scene:()=>{o.scene.setDirty()},camera:()=>o.scene.activeCamera.setDirty()}),delete this.options.to,delete this.options.from}async animateReverse(){await this.animate(!0)}async removeFromParent2(){const d=Ee(this.target);this.parent&&d&&await d.confirm(`Delete: Are you sure you want to delete the animation ${this.name}?`)&&this.removeFromParent()}removeFromParent(){this.parent&&this.parent.remove(this)}addAnimation(){this.add(new AnimationObject_1(this.target))}};AnimationObjectPlugin_decorate([serialize(),uiInput()],AnimationObject.prototype,"name",void 0),AnimationObjectPlugin_decorate([serialize(),uiInput(),x(AnimationObject.prototype._onAccessChanged)],AnimationObject.prototype,"access",void 0),AnimationObjectPlugin_decorate([uiConfig(),serialize()],AnimationObject.prototype,"from",void 0),AnimationObjectPlugin_decorate([uiConfig(),serialize()],AnimationObject.prototype,"to",void 0),AnimationObjectPlugin_decorate([serialize()],AnimationObject.prototype,"options",void 0),AnimationObjectPlugin_decorate([serialize(),uiSlider(void 0,[0,1e4],1,d=>({hidden:()=>d.from===void 0}))],AnimationObject.prototype,"duration",void 0),AnimationObjectPlugin_decorate([serialize(),uiSlider(void 0,[0,1e4],1,d=>({hidden:()=>d.from===void 0}))],AnimationObject.prototype,"delay",void 0),AnimationObjectPlugin_decorate([serialize(),uiSlider(void 0,[0,10],1,d=>({hidden:()=>d.from===void 0}))],AnimationObject.prototype,"repeat",void 0),AnimationObjectPlugin_decorate([serialize(),uiDropdown("repeatType",["loop","reverse","mirror"].map(d=>({label:d})),d=>({hidden:()=>d.from===void 0}))],AnimationObject.prototype,"repeatType",void 0),AnimationObjectPlugin_decorate([serialize(),uiDropdown("ease",Object.keys(EasingFunctions$1).map(d=>({label:d})),d=>({hidden:()=>d.from===void 0}))],AnimationObject.prototype,"ease",void 0),AnimationObjectPlugin_decorate([serialize(),uiToggle(void 0,d=>({hidden:()=>d.from===void 0}))],AnimationObject.prototype,"updateScene",void 0),AnimationObjectPlugin_decorate([serialize(),uiToggle(void 0,d=>({hidden:()=>d.from===void 0}))],AnimationObject.prototype,"updateCamera",void 0),AnimationObjectPlugin_decorate([serialize(),uiToggle(void 0,d=>({hidden:()=>d.from===void 0}))],AnimationObject.prototype,"updateViewer",void 0),AnimationObjectPlugin_decorate([uiButton("Animate")],AnimationObject.prototype,"animate",null),AnimationObjectPlugin_decorate([uiButton("Animate Reverse")],AnimationObject.prototype,"animateReverse",null),AnimationObjectPlugin_decorate([uiButton("Delete")],AnimationObject.prototype,"removeFromParent2",null),AnimationObjectPlugin_decorate([serialize(),uiToggle()],AnimationObject.prototype,"animSetParallel",void 0),AnimationObjectPlugin_decorate([serialize(),uiConfig()],AnimationObject.prototype,"animSet",void 0),AnimationObjectPlugin_decorate([uiButton("Add Animation")],AnimationObject.prototype,"addAnimation",null),AnimationObject=AnimationObject_1=AnimationObjectPlugin_decorate([serializable("AnimationObject")],AnimationObject);var GradientSvgPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};let GradientSvgPlugin=class extends AViewerPlugin{constructor(d=!0){super(),this.enabled=!0,this.dependencies=[],this.options={id:generateUUID(),type:"linear",gradientUnits:"objectBoundingBox",linearOptions:{angle:45,x1:0,y1:0,x2:1,y2:1},radialOptions:{cx:.5,cy:.5,r:.5,fx:.5,fy:.5,spreadMethod:"pad"}},this.type="linear",this.gradientUnits="objectBoundingBox",this.position1=new three_module.I9Y(0,0),this.position2=new three_module.I9Y(1,1),this.angle=0,this.radius=.5,this.center=new three_module.I9Y(.5,.5),this.focus=new three_module.I9Y(.5,.5),this.spreadMethod="pad",this._svgGradient=new SvgGradient,this._needsUpdate=!1,this.colors=[new three_module.Q1f(1,1,1),new three_module.Q1f(1,0,0)],this.color1=this.colors[0],this.color2=this.colors[1],this.applyToBackground=!1,this.autoRefresh=!0,this.enabled=d}_refreshOptions(){var d,o,l,c,u,h,_,A;this.options.type=this.type,this.options.gradientUnits=this.gradientUnits,this.options.linearOptions={angle:this.angle,x1:(d=this.position1)===null||d===void 0?void 0:d.x,y1:(o=this.position1)===null||o===void 0?void 0:o.y,x2:(l=this.position2)===null||l===void 0?void 0:l.x,y2:(c=this.position2)===null||c===void 0?void 0:c.y},this.options.radialOptions={cx:(u=this.center)===null||u===void 0?void 0:u.x,cy:(h=this.center)===null||h===void 0?void 0:h.y,r:this.radius,fx:(_=this.focus)===null||_===void 0?void 0:_.x,fy:(A=this.focus)===null||A===void 0?void 0:A.y,spreadMethod:this.spreadMethod},this.setDirty()}setDirty(){this._needsUpdate=!0}addColor(){this.colors.push(new three_module.Q1f),this.setDirty()}refreshSvg(){if((!this.applyToBackground||this._viewer)&&(this._refreshOptions(),this._needsUpdate=!1,this._svgElement=this._svgGradient.get(this.colors,this.options),this.applyToBackground)){const d=`
            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">
            <defs>
            ${this._svgElement.outerHTML}
            </defs>
            <rect width="100%" height="100%" fill="url(#${this.options.id})"/>
            </svg>
            `,o=B(d),l=new Image;l.src=o;const c=new three_module.gPd(l);l.onload=()=>{this._svgTexture===c&&(this._svgTexture.needsUpdate=!0,this._viewer.scene.background=this._svgTexture,this._viewer.setDirty())},this._svgTexture&&this._svgTexture.dispose(),this._svgTexture=c}}async onAdded(d){await super.onAdded(d),d.addEventListener("postFrame",()=>{this.enabled&&this._needsUpdate&&this.autoRefresh&&this.refreshSvg()})}};GradientSvgPlugin.PluginType="GradientSvgPlugin",GradientSvgPlugin_decorate([uiToggle()],GradientSvgPlugin.prototype,"enabled",void 0),GradientSvgPlugin_decorate([serialize(),uiDropdown("type",["linear","radial"].map(d=>({label:d}))),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"type",void 0),GradientSvgPlugin_decorate([serialize(),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"gradientUnits",void 0),GradientSvgPlugin_decorate([serialize(),uiVector("position1",[0,1],.01,d=>({hidden:()=>d.type!=="linear",onChange:()=>d._refreshOptions()})),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"position1",void 0),GradientSvgPlugin_decorate([serialize(),uiVector("position2",[0,1],.01,d=>({hidden:()=>d.type!=="linear",onChange:()=>d._refreshOptions()})),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"position2",void 0),GradientSvgPlugin_decorate([serialize(),uiSlider("angle",[0,360],1,d=>({hidden:()=>d.type!=="linear"})),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"angle",void 0),GradientSvgPlugin_decorate([serialize(),uiSlider("radius",[0,1],.01,d=>({hidden:()=>d.type!=="radial"})),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"radius",void 0),GradientSvgPlugin_decorate([serialize(),uiVector("center",[0,1],.01,d=>({hidden:()=>d.type!=="radial",onChange:()=>d._refreshOptions()})),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"center",void 0),GradientSvgPlugin_decorate([serialize(),uiVector("focus",[0,1],.01,d=>({hidden:()=>d.type!=="radial",onChange:()=>d._refreshOptions()})),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"focus",void 0),GradientSvgPlugin_decorate([serialize(),x(GradientSvgPlugin.prototype._refreshOptions)],GradientSvgPlugin.prototype,"spreadMethod",void 0),GradientSvgPlugin_decorate([serialize()],GradientSvgPlugin.prototype,"colors",void 0),GradientSvgPlugin_decorate([uiColor(void 0,d=>({onChange:()=>d.setDirty()})),x(GradientSvgPlugin.prototype.setDirty)],GradientSvgPlugin.prototype,"color1",void 0),GradientSvgPlugin_decorate([uiColor(void 0,d=>({onChange:()=>d.setDirty()})),x(GradientSvgPlugin.prototype.setDirty)],GradientSvgPlugin.prototype,"color2",void 0),GradientSvgPlugin_decorate([serialize(),uiToggle(),x(GradientSvgPlugin.prototype.setDirty)],GradientSvgPlugin.prototype,"applyToBackground",void 0),GradientSvgPlugin_decorate([uiButton()],GradientSvgPlugin.prototype,"refreshSvg",null),GradientSvgPlugin_decorate([serialize()],GradientSvgPlugin.prototype,"autoRefresh",void 0),GradientSvgPlugin=GradientSvgPlugin_decorate([uiFolder("Gradient SVG")],GradientSvgPlugin);class SvgGradient{constructor(){}get(o,l){return this.colors=o,this.options=l,this.createGradient()}createSvgElement(o){return document.createElementNS("http://www.w3.org/2000/svg",o)}createColorStop(o,l,c){const u=this.createSvgElement("stop");return u.setAttribute("offset",l/c*100+"%"),u.setAttribute("stop-color",o),u}colorsToStops(){const o=this.colors;return o.map((l,c)=>{const u=l.getStyle();return this.createColorStop(u,c,o.length)})}createGradientElement(){const o=this.options,l=this.createSvgElement(`${o.type}Gradient`),c=/((id)|([c|f|x|y|r][x|y|1|2]?)|(gradientUnits))/,u=o[`${o.type}Options`],h={id:o.id,type:o.type,gradientUnits:o.gradientUnits,...u};return Object.entries(h).filter(_=>c.test(_[0])).forEach(_=>{_[0]!=="type"&&l.setAttribute(_[0],_[1])}),h.angle&&l.setAttribute("gradientTransform",`rotate(${h.angle})`),l}createGradient(){const o=this.createGradientElement();return this.colorsToStops().forEach(l=>o.appendChild(l)),o}}var TransformControlsPlugin_decorate=function(d,o,l,c){var u,h=arguments.length,_=h<3?o:c===null?c=Object.getOwnPropertyDescriptor(o,l):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(d,o,l,c);else for(var A=d.length-1;A>=0;A--)(u=d[A])&&(_=(h<3?u(_):h>3?u(o,l,_):u(o,l))||_);return h>3&&_&&Object.defineProperty(o,l,_),_};class TransformControlsPlugin extends AViewerPlugin{setDirty(){var o,l;if(!this._viewer)return;const c=this._viewer.getPlugin(PickingPlugin),u=this.enabled;u&&c.widgetEnabled?(c.enableWidget(!1),this._pickingWidgetDisabled=!0):!u&&this._pickingWidgetDisabled&&(c.enableWidget(!0),this._pickingWidgetDisabled=!1),this.transformControls&&(u&&c.getSelectedObject()?this.transformControls.attach(c.getSelectedObject()):this.transformControls.detach()),this._viewer.setDirty(),(l=(o=this.uiConfig)===null||o===void 0?void 0:o.uiRefresh)===null||l===void 0||l.call(o,"postFrame",!0,1)}constructor(o=!0){super(),this.uiConfig={type:"folder",label:"Transform Controls",children:[...generateUiConfig(this),()=>{var l;return(l=this.transformControls)===null||l===void 0?void 0:l.uiConfig}]},this.enabled=!0,this._pickingWidgetDisabled=!1,this.toJSON=void 0,this.dependencies=[PickingPlugin],this._isInteracting=!1,this._transformState={obj:null,position:new three_module.Pq0,rotation:new three_module.O9p,scale:new three_module.Pq0},this._activeCameraChange=()=>{this.transformControls&&this._viewer&&(this.transformControls.camera=this._viewer.scene.activeCamera.cameraObject)},TransformControls.ObjectConstructors.MeshBasicMaterial=MeshBasicMaterial2,this.enabled=o}get undoManager(){var o,l;return(l=(o=this._viewer)===null||o===void 0?void 0:o.getPlugin(TweakpaneUiPlugin$1))===null||l===void 0?void 0:l.undoManager}async onAdded(o){await super.onAdded(o),this.setDirty(),this.transformControls=new TransformControls2(o.scene.activeCamera.cameraObject,o.canvas),this._activeCameraChange=this._activeCameraChange.bind(this),o.scene.addEventListener("activeCameraChange",this._activeCameraChange),this.transformControls.addEventListener("dragging-changed",l=>{if(!(this!=null&&this._viewer))return;const c=this._viewer.scene.activeCamera.controls;typeof(c==null?void 0:c.stopDamping)=="function"&&(c!=null&&c.enabled)&&c.stopDamping(),this._viewer.scene.activeCamera.setInteractions(!l.value,TransformControlsPlugin.PluginType)}),this.transformControls.addEventListener("axis-changed",l=>{if(!(this!=null&&this._viewer))return;this._isInteracting=!!l.value;const c=this._viewer.scene.activeCamera.controls;typeof(c==null?void 0:c.stopDamping)=="function"&&(c!=null&&c.enabled)&&c.stopDamping(),this._viewer.setDirty()}),o.scene.addSceneObject(this.transformControls,{addToRoot:!0}),o.getPlugin(PickingPlugin).addEventListener("selectedObjectChanged",l=>{this.transformControls&&(this.enabled?l.object?this.transformControls.attach(l.object):this.transformControls.detach():this.transformControls.object&&this.transformControls.detach())}),this.transformControls.addEventListener("mouseDown",()=>{if(!this.transformControls)return;const l=this.transformControls.object;l&&(this._transformState.obj=l,this._transformState.position=l.position.clone(),this._transformState.rotation=l.rotation.clone(),this._transformState.scale=l.scale.clone())}),this.transformControls.addEventListener("mouseUp",()=>{if(!this.transformControls)return;const l=this.transformControls.object;if(!l||this._transformState.obj!==l||!this.undoManager)return;const c={translate:"position",rotate:"rotation",scale:"scale"}[this.transformControls.getMode()];if(!c||this._transformState[c].equals(l[c]))return;const u={last:this._transformState[c].clone(),current:l[c].clone(),set:h=>{var _,A;l[c].copy(h),l.updateMatrixWorld(!0),(_=this.transformControls)===null||_===void 0||_.dispatchEvent({type:"change"}),(A=this.transformControls)===null||A===void 0||A.dispatchEvent({type:"objectChange"})},undo:()=>u.set(u.last),redo:()=>u.set(u.current)};this.undoManager.record(u)})}async onRemove(o){o.scene.removeEventListener("activeCameraChange",this._activeCameraChange),this.transformControls&&(this.transformControls.detach(),o.scene.remove(this.transformControls),this.transformControls.dispose()),this.transformControls=void 0,await super.onRemove(o)}}TransformControlsPlugin.PluginType="TransformControlsPlugin",TransformControlsPlugin_decorate([uiToggle(),x(TransformControlsPlugin.prototype.setDirty)],TransformControlsPlugin.prototype,"enabled",void 0);class CoreEditorApp extends ViewerApp{get editorInitialized(){return this._editorInitialized}constructor(o){super(o),this._editorInitialized=!1,this.defaultModes=[{title:"Viewer",plugins:[RendererUiPlugin,CameraUiPlugin,PresetLibraryPlugin,DropzonePlugin]},{title:"Picking",plugins:[HierarchyUiPlugin,PickingPlugin,TransformControlsPlugin,DiamondPlugin,MaterialLibraryPlugin,XAtlasPlugin,Object3DWidgetsPlugin]},{title:"Scene",plugins:[SimpleBackgroundEnvUiPlugin,GroundPlugin,SimpleViewerUi,LightsUiPlugin,SceneCamerasUiPlugin,RandomizedDirectionalLightPlugin,HDRiGroundPlugin,ContactShadowGroundPlugin,GeometryGeneratorPlugin,GradientSvgPlugin]},{title:"Anti-aliasing",plugins:[ProgressivePlugin,TemporalAAPlugin,VelocityBufferPlugin]},{title:"Post Processing",plugins:[TonemapPlugin,OutlinePlugin,LUTPlugin,ChromaticAberrationPlugin,FilmicGrainPlugin,VignettePlugin,SSRPlugin,SSAOPlugin,BloomPlugin,DepthOfFieldPlugin,SSGIPlugin,SSContactShadows,SSBevelPlugin]},{title:"Export",plugins:[AssetExporterPlugin,CanvasSnipperPlugin,CanvasRecorderPlugin,AWSClientPlugin,TransfrSharePlugin]},{title:"Animations",plugins:[GLTFAnimationPlugin,CameraViewPlugin,AnimationObjectPlugin,ScrollableCameraViewPreviewPlugin,CannonPhysicsPlugin,PosePlugin]},{title:"Modifiers",plugins:[ObjectRotationPlugin,ShapeTubeExtrudePlugin,SimpleTextPlugin,ParallaxMappingPlugin,CSGPluginBSP,CSGPluginBVH,ParallaxCameraControllerPlugin,MeshOptSimplifyModifierPlugin]},{title:"Configurators",plugins:[SwitchNodePlugin,MaterialConfiguratorPlugin,GLTFKHRMaterialVariantsPlugin,VariationConfiguratorEditorUiPlugin]},{title:"Plugins",plugins:[InteractionPromptPlugin,AnisotropyPlugin,FullScreenPlugin,CustomBumpMapPlugin,FrameFadePlugin,ClearcoatTintPlugin,ThinFilmLayerPlugin,FragmentClippingExtensionPlugin,NormalBufferPlugin,NoiseBumpMaterialPlugin,LoadingScreenPlugin,CSS3DRendererPlugin,Rhino3dmLoadPlugin,ModelStagePlugin]},{title:"Extras",plugins:[ExtrasUiPlugin,SnowFallPlugin,WaveGroundPlugin,VRPluginBasic,VirtualCamerasPlugin,RainbowDiamondPlugin,BeringRingAnimation]}],setupModesStyles();const l=this.scene.activeCamera.controls;l&&(l.autoPushTarget2=!0)}async setupUi(o,l){await setupModesUi(this,o,l??this.defaultModes),this._editorInitialized=!0}}async function addEditorPlugins(d,{debug:o=!1,ground:l=!0,bloom:c=!0,depthTonemap:u=!0,importPopup:h=!0,caching:_=!0,presetLibrary:A=!0,switchNode:w=!0,materialConfigurator:C=!0}){d.enabled=!1,KTX2LoadPlugin.SAVE_SOURCE_BLOBS=!0,o&&await d.addPlugin(DebugPlugin),d.getPlugin(AssetManagerPlugin)||await d.addPlugin(AssetManagerPlugin,void 0,void 0,{storage:_&&window.caches?await window.caches.open("webgi-cache-storage"):void 0}),await d.addPlugin(AssetExporterPlugin),await d.addPlugin(GLTFDracoExportPlugin),await d.addPlugin(GLTFSpecGlossinessConverterPlugin),await d.addPlugin(FileTransferPlugin),h&&((await d.addPlugin(LoadingScreenPlugin)).isEditor=!0),await d.addPlugin(WindowiseDialogPlugin),await d.addPlugin(VirtualCamerasPlugin,!1),await d.getOrAddPlugin(KTXLoadPlugin),await d.addPlugin(PopmotionPlugin),await d.getOrAddPlugin(DropzonePlugin),await d.addPlugin(CannonPhysicsPlugin),await d.addPlugin(TransformAnimationPlugin),await d.addPlugin(PickingPlugin,BoxSelectionWidget,!1,!0),await d.addPlugin(TransformControlsPlugin,!1),await addBasePlugins(d,{ground:l,bloom:c,depthTonemap:u}),(await d.getOrAddPlugin(FrameFadePlugin)).isEditor=!0,A&&await d.getOrAddPlugin(PresetLibraryPlugin),await d.getOrAddPlugin(DiamondPlugin),await d.addPlugin(OutlinePlugin),await d.addPlugin(ParallaxMappingPlugin,!1),await d.addPlugin(DeviceOrientationControlsPlugin),await d.addPlugin(FirstPersonControlsPlugin),await d.addPlugin(PointerLockControlsPlugin),await d.addPlugin(TrackballControlsPlugin),await d.addPlugin(CSS3DRendererPlugin,!1),await d.addPlugin(new ObjectRotationPlugin(!1)),await d.addPlugin(ShapeTubeExtrudePlugin),await d.addPlugin(SimpleTextPlugin),C&&((await d.addPlugin(MaterialConfiguratorPlugin)).enableEditContextMenus=!0),w&&await d.addPlugin(SwitchNodePlugin),await d.addPlugin(VariationConfiguratorEditorUiPlugin),await d.addPlugin(MaterialLibraryPlugin),await d.addPlugin(CanvasRecorderPlugin),await d.addPlugin(CanvasSnipperPlugin),await d.addPlugin(HierarchyUiPlugin),await d.addPlugin(SimpleViewerUi),await d.addPlugin(LightsUiPlugin),await d.addPlugin(SceneCamerasUiPlugin),await d.addPlugin(RendererUiPlugin),await d.addPlugin(CameraUiPlugin),await d.addPlugin(SimpleBackgroundEnvUiPlugin),await d.addPlugin(Object3DWidgetsPlugin,!1),await d.addPlugin(GeometryGeneratorPlugin),await d.addPlugin(XAtlasPlugin),await d.addPlugin(ScrollableCameraViewPreviewPlugin,d.container,!1),await d.addPlugin(AWSClientPlugin),await d.addPlugin(RainbowDiamondPlugin),await d.addPlugin(TransfrSharePlugin),await d.addPlugin(GradientSvgPlugin),await d.addPlugin(AnimationObjectPlugin),await d.addPlugin(MeshOptSimplifyModifierPlugin),await d.addPlugin(SnowFallPlugin),await d.addPlugin(WaveGroundPlugin),await d.addPlugin(PosePlugin);const M=await d.addPlugin(new TweakpaneUiPlugin$1(!we()));return d.renderer.refreshPipeline(),d.scene.addEventListener("textureAdded",O=>{O.texture&&d.setEnvironmentMap(O.texture)}),M.setupPluginUi(FullScreenPlugin),M.setupPluginUi(RendererUiPlugin),M.setupPluginUi(CameraUiPlugin),M.setupPluginUi(LoadingScreenPlugin),M.setupPluginUi(DropzonePlugin),M.setupPluginUi(SimpleBackgroundEnvUiPlugin),M.setupPluginUi(AssetExporterPlugin),M.setupPluginUi(GLTFAnimationPlugin),M.setupPluginUi(RandomizedDirectionalLightPlugin),w&&M.setupPluginUi(SwitchNodePlugin),C&&M.setupPluginUi(MaterialConfiguratorPlugin),M.setupPluginUi(CannonPhysicsPlugin),M.setupPluginUi(HierarchyUiPlugin),M.setupPluginUi(MaterialLibraryPlugin),M.setupPluginUi(DiamondPlugin),M.setupPluginUi(TransformControlsPlugin),M.setupPluginUi(PickingPlugin),l&&d.getPlugin(GroundPlugin)&&M.setupPluginUi(GroundPlugin),l&&d.getPlugin(ContactShadowGroundPlugin)&&M.setupPluginUi(ContactShadowGroundPlugin),M.setupPluginUi(SSRPlugin),M.setupPluginUi(CameraViewPlugin),M.setupPluginUi(CanvasRecorderPlugin),M.setupPluginUi(TonemapPlugin),M.setupPluginUi(OutlinePlugin),M.setupPluginUi(ChromaticAberrationPlugin),M.setupPluginUi(FilmicGrainPlugin),M.setupPluginUi(LUTPlugin),M.setupPluginUi(VignettePlugin),M.setupPluginUi(DepthOfFieldPlugin),M.setupPluginUi(SSAOPlugin),M.setupPluginUi(NormalBufferPlugin),M.setupPluginUi(SSBevelPlugin),M.setupPluginUi(SimpleViewerUi),M.setupPluginUi(ObjectRotationPlugin),M.setupPluginUi(ShapeTubeExtrudePlugin),M.setupPluginUi(ProgressivePlugin),M.setupPluginUi(GradientSvgPlugin),M.setupPluginUi(AnimationObjectPlugin),M.setupPluginUi(LightsUiPlugin),M.setupPluginUi(SceneCamerasUiPlugin),M.setupPluginUi(ThinFilmLayerPlugin),M.setupPluginUi(FragmentClippingExtensionPlugin),M.setupPluginUi(NoiseBumpMaterialPlugin),c&&M.setupPluginUi(BloomPlugin),M.setupPluginUi(CanvasSnipperPlugin),M.setupPluginUi(AnisotropyPlugin),M.setupPluginUi(TemporalAAPlugin),M.setupPluginUi(HDRiGroundPlugin),M.setupPluginUi(SSGIPlugin),M.setupPluginUi(SSContactShadows),M.setupPluginUi(SimpleTextPlugin),M.setupPluginUi(FrameFadePlugin),M.setupPluginUi(VelocityBufferPlugin),M.setupPluginUi(ModelStagePlugin),A&&M.setupPluginUi(PresetLibraryPlugin),M.setupPluginUi(GLTFKHRMaterialVariantsPlugin),M.setupPluginUi(CustomBumpMapPlugin),M.setupPluginUi(ParallaxMappingPlugin),M.setupPluginUi(CSS3DRendererPlugin),M.setupPluginUi(AWSClientPlugin),M.setupPluginUi(ScrollableCameraViewPreviewPlugin),M.setupPluginUi(XAtlasPlugin),M.setupPluginUi(VariationConfiguratorEditorUiPlugin),M.setupPluginUi(ParallaxCameraControllerPlugin),M.setupPluginUi(Object3DWidgetsPlugin),M.setupPluginUi(Rhino3dmLoadPlugin),M.setupPluginUi(VirtualCamerasPlugin),M.setupPluginUi(GeometryGeneratorPlugin),M.setupPluginUi(InteractionPromptPlugin),M.setupPluginUi(RainbowDiamondPlugin),M.setupPluginUi(TransfrSharePlugin),M.setupPluginUi(MeshOptSimplifyModifierPlugin),M.setupPluginUi(SnowFallPlugin),M.setupPluginUi(WaveGroundPlugin),M.setupPluginUi(PosePlugin),d.enabled=!0,d}async function setupSandboxWebGiEditor(d,{debug:o=!1,ground:l=!0,bloom:c=!0,depthTonemap:u=!0,importPopup:h=!0,caching:_=!0}){const A=new ViewerApp(d);return await addEditorPlugins(A,{debug:o,ground:l,bloom:c,depthTonemap:u,importPopup:h,caching:_}),A}async function setupCoreWebGiViewer(d,{debug:o=!1,ground:l=!0,bloom:c=!0,depthTonemap:u=!0,importPopup:h=!1,enableDrop:_=!1,caching:A=!0}={}){const w=new ViewerApp(d);return o&&await w.addPlugin(DebugPlugin),w.getPlugin(AssetManagerPlugin)||w.addPluginSync(AssetManagerPlugin,void 0,void 0,{storage:A&&window.caches?await caches.open("webgi-cache-storage"):void 0}),await w.addPlugin(AssetManagerLoadingBarPlugin,!0),await addBasePlugins(w,{ground:l,bloom:c,depthTonemap:u,enableDrop:_,importPopup:h}),await w.getOrAddPlugin(DiamondPlugin),w}__webpackgi_exports__.CZu;__webpackgi_exports__.FV;__webpackgi_exports__.oK2;__webpackgi_exports__.SLH;__webpackgi_exports__.yo9;__webpackgi_exports__.YJd;__webpackgi_exports__.qnC;__webpackgi_exports__.TtJ;__webpackgi_exports__.rUH;__webpackgi_exports__.oAs;__webpackgi_exports__.$fV;__webpackgi_exports__.upe;__webpackgi_exports__.yPJ;__webpackgi_exports__.gO9;__webpackgi_exports__.XrR;__webpackgi_exports__.DAe;__webpackgi_exports__.EZo;__webpackgi_exports__.wrO;__webpackgi_exports__.FFZ;__webpackgi_exports__.lGu;__webpackgi_exports__.sKt;__webpackgi_exports__.$p8;__webpackgi_exports__.nJr;__webpackgi_exports__.pPE;var __webpackgi_exports__AnimationClip=__webpackgi_exports__.tz3;__webpackgi_exports__.kEx;var __webpackgi_exports__AnimationMixer=__webpackgi_exports__.Iw4;__webpackgi_exports__.P5j;__webpackgi_exports__.AKb;__webpackgi_exports__.GXy;__webpackgi_exports__.ibB;__webpackgi_exports__.nZQ;__webpackgi_exports__.E0M;__webpackgi_exports__.GLG;__webpackgi_exports__.$VP;__webpackgi_exports__.NeI;__webpackgi_exports__.rzc;__webpackgi_exports__.Kiu;var __webpackgi_exports__AssetManagerPlugin=__webpackgi_exports__.XDT;__webpackgi_exports__.XiN;__webpackgi_exports__._I9;__webpackgi_exports__.ShE;__webpackgi_exports__.OXP;__webpackgi_exports__.JZ8;__webpackgi_exports__.gS4;__webpackgi_exports__.eFx;__webpackgi_exports__.peq;__webpackgi_exports__.hw0;__webpackgi_exports__._DG;__webpackgi_exports__.fP5;__webpackgi_exports__.CwR;__webpackgi_exports__.UtX;__webpackgi_exports__.Pf$;__webpackgi_exports__.Am1;__webpackgi_exports__.IzY;__webpackgi_exports__.hsX;__webpackgi_exports__.XFr;__webpackgi_exports__.Eh1;__webpackgi_exports__.RJS;__webpackgi_exports__.Rkk;__webpackgi_exports__.bTm;__webpackgi_exports__.Otl;__webpackgi_exports__.pOj;__webpackgi_exports__.jg0;__webpackgi_exports__.$Kf;__webpackgi_exports__.YOZ;__webpackgi_exports__.UtB;__webpackgi_exports__.NRn;__webpackgi_exports__.DYt;__webpackgi_exports__.BND;__webpackgi_exports__.iNn;__webpackgi_exports__.IWo;__webpackgi_exports__.SYd;__webpackgi_exports__.THS;__webpackgi_exports__.LoY;__webpackgi_exports__.SUR;__webpackgi_exports__.tJf;__webpackgi_exports__.Y3u;__webpackgi_exports__.poD;__webpackgi_exports__.gaG;__webpackgi_exports__.z0x;__webpackgi_exports__.l2R;__webpackgi_exports__.i7d;__webpackgi_exports__.mL7;__webpackgi_exports__.WTh;__webpackgi_exports__.l5h;__webpackgi_exports__.hzv;__webpackgi_exports__.f_U;var __webpackgi_exports__CameraViewPlugin=__webpackgi_exports__.sxt;__webpackgi_exports__.af0;__webpackgi_exports__.Phj;__webpackgi_exports__.p5D;__webpackgi_exports__.CS6;__webpackgi_exports__.aKT;__webpackgi_exports__.RzO;var __webpackgi_exports__CanvasTexture=__webpackgi_exports__.GOR;__webpackgi_exports__.qU7;__webpackgi_exports__.B6O;__webpackgi_exports__.z1d;__webpackgi_exports__.nNL;__webpackgi_exports__.tcD;__webpackgi_exports__.ghU;__webpackgi_exports__.Dk8;__webpackgi_exports__.zD7;__webpackgi_exports__.Q1f;__webpackgi_exports__.T6I;__webpackgi_exports__.ppV;__webpackgi_exports__.FvD;__webpackgi_exports__.n3b;__webpackgi_exports__.iOZ;__webpackgi_exports__.c5h;__webpackgi_exports__.YSM;__webpackgi_exports__.YRT;__webpackgi_exports__.qFE;__webpackgi_exports__.fCM;__webpackgi_exports__.afc;__webpackgi_exports__.hLJ;__webpackgi_exports__.F1T;__webpackgi_exports__.SXA;__webpackgi_exports__.hy7;__webpackgi_exports__.xFO;__webpackgi_exports__.b4q;__webpackgi_exports__.ScU;__webpackgi_exports__.Om;__webpackgi_exports__.Z0B;__webpackgi_exports__.s0K;__webpackgi_exports__.Pdi;__webpackgi_exports__.Vb5;__webpackgi_exports__.Jnc;__webpackgi_exports__.ywQ;__webpackgi_exports__.WNZ;__webpackgi_exports__.Ipv;__webpackgi_exports__.jGm;__webpackgi_exports__.Ogy;__webpackgi_exports__.xLk;__webpackgi_exports__.bCz;__webpackgi_exports__.bGG;__webpackgi_exports__.g7M;__webpackgi_exports__.Ho_;__webpackgi_exports__.hjs;__webpackgi_exports__.Zn9;__webpackgi_exports__.AHf;__webpackgi_exports__.dYF;__webpackgi_exports__.rFo;__webpackgi_exports__.GYF;__webpackgi_exports__.BRH;__webpackgi_exports__.psi;__webpackgi_exports__.GxU;__webpackgi_exports__.n2t;__webpackgi_exports__.yuL;__webpackgi_exports__.YMq;__webpackgi_exports__.ROr;__webpackgi_exports__.fJr;__webpackgi_exports__.h_9;__webpackgi_exports__.Gyi;__webpackgi_exports__.zdS;__webpackgi_exports__.WCV;__webpackgi_exports__._Vf;__webpackgi_exports__.dcC;__webpackgi_exports__.VCu;__webpackgi_exports__.n1S;__webpackgi_exports__.sOF;__webpackgi_exports__.aFP;__webpackgi_exports__.GMU;__webpackgi_exports__.ZyN;__webpackgi_exports__.rFg;__webpackgi_exports__.PFK;__webpackgi_exports__.Yhb;__webpackgi_exports__.V5c;__webpackgi_exports__.nEu;__webpackgi_exports__.$EB;__webpackgi_exports__.mRE;__webpackgi_exports__.hSt;__webpackgi_exports__.hdd;__webpackgi_exports__.wn6;__webpackgi_exports__.MOq;__webpackgi_exports__.Vnu;__webpackgi_exports__.hIf;__webpackgi_exports__.d5G;__webpackgi_exports__.vr8;__webpackgi_exports__.JCs;__webpackgi_exports__.TDQ;__webpackgi_exports__.WYq;__webpackgi_exports__.S20;__webpackgi_exports__.LWT;__webpackgi_exports__.MJ1;__webpackgi_exports__.KDW;__webpackgi_exports__.SQT;__webpackgi_exports__.kO0;__webpackgi_exports__.U3G;__webpackgi_exports__.jsO;__webpackgi_exports__.wfO;__webpackgi_exports__.uV5;__webpackgi_exports__.O9p;__webpackgi_exports__.Qev;__webpackgi_exports__.j8I;__webpackgi_exports__.QCA;__webpackgi_exports__.ol2;__webpackgi_exports__.y74;__webpackgi_exports__.lT0;__webpackgi_exports__.Y9S;__webpackgi_exports__.ryq;__webpackgi_exports__.xcV;__webpackgi_exports__.OMG;__webpackgi_exports__.Vkg;__webpackgi_exports__.Oax;__webpackgi_exports__.qtW;__webpackgi_exports__.V58;__webpackgi_exports__.RQf;__webpackgi_exports__.jUj;__webpackgi_exports__.cRK;__webpackgi_exports__.ziY;__webpackgi_exports__.kzd;var __webpackgi_exports__FrameFadePlugin=__webpackgi_exports__.VNy;__webpackgi_exports__.Pem;__webpackgi_exports__.hB5;__webpackgi_exports__.PPD;__webpackgi_exports__.BH6;var __webpackgi_exports__GBufferPlugin=__webpackgi_exports__.HSI;__webpackgi_exports__.oh6;__webpackgi_exports__.Wyr;__webpackgi_exports__.Wdf;__webpackgi_exports__.P3V;__webpackgi_exports__.s0N;__webpackgi_exports__._Js;__webpackgi_exports__.xQA;__webpackgi_exports__.Yeh;__webpackgi_exports__.N30;__webpackgi_exports__.P44;__webpackgi_exports__.MdZ;__webpackgi_exports__.Cc9;__webpackgi_exports__.HjZ;__webpackgi_exports__.UX5;__webpackgi_exports__.fGP;__webpackgi_exports__.T03;var __webpackgi_exports__GammaCorrectionPlugin=__webpackgi_exports__.fPK;__webpackgi_exports__.XpU;__webpackgi_exports__.hUz;__webpackgi_exports__.pbu;__webpackgi_exports__.jhn;__webpackgi_exports__.eoi;__webpackgi_exports__.K52;__webpackgi_exports__.gWB;__webpackgi_exports__.Gwm;__webpackgi_exports__.TMh;__webpackgi_exports__.RcT;__webpackgi_exports__.fTw;var __webpackgi_exports__GroundPlugin=__webpackgi_exports__.Hx_;__webpackgi_exports__.YJl;__webpackgi_exports__.asK;__webpackgi_exports__._qo;__webpackgi_exports__.Ne;__webpackgi_exports__.Guc;__webpackgi_exports__.ix0;__webpackgi_exports__.dth;__webpackgi_exports__.R1W;__webpackgi_exports__.tcR;__webpackgi_exports__.WBB;__webpackgi_exports__.Kzg;__webpackgi_exports__.$NF;__webpackgi_exports__.NuM;__webpackgi_exports__.HgN;__webpackgi_exports__.l9C;__webpackgi_exports__.HLH;__webpackgi_exports__.Ru$;__webpackgi_exports__.ELl;__webpackgi_exports__.uWO;__webpackgi_exports__.CmU;__webpackgi_exports__.LuO;__webpackgi_exports__.ZLX;__webpackgi_exports__.Hrb;__webpackgi_exports__.vmz;__webpackgi_exports__.wvS;__webpackgi_exports__.Yuy;var __webpackgi_exports__InteractionPromptPlugin=__webpackgi_exports__.K5h;__webpackgi_exports__.eB$;__webpackgi_exports__.eHs;__webpackgi_exports__.lGw;__webpackgi_exports__.ljd;__webpackgi_exports__.PJ3;__webpackgi_exports__.EQC;__webpackgi_exports__.oVO;__webpackgi_exports__.Yj4;__webpackgi_exports__.ZPL;__webpackgi_exports__.$16;__webpackgi_exports__.VVr;__webpackgi_exports__.UJ6;__webpackgi_exports__.UpK;__webpackgi_exports__.ZYb;__webpackgi_exports__.nzx;__webpackgi_exports__.DLJ;__webpackgi_exports__.zgK;__webpackgi_exports__.vim;__webpackgi_exports__.brA;__webpackgi_exports__.TiK;__webpackgi_exports__.xSv;__webpackgi_exports__.CR7;__webpackgi_exports__.kYr;__webpackgi_exports__.veJ;__webpackgi_exports__.FZo;__webpackgi_exports__.Dvx;__webpackgi_exports__.N1A;__webpackgi_exports__.XkL;__webpackgi_exports__.cZY;__webpackgi_exports__.mrM;__webpackgi_exports__.GZZ;__webpackgi_exports__.VnP;__webpackgi_exports__.Fvt;__webpackgi_exports__.vK6;__webpackgi_exports__.FCc;__webpackgi_exports__.GV4;__webpackgi_exports__.DXC;__webpackgi_exports__.bFd;__webpackgi_exports__.n31;__webpackgi_exports__.qIQ;__webpackgi_exports__.tgE;__webpackgi_exports__.k6q;__webpackgi_exports__.ezk;__webpackgi_exports__.NZq;__webpackgi_exports__.iUH;__webpackgi_exports__.$_I;__webpackgi_exports__.kRr;__webpackgi_exports__.Zr2;__webpackgi_exports__.kyO;__webpackgi_exports__.VxR;__webpackgi_exports__.aHM;__webpackgi_exports__.r6x;__webpackgi_exports__.KPJ;__webpackgi_exports__.O0Q;var __webpackgi_exports__LoopOnce=__webpackgi_exports__.G3T;__webpackgi_exports__.lc7;var __webpackgi_exports__LoopRepeat=__webpackgi_exports__.aMy;__webpackgi_exports__.CMB;__webpackgi_exports__.Kzv;__webpackgi_exports__.kBv;__webpackgi_exports__.T6P;__webpackgi_exports__.imn;__webpackgi_exports__.Bhh;__webpackgi_exports__.q$N;__webpackgi_exports__.pzC;__webpackgi_exports__.xbg;__webpackgi_exports__.LTv;__webpackgi_exports__.usO;__webpackgi_exports__.jut;__webpackgi_exports__.Jxy;__webpackgi_exports__.Kmw;__webpackgi_exports__.jR8;__webpackgi_exports__.cj9;__webpackgi_exports__.dwI;__webpackgi_exports__.kn4;__webpackgi_exports__.$ei;__webpackgi_exports__.eaF;__webpackgi_exports__.V9B;__webpackgi_exports__.NLY;__webpackgi_exports__.CSG;__webpackgi_exports__.aVO;__webpackgi_exports__.G_z;__webpackgi_exports__.FNr;__webpackgi_exports__.qBx;__webpackgi_exports__.onB;__webpackgi_exports__.tXL;__webpackgi_exports__.uSd;__webpackgi_exports__._4j;__webpackgi_exports__.gCR;__webpackgi_exports__.Df;__webpackgi_exports__.znC;__webpackgi_exports__.kTW;__webpackgi_exports__.KRh;__webpackgi_exports__.$iG;__webpackgi_exports__.eti;__webpackgi_exports__.Um5;__webpackgi_exports__.tF0;__webpackgi_exports__.EdD;__webpackgi_exports__.caT;__webpackgi_exports__.hxR;__webpackgi_exports__.a$r;__webpackgi_exports__.$O9;__webpackgi_exports__.Cfg;__webpackgi_exports__.pHI;__webpackgi_exports__.amv;__webpackgi_exports__.eHc;__webpackgi_exports__.HPb;__webpackgi_exports__.XIg;__webpackgi_exports__.jf0;__webpackgi_exports__.y_p;__webpackgi_exports__.dFv;__webpackgi_exports__.Ke9;__webpackgi_exports__.NTi;__webpackgi_exports__.nqf;__webpackgi_exports__.hws;__webpackgi_exports__.jzd;__webpackgi_exports__.bw0;__webpackgi_exports__.klZ;__webpackgi_exports__.Hit;__webpackgi_exports__.DJz;__webpackgi_exports__.UwE;__webpackgi_exports__.B69;__webpackgi_exports__.QA8;__webpackgi_exports__.$xz;__webpackgi_exports__.XTe;__webpackgi_exports__.zjB;__webpackgi_exports__.sHL;__webpackgi_exports__.Upe;__webpackgi_exports__.nEH;__webpackgi_exports__.vyJ;__webpackgi_exports__.Ufg;__webpackgi_exports__.qad;__webpackgi_exports__.Nt7;__webpackgi_exports__.aEY;__webpackgi_exports__.OuU;__webpackgi_exports__.LiQ;__webpackgi_exports__.xYO;__webpackgi_exports__.c07;__webpackgi_exports__.qUd;__webpackgi_exports__.I_i;__webpackgi_exports__.wqq;__webpackgi_exports__.QP0;__webpackgi_exports__.Wk7;__webpackgi_exports__.BdL;__webpackgi_exports__.Q7O;__webpackgi_exports__.uxM;__webpackgi_exports__.N9C;__webpackgi_exports__.wAk;__webpackgi_exports__.ubm;var __webpackgi_exports__PickingPlugin=__webpackgi_exports__.PG6;__webpackgi_exports__.Zcv;__webpackgi_exports__.bdM;__webpackgi_exports__.ZM4;__webpackgi_exports__._EQ;__webpackgi_exports__.HiM;__webpackgi_exports__.RXx;__webpackgi_exports__.F1l;__webpackgi_exports__.W_W;__webpackgi_exports__.FnS;__webpackgi_exports__.oPt;__webpackgi_exports__.ONl;__webpackgi_exports__.BH$;__webpackgi_exports__.hzE;__webpackgi_exports__.pFK;var __webpackgi_exports__PopmotionPlugin=__webpackgi_exports__.j9d;__webpackgi_exports__.DeC;__webpackgi_exports__.xZx;__webpackgi_exports__.ZaL;__webpackgi_exports__.UwN;var __webpackgi_exports__ProgressivePlugin=__webpackgi_exports__.hzf;__webpackgi_exports__.Nwf;__webpackgi_exports__.N2s;__webpackgi_exports__.dAo;__webpackgi_exports__.CV9;__webpackgi_exports__.PTz;__webpackgi_exports__.MBL;__webpackgi_exports__.GBG;__webpackgi_exports__.HO_;__webpackgi_exports__.Kef;__webpackgi_exports__.sPf;__webpackgi_exports__.N5j;__webpackgi_exports__.GWd;__webpackgi_exports__.c90;__webpackgi_exports__.y3Z;__webpackgi_exports__.uB5;__webpackgi_exports__.lyL;__webpackgi_exports__.bC7;__webpackgi_exports__.ojs;__webpackgi_exports__.S$4;__webpackgi_exports__.qa3;__webpackgi_exports__.B_h;__webpackgi_exports__.czI;__webpackgi_exports__.rSH;__webpackgi_exports__.Qrf;__webpackgi_exports__.psI;__webpackgi_exports__.a5J;__webpackgi_exports__._QJ;__webpackgi_exports__.Fn;__webpackgi_exports__.KDk;__webpackgi_exports__.pBf;__webpackgi_exports__.HXV;__webpackgi_exports__.Nz6;__webpackgi_exports__.jR7;__webpackgi_exports__.BXX;__webpackgi_exports__.DAr;__webpackgi_exports__.uC4;__webpackgi_exports__.H23;__webpackgi_exports__.W9U;__webpackgi_exports__.CVz;__webpackgi_exports__.Riy;__webpackgi_exports__.kTp;__webpackgi_exports__.k6Q;__webpackgi_exports__.IE4;__webpackgi_exports__.paN;__webpackgi_exports__.TkQ;__webpackgi_exports__.qa1;__webpackgi_exports__.EZL;__webpackgi_exports__.fMJ;__webpackgi_exports__.D$Q;__webpackgi_exports__.RlV;var __webpackgi_exports__Raycaster=__webpackgi_exports__.tBo;__webpackgi_exports__.z5;__webpackgi_exports__.ure;__webpackgi_exports__.VT0;__webpackgi_exports__.ZQM;__webpackgi_exports__.TyI;__webpackgi_exports__.Mjd;__webpackgi_exports__.O0B;__webpackgi_exports__.FZz;__webpackgi_exports__.GJx;__webpackgi_exports__.kG0;__webpackgi_exports__.nST;__webpackgi_exports__.AUf;__webpackgi_exports__.oXQ;__webpackgi_exports__.rKP;__webpackgi_exports__.vMJ;__webpackgi_exports__.CWW;__webpackgi_exports__.XG_;var __webpackgi_exports__SRGBColorSpace=__webpackgi_exports__.er$;__webpackgi_exports__.KLL;var __webpackgi_exports__SSAOPlugin=__webpackgi_exports__.ye;__webpackgi_exports__.czS;__webpackgi_exports__.UG9;__webpackgi_exports__.aJo;__webpackgi_exports__.uC9;var __webpackgi_exports__SSRPlugin=__webpackgi_exports__.k9M;__webpackgi_exports__.fRH;__webpackgi_exports__.Z58;__webpackgi_exports__._I4;__webpackgi_exports__.Sr;__webpackgi_exports__.zx2;__webpackgi_exports__.r1V;__webpackgi_exports__.tI0;__webpackgi_exports__.vxI;__webpackgi_exports__.zkh;__webpackgi_exports__.BKk;__webpackgi_exports__.rNP;__webpackgi_exports__.DkA;__webpackgi_exports__.rpH;__webpackgi_exports__.Q4F;__webpackgi_exports__.q2;__webpackgi_exports__.ypk;__webpackgi_exports__.MSw;__webpackgi_exports__.Ld9;__webpackgi_exports__.YOp;__webpackgi_exports__.xJ6;__webpackgi_exports__.fBL;__webpackgi_exports__.XTN;var __webpackgi_exports__SimpleBackgroundEnvUiPlugin=__webpackgi_exports__.ZXl;__webpackgi_exports__.O9e;__webpackgi_exports__.ILd;__webpackgi_exports__.SQN;__webpackgi_exports__.GDD;__webpackgi_exports__.HVh;__webpackgi_exports__.X46;__webpackgi_exports__.hdr;__webpackgi_exports__.CSJ;__webpackgi_exports__.EAD;__webpackgi_exports__._xc;__webpackgi_exports__.I46;__webpackgi_exports__.CSm;__webpackgi_exports__.kLi;__webpackgi_exports__.iyt;__webpackgi_exports__.Gu$;__webpackgi_exports__.s6s;__webpackgi_exports__.YHV;__webpackgi_exports__.xOk;__webpackgi_exports__.xfg;__webpackgi_exports__.nCl;__webpackgi_exports__.Hs2;__webpackgi_exports__.Fpm;__webpackgi_exports__.kxk;__webpackgi_exports__.RoJ;__webpackgi_exports__.ie2;__webpackgi_exports__.hgQ;__webpackgi_exports__.f4X;__webpackgi_exports__.Hrq;__webpackgi_exports__.agE;__webpackgi_exports__.uXQ;__webpackgi_exports__.keZ;__webpackgi_exports__.rOG;__webpackgi_exports__.Ktl;__webpackgi_exports__.uov;__webpackgi_exports__.hZF;__webpackgi_exports__.FXf;__webpackgi_exports__.Kwu;__webpackgi_exports__.hv1;__webpackgi_exports__.AqU;__webpackgi_exports__.wtR;__webpackgi_exports__.cGs;__webpackgi_exports__.bI3;var __webpackgi_exports__TemporalAAPlugin=__webpackgi_exports__.afA;__webpackgi_exports__.Zpd;__webpackgi_exports__.gO_;__webpackgi_exports__.gPd;__webpackgi_exports__.Tap;__webpackgi_exports__.k4W;__webpackgi_exports__.ndu;var __webpackgi_exports__TonemapPlugin=__webpackgi_exports__.el_;__webpackgi_exports__.O3Y;__webpackgi_exports__.UPV;__webpackgi_exports__.iu6;__webpackgi_exports__.Ijk;__webpackgi_exports__.ZU6;__webpackgi_exports__.XXP;__webpackgi_exports__.RQH;__webpackgi_exports__.tUF;__webpackgi_exports__.Tww;__webpackgi_exports__.lMl;__webpackgi_exports__.rYR;__webpackgi_exports__.O49;__webpackgi_exports__.RJ4;__webpackgi_exports__.CXS;__webpackgi_exports__.j6;__webpackgi_exports__.G8g;__webpackgi_exports__.SOP;__webpackgi_exports__.e2_;__webpackgi_exports__.GTy;__webpackgi_exports__.cOZ;__webpackgi_exports__.XxD;__webpackgi_exports__.UTZ;__webpackgi_exports__.A$4;__webpackgi_exports__.MW4;__webpackgi_exports__.baL;__webpackgi_exports__.fc6;__webpackgi_exports__.t7h;__webpackgi_exports__.nc$;__webpackgi_exports__.dzP;__webpackgi_exports__.fCn;__webpackgi_exports__.LlO;__webpackgi_exports__.OUM;__webpackgi_exports__.V3x;__webpackgi_exports__.bkx;__webpackgi_exports__.Wew;__webpackgi_exports__.gJ2;__webpackgi_exports__.cHt;__webpackgi_exports__.HJp;__webpackgi_exports__.mMi;__webpackgi_exports__.XLH;__webpackgi_exports__.TWi;__webpackgi_exports__.DcJ;__webpackgi_exports__.Kmx;__webpackgi_exports__.RyA;__webpackgi_exports__.NPD;__webpackgi_exports__.Gpr;__webpackgi_exports__.mKI;__webpackgi_exports__.I9Y;var __webpackgi_exports__Vector3=__webpackgi_exports__.Pq0;__webpackgi_exports__.IUQ;__webpackgi_exports__.RiT;__webpackgi_exports__.Xkr;__webpackgi_exports__.Nv2;var __webpackgi_exports__ViewerApp=__webpackgi_exports__.EW5;__webpackgi_exports__.oJ0;__webpackgi_exports__.Q1b;__webpackgi_exports__.jK_;__webpackgi_exports__.gTm;__webpackgi_exports__.S3G;__webpackgi_exports__.ALV;__webpackgi_exports__.y9J;__webpackgi_exports__.TdN;__webpackgi_exports__.o6l;__webpackgi_exports__.AT1;__webpackgi_exports__.nWS;__webpackgi_exports__.JeP;__webpackgi_exports__.hfX;__webpackgi_exports__.i7u;__webpackgi_exports__.b5D;__webpackgi_exports__.Z1R;__webpackgi_exports__.pWZ;__webpackgi_exports__.XJ7;__webpackgi_exports__.r3D;__webpackgi_exports__.dhZ;__webpackgi_exports__.$Tl;__webpackgi_exports__.rQf;__webpackgi_exports__.ojh;__webpackgi_exports__.h2z;__webpackgi_exports__.kqe;__webpackgi_exports__.qQr;__webpackgi_exports__.D8L;__webpackgi_exports__.p9O;__webpackgi_exports__.uZB;__webpackgi_exports__.KK;__webpackgi_exports__.Ua6;__webpackgi_exports__.TYE;__webpackgi_exports__.rQr;__webpackgi_exports__.$00;__webpackgi_exports__.ued;__webpackgi_exports__.p$A;__webpackgi_exports__.m2A;__webpackgi_exports__.MqB;__webpackgi_exports__.Dv6;__webpackgi_exports__.f9i;__webpackgi_exports__.qHA;__webpackgi_exports__.sQz;__webpackgi_exports__.G52;__webpackgi_exports__.EP1;__webpackgi_exports__.v5N;__webpackgi_exports__.SET;__webpackgi_exports__.g7h;__webpackgi_exports__.i0Z;__webpackgi_exports__.GcL;__webpackgi_exports__.z67;__webpackgi_exports__.im4;__webpackgi_exports__.$bx;__webpackgi_exports__.btx;__webpackgi_exports__.M7c;__webpackgi_exports__.ZMO;__webpackgi_exports__.YiG;__webpackgi_exports__.UE8;__webpackgi_exports__.uHr;__webpackgi_exports__.YYK;__webpackgi_exports__.qZL;__webpackgi_exports__.XMb;__webpackgi_exports__.utC;__webpackgi_exports__.uO_;__webpackgi_exports__.dgX;__webpackgi_exports__.ZZ5;__webpackgi_exports__.Szj;__webpackgi_exports__.Ms4;__webpackgi_exports__.OMj;__webpackgi_exports__.D7g;__webpackgi_exports__.LG_;__webpackgi_exports__.cis;__webpackgi_exports__.pAB;__webpackgi_exports__.y80;__webpackgi_exports__.sQg;__webpackgi_exports__.ipZ;__webpackgi_exports__.wmn;__webpackgi_exports__.Tel;__webpackgi_exports__.Q5;__webpackgi_exports__.b1j;__webpackgi_exports__.wzf;__webpackgi_exports__.Cq_;__webpackgi_exports__.poN;__webpackgi_exports__.tnX;__webpackgi_exports__.yT;__webpackgi_exports__.qE8;__webpackgi_exports__.WYS;__webpackgi_exports__.Cp1;__webpackgi_exports__.mz1;__webpackgi_exports__.Bc;__webpackgi_exports__.oSR;__webpackgi_exports__.KJu;__webpackgi_exports__.G1I;__webpackgi_exports__.dXm;__webpackgi_exports__.lRj;__webpackgi_exports__.WL9;__webpackgi_exports__.OkM;__webpackgi_exports__.kRU;__webpackgi_exports__.Xpo;__webpackgi_exports__.KCp;__webpackgi_exports__.a17;__webpackgi_exports__.prl;__webpackgi_exports__.ij0;__webpackgi_exports__.MjE;__webpackgi_exports__.bhJ;__webpackgi_exports__.nMR;__webpackgi_exports__.p4x;__webpackgi_exports__.lPF;__webpackgi_exports__.SwP;__webpackgi_exports__.U2C;__webpackgi_exports__.FOd;__webpackgi_exports__.WOM;__webpackgi_exports__.mFw;__webpackgi_exports__.n4h;__webpackgi_exports__.eRo;__webpackgi_exports__.LsR;__webpackgi_exports__.tJ;__webpackgi_exports__.bES;__webpackgi_exports__.rU;__webpackgi_exports__.omb;__webpackgi_exports__.AHW;__webpackgi_exports__.AKs;__webpackgi_exports__.VxZ;__webpackgi_exports__.GRd;__webpackgi_exports__.TVt;__webpackgi_exports__.mFv;__webpackgi_exports__.RqU;__webpackgi_exports__.UKN;__webpackgi_exports__.mmZ;__webpackgi_exports__.Ikv;__webpackgi_exports__.Kcl;__webpackgi_exports__.pdh;__webpackgi_exports__.tRv;__webpackgi_exports__.nNY;__webpackgi_exports__.LK7;__webpackgi_exports__.$q;__webpackgi_exports__.vem;__webpackgi_exports__.__B;__webpackgi_exports__.BF2;__webpackgi_exports__.IoC;__webpackgi_exports__.WNF;__webpackgi_exports__.PE3;__webpackgi_exports__.a6C;__webpackgi_exports__.am_;__webpackgi_exports__.vTE;__webpackgi_exports__.VAT;__webpackgi_exports__._N2;__webpackgi_exports__.oib;__webpackgi_exports__.NtM;__webpackgi_exports__.ru_;__webpackgi_exports__.GcD;__webpackgi_exports__.pJG;__webpackgi_exports__.vxL;__webpackgi_exports__.UUz;__webpackgi_exports__.mlk;__webpackgi_exports__.SVi;__webpackgi_exports__.QXJ;__webpackgi_exports__.D01;__webpackgi_exports__.$7C;__webpackgi_exports__.cdn;__webpackgi_exports__.vGk;__webpackgi_exports__.GPz;__webpackgi_exports__.NxN;__webpackgi_exports__.o7j;__webpackgi_exports__.yqR;__webpackgi_exports__.U_j;__webpackgi_exports__.mB_;__webpackgi_exports__.d6c;__webpackgi_exports__.zhG;__webpackgi_exports__.HJb;__webpackgi_exports__.e5R;__webpackgi_exports__.kdR;__webpackgi_exports__.D85;__webpackgi_exports__.ZIX;__webpackgi_exports__.u3y;__webpackgi_exports__.jDu;__webpackgi_exports__.qyt;__webpackgi_exports__.Dtr;__webpackgi_exports__.WKP;__webpackgi_exports__.fJV;__webpackgi_exports__.tC7;__webpackgi_exports__.Uan;__webpackgi_exports__.Uct;__webpackgi_exports__.K_U;__webpackgi_exports__.BFA;__webpackgi_exports__.BHX;__webpackgi_exports__.Pee;__webpackgi_exports__.$If;__webpackgi_exports__.RFY;__webpackgi_exports__.Buv;__webpackgi_exports__.UDz;__webpackgi_exports__.HMP;__webpackgi_exports__.Zg4;__webpackgi_exports__.GWP;__webpackgi_exports__.r58;__webpackgi_exports__.fTC;__webpackgi_exports__.YWz;__webpackgi_exports__.eAs;__webpackgi_exports__.i7C;__webpackgi_exports__.jFo;__webpackgi_exports__.kbd;__webpackgi_exports__.nU8;__webpackgi_exports__.NFx;__webpackgi_exports__.sns;__webpackgi_exports__.S2G;__webpackgi_exports__.iW4;__webpackgi_exports__.Se$;__webpackgi_exports__.Sop;__webpackgi_exports__.HNH;__webpackgi_exports__.jGz;__webpackgi_exports__.ll7;__webpackgi_exports__.SrG;__webpackgi_exports__.UGD;__webpackgi_exports__.KVf;__webpackgi_exports__.gDN;__webpackgi_exports__.h0o;__webpackgi_exports__.pPQ;__webpackgi_exports__.hLo;__webpackgi_exports__.ecu;__webpackgi_exports__.mhB;__webpackgi_exports__.jhA;__webpackgi_exports__.iou;__webpackgi_exports__.JL8;__webpackgi_exports__.G8Z;__webpackgi_exports__.GMB;__webpackgi_exports__.tB5;__webpackgi_exports__.GnX;__webpackgi_exports__.cYW;__webpackgi_exports__.k9K;__webpackgi_exports__.CTC;__webpackgi_exports__.JW6;__webpackgi_exports__.p7C;__webpackgi_exports__.OId;__webpackgi_exports__.CN_;__webpackgi_exports__.uaX;__webpackgi_exports__.FsL;__webpackgi_exports__.gtD;__webpackgi_exports__.wbL;__webpackgi_exports__.DDu;__webpackgi_exports__.O$W;__webpackgi_exports__.xfb;__webpackgi_exports__.UD3;__webpackgi_exports__.ZoD;__webpackgi_exports__.hQ_;__webpackgi_exports__.V7C;__webpackgi_exports__.Sow;__webpackgi_exports__.qB0;__webpackgi_exports__.nv6;__webpackgi_exports__.LF4;__webpackgi_exports__.TAg;__webpackgi_exports__.irg;__webpackgi_exports__.Ei4;__webpackgi_exports__.Grb;__webpackgi_exports__.yhl;__webpackgi_exports__.Gmo;__webpackgi_exports__.pGT;__webpackgi_exports__.Gsh;__webpackgi_exports__.S2Q;__webpackgi_exports__.pUp;__webpackgi_exports__.sU3;__webpackgi_exports__.lKg;__webpackgi_exports__.gwL;__webpackgi_exports__.EBS;__webpackgi_exports__.YCG;__webpackgi_exports__.gC;__webpackgi_exports__.R5k;__webpackgi_exports__.zB$;__webpackgi_exports__.dGw;__webpackgi_exports__.tNl;__webpackgi_exports__.AAd;__webpackgi_exports__.YFt;__webpackgi_exports__.IRk;__webpackgi_exports__.ZVX;__webpackgi_exports__.cTN;__webpackgi_exports__.PlU;__webpackgi_exports__.Mi5;__webpackgi_exports__.nuN;__webpackgi_exports__.Jp2;__webpackgi_exports__.oDA;__webpackgi_exports__.n$K;__webpackgi_exports__.w4b;__webpackgi_exports__.JVv;__webpackgi_exports__.ozl;__webpackgi_exports__.asH;__webpackgi_exports__.niF;__webpackgi_exports__.CiD;__webpackgi_exports__.heq;__webpackgi_exports__._uk;__webpackgi_exports__.xrZ;__webpackgi_exports__.aUi;__webpackgi_exports__.Tmf;__webpackgi_exports__.AYr;__webpackgi_exports__.SVO;__webpackgi_exports__.mBH;__webpackgi_exports__.z73;__webpackgi_exports__.cyN;var __webpackgi_exports__timeout=__webpackgi_exports__.wRz;__webpackgi_exports__.pbX;__webpackgi_exports__.nIf;__webpackgi_exports__.RY5;__webpackgi_exports__.SnO;__webpackgi_exports__._cJ;__webpackgi_exports__.Mny;__webpackgi_exports__.X0G;__webpackgi_exports__.mBY;__webpackgi_exports__.rpQ;__webpackgi_exports__.exO;__webpackgi_exports__.rsv;__webpackgi_exports__.gpt;__webpackgi_exports__.hEL;__webpackgi_exports__.LIx;__webpackgi_exports__.Z5F;__webpackgi_exports__.Eiw;__webpackgi_exports__.Jx6;__webpackgi_exports__.q00;__webpackgi_exports__.PiW;__webpackgi_exports__.$15;__webpackgi_exports__.AOo;__webpackgi_exports__.VTi;__webpackgi_exports__.a8Y;__webpackgi_exports__.QMY;__webpackgi_exports__.d5o;__webpackgi_exports__.Fxe;__webpackgi_exports__.Nan;__webpackgi_exports__.Ols;__webpackgi_exports__.Ovn;__webpackgi_exports__.fjO;__webpackgi_exports__.pZl;__webpackgi_exports__.R9T;__webpackgi_exports__.LV7;__webpackgi_exports__.M98;__webpackgi_exports__._h9;__webpackgi_exports__.yU6;__webpackgi_exports__.LaF;__webpackgi_exports__.w58;__webpackgi_exports__.$ax;const styles="";/*!
 * Deep merge two or more objects or arrays.
 * (c) 2023 Chris Ferdinandi, MIT License, https://gomakethings.com
 * @param   {*} ...objs  The arrays or objects to merge
 * @returns {*}          The merged arrays or objects
 */function deepMerge(...d){function o(u){return Object.prototype.toString.call(u).slice(8,-1).toLowerCase()}function l(u,h){for(let[_,A]of Object.entries(h)){let w=o(A);u[_]!==void 0&&o(u[_])===w&&["array","object"].includes(w)?u[_]=deepMerge(u[_],A):u[_]=structuredClone(A)}}let c=structuredClone(d.shift());for(let u of d){let h=o(u);if(o(c)!==h){c=structuredClone(u);continue}h==="array"?c=[...c,...structuredClone(u)]:h==="object"?l(c,u):c=u}return c}const APP_DATA_DEFAULTS={debug:!1,scene:{model:"./assets/models/model.glb",hdr:"./assets/hdr/env.hdr",autoScale:!0,autoScaleRadius:2,autoCenter:!0,ground:!1,limitCameraAboveGround:!1,backgroundColor:16777215,backgroundImage:"",clipBackground:!1},gui:{useModals:{menus:!0,hotspots:!0},useHotspots:!0,useHotspotsMenu:!1,useAnimationMenu:!0,hotspotPrefix:"hs_",hideHotspots:!1,replaceHotspots:!1,animateHotspots:!1,scaleHotspots:!0,hotspotsFollowCamera:!1,useCameraViews:!1},controls:{enableDamping:!0,enablePan:!1,autoRotate:!1}},CONTENT_LOAD_TWEEN_SPEED=3e3,ACTIVE_HS_SIZE=.3,NORMAL_HS_SIZE=1,AUTOROTATE_TIMEOUT=15e3,ANIM_SPEED=3e3,example_data={debug:!1,scene:{models:{main:"./assets/360.glb"},ground:!1},gui:{useHotspots:!1,useHotspotsMenu:!1,replaceHotspots:!1,hideHotspots:!0,useCameraViews:!0,hotspotsFollowCamera:!1},controls:{enableDamping:!0,enablePan:!0}},ps3d_animation_data={animation_rotation:{buttonText:"Show Rotation",antagonists:["animation_latch_in","animation_latch_out"],state:"full"},animation_latch:{buttonText:"Latch",state:"full"},animation_hinge:{buttonText:"Hinge animation",state:"out",order:1}},ps3d_content_data={battery:{},display:{},forks:{}};async function setupViewer(d,o,l,c){var Rn,Un;const u=deepMerge(APP_DATA_DEFAULTS,o);window.app_data=u,window.content_data=l,window.animation_data=c,u.scene.model,u.scene.hdr;let h;const _={};window.mixers=_;let A=[];window.clips=A;const w=new Set,C=[],M=[],O=[],ne=[],ce=[],ue=new __webpackgi_exports__ViewerApp({canvas:d.querySelector(".webgi-canvas")});window.viewer=ue,await ue.addPlugin(__webpackgi_exports__AssetManagerPlugin);const ye=await ue.addPlugin(__webpackgi_exports__InteractionPromptPlugin);ye.enabled=!0,ye.autoStart=!0,window.interactionPromptPlugin=ye,console.log(ye),await ue.addPlugin(__webpackgi_exports__GBufferPlugin),await ue.addPlugin(new __webpackgi_exports__ProgressivePlugin(32));const Oe=await ue.addPlugin(new __webpackgi_exports__TonemapPlugin(ue.useRgbm),{tonemapBackground:!1});window.toneMapping=Oe,await ue.addPlugin(__webpackgi_exports__GammaCorrectionPlugin),await ue.addPlugin(__webpackgi_exports__SSRPlugin,{}),await ue.addPlugin(__webpackgi_exports__SSAOPlugin),await ue.addPlugin(__webpackgi_exports__FrameFadePlugin),await ue.addPlugin(__webpackgi_exports__TemporalAAPlugin),await ue.addPlugin(__webpackgi_exports__SimpleBackgroundEnvUiPlugin);const ke=await ue.addPlugin(__webpackgi_exports__GroundPlugin);ke.autoBakeShadows=!1,ke.shadowBaker.smoothShadow=!0,window.groundPlugin=ke,u.scene.ground===!1&&(ke.visible=!1),u.scene.limitCameraAboveGround&&(ke.limitCameraAboveGround=u.scene.limitCameraAboveGround);const Ve=await ue.addPlugin(__webpackgi_exports__PopmotionPlugin),tt=await ue.addPlugin(__webpackgi_exports__CameraViewPlugin);ue.renderer.refreshPipeline();let ht,ut=!1,_t=null,at=null,lt=null,pt=[];const xt=[];let{hotspotPrefix:Tt="hs_",animateHotspots:Pt=!1,scaleHotspots:Lt=!0,followCamera:Bt,useCameraViews:Ut}=u==null?void 0:u.gui;const kt=Ai=>{let Fi=Ai,Ki=Ai.name.substr(Tt.length);return Ai.traverseAncestors(_n=>{_n.name.indexOf(Tt)===0&&(Ki=_n.name.substr(Tt.length),Fi=_n)}),{hotspot_object:Fi,key:Ki}},Vt=async()=>{ue.getPlugin(__webpackgi_exports__PickingPlugin)?ht=ue.getPlugin(__webpackgi_exports__PickingPlugin):(ht=await ue.addPlugin(__webpackgi_exports__PickingPlugin),ht.addEventListener("hitObject",async Ai=>{const Fi=Ai.intersects.selectedObject;Ai.intersects.selectedObject=null;let{hotspot_object:Ki,key:_n}=kt(Fi);Ki&&Ki.name.indexOf(Tt)===0&&(_t!==_n?(at!==null&&Lt&&si(at,ACTIVE_HS_SIZE,NORMAL_HS_SIZE),at=Ki,Lt&&si(Ki,NORMAL_HS_SIZE,ACTIVE_HS_SIZE),Kn(_n)):(Ln(),An()))}))},si=async(Ai,Fi,Ki)=>{await Ve.animate({from:Fi,to:Ki,duration:CONTENT_LOAD_TWEEN_SPEED/2,repeat:0,ease:EasingFunctions.linear,onUpdate:yn=>{Ai.modelObject.scale.set(yn,yn,yn),ue.setDirty()}}).promise},Jt=()=>{if((pt==null?void 0:pt.length)===0)return!1;pt.forEach(Ai=>{Ai.visible=!1})},Wt=()=>{pt.forEach(Ai=>{Ai.lookAt(ue.scene.activeCamera.position)})};async function Zt(Ai,Fi,Ki="easeInOut"){if(!tt)return!1;typeof Fi>"u"&&(Fi=ANIM_SPEED);let _n=`camera_${Ai}`;d.clientHeight>=(d==null?void 0:d.clientWidth)&&ue.scene.getObjectByName(`mobile_camera_${Ai}`)&&(_n=`mobile_camera_${Ai}`);const yn=ue.scene.getObjectByName(_n),Tn=ue.scene.getObjectByName(`camera_${Ai}Target`);let qn=ue.createCamera(yn),fr=tt.getCurrentCameraView(qn);Tn==null||Tn.getWorldPosition(fr.target),await tt.animateToView(fr,Fi,Ki)}window.animateCameraToKey=Zt;const ti=()=>{const Ai=ue.scene.activeCamera.controls;Object.keys(u.controls).forEach(Fi=>{Fi!=="autoRotate"&&(Ai[Fi]=u.controls[Fi])}),u.controls.autoRotate&&an()};let ci,ri=!1;const Ct=d.querySelector(".ps3d-modal"),Ht=Ct==null?void 0:Ct.querySelector(".ps3d-close-button");Ht==null||Ht.addEventListener("click",()=>{u.gui.useHotspots&&Ln(),An()});const qt=({clientWidth:Ai,clientHeight:Fi,scrollWidth:Ki,scrollHeight:_n})=>_n>Fi||Ki>Ai,Li=Ai=>{Ai.thumb.forEach((Fi,Ki)=>{var _n;(_n=document.querySelector(".ps3d-modal .swiper-wrapper"))==null||_n.insertAdjacentHTML("beforeend",`<div class="swiper-slide"><a class="glightbox-inline" href="${Ai.elements[Ki].href}"><img src="${Fi}" /></a></div>`)}),ci=new Swiper(".swiper",{navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"},pagination:{el:".swiper-pagination"}})},Ui=Ai=>{if(!Ai)return!1;typeof Ai=="string"&&(Ai=document.querySelector(Ai));const Fi=Ai==null?void 0:Ai.querySelectorAll(".glightbox-inline");(Fi==null?void 0:Fi.length)>0&&GLightbox({selector:".glightbox-inline"})},Xi=Ai=>{let Fi=l[Ai];(typeof Fi>"u"||!Ct)&&(Fi=Object.values(l)[0]);const Ki=Ct==null?void 0:Ct.querySelector("h2"),_n=Ct==null?void 0:Ct.querySelector(".ps3d-modal-content"),yn=Ct==null?void 0:Ct.querySelector("img"),Tn=Ct==null?void 0:Ct.querySelector("a.glightbox"),qn=Ct==null?void 0:Ct.querySelector(".swiper");if(Ki.innerHTML=Fi.title,Fi.content?(_n.innerHTML=Fi.content,_n.classList.remove("hidden"),Ui(_n)):_n.classList.add("hidden"),Fi.media){const fr=Fi.media;typeof fr.thumb=="string"?(yn.src=fr.thumb,Tn.setAttribute("href",fr.href),yn.classList.remove("hidden"),Tn.classList.remove("hidden"),qn.classList.add("hidden"),lightbox.setElements(fr.elements)):typeof fr.thumb=="object"&&(yn.classList.add("hidden"),Tn.classList.add("hidden"),qn.classList.remove("hidden"),Li(fr),Ui(qn))}else yn.classList.add("hidden"),Tn.classList.add("hidden");Ct.classList.add("active"),qt(_n)?_n.classList.add("overflown"):_n.classList.remove("overflown"),u.controls.autoRotate&&clearTimeout(dn)},An=()=>{var Ai,Fi;if(w.size>0&&mi(A[0].name),Ct==null||Ct.classList.remove("active"),(Ai=u.gui)!=null&&Ai.useHotspotsMenu&&document.querySelectorAll(".hotspots-menu button").forEach(Ki=>Ki.classList.remove("active")),ri=!1,ci){ci.destroy(!0,!1);const Ki=Ct.querySelector(".swiper .swiper-wrapper");Ki.innerHTML=""}(Fi=u.gui)!=null&&Fi.useHotspotsMenu&&document.querySelectorAll(".hotspots-menu button").forEach(Ki=>Ki.classList.remove("active"))},Ln=async()=>{at!==null&&Lt&&si(at,ACTIVE_HS_SIZE,NORMAL_HS_SIZE),Ut&&lt&&(ti(),await tt.animateToView(lt,CONTENT_LOAD_TWEEN_SPEED)),ut=!1,at=null,_t=null},Nn=async(Ai,Fi)=>{var _n,yn;const Ki=Ut?CONTENT_LOAD_TWEEN_SPEED:200;!ut&&Ut&&(lt=tt.getCurrentCameraView(ue.scene.activeCamera,!1)),An(),ut=!0,ri=!0,_t=Ai,(_n=u.gui)!=null&&_n.useHotspotsMenu&&(document.querySelectorAll(".hotspots-menu button").forEach(Tn=>Tn.classList.remove("active")),(yn=document.querySelector(`.hotspots-menu button[data-modal="${Ai}"]`))==null||yn.classList.add("active")),setTimeout(()=>{(u.gui.useModals[Fi]||u.gui.useModals===!0)&&Xi(Ai)},Ki),Ut&&await Zt(Ai),Ai==="forks"&&Zi("ATL_idle")},Kn=async Ai=>{Nn(Ai,"hotspots")},_i=async Ai=>{Nn(Ai,"menus")};new __webpackgi_exports__Raycaster;const Gi=Ai=>{var Fi=new __webpackgi_exports__Vector3,Ki=.5*ue.renderer.context.canvas.width,_n=.5*ue.renderer.context.canvas.height;return Ai.updateMatrixWorld(),Fi.setFromMatrixPosition(Ai.matrixWorld),Fi.project(ue.scene.activeCamera._camera),Fi.x=Fi.x*Ki+Ki,Fi.y=-(Fi.y*_n)+_n,{x:Fi.x,y:Fi.y}};window.getScreenTranslation=Gi;const sn=(Ai,Fi)=>{if(typeof Ai>"u")return;const Ki=Gi(Ai),_n=ue.renderer.context.canvas.width,yn=ue.renderer.context.canvas.height;Ki.x=Ki.x<0?20:Ki.x,Ki.x=Ki.x>_n-Fi.offsetWidth?_n-Fi.offsetWidth-20:Ki.x,Ki.y=Ki.y<0?20:Ki.y,Ki.y=Ki.y>yn-Fi.offsetHeight?yn-Fi.offsetHeight-20:Ki.y,Fi.style.top=`${Math.floor(Ki.y)}px`,Fi.style.left=`${Math.floor(Ki.x)}px`},jt=()=>{ue.scene.activeCamera._camera,new __webpackgi_exports__Vector3,xt.forEach(Ai=>{sn(Ai.obj,Ai.html)})};window.repositionHtmlHotspots=jt;const Gt=()=>{var Fi;const Ai=document.createElement("div");Ai.classList.add("hotspots-menu","button-group"),pt.forEach(Ki=>{const _n=Ki.name.substr(Tt.length);if(l[_n]){const yn=l[_n],Tn=document.createElement("button");Tn.classList.add("btn-text"),Tn.setAttribute("data-modal",_n),yn.order?Tn.style.order=yn.order:Tn.style.order=1e3,Tn.innerHTML=yn.title,Ai==null||Ai.appendChild(Tn),Tn.addEventListener("click",qn=>{if(Tn.classList.contains("active"))u.gui.useHotspots&&Ln(),An();else{at!==null&&Lt&&si(at,ACTIVE_HS_SIZE,NORMAL_HS_SIZE);const fr=ue.scene.getObjectByName(`${Tt}${_n}`);at=fr,Lt&&si(fr,NORMAL_HS_SIZE,ACTIVE_HS_SIZE),_i(_n)}})}}),(Fi=document.querySelector(".floating-controls"))==null||Fi.appendChild(Ai)},li=()=>{A.forEach(Ai=>{const Ki=Ai.name.split("_");if(Ki.length!==1&&(Ki[0]==="hsanimation"&&ce.push(Ai.name),Ki[0]==="loop"&&ne.push(Ai.name),Ki[0]==="random"&&C.push(Ai.name),Ki[0]==="animation"))if(Ki[Ki.length-1]==="in"){Ki.pop();const _n=Ki.join("_");M.push(_n)}else Ki[Ki.length-1]==="out"||O.push(Ai.name)}),ce.forEach(Ai=>Zi(Ai))},vi=()=>{var Ki;const Ai=document.createElement("div");Ai.classList.add("animation-actions","button-group"),(Ki=document.querySelector(".floating-controls"))==null||Ki.appendChild(Ai),[...O,...M].forEach(_n=>{const yn=c[_n];if(!yn)return!1;const Tn=document.createElement("button");Tn.classList.add("btn-text"),Tn.classList.add(_n),Tn.setAttribute("data-animation",_n),yn.order?Tn.style.order=yn.order:Tn.style.order=1e3,Tn.innerHTML=yn.buttonText,Ai==null||Ai.appendChild(Tn),Tn.addEventListener("click",qn=>{xi(qn.target.getAttribute("data-animation"))})})},xi=Ai=>{let Ki=c[Ai].state;(Ki==="in"||Ki==="out")&&(Ki=Ki==="in"?"out":"in"),Ri(Ai,Ki)},mi=Ai=>{const Fi=_[Ai].action;if(!Fi)return!1;Fi.enabled=!1,Fi.setEffectiveWeight(0),Fi.setLoop(0),Fi.clampWhenFinished=!0,Fi.reset(),Fi.stop(),w.has(Fi)&&w.delete(Fi)},Ri=async(Ai,Fi="in")=>{let Ki=Ai;Fi!=="full"&&(Ki=`${Ai}${Fi==="out"?"_out":"_in"}`);const _n=__webpackgi_exports__AnimationClip.findByName(A,Ki),yn=_[Ki].action;if(!yn)return!1;if(Fi==="out"){const qn=Ai+"_in";if(__webpackgi_exports__AnimationClip.findByName(A,qn)){const wr=_[qn].action;wr.enabled=!1,wr.setEffectiveWeight(0)}}else if(Fi==="in"){const qn=Ai+"_out";if(__webpackgi_exports__AnimationClip.findByName(A,qn)){const wr=_[qn].action;wr.enabled=!1,wr.setEffectiveWeight(0)}}const Tn=c[Ai].antagonists;if(Tn!=null&&Tn.length&&Tn.forEach(qn=>{if(__webpackgi_exports__AnimationClip.findByName(A,qn)){const wr=_[qn].action;wr.enabled=!1,wr.setEffectiveWeight(0)}}),yn.enabled=!0,yn.setEffectiveWeight(1),yn.setLoop(__webpackgi_exports__LoopOnce),yn.clampWhenFinished=!0,yn.reset(),yn.play(),w.add(yn),await __webpackgi_exports__timeout(_n.duration*1e3),w.delete(yn),yn.paused=!0,c[Ai].state==="in"||c[Ai].state==="out"){const qn=c[Ai].state==="in"?"out":"in";c[Ai].state=qn}},Zi=async Ai=>{const Fi=_[Ai].action;if(!Fi)return console.log("no loop mixer aniamtion"),!1;Fi.enabled=!0,Fi.setEffectiveWeight(1),Fi.setLoop(__webpackgi_exports__LoopRepeat),Fi.clampWhenFinished=!0,Fi.reset(),Fi.play(),w.add(Fi)};window.loopAnimationByName=Zi,ue.addEventListener("preFrame",Ai=>{u.gui.hotspotsFollowCamera&&Wt(),!(w.size<1)&&(Object.keys(_).forEach(Fi=>{_[Fi].mixer.update(Ai.deltaTime/1e3)}),ue.setDirty())});let dn=null;const hn=()=>{kn=!0,nn.autoRotate=kn},an=()=>{dn=setTimeout(()=>{hn()},AUTOROTATE_TIMEOUT)},pn=Ai=>{Ai.target.closest("button")&&Ai.target.closest("button").classList.contains("ps3d-close-button")&&(ri=!1,ut=!1),kn?(kn=!1,nn.autoRotate=kn):clearTimeout(dn),!ri&&!ut&&an()};u.controls.autoRotate&&document.querySelector(".ps-3d-container").addEventListener("click",pn);let Yi=ue.scene.activeCamera,nn=Yi.controls,kn=u.controls.autoRotate;function un(Ai,Fi,Ki,_n,yn,Tn,qn,fr){arguments.length===2&&(Ki=_n=0,yn=Ai.canvas.width,Tn=Ai.canvas.height),qn=typeof qn=="number"?qn:.5,fr=typeof fr=="number"?fr:.5,qn<0&&(qn=0),fr<0&&(fr=0),qn>1&&(qn=1),fr>1&&(fr=1);var wr=Fi.width,jr=Fi.height,Xr=Math.min(yn/wr,Tn/jr),Nr=wr*Xr,vn=jr*Xr,wn,Zr,or,eo,Kr=1;Nr<yn&&(Kr=yn/Nr),Math.abs(Kr-1)<1e-14&&vn<Tn&&(Kr=Tn/vn),Nr*=Kr,vn*=Kr,or=wr/(Nr/yn),eo=jr/(vn/Tn),wn=(wr-or)*qn,Zr=(jr-eo)*fr,wn<0&&(wn=0),Zr<0&&(Zr=0),or>wr&&(or=wr),eo>jr&&(eo=jr),Ai.drawImage(Fi,wn,Zr,or,eo,Ki,_n,yn,Tn)}const On=Ai=>{const Fi=document.querySelector(".webgi-canvas-container");Ai==""&&(ue.scene.background=null);let Ki=document.querySelector(".webgi-canvas-container > .bg-canvas"),_n=Ki.getContext("2d"),yn=document.querySelector(".webgi-canvas-container > img");yn||(yn=new Image,Fi==null||Fi.insertBefore(yn,Fi.firstChild)),yn.src=Ai,yn.crossOrigin="Anonymous",yn.onload=function(){un(_n,yn,0,0,Ki.width,Ki.height);const Tn=new __webpackgi_exports__CanvasTexture(Ki);Tn.needsUpdate=!0,Tn.colorSpace=__webpackgi_exports__SRGBColorSpace,ue.scene.setBackgroundColor(16777215),ue.scene.background=Tn}},fn=Ai=>{Ai.name==="mainModel"&&(Ai.animations.forEach(Fi=>{A.push(Fi)}),A.forEach(Fi=>{let Ki=new __webpackgi_exports__AnimationMixer(ue.scene);_[Fi.name]={mixer:Ki,action:Ki.clipAction(Fi)}})),Ai.traverse(Fi=>{if(Fi.name.indexOf(`${Tt}`)==0){let{hotspot_object:Ki,key:_n}=kt(Fi);pt.includes(Ki)||pt.push(Ki)}})};await(async()=>{var Fi,Ki,_n,yn;ue.scene.addEventListener("addSceneObject",async Tn=>{});const Ai={autoScale:u.scene.autoScale??!0,autoScaleRadius:u.scene.autoScaleRadius??1,autoCenter:u.scene.autoCenter??!0};for(const Tn of Object.keys(window.app_data.scene.models)){const qn=u.scene.models[Tn],wr=(await ue.load(qn,Ai))._modelObject;wr.name=`${Tn}Model`,fn(wr),h=ue.scene.getObjectByName("camera_generalTarget"),h&&h.position.set(0,0,0)}A.length&&li(),u.gui.useAnimationMenu&&vi(),(Fi=u.gui)!=null&&Fi.useHotspotsMenu&&Gt(),(Ki=u.gui)!=null&&Ki.replaceHotspots&&replaceHotspotsWithSVG(),(_n=u.gui)!=null&&_n.useHotspots&&Vt(),(yn=u.gui)!=null&&yn.hideHotspots&&Jt(),await ue.getManager().importer.importPath("./assets/360.vjson",{processImported:!0}),Oe.config.clipBackground=u.scene.clipBackground,u.scene.backgroundImage!==""&&On(u.scene.backgroundImage),Yi=ue.scene.activeCamera,nn=Yi.controls,Object.keys(u.controls).forEach(Tn=>{nn[Tn]=u.controls[Tn]}),window.orbitControls=nn})(),ue.scene.getObjectByName("testigo")&&(ue.scene.getObjectByName("testigo").visible=!1),ue.scene.getObjectByName("camera_detail_front").dispatchEvent({type:"activateMain",camera:null}),await Zt("detail_front",20),ue.scene.getObjectByName("shadow").material.opacity=.6,ue.scene.activeCamera.setCameraOptions({controlsEnabled:!0});let Zn=ue.scene.activeCamera.controls;if(Zn.minDistance=8.6,Zn.maxDistance=40,(Rn=document.querySelector(".preloader"))==null||Rn.classList.add("hidden"),setTimeout(()=>{ye.startAnimation()},500),u.debug){const Ai=await ue.addPlugin(TweakpaneUiPlugin);Ai.setupPlugins(__webpackgi_exports__TonemapPlugin),Ai.setupPlugins(__webpackgi_exports__GroundPlugin),Ai.setupPlugins(__webpackgi_exports__SimpleBackgroundEnvUiPlugin),Ai.setupPlugins(__webpackgi_exports__GammaCorrectionPlugin),Ai.setupPlugins(__webpackgi_exports__SSRPlugin),Ai.setupPlugins(__webpackgi_exports__FrameFadePlugin),Ai.setupPlugins(__webpackgi_exports__TemporalAAPlugin)}if(u.debug){const Ai={url:"",age:30};Ai.uiConfig={type:"folder",label:"sceneBackground",children:[{type:"input",label:"URL",property:[Ai,"url"],onChange:Fi=>{On(Fi.value)}}]},(Un=ue.getPlugin(TweakpaneUiPlugin))==null||Un.appendUiObject(Ai)}window.vgo=function(Ai){return ue.scene.getObjectByName(Ai)}}setupViewer(document.getElementById("ps3dContainer"),example_data,ps3d_content_data,ps3d_animation_data);
